var WebMolKit;(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{ASCENT_FUDGE:()=>dt,AbbrevContainer:()=>xs,ActivityType:()=>Ys,ArrangeComponent:()=>je,ArrangeComponentAnnot:()=>qe,ArrangeComponentType:()=>Oe,ArrangeExperiment:()=>Ve,ArrangeMolecule:()=>He,Aspect:()=>ae,AspectList:()=>me,AssayProvenance:()=>ce,AssayProvenanceHeader:()=>de,AxisLabeller:()=>Ui,BLineType:()=>we,BONDARTIFACT_EXTRA_ARENE:()=>Lt,BONDARTIFACT_EXTRA_RESPATH:()=>kt,BONDARTIFACT_EXTRA_RESRING:()=>Rt,BayesianModel:()=>cs,BayesianPrediction:()=>Ae,BayesianPredictionModel:()=>ge,BayesianPredictionOutcome:()=>be,BayesianSource:()=>fe,BayesianSourceModel:()=>pe,BinaryData:()=>Me,BinaryDataField:()=>Ee,BondArtifact:()=>Dt,Box:()=>c,BuildSMILES:()=>ps,ButtonBank:()=>Hs,ButtonView:()=>Xs,ButtonViewPosition:()=>Us,Chemistry:()=>qt,CircularFingerprints:()=>ds,ClipboardProxy:()=>fi,ClipboardProxyHandler:()=>pi,ClipboardProxyWeb:()=>gi,CommandBank:()=>ri,ContextSketch:()=>ai,CoordUtil:()=>jt,DEGRAD:()=>J,DOM:()=>y,DataSheet:()=>re,DataSheetColumn:()=>le,DataSheetStream:()=>Ms,Dialog:()=>ks,DotPath:()=>os,DotPathBond:()=>De,DotPathCharge:()=>Ie,DraggingTool:()=>hi,DrawCanvas:()=>ci,DrawCanvasDecoration:()=>ui,DrawExperiment:()=>Qe,DrawMolecule:()=>$e,EditAtom:()=>Ci,EditBond:()=>Ni,EditCompound:()=>zi,EditPolymer:()=>Bi,EmbedChemistry:()=>Yi,EmbedCollection:()=>Xi,EmbedMolecule:()=>Hi,EmbedReaction:()=>ji,EmbedReactionFacet:()=>_i,Experiment:()=>ts,ExperimentComponent:()=>Ke,ExperimentComponentType:()=>ke,ExperimentEntry:()=>Je,ExperimentMeta:()=>Pe,ExperimentMetaApplic:()=>xe,ExperimentMetaRoleType:()=>Ce,ExperimentMetaType:()=>Te,ExperimentMetaValue:()=>ve,ExperimentStep:()=>Ze,ExtraFieldsWidget:()=>yi,FontData:()=>Ue,ForeignMolecule:()=>is,ForeignMoleculeExtra:()=>Le,FormatList:()=>vs,FusionBank:()=>Di,FusionPermutation:()=>Vs,GeomUtil:()=>a,GeomWidget:()=>Ei,GeomWidgetSelType:()=>di,GeomWidgetType:()=>mi,Geometry:()=>Ft,Graph:()=>Bt,GreenMetrics:()=>Fe,INV_TWOPI:()=>Z,KeyCode:()=>vt,Line:()=>f,MDLMOLReader:()=>Zt,MDLMOLWriter:()=>te,MDLMOL_VALENCE:()=>Kt,MDLSDFReader:()=>Jt,MDLSDFWriter:()=>ee,Matrix:()=>o,MeasurementData:()=>ye,MenuProxy:()=>Wi,MenuProxyWeb:()=>Gi,MetaMolecule:()=>ls,MetaVector:()=>Ge,MetalLigate:()=>js,Mixture:()=>es,MixtureAttributeType:()=>Re,MolUtil:()=>Ht,Molecule:()=>ne,MoleculeActivity:()=>Gs,MoleculeStream:()=>se,OntologyTree:()=>ws,OpenMolSpec:()=>Qt,OpenMolType:()=>zt,OptionList:()=>bi,OutlineMeasurement:()=>We,Oval:()=>p,POLYMERBLOCK_EXTRA_POLYMER:()=>It,POLYMERBLOCK_SPECIAL_UNCAPPED:()=>Pt,PeriodicTableWidget:()=>xi,Permutation:()=>i,PolymerBlock:()=>Yt,PolymerBlockConnectivity:()=>_t,PolymerBlockUnit:()=>Ut,Popup:()=>Vi,Pos:()=>m,QuantityCalc:()=>ze,QuantityCalcComp:()=>_e,QuantityCalcRole:()=>Ne,QuantityCalcStat:()=>Se,QueryFieldsWidget:()=>vi,QueryTypeAtom:()=>Os,QueryTypeBond:()=>qs,QueryUtil:()=>Bs,QuickHull:()=>h,RADDEG:()=>tt,Random:()=>$i,RenderEffects:()=>Xe,RenderPolicy:()=>Ye,ResonanceRemover:()=>fs,RollingBall:()=>u,SARTable:()=>ss,SingularValueDecomposition:()=>n,Size:()=>d,SketchUtil:()=>Xt,Sketcher:()=>Fi,Stereochemistry:()=>ns,TEMPLATE_FILES:()=>Ts,TWOPI:()=>K,TabBar:()=>Ai,TemplateBank:()=>Li,TemplateFusion:()=>Ws,TextAlign:()=>Be,Theme:()=>gs,ToolBank:()=>Pi,ToolBankItem:()=>ki,Tooltip:()=>Fs,Triangulation2D:()=>r,Vec:()=>s,Widget:()=>zs,XML:()=>g,addText:()=>v,addTooltip:()=>Is,angleDiff:()=>st,angleDiffPos:()=>it,angleNorm:()=>et,blendRGB:()=>k,clearTooltip:()=>_s,clone:()=>ft,colourAlpha:()=>O,colourCanvas:()=>B,colourCode:()=>w,deepClone:()=>gt,dictValues:()=>yt,dom:()=>b,domLegacy:()=>A,drawLine:()=>mt,empiricalScrollerSize:()=>Ot,escapeHTML:()=>bt,eventCoords:()=>P,findNode:()=>at,findNodes:()=>ht,fltEqual:()=>G,fontSansSerif:()=>ct,formatDate:()=>R,formatDouble:()=>N,fromUTF8:()=>Tt,getBoundaryPixelsDOM:()=>F,getOffsetPixelsDOM:()=>z,hasInlineCSS:()=>ys,htmlToRGB:()=>S,initWebMolKit:()=>bs,installInlineCSS:()=>Es,invZ:()=>W,isDef:()=>D,jsonPrettyPrint:()=>xt,maxArray:()=>rt,minArray:()=>lt,newElement:()=>x,nodeText:()=>L,norm2_xy:()=>X,norm2_xyz:()=>H,norm_xy:()=>U,norm_xyz:()=>Y,notDef:()=>I,orBlank:()=>At,pathRoundedRect:()=>ut,pixelDensity:()=>pt,plural:()=>C,postJSONURL:()=>Nt,raiseToolTip:()=>Ps,randomInt:()=>Q,readTextURL:()=>Ct,realEqual:()=>$,registerAspect:()=>ue,safeFloat:()=>T,safeInt:()=>M,setBoundaryPixels:()=>_,signum:()=>j,sortAngles:()=>ot,sqr:()=>V,toUTF8:()=>Mt,uniqueAngles:()=>nt,yieldDOM:()=>St,zip:()=>Et});class s{static isBlank(t){return null==t||0==t.length}static notBlank(t){return null!=t&&t.length>0}static safeArray(t){return null==t?[]:t}static len(t){return null==t?0:t.length}static arrayLength(t){return null==t?0:t.length}static anyTrue(t){if(null==t)return!1;for(let e of t)if(e)return!0;return!1}static allTrue(t){if(null==t)return!0;for(let e of t)if(!e)return!1;return!0}static anyFalse(t){if(null==t)return!1;for(let e of t)if(!e)return!0;return!1}static allFalse(t){if(null==t)return!0;for(let e of t)if(e)return!1;return!0}static iterAnyTrue(t,e){for(let s of t)if(e(s))return!0;return!1}static iterAllTrue(t,e){for(let s of t)if(!e(s))return!1;return!0}static iterAnyFalse(t,e){for(let s of t)if(!e(s))return!0;return!1}static iterAllFalse(t,e){for(let s of t)if(e(s))return!1;return!0}static swap(t,e,s){let i=t[e];t[e]=t[s],t[s]=i}static duplicate(t){return null==t?[]:t.slice(0)}static append(t,e){return null==t||0==t.length?[e]:((t=t.slice(0)).push(e),t)}static prepend(t,e){return null==t||0==t.length?[e]:((t=t.slice(0)).unshift(e),t)}static concat(t,e){return null==t&&null==e?[]:null==t?e.slice(0):null==e?t.slice(0):t.concat(e)}static remove(t,e){return(t=t.slice(0)).splice(e,1),t}static flatten(t){let e=[];for(let s of t)e.push(...s);return e}static transpose(t){let e=t.length,i=t[0].length,o=s.anyArray(null,i);for(let n=0;n<i;n++){o[n]=s.anyArray(null,e);for(let s=0;s<e;s++)o[n][s]=t[s][n]}return o}static equals(t,e){if(null==t&&null==e)return!0;if(null==t||null==e)return!1;if(t.length!=e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!=e[s])return!1;return!0}static equivalent(t,e){const s=null==t?0:t.length;if(s!=(null==e?0:e.length))return!1;for(let i=0;i<s;i++)if(t[i]!=e[i])return!1;return!0}static compareTo(t,e){const s=Math.max(t.length,e.length);for(let i=0;i<s;i++){if(t[i]<e[i])return-1;if(t[i]>e[i])return 1}return 0}static booleanArray(t,e){let s=new Array(e);return s.fill(t),s}static numberArray(t,e){let s=new Array(e);return s.fill(t),s}static stringArray(t,e){let s=new Array(e);return s.fill(t),s}static anyArray(t,e){let s=new Array(e);return s.fill(t),s}static genericArray(t,e){let s=new Array(e);return s.fill(t),s}static genericBlankArrays(t){let e=new Array(t);for(let s=0;s<t;s++)e[s]=[];return e}static funcArray(t,e){let s=new Array(t);for(let i=0;i<t;i++)s[i]=e(i);return s}static first(t){return null==t||0==t.length?null:t[0]}static last(t){return null==t||0==t.length?null:t[t.length-1]}static min(t){if(null==t||0==t.length)return Number.MAX_VALUE;let e=t[0];for(let s=1;s<t.length;s++)e=Math.min(e,t[s]);return e}static max(t){if(null==t||0==t.length)return Number.MIN_VALUE;let e=t[0];for(let s=1;s<t.length;s++)e=Math.max(e,t[s]);return e}static idxMin(t){if(null==t||0==t.length)return-1;let e=0;for(let s=1;s<t.length;s++)t[s]<t[e]&&(e=s);return e}static idxMax(t){if(null==t||0==t.length)return-1;let e=0;for(let s=1;s<t.length;s++)t[s]>t[e]&&(e=s);return e}static range(t){if(null==t||0==t.length)return 0;let e=t[0],s=t[0];for(let i=1;i<t.length;i++)t[i]<e&&(e=t[i]),t[i]>s&&(s=t[i]);return s-e}static reverse(t){let e=[];for(let s=t.length-1;s>=0;s--)e.push(t[s]);return e}static identity0(t){let e=new Array(t);for(let s=0;s<t;s++)e[s]=s;return e}static identity1(t){let e=new Array(t);for(let s=0;s<t;s++)e[s]=s+1;return e}static identityN(t,e){let s=new Array(e);for(let i=0;i<e;i++)s[i]=i+t;return s}static notMask(t){let e=new Array(t.length);for(let s=t.length-1;s>=0;s--)e[s]=!t[s];return e}static idxGet(t,e){let s=[];for(let i=0;i<e.length;i++)s.push(t[e[i]]);return s}static maskCount(t){if(!t)return 0;let e=0;for(let s=t.length-1;s>=0;s--)t[s]&&e++;return e}static maskIdx(t){let e=[];for(let s=0;s<t.length;s++)t[s]&&e.push(s);return e}static idxMask(t,e){let i=s.booleanArray(!1,e);for(let e of t)i[e]=!0;return i}static maskMap(t){let e=[];for(let s=0,i=0;s<t.length;s++)e.push(t[s]?i++:-1);return e}static maskGet(t,e){let s=[];for(let i=0;i<t.length;i++)e[i]&&s.push(t[i]);return s}static maskEqual(t,e){let s=[];if(e.constructor===Array){let i=e;for(let e=0;e<t.length;e++)s.push(t[e]==i[e])}else for(let i=0;i<t.length;i++)s.push(t[i]==e);return s}static sum(t){if(null==t||0==t.length)return 0;let e=t[0];for(let s=1;s<t.length;s++)e+=t[s];return e}static add(t,e){let s=[];if(e.constructor===Array){let i=e;for(let e=0;e<t.length;e++)s.push(t[e]+i[e])}else for(let i=0;i<t.length;i++)s.push(t[i]+e);return s}static sub(t,e){let s=[];if(e.constructor===Array){let i=e;for(let e=0;e<t.length;e++)s.push(t[e]-i[e])}else for(let i=0;i<t.length;i++)s.push(t[i]-e);return s}static mul(t,e){let s=[];if(e.constructor===Array){let i=e;for(let e=0;e<t.length;e++)s.push(t[e]*i[e])}else for(let i=0;i<t.length;i++)s.push(t[i]*e);return s}static neg(t){let e=t.slice(0);for(let t=e.length-1;t>=0;t--)e[t]*=-1;return e}static setTo(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]=e}static addTo(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]+=e}static mulBy(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]*=e}static addToArray(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]+=e[s]}static subFromArray(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]-=e[s]}static mulByArray(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]*=e[s]}static divByArray(t,e){for(let s=null==t?-1:t.length-1;s>=0;s--)t[s]/=e[s]}static idxSort(t){let e=new Array(t.length);for(let s=0;s<t.length;s++)e[s]=s;return e.sort(((e,s)=>t[e]<t[s]?-1:t[e]>t[s]?1:0)),e}static sort(t){t.sort(((t,e)=>t-e))}static sorted(t){return t=t.slice(0),this.sort(t),t}static sortedUnique(t){if(null==t||0==t.length)return[];let e=s.uniqueUnstable(t);return"number"==typeof t[0]?this.sort(e):e.sort(),e}static uniqueUnstable(t){return Array.from(new Set(t))}static uniqueStable(t){let e=new Set(t),s=[];for(let i of t)e.has(i)&&(s.push(i),e.delete(i));return s}static maskUnique(t){let e=new Set(t),s=this.booleanArray(!1,t.length);for(let i=0;i<t.length;i++)e.has(t[i])&&(s[i]=!0,e.delete(t[i]));return s}static idxUnique(t){let e=new Set(t),s=[];for(let i=0;i<t.length;i++)e.has(t[i])&&(s.push(i),e.delete(t[i]));return s}static exclude(t,e){const i=s.len(t);if(0==i)return[];let o=new Array(i),n=0;for(let s=0;s<t.length;s++)o[s]=e.indexOf(t[s])<0,o[s]&&n++;return n==i?t:s.maskGet(t,o)}}class i{static parityPerms(t){let e=s.booleanArray(!1,t.length),i=0;for(let s=t.length-1;s>=0;s--)if(e[s])i++;else{let i=s;do{i=t[i],e[i]=!0}while(i!=s)}return i}static parityIdentity(t){return 1&this.parityPerms(t)}static parityOrder(t){if(t.length<=1)return 0;if(2==t.length)return t[0]<t[1]?0:1;if(3==t.length){let e=1;return t[0]<t[1]&&e++,t[0]<t[2]&&e++,t[1]<t[2]&&e++,1&e}if(4==t.length){let e=0;return t[0]<t[1]&&e++,t[0]<t[2]&&e++,t[0]<t[3]&&e++,t[1]<t[2]&&e++,t[1]<t[3]&&e++,t[2]<t[3]&&e++,1&e}let e=[],s=t.slice(0);s.sort();for(let i=0;i<t.length;i++)e.push(s.indexOf(t[i]));return this.parityIdentity(e)}static smallPermutation(t){return 1==t?this.PERM1:2==t?this.PERM2:3==t?this.PERM3:4==t?this.PERM4:null}static allPermutations(t){if(t<=this.SMALL_PERMS)return this.smallPermutation(t);for(;this.PERM_CACHE.length<this.MAX_CACHE-this.SMALL_PERMS;)this.PERM_CACHE.push(null);if(t<this.MAX_CACHE&&null!=this.PERM_CACHE[t-this.SMALL_PERMS])return this.PERM_CACHE[t-this.SMALL_PERMS];let e=1;for(let s=2;s<=t;s++)e*=s;let i=[],o=s.identity0(t);i.push(o.slice(0));let n=s.booleanArray(!1,t);for(let l=1;l<e;l++)t:for(;o[0]<t;){o[t-1]++;for(let e=t-1;e>0&&!(o[e]<t);e--)o[e]=0,o[e-1]++;s.setTo(n,!1);for(let t of o){if(n[t])continue t;n[t]=!0}i[l]=o.slice(0);break}return t<this.MAX_CACHE&&(this.PERM_CACHE[t-this.SMALL_PERMS]=i),i}}i.PERM1=[[0]],i.PERM2=[[0,1],[1,0]],i.PERM3=[[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]],i.PERM4=[[0,1,2,3],[0,1,3,2],[0,2,1,3],[0,2,3,1],[0,3,1,2],[0,3,2,1],[1,0,2,3],[1,0,3,2],[1,2,0,3],[1,2,3,0],[1,3,0,2],[1,3,2,0],[2,0,1,3],[2,0,3,1],[2,1,0,3],[2,1,3,0],[2,3,0,1],[2,3,1,0],[3,0,1,2],[3,0,2,1],[3,1,0,2],[3,1,2,0],[3,2,0,1],[3,2,1,0]],i.SMALL_PERMS=4,i.MAX_CACHE=8,i.PERM_CACHE=[];class o{constructor(t,e,i=0){if(this.m=t,this.n=e,0!=t){this.A=new Array(t);for(let o=0;o<t;o++)this.A[o]=s.numberArray(i,e)}}static fromArray(t){let e=new o(0,0);return e.A=t,e.m=t.length,e.n=t[0].length,e}clone(){const{A:t,m:e,n:s}=this;let i=new o(e,s);for(let o=0;o<e;o++)for(let e=0;e<s;e++)i.A[o][e]=t[o][e];return i}get numRows(){return this.m}get numCols(){return this.n}get(t,e){return this.A[t][e]}set(t,e,s){this.A[t][e]=s}transpose(){const{A:t,m:e,n:s}=this;let i=new o(s,e);const n=i.A;for(let i=0;i<e;i++)for(let e=0;e<s;e++)n[e][i]=t[i][e];return i}norm1(){const{A:t,m:e,n:s}=this;let i=0;for(let o=0;o<s;o++){let s=0;for(let i=0;i<e;i++)s+=Math.abs(t[i][o]);i=Math.max(i,s)}return i}normInf(){const{A:t,m:e,n:s}=this;let i=0;for(let o=0;o<e;o++){let e=0;for(let i=0;i<s;i++)e+=Math.abs(t[o][i]);i=Math.max(i,e)}return i}uminus(){const{A:t,m:e,n:s}=this;let i=new o(e,s),n=i.A;for(let i=0;i<e;i++)for(let e=0;e<s;e++)n[i][e]=-t[i][e];return i}plus(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=n.A;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=e[o][s]+t.A[o][s];return n}plusEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=e[o][s]+t.A[o][s];return this}minus(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=e;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=e[o][s]-t.A[o][s];return n}minusEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=e[o][s]-t.A[o][s];return this}arrayTimes(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=n.A;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=e[o][s]*t.A[o][s];return n}arrayTimesEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=e[o][s]*t.A[o][s];return this}arrayRightDivide(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=n.A;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=e[o][s]/t.A[o][s];return n}arrayRightDivideEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=e[o][s]/t.A[o][s];return this}arrayLeftDivide(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=n.A;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=t.A[o][s]/e[o][s];return n}arrayLeftDivideEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=t.A[o][s]/e[o][s];return this}scalarTimes(t){const{A:e,m:s,n:i}=this;let n=new o(s,i),l=n.A;for(let o=0;o<s;o++)for(let s=0;s<i;s++)l[o][s]=t*e[o][s];return n}scalarTimesEquals(t){const{A:e,m:s,n:i}=this;for(let o=0;o<s;o++)for(let s=0;s<i;s++)e[o][s]=t*e[o][s];return this}times(t){const{A:e,m:s,n:i}=this;let n=new o(s,t.n),l=n.A,r=new Array(i);for(let o=0;o<t.n;o++){for(let e=0;e<i;e++)r[e]=t.A[e][o];for(let t=0;t<s;t++){let s=e[t],n=0;for(let t=0;t<i;t++)n+=s[t]*r[t];l[t][o]=n}}return n}rank(){return new n(this).rank()}cond(){return new n(this).cond()}trace(){const{A:t,m:e,n:s}=this;let i=0;for(let o=0;o<Math.min(e,s);o++)i+=t[o][o];return i}static identity(t,e){let s=new o(t,e),i=s.A;for(let s=0;s<t;s++)for(let t=0;t<e;t++)i[s][t]=s==t?1:0;return s}toString(){let t=["["];for(let e of this.A)t.push(JSON.stringify(e));return t.push("]"),t.join("\n")}}class n{constructor(t){let e=t.A,i=this.m=t.m,o=this.n=t.n,l=Math.min(i,o),r=this.s=new Array(Math.min(i+1,o)),a=this.U=new Array(i),h=this.V=new Array(o);for(let t=0;t<i;t++)a[t]=s.numberArray(0,l);for(let t=0;t<o;t++)h[t]=s.numberArray(0,o);let u=new Array(o),m=new Array(i),d=Math.min(i-1,o),c=Math.max(0,Math.min(o-2,i));for(let t=0;t<Math.max(d,c);t++){if(t<d){r[t]=0;for(let s=t;s<i;s++)r[t]=n.hypot(r[t],e[s][t]);if(0!=r[t]){e[t][t]<0&&(r[t]=-r[t]);for(let s=t;s<i;s++)e[s][t]/=r[t];e[t][t]+=1}r[t]=-r[t]}for(let s=t+1;s<o;s++){if(t<d&&0!=r[t]){let o=0;for(let n=t;n<i;n++)o+=e[n][t]*e[n][s];o=-o/e[t][t];for(let n=t;n<i;n++)e[n][s]+=o*e[n][t]}u[s]=e[t][s]}if(t<d)for(let s=t;s<i;s++)a[s][t]=e[s][t];if(t<c){u[t]=0;for(let e=t+1;e<o;e++)u[t]=n.hypot(u[t],u[e]);if(0!=u[t]){u[t+1]<0&&(u[t]=-u[t]);for(let e=t+1;e<o;e++)u[e]/=u[t];u[t+1]+=1}if(u[t]=-u[t],t+1<i&&0!=u[t]){for(let e=t+1;e<i;e++)m[e]=0;for(let s=t+1;s<o;s++)for(let o=t+1;o<i;o++)m[o]+=u[s]*e[o][s];for(let s=t+1;s<o;s++){let o=-u[s]/u[t+1];for(let n=t+1;n<i;n++)e[n][s]+=o*m[n]}}for(let e=t+1;e<o;e++)h[e][t]=u[e]}}let p=Math.min(o,i+1);d<o&&(r[d]=e[d][d]),i<p&&(r[p-1]=0),c+1<p&&(u[c]=e[c][p-1]),u[p-1]=0;for(let t=d;t<l;t++){for(let e=0;e<i;e++)a[e][t]=0;a[t][t]=1}for(let t=d-1;t>=0;t--)if(0!=r[t]){for(let e=t+1;e<l;e++){let s=0;for(let o=t;o<i;o++)s+=a[o][t]*a[o][e];s=-s/a[t][t];for(let o=t;o<i;o++)a[o][e]+=s*a[o][t]}for(let e=t;e<i;e++)a[e][t]=-a[e][t];a[t][t]=1+a[t][t];for(let e=0;e<t-1;e++)a[e][t]=0}else{for(let e=0;e<i;e++)a[e][t]=0;a[t][t]=1}for(let t=o-1;t>=0;t--){if(t<c&&0!=u[t])for(let e=t+1;e<l;e++){let s=0;for(let i=t+1;i<o;i++)s+=h[i][t]*h[i][e];s=-s/h[t+1][t];for(let i=t+1;i<o;i++)h[i][e]+=s*h[i][t]}for(let e=0;e<o;e++)h[e][t]=0;h[t][t]=1}let f=p-1,g=0,b=Math.pow(2,-52),A=Math.pow(2,-966);for(;p>0;){let t,e;for(t=p-2;t>=-1&&-1!=t;t--)if(Math.abs(u[t])<=A+b*(Math.abs(r[t])+Math.abs(r[t+1]))){u[t]=0;break}if(t==p-2)e=4;else{let s;for(s=p-1;s>=t&&s!=t;s--){let e=(s!=p?Math.abs(u[s]):0)+(s!=t+1?Math.abs(u[s-1]):0);if(Math.abs(r[s])<=A+b*e){r[s]=0;break}}s==t?e=3:s==p-1?e=1:(e=2,t=s)}if(t++,1==e){let e=u[p-2];u[p-2]=0;for(let s=p-2;s>=t;s--){let i=n.hypot(r[s],e),l=r[s]/i,a=e/i;r[s]=i,s!=t&&(e=-a*u[s-1],u[s-1]=l*u[s-1]);for(let t=0;t<o;t++)i=l*h[t][s]+a*h[t][p-1],h[t][p-1]=-a*h[t][s]+l*h[t][p-1],h[t][s]=i}}else if(2==e){let e=u[t-1];u[t-1]=0;for(let s=t;s<p;s++){let o=n.hypot(r[s],e),l=r[s]/o,h=e/o;r[s]=o,e=-h*u[s],u[s]=l*u[s];for(let e=0;e<i;e++)o=l*a[e][s]+h*a[e][t-1],a[e][t-1]=-h*a[e][s]+l*a[e][t-1],a[e][s]=o}}else if(3==e){let e=Math.max(Math.max(Math.max(Math.max(Math.abs(r[p-1]),Math.abs(r[p-2])),Math.abs(u[p-2])),Math.abs(r[t])),Math.abs(u[t])),s=r[p-1]/e,l=r[p-2]/e,m=u[p-2]/e,d=r[t]/e,c=u[t]/e,f=((l+s)*(l-s)+m*m)/2,b=s*m*(s*m),A=0;0==f&&0==b||(A=Math.sqrt(f*f+b),f<0&&(A=-A),A=b/(f+A));let y=(d+s)*(d-s)+A,E=d*c;for(let e=t;e<p-1;e++){let s=n.hypot(y,E),l=y/s,m=E/s;e!=t&&(u[e-1]=s),y=l*r[e]+m*u[e],u[e]=l*u[e]-m*r[e],E=m*r[e+1],r[e+1]=l*r[e+1];for(let t=0;t<o;t++)s=l*h[t][e]+m*h[t][e+1],h[t][e+1]=-m*h[t][e]+l*h[t][e+1],h[t][e]=s;if(s=n.hypot(y,E),l=y/s,m=E/s,r[e]=s,y=l*u[e]+m*r[e+1],r[e+1]=-m*u[e]+l*r[e+1],E=m*u[e+1],u[e+1]=l*u[e+1],e<i-1)for(let t=0;t<i;t++)s=l*a[t][e]+m*a[t][e+1],a[t][e+1]=-m*a[t][e]+l*a[t][e+1],a[t][e]=s}u[p-2]=y,g+=1}else if(4==e){if(r[t]<=0){r[t]=r[t]<0?-r[t]:0;for(let e=0;e<=f;e++)h[e][t]=-h[e][t]}for(;t<f&&!(r[t]>=r[t+1]);){let e=r[t];if(r[t]=r[t+1],r[t+1]=e,t<o-1)for(let s=0;s<o;s++)e=h[s][t+1],h[s][t+1]=h[s][t],h[s][t]=e;if(t<i-1)for(let s=0;s<i;s++)e=a[s][t+1],a[s][t+1]=a[s][t],a[s][t]=e;t++}g=0,p--}}}getU(){return o.fromArray(this.U)}getV(){return o.fromArray(this.V)}getSingularValues(){return this.s}getS(){const{n:t}=this;let e=new o(t,t,0),s=e.A;for(let e=0;e<t;e++)s[e][e]=this.s[e];return e}norm2(){return this.s[0]}cond(){const{m:t,n:e,s}=this;return s[0]/s[Math.min(t,e)-1]}rank(){const{m:t,n:e,s}=this;let i=Math.pow(2,-52),o=Math.max(t,e)*s[0]*i,n=0;for(let t=0;t<s.length;t++)s[t]>o&&n++;return n}static hypot(t,e){let s;return Math.abs(t)>Math.abs(e)?(s=e/t,s=Math.abs(t)*Math.sqrt(1+s*s)):0!=e?(s=t/e,s=Math.abs(e)*Math.sqrt(1+s*s)):s=0,s}}const l=Math.pow(2,-52);class r{constructor(t,e){this.px=t,this.py=e,this.numTriangles=0,this.edgeStack=s.numberArray(0,512),this.hull=null,this.px=t,this.py=e,this.sz=t.length;let i=Math.max(2*this.sz-5,0);this.triangles=new Array(3*i),this.halfedges=new Array(3*i),this.hashSize=Math.ceil(Math.sqrt(this.sz)),this.hullPrev=new Array(this.sz),this.hullNext=new Array(this.sz),this.hullTri=new Array(this.sz),this.hullHash=s.numberArray(-1,this.hashSize),this.ids=new Array(this.sz),this.dists=new Array(this.sz),this.update()}trimConcave(t){const e=V(t),{sz:i,px:o,py:n}=this;let l=this.triangles.slice(0),r=new Map;for(;;){const t=l.length/3;r.clear();for(let e=0,s=0;e<t;e++,s+=3){const t=i*Math.min(l[s+0],l[s+1])+Math.max(l[s+0],l[s+1]),e=i*Math.min(l[s+0],l[s+2])+Math.max(l[s+0],l[s+2]),o=i*Math.min(l[s+1],l[s+2])+Math.max(l[s+1],l[s+2]);r.set(t,(r.get(t)||0)+1),r.set(e,(r.get(e)||0)+1),r.set(o,(r.get(o)||0)+1)}let a=s.booleanArray(!0,t);for(let s=0,h=0;s<t;s++,h+=3){const t=l[h],u=l[h+1],m=l[h+2],d=i*Math.min(t,u)+Math.max(t,u),c=i*Math.min(t,m)+Math.max(t,m),p=i*Math.min(u,m)+Math.max(u,m),f=r.get(d),g=r.get(c),b=r.get(p);1==f&&1!=g&&1!=b?a[s]=X(o[t]-o[u],n[t]-n[u])<e:1!=f&&1==g&&1!=b?a[s]=X(o[t]-o[m],n[t]-n[m])<e:1!=f&&1!=g&&1==b&&(a[s]=X(o[u]-o[m],n[u]-n[m])<e)}if(s.allTrue(a))break;let h=new Array(3*s.maskCount(a));for(let e=0,s=0,i=0;e<t;e++,s+=3)a[e]&&(h[i++]=l[s],h[i++]=l[s+1],h[i++]=l[s+2]);l=h}return l}traceOutline(t){const e=t.length/3,{sz:i,px:o,py:n}=this;let l=new Map;for(let s=0,o=0;s<e;s++,o+=3){const e=i*Math.min(t[o+0],t[o+1])+Math.max(t[o+0],t[o+1]),s=i*Math.min(t[o+0],t[o+2])+Math.max(t[o+0],t[o+2]),n=i*Math.min(t[o+1],t[o+2])+Math.max(t[o+1],t[o+2]);l.set(e,(l.get(e)||0)+1),l.set(s,(l.get(s)||0)+1),l.set(n,(l.get(n)||0)+1)}let r=[];for(let t of l.entries())if(1==t[1]){const e=t[0],s=Math.floor(e/i),o=e%i;r.push(s),r.push(o)}const a=s.uniqueUnstable(r),h=a.length,u=new Map;for(let t=0;t<h;t++)u.set(a[t],t);let m=s.numberArray(-1,h),d=s.numberArray(-1,h);for(let t=0;t<r.length;t+=2){const e=u.get(r[t]),s=u.get(r[t+1]);m[e]<0?m[e]=s:d[e]=s,m[s]<0?m[s]=e:d[s]=e}let c=s.booleanArray(!1,h),p=new Array(h);p[0]=0,c[0]=!0;for(let t=1;t<h;t++){const e=p[t-1];c[m[e]]?p[t]=d[e]:p[t]=m[e],c[p[t]]=!0}return s.idxGet(a,p)}update(){const t=this.sz;let{px:e,py:i,ids:o,dists:n,triangles:r,halfedges:a}=this;const h=s.min(e),u=s.min(i),m=s.max(e),d=s.max(i);for(let e=0;e<t;e++)o[e]=e;this.centreX=.5*(h+m),this.centreY=.5*(u+d);let c=0,p=0,f=0,g=Number.POSITIVE_INFINITY;for(let s=0;s<t;s++){const t=U(this.centreX-e[s],this.centreY-i[s]);t<g&&(c=s,g=t)}const b=e[c],A=i[c];g=Number.POSITIVE_INFINITY;for(let s=0;s<t;s++){if(s==c)continue;const t=U(b-e[s],A-i[s]);t<g&&t>0&&(p=s,g=t)}let y=e[p],E=i[p],M=Number.POSITIVE_INFINITY;for(let s=0;s<t;s++){if(s==c||s==p)continue;let t=this.circumRadius(b,A,y,E,e[s],i[s]);t<M&&(f=s,M=t)}let T=e[f],x=i[f];if(!Number.isFinite(M)){for(let s=0;s<t;s++)n[s]=e[s]-e[0],0==n[s]&&(n[s]=i[s]-i[0]);this.quicksort(0,t-1);let s=new Array(t),l=0,h=Number.NEGATIVE_INFINITY;for(let e=0;e<t;e++){let t=o[e];n[t]>h&&(s[l++]=t,h=n[t])}return this.hull=s.slice(0,l),r=[],void(a=[])}if(this.orient(b,A,y,E,T,x)){let t=p,e=y,s=E;p=f,y=T,E=x,f=t,T=e,x=s}this.pickCircumCentre(b,A,y,E,T,x);for(let s=0;s<t;s++)n[s]=U(e[s]-this.centreX,i[s]-this.centreY);this.quicksort(0,t-1),this.hullStart=c;let v=3;const{hullNext:C,hullPrev:N,hullTri:S,hullHash:w,hashSize:O}=this;C[c]=N[f]=p,C[p]=N[c]=f,C[f]=N[p]=c,S[c]=0,S[p]=1,S[f]=2,w.fill(-1),w[this.hashKey(b,A)]=c,w[this.hashKey(y,E)]=p,w[this.hashKey(T,x)]=f,this.numTriangles=0,this.addTriangle(c,p,f,-1,-1,-1);let q=0,B=0;for(let t=0;t<o.length;t++){let s=o[t],n=e[s],r=i[s];if(t>0&&Math.abs(n-q)<=l&&Math.abs(r-B)<=l)continue;if(q=n,B=r,s==c||s==p||s==f)continue;let a=0;for(let t=0,e=this.hashKey(n,r);t<O&&(a=w[(e+t)%O],!(a>=0&&a!=C[a]));t++);a=N[a];let h=a,u=C[h];for(;!this.orient(n,r,e[h],i[h],e[u],i[u]);){if(h=u,h==a){h=-1;break}u=C[h]}if(h<0)continue;let m=this.addTriangle(h,s,C[h],-1,-1,S[h]);S[s]=this.legalise(m+2),S[h]=m,v++;let d=C[h];for(u=C[d];this.orient(n,r,e[d],i[d],e[u],i[u]);)m=this.addTriangle(d,s,u,S[s],-1,S[d]),S[s]=this.legalise(m+2),C[d]=d,v--,d=u,u=C[d];if(h==a)for(u=N[h];this.orient(n,r,e[u],i[u],e[h],i[h]);)m=this.addTriangle(u,s,h,-1,S[h],S[u]),this.legalise(m+2),S[u]=m,C[h]=h,v--,h=u,u=N[h];this.hullStart=N[s]=h,C[h]=N[d]=s,C[s]=d,w[this.hashKey(n,r)]=s,w[this.hashKey(e[h],i[h])]=h}this.hull=new Array(v);for(let t=0,e=this.hullStart;t<v;t++)this.hull[t]=e,e=C[e];this.triangles=r.slice(0,this.numTriangles),this.halfedges=a.slice(0,this.numTriangles)}hashKey(t,e){return Math.floor(this.pseudoAngle(t-this.centreX,e-this.centreY)*this.hashSize)%this.hashSize}legalise(t){let e=0,s=0;for(;;){let i=this.halfedges[t],o=t-t%3;if(s=o+(t+2)%3,i<0){if(0==e)break;t=this.edgeStack[--e];continue}const n=i-i%3,l=o+(t+1)%3,r=n+(i+2)%3,{px:a,py:h,triangles:u,halfedges:m}=this,d=u[s],c=u[t],p=u[l],f=u[r];if(this.inCircle(a[d],h[d],a[c],h[c],a[p],h[p],a[f],h[f])){this.triangles[t]=f,this.triangles[i]=d;const o=m[r];if(o<0){let e=this.hullStart;do{if(this.hullTri[e]==r){this.hullTri[e]=t;break}e=this.hullPrev[e]}while(e!=this.hullStart)}this.link(t,o),this.link(i,m[s]),this.link(s,r);const l=n+(i+1)%3;e<this.edgeStack.length&&(this.edgeStack[e++]=l)}else{if(0==e)break;t=this.edgeStack[--e]}}return s}link(t,e){this.halfedges[t]=e,e>=0&&(this.halfedges[e]=t)}addTriangle(t,e,s,i,o,n){const l=this.numTriangles;return this.triangles[l]=t,this.triangles[l+1]=e,this.triangles[l+2]=s,this.link(l,i),this.link(l+1,o),this.link(l+2,n),this.numTriangles+=3,l}pseudoAngle(t,e){const s=t/(Math.abs(t)+Math.abs(e));return(e>0?3-s:1+s)/4}orientIfSure(t,e,s,i,o,n){const l=(i-e)*(o-t),r=(s-t)*(n-e);return Math.abs(l-r)>=33306690738754716e-32*Math.abs(l+r)?l-r:0}orient(t,e,s,i,o,n){let l=this.orientIfSure(o,n,t,e,s,i);return 0!=l||(l=this.orientIfSure(t,e,s,i,o,n),0!=l||(l=this.orientIfSure(s,i,o,n,t,e))),l<0}inCircle(t,e,s,i,o,n,l,r){const a=t-l,h=e-r,u=s-l,m=i-r,d=o-l,c=n-r,p=u*u+m*m,f=d*d+c*c;return a*(m*f-p*c)-h*(u*f-p*d)+(a*a+h*h)*(u*c-m*d)<0}circumRadius(t,e,s,i,o,n){const l=s-t,r=i-e,a=o-t,h=n-e,u=l*l+r*r,m=a*a+h*h,d=.5/(l*h-r*a),c=(h*u-r*m)*d,p=(l*m-a*u)*d;return c*c+p*p}pickCircumCentre(t,e,s,i,o,n){const l=s-t,r=i-e,a=o-t,h=n-e,u=l*l+r*r,m=a*a+h*h,d=.5/(l*h-r*a);this.centreX=t+(h*u-r*m)*d,this.centreY=e+(l*m-a*u)*d}quicksort(t,e){const{ids:i,dists:o}=this;if(e-t<=20)for(let s=t+1;s<=e;s++){const e=i[s],n=o[e];let l=s-1;for(;l>=t&&o[i[l]]>n;)i[l+1]=i[l--];i[l+1]=e}else{let n=t+e>>1,l=t+1,r=e;s.swap(i,n,l),o[i[t]]>o[i[e]]&&s.swap(i,t,e),o[i[l]]>o[i[e]]&&s.swap(i,l,e),o[i[t]]>o[i[l]]&&s.swap(i,t,l);let a=i[l];const h=o[a];for(;;){do{l++}while(o[i[l]]<h);do{r--}while(o[i[r]]>h);if(r<l)break;s.swap(i,l,r)}i[t+1]=i[r],i[r]=a,e-l+1>=r-t?(this.quicksort(l,e),this.quicksort(t,r-1)):(this.quicksort(t,r-1),this.quicksort(l,e))}}}class a{static pointInPolygon(t,e,s,i){if(t<lt(s)||t>rt(s)||e<lt(i)||e>rt(i))return!1;let o=s.length;for(let n=0;n<o;n++)if(s[n]==t&&i[n]==e)return!0;let n=!1;for(let l=0;l<o;l++){let r=s[l],a=i[l],h=s[l+1<o?l+1:0],u=i[l+1<o?l+1:0];if(e>Math.min(a,u)&&e<=Math.max(a,u)&&t<=Math.max(r,h)&&a!=u){let s=(e-a)*(h-r)/(u-a)+r;(r==h||t<=s)&&(n=!n)}}return n}static areLinesParallel(t,e,s,i,o,n,l,r){let a=s-t,h=l-o,u=i-e,m=r-n;return $(a,h)&&$(u,m)||$(a,-h)&&$(u,-m)}static lineIntersect(t,e,s,i,o,n,l,r){let a=((l-o)*(e-n)-(r-n)*(t-o))/((r-n)*(s-t)-(l-o)*(i-e));return[t+a*(s-t),e+a*(i-e)]}static isPointOnLineSeg(t,e,s,i,o,n){if(t<Math.min(s,o)||t>Math.max(s,o)||e<Math.min(i,n)||e>Math.max(i,n))return!1;if(t==s&&e==i||t==o&&e==n)return!0;let l=o-s,r=n-i;return Math.abs(l)>Math.abs(r)?$(e,r/l*(t-s)+i):$(t,l/r*(e-i)+s)}static pointLineDistance(t,e,s,i,o,n){let l=o-s,r=n-i;return Math.abs(r*t-l*e+o*i-n*s)/U(l,r)}static pointLineSegDistance(t,e,s,i,o,n){let l=o-s,r=n-i,a=((t-s)*l+(e-i)*r)/X(l,r);return a=Math.max(0,Math.min(1,a)),U(t-(s+a*l),e-(i+a*r))}static doLineSegsIntersect(t,e,s,i,o,n,l,r){if(Math.max(t,s)<Math.min(o,l)||Math.max(e,i)<Math.min(n,r))return!1;if(Math.min(t,s)>Math.max(o,l)||Math.min(e,i)>Math.max(n,r))return!1;if(t==o&&e==n||t==l&&e==r||s==o&&i==n||s==l&&i==r)return!0;if(!(t!=s&&o!=l||t!=o&&t!=l&&s!=o&&s!=l))return!0;if(!(e!=i&&n!=r||e!=n&&e!=r&&i!=n&&i!=r))return!0;let a=l-o,h=r-n,u=s-t,m=i-e,d=t-o,c=e-n,p=a*c-h*d,f=u*c-m*d,g=h*u-a*m;return 0!=g&&(g<0&&(g=-g,p=-p,f=-f),p>=0&&p<=g&&f>=0&&f<=g)}static rectsIntersect(t,e,s,i,o,n,l,r){return t<=o&&t+s>=o+l&&e<=n&&e+i>=n+r||o<=t&&o+l>=t+s&&n<=e&&n+r>=e+i||!(t+s<o||o+l<t||e+i<n||n+r<e)}static sortAngles(t){if(null==t||t.length<2)return t;t=t.slice(0);for(let e=0;e<t.length;e++)t[e]=et(t[e]);if(2==t.length)return it(t[1],t[0])>Math.PI?[t[1],t[0]]:t;for(s.sort(t);;){let e=t[t.length-1],s=t[0],i=t[1];if(st(s,e)<=st(i,s))break;for(let e=t.length-1;e>0;e--)t[e]=t[e-1];t[0]=e}return t}static idxSortAngles(t){const e=s.len(t);if(null==t||e<2)return s.identity0(e);if(2==e)return it(t[1],t[0])>Math.PI?[1,0]:[0,1];t=s.duplicate(t);for(let s=0;s<e;s++)t[s]=et(t[s]);let i=s.idxSort(t);for(;;){let s=t[i[e-1]],o=t[i[0]],n=t[i[1]];if(st(o,s)<=st(n,o))break;let l=i.pop();i.unshift(l)}return i}static uniqueAngles(t,e){let s=a.sortAngles(t),i=[];i.push(s[0]);for(let t=1;t<s.length;t++)Math.abs(st(s[t],s[t-1]))>e&&i.push(s[t]);return i}static thetaObtuse(t,e){let s=e-t;for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;return s>0?t-.5*(2*Math.PI-s):t+.5*(2*Math.PI+s)}static emergentAngle(t){let e=t.length;if(1==e)return t[0];if(2==e)return.5*(t[0]+t[1]);s.sort(t);let i=0,o=it(t[0],t[e-1]);for(let s=1;s<e;s++){let e=it(t[s],t[s-1]);e>o&&(i=s,o=e)}let n=0;for(let s=0;s<e;s++){let e=t[s]-t[i];e<0&&(e+=K),n+=e}return n/e+t[i]}static dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static crossProduct(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}static affineTranslate(t,e){return[[1,0,t],[0,1,e],[0,0,1]]}static affineMirror(t,e){return[[t?-1:1,0,0],[0,e?-1:1,0],[0,0,1]]}static affineScale(t,e){return[[t,0,0],[0,e,0],[0,0,1]]}static affineRotate(t){let e=Math.cos(t),s=Math.sin(t);return[[e,-s,0],[s,e,0],[0,0,1]]}static affineCompose(t,e){let s=[[0,0,0],[0,0,0],[0,0,0]],i=[0,0,0];for(let o=0;o<3;o++){for(let e=0;e<3;e++)i[e]=t[e][o];for(let t=0;t<3;t++){let n=e[t],l=0;for(let t=0;t<3;t++)l+=i[t]*n[t];s[t][o]=l}}return s}static applyAffine(t,e,s){return[t*s[0][0]+e*s[0][1]+s[0][2],t*s[1][0]+e*s[1][1]+s[1][2]]}static isAffineMirror(t){let e=t[0][0],s=t[0][1],i=t[0][2],o=t[1][0],n=t[1][1],l=t[1][2],r=t[2][0],a=t[2][1],h=t[2][2];return e*n*h+s*l*r+i*o*a-i*n*r-s*o*h-e*l*a<0}static magnitude2(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}static magnitude(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static dist2(t,e){let s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return s*s+i*i+o*o}static dist(t,e){let s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(s*s+i*i+o*o)}static normalise(t){const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(0==e)return;const s=1/Math.sqrt(e);t[0]*=s,t[1]*=s,t[2]*=s}static normalised(t){let e=t.slice(0);return this.normalise(e),e}static acuteAngle(t,e){let s=this.magnitude(t),i=this.magnitude(e);if(0==s||0==i)return 0;let o=this.dotProduct(t,e)/(s*i);return o=Math.max(-1,Math.min(1,o)),Math.acos(o)}static arcControlPoints(t,e,s,i,o){let n=-s,l=e,r=o,a=-i,h=.5*(e+i),u=.5*(s+o),m=3/8*(n+r),d=3/8*(l+a),c=m*m+d*d,p=h*m+u*d,f=p*p-c*(h*h+u*u-t*t),g=(Math.sqrt(f)-p)/c;return[e+g*n,s+g*l,i+g*r,o+g*a]}static fitCircle(t,e){let s=Number.POSITIVE_INFINITY;for(let i=0;i<t.length;i++)s=Math.min(s,X(t[i],e[i]));return Math.sqrt(s)}static fitEllipse(t,e,i,o,n,l){let r=.5*this.fitCircle(t,e),a=r,h=r*a,u=s.concat(t,[i,n,0,0]),m=s.concat(e,[0,0,o,l]);const d=u.length;let c=t=>{let e=Number.POSITIVE_INFINITY,s=1/(t[0]*t[0]),i=1/(t[1]*t[1]);for(let t=0;t<d;t++)e=Math.min(e,Math.sqrt(u[t]*u[t]*s+m[t]*m[t]*i));e<1&&(t[0]*=e,t[1]*=e),t[2]=t[0]*t[1]},p=1,f=[0,0,0],g=[0,0,0];for(;p>.001;){f[0]=r*(1+p),f[1]=a,c(f),g[0]=r,g[1]=a*(1+p),c(g);let t=!1;f[2]>h&&(r=f[0],a=f[1],h=f[2],t=!0),g[2]>h&&(r=g[0],a=g[1],h=g[2],t=!0),t||(p*=.6)}return[r,a]}static superimpose(t,e,i,l){let r=t.length;if(1==r)return[[1,0,i[0]-t[0]],[0,1,l[0]-e[0]],[0,0,1]];if(2==r){let s=Math.atan2(e[1]-e[0],t[1]-t[0]),o=st(Math.atan2(l[1]-l[0],i[1]-i[0]),s),n=Math.cos(o),r=Math.sin(o),a=n,h=-r,u=r,m=n,d=.5*(t[0]+t[1]),c=.5*(e[0]+e[1]);return[[a,h,.5*(i[0]+i[1])-(a*d+h*c)],[u,m,.5*(l[0]+l[1])-(u*d+m*c)],[0,0,1]]}let a=1/r,h=s.sum(t)*a,u=s.sum(e)*a,m=s.sum(i)*a,d=s.sum(l)*a,c=new o(3,r),p=new o(3,r);for(let s=0;s<r;s++)c.set(0,s,t[s]-h),c.set(1,s,e[s]-u),c.set(2,s,0),p.set(0,s,i[s]-m),p.set(1,s,l[s]-d),p.set(2,s,0);let f=c.times(p.transpose()),g=new n(f),b=g.getV().times(g.getU().transpose()),A=b.get(0,0),y=b.get(0,1),E=b.get(1,0),M=b.get(1,1);return[[A,y,m-(A*h+y*u)],[E,M,d-(E*h+M*u)],[0,0,1]]}static convexHull(t,e,s){let i=new h(t,e,V(.1*s));return[i.hullX,i.hullY]}static outlinePolygon(t,e,i){let o=new r(t,e),n=o.trimConcave(i),l=o.traceOutline(n);return[s.idxGet(t,l),s.idxGet(e,l)]}}class h{constructor(t,e,s){this.x=t,this.y=e,this.threshSq=s,this.hsz=0,this.hullX=[],this.hullY=[];const i=t.length;let o=0,n=0;for(let s=0;s<i;s++)(t[n]>t[s]||t[n]==t[s]&&e[n]>e[s])&&(n=s),(t[o]<t[s]||t[o]==t[s]&&e[o]<e[s])&&(o=s);let l=[],r=[];for(let t=0;t<i;t++)t!=o&&t!=n&&(this.right(n,o,t)>0?l.push(t):r.push(t));this.hullX.push(t[n]),this.hullY.push(e[n]),this.quickHull(n,o,l),this.hullX.push(t[o]),this.hullY.push(e[o]),this.quickHull(o,n,r);for(let t=0;t<this.hullX.length-1;)X(this.hullX[t]-this.hullY[t+1],this.hullY[t]-this.hullY[t+1])<s?(this.hullX.splice(t+1,1),this.hullY.splice(t+1,1)):t++}quickHull(t,e,s){if(0==s.length)return;let i=this.furthestPoint(t,e,s),o=[],n=[];for(let l=0;l<s.length;l++){let r=s[l];r!=t&&r!=e&&(this.right(t,i,r)>0?o.push(r):this.right(i,e,r)>0&&n.push(r))}this.quickHull(t,i,o),this.hullX.push(this.x[i]),this.hullY.push(this.y[i]),this.quickHull(i,e,n)}right(t,e,s){const i=this.x,o=this.y;return(i[t]-i[e])*(o[s]-o[e])-(i[s]-i[e])*(o[t]-o[e])}distance(t,e,s){const i=this.x,o=this.y;let n=((i[s]-i[t])*(i[e]-i[t])+(o[s]-o[t])*(o[e]-o[t]))/((i[e]-i[t])*(i[e]-i[t])+(o[e]-o[t])*(o[e]-o[t])),l=i[t]+n*(i[e]-i[t]),r=o[t]+n*(o[e]-o[t]);return(l-i[s])*(l-i[s])+(r-o[s])*(r-o[s])}furthestPoint(t,e,s){let i=-1,o=-1;for(let n=0;n<s.length;n++){let l=s[n];if(l==t||l==e)continue;let r=this.distance(t,e,l);r>i&&(i=r,o=l)}return o}}class u{constructor(t,e,i){this.x=t,this.y=e,this.sequence=[];const o=t.length,n=i*i;let l=s.idxMax(t),r=l,a=0,h=s.booleanArray(!1,o);this.sequence.push(l);let u=()=>{let s=-1,i=0,l=0;for(let u=0;u<o;u++)if(u!=r&&!h[u]){let o=t[u]-t[r],h=e[u]-e[r],m=X(o,h);if(0==m||m>n)continue;let d=Math.atan2(h,o),c=it(d,a);(s<0||c<i)&&(s=u,i=c,l=d)}return s<0?-1:(a=et(l-.5*Math.PI),h[s]=!0,s)};for(;;){let t=u();if(t<0)return void(this.sequence=null);if(t==l)break;this.sequence.push(t),r=t}}sequencePos(){if(!this.sequence)return null;let t=[];for(let e of this.sequence)t.push(new m(this.x[e],this.y[e]));return t}sequenceXY(){if(!this.sequence)return[null,null];let t=[],e=[];for(let s of this.sequence)t.push(this.x[s]),e.push(this.y[s]);return[t,e]}}class m{constructor(t,e){this.x=null==t?0:t,this.y=null==e?0:e}static zero(){return new m}static fromArray(t){return new m(t[0],t[1])}clone(){return new m(this.x,this.y)}equals(t){return this.x==t.x&&this.y==t.y}scaleBy(t){1!=t&&(this.x*=t,this.y*=t)}offsetBy(t,e){this.x+=t,this.y+=e}withScaleBy(t){return new m(this.x*t,this.y*t)}withOffsetBy(t,e){return new m(this.x+t,this.y+e)}toString(){return"["+this.x+","+this.y+"]"}}class d{constructor(t,e){this.w=null==t?0:t,this.h=null==e?0:e}static zero(){return new d}static fromArray(t){return new d(t[0],t[1])}clone(){return new d(this.w,this.h)}equals(t){return this.w==t.w&&this.h==t.h}isZero(){return 0==this.w&&0==this.h}scaleBy(t){1!=t&&(this.w*=t,this.h*=t)}fitInto(t,e){let s=1;this.w>t&&(s=t/this.w),this.h>e&&(s=Math.min(s,e/this.h)),s<1&&this.scaleBy(s)}withScaleBy(t){return new d(this.w*t,this.h*t)}toString(){return"["+this.w+","+this.h+"]"}}class c{constructor(t,e,s,i){this.x=null==t?0:t,this.y=null==e?0:e,this.w=null==s?0:s,this.h=null==i?0:i}static zero(){return new c}static fromSize(t){return new c(0,0,t.w,t.h)}static fromOval(t){return new c(t.cx-t.rw,t.cy-t.rh,2*t.rw,2*t.rh)}static fromArray(t){return new c(t[0],t[1],t[2],t[3])}clone(){return new c(this.x,this.y,this.w,this.h)}equals(t){return this.x==t.x&&this.y==t.y&&this.w==t.w&&this.h==t.h}getPos(){return new m(this.x,this.y)}setPos(t){this.x=t.x,this.y=t.y}getSize(){return new d(this.w,this.h)}setSize(t){this.w=t.w,this.h=t.h}isZero(){return 0==this.w&&0==this.h}minX(){return this.x}minY(){return this.y}midX(){return this.x+.5*this.w}midY(){return this.y+.5*this.h}maxX(){return this.x+this.w}maxY(){return this.y+this.h}area(){return this.w*this.h}scaleBy(t){1!=t&&(this.x*=t,this.y*=t,this.w*=t,this.h*=t)}offsetBy(t,e){this.x+=t,this.y+=e}grow(t,e){this.x-=t,this.y-=e,this.w+=2*t,this.h+=2*e}withScaleBy(t){return new c(this.x*t,this.y*t,this.w*t,this.h*t)}withOffsetBy(t,e){return new c(this.x+t,this.y+e,this.w,this.h)}withGrow(t,e){return new c(this.x-t,this.y-e,this.w+2*t,this.h+2*e)}intersects(t){return a.rectsIntersect(this.x,this.y,this.w,this.h,t.x,t.y,t.w,t.h)}intersection(t){let e=this.x,s=e+this.w,i=this.y,o=i+this.h,n=t.x,l=n+t.w,r=t.y,a=r+t.h,h=Math.max(e,n),u=Math.max(i,r),m=Math.min(s,l),d=Math.min(o,a);return new c(h,u,m-h,d-u)}contains(t,e){return t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h}union(t){let e=Math.min(this.x,t.x),s=Math.max(this.x+this.w,t.x+t.w),i=Math.min(this.y,t.y),o=Math.max(this.y+this.h,t.y+t.h);return new c(e,i,s-e,o-i)}isEmpty(){return 0==this.w&&0==this.h}notEmpty(){return this.w>0||this.h>0}toString(){return"["+this.x+","+this.y+";"+this.w+","+this.h+"]"}}class p{constructor(t,e,s,i){this.cx=null==t?0:t,this.cy=null==e?0:e,this.rw=null==s?0:s,this.rh=null==i?0:i}static zero(){return new p}static fromBox(t){return new p(t.x+.5*t.w,t.y+.5*t.h,.5*t.w,.5*t.h)}static fromArray(t){return new p(t[0],t[1],t[2],t[3])}clone(){return new p(this.cx,this.cy,this.rw,this.rh)}setCentre(t){this.cx=t.x,this.cy=t.y}setRadius(t){this.rw=t.w,this.rh=t.h}minX(){return this.cx-this.rw}minY(){return this.cy-this.rh}maxX(){return this.cx+this.rw}maxY(){return this.cy+this.rh}scaleBy(t){1!=t&&(this.cx*=t,this.cy*=t,this.rw*=t,this.rh*=t)}offsetBy(t,e){this.cx+=t,this.cy+=e}withScaleBy(t){return new p(this.cx*t,this.cy*t,this.rw*t,this.rh*t)}withOffsetBy(t,e){return new p(this.cx+t,this.cy+e,this.rw,this.rh)}toString(){return"["+this.cx+","+this.cy+";"+this.rw+","+this.rh+"]"}}class f{constructor(t,e,s,i){this.x1=null==t?0:t,this.y1=null==e?0:e,this.x2=null==s?0:s,this.y2=null==i?0:i}static zero(){return new f}clone(){return new f(this.x1,this.y1,this.x2,this.y2)}setPos1(t){this.x1=t.x,this.y1=t.y}setPos2(t){this.x2=t.x,this.y2=t.y}minX(){return Math.min(this.x1,this.x2)}minY(){return Math.min(this.y1,this.y2)}maxX(){return Math.max(this.x1,this.x2)}maxY(){return Math.max(this.y1,this.y2)}scaleBy(t){1!=t&&(this.x1*=t,this.y1*=t,this.x2*=t,this.y2*=t)}offsetBy(t,e){this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e}toString(){return"["+this.x1+","+this.y1+";"+this.x2+","+this.y2+"]"}}class g{static parseXML(t){let e;return e=this.customParser?(new this.customParser).parseFromString(t,"application/xml"):(new DOMParser).parseFromString(t,"application/xml"),null==e?null:e}static toString(t){return this.customSerial?(new this.customSerial).serializeToString(t.documentElement):(new XMLSerializer).serializeToString(t.documentElement)}static toPrettyString(t){let e=['<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">','  <xsl:strip-space elements="*"/>','  <xsl:template match="para[content-style][not(text())]">','    <xsl:value-of select="normalize-space(.)"/>',"  </xsl:template>",'  <xsl:template match="node()|@*">','    <xsl:copy><xsl:apply-templates select="node()|@*"/></xsl:copy>',"  </xsl:template>",'  <xsl:output indent="yes"/>',"</xsl:stylesheet>"].join("\n"),s=this.parseXML(e),i=new XSLTProcessor;i.importStylesheet(s);let o=i.transformToDocument(t);return(new XMLSerializer).serializeToString(o)}static nodeText(t){let e="";for(let s of Array.from(t.childNodes))s.nodeType!=Node.TEXT_NODE&&s.nodeType!=Node.CDATA_SECTION_NODE||(e+=s.nodeValue);return e}static childText(t,e){if(null==t)return null;let s=this.findElement(t,e);return null==s?null:L(s)}static appendElement(t,e){let s=t.ownerDocument.createElement(e);return t.appendChild(s),s}static appendElementAfter(t,e){let s=t.ownerDocument.createElement(e),i=t.nextSibling;return null==i?t.parentNode.appendChild(s):t.parentNode.insertBefore(s,i),s}static appendText(t,e,s=!1){null!=e&&0!=e.length&&(s?t.appendChild(t.ownerDocument.createCDATASection(e)):t.appendChild(t.ownerDocument.createTextNode(e)))}static createTextChild(t,e,s,i=!1){let o=t.ownerDocument.createElement(e);t.appendChild(o),i?o.appendChild(t.ownerDocument.createCDATASection(s)):o.textContent=s}static setText(t,e,s=!1){for(;null!=t.firstChild;)t.removeChild(t.firstChild);this.appendText(t,e,s)}static findElement(t,e){if(null==t)return null;let s=t.firstChild;for(;null!=s;){if(s.nodeType==Node.ELEMENT_NODE&&s.nodeName==e)return s;s=s.nextSibling}return null}static findChildElements(t,e){if(null==t)return[];let s=[],i=t.firstChild;for(;null!=i;)i.nodeType==Node.ELEMENT_NODE&&i.nodeName===e&&s.push(i),i=i.nextSibling;return s}static childElements(t){if(null==t)return[];let e=[],s=t.firstChild;for(;null!=s;)s.nodeType==Node.ELEMENT_NODE&&e.push(s),s=s.nextSibling;return e}}function b(t){return"string"==typeof t?y.parse(t):t instanceof y?t:new y(t)}function A(t){return null==t?null:t.jquery?b(t[0]):b(t)}g.customParser=null,g.customSerial=null;class y{constructor(t){this.el=t}get elHTML(){return this.el}get elInput(){return this.el}get elCanvas(){return this.el}static parse(t){let e=g.parseXML(t);if(null==e)throw"Invalid XHTML string: "+t;let s=e.documentElement.outerHTML,i=document.createElement("template");return i.innerHTML=s,new y(i.content.firstChild)}static find(t){let e=document.querySelector(t);return e?new y(e):null}static findAll(t){let e=document.querySelectorAll(t),s=[];for(let t=0;t<e.length;t++)s.push(new y(e.item(t)));return s}parent(){let t=this.el.parentElement;return t?new y(t):null}ancestor(t){let e=this.el.closest(t);return e?new y(e):null}children(t){let e=[];for(let s=this.el.firstElementChild;s;s=s.nextElementSibling)t&&s.tagName!=t||e.push(new y(s));return e}find(t){let e=this.el.querySelector(t);return e?new y(e):null}findAll(t){let e=this.el.querySelectorAll(t),s=[];for(let t=0;t<e.length;t++)s.push(new y(e.item(t)));return s}exists(){return document.documentElement.contains(this.el)}isVisible(){return this.elHTML.offsetWidth>0||this.elHTML.offsetHeight>0||this.elHTML.getClientRects().length>0}append(t){this.el.append(t.el)}appendTo(t){return t instanceof y?t.el.append(this.el):t.appendChild(this.el),this}prepend(t){this.el.prepend(t.el)}prependTo(t){return t instanceof y?t.el.prepend(this.el):t.append(this.el),this}insertBefore(t){return t.el.parentElement.insertBefore(this.el,t.el),this}insertAfter(t){let e=t.el.nextElementSibling;return e?t.el.parentElement.insertBefore(this.el,e):t.el.parentElement.append(this.el),this}remove(){this.el.remove()}empty(){this.el.innerHTML=""}getHTML(){return this.el.innerHTML}setHTML(t){this.el.innerHTML=t}appendHTML(t){let e=g.parseXML("<z>"+t+"</z>");if(null==e)throw"Invalid XHTML string: "+t;let s=e.documentElement.innerHTML;this.el.insertAdjacentHTML("beforeend",s)}getText(){return this.el.textContent}setText(t){this.el.textContent=t}appendText(t){let e=document.createTextNode(t);this.el.appendChild(e)}getValue(){return this.el.value}setValue(t){this.el.value=t||""}getCSS(t){return this.elHTML.style.getPropertyValue(t)}setCSS(t,e){this.elHTML.style.setProperty(t,e)}css(t){for(let e in t)this.setCSS(e,t[e].toString());return this}getAttr(t){return this.el.hasAttribute(t)?this.el.getAttribute(t):null}setAttr(t,e){this.el.setAttribute(t,e)}attr(t){for(let e in t)this.setAttr(e,t[e].toString());return this}addClass(t){for(let e of t.split(" "))e&&this.elHTML.classList.add(e)}removeClass(t){for(let e of t.split(" "))e&&this.elHTML.classList.remove(e)}hasClass(t){return this.elHTML.classList.contains(t)}setClass(t,e){e?this.addClass(t):this.removeClass(t)}class(t){return this.addClass(t),this}toggleClass(t){for(let e in t)t[e]?this.elHTML.classList.add(e):this.elHTML.classList.remove(e)}width(){return this.elHTML.offsetWidth}height(){return this.elHTML.offsetHeight}offset(){let t=this.el.getBoundingClientRect(),e=this.el.ownerDocument.defaultView;return new m(t.left+e.pageXOffset,t.top+e.pageYOffset)}size(){return new d(this.width(),this.height())}setBoundaryPixels(t,e,s,i){this.css({left:`${t}px`,top:`${e}px`,width:`${s}px`,height:`${i}px`})}hasFocus(){return this.el===document.activeElement}grabFocus(t=!1){t?setTimeout((()=>this.grabFocus()),10):this.elHTML.focus()}removeEvent(t,e){this.el.removeEventListener(t,e)}onKeyDown(t){this.el.addEventListener("keydown",t)}onKeyUp(t){this.el.addEventListener("keyup",t)}onKeyPress(t){this.el.addEventListener("keypress",t)}onScroll(t){this.el.addEventListener("scroll",t)}onWheel(t){this.el.addEventListener("wheel",t)}onClick(t){this.el.addEventListener("click",t)}onContextMenu(t){this.el.addEventListener("contextmenu",t)}onDblClick(t){this.el.addEventListener("dblclick",t)}onMouseDown(t){this.el.addEventListener("mousedown",t)}onMouseUp(t){this.el.addEventListener("mouseup",t)}onMouseEnter(t){this.el.addEventListener("mouseenter",t)}onMouseLeave(t){this.el.addEventListener("mouseleave",t)}onMouseMove(t){this.el.addEventListener("mousemove",t)}onMouseOver(t){this.el.addEventListener("mouseover",t)}onChange(t){this.el.addEventListener("change",t)}onInput(t){this.el.addEventListener("input",t)}onTouchStart(t){this.el.addEventListener("touchstart",t)}onTouchMove(t){this.el.addEventListener("touchmove",t)}onTouchCancel(t){this.el.addEventListener("touchcancel",t)}onTouchEnd(t){this.el.addEventListener("touchend",t)}}var E=function(t,e,s,i){return new(s||(s=Promise))((function(o,n){function l(t){try{a(i.next(t))}catch(t){n(t)}}function r(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,r)}a((i=i.apply(t,e||[])).next())}))};function M(t,e=0){if(null==t||0==t.length)return e;let s=t.startsWith("0x")?parseInt(t.substring(2),16):t.startsWith("#")?parseInt(t.substring(1),16):parseInt(t);return isNaN(s)?e:s}function T(t,e=0){if(null==t||0==t.length)return e;let s=parseFloat(t);return isNaN(s)?e:s}function x(t,e,s){let i=b(`<${e}/>`);return s&&i.attr(s),A(t).append(i),i.el}function v(t,e){t.appendChild(document.createTextNode(e))}function C(t){return 1==t?"":"s"}function N(t,e){if(null==t)return"";let s=t.toPrecision(e);if(s.indexOf(".")>0){for(;s.endsWith("0");)s=s.substring(0,s.length-1);s.endsWith(".")&&(s=s.substring(0,s.length-1))}return s}function S(t){return null==t||"#"!=t.charAt(0)||7!=t.length?null:parseInt(t.substring(1),16)}function w(t){let e=(16777215&t).toString(16);for(;e.length<6;)e="0"+e;return"#"+e}function O(t){let e=t>>>24&255;return 0==e?1:255==e?0:1-e*(1/255)}const q=1/255;function B(t){return 16777215==t?"white":0==t?"black":-1==t?null:t>=0&&t<=16777215?w(t):"rgba("+(t>>16&255)+","+(t>>8&255)+","+(255&t)+","+(1-(t>>24&255)*q)+")"}function k(t,e,s,i){t=Math.max(0,Math.min(1,t));let o,n,l,r=(e>>16&255)*q,a=(e>>8&255)*q,h=(255&e)*q,u=(s>>16&255)*q,m=(s>>8&255)*q,d=(255&s)*q;if(null==i){let e=1-t,s=t;o=Math.round(255*(e*r+s*u)),n=Math.round(255*(e*a+s*m)),l=Math.round(255*(e*h+s*d))}else{let e=(i>>16&255)*q,s=(i>>8&255)*q,c=(255&i)*q;if(t<.5){let e=2*t,s=1-e;o=Math.round(255*(s*r+e*u)),n=Math.round(255*(s*a+e*m)),l=Math.round(255*(s*h+e*d))}else{let i=2*(t-.5),r=1-i;o=Math.round(255*(r*u+i*e)),n=Math.round(255*(r*m+i*s)),l=Math.round(255*(r*d+i*c))}}return o<<16|n<<8|l}function R(t){let e=t.getDate(),s=t.getMonth(),i=t.getFullYear();return e+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s]+"-"+i}function L(t){let e="";if(!t)return"";for(t=t.firstChild;t;)3!=t.nodeType&&4!=t.nodeType||(e+=t.nodeValue),t=t.nextSibling;return e}function D(t){return!(null==t)}function I(t){return null==t}function P(t,e){let s=A(e).offset();return[t.pageX-s.x,t.pageY-s.y]}function _(t,e,s,i,o){t.css({left:e+"px",top:s+"px",width:i+"px",height:o+"px"})}function F(t){let e=t.offset();return[e.x,e.y,t.width(),t.height()]}function z(t){return[t.elHTML.offsetLeft,t.elHTML.offsetTop,t.elHTML.offsetWidth,t.elHTML.offsetHeight]}function U(t,e){return Math.sqrt(t*t+e*e)}function Y(t,e,s){return Math.sqrt(t*t+e*e+s*s)}function X(t,e){return t*t+e*e}function H(t,e,s){return t*t+e*e+s*s}function j(t){return t<0?-1:t>0?1:0}function V(t){return t*t}function W(t){return 0==t?0:1/t}function G(t,e){return t==e||Math.abs(t-e)<=1e-7*Math.max(t,e)}function $(t,e){return t==e||Math.abs(t-e)<=1e-14*Math.max(t,e)}function Q(t){return t<=1?0:Math.floor(Math.random()*t)}const K=2*Math.PI,Z=1/K,J=Math.PI/180,tt=180/Math.PI;function et(t){return t==-Math.PI?Math.PI:t<-Math.PI?t+Math.ceil((-t-Math.PI)*Z)*K:t>Math.PI?t-Math.ceil((t-Math.PI)*Z)*K:t}function st(t,e){let s=et(t)-et(e);return s-(s>Math.PI?K:0)+(s<=-Math.PI?K:0)}function it(t,e){let s=et(t)-et(e);return s+(s<0?K:0)}function ot(t){if(null==t||t.length<2)return t;t=t.slice(0);for(let e=0;e<t.length;e++)t[e]=et(t[e]);for(s.sort(t);;){let e=t[t.length-1],s=t[0],i=t[1];if(st(s,e)<=st(i,s))break;for(let e=t.length-1;e>0;e--)t[e]=t[e-1];t[0]=e}return t}function nt(t,e){t=ot(t);for(let s=1;s<t.length;s++)Math.abs(st(t[s],t[s-1]))<=e&&(t.splice(s,1),s--);return t}function lt(t){if(null==t||0==t.length)return 0;let e=t[0];for(let s=1;s<t.length;s++)e=Math.min(e,t[s]);return e}function rt(t){if(null==t||0==t.length)return 0;let e=t[0];for(let s=1;s<t.length;s++)e=Math.max(e,t[s]);return e}function at(t,e){if(null==t)return null;let s=t.firstChild;for(;s;){if(s.nodeName==e)return s;s=s.nextSibling}return null}function ht(t,e){if(null==t)return null;let s=t.firstChild,i=[];for(;s;)s.nodeName==e&&i.push(s),s=s.nextSibling;return i}function ut(t,e,s,i,o){let n=new Path2D;return n.moveTo(s-o,e),n.quadraticCurveTo(s,e,s,e+o),n.lineTo(s,i-o),n.quadraticCurveTo(s,i,s-o,i),n.lineTo(t+o,i),n.quadraticCurveTo(t,i,t,i-o),n.lineTo(t,e+o),n.quadraticCurveTo(t,e,t+o,e),n.closePath(),n}function mt(t,e,s,i,o){t.beginPath(),t.moveTo(e,s),t.lineTo(i,o),t.stroke()}const dt=1.4;function ct(t){return t*dt+"px sans-serif"}function pt(){return"devicePixelRatio"in window&&window.devicePixelRatio>1?window.devicePixelRatio:1}function ft(t){if(null==t)return null;if(Array.isArray(t))return t.slice(0);if("object"!=typeof t)return t;let e={};for(let s in t)e[s]=t[s];return e}function gt(t){if(null==t)return null;if("function"==typeof t)return null;if("object"!=typeof t)return t;let e=Array.isArray(t)?[]:{};for(let s in t){let i=t[s];e[s]="object"==typeof i?gt(i):i}return e}function bt(t){if(!t)return"";const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,(t=>e[t]))}function At(t){return null==t?"":t}function yt(t){let e=[];for(let s in t)e.push(t[s]);return e}function Et(t,e){return t.map(((t,s)=>[t,e[s]]))}function Mt(t){let e=[],s="";const i=t.length;for(let o=0;o<i;o++){let i=t.charCodeAt(o);i<128?s+=t.charAt(o):i<2048?(s+=String.fromCharCode(192|i>>6),s+=String.fromCharCode(128|63&i)):i<55296||i>=57344?(s+=String.fromCharCode(224|i>>12),s+=String.fromCharCode(128|i>>6&63),s+=String.fromCharCode(128|63&i)):(o++,i=65536+((1023&i)<<10|1023&t.charCodeAt(o)),s+=String.fromCharCode(240|i>>18),s+=String.fromCharCode(128|i>>12&63),s+=String.fromCharCode(128|i>>6&63),s+=String.fromCharCode(128|63&i)),s.length>100&&(e.push(s),s="")}return e.push(s),e.join("")}function Tt(t){let e=[],s="";const i=t.length;for(let o=0;o<i;o++){let i=t.charCodeAt(o);if(i<128)s+=t.charAt(o);else if(i>191&&i<224)s+=String.fromCharCode((31&i)<<6|63&t.charCodeAt(o+1)),o++;else if(i>223&&i<240)t+=String.fromCharCode((15&i)<<12|(63&t.charCodeAt(o+1))<<6|63&t.charCodeAt(o+2)),o+=2;else{let e=((7&i)<<18|(63&t.charCodeAt(o+1))<<12|(63&t.charCodeAt(o+2))<<6|63&t.charCodeAt(o+3))-65536;s+=String.fromCharCode(e>>10|55296,1023&e|56320),o+=3}s.length>100&&(e.push(s),s="")}return e.push(s),e.join("")}function xt(t){let e=JSON.stringify(t,null,1).split(/\n/);for(let t=0;t<e.length;t++)if(e[t]=e[t].trim(),e[t].length>1&&(e[t].endsWith("{")||e[t].endsWith("["))){let s=e[t].charAt(e[t].length-1);e[t]=e[t].substring(0,e[t].length-1),e.splice(t+1,0,s),t--}let s=0;for(let t=0;t<e.length;t++){let i=e[t];"]"!=i&&"}"!=i&&"],"!=i&&"},"!=i||s--,e[t]="\t".repeat(s)+i,"["!=i&&"{"!=i||s++}return e.join("\n")}var vt;function Ct(t){return E(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{let i=new XMLHttpRequest;i.open("GET",t.toString(),!0),i.responseType="text",i.onload=()=>e(i.response.toString()),i.onerror=()=>e(null),i.send()}))}))}function Nt(t,e){return E(this,void 0,void 0,(function*(){return new Promise(((s,i)=>{let o=new XMLHttpRequest;o.open("POST",t.toString(),!0),o.responseType="text",o.onload=()=>{try{s(JSON.parse(o.response.toString()))}catch(t){i("JSON parsing error on result:"+t)}},o.onerror=()=>i("Failed to request URL: "+t),o.send(JSON.stringify(e))}))}))}function St(){return E(this,void 0,void 0,(function*(){return new Promise((t=>setTimeout((()=>t()))))}))}!function(t){t.Backspace="Backspace",t.Tab="Tab",t.Enter="Enter",t.Escape="Escape",t.Space=" ",t.PageUp="PageUp",t.PageDown="PageDown",t.End="End",t.Home="Home",t.Left="ArrowLeft",t.Right="ArrowRight",t.Up="ArrowUp",t.Down="ArrowDown",t.Delete="Delete",t.Insert="Insert"}(vt||(vt={}));let wt=null;function Ot(){if(wt)return wt;let t=b("<div/>").css({visibility:"hidden",width:"100px",height:"100px",overflow:"scroll"}).appendTo(b(document.body)),e=b("<div/>").css({width:"100%",height:"100%"}).appendTo(t);return wt=new d(100-e.elHTML.offsetWidth,100-e.elHTML.offsetHeight),t.remove(),wt}class qt{}qt.ELEMENTS=[null,"H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"],qt.ELEMENT_GROUPS=[0,1,18,1,2,13,14,15,16,17,18,1,2,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,5,6,7,8,9,10,11,12],qt.ELEMENT_ROWS=[0,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],qt.ELEMENT_BLOCKS=[0,1,2,1,1,2,2,2,2,2,2,1,1,2,2,2,2,2,2,1,1,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3],qt.ELEMENT_VALENCE=[0,1,2,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,2,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12],qt.ELEMENT_BONDING=[0,1,0,1,2,3,4,3,2,1,0,1,2,3,4,3,2,1,0,1,2,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,2,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12],qt.ELEMENT_SHELL=[0,2,2,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,8,8,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18],qt.NATURAL_ATOMIC_WEIGHTS=[0,1.00794,4.002602,6.941,9.012182,10.811,12.0107,14.0067,15.9994,18.9984032,20.1797,22.98977,24.305,26.981538,28.0855,30.973761,32.065,35.453,39.948,39.0983,40.078,44.95591,47.867,50.9415,51.9961,54.938049,55.845,58.9332,58.6934,63.546,65.409,69.723,72.64,74.9216,78.96,79.904,83.798,85.4678,87.62,88.90585,91.224,92.90638,95.94,98,101.07,102.9055,106.42,107.8682,112.411,114.818,118.71,121.76,127.6,126.90447,131.293,132.90545,137.327,138.9055,140.116,140.90765,144.24,145,150.36,151.964,157.25,158.92534,162.5,164.93032,167.259,168.93421,173.04,174.967,178.49,180.9479,183.84,186.207,190.23,192.217,195.078,196.96655,200.59,204.3833,207.2,208.98038,209,210,222,223,226,227,230.0331266,231.03588,233.039628,237,244,243,247,247,251,252,257,258,259,262,261,262,266,264,277,268,271,272,285],qt.ELEMENT_H=1,qt.ELEMENT_He=2,qt.ELEMENT_Li=3,qt.ELEMENT_Be=4,qt.ELEMENT_B=5,qt.ELEMENT_C=6,qt.ELEMENT_N=7,qt.ELEMENT_O=8,qt.ELEMENT_F=9,qt.ELEMENT_Ne=10,qt.ELEMENT_Na=11,qt.ELEMENT_Mg=12,qt.ELEMENT_Al=13,qt.ELEMENT_Si=14,qt.ELEMENT_P=15,qt.ELEMENT_S=16,qt.ELEMENT_Cl=17,qt.ELEMENT_Ar=18,qt.ELEMENT_K=19,qt.ELEMENT_Ca=20,qt.ELEMENT_Sc=21,qt.ELEMENT_Ti=22,qt.ELEMENT_V=23,qt.ELEMENT_Cr=24,qt.ELEMENT_Mn=25,qt.ELEMENT_Fe=26,qt.ELEMENT_Co=27,qt.ELEMENT_Ni=28,qt.ELEMENT_Cu=29,qt.ELEMENT_Zn=30,qt.ELEMENT_Ga=31,qt.ELEMENT_Ge=32,qt.ELEMENT_As=33,qt.ELEMENT_Se=34,qt.ELEMENT_Br=35,qt.ELEMENT_Kr=36,qt.ELEMENT_Rb=37,qt.ELEMENT_Sr=38,qt.ELEMENT_Y=39,qt.ELEMENT_Zr=40,qt.ELEMENT_Nb=41,qt.ELEMENT_Mo=42,qt.ELEMENT_Tc=43,qt.ELEMENT_Ru=44,qt.ELEMENT_Rh=45,qt.ELEMENT_Pd=46,qt.ELEMENT_Ag=47,qt.ELEMENT_Cd=48,qt.ELEMENT_In=49,qt.ELEMENT_Sn=50,qt.ELEMENT_Sb=51,qt.ELEMENT_Te=52,qt.ELEMENT_I=53,qt.ELEMENT_Xe=54,qt.ELEMENT_Cs=55,qt.ELEMENT_Ba=56,qt.ELEMENT_La=57,qt.ELEMENT_Ce=58,qt.ELEMENT_Pr=59,qt.ELEMENT_Nd=60,qt.ELEMENT_Pm=61,qt.ELEMENT_Sm=62,qt.ELEMENT_Eu=63,qt.ELEMENT_Gd=64,qt.ELEMENT_Tb=65,qt.ELEMENT_Dy=66,qt.ELEMENT_Ho=67,qt.ELEMENT_Er=68,qt.ELEMENT_Tm=69,qt.ELEMENT_Yb=70,qt.ELEMENT_Lu=71,qt.ELEMENT_Hf=72,qt.ELEMENT_Ta=73,qt.ELEMENT_W=74,qt.ELEMENT_Re=75,qt.ELEMENT_Os=76,qt.ELEMENT_Ir=77,qt.ELEMENT_Pt=78,qt.ELEMENT_Au=79,qt.ELEMENT_Hg=80,qt.ELEMENT_Tl=81,qt.ELEMENT_Pb=82,qt.ELEMENT_Bi=83,qt.ELEMENT_Po=84,qt.ELEMENT_At=85,qt.ELEMENT_Rn=86,qt.ELEMENT_Fr=87,qt.ELEMENT_Ra=88,qt.ELEMENT_Ac=89,qt.ELEMENT_Th=90,qt.ELEMENT_Pa=91,qt.ELEMENT_U=92,qt.ELEMENT_Np=93,qt.ELEMENT_Pu=94,qt.ELEMENT_Am=95,qt.ELEMENT_Cm=96,qt.ELEMENT_Bk=97,qt.ELEMENT_Cf=98,qt.ELEMENT_Es=99,qt.ELEMENT_Fm=100,qt.ELEMENT_Md=101,qt.ELEMENT_No=102,qt.ELEMENT_Lr=103,qt.ELEMENT_Rf=104,qt.ELEMENT_Db=105,qt.ELEMENT_Sg=106,qt.ELEMENT_Bh=107,qt.ELEMENT_Hs=108,qt.ELEMENT_Mt=109,qt.ELEMENT_Ds=110,qt.ELEMENT_Rg=111,qt.ELEMENT_Cn=112;class Bt{constructor(t,e,s){if(this.nbrs=[],this.indices=null,this.labels=null,this.props=null,null!=t)for(let e=0;e<t;e++)this.nbrs.push([]);if(null!=e&&null!=s)for(let t=0;t<e.length;t++)this.nbrs[e[t]].push(s[t]),this.nbrs[s[t]].push(e[t])}clone(){let t=new Bt;for(let e of this.nbrs)t.nbrs.push(e.slice(0));return t.indices=null==this.indices?null:this.indices.slice(0),t.labels=null==this.labels?null:this.labels.slice(0),t.props=null==this.props?null:this.props.slice(0),t}static fromMolecule(t){let e=new Bt;e.indices=[];for(let s=0;s<t.numAtoms;s++)e.nbrs.push([]),e.indices.push(s+1);for(let s=1;s<=t.numBonds;s++){let i=t.bondFrom(s)-1,o=t.bondTo(s)-1;e.nbrs[i].push(o),e.nbrs[o].push(i)}return e}static fromNeighbours(t){let e=new Bt;return e.nbrs=t,e}toString(){let t="#nodes="+this.nbrs.length;for(let e=0;e<this.nbrs.length;e++)t+=" "+e+":{"+this.nbrs[e]+"}",e<s.len(this.indices)&&(t+="[i="+this.indices[e]+"]"),e<s.len(this.labels)&&(t+="[l="+this.labels[e]+"]");return t}get numNodes(){return this.nbrs.length}numEdges(t){return this.nbrs[t].length}getEdge(t,e){return this.nbrs[t][e]}getEdges(t){return this.nbrs[t]}getIndex(t){return null==this.indices?0:this.indices[t]}setIndex(t,e){null==this.indices&&(this.indices=s.numberArray(0,this.nbrs.length)),this.indices[t]=e}getLabel(t){return null==this.labels?null:this.labels[t]}setLabel(t,e){null==this.labels&&(this.labels=s.stringArray("",this.nbrs.length)),this.labels[t]=e}getProperty(t){return null==this.props?null:this.props[t]}setProperty(t,e){null==this.props&&(this.props=new Array(this.nbrs.length)),this.props[t]=e}addNode(){return this.nbrs.push([]),null!=this.indices&&this.indices.push(0),null!=this.labels&&this.labels.push(""),null!=this.props&&this.props.push(null),this.nbrs.length-1}hasEdge(t,e){return this.nbrs[t].length<=this.nbrs[e].length?this.nbrs[t].indexOf(e)>=0:this.nbrs[e].indexOf(t)>=0}addEdge(t,e){this.nbrs[t].push(e),this.nbrs[e].push(t)}removeEdge(t,e){let s=this.nbrs[t].indexOf(e),i=this.nbrs[e].indexOf(t);s>=0&&this.nbrs[t].splice(s,1),i>=0&&this.nbrs[e].splice(i,1)}isolateNode(t){for(let e of this.nbrs[t]){let s=this.nbrs[e].indexOf(t);s>=0&&this.nbrs[e].splice(s,1)}this.nbrs[t]=[]}keepNodesMask(t){const e=this.nbrs.length,i=s.maskCount(t);if(i==e)return;if(0==i)return this.nbrs=[],this.indices=null,this.labels=null,void(this.props=null);let o=s.maskMap(t),n=[];for(let t=0;t<i;t++)n.push([]);for(let s=0,i=0;s<e;s++)if(t[s]){for(let e of this.nbrs[s])t[e]&&n[i].push(o[e]);i++}this.nbrs=n,null!=this.indices&&(this.indices=s.maskGet(this.indices,t)),null!=this.labels&&(this.labels=s.maskGet(this.labels,t)),null!=this.props&&(this.props=s.maskGet(this.props,t))}keepNodesIndex(t){this.keepNodesMask(s.idxMask(t,this.numNodes))}removeNodesMask(t){this.keepNodesMask(s.notMask(t))}removeNodesIndex(t){this.removeNodesMask(s.idxMask(t,this.numNodes))}subgraphIndex(t){const e=t.length;let s=new Bt(e);if(null!=this.indices||null!=this.labels||null!=this.props)for(let i=0;i<e;i++)null!=this.indices&&s.setIndex(i,this.indices[t[i]]),null!=this.labels&&s.setLabel(i,this.labels[t[i]]),null!=this.props&&s.setProperty(i,this.props[t[i]]);for(let i=0;i<e;i++)for(let e of this.nbrs[t[i]]){let o=t.indexOf(e);o>i&&s.addEdge(i,o)}return s}subgraphMask(t){let e=this.clone();return e.keepNodesMask(t),e}calculateComponents(){const t=this.nbrs.length;if(0==t)return[];let e=s.numberArray(0,t);e[0]=1;let i=1,o=1;for(;;){for(;i<t&&e[i]>0;)i++;if(i>=t)break;let s=!1;for(let o=i;o<t;o++)if(0==e[o])for(let t=0;t<this.nbrs[o].length;t++)0!=e[this.nbrs[o][t]]&&(e[o]=e[this.nbrs[o][t]],s=!0);s||(e[i]=++o)}return e}calculateComponentGroups(){if(0==this.nbrs.length)return[];let t=this.calculateComponents(),e=s.max(t),i=[];for(let t=0;t<e;t++)i.push([]);for(let e=0;e<t.length;e++)i[t[e]-1].push(e);return i}calculateRingBlocks(){let t=this.numNodes,e=this.nbrs;if(0==t)return[[],0];let i=new Array(this.numNodes),o=s.booleanArray(!1,t);s.setTo(i,0);let n=new Array(t+1),l=0,r=0;for(;;){let s,a;if(0==l)for(s=-1,a=0;o[a];a++);else{s=n[l-1],a=-1;for(let t=0;t<e[s].length;t++)if(!o[e[s][t]]){a=e[s][t];break}}if(a>=0&&l>=2){let r=n[l-1];for(let h=0;h<e[a].length;h++){let u=e[a][h];if(u!=r&&o[u]){n[l]=a;for(let e=l;e==l||n[e+1]!=u;e--){let o=i[n[e]];if(0==o)i[n[e]]=s;else if(o!=s)for(let e=0;e<t;e++)i[e]==o&&(i[e]=s)}}}}if(a>=0?(o[a]=!0,n[l++]=a,r++):l--,r==t)break}let a=0;for(let e=0;e<t;e++)if(i[e]>0){a--;for(let s=t-1;s>=e;s--)i[s]==i[e]&&(i[s]=a)}for(let e=0;e<t;e++)i[e]=-i[e];return[i,-a]}calculateRingBlockGroups(){let[t,e]=this.calculateRingBlocks();if(0==e)return[];let i=s.numberArray(0,e);for(let e=0;e<t.length;e++)t[e]>0&&i[t[e]-1]++;let o=new Array(e);for(let t=0;t<e;t++)o[t]=new Array(i[t]),i[t]=0;for(let e=0;e<t.length;e++){let s=t[e]-1;s<0||(o[s][i[s]++]=e)}return o}findRingsOfSize(t){let[e,s]=this.calculateRingBlocks();if(0==s)return[];let i=[],o=new Array(this.numNodes);for(let n=1;n<=s;n++){for(let t=0;t<this.numNodes;t++)o[t]=e[t]==n;let s=this.findRingsOfSizeMask(t,o);for(let t=0;t<s.length;t++)i.push(s[t])}return i}findRingsOfSizeMask(t,e){let s=[];for(let i=0;i<this.numNodes;i++)if(e[i]){let o=new Array(t);o[0]=i,this.recursiveRingFind(o,1,t,e,s)}return s}calculateBFS(t){let e=s.numberArray(-1,this.numNodes);e[t]=0;let i=0,o=1,n=0,l=s.numberArray(0,this.numNodes);for(l[0]=t;;){let t=o;for(let s=n;s<o;s++)for(let o=0;o<this.nbrs[l[s]].length;o++){let n=this.nbrs[l[s]][o];e[n]<0&&(e[n]=i+1,l[t++]=n)}if(t==o)break;n=o,o=t,i++}return e}calculateGravity(){const t=this.numNodes,{nbrs:e}=this;let i=s.numberArray(1,t),o=s.numberArray(0,t);for(let n=0;n<t;n++){s.setTo(o,i);for(let s=0;s<t;s++)for(let t=e[s].length-1;t>=0;t--)o[s]+=i[e[s][t]];s.setTo(i,o)}return i}recursiveRingFind(t,e,i,o,n){if(e<i){let l=t[e-1];for(let r=0;r<this.nbrs[l].length;r++){let a=this.nbrs[l][r];if(!o[a])continue;let h=!1;for(let s=0;s<e;s++)if(t[s]==a){h=!0;break}if(!h){let l=s.duplicate(t);l[e]=a,this.recursiveRingFind(l,e+1,i,o,n)}}return}let l=t[e-1],r=!1;for(let e=0;e<this.nbrs[l].length;e++)if(this.nbrs[l][e]==t[0]){r=!0;break}if(!r)return;for(let e=0;e<t.length;e++){let s=0,i=t[e];for(let e=0;e<this.nbrs[i].length;e++)t.indexOf(this.nbrs[i][e])>=0&&s++;if(2!=s)return}let a=0;for(let s=1;s<e;s++)t[s]<t[a]&&(a=s);let h=(a+1)%e,u=t[(a-1+e)%e]<t[h];if(0!=a||u){let s=new Array(e);for(let i=0;i<e;i++)s[i]=t[(a+(u?e-i:i))%e];t=s}for(let s=0;s<n.length;s++){let i=n[s],o=!0;for(let s=0;s<e;s++)if(i[s]!=t[s]){o=!1;break}if(o)return}n.push(t)}}const kt="xRESPATH:",Rt="xRESRING:",Lt="xARENE:";class Dt{constructor(t){this.mol=t,this.resPaths=new Map,this.resRings=new Map,this.arenes=new Map;for(let t=1;t<=this.mol.numAtoms;t++)for(let e of this.mol.atomExtra(t))e.startsWith(kt)?this.appendResPath(t,e.substring(kt.length).split(":")):e.startsWith(Rt)?this.appendResRing(t,e.substring(Rt.length).split(":")):e.startsWith(Lt)&&this.appendArene(t,e.substring(Lt.length).split(":"));for(let[t,e]of this.resPaths.entries())e.atoms=this.pack(e.atoms),this.pathify(e.atoms,!1)||this.resPaths.delete(t);for(let[t,e]of this.resRings.entries())e.atoms=this.pack(e.atoms),this.pathify(e.atoms,!0)||this.resRings.delete(t);for(let[t,e]of this.arenes.entries())e.atoms=this.pack(e.atoms),e.atoms.length>1&&(e.centre=e.atoms.shift()),this.pathify(e.atoms,!1)||this.arenes.delete(t)}getPathBlocks(){return Array.from(this.resPaths.keys())}getRingBlocks(){return Array.from(this.resRings.keys())}getAreneBlocks(){return Array.from(this.arenes.keys())}getResPaths(){let t=[];for(let e of s.sorted(Array.from(this.resPaths.keys())))t.push(this.resPaths.get(e));return t}getResRings(){let t=[];for(let e of s.sorted(Array.from(this.resRings.keys())))t.push(this.resRings.get(e));return t}getArenes(){let t=[];for(let e of s.sorted(Array.from(this.arenes.keys())))t.push(this.arenes.get(e));return t}rewriteMolecule(){const t=this.mol;for(let e=1;e<=t.numAtoms;e++){let s=t.atomExtra(e),i=!1;for(let t=s.length-1;t>=0;t--)(s[t].startsWith(kt)||s[t].startsWith(Rt)||s[t].startsWith(Lt))&&(s.splice(t),i=!0);i&&t.setAtomExtra(e,s)}for(let[e,s]of this.resPaths.entries())for(let i=0;i<s.atoms.length;i++){let o=t.atomExtra(s.atoms[i]);o.push(kt+e+":"+(i+1)),t.setAtomExtra(s.atoms[i],o)}for(let[e,s]of this.resRings.entries())for(let i=0;i<s.atoms.length;i++){let o=t.atomExtra(s.atoms[i]);o.push(Rt+e+":"+(i+1)),t.setAtomExtra(s.atoms[i],o)}for(let[e,s]of this.arenes.entries())for(let i=-1;i<s.atoms.length;i++){let o=i<0?s.centre:s.atoms[i],n=t.atomExtra(o);n.push(Lt+e+":"+(i+2)),t.setAtomExtra(o,n)}}harmoniseNumbering(t){let e=t.getPathBlocks(),s=this.getResPaths();this.resPaths.clear();for(let t of s){let s=this.nextIdentifier(e);this.resPaths.set(s,t),e.push(s)}e=t.getRingBlocks();let i=this.getResRings();this.resRings.clear();for(let t of i){let s=this.nextIdentifier(e);this.resRings.set(s,t),e.push(s)}e=t.getAreneBlocks();let o=this.getArenes();this.arenes.clear();for(let t of o){let s=this.nextIdentifier(e);this.arenes.set(s,t),e.push(s)}}createPath(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsPath(t);if(e){let t=this.nextIdentifier(Array.from(this.resPaths.keys()));return this.resPaths.set(t,e),!0}return!1}createRing(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsRing(t);if(e){let t=this.nextIdentifier(Array.from(this.resRings.keys()));return this.resRings.set(t,e),!0}return!1}createArene(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsArene(t);if(e){let t=this.nextIdentifier(Array.from(this.arenes.keys()));return this.arenes.set(t,e),!0}return!1}removeArtifact(t){let e=0,s=0,i=0;for(let[o,n]of this.resPaths.entries()){let l=0;for(let e of n.atoms)t.indexOf(e)>=0&&l++;l>i&&(e=1,s=o,i=l)}for(let[o,n]of this.resRings.entries()){let l=0;for(let e of n.atoms)t.indexOf(e)>=0&&l++;l>i&&(e=2,s=o,i=l)}for(let[o,n]of this.arenes.entries()){let l=t.indexOf(n.centre)>=0?1:0;for(let e of n.atoms)t.indexOf(e)>=0&&l++;l>i&&(e=3,s=o,i=l)}return 0!=e&&(1==e?this.resPaths.delete(s):2==e?this.resRings.delete(s):3==e&&this.arenes.delete(s),!0)}static removeAll(t){for(let e=1;e<=t.numAtoms;e++){let i=t.atomExtra(e),o=!1;for(let t=i.length-1;t>=0;t--)(i[t].startsWith(kt)||i[t].startsWith(Rt)||i[t].startsWith(Lt))&&(i=s.remove(i,t),o=!0);o&&t.setAtomExtra(e,i)}}appendResPath(t,e){let i=M(e[0],0);if(i<=0)return;let o=this.resPaths.get(i);null==o&&this.resPaths.set(i,o={atoms:s.numberArray(0,this.mol.numAtoms)});let n=e.length>=2?M(e[1],0):0;o.atoms.indexOf(t)>=0||(n>=1&&n<=this.mol.numAtoms?o.atoms[n-1]=t:o.atoms.push(t))}appendResRing(t,e){let i=M(e[0],0);if(i<=0)return;let o=this.resRings.get(i);null==o&&this.resRings.set(i,o={atoms:s.numberArray(0,this.mol.numAtoms)});let n=e.length>=2?M(e[1],0):0;o.atoms.indexOf(t)>=0||(n>=1&&n<=this.mol.numAtoms?o.atoms[n-1]=t:o.atoms.push(t))}appendArene(t,e){let i=M(e[0],0);if(i<=0)return;let o=this.arenes.get(i);null==o&&this.arenes.set(i,o={centre:0,atoms:s.numberArray(0,this.mol.numAtoms)});let n=e.length>=2?M(e[1],0):0;o.atoms.indexOf(t)>=0||(n>=1&&n<=this.mol.numAtoms?o.atoms[n-1]=t:o.atoms.push(t))}pack(t){let e=[];for(let s of t)0!=s&&e.push(s);return e}pathify(t,e){let i=t.length;if(i<2)return!1;let o=Bt.fromMolecule(this.mol);for(let t=0;t<this.mol.numAtoms;t++)o.setIndex(t,t+1);o=o.subgraphIndex(s.add(t,-1));let n=0;for(let t=1;t<i;t++)o.numEdges(t)<o.numEdges(n)&&(n=t);s.setTo(t,-1);for(let s=0;s<i;s++)if(t[s]=n,s==i-1){if(e&&o.getEdges(n).indexOf(t[0])<0)return!1}else{let e=i;for(let s of o.getEdges(n))t.indexOf(s)<0&&s<e&&(e=s);if(e==i)return!1;n=e}for(let e=0;e<i;e++)t[e]=o.getIndex(t[e]);return!0}alreadyExists(t){t=s.sorted(t);for(let e of this.resPaths.values())if(s.equals(t,s.sorted(e.atoms)))return!0;for(let e of this.resRings.values())if(s.equals(t,s.sorted(e.atoms)))return!0;for(let e of this.arenes.values()){let i=s.append(e.atoms,e.centre);if(s.equals(t,s.sorted(i)))return!0}return!1}atomsAsPath(t){if(t.length<2)return null;let e={atoms:t};return this.pathify(e.atoms,!1)?e:null}atomsAsRing(t){if(t.length<3)return null;let e={atoms:t};return this.pathify(e.atoms,!0)?e:null}atomsAsArene(t){const e=t.length;if(e<3)return null;let i=Bt.fromMolecule(this.mol).subgraphIndex(s.add(t,-1)),o=0;if(3==e){let n=[0,0,0];for(let l=0;l<e;l++){if(2!=i.numEdges(l))return null;for(let e of i.getEdges(l))n[l]+=this.mol.bondOrder(this.mol.findBond(t[l],t[e]));o=s.idxMin(n)}}else for(let t=1;t<e;t++)i.numEdges(t)>i.numEdges(o)&&(o=t);let n={centre:t[o],atoms:s.remove(t,o)};return this.pathify(n.atoms,!1)?n:null}nextIdentifier(t){if(0==t.length)return 1;let e=s.sorted(t);for(let t=0;t<e.length-1;t++)if(e[t+1]!=e[t]+1)return e[t]+1;return e[e.length-1]+1}}const It="xPOLYMER:",Pt="*";var _t,Ft,zt;!function(t){t.HeadToTail="ht",t.HeadToHead="hh",t.Random="rnd"}(_t||(_t={}));class Ut{constructor(t){this.atoms=t,this.connect=null,this.bondConn=null,this.atomName=new Map,this.bondIncl=new Map,this.bondExcl=new Map}clone(){let t=new Ut(this.atoms.slice(0));t.connect=this.connect,this.bondConn&&(t.bondConn=this.bondConn.slice(0));for(let[e,s]of this.atomName.entries())t.atomName.set(e,s.slice(0));for(let[e,s]of this.bondIncl.entries())t.bondIncl.set(e,s.slice(0));for(let[e,s]of this.bondExcl.entries())t.bondExcl.set(e,s.slice(0));return t}}class Yt{constructor(t){this.mol=t,this.units=new Map;let e=new Map;for(let s=1;s<=t.numAtoms;s++){let i=t.atomExtra(s);for(let t of i)if(t.startsWith(It)){let i=t.substring(It.length).split(":"),o=parseInt(i[0]);if(o>0){let t=e.get(o);t?t.push(s):t=[s],e.set(o,t)}}}for(let t of s.sorted(Array.from(e.keys())))this.appendBlock(t,e.get(t))}getIDList(){return s.sorted(Array.from(this.units.keys()))}getUnit(t){return this.units.get(t)}getUnits(){return Array.from(this.units.values())}rewriteMolecule(){this.purgeExtraFields();for(let t of s.sorted(Array.from(this.units.keys())))this.writeUnit(t,this.units.get(t))}harmoniseNumbering(t){let e=t.getIDList();for(let t of this.getIDList())if(e.includes(t)){let s=this.units.get(t);this.units.delete(t),t=this.nextIdentifier(e),this.units.set(t,s),e.push(t)}}removeUnit(t){let e=this.units.get(t);if(null==e)return;this.units.delete(t);let i=It+t+":";for(let t of e.atoms){let e=this.mol.atomExtra(t);for(let t=e.length-1;t>=0;t--)e[t].startsWith(i)&&(e=s.remove(e,t));this.mol.setAtomExtra(t,e)}for(let t=1;t<=this.mol.numBonds;t++){let e=this.mol.bondExtra(t);if(!s.isBlank(e)){for(let t=e.length-1;t>=0;t--)e[t].startsWith(i)&&(e=s.remove(e,t));this.mol.setBondExtra(t,e)}}}removeAll(){this.units.clear(),this.purgeExtraFields()}createUnit(t){let e=this.nextIdentifier();return this.units.set(e,t.clone()),this.writeUnit(e,t),e}static hasPolymerExtensions(t){for(let e=1;e<=t.numAtoms;e++){let s=t.atomExtra(e);if(null!=s)for(let t of s)if(t.startsWith(It))return!0}return!1}static getPolymerExtensions(t,e){let i=t.atomExtra(e),o=null;if(null==i)return null;for(let t of i)t.startsWith(It)&&(o=s.append(o,t));return o}static removePolymerExtensions(t,e){let i=t.atomExtra(e);if(null==i)return;let o=!1;for(let t=i.length-1;t>=0;t--)i[t].startsWith(It)&&(i=s.remove(i,t),o=!0);o&&t.setAtomExtra(e,i)}appendBlock(t,e){const{mol:i}=this;let o=0,n=new Ut(e);for(let s of e)for(let l of i.atomExtra(s))if(l.startsWith(It)){let r=l.substring(It.length).split(":");if(r.length<2||parseInt(r[0])!=t)continue;o=parseInt(r[1]);for(let t=2;t<r.length;t++)if(r[t]==_t.HeadToTail)n.connect=_t.HeadToTail;else if(r[t]==_t.HeadToHead)n.connect=_t.HeadToHead;else if(r[t]==_t.Random)n.connect=_t.Random;else if(r[t].startsWith("n")){let o=!1;for(let t of i.atomAdjList(s))if(!e.includes(t)){o=!0;break}if(o){let e=r[t].substring(1).split(",");n.atomName.set(s,e.map((t=>parseInt(t))))}}}if(o<0)return;for(let t=1;t<=i.numBonds;t++){let s=e.indexOf(i.bondFrom(t))>=0,n=e.indexOf(i.bondTo(t))>=0;(s&&!n||!s&&n)&&o--}if(0!=o)return;let l=null,r=null;for(let e=1;e<=i.numBonds;e++)for(let o of i.bondExtra(e))if(o.startsWith(It)){let i=o.substring(It.length).split(":");if(i.length<2||parseInt(i[0])!=t)continue;for(let t=1;t<i.length;t++)if(i[t].startsWith("i")){let s=i[t].substring(1).split(",");n.bondIncl.set(e,s.map((t=>parseInt(t))))}else if(i[t].startsWith("e")){let s=i[t].substring(1).split(",");n.bondExcl.set(e,s.map((t=>parseInt(t))))}else{let o=parseInt(i[t]);o>0&&(l=s.append(l,e),r=s.append(r,o))}}if(null!=l){if(l.length%2==1)return;n.bondConn=s.idxGet(l,s.idxSort(r))}this.units.set(t,n)}formatBlockAtom(t,e,i){let o=0;for(let t=1;t<=this.mol.numBonds;t++){let s=e.atoms.indexOf(this.mol.bondFrom(t))>=0,i=e.atoms.indexOf(this.mol.bondTo(t))>=0;(s&&!i||!s&&i)&&o++}let n=It+t+":"+o;null!=e.connect&&(n+=":"+e.connect);let l=e.atomName.get(i);return s.notBlank(l)&&(n+=":n"+l.join(",")),n}formatBlockBond(t,e,i){let o=e.atoms.includes(this.mol.bondFrom(i)),n=e.atoms.includes(this.mol.bondTo(i));if(!(o&&!n||n&&!o))return null;let l=e.bondConn?e.bondConn.indexOf(i):-1,r=e.bondIncl.get(i),a=e.bondExcl.get(i);if(l<0&&s.isBlank(r)&&s.isBlank(a))return null;let h=It+t;return l>=0&&(h+=":"+(l+1)),s.notBlank(r)&&(h+=":i"+r.join(",")),s.notBlank(a)&&(h+=":e"+a.join(",")),h}purgeExtraFields(){for(let t=1;t<=this.mol.numAtoms;t++){let e=this.mol.atomExtra(t),i=!1;for(let t=e.length-1;t>=0;t--)e[t].startsWith(It)&&(e=s.remove(e,t),i=!0);i&&this.mol.setAtomExtra(t,e)}for(let t=1;t<=this.mol.numBonds;t++){let e=this.mol.bondExtra(t),i=!1;for(let t=e.length-1;t>=0;t--)e[t].startsWith(It)&&(e=s.remove(e,t),i=!0);i&&this.mol.setBondExtra(t,e)}}writeUnit(t,e){const{mol:i}=this;for(let o of e.atoms){let n=this.formatBlockAtom(t,e,o);i.setAtomExtra(o,s.append(i.atomExtra(o),n))}for(let o=1;o<=i.numBonds;o++){let n=this.formatBlockBond(t,e,o);n&&i.setBondExtra(o,s.append(i.bondExtra(o),n))}}nextIdentifier(t){if(t||(t=this.getIDList()),0==t.length)return 1;for(let e=0;e<t.length-1;e++)if(t[e+1]!=t[e]+1)return t[e]+1;return t[t.length-1]+1}}!function(t){t[t.Linear=0]="Linear",t[t.Bent=1]="Bent",t[t.Trigonal=2]="Trigonal",t[t.Tetra1=3]="Tetra1",t[t.Tetra2=4]="Tetra2",t[t.SqPlan=5]="SqPlan",t[t.BasePyram=6]="BasePyram",t[t.TrigBip=7]="TrigBip",t[t.Octa1=8]="Octa1",t[t.Octa2=9]="Octa2"}(Ft||(Ft={}));class Xt{static placeNewAtom(t,e){let s=t.boundary(),i=s.maxX()+ne.IDEALBOND,o=s.maxY();return t.addAtom(e,i,o)}static placeNewFragment(t,e){if(0==e.numAtoms)return;let i=[1,0,-1,1,-1,1,0,-1],o=[1,1,1,0,0,-1,-1,-1],n=s.numberArray(0,8),l=s.numberArray(0,8),r=s.numberArray(0,8),a=t.boundary(),h=e.boundary();for(let s=0;s<8;s++){let u=i[s],m=o[s];n[s]=0==s||3==s||5==s?a.minX()-h.maxX():2==s||4==s||7==s?a.maxX()-h.minX():.5*(a.minX()+a.maxX()-h.minX()-h.maxX()),l[s]=5==s||6==s||7==s?a.minY()-h.maxY():0==s||1==s||2==s?a.maxY()-h.minY():.5*(a.minY()+a.maxY()-h.minY()-h.maxY()),n[s]-=u,l[s]-=m,r[s]=Xt.fragPosScore(t,e,n[s],l[s]),u*=.25,m*=.25;for(let i=100;i>0;i--){let i=Xt.fragPosScore(t,e,n[s]+u,l[s]+m);if(i<=r[s])break;r[s]=i,n[s]+=u,l[s]+=m}for(let a=100;a>0;a--)for(let a=0;a<8;a++){u=.1*i[a],m=.1*o[a];let h=Xt.fragPosScore(t,e,n[s]+u,l[s]+m);if(h<=r[s])break;r[s]=h,n[s]+=u,l[s]+=m}}let u=0;for(let t=1;t<8;t++)r[t]>r[u]&&(u=t);e=e.clone();for(let t=1;t<=e.numAtoms;t++)e.setAtomPos(t,e.atomX(t)+n[u],e.atomY(t)+l[u]);t.append(e)}static fragPosScore(t,e,s,i){let o=0;for(let n=1;n<=t.numAtoms;n++)for(let l=1;l<=e.numAtoms;l++){let r=e.atomX(l)+s-t.atomX(n),a=e.atomY(l)+i-t.atomY(n),h=r*r+a*a;if(h<1)return 0;o+=1/h}let n=t.boundary(),l=e.boundary(),r=Math.min(l.minX()+s,n.minX()),a=Math.max(l.maxX()+s,n.maxX()),h=Math.min(l.minY()+i,n.minY()),u=Math.max(l.maxY()+i,n.maxY()),m=Math.max(1,a-r),d=Math.max(1,u-h);return o/Math.max(m/d,d/m)}static mergeOverlappingAtoms(t){return Xt.mergeFragmentsDiv(t,0)}static mergeFragmentsDiv(t,e){const i=t.numAtoms;let o=jt.overlappingAtomMask(t),n=s.booleanArray(!1,i),l=Ht.arrayAtomX(t),r=Ht.arrayAtomY(t),a=[];for(let t=0;t<i;t++)a.push(t+1);let h=e,u=e+1;0==e&&(h=i);for(let s=1;s<=h;s++)if(o[s-1]&&!n[s-1]){0==e&&(u=s+1);for(let e=u;e<=i;e++)if(o[e-1]&&!n[e-1]){if(X(l[s-1]-l[e-1],r[s-1]-r[e-1])>jt.OVERLAP_THRESHOLD_SQ)continue;let i=e,o=s,h=[0,0];for(let i=0;i<2;i++){let o=0==i?s:e;h[i]=("C"==t.atomElement(o)?0:1)+("X"==t.atomElement(o)?-100:0)+(0!=t.atomCharge(o)?1:0)+(0!=t.atomUnpaired(o)?1:0)+(t.atomIsotope(o)!=ne.ISOTOPE_NATURAL?1:0)+(t.atomHExplicit(o)!=ne.HEXPLICIT_UNKNOWN?1:0)+(Ht.hasAbbrev(t,o)?1e3:0)}h[1]>h[0]&&(i=s,o=e);for(let e=1;e<=t.numBonds;e++)t.bondFrom(e)==i&&t.setBondFrom(e,o),t.bondTo(e)==i&&t.setBondTo(e,o);n[i-1]=!0,a[i-1]=o}}for(let s=i;s>=1;s--)if(n[s-1]){s<=e&&e--,t.deleteAtomAndBonds(s);for(let t=0;t<i;t++)a[t]>s&&a[t]--}for(let s=t.numAtoms;s>e;s--)if("X"==t.atomElement(s)){t.deleteAtomAndBonds(s);for(let t=0;t<i;t++)a[t]>s&&a[t]--}return Ht.removeDuplicateBonds(t),a}static mergeFragmentsMask(t,e){let i=s.booleanArray(!1,t.numAtoms),o=t.numAtoms,n=Ht.arrayAtomX(t),l=Ht.arrayAtomY(t);for(let r=1;r<=o;r++)if(e[r-1])for(let a=1;a<=o;a++)if(!e[a-1]&&!i[a-1]&&X(n[r-1]-n[a-1],l[r-1]-l[a-1])<jt.OVERLAP_THRESHOLD_SQ){let e=a,o=r;"C"==t.atomElement(r)&&"C"!=t.atomElement(a)&&"X"!=t.atomElement(a)&&([e,o]=[r,a]),t.atomHExplicit(o)==ne.HEXPLICIT_UNKNOWN&&t.setAtomHExplicit(o,t.atomHExplicit(e)),t.setAtomUnpaired(o,t.atomUnpaired(o)+t.atomUnpaired(e)),t.setAtomCharge(o,t.atomCharge(o)+t.atomCharge(e)),t.setAtomExtra(o,s.concat(t.atomExtra(e),t.atomExtra(o)));for(let s=1;s<=t.numBonds;s++)t.bondFrom(s)==e&&t.setBondFrom(s,o),t.bondTo(s)==e&&t.setBondTo(s,o);i[e-1]=!0}for(let e=i.length;e>=1;e--)i[e-1]&&t.deleteAtomAndBonds(e);Ht.removeDuplicateBonds(t)}static matchAngleGeometry(t,e){if(e.length<=1)return!0;let i=Xt.GEOM_ANGLES[t],o=s.numberArray(0,e.length),n=s.booleanArray(!1,i.length);for(let t=0;t<e.length;t++)for(let t=1;t>=-1;t-=2){for(let s=0;s<e.length;s++)o[s]=(e[s]-e[0])*t;s.setTo(n,!1);let l=!0;for(let t=0;t<o.length;t++){let e=!1;for(let s=0;s<i.length;s++)if(!n[s]&&Math.abs(st(o[t],i[s]))<3*J){n[s]=!0,e=!0;break}if(!e){l=!1;break}}if(l)return!0}return!1}static primeDirections(t,e){let s=Xt.calculateNewBondAngles(t,e,1),i=Xt.exitVectors(t,e);return a.uniqueAngles(s.concat(i),2*J)}static exitVectors(t,e){let s=t.atomAdjList(e),i=s.length;if(0==i)return[0,90*J,180*J,-90*J];if(1==i)return[];let o=[],n=a.sortAngles(jt.atomBondAngles(t,e,s));for(let t=0;t<i;t++){let e=t<i-1?t+1:0;o.push(et(n[t]+.5*it(n[e],n[t])))}return o}static calculateNewBondAngles(t,e,s){let i=t.atomAdjList(e);if(0==i.length){let s=t.atomicNumber(e);return qt.ELEMENT_BLOCKS[s]<=2?[0,90*J,180*J,-90*J]:[90*J,-90*J,30*J,150*J,210*J,-30*J,180*J,0*J]}let o=Xt.guessAtomGeometry(t,e,s),n=jt.atomBondAngles(t,e,i);for(let t=0;t<o.length;t++){let e=Xt.mapAngleSubstituent(o[t],n);if(null!=e)return e}return[]}static guessAtomGeometry(t,e,i){let o=t.atomAdjList(e),n=o.length,l=t.atomicNumber(e),r=qt.ELEMENT_BLOCKS[l],a=qt.ELEMENT_ROWS[l],h=t.atomElement(e),u=[],m=[],d=[],c=!0;for(let s=0;s<n;s++)u.push(t.bondOrder(t.findBond(e,o[s]))),m.push(t.atomicNumber(o[s])),d.push(200*u[s]+m[s]),1!=u[s]&&(c=!0);for(let t=0;t<n-1;)d[t]>d[t+1]?(s.swap(o,t,t+1),s.swap(u,t,t+1),s.swap(m,t,t+1),s.swap(d,t,t+1),t>0&&t--):t++;let p=jt.atomBondAngles(t,e,o);if(1==n){if("C"==h||"N"==h){if(2==u[0]&&2==i)return[Ft.Linear];if(3==u[0]&&1==i||1==u[0]&&3==i)return[Ft.Linear]}return r>2?[Ft.Octa1,Ft.Octa2]:0==i||"C"!=h&&"N"!=h&&"O"!=h?[Ft.Trigonal,Ft.Linear]:[Ft.Trigonal]}if(2==n&&Math.abs(st(p[0],p[1]))>=175*J)return r<=2?[Ft.SqPlan]:[Ft.Octa1,Ft.Octa2];let f=[];0==r?f=[Ft.Trigonal,Ft.SqPlan]:1==r?f=[Ft.Trigonal,Ft.SqPlan,Ft.Octa1,Ft.Octa2]:2==r?(f.push(Ft.Trigonal),"C"==h&&c?(f.push(Ft.Tetra1),f.push(Ft.Tetra2),f.push(Ft.SqPlan)):("C"!=h||c)&&(a<=3?(f.push(Ft.Tetra1),f.push(Ft.Tetra2),f.push(Ft.SqPlan)):(f.push(Ft.Tetra1),f.push(Ft.Tetra2),f.push(Ft.SqPlan),f.push(Ft.Octa1),f.push(Ft.Octa2)))):(f.push(Ft.Octa1),f.push(Ft.Octa2));for(let t=f.length-1;t>=0;t--)Xt.matchAngleGeometry(f[t],p)||f.splice(t,1);return f}static mapAngleSubstituent(t,e){let i=Xt.GEOM_ANGLES[t];const o=e.length,n=i.length;if(o>=n)return null;if(0==o)return i.slice(0);let l=[];for(let t=0;t<o;t++)for(let r=0;r<n;r++)for(let a=1;a>=-1;a-=2){let h=[];for(let s=0;s<n;s++)h.push(et(e[t]+a*(i[s]-i[r])));let u=s.booleanArray(!1,n),m=0;for(let t=0;t<n;t++)if(!u[t])for(let s=0;s<o;s++)if(Math.abs(st(h[t],e[s]))<3*J){u[t]=!0,m++;break}if(m==o)for(let t=0;t<n;t++)u[t]||l.push(h[t])}if(0==l.length)return null;l=a.sortAngles(l);for(let t=0;t<l.length-1;t++){let e=l[t],s=st(l[t+1],e);Math.abs(s)<5*J&&(l[t]=e+.5*s,l.splice(t+1,1),t--)}return l}static refitAtomGeometry(t,e,i){let o=Xt.GEOM_ANGLES[i],n=o.length,l=t.atomAdjList(e),r=l.length;if(r<=1||r>n)return null;let a=jt.atomBondAngles(t,e,l),h=s.booleanArray(!1,r),u=!0;for(let s=0;s<r;s++)h[s]=t.bondInRing(t.findBond(e,l[s])),h[s]||(u=!1);if(u)return null;let m=null,d=0,c=Ht.calculateWalkWeight(t,e);for(let t=0;t<n;t++)for(let e=0;e<r;e++)for(let i=1;i>=-1;i-=2){let u=s.numberArray(0,r),p=s.booleanArray(!1,n);for(let s=0;s<r;s++){let l=-1,r=0;for(let h=0;h<n;h++)if(!p[h]){let n=et(o[h]*i-o[t]+a[e]),m=Math.abs(st(n,a[s]));(l<0||m<r)&&(l=h,r=m,u[s]=n)}p[l]=!0}let f=!1;for(let t=0;t<r;t++)if(h[t]&&Math.abs(st(u[t],a[t]))>2*J){f=!0;break}if(f)continue;let g=0;for(let t=0;t<r;t++)g+=c[l[t]-1]*Math.abs(st(u[t],a[t]));(null==m||g<d)&&(m=u,d=g)}if(null==m)return null;let p=!0;for(let t=0;t<r;t++)if(Math.abs(st(m[t],a[t]))>2*J){p=!1;break}if(p)return null;t=t.clone();for(let s=0;s<r;s++)h[s]||jt.rotateBond(t,e,l[s],m[s]-a[s]);return t}static switchAtomGeometry(t,e,i,o){let n=0,l=0,r=0,a=0,h=t.atomAdjList(e),u=jt.atomBondAngles(t,e,h),m=s.numberArray(0,u.length-1),d=t.atomX(e),c=t.atomY(e);for(let e=0;e<i.length;e++){let s=h.indexOf(i[e]),p=u[s];for(let t=0,e=0;t<h.length;t++)t!=s&&(m[e++]=u[t]);let f=U(t.atomX(i[e])-d,t.atomY(i[e])-c);for(let s=0;s<o.length;s++){if(h.length>=Xt.GEOM_ANGLES[o[s]].length)continue;let u=Xt.mapAngleSubstituent(o[s],m);if(null!=u)for(let s=0;s<u.length;s++){let o=st(u[s],p);if(!(Math.abs(o)<3*J)&&(o<0&&(o+=K),0==n||o<l-2*J||o<l+2*J&&i[e]<n)){let h=d+f*Math.cos(u[s]),m=c+f*Math.sin(u[s]);if(0!=jt.atomAtPoint(t,h,m))continue;n=i[e],l=o,r=h,a=m}}break}}return 0==n?null:((t=t.clone()).setAtomPos(n,r,a),t)}static pickAtomsToConnect(t,e){if(e.length<2)return null;if(2==e.length)return t.findBond(e[0],e[1])>0?null:e;const s=V(ne.IDEALBOND+.1);let i=Number.MAX_VALUE,o=0,n=0,l=[];for(let r=0;r<e.length-1;r++)for(let a=r+1;a<e.length;a++){if(t.findBond(e[r],e[a])>0)continue;let h=X(t.atomX(e[r])-t.atomX(e[a]),t.atomY(e[r])-t.atomY(e[a]));h<s?(l.push(e[r]),l.push(e[a])):h<i&&(i=h,o=e[r],n=e[a])}return 0==l.length&&0!=o&&(l.push(o),l.push(n)),0==l.length?null:l}static pickNewAtomDirection(t,e,s){if(1==s.length)return s[0];let i=s[0],o=Number.MAX_VALUE;for(let n=0;n<s.length;n++){let l=t.atomX(e)+ne.IDEALBOND*Math.cos(s[n]),r=t.atomY(e)+ne.IDEALBOND*Math.sin(s[n]),a=jt.congestionPoint(t,l,r);a>o||(jt.overlapsAtom(t,l,r,.2)&&(a+=1e5),a<o&&(i=s[n],o=a))}return i}static joinOverlappingAtoms(t,e){t=t.clone(),e=e.slice(0);const i=t.numAtoms;let o=Ht.arrayAtomX(t),n=Ht.arrayAtomY(t),l=[],r=[],a=[];for(let s=0;s<i-1;s++)if(e[s]){let h=[s+1],u=o[s],m=n[s];for(let l=s+1;l<i;l++)if(e[l]){if(X(o[l]-o[s],n[l]-n[s])>jt.OVERLAP_THRESHOLD_SQ)continue;h.push(l+1),u+=o[l],m+=n[l];let e=t.atomAdjBonds(l+1);for(let i=0;i<e.length;i++)t.bondFrom(e[i])==l+1?t.setBondFrom(e[i],s+1):t.bondTo(e[i])==l+1&&t.setBondTo(e[i],s+1)}if(1==h.length)continue;l.push(h),r.push(u/h.length),a.push(m/h.length)}if(0==l.length)return null;let h=s.booleanArray(!0,i);for(let e=0;e<l.length;e++){let s=l[e];t.setAtomPos(s[0],r[e],a[e]);for(let t=1;t<s.length;t++)h[s[t]-1]=!1}return t=Ht.subgraphMask(t,h),Ht.removeDuplicateBonds(t),t}static moveToEdge(t,e,s,i){let o=!1,n=!1,l=0,r=0,a=0,h=0,u=0,m=0,d=0,c=0;for(let s=1;s<=t.numAtoms;s++){let i=t.atomX(s),p=t.atomY(s);e[s-1]?((!o||i<l)&&(l=i),(!o||p<r)&&(r=p),(!o||i>a)&&(a=i),(!o||p>h)&&(h=p),o=!0):((!n||i<u)&&(u=i),(!n||p<m)&&(m=p),(!n||i>d)&&(d=i),(!n||p>c)&&(c=p),n=!0)}const p=.9;if(s<0&&0==i&&a<=u-p||s>0&&0==i&&l>=d+p||0==s&&i<0&&h<=m-p||0==s&&i>0&&r>=c+p)return null;t=t.clone();let f=0,g=0;s<0&&(f=u-a-1),s>0&&(f=d-l+1),i<0&&(g=m-h-1),i>0&&(g=c-r+1);for(let s=1;s<=t.numAtoms;s++)e[s-1]&&t.setAtomPos(s,t.atomX(s)+f,t.atomY(s)+g);return t}static placeAdditionalHydrogens(t,e,s){let i=t.numAtoms;const o=t.atomX(e),n=t.atomY(e);let l=t.atomAdjList(e);if(2==l.length&&2==s){const s=Math.atan2(t.atomY(l[0])-n,t.atomX(l[0])-o),r=Math.atan2(t.atomY(l[1])-n,t.atomX(l[1])-o);if(Math.abs(st(s,r))<170*J){let l=.5*(s+r)+Math.PI,a=l-30*J,h=l+30*J;return t.addAtom("H",o+ne.IDEALBOND*Math.cos(a),n+ne.IDEALBOND*Math.sin(a)),t.addAtom("H",o+ne.IDEALBOND*Math.cos(h),n+ne.IDEALBOND*Math.sin(h)),t.addBond(e,i+1,1),void t.addBond(e,i+2,1)}}if(1==l.length&&3==s){let s=Math.atan2(t.atomY(l[0])-n,t.atomX(l[0])-o),r=s+90*J,a=s+180*J,h=s+270*J;return t.addAtom("H",o+ne.IDEALBOND*Math.cos(r),n+ne.IDEALBOND*Math.sin(r)),t.addAtom("H",o+ne.IDEALBOND*Math.cos(a),n+ne.IDEALBOND*Math.sin(a)),t.addAtom("H",o+ne.IDEALBOND*Math.cos(h),n+ne.IDEALBOND*Math.sin(h)),t.addBond(e,i+1,1),t.addBond(e,i+2,1),void t.addBond(e,i+3,1)}let r=Xt.pickNewAtomDirection(t,e,Xt.primeDirections(t,e));t.addAtom("H",o+ne.IDEALBOND*Math.cos(r),n+ne.IDEALBOND*Math.sin(r)),t.addBond(e,i+1,1),s>1&&Xt.placeAdditionalHydrogens(t,e,s-1)}static allViableDirections(t,e,s){if(0==t.atomAdjCount(e)){let t=[];for(let e=0;e<12;e++)t.push(30*J);return t}let i=t.atomAdjList(e),o=Xt.exitVectors(t,e),n=Xt.guessAtomGeometry(t,e,s);1==i.length&&n.indexOf(Ft.Linear)<0&&n.push(Ft.Linear);let l=jt.atomBondAngles(t,e,i);for(let t of n){let e=Xt.mapAngleSubstituent(t,l);if(null!=e)for(let t of e)o.push(t)}return a.uniqueAngles(o,2*J)}static proposeNewRing(t,e,s,i,o,n,l){let r=Math.atan2(n,o);if(l){const t=30*J;r=Math.round(r/t)*t}return Xt.positionSimpleRing(t,e,s,i,r)}static proposeAtomRing(t,e,s,i,o){let n=[],l=t.atomX(s),r=t.atomY(s);if(0==t.atomAdjCount(s))for(let t=0;t<12;t++)n.push(K*t/12);else if(1==t.atomAdjCount(s)){let e=t.atomAdjList(s)[0];n.push(et(Math.atan2(t.atomY(e)-r,t.atomX(e)-l)+Math.PI))}else{let e=[];for(let i of t.atomAdjList(s))e.push(Math.atan2(t.atomY(i)-r,t.atomX(i)-l));e=ot(e);for(let t=0;t<e.length;t++){let s=e[t],i=e[t<e.length-1?t+1:0];n.push(s+.5*it(i,s))}}let a=Math.atan2(o,i),h=0,u=Number.MAX_VALUE;for(let t of n){let e=Math.abs(st(t,a));e<u&&(h=t,u=e)}return Xt.positionSimpleRing(t,e,t.atomX(s),t.atomY(s),h)}static proposeBondRing(t,e,s,i,o){let n=t.bondFrom(s),l=t.bondTo(s),r=t.atomX(l)-t.atomX(n),a=t.atomY(l)-t.atomY(n),h=i*a-o*r,u=h>0?-90*J:90*J,m=Math.atan2(a,r)+u,d=K/e,c=ne.IDEALBOND/(2*Math.sin(.5*d)),p=c*Math.cos(.5*d),f=.5*(t.atomX(n)+t.atomX(l))+p*Math.cos(m),g=.5*(t.atomY(n)+t.atomY(l))+p*Math.sin(m),b=[],A=[];for(let t=0;t<e;t++){let e=m-Math.PI+(t-.5)*d;b.push(f+Math.cos(e)*c),A.push(g+Math.sin(e)*c)}let[y,E]=h<0?[n,l]:[l,n];return b[0]=t.atomX(y),A[0]=t.atomY(y),b[1]=t.atomX(E),A[1]=t.atomY(E),[b,A]}static positionSimpleRing(t,e,s,i,o){let n=K/e,l=ne.IDEALBOND/(2*Math.sin(.5*n)),r=s+l*Math.cos(o),a=i+l*Math.sin(o),h=[],u=[];for(let t=0;t<e;t++){let e=o-Math.PI+t*n;h.push(r+Math.cos(e)*l),u.push(a+Math.sin(e)*l)}return[h,u]}static guidelineSprouts(t,e){let i=[],o=[],n=[];for(let i=0;i<3;i++){o.push(Xt.allViableDirections(t,e,i+1)),n.push([i+1]);for(let t=0;t<i;t++)null!=o[t]&&s.equals(o[i],o[t])&&(o[i]=null,n[t].push(i+1))}const l=t.atomX(e),r=t.atomY(e);for(let t=0;t<3;t++)if(null!=o[t]){let s={atom:e,orders:n[t],x:[],y:[]};for(let e=0;e<o[t].length;e++)s.x[e]=l+Math.cos(o[t][e])*ne.IDEALBOND,s.y[e]=r+Math.sin(o[t][e])*ne.IDEALBOND;i.push(s)}return i}}Xt.GEOM_ANGLES=[[0,180*J],[0,120*J],[0,120*J,240*J],[0,90*J,150*J,240*J],[0,120*J,180*J,240*J],[0,90*J,180*J,270*J],[0,90*J,150*J,210*J,270*J],[0,60*J,90*J,180*J,210*J],[0,60*J,120*J,180*J,240*J,300*J],[0,45*J,90*J,180*J,225*J,270*J]];class Ht{static isBlank(t){return null==t||0==t.numAtoms}static notBlank(t){return null!=t&&t.numAtoms>0}static orBlank(t){return null==t?new ne:t}static hasAnyAbbrev(t){for(let e=1;e<=t.numAtoms;e++)if(Ht.hasAbbrev(t,e))return!0;return!1}static hasAbbrev(t,e){let s=t.atomExtra(e);for(let t=0;t<(null==s?0:s.length);t++)if(s[t].startsWith("a"))return!0;return!1}static getAbbrev(t,e){let s=t.atomExtra(e);for(let t=0;t<(null!=s?s.length:0);t++)if(s[t].startsWith("a"))return ne.fromString(s[t].substring(1));return null}static setAbbrev(t,e,s){let i=0;for(let t=1;t<=s.numAtoms;t++)if(s.atomElement(t)==Ht.ABBREV_ATTACHMENT){if(i>0)throw"Multiple attachment points indicated: invalid.";i=t}if(0==i)throw"No attachment points indicated.";if(i>=2&&(s=s.clone()).swapAtoms(i,1),t.atomAdjList(e).length>1)throw"Setting abbreviation for non-terminal atom.";if(1==s.atomAdjCount(1)&&t.atomAdjCount(e)>0){let i=t.findBond(e,t.atomAdjList(e)[0]),o=s.findBond(1,s.atomAdjList(1)[0]);t.setBondOrder(i,s.bondOrder(o))}let o=t.atomExtra(e),n=-1;for(let t=0;t<(null!=o?o.length:0);t++)if(o[t].startsWith("a")){n=t;break}n<0&&(n=o.push(null)-1),o[n]="a"+s.toString(),t.setAtomExtra(e,o)}static validateAbbrevs(t){for(let e=1;e<=t.numAtoms;e++)Ht.hasAbbrev(t,e)&&(t.atomAdjCount(e)>1&&Ht.clearAbbrev(t,e),0!=t.atomCharge(e)&&t.setAtomCharge(e,0),0!=t.atomUnpaired(e)&&t.setAtomUnpaired(e,0),0!=t.atomIsotope(e)&&t.setAtomIsotope(e,ne.ISOTOPE_NATURAL),t.atomHExplicit(e)!=ne.HEXPLICIT_UNKNOWN&&t.setAtomHExplicit(e,ne.HEXPLICIT_UNKNOWN))}static convertToAbbrev(t,e,s){let i=this.convertToAbbrevIndex(t,e,s);return i?i[0]:null}static convertToAbbrevIndex(t,e,i){let o=0,n=null;for(let s=1;s<=t.numBonds;s++){let i=t.bondFrom(s),l=t.bondTo(s),r=0;if(e[i-1]&&!e[l-1]?(r=i,n=Yt.getPolymerExtensions(t,l)):!e[i-1]&&e[l-1]&&(r=l,n=Yt.getPolymerExtensions(t,i)),0!=r){if(o>0&&r!=o)return null;o=r}}if(0==o)return null;let l=t.numAtoms,r=0,a=0,h=s.booleanArray(!1,l),u=s.booleanArray(!1,l);for(let t=0;t<l;t++)h[t]=e[t],u[t]=!e[t]||t+1==o,h[t]&&t+1<=o&&r++,u[t]&&t+1<=o&&a++;let m=ne.BONDTYPE_NORMAL,d=0;for(let s of t.atomAdjList(o))if(!e[s-1]){if(0!=d){m=ne.BONDTYPE_NORMAL;break}let e=t.findBond(o,s);t.bondFrom(e)==o&&(m=t.bondType(e)),d++}let c=Ht.subgraphMask(t,u);c.setAtomElement(a,Ht.ABBREV_ATTACHMENT),c.setAtomCharge(a,0),c.setAtomUnpaired(a,0),c.setAtomHExplicit(a,ne.HEXPLICIT_UNKNOWN),c.setAtomMapNum(a,0),c.setAtomExtra(a,[]),c.setAtomTransient(a,[]);let p=c.atomAdjList(a),f=0,g=0,b=1/p.length,A=1;for(let t=0;t<p.length;t++){f+=c.atomX(p[t]),g+=c.atomY(p[t]);let e=c.findBond(a,p[t]);0==t?A=c.bondOrder(e):A!=c.bondOrder(e)&&(A=1)}f*=b,g*=b;let y=Ht.subgraphMask(t,h),E=y.addAtom(i,f,g);return y.addBond(r,E,A,m),Ht.setAbbrev(y,E,c),null!=n&&y.setAtomExtra(E,s.concat(y.atomExtra(E),n)),[y,E]}static expandAbbrevs(t,e){for(;;){let s=!1;for(let i=1;i<=t.numAtoms;i++)Ht.hasAbbrev(t,i)&&(Ht.expandOneAbbrev(t,i,e)&&(s=!0),i--);if(!s)break}}static expandOneAbbrev(t,e,s){let i=Ht.getAbbrev(t,e);if(null==i)return null;if(1!=t.atomAdjCount(e)||0==i.numAtoms)return Ht.clearAbbrev(t,e),null;let o=t.atomMapNum(e);if(o>0)for(let t of i.atomAdjList(1))i.setAtomMapNum(t,o);return Ht.expandOneAbbrevFrag(t,e,i,s)}static expandOneAbbrevFrag(t,e,i,o){let n=Yt.getPolymerExtensions(t,e),l=1==t.atomAdjCount(e)?t.atomAdjList(e)[0]:0,r=t.findBond(e,l),a=ne.BONDTYPE_NORMAL;if(r>0&&(a=t.bondType(r),t.bondFrom(r)==l||a!=ne.BONDTYPE_INCLINED&&a!=ne.BONDTYPE_DECLINED||(a=ne.BONDTYPE_NORMAL)),o){let s=t.atomX(e)-t.atomX(l),o=t.atomY(e)-t.atomY(l),n=i.atomAdjList(1),r=0,a=0,h=1/n.length;for(let t=0;t<n.length;t++)r+=i.atomX(n[t])-i.atomX(1),a+=i.atomY(n[t])-i.atomY(1);r*=h,a*=h;let u=Math.atan2(o,s),m=Math.atan2(a,r);jt.rotateMolecule(i,u-m),jt.translateMolecule(i,t.atomX(l)-i.atomX(1),t.atomY(l)-i.atomY(1))}if(null!=n)for(let t=1;t<=i.numAtoms;t++){let e=i.atomExtra(t);for(let t=e.length-1;t>=0;t--)n.indexOf(e[t])>=0&&e.splice(t,1);i.setAtomExtra(t,s.concat(e,n))}let h=t.numAtoms+1;t.append(i);for(let e=1;e<=t.numBonds;e++)t.bondFrom(e)==h?(t.setBondFrom(e,l),t.setBondType(e,a)):t.bondTo(e)==h&&(t.setBondFromTo(e,l,t.bondFrom(e)),t.setBondType(e,a));let u=s.booleanArray(!1,t.numAtoms);for(let t=u.length-i.numAtoms;t<u.length;t++)u[t]=!0;return t.deleteAtomAndBonds(h),t.deleteAtomAndBonds(e),u.splice(h-1,1),u.splice(e-1,1),u}static clearAbbrev(t,e){let s=t.atomExtra(e);for(let i=0;i<(null!=s?s.length:0);i++)if(s[i].startsWith("a"))return s.splice(i,1),t.setAtomExtra(e,s),void t.setAtomElement(e,"C")}static setAtomElement(t,e,s){t.atomElement(e)!=s&&(this.clearAbbrev(t,e),t.setAtomElement(e,s))}static addBond(t,e,s,i,o){null==o&&(o=ne.BONDTYPE_NORMAL),t.atomAdjCount(e)>=1&&this.clearAbbrev(t,e),t.atomAdjCount(s)>=1&&this.clearAbbrev(t,s);let n=t.findBond(e,s);return n>0&&t.deleteBond(n),t.addBond(e,s,i,o)}static subgraphMask(t,e){let s=[],i=0;for(let o=0;o<t.numAtoms;o++)e[o]?s.push(++i):s.push(0);if(0==i)return new ne;if(i==t.numAtoms)return t.clone();let o=new ne;for(let s=1;s<=t.numAtoms;s++)if(e[s-1]){let e=o.addAtom(t.atomElement(s),t.atomX(s),t.atomY(s),t.atomCharge(s),t.atomUnpaired(s));o.setAtomIsotope(e,t.atomIsotope(s)),o.setAtomHExplicit(e,t.atomHExplicit(s)),o.setAtomMapNum(e,t.atomMapNum(s)),o.setAtomExtra(e,t.atomExtra(s))}for(let e=1;e<=t.numBonds;e++){let i=s[t.bondFrom(e)-1],n=s[t.bondTo(e)-1];if(i>0&&n>0){let s=o.addBond(i,n,t.bondOrder(e),t.bondType(e));o.setBondExtra(s,t.bondExtra(e))}}return o}static subgraphIndex(t,e){let i=s.numberArray(0,t.numAtoms);for(let t=0;t<i.length;t++)i[t]=0;for(let t=0;t<e.length;t++)i[e[t]-1]=t+1;let o=new ne;o.keepTransient=t.keepTransient;for(let s=0;s<e.length;s++){let i=o.addAtom(t.atomElement(e[s]),t.atomX(e[s]),t.atomY(e[s]),t.atomCharge(e[s]),t.atomUnpaired(e[s]));o.setAtomIsotope(i,t.atomIsotope(e[s])),o.setAtomHExplicit(i,t.atomHExplicit(e[s])),o.setAtomMapNum(i,t.atomMapNum(e[s])),o.setAtomExtra(i,t.atomExtra(e[s])),t.keepTransient&&o.setAtomTransient(i,t.atomTransient(e[s]))}for(let e=1;e<=t.numBonds;e++){let s=i[t.bondFrom(e)-1],n=i[t.bondTo(e)-1];if(s>0&&n>0){let i=o.addBond(s,n,t.bondOrder(e),t.bondType(e));o.setBondExtra(i,t.bondExtra(e)),t.keepTransient&&o.setBondTransient(i,t.bondTransient(e))}}return o}static subgraphWithAttachments(t,e){let s=e.slice(0);for(let i=1;i<=t.numBonds;i++){let o=t.bondFrom(i)-1,n=t.bondTo(i)-1;e[o]&&!e[n]?s[n]=!0:e[n]&&!e[o]&&(s[o]=!0)}let i=t.clone();for(let t=1;t<=i.numAtoms;t++)s[t-1]&&!e[t-1]&&(i.setAtomElement(t,"X"),i.setAtomCharge(t,0),i.setAtomUnpaired(t,0),i.setAtomHExplicit(t,ne.HEXPLICIT_UNKNOWN),i.setAtomExtra(t,[]));return Ht.subgraphMask(i,s)}static append(t,e){let s=t.boundary(),i=e.boundary(),o=s.maxX()+ne.IDEALBOND-s.minX(),n=.5*(s.minY()+s.maxY()-i.minY()-i.maxY()),l=t.numAtoms;t.append(e);for(let e=l+1;e<=t.numAtoms;e++)t.setAtomPos(e,t.atomX(e)+o,t.atomY(e)+n)}static deleteAtoms(t,e){let i=s.booleanArray(!0,t.numAtoms);for(let t=0;t<e.length;t++)i[e[t]-1]=!1;return Ht.subgraphMask(t,i)}static componentList(t){if(0==t.numAtoms)return null;let e=Bt.fromMolecule(t).calculateComponentGroups();for(let t of e)s.addTo(t,1);return e}static getAtomSides(t,e){let i=Bt.fromMolecule(t),o=i.calculateComponents(),n=[];for(let t=0;t<o.length;t++)n.push(o[t]==o[e-1]);n[e-1]=!1;let l=s.maskIdx(n);i.keepNodesMask(n),o=i.calculateComponents();let r=s.max(o),a=[];for(let t=0;t<r;t++)a.push([e]);for(let t=0;t<o.length;t++)a[o[t]-1].push(l[t]+1);return a}static getBondSides(t,e){let i=t.bondFrom(e),o=t.bondTo(e),n=t.bondInRing(e),l=Bt.fromMolecule(t),r=l.calculateComponents(),a=[];for(let t=0;t<r.length;t++)a.push(r[t]==r[i-1]);n?(a[i-1]=!1,a[o-1]=!1):l.removeEdge(i-1,o-1);let h=s.maskIdx(a);l.keepNodesMask(a),r=l.calculateComponents();let u=s.max(r),m=[];for(let t=0;t<u;t++)m[t]=[],n&&(m[t].push(i),m[t].push(o));for(let t=0;t<r.length;t++)m[r[t]-1].push(h[t]+1);return m}static arrayAtomX(t){let e=s.numberArray(0,t.numAtoms);for(let s=e.length-1;s>=0;s--)e[s]=t.atomX(s+1);return e}static arrayAtomY(t){let e=s.numberArray(0,t.numAtoms);for(let s=e.length-1;s>=0;s--)e[s]=t.atomY(s+1);return e}static arrayAtomMapNum(t){let e=s.numberArray(0,t.numAtoms);for(let s=e.length-1;s>=0;s--)e[s]=t.atomMapNum(s+1);return e}static molecularFormula(t,e){let i="",o="",n="",l="";1==e?[i,o]=["{","}","{^","}"]:e instanceof Array&&(i=e[0],o=e[1],n=e[2],l=e[3]);for(let e=1;e<=t.numAtoms;e++)if(Ht.hasAbbrev(t,e)){t=t.clone(),Ht.expandAbbrevs(t,!1);break}let r=0,a=0,h=s.stringArray("",t.numAtoms);for(let e=1;e<=t.numAtoms;e++){a+=t.atomHydrogens(e);let s=t.atomElement(e);t.atomIsotope(e)!=ne.ISOTOPE_NATURAL&&(s=n+t.atomIsotope(e)+l+s),"C"==s?r++:"H"==s?a++:h[e-1]=s}h.sort();let u="";r>0&&(u+="C"),r>1&&(e&&(u+=i),u+=r,e&&(u+=o)),a>0&&(u+="H"),a>1&&(e&&(u+=i),u+=a,e&&(u+=o));for(let t=0;t<h.length;t++)if(h[t].length>0){let s=1;for(;t+1<h.length&&h[t]==h[t+1];t++)s++;u+=h[t],s>1&&(e&&(u+=i),u+=s,e&&(u+=o))}return u.toString()}static molecularWeight(t){for(let e=1;e<=t.numAtoms;e++)if(Ht.hasAbbrev(t,e)){t=t.clone(),Ht.expandAbbrevs(t,!1);break}let e=0;for(let s=1;s<=t.numAtoms;s++){e+=t.atomHydrogens(s)*qt.NATURAL_ATOMIC_WEIGHTS[1];let i=t.atomIsotope(s);if(i!=ne.ISOTOPE_NATURAL){e+=i;continue}let o=ne.elementAtomicNumber(t.atomElement(s));o>0&&o<qt.NATURAL_ATOMIC_WEIGHTS.length&&(e+=qt.NATURAL_ATOMIC_WEIGHTS[o])}return e}static removeDuplicateBonds(t){let e=[];for(let s=1;s<=t.numBonds;s++){let i=Math.min(t.bondFrom(s),t.bondTo(s))*t.numAtoms+Math.max(t.bondFrom(s),t.bondTo(s));e.push(i)}let i=s.idxSort(e),o=s.booleanArray(!1,i.length),n=0;for(;n<i.length;){let s=1;for(;n+s<i.length&&e[i[n]]==e[i[n+s]];)s++;let l=n;for(let e=n+1;e<n+s;e++){let s=i[l]+1,o=i[e]+1,n=t.bondFrom(s),r=t.bondTo(s),a=t.atomElement(n),h=t.atomElement(r),u=0,m=0;if("C"==a||"N"==a?u=4:"O"==a&&(u=3),"C"==h||"N"==h?m=4:"O"==h&&(m=3),u>0||m>0){let i=0,a=0,h=0,d=0;for(let e=1;e<=t.numBonds;e++)e==o||t.bondFrom(e)!=n&&t.bondTo(e)!=n||(i+=t.bondOrder(e)),e==o||t.bondFrom(e)!=r&&t.bondTo(e)!=r||(a+=t.bondOrder(e)),e==s||t.bondFrom(e)!=n&&t.bondTo(e)!=n||(h+=t.bondOrder(e)),e==s||t.bondFrom(e)!=r&&t.bondTo(e)!=r||(d+=t.bondOrder(e));let c=0,p=0;if(u>0&&i>u&&c++,m>0&&a>m&&c++,u>0&&h>u&&p++,m>0&&d>m&&p++,c<p)continue;if(c>p){l=e;continue}}let d=2*t.bondOrder(s),c=2*t.bondOrder(o);d+=(0==d?4:0)+(t.bondType(s)!=ne.BONDTYPE_NORMAL?1:0),c+=(0==c?4:0)+(t.bondType(o)!=ne.BONDTYPE_NORMAL?1:0),c>d&&(l=e)}o[i[l]]=!0,n+=s}for(let e=t.numBonds;e>=1;e--)o[e-1]&&t.bondFrom(e)!=t.bondTo(e)||t.deleteBond(e)}static calculateWalkWeight(t,e){let i=0,o=Bt.fromMolecule(t).calculateComponents();for(let t=0;t<o.length;t++)o[t]==o[e-1]&&i++;let n=s.numberArray(1,t.numAtoms),l=s.numberArray(0,t.numAtoms);for(n[e-1]=0;i>0;i--){for(let e=0;e<t.numAtoms;e++)l[e]=n[e];for(let e=1;e<=t.numBonds;e++){let s=t.bondFrom(e)-1,i=t.bondTo(e)-1;n[s]+=.1*l[i],n[i]+=.1*l[s]}n[e-1]=0}return n}static totalHydrogens(t,e){let s=t.atomHydrogens(e),i=t.atomAdjList(e);for(let e=0;e<i.length;e++)"H"==t.atomElement(i[e])&&s++;return s}static stripHydrogens(t,e=!1){for(let s=t.numAtoms;s>=1;s--)(e&&"H"==t.atomElement(s)||this.boringHydrogen(t,s))&&t.deleteAtomAndBonds(s)}static boringHydrogen(t,e){if("H"!=t.atomElement(e))return!1;if(0!=t.atomCharge(e)||0!=t.atomUnpaired(e))return!1;if(t.atomIsotope(e)!=ne.ISOTOPE_NATURAL)return!1;if(s.notBlank(t.atomExtra(e))||s.notBlank(t.atomTransient(e)))return!1;if(1!=t.atomAdjCount(e))return!1;let i=t.atomAdjList(e)[0];if("H"==t.atomElement(i))return!1;let o=t.atomAdjBonds(e)[0];return 1==t.bondOrder(o)&&t.bondType(o)==ne.BONDTYPE_NORMAL&&t.atomHExplicit(i)==ne.HEXPLICIT_UNKNOWN&&!(ne.HYVALENCE_EL.indexOf(t.atomElement(i))<0)}static createHydrogens(t,e){null==e&&(e=!1);let s=t.numAtoms;for(let i=1;i<=s;i++){let s=t.atomHydrogens(i);if(0!=s)if(t.atomHExplicit(i)!=ne.HEXPLICIT_UNKNOWN&&t.setAtomHExplicit(i,0),e)Xt.placeAdditionalHydrogens(t,i,s);else for(;s>0;s--){let e=t.addAtom("H",t.atomX(i),t.atomY(i));t.addBond(i,e,1)}}return t.numAtoms-s}static atomVec3(t,e){return t.is3D()?[t.atomX(e),t.atomY(e),t.atomZ(e)]:[t.atomX(e),t.atomY(e),0]}static atomOxidationState(t,e){if(0==t.atomAdjCount(e))return null;if(this.hasAbbrev(t,e))return null;let s=t.atomicNumber(e);if(0==s)return null;let i=s==qt.ELEMENT_H||2==qt.ELEMENT_BLOCKS[s],o=t.atomHydrogens(e)+(i?-t.atomCharge(e):t.atomCharge(e));for(let s of t.atomAdjBonds(e)){let n=t.bondOrder(s),l=t.bondOther(s,e),r=["O","S","Se","Te"].includes(t.atomElement(l));o+=i||r?n:n%2}return s==qt.ELEMENT_H&&1==o||s==qt.ELEMENT_B&&3==o||s==qt.ELEMENT_C&&4==o||s==qt.ELEMENT_N&&3==o||s==qt.ELEMENT_O&&2==o?null:(s!=qt.ELEMENT_S||2!=o&&4!=o&&6!=o)&&(s!=qt.ELEMENT_P||3!=o&&5!=o)&&(s!=qt.ELEMENT_F&&s!=qt.ELEMENT_Cl&&s!=qt.ELEMENT_Br&&s!=qt.ELEMENT_I||1!=o)?o:null}static oxidationStateText(t){if(0==t)return"0";let e=t<0?"-":"",s=Math.abs(t);return 1==s?e+="I":2==s?e+="II":3==s?e+="III":4==s?e+="IV":5==s?e+="V":6==s?e+="VI":7==s?e+="VII":8==s?e+="VIII":9==s?e+="IX":10==s?e+="X":11==s?e+="XI":12==s?e+="XII":e=(t>0?"+":"")+t,e}}Ht.TEMPLATE_ATTACHMENT="X",Ht.ABBREV_ATTACHMENT="*";class jt{static atomAtPoint(t,e,s,i){null==i&&(i=jt.OVERLAP_THRESHOLD);const o=i*i;for(let i=1;i<=t.numAtoms;i++)if(X(t.atomX(i)-e,t.atomY(i)-s)<o)return i;return 0}static sketchEquivalent(t,e,i){null==i&&(i=jt.DEFAULT_EQUIV_TOLERANCE);const o=t.numAtoms,n=t.numBonds;if(o!=e.numAtoms||n!=e.numBonds)return!1;const l=i*i;let r=t.boundary(),a=e.boundary();if(Math.abs(r.minX()-a.minX())>i)return!1;if(Math.abs(r.minY()-a.minY())>i)return!1;if(Math.abs(r.maxX()-a.maxX())>i)return!1;if(Math.abs(r.maxY()-a.maxY())>i)return!1;let h=Ht.arrayAtomX(t),u=Ht.arrayAtomY(t),m=Ht.arrayAtomX(e),d=Ht.arrayAtomY(e),c=s.numberArray(0,o),p=s.booleanArray(!1,o);for(let s=0;s<o;s++){let i=-1;if(X(h[s]-m[s],u[s]-d[s])<l&&(i=s),i<0){let t=Number.MAX_VALUE;for(let e=0;e<o;e++)if(!p[e]){let o=X(h[s]-m[e],u[s]-d[e]);o<t&&(t=o,i=e)}if(i<0||t>l)return!1}if(c[s]=i+1,p[i]=!0,t.atomElement(s+1)!=e.atomElement(i+1))return!1;if(t.atomCharge(s+1)!=e.atomCharge(i+1))return!1;if(t.atomUnpaired(s+1)!=e.atomUnpaired(i+1))return!1;if(t.atomHExplicit(s+1)!=e.atomHExplicit(i+1)&&t.atomHExplicit(s+1)!=ne.HEXPLICIT_UNKNOWN&&e.atomHExplicit(i+1)!=ne.HEXPLICIT_UNKNOWN)return!1}for(let s=1;s<=n;s++){let i=t.bondFrom(s),o=t.bondTo(s),n=c[i-1],l=c[o-1],r=e.findBond(n,l);if(0==r)return!1;if(t.bondOrder(s)!=e.bondOrder(r)||t.bondType(s)!=e.bondType(r))return!1;if(e.bondFrom(r)==n&&e.bondTo(r)==l);else if(e.bondType(r)==ne.BONDTYPE_INCLINED||e.bondType(r)==ne.BONDTYPE_DECLINED||e.bondFrom(r)!=l||e.bondTo(r)!=n)return!1}return!0}static sketchMappable(t,e,s){null==s&&(s=jt.DEFAULT_EQUIV_TOLERANCE);let i=t.boundary(),o=e.boundary(),n=i.minX()-o.minX(),l=i.minY()-o.minY();if(Math.abs(n)>.1*s||Math.abs(l)>.1*s){e=e.clone();for(let t=1;t<=e.numAtoms;t++)e.setAtomPos(t,e.atomX(t)+n,e.atomY(t)+l)}return jt.sketchEquivalent(t,e,s)}static atomBondAngles(t,e,s){null==s&&(s=t.atomAdjList(e));let i=[],o=t.atomX(e),n=t.atomY(e);for(let e of s)i.push(Math.atan2(t.atomY(e)-n,t.atomX(e)-o));return i}static overlapsAtom(t,e,s,i){const o=i*i;for(let i=1;i<=t.numAtoms;i++)if(X(t.atomX(i)-e,t.atomY(i)-s)<o)return!0;return!1}static overlappingAtomMask(t,e){null==e&&(e=jt.OVERLAP_THRESHOLD);const i=t.numAtoms;let o,n,l=t.boundary();l.w>l.h?(o=Ht.arrayAtomX(t),n=Ht.arrayAtomY(t)):(o=Ht.arrayAtomY(t),n=Ht.arrayAtomX(t));let r=s.booleanArray(!1,i),a=s.idxSort(o);const h=e*e;for(let t=1;t<i-1;t++){for(let s=t-1;s>=0;s--){let i=o[a[t]]-o[a[s]];if(i>e)break;X(i,n[a[t]]-n[a[s]])<h&&(r[a[t]]=!0,r[a[s]]=!0)}for(let s=t+1;s<i;s++){let i=o[a[s]]-o[a[t]];if(i>e)break;X(i,n[a[s]]-n[a[t]])<h&&(r[a[t]]=!0,r[a[s]]=!0)}}return r}static overlappingAtomList(t,e){return null==e&&(e=jt.OVERLAP_THRESHOLD),s.add(s.maskIdx(jt.overlappingAtomMask(t,e)),1)}static congestionPoint(t,e,s,i){null==i&&(i=1e-5);let o=0,n=t.numAtoms;for(let l=1;l<=n;l++)o+=1/(i+X(t.atomX(l)-e,t.atomY(l)-s));return o}static congestionMolecule(t,e){null==e&&(e=1e-5);let s=0;const i=t.numAtoms;let o=Ht.arrayAtomX(t),n=Ht.arrayAtomY(t);for(let t=0;t<i-1;t++)for(let l=t+1;l<i;l++)s+=1/(e+X(o[t]-o[l],n[t]-n[l]));return s}static translateMolecule(t,e,s){for(let i=1;i<=t.numAtoms;i++)t.setAtomPos(i,t.atomX(i)+e,t.atomY(i)+s)}static rotateMolecule(t,e,s,i){if(null==s||null==i){let e=t.boundary();s=e.midX(),i=e.midY()}let o=Math.cos(e),n=Math.sin(e);for(let e=1;e<=t.numAtoms;e++){let l=t.atomX(e)-s,r=t.atomY(e)-i;t.setAtomPos(e,s+l*o-r*n,i+l*n+r*o)}}static rotateBond(t,e,s,i){if(i=et(i),Math.abs(i)<.1*J)return;let o=Bt.fromMolecule(t);o.isolateNode(e-1);let n=o.calculateComponents(),l=t.atomX(e),r=t.atomY(e),a=Math.cos(i),h=Math.sin(i);for(let e=1;e<=t.numAtoms;e++)if(n[e-1]==n[s-1]){let s=t.atomX(e)-l,i=t.atomY(e)-r;t.setAtomPos(e,l+s*a-i*h,r+s*h+i*a)}}static rotateAtoms(t,e,s,i,o){let n=Math.cos(o),l=Math.sin(o);for(let o=1;o<=t.numAtoms;o++)if(e[o-1]){let e=t.atomX(o)-s,r=t.atomY(o)-i;t.setAtomPos(o,s+e*n-r*l,i+e*l+r*n)}}static angleNeighbours(t,e){let i=t.atomAdjList(e);if(i.length<=1)return null;let o=[];for(let s=0;s<i.length;s++)o.push(Math.atan2(t.atomY(i[s])-t.atomY(e),t.atomX(i[s])-t.atomX(e)));if(2==i.length)return st(o[1],o[0])>0?i:[i[1],i[0]];let n=s.idxSort(o);return s.idxGet(i,n)}static mergeAtoms(t,e,s){for(let i=1;i<=t.numBonds;i++)t.bondFrom(i)==e&&t.setBondFrom(i,s),t.bondTo(i)==e&&t.setBondTo(i,s);t.deleteAtomAndBonds(e)}static normaliseBondDistances(t){const e=t.numBonds;if(0==e)return;let i=[];for(let s=1;s<=e;s++){let e=t.bondFrom(s),o=t.bondTo(s);i.push(X(t.atomX(o)-t.atomX(e),t.atomY(o)-t.atomY(e)))}s.sort(i);let o=1==(1&e)?Math.sqrt(i[e>>1]):.5*(Math.sqrt(i[e>>1])+Math.sqrt(i[(e>>1)-1]));if(o<.1||o>.9*ne.IDEALBOND&&o<1.1*ne.IDEALBOND)return;let n=t.boundary(),l=n.midX(),r=n.midY(),a=ne.IDEALBOND/o;for(let e=t.numAtoms;e>=1;e--){let s=(t.atomX(e)-l)*a+l,i=(t.atomY(e)-r)*a+r;t.setAtomPos(e,s,i)}}static mirrorImage(t){t=t.clone();for(let e=1;e<=t.numAtoms;e++)t.setAtomX(e,-t.atomX(e));for(let e=1;e<=t.numBonds;e++)t.bondType(e)==ne.BONDTYPE_DECLINED?t.setBondType(e,ne.BONDTYPE_INCLINED):t.bondType(e)==ne.BONDTYPE_INCLINED&&t.setBondType(e,ne.BONDTYPE_DECLINED);return t}static alignOrientFlip(t,e,s,i){if(e.length<2||e.length!=i.length)throw"Invalid mapping indices.";let o=t.atomX(e[0]),n=t.atomY(e[0]);jt.translateMolecule(s,o-s.atomX(i[0]),n-s.atomY(i[0]));const l=e.length-1;let r=[],a=[],h=0,u=0;for(let m=0;m<l;m++){r.push(Math.atan2(t.atomY(e[m+1])-n,t.atomX(e[m+1])-o)),a.push(Math.atan2(s.atomY(i[m+1])-n,s.atomX(i[m+1])-o));let l=st(r[m],a[m]),d=st(r[m],-a[m]);l<-175*J&&h>0?l+=K:l>175*J&&h<0&&(l-=K),d<-175*J&&u>0?d+=K:d>175*J&&u<0&&(d-=K),h+=l,u+=d}if(l>1){let t=1/l;h*=t,u*=t}let m=0,d=0;for(let t=0;t<l;t++)m+=Math.abs(st(r[t],a[t]+h)),d+=Math.abs(st(r[t],-a[t]+u));if(d<m){for(let t=1;t<=s.numAtoms;t++)s.setAtomY(t,2*n-s.atomY(t));for(let t=1;t<=s.numBonds;t++)s.bondType(t)==ne.BONDTYPE_DECLINED?s.setBondType(t,ne.BONDTYPE_INCLINED):s.bondType(t)==ne.BONDTYPE_INCLINED&&s.setBondType(t,ne.BONDTYPE_DECLINED);jt.rotateMolecule(s,o,n,u)}else jt.rotateMolecule(s,o,n,h)}}jt.OVERLAP_THRESHOLD=.2,jt.OVERLAP_THRESHOLD_SQ=jt.OVERLAP_THRESHOLD*jt.OVERLAP_THRESHOLD,jt.DEFAULT_EQUIV_TOLERANCE=.2,function(t){t[t.None=0]="None",t[t.AtomCount1000=1]="AtomCount1000",t[t.BondCount1000=2]="BondCount1000",t[t.InlineAbbreviations=3]="InlineAbbreviations",t[t.ZeroOrderBonds=4]="ZeroOrderBonds",t[t.HydrogenCounting=5]="HydrogenCounting",t[t.MoleculeName=6]="MoleculeName",t[t.QueryResonance=7]="QueryResonance",t[t.QueryHCount=8]="QueryHCount"}(zt||(zt={}));const Vt=[zt.AtomCount1000,zt.BondCount1000],Wt=[zt.InlineAbbreviations],Gt=[zt.ZeroOrderBonds,zt.HydrogenCounting],$t=[zt.QueryResonance,zt.QueryHCount];class Qt{constructor(){this.level=1,this.invalid=!1,this.notes=[]}add(t,e,s,i){this.addNote({type:t,atoms:e,bonds:s,source:i})}addNote(t){this.notes.push(t),t.level=1,Vt.indexOf(t.type)>=0?t.level=1.1:Wt.indexOf(t.type)>=0?t.level=1.2:Gt.indexOf(t.type)>=0&&(t.level=1.3),this.level=Math.max(this.level,t.level),this.invalid=this.invalid||$t.indexOf(t.type)>=0}addJoin(t,e,s,i){for(let o of this.notes)if(o.type==t)return e&&o.atoms?o.atoms=o.atoms.concat(e):e&&(o.atoms=e),s&&o.bonds?o.bonds=o.bonds.concat(s):s&&(o.bonds=s),void(i&&o.source?o.source=o.source.concat(i):i&&(o.source=i));this.add(t,e,s,i)}derive(t){t.numAtoms>=1e3&&this.add(zt.AtomCount1000),t.numBonds>=1e3&&this.add(zt.BondCount1000)}}const Kt={H:[1],B:[3],C:[4],Si:[4],N:[3],P:[3,5],As:[3,5],O:[2],S:[2,4,6],Se:[2,4,6],Te:[2,4,6],F:[1],Cl:[1,3,5,7],Br:[1],I:[1,3,5,7],At:[1,3,5,7]};class Zt{constructor(t){this.parseHeader=!0,this.parseExtended=!0,this.allowV3000=!0,this.considerRescale=!0,this.relaxed=!1,this.keepAromatic=!1,this.keepParity=!1,this.mol=null,this.molName="",this.openmol=new Qt,this.atomHyd=null,this.resBonds=null,this.explicitValence=[],this.groupAttachAny=new Map,this.groupAttachAll=new Map,this.groupStereoAbsolute=[],this.groupStereoRacemic=[],this.groupStereoRelative=[],this.groupLinkNodes=[],this.groupMixtures=[],this.pos=0,this.lines=t.split(/\r?\n/)}parse(){if(this.parseHeader){if(this.molName=this.lines[0],this.molName){let t={row:0,col:0,len:this.molName.length};this.openmol.add(zt.MoleculeName,null,null,[t])}this.pos=3}return this.parseCTAB(),this.mol}nextLine(){if(this.pos>=this.lines.length)throw"MDL Molfile parser: premature end, at line "+(this.pos+1);return this.lines[this.pos++]}parseCTAB(){this.mol=new ne,this.mol.keepTransient=!0;let t=this.nextLine();if(!this.relaxed){let e=t.length>=39?t.substring(34,39):"";if(this.allowV3000&&"V3000"==e)return this.parseV3000(),void this.openmol.derive(this.mol);if("V2000"!=e)throw"Invalid MDL MOL: no Vx000 tag."}let e=parseInt(t.substring(0,3).trim()),i=parseInt(t.substring(3,6).trim());for(let i=0;i<e;i++){if(t=this.nextLine(),t.length<39)throw"Invalid MDL MOL: atom line"+(i+1);let o=parseFloat(t.substring(0,10).trim()),n=parseFloat(t.substring(10,20).trim()),l=parseFloat(t.substring(20,30).trim()),r=t.substring(31,34).trim(),a=parseInt(t.substring(36,39).trim()),h=0,u=t.length<42?0:parseInt(t.substring(39,42).trim()),m=t.length<45?0:parseInt(t.substring(42,45).trim()),d=t.length<51?0:parseInt(t.substring(48,51).trim()),c=t.length<63?0:parseInt(t.substring(60,63).trim());a>=1&&a<=3?a=4-a:4==a?(a=0,h=2):a=a>=5&&a<=7?4-a:0;let p=this.mol.addAtom(r,o,n,a,h);0!=l&&(this.mol.setAtomZ(p,l),this.mol.setIs3D(!0)),this.mol.setAtomMapNum(p,c),m>0&&(this.openmol.addJoin(zt.QueryHCount,[p]),null==this.atomHyd&&(this.atomHyd=s.numberArray(ne.HEXPLICIT_UNKNOWN,e)),this.atomHyd[i]=m-1),u>0&&this.keepParity,this.explicitValence.push(d)}for(let s=0;s<i;s++){if(t=this.nextLine(),t.length<12)throw"Invalid MDL MOL: bond line"+(s+1);let i=parseInt(t.substring(0,3).trim()),o=parseInt(t.substring(3,6).trim()),n=parseInt(t.substring(6,9).trim()),l=parseInt(t.substring(9,12).trim());if(i==o||i<1||i>e||o<1||o>e)throw"Invalid MDL MOL: bond line"+(s+1);let r=n>=1&&n<=3?n:8==n?0:1,a=ne.BONDTYPE_NORMAL;1==l?a=ne.BONDTYPE_INCLINED:6==l?a=ne.BONDTYPE_DECLINED:3!=l&&4!=l||(a=ne.BONDTYPE_UNKNOWN);let h=this.mol.addBond(i,o,r,a);if(4==n){let t={row:this.pos-1,col:6,len:3};this.openmol.addJoin(zt.QueryResonance,null,[h],[t])}}let o=new Map,n=new Map,l=new Map,r=new Map,a=new Map;for(;t=this.nextLine(),!t.startsWith("M  END");){let i=0;if(t.startsWith("M  CHG"))i=1;else if(t.startsWith("M  RAD"))i=2;else if(t.startsWith("M  ISO"))i=3;else if(t.startsWith("M  RGP"))i=4;else if(this.parseExtended&&t.startsWith("M  HYD"))i=5;else if(this.parseExtended&&t.startsWith("M  ZCH"))i=6;else if(this.parseExtended&&t.startsWith("M  ZBO"))i=7;else if(this.parseExtended&&t.startsWith("M  ZPA"))i=8;else if(this.parseExtended&&t.startsWith("M  ZRI"))i=9;else if(this.parseExtended&&t.startsWith("M  ZAR"))i=10;else if(t.startsWith("A  ")&&t.length>=6){let e=parseInt(t.substring(3,6).trim());if(e>=1&&e<=this.mol.numAtoms){if(t=this.nextLine(),null==t)break;this.mol.setAtomElement(e,t);continue}}else if(t.startsWith("M  STY")){let e=parseInt(t.substring(6,9).trim());for(let s=0;s<e;s++){let e=parseInt(t.substring(9+8*s,13+8*s).trim()),i=t.substring(14+8*s,17+8*s);"SUP"==i?r.set(e,{atoms:[],name:null}):"MIX"==i||"FOR"==i?a.set(e,{index:e,parent:0,atoms:[],type:i}):"SRU"!=i&&"COP"!=i||r.set(e,{atoms:[],name:null,bracketType:i})}}else if(t.startsWith("M  SPL")){let e=parseInt(t.substring(6,9).trim());for(let s=0;s<e;s++){let e=parseInt(t.substring(9+8*s,13+8*s).trim()),i=parseInt(t.substring(13+8*s,17+8*s).trim()),o=a.get(e);null!=o&&(o.parent=i)}}else if(t.startsWith("M  SAL")){let e=parseInt(t.substring(6,10).trim()),i=r.get(e);if(null!=i){let e=parseInt(t.substring(10,13).trim()),o=s.numberArray(0,e);for(let s=0;s<e;s++)o[s]=parseInt(t.substring(13+4*s,17+4*s).trim());i.atoms=s.concat(i.atoms,o)}let o=a.get(e);if(null!=o){let e=parseInt(t.substring(10,13).trim()),i=s.numberArray(0,e);for(let s=0;s<e;s++)i[s]=parseInt(t.substring(13+4*s,17+4*s).trim());o.atoms=s.concat(o.atoms,i)}}else if(t.startsWith("M  SBL")){let e=parseInt(t.substring(6,10).trim()),i=r.get(e);if(null!=i){let e=parseInt(t.substring(10,13).trim()),o=s.numberArray(0,e);for(let s=0;s<e;s++)o[s]=parseInt(t.substring(13+4*s,17+4*s).trim());i.bonds=s.concat(i.bonds,o)}}else if(t.startsWith("M  SMT")){let e=parseInt(t.substring(6,10).trim()),s=r.get(e);null!=s&&(s.name=t.substring(11).trim())}else if(t.startsWith("M  SCN")){let e=parseInt(t.substring(6,9).trim());for(let s=0;s<e;s++){let e=parseInt(t.substring(9+8*s,13+8*s).trim()),i=t.substring(14+8*s,17+8*s),o=r.get(e);null!=o&&(o.connectType=i.trim())}}else if(t.startsWith("M  CRS")){let e=parseInt(t.substring(6,10).trim()),i=r.get(e);if(null!=i){let e=parseInt(t.substring(10,13).trim());i.bondConn=s.numberArray(0,e);for(let s=0;s<e;s++)i.bondConn[s]=parseInt(t.substring(13+4*s,17+4*s).trim())}}else if(t.startsWith("M  LIN")){let e=parseInt(t.substring(6,9).trim());for(let s=0;s<e;s++){let e={atom:parseInt(t.substring(9+8*s,13+8*s).trim()),nbrs:[],minRep:1,maxRep:parseInt(t.substring(13+8*s,17+8*s).trim())},i=parseInt(t.substring(17+8*s,21+8*s).trim()),o=parseInt(t.substring(21+8*s,25+8*s).trim());i>0&&e.nbrs.push(i),o>0&&e.nbrs.push(o),this.groupLinkNodes.push(e)}}if(8==i||9==i||10==i){let s=parseInt(t.substring(6,9).trim()),r=parseInt(t.substring(9,13).trim()),a=8==i?o:9==i?n:l;for(let i=0;i<s;i++){let s=parseInt(t.substring(13+4*i,17+4*i).trim());if(s<1||s>e)throw"Invalid MDL MOL: M-block";let o=a.get(r);o||a.set(r,o=[]),o.push(s)}}else if(i>0){let e=parseInt(t.substring(6,9).trim());for(let s=0;s<e;s++){let e=parseInt(t.substring(9+8*s,13+8*s).trim()),o=parseInt(t.substring(13+8*s,17+8*s).trim());if(e<1)throw"Invalid MDL MOL: M-block";if(1==i)this.mol.setAtomCharge(e,o);else if(2==i)1==o||3==o?this.mol.setAtomUnpaired(e,2):2==o&&this.mol.setAtomUnpaired(e,1);else if(3==i)this.mol.setAtomIsotope(e,o);else if(4==i)this.mol.setAtomElement(e,"R"+o);else if(5==i){this.mol.setAtomHExplicit(e,o);let t={row:this.pos-1,col:9+8*s,len:8};this.openmol.addJoin(zt.HydrogenCounting,[e],null,[t])}else if(6==i)this.mol.setAtomCharge(e,o);else if(7==i){this.mol.setBondOrder(e,o);let t={row:this.pos-1,col:9+8*s,len:8};this.openmol.addJoin(zt.ZeroOrderBonds,null,[e],[t])}}}}if(this.postFix(),this.parseExtended){let t=new Dt(this.mol);for(let e of o.values())t.createPath(e);for(let e of n.values())t.createRing(e);for(let e of l.values())t.createArene(e);t.rewriteMolecule()}for(let t of s.sorted(Array.from(r.keys()))){let e=r.get(t);e.bracketType&&(r.delete(t),this.applyPolymerBlock(e))}for(let t of s.sorted(Array.from(r.keys()))){let e=r.get(t);r.delete(t),this.applySuperAtom(e,Array.from(r.values()))}for(let t of s.sorted(Array.from(a.keys())))this.groupMixtures.push(a.get(t));this.openmol.derive(this.mol)}postFix(){const t=this.mol;for(let e=1;e<=t.numAtoms;e++){let s=t.atomElement(e);"D"==s?(t.setAtomElement(e,"H"),t.setAtomIsotope(e,2)):"T"==s&&(t.setAtomElement(e,"H"),t.setAtomIsotope(e,3));let i=this.explicitValence[e-1],o=Kt[s];if(0!=i){let s=i<0||i>14?0:i;for(let i of t.atomAdjBonds(e))s-=t.bondOrder(i);s!=t.atomHydrogens(e)&&t.setAtomHExplicit(e,Math.max(0,s))}else if(o){let i=t.atomCharge(e),n="C"==s||"H"==s?Math.abs(i):"B"==s?-Math.abs(i):-i,l=t.atomUnpaired(e);l>0&&("C"==s||"O"==s||"S"==s||"N"==s||"P"==s)&&(n+=l);for(let s of t.atomAdjBonds(e))n+=t.bondOrder(s);for(let s of o)if(n<=s){let i=s-n;i!=t.atomHydrogens(e)&&t.setAtomHExplicit(e,Math.max(0,i));break}}}this.considerRescale&&jt.normaliseBondDistances(t),t.keepTransient=!1}parseV3000(){let t;!function(t){t[t.ATOM=0]="ATOM",t[t.BOND=1]="BOND",t[t.COLL=2]="COLL",t[t.SGROUP=3]="SGROUP"}(t||(t={}));let e=!1,i=null,o=null,n=[],l=[],r=[],a=[];const h="Invalid MDL MOL V3000: ";for(;;){let h=this.nextLine();if("M  END"==h)break;if(h.startsWith("M  V30 "))if(h=h.substring(7),h.startsWith("COUNTS "))o=h.substring(7);else if(h.startsWith("BEGIN CTAB"))e=!0;else if(h.startsWith("BEGIN ATOM"))i=t.ATOM;else if(h.startsWith("BEGIN BOND"))i=t.BOND;else if(h.startsWith("BEGIN COLLECTION"))i=t.COLL;else if(h.startsWith("BEGIN SGROUP"))i=t.SGROUP;else if(h.startsWith("END "))i=null;else if(e&&i==t.ATOM)n.push(h);else if(e&&i==t.BOND)l.push(h);else if(e&&i==t.COLL)r.push(h);else if(e&&i==t.SGROUP)a.push(h);else if(e&&null==i&&h.startsWith("LINKNODE ")){let t=this.splitWithQuotes(h.substring(9)),e={atom:0,nbrs:[],minRep:parseInt(t[0]),maxRep:parseInt(t[1])},i=parseInt(t[2]),o=[];for(let e=0;e<2*i;e++)o.push(parseInt(t[3+e]));s.sort(o);for(let t=0;t<o.length;t++)t<o.length-1&&o[t]==o[t+1]?e.atom=o[t++]:e.nbrs.push(o[t]);this.groupLinkNodes.push(e)}}let u=o.split(/\s+/);if(u.length<2)throw h+"counts line malformatted";let m=parseInt(u[0]),d=parseInt(u[1]);if(m<0||m>n.length)throw h+"unreasonable atom count: "+m;if(d<0||d>l.length)throw h+"unreasonable bond count: "+d;let c=[],p=[];for(let t=0;t<n.length;t++){let e=n[t];for(;t<n.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+n[t];let s=this.splitWithQuotes(e);if(s.length<6)throw h+"atom line has too few components: "+e;let i=parseInt(s[0],0);if(i<1||i>m)throw h+"invalid atom index: "+s[0];if(null!=c[i-1])throw h+"duplicate atom index: "+i;c[i-1]=s}for(let t=0;t<l.length;t++){let e=l[t];for(;t<l.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+l[t];let s=this.splitWithQuotes(e);if(s.length<4)throw h+"bond line has too few components: "+e;let i=parseInt(s[0],0);if(i<1||i>d)throw h+"invalid bond index: "+s[0];if(null!=p[i-1])throw h+"duplicate bond index: "+i;p[i-1]=s}this.explicitValence=s.numberArray(0,m);for(let t=1;t<=m;t++){let e=c[t-1];if(null==e)throw h+"atom definition missing for #"+t;let s=e[1],i=parseFloat(e[2]),o=parseFloat(e[3]),n=(parseFloat(e[4]),parseInt(e[5]));this.mol.addAtom(s,i,o),this.mol.setAtomMapNum(t,n);for(let s=6;s<e.length;s++){let i=e[s].indexOf("=");if(i<0)continue;let o=e[s].substring(0,i),n=e[s].substring(i+1);if("CHG"==o)this.mol.setAtomCharge(t,parseInt(n));else if("RAD"==o){let e=parseInt(n);1==e||3==e?this.mol.setAtomUnpaired(t,2):2==e&&this.mol.setAtomUnpaired(t,1)}else"MASS"==o?this.mol.setAtomIsotope(t,parseInt(n)):"CFG"==o?parseInt(n)>0&&this.keepParity:"VAL"==o&&(this.explicitValence[t-1]=parseInt(n))}}for(let t=1;t<=d;t++){let e=p[t-1];if(null==e)throw h+"bond definition missing for #"+t;let s=parseInt(e[1]),i=parseInt(e[2]),o=parseInt(e[3]),n=s>=1&&s<=3?s:9==s||10==s?0:1;this.mol.addBond(i,o,n);let l=null,r=null;for(let s=4;s<e.length;s++){let i=e[s].indexOf("=");if(i<0)continue;let o=e[s].substring(0,i),n=e[s].substring(i+1);if("CFG"==o){let e=parseInt(n);this.mol.setBondType(t,1==e?ne.BONDTYPE_INCLINED:2==e?ne.BONDTYPE_UNKNOWN:3==e?ne.BONDTYPE_DECLINED:ne.BONDTYPE_NORMAL)}else"DISP"==o?"COORD"==n&&this.mol.setBondOrder(t,0):"ENDPTS"==o?l=this.unpackList(n):"ATTACH"==o&&(r=n)}null!=r&&null!=l&&("ALL"==r?this.groupAttachAll.set(t,l):"ANY"==r&&this.groupAttachAny.set(t,l))}this.postFix();for(let t=0;t<r.length;t++){let e=r[t];for(;t<r.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+r[t];let s=this.splitWithQuotes(e);s[0].startsWith("MDLV30/STEABS")?s[1].startsWith("ATOMS=")&&(this.groupStereoAbsolute=this.unpackList(s[1].substring(5))):s[0].startsWith("MDLV30/STERAC")?s[1].startsWith("ATOMS=")&&this.groupStereoRacemic.push(this.unpackList(s[1].substring(6))):s[0].startsWith("MDLV30/STEREL")&&s[1].startsWith("ATOMS=")&&this.groupStereoRelative.push(this.unpackList(s[1].substring(6)))}let f=new Map;for(let t=0;t<a.length;t++){let e=a[t];for(;t<a.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+a[t];let s=this.splitWithQuotes(e),i=parseInt(s[0]);if(s.length>3&&i>0&&"SUP"==s[1]&&parseInt(s[2])==i){let t={atoms:[],name:null};for(let e=3;e<s.length;e++)s[e].startsWith("ATOMS=")?t.atoms=this.unpackList(s[e].substring(6)):s[e].startsWith("LABEL=")&&(t.name=this.withoutQuotes(s[e].substring(6)));f.set(i,t)}else if(s.length>3&&i>0&&("MIX"==s[1]||"FOR"==s[1])&&parseInt(s[2])==i){let t={index:i,parent:0,atoms:null,type:s[1]};for(let e=3;e<s.length;e++)s[e].startsWith("ATOMS=")?t.atoms=this.unpackList(s[e].substring(6)):s[e].startsWith("PARENT=")&&(t.parent=parseInt(s[e].substring(7)));this.groupMixtures.push(t)}else if(s.length>3&&i>0&&("SRU"==s[1]||"COP"==s[1])&&parseInt(s[2])==i){let t={atoms:[],name:null,bracketType:s[1]};for(let e=3;e<s.length;e++)s[e].startsWith("ATOMS=")?t.atoms=this.unpackList(s[e].substring(6)):s[e].startsWith("BONDS=")?t.bonds=this.unpackList(s[e].substring(6)):s[e].startsWith("LABEL=")?t.name=this.withoutQuotes(s[e].substring(6)):s[e].startsWith("CONNECT=")?t.connectType=s[e].substring(8):s[e].startsWith("XBCORR=")&&(t.bondConn=this.unpackList(s[e].substring(7)));f.set(i,t)}}for(let t of s.sorted(Array.from(f.keys()))){let e=f.get(t);e.bracketType&&(f.delete(t),this.applyPolymerBlock(e))}for(let t of s.sorted(Array.from(f.keys()))){let e=f.get(t);f.delete(t),this.applySuperAtom(e,Array.from(f.values()))}}applySuperAtom(t,e){if(null==t.name||s.isBlank(t.atoms))return;let i=s.booleanArray(!0,this.mol.numAtoms);for(let e of t.atoms)i[e-1]=!1;let o,n=t.name;for(;(o=n.indexOf("\\S"))>=0;)n=n.substring(0,o)+"{^"+n.substring(o+2);for(;(o=n.indexOf("\\s"))>=0;)n=n.substring(0,o)+"{"+n.substring(o+2);for(;(o=n.indexOf("\\n"))>=0;)n=n.substring(0,o)+"}"+n.substring(o+2);let[l,r]=Ht.convertToAbbrevIndex(this.mol,i,n);if(null==l)return;this.mol=l;let a=s.maskMap(i);for(let t of e){let e=!1;for(let i=t.atoms.length-1;i>=0;i--){let o=a[t.atoms[i]-1]+1;0==o?(t.atoms=s.remove(t.atoms,i),e=!0):t.atoms[i]=o}e&&(t.atoms=s.sorted(s.append(t.atoms,r)))}}applyPolymerBlock(t){let e=new Yt(this.mol),i=null;if(null==t.connectType);else if("HT"==t.connectType)i=_t.HeadToTail;else if("HH"==t.connectType)i=_t.HeadToHead;else{if("EU"!=t.connectType)return;i=_t.Random}let o=null;if(3==s.len(t.bondConn)){let e=t.bondConn[0],s=t.bondConn[2],i=t.bondConn[1],n=0;for(let o=1;o<=this.mol.numBonds;o++)if(o!=e&&o!=s&&o!=i){let e=t.atoms.indexOf(this.mol.bondFrom(o))>=0,s=t.atoms.indexOf(this.mol.bondTo(o))>=0;if(e&&!s||!e&&s){if(n>0){n=0;break}n=o}}o=[e,s,i,n]}else 4==s.len(t.bondConn)&&(o=t.bondConn);let n=new Ut(t.atoms);n.connect=i,n.bondConn=o,e.createUnit(n)}withoutQuotes(t){return t.length>=2&&t.startsWith('"')&&t.endsWith('"')?t.substring(1,t.length-1):t}splitWithQuotes(t){let e=[],s="",i=0,o=!1;for(let n=0;n<t.length;n++){let l=t.charAt(n);" "!=l||0!=i||o?(s+=l,'"'==l?o=!o:"("==l||"["==l?i++:")"!=l&&"]"!=l||i--):(s.length>0&&e.push(s),s="")}return s.length>0&&e.push(s),e}unpackList(t){if(!t.startsWith("(")||!t.endsWith(")"))return null;t=t.substring(1,t.length-1);let e=[];for(let s of t.split(" "))e.push(parseInt(s));return e[0]!=e.length-1?null:s.remove(e,0)}}class Jt{constructor(t){this.ds=new re,this.upcastColumns=!0,this.pos=0,this.lines=t.split(/\r?\n/)}parse(){return this.parseStream(),this.upcastColumns&&this.upcastStringColumns(),this.ds}parseStream(){let t=this.ds;t.appendColumn("Molecule","molecule","Molecular structure");let e=-1,s=[];for(;this.pos<this.lines.length;){let i=this.lines[this.pos++];if(!i.startsWith("$$$$")){s.push(i);continue}let o=t.appendRow(),n="",l=0;for(;l<s.length&&(i=s[l],!i.startsWith("> "))&&(n+=i+"\n",l++,!i.startsWith("M\tEND")););let r=null,a=null;try{if(n.length>0){let t=new Zt(n);t.parse(),r=t.mol,a=t.molName}}catch(t){}if(null!=r&&t.setMolecule(o,0,r),a&&(e<0&&(e=t.appendColumn("Name","string","Molecule name")),t.setString(o,e,a)),0==o&&null!=r){let e=s[0],i=s[2];e.length>=7&&e.startsWith("$name=")&&t.changeColumnName(0,e.substring(6),t.colDescr(0)),i.length>=8&&i.startsWith("$title=")&&(t.title=i.substring(7))}for(;l+1<s.length;l+=3){let e=s[l],i=s[l+1];if(!e.startsWith(">"))continue;let n=e.indexOf("<");if(n<0)continue;if(e=e.substring(n+1),n=e.indexOf(">"),n<0)continue;if(e=e.substring(0,n),0==e.length)continue;for(;l+2<s.length&&s[l+2].length>0;)i+="\n"+s[l+2],l++;let r=t.findColByName(e);r<0&&(r=t.appendColumn(e,"string","")),0==i.length?t.setToNull(o,r):t.setString(o,r,i)}s=[]}0==t.numRows&&(this.ds=null)}upcastStringColumns(){let t=this.ds;for(let e=0;e<t.numCols;e++)if("string"==t.colType(e)){let s=!0,i=!0,o=!0,n=!0;for(let l=0;l<t.numRows&&(i||o||n);l++){if(t.isNull(l,e))continue;s=!1;let r=t.getString(l,e);if(n){let t=r.toLowerCase();"true"!=t&&"false"!=t&&(n=!1)}if(o){let t=parseInt(r);isFinite(t)&&t==parseFloat(r)||(o=!1)}i&&(isFinite(parseFloat(r))||(i=!1))}s||(o?t.changeColumnType(e,"integer"):i?t.changeColumnType(e,"real"):n&&t.changeColumnType(e,"boolean"))}}}class te{constructor(t){this.mol=t,this.includeHeader=!0,this.enhancedFields=!0,this.chargeSeparate=!1,this.abbrevSgroups=!0,this.polymerBlocks=!0,this.molName="",this.sgroupNames=[],this.sgroupAtoms=[],this.lines=[]}write(){return this.includeHeader&&(this.lines.push(this.molName),this.lines.push("Generated by WebMolKit"),this.lines.push(""),this.writeCTAB()),this.lines.join("\n")}getResult(){return this.lines.join("\n")}writeCTAB(){let t=this.mol;Ht.hasAnyAbbrev(t)&&(t=this.mol=t.clone(),this.abbrevSgroups?(this.partialAbbrevExpansion(),this.prepareSgroups()):Ht.expandAbbrevs(t,!0)),this.lines.push(this.intrpad(t.numAtoms,3)+this.intrpad(t.numBonds,3)+"  0  0  0  0  0  0  0  0999 V2000");let e=[],i=[],o=[],n=[],l=[],r=[],a=[],h=[],u=[],m=[],d=[],c=[];for(let s=1;s<=t.numAtoms;s++){let d=t.atomX(s),c=t.atomY(s),p=0,f=this.rpad(d.toFixed(4),10)+this.rpad(c.toFixed(4),10)+this.rpad(p.toFixed(4),10),g=t.atomElement(s);for(g.length>3&&(g=g.substring(0,3)),g.length>1&&"R"==g.charAt(0)&&g.charAt(1)>="0"&&g.charAt(1)<="9"&&(a.push(s),h.push(parseInt(g.substring(1))),g="R#");g.length<4;)g+=" ";f+=" "+g+"0";let b=t.atomCharge(s),A=t.atomUnpaired(s),y=t.atomMapNum(s);b=b>=-3&&b<=-1?4-b:0==b&&2==A?4:b>=1&&b<=3?4-b:0;let E=this.mdlValence(t,s,15);f+=this.intrpad(b,3)+"  0  0  0"+this.intrpad(E,3)+"  0  0  0"+this.intrpad(y,3)+"  0  0",this.lines.push(f),0!=t.atomCharge(s)&&(e.push(s),i.push(t.atomCharge(s))),this.enhancedFields&&t.atomHExplicit(s)!=ne.HEXPLICIT_UNKNOWN&&(u.push(s),m.push(t.atomHExplicit(s))),1==A&&(o.push(s),n.push(2)),2==A&&(o.push(s),n.push(1)),t.atomIsotope(s)!=ne.ISOTOPE_NATURAL&&(l.push(s),r.push(t.atomIsotope(s)))}for(let e=1;e<=t.numBonds;e++){let s=t.bondOrder(e),i=s;0==i?i=8:i>3&&(i=3);let o=t.bondType(e);o==ne.BONDTYPE_NORMAL||(o=o==ne.BONDTYPE_INCLINED?1:o==ne.BONDTYPE_DECLINED?6:o==ne.BONDTYPE_UNKNOWN?1==i?4:3:0);let n=this.intrpad(t.bondFrom(e),3)+this.intrpad(t.bondTo(e),3)+this.intrpad(i,3)+this.intrpad(o,3)+"  0  0  0";this.lines.push(n),this.enhancedFields&&(s<1||s>3||i!=s)&&(d.push(e),c.push(s))}if(this.writeMBlockPair("CHG",e,i),this.writeMBlockPair("RAD",o,n),this.writeMBlockPair("ISO",l,r),this.writeMBlockPair("RGP",a,h),this.writeMBlockPair("HYD",u,m),this.writeMBlockPair("ZCH",[],[]),this.writeMBlockPair("ZBO",d,c),this.enhancedFields){let t=new Dt(this.mol),e=0;for(let s of t.getResPaths())this.writeMBlockFlat("ZPA",++e,s.atoms);for(let s of t.getResRings())this.writeMBlockFlat("ZRI",++e,s.atoms);for(let i of t.getArenes())this.writeMBlockFlat("ZAR",++e,s.prepend(i.atoms,i.centre))}let p=s.booleanArray(!1,t.numAtoms);for(let t=0;t<this.sgroupAtoms.length;t++){let e=this.sgroupAtoms[t];for(let t of e)p[t-1]=!0;let s=this.intrpad(t+1,4);this.lines.push("M  STY  1"+s+" SUP");for(let t=0;t<e.length;t+=15){let i=Math.min(e.length-t,15),o="M  SAL"+s+this.intrpad(i,3);for(let s=0;s<i;s++)o+=this.intrpad(e[t+s],4);this.lines.push(o)}this.lines.push("M  SMT"+s+" "+this.sgroupNames[t])}this.polymerBlocks&&this.encodePolymerBlocks(this.sgroupAtoms.length);for(let e=1;e<=t.numAtoms;e++)t.atomElement(e).length>2&&(this.lines.push("A  "+this.intrpad(e,3)),this.lines.push(t.atomElement(e)));this.lines.push("M  END")}writeMBlockPair(t,e,s){const i=e.length;for(let o=0;o<i;o+=8){let n=Math.min(8,i-o),l="M  "+t+this.intrpad(n,3);for(let t=0;t<n;t++)l+=this.intrpad(e[o+t],4)+this.intrpad(s[o+t],4);this.lines.push(l)}}writeMBlockFlat(t,e,s){const i=s.length;for(let o=0;o<i;o+=15){let n=Math.min(15,i-o),l="M  "+t+this.intrpad(n,3)+this.intrpad(e,4);for(let t=0;t<n;t++)l+=this.intrpad(s[o+t],4);this.lines.push(l)}}writeMBlockFlatIdxFirst(t,e,s){const i=s.length;for(let o=0;o<i;o+=15){let n=Math.min(15,i-o),l="M  "+t+this.intrpad(e,4)+this.intrpad(n,3);for(let t=0;t<n;t++)l+=this.intrpad(s[o+t],4);this.lines.push(l)}}intrpad(t,e){return this.rpad(t.toString(),e)}rpad(t,e){for(;t.length<e;)t=" "+t;return t}mdlValence(t,e,s){let i=t.atomHydrogens(e),o=t.atomElement(e),n=Kt[o];if(null==n&&0==i)return 0;let l=t.atomCharge(e),r="C"==o||"H"==o?Math.abs(l):"B"==o?-Math.abs(l):-l,a=0;for(let s of t.atomAdjBonds(e))a+=t.bondOrder(s);let h=r+i+a;if(n&&n[0]==h)return 0;let u=h-r;return u<=0||u>14?s:u}partialAbbrevExpansion(){const{mol:t}=this;for(let e=1;e<=t.numAtoms;e++)if(Ht.hasAbbrev(t,e)){let s=Ht.getAbbrev(t,e);if(null==s||1!=t.atomAdjCount(e)){Ht.clearAbbrev(t,e);continue}Ht.hasAnyAbbrev(s)&&(Ht.expandAbbrevs(s,!0),Ht.setAbbrev(t,e,s));let i=t.bondOrder(t.atomAdjBonds(e)[0]);if(1==s.atomAdjCount(1)&&i==s.bondOrder(s.atomAdjBonds(1)[0]))continue;Ht.expandOneAbbrev(t,e,!0),e--}}prepareSgroups(){const{mol:t}=this;for(let e=1;e<=t.numAtoms;e++)t.atomMapNum(e)<0&&t.setAtomMapNum(e,0);let e=0;for(let s=1;s<=t.numAtoms;s++)if(Ht.hasAbbrev(t,s)){this.sgroupNames.push(t.atomElement(s));let i=Ht.expandOneAbbrev(t,s,!0);if(null==i)continue;e--;for(let s=0;s<i.length;s++)i[s]&&t.setAtomMapNum(s+1,e);s--}for(let s=-1;s>=e;s--){let e=[];for(let i=1;i<=t.numAtoms;i++)t.atomMapNum(i)==s&&(e.push(i),t.setAtomMapNum(i,0));this.sgroupAtoms.push(e)}}encodePolymerBlocks(t){let e=new Yt(this.mol);for(let i of e.getIDList()){let o=e.getUnit(i),n=this.intrpad(++t,4);this.lines.push("M  STY  1"+n+" SRU"),o.connect==_t.HeadToTail?this.lines.push("M  SCN  1"+n+" HT "):o.connect==_t.HeadToHead?this.lines.push("M  SCN  1"+n+" HH "):o.connect==_t.Random&&this.lines.push("M  SCN  1"+n+" EU "),this.writeMBlockFlatIdxFirst("SAL",t,o.atoms);let l=null;for(let t=1;t<=this.mol.numBonds;t++){let e=o.atoms.indexOf(this.mol.bondFrom(t))>=0,i=o.atoms.indexOf(this.mol.bondTo(t))>=0;(e&&!i||!e&&i)&&(l=s.append(l,t))}if(null!=l&&this.writeMBlockFlatIdxFirst("SBL",t,l),4==s.len(o.bondConn)){let e=[o.bondConn[0],o.bondConn[2],o.bondConn[1]];this.writeMBlockFlatIdxFirst("CRS",t,e)}this.lines.push("M  SMT"+n+" n")}}}class ee{constructor(t){this.ds=t,this.enhancedFields=!0,this.chargeSeparate=!1,this.abbrevSgroups=!0,this.lines=[]}write(){let t=this.ds,e=this.lines,s=this.ds.firstColOfType("molecule");for(let i=0;i<t.numRows;i++){let o=s<0?null:t.getMolecule(i,s);if(null!=o){let t=new te(o);t.enhancedFields=this.enhancedFields,t.chargeSeparate=this.chargeSeparate,t.abbrevSgroups=this.abbrevSgroups;let s=t.write();e.push(s)}for(let o=0;o<t.numCols;o++)if(o!=s&&t.notNull(i,o)){let s=t.colType(o),n="";"string"==s?n=t.getString(i,o):"integer"==s?n=t.getInteger(i,o).toString():"real"==s?n=t.getReal(i,o).toString():"boolean"==s&&(n=t.getBoolean(i,o)?"true":"false"),""!=n&&(e.push("> <"+t.colName(o)+">"),e.push(n),e.push(""))}e.push("$$$$")}return e.join("\n")}getResult(){return this.lines.join("\n")}}class se{static readUnknown(t){if(t.startsWith('"'))try{let e=JSON.parse(t),s=se.readNative(e);if(s)return s}catch(t){}let e=se.readNative(t);if(e)return e;try{e=se.readMDLMOL(t)}catch(t){}return e}static readNative(t){let e=new ne;e.keepTransient=!0;let s=t.split(/\r?\n/);if(s.length<2)return null;if(!s[0].startsWith("SketchEl!")&&s.length>=4&&s[3].indexOf("V2000")>=0){let e=t.indexOf("SketchEl!");if(e<0)return null;s=t.substring(e).split(/r?\n/)}let i=s[0].match(/^SketchEl\!\((\d+)\,(\d+)\)/);if(!i)return null;let o=parseInt(i[1]),n=parseInt(i[2]);if(s.length<2+o+n)return null;if(!s[1+o+n].match(/^!End/))return null;for(let t=0;t<o;t++){i=s[1+t].split(/[=,;]/);let o=e.addAtom(se.skUnescape(i[0]),parseFloat(i[1]),parseFloat(i[2]),parseInt(i[3]),parseInt(i[4])),n=[],l=[];for(let t=5;t<i.length;t++)i[t].charAt(0),"i"==i[t].charAt(0)||("e"==i[t].charAt(0)?e.setAtomHExplicit(o,parseInt(i[t].substring(1))):"m"==i[t].charAt(0)?e.setAtomIsotope(o,parseInt(i[t].substring(1))):"n"==i[t].charAt(0)?e.setAtomMapNum(o,parseInt(i[t].substring(1))):"x"==i[t].charAt(0)?n.push(se.skUnescape(i[t])):"y"==i[t].charAt(0)?l.push(se.skUnescape(i[t])):"z"==i[t].charAt(0)?(e.setAtomZ(o,parseFloat(i[t].substring(1))),e.setIs3D(!0)):n.push(se.skUnescape(i[t])));e.setAtomExtra(o,n),e.setAtomTransient(o,l)}for(let t=0;t<n;t++){i=s[1+o+t].split(/[=,]/);let n=i[0].split("-"),l=parseInt(n[0].trim()),r=parseInt(n[1].trim());if(l==r)continue;let a=e.addBond(l,r,parseInt(i[1]),parseInt(i[2])),h=new Array,u=new Array;for(let t=3;t<i.length;t++)i[t].charAt(0),"x"==i[t].charAt(0)?h.push(se.skUnescape(i[t])):"y"==i[t].charAt(0)?u.push(se.skUnescape(i[t])):h.push(se.skUnescape(i[t]));e.setBondExtra(a,h),e.setBondTransient(a,u)}return e.keepTransient=!1,e}static writeNative(t){let e="SketchEl!("+t.numAtoms+","+t.numBonds+")\n";for(let s=1;s<=t.numAtoms;s++){let i=t.atomElement(s),o=t.atomX(s),n=t.atomY(s),l=t.atomCharge(s),r=t.atomUnpaired(s),a=t.atomHExplicit(s)!=ne.HEXPLICIT_UNKNOWN?"e"+t.atomHExplicit(s):"i"+t.atomHydrogens(s);e+=se.skEscape(i)+"="+o.toFixed(4)+","+n.toFixed(4)+";"+l+","+r+","+a,t.is3D()&&(e+=",z"+t.atomZ(s)),t.atomIsotope(s)!=ne.ISOTOPE_NATURAL&&(e+=",m"+t.atomIsotope(s)),t.atomMapNum(s)>0&&(e+=",n"+t.atomMapNum(s)),e+=se.skEncodeExtra(t.atomExtra(s)),e+=se.skEncodeExtra(t.atomTransient(s)),e+="\n"}for(let s=1;s<=t.numBonds;s++)e+=t.bondFrom(s)+"-"+t.bondTo(s)+"="+t.bondOrder(s)+","+t.bondType(s),e+=se.skEncodeExtra(t.bondExtra(s)),e+=se.skEncodeExtra(t.bondTransient(s)),e+="\n";return e+="!End\n",e}static readMDLMOL(t){let e=new Zt(t);return e.parseHeader=!0,e.parse(),e.mol}static writeMDLMOL(t){return new te(t).write()}static skUnescape(t){let e,s="";for(;e=t.match(/^(.*?)\\([0-9A-Fa-f][0-9A-Fa-f][0-9A-Fa-f][0-9A-Fa-f])(.*)/);)s+=e[1]+String.fromCharCode(parseInt("0x"+e[2])),t=e[3];return s+t}static skEscape(t){let e="";for(let s=0;s<t.length;s++){let i=t.charAt(s),o=t.charCodeAt(s);if(o<=32||o>127||"\\"==i||","==i||";"==i||"="==i){let t=(65535&o).toString(16).toUpperCase();e+="\\";for(let s=4-t.length;s>0;s--)e+="0";e+=t}else e+=i}return e}static skEncodeExtra(t){let e="";for(let s=0;s<t.length;s++)e+=","+se.skEscape(t[s]);return e}}class ie{}class oe{}class ne{constructor(){this.atoms=[],this.bonds=[],this.hasZCoord=!1,this.keepTransient=!1,this.hasTransient=!1,this.graph=null,this.graphBond=null,this.ringID=null,this.compID=null,this.ring3=null,this.ring4=null,this.ring5=null,this.ring6=null,this.ring7=null}clone(){let t=new ne;return t.atoms=gt(this.atoms),t.bonds=gt(this.bonds),t.hasZCoord=this.hasZCoord,t.keepTransient=this.keepTransient,t.hasTransient=this.hasTransient,t.graph=this.graph,t.graphBond=this.graphBond,t.ringID=this.ringID,t.compID=this.compID,t.ring3=this.ring3,t.ring4=this.ring4,t.ring5=this.ring5,t.ring6=this.ring6,t.ring7=this.ring7,t}static fromString(t){return se.readNative(t)}toString(){return se.writeNative(this)}append(t){let e=this.atoms.length;for(let e=1;e<=t.numAtoms;e++){let s=this.addAtom(t.atomElement(e),t.atomX(e),t.atomY(e),t.atomCharge(e),t.atomUnpaired(e));this.setAtomIsotope(s,t.atomIsotope(e)),this.setAtomHExplicit(s,t.atomHExplicit(e)),this.setAtomMapNum(s,t.atomMapNum(e)),this.setAtomExtra(s,t.atomExtra(e))}for(let s=1;s<=t.numBonds;s++){let i=this.addBond(t.bondFrom(s)+e,t.bondTo(s)+e,t.bondOrder(s),t.bondType(s));this.setBondExtra(i,t.bondExtra(s))}this.trashTransient()}get numAtoms(){return this.atoms.length}getAtom(t){if(t<1||t>this.atoms.length)throw new Error(`Molecule.getAtom: index ${t} out of range (#atoms=${this.atoms.length})`);return this.atoms[t-1]}atomElement(t){return this.getAtom(t).element}atomX(t){return this.getAtom(t).x}atomY(t){return this.getAtom(t).y}atomCharge(t){return this.getAtom(t).charge}atomUnpaired(t){return this.getAtom(t).unpaired}atomIsotope(t){return this.getAtom(t).isotope}atomHExplicit(t){return this.getAtom(t).hExplicit}atomMapNum(t){return this.getAtom(t).mapNum}atomExtra(t){return this.getAtom(t).extra.slice(0)}atomTransient(t){return this.getAtom(t).transient.slice(0)}get numBonds(){return this.bonds.length}getBond(t){if(t<1||t>this.bonds.length)throw new Error(`Molecule.getBond: index ${t} out of range (#bonds=${this.bonds.length})`);return this.bonds[t-1]}bondFrom(t){return this.getBond(t).from}bondTo(t){return this.getBond(t).to}bondOrder(t){return this.getBond(t).order}bondType(t){return this.getBond(t).type}bondExtra(t){return this.getBond(t).extra.slice(0)}bondTransient(t){return this.getBond(t).transient.slice(0)}bondFromTo(t){let e=this.getBond(t);return[e.from,e.to]}addAtom(t,e,s,i=0,o=0){let n=new ie;return n.element=t,n.x=e,n.y=s,n.charge=i,n.unpaired=o,n.isotope=ne.ISOTOPE_NATURAL,n.hExplicit=ne.HEXPLICIT_UNKNOWN,n.mapNum=0,n.extra=[],n.transient=[],this.atoms.push(n),this.trashTransient(),this.trashGraph(),this.atoms.length}setAtomElement(t,e){this.getAtom(t).element=e,this.trashTransient()}setAtomPos(t,e,s,i){let o=this.getAtom(t);o.x=e,o.y=s,o.z=null==i?0:i,this.trashTransient()}setAtomX(t,e){this.getAtom(t).x=e,this.trashTransient()}setAtomY(t,e){this.getAtom(t).y=e,this.trashTransient()}setAtomCharge(t,e){this.getAtom(t).charge=e,this.trashTransient()}setAtomUnpaired(t,e){this.getAtom(t).unpaired=e,this.trashTransient()}setAtomIsotope(t,e){this.getAtom(t).isotope=e,this.trashTransient()}setAtomHExplicit(t,e){this.getAtom(t).hExplicit=e,this.trashTransient()}setAtomMapNum(t,e){this.getAtom(t).mapNum=e,this.trashTransient()}setAtomExtra(t,e){this.getAtom(t).extra=e.slice(0)}setAtomTransient(t,e){this.getAtom(t).transient=e.slice(0),e.length>0&&(this.hasTransient=!0)}swapAtoms(t,e){let s=this.atoms[t-1];this.atoms[t-1]=this.atoms[e-1],this.atoms[e-1]=s;for(let s=0;s<this.bonds.length;s++){let i=this.bonds[s];i.from==e?i.from=t:i.from==t&&(i.from=e),i.to==e?i.to=t:i.to==t&&(i.to=e)}this.trashGraph()}addBond(t,e,s,i=ne.BONDTYPE_NORMAL){let o=new oe;return o.from=t,o.to=e,o.order=s,o.type=i,o.extra=[],o.transient=[],this.bonds.push(o),this.trashTransient(),this.trashGraph(),this.bonds.length}setBondFrom(t,e){this.getBond(t).from=e,this.trashTransient(),this.trashGraph()}setBondTo(t,e){this.getBond(t).to=e,this.trashTransient(),this.trashGraph()}setBondFromTo(t,e,s){this.getBond(t).from=e,this.getBond(t).to=s,this.trashTransient(),this.trashGraph()}setBondOrder(t,e){this.getBond(t).order=e,this.trashTransient()}setBondType(t,e){this.getBond(t).type=e,this.trashTransient()}setBondExtra(t,e){this.getBond(t).extra=e.slice(0)}setBondTransient(t,e){this.getBond(t).transient=e.slice(0),e.length>0&&(this.hasTransient=!0)}deleteAtomAndBonds(t){for(let e=this.numBonds;e>=1;e--)this.bondFrom(e)==t||this.bondTo(e)==t?this.deleteBond(e):(this.bondFrom(e)>t&&this.setBondFrom(e,this.bondFrom(e)-1),this.bondTo(e)>t&&this.setBondTo(e,this.bondTo(e)-1));this.atoms.splice(t-1,1),this.trashTransient(),this.trashGraph()}deleteBond(t){this.bonds.splice(t-1,1),this.trashTransient(),this.trashGraph()}atomHydrogens(t){let e=this.atomHExplicit(t);if(e!=ne.HEXPLICIT_UNKNOWN)return e;for(let s=0;s<ne.HYVALENCE_EL.length;s++)if(ne.HYVALENCE_EL[s]==this.atomElement(t)){e=ne.HYVALENCE_VAL[s];break}if(e==ne.HEXPLICIT_UNKNOWN)return 0;let s=this.atomCharge(t);"C"==this.atomElement(t)&&(s=-Math.abs(s)),e+=s-this.atomUnpaired(t);let i=this.atomAdjBonds(t);for(let t=0;t<i.length;t++)e-=this.bondOrder(i[t]);return e<0?0:e}findBond(t,e){for(let s=1;s<=this.numBonds;s++){let i=this.bondFrom(s),o=this.bondTo(s);if(t==i&&e==o||t==o&&e==i)return s}return 0}bondOther(t,e){let s=this.bondFrom(t),i=this.bondTo(t);return s==e?i:i==e?s:0}atomExplicit(t){let e=this.atoms[t-1];return e.isotope!=ne.ISOTOPE_NATURAL||"C"!=e.element||0!=e.charge||0!=e.unpaired||0==this.atomAdjCount(t)}atomRingBlock(t){return null==this.graph&&this.buildGraph(),null==this.ringID&&this.buildRingID(),this.ringID[t-1]}bondInRing(t){let e=this.atomRingBlock(this.bondFrom(t)),s=this.atomRingBlock(this.bondTo(t));return e>0&&e==s}atomConnComp(t){return null==this.graph&&this.buildGraph(),null==this.compID&&this.buildConnComp(),this.compID[t-1]}atomAdjCount(t){return this.buildGraph(),this.graph[t-1].length}atomAdjList(t){this.buildGraph();let e=this.graph[t-1].slice(0);for(let t=e.length-1;t>=0;t--)e[t]++;return e}atomAdjBonds(t){return this.buildGraph(),this.graphBond[t-1].slice(0)}findRingsOfSize(t){let e=null;if(3==t&&null!=this.ring3&&(e=this.ring3),4==t&&null!=this.ring4&&(e=this.ring4),5==t&&null!=this.ring5&&(e=this.ring5),6==t&&null!=this.ring6&&(e=this.ring6),7==t&&null!=this.ring7&&(e=this.ring7),null==e){null==this.graph&&this.buildGraph(),null==this.ringID&&this.buildRingID(),e=[];for(let i=1;i<=this.atoms.length;i++)if(this.ringID[i-1]>0){let o=s.numberArray(0,t);o[0]=i,this.recursiveRingFind(o,1,t,this.ringID[i-1],e)}3==t&&(this.ring3=e),4==t&&(this.ring4=e),5==t&&(this.ring5=e),6==t&&(this.ring6=e),7==t&&(this.ring7=e)}let i=[];for(let t=0;t<e.length;t++)i.push(e[t].slice(0));return i}boundary(){if(0==this.atoms.length)return c.zero();let t=this.atoms[0].x,e=t,s=this.atoms[0].y,i=s;for(let o=1;o<this.atoms.length;o++)t=Math.min(t,this.atoms[o].x),s=Math.min(s,this.atoms[o].y),e=Math.max(e,this.atoms[o].x),i=Math.max(i,this.atoms[o].y);return new c(t,s,e-t,i-s)}atomicNumber(t){return ne.elementAtomicNumber(this.atomElement(t))}static elementAtomicNumber(t){return Math.max(0,qt.ELEMENTS.indexOf(t))}is3D(){return this.hasZCoord}setIs3D(t){this.hasZCoord=t}atomZ(t){return this.getAtom(t).z}setAtomZ(t,e){this.getAtom(t).z=e}compareTo(t){if(null==t||0==t.numAtoms)return 0==this.numAtoms?0:1;if(this.numAtoms<t.numAtoms)return-1;if(this.numAtoms>t.numAtoms)return 1;if(this.numBonds<t.numBonds)return-1;if(this.numBonds>t.numBonds)return 1;for(let e=1;e<=this.numAtoms;e++){if(this.atomElement(e)<t.atomElement(e))return-1;if(this.atomElement(e)>t.atomElement(e))return 1;if(this.atomX(e)<t.atomX(e))return-1;if(this.atomX(e)>t.atomX(e))return 1;if(this.atomY(e)<t.atomY(e))return-1;if(this.atomY(e)>t.atomY(e))return 1;if(this.atomCharge(e)<t.atomCharge(e))return-1;if(this.atomCharge(e)>t.atomCharge(e))return 1;if(this.atomUnpaired(e)<t.atomUnpaired(e))return-1;if(this.atomUnpaired(e)>t.atomUnpaired(e))return 1;if(this.atomHExplicit(e)<t.atomHExplicit(e))return-1;if(this.atomHExplicit(e)>t.atomHExplicit(e))return 1;if(this.atomIsotope(e)<t.atomIsotope(e))return-1;if(this.atomIsotope(e)>t.atomIsotope(e))return 1;if(this.atomMapNum(e)<t.atomMapNum(e))return-1;if(this.atomMapNum(e)>t.atomMapNum(e))return 1;let s=this.atomExtra(e),i=t.atomExtra(e);if(s.length<i.length)return-1;if(s.length>i.length)return 1;for(let t=0;t<s.length;t++){if(s[t]<i[t])return-1;if(s[t]>i[t])return 1}if(s=this.atomTransient(e),i=t.atomTransient(e),s.length<i.length)return-1;if(s.length>i.length)return 1;for(let t=0;t<s.length;t++){if(s[t]<i[t])return-1;if(s[t]>i[t])return 1}}for(let e=1;e<=this.numBonds;e++){if(this.bondFrom(e)<t.bondFrom(e))return-1;if(this.bondFrom(e)>t.bondFrom(e))return 1;if(this.bondTo(e)<t.bondTo(e))return-1;if(this.bondTo(e)>t.bondTo(e))return 1;if(this.bondOrder(e)<t.bondOrder(e))return-1;if(this.bondOrder(e)>t.bondOrder(e))return 1;if(this.bondType(e)<t.bondType(e))return-1;if(this.bondType(e)>t.bondType(e))return 1;let s=this.bondExtra(e),i=t.bondExtra(e);if(s.length<i.length)return-1;if(s.length>i.length)return 1;for(let t=0;t<s.length;t++){if(s[t]<i[t])return-1;if(s[t]>i[t])return 1}if(s=this.bondTransient(e),i=t.bondTransient(e),s.length<i.length)return-1;if(s.length>i.length)return 1;for(let t=0;t<s.length;t++){if(s[t]<i[t])return-1;if(s[t]>i[t])return 1}}return 0}trashGraph(){this.graph=null,this.graphBond=null,this.ringID=null,this.compID=null,this.ring3=null,this.ring4=null,this.ring5=null,this.ring6=null,this.ring7=null}trashTransient(){if(!this.keepTransient&&this.hasTransient){for(let t of this.atoms)t.transient=[];for(let t of this.bonds)t.transient=[];this.hasTransient=!1}}buildGraph(){if(null!=this.graph&&null!=this.graphBond)return;let t=[],e=[],s=this.numAtoms,i=this.numBonds;for(let i=0;i<s;i++)t.push([]),e.push([]);for(let s=1;s<=i;s++){let i=this.getBond(s);t[i.from-1].push(i.to-1),t[i.to-1].push(i.from-1),e[i.from-1].push(s),e[i.to-1].push(s)}this.graph=t,this.graphBond=e}buildConnComp(){const t=this.atoms.length;this.compID=s.numberArray(0,t);for(let e=0;e<t;e++)this.compID[e]=0;let e=1;for(this.compID[0]=e;;){let s=!1;for(let i=0;i<t;i++)if(this.compID[i]==e)for(let t=0;t<this.graph[i].length;t++)0==this.compID[this.graph[i][t]]&&(this.compID[this.graph[i][t]]=e,s=!0);if(!s){for(let i=0;i<t;i++)if(0==this.compID[i]){this.compID[i]=++e,s=!0;break}if(!s)break}}}buildRingID(){const t=this.atoms.length;if(this.ringID=s.numberArray(0,t),0==t)return;let e=s.booleanArray(!1,t);for(let s=0;s<t;s++)this.ringID[s]=0,e[s]=!1;let i=s.numberArray(0,t+1),o=0,n=0;for(;;){let s,l;if(0==o)for(s=-1,l=0;e[l];l++);else{s=i[o-1],l=-1;for(let t=0;t<this.graph[s].length;t++)if(!e[this.graph[s][t]]){l=this.graph[s][t];break}}if(l>=0&&o>=2){let n=i[o-1];for(let r=0;r<this.graph[l].length;r++){let a=this.graph[l][r];if(a!=n&&e[a]){i[o]=l;for(let e=o;e==o||i[e+1]!=a;e--){let o=this.ringID[i[e]];if(0==o)this.ringID[i[e]]=s;else if(o!=s)for(let e=0;e<t;e++)this.ringID[e]==o&&(this.ringID[e]=s)}}}}if(l>=0?(e[l]=!0,i[o++]=l,n++):o--,n==t)break}let l=0;for(let e=0;e<t;e++)if(this.ringID[e]>0){l--;for(let s=t-1;s>=e;s--)this.ringID[s]==this.ringID[e]&&(this.ringID[s]=l)}for(let e=0;e<t;e++)this.ringID[e]=-this.ringID[e]}recursiveRingFind(t,e,i,o,n){const{graph:l}=this;if(e<i){let s=t[e-1];for(let r=0;r<l[s-1].length;r++){let a=l[s-1][r]+1;if(this.ringID[a-1]!=o)continue;let h=!1;for(let s=0;s<e;s++)if(t[s]==a){h=!0;break}if(!h){let s=t.slice(0);s[e]=a,this.recursiveRingFind(s,e+1,i,o,n)}}return}let r=t[e-1],a=!1;for(let e=0;e<l[r-1].length;e++)if(l[r-1][e]+1==t[0]){a=!0;break}if(!a)return;for(let e=0;e<t.length;e++){let s=0,i=t[e]-1;for(let e=0;e<l[i].length;e++)t.indexOf(l[i][e]+1)>=0&&s++;if(2!=s)return}let h=0;for(let s=1;s<e;s++)t[s]<t[h]&&(h=s);let u=(h+1)%e,m=t[(h-1+e)%e]<t[u];if(0!=h||m){let i=s.numberArray(0,e);for(let s=0;s<e;s++)i[s]=t[(h+(m?e-s:s))%e];t=i}for(let s=0;s<n.length;s++){let i=n[s],o=!0;for(let s=0;s<e;s++)if(i[s]!=t[s]){o=!1;break}if(o)return}n.push(t)}}var le;ne.IDEALBOND=1.5,ne.HEXPLICIT_UNKNOWN=-1,ne.ISOTOPE_NATURAL=0,ne.BONDTYPE_NORMAL=0,ne.BONDTYPE_INCLINED=1,ne.BONDTYPE_DECLINED=2,ne.BONDTYPE_UNKNOWN=3,ne.HYVALENCE_EL=["C","N","O","S","P"],ne.HYVALENCE_VAL=[4,3,2,2,3],ne.PREFIX_EXTRA="x",ne.PREFIX_TRANSIENT="y",function(t){t.Molecule="molecule",t.String="string",t.Real="real",t.Integer="integer",t.Boolean="boolean",t.Extend="extend"}(le||(le={}));class re{constructor(t){t||(t={}),t.title||(t.title=""),t.description||(t.description=""),null==t.numCols&&(t.numCols=s.len(t.colData)),null==t.numRows&&(t.numRows=s.len(t.rowData)),null==t.numExtens&&(t.numExtens=s.len(t.extData)),null==t.colData&&(t.colData=[]),null==t.rowData&&(t.rowData=[]),null==t.extData&&(t.extData=[]),this.data=t}clone(t=!0){let{numCols:e,numRows:s,colData:i,rowData:o}=this.data,n={title:this.data.title,description:this.data.description,numCols:e,numRows:t?s:0,numExtens:this.data.numExtens,colData:gt(i),rowData:t?new Array(s):[],extData:gt(this.data.extData)};if(t)for(let t=0;t<s;t++){let s=o[t],l=new Array(e);for(let t=0;t<e;t++)null!=s[t]&&"molecule"==i[t].type&&s[t]instanceof ne?l[t]=s[t].clone():l[t]=s[t];n.rowData[t]=l}return new re(n)}cloneMask(t,e=null,i=!0){let{numCols:o,numRows:n,colData:l,rowData:r}=this.data,a={title:this.data.title,description:this.data.description,numCols:s.maskCount(t),numRows:e?s.maskCount(e):0,numExtens:i?this.data.numExtens:0,colData:gt(s.maskGet(l,t)),rowData:[],extData:i?gt(this.data.extData):[]};if(e)for(let i=0;i<n;i++)if(e[i]){let e=r[i],o=s.maskGet(e,t);a.rowData.push(o)}const{colData:h,rowData:u}=a;for(let t=h.length-1;t>=0;t--)if("molecule"==h[t].type)for(let e=u.length-1;e>=0;e--)null!=u[e][t]&&u[e][t]instanceof ne&&(u[e][t]=u[e][t].clone());return new re(a)}getData(){return this.data}get numCols(){return this.data.numCols}get numRows(){return this.data.numRows}get title(){return this.data.title}set title(t){this.data.title=t}get description(){return this.data.description}set description(t){this.data.description=t}get numExtensions(){return this.data.numExtens}getExtName(t){return this.data.extData[t].name}getExtType(t){return this.data.extData[t].type}getExtData(t){return this.data.extData[t].data}setExtName(t,e){this.data.extData[t].name=e}setExtType(t,e){this.data.extData[t].type=e}setExtData(t,e){this.data.extData[t].data=e}appendExtension(t,e,s){return this.data.numExtens++,this.data.extData.push({name:t,type:e,data:s}),this.data.numExtens-1}insertExtension(t,e,s,i){this.data.numExtens++,this.data.extData.splice(t,0,{name:e,type:s,data:i})}deleteExtension(t){this.data.extData.splice(t,1),this.data.numExtens--}colName(t){return this.data.colData[t].name}colType(t){return this.data.colData[t].type}colDescr(t){return this.data.colData[t].descr}isNull(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:null==this.data.rowData[t][e]}notNull(t,e){return!this.isNull(t,e)}isBlank(t,e){if("string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e))return!0;let s=this.colType(e);return"molecule"==s?0==this.getMolecule(t,e).numAtoms:"string"==s?0==this.getString(t,e).length:"extend"==s&&0==this.getExtend(t,e).length}notBlank(t,e){return!this.isBlank(t,e)}getObject(t,e){return"string"==typeof e&&(e=this.findColByName(e)),this.data.rowData[t][e]}getMolecule(t,e){if("string"==typeof e&&(e=this.findColByName(e)),e<0)return null;let s=this.data.rowData[t][e];return null==s?null:("string"==typeof s&&(s=ne.fromString(s),this.data.rowData[t][e]=s),s)}getMoleculeClone(t,e){let s=this.getMolecule(t,e);return null==s?null:s.clone()}getMoleculeBlank(t,e){return this.getMolecule(t,e)||new ne}getString(t,e){if("string"==typeof e&&(e=this.findColByName(e)),e<0)return null;let s=this.data.rowData[t][e];return null==s?"":s}getInteger(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getReal(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getBoolean(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getExtend(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}setToNull(t,e){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=null)}setObject(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}setMolecule(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s?s.clone():null)}setString(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}setInteger(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}setReal(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}setBoolean(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}setExtend(t,e,s){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=s)}isEqualMolecule(t,e,s){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==s)&&(null==s||0==this.getMolecule(t,e).compareTo(s))}isEqualString(t,e,s){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==s||""==s)&&(null==s||""==s||this.getString(t,e)==s)}isEqualInteger(t,e,s){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==s)&&(null==s||this.getInteger(t,e)==s)}isEqualReal(t,e,s){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==s)&&(null==s||this.getReal(t,e)==s)}isEqualBoolean(t,e,s){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==s)&&(null==s||this.getBoolean(t,e)==s)}appendColumn(t,e,s){this.data.numCols++,this.data.colData.push({name:t,type:e,descr:s});for(let t=0;t<this.data.numRows;t++)this.data.rowData[t].push(null);return this.data.numCols-1}insertColumn(t,e,s,i){this.data.numCols++,this.data.colData.splice(t,0,{name:e,type:s,descr:i});for(let e=0;e<this.data.numRows;e++)this.data.rowData[e].splice(t,0,null)}deleteColumn(t){this.data.numCols--,this.data.colData.splice(t,1);for(let e=0;e<this.data.numRows;e++)this.data.rowData[e].splice(t,1)}changeColumnName(t,e,s){this.data.colData[t].name=e,this.data.colData[t].descr=s}changeColumnType(t,e){let s=this.colType(t);if(s==e)return;let i="molecule"==s||"molecule"==e||"extend"==s||"extend"==e;for(let o=this.data.rowData.length-1;o>=0;o--){let n=this.data.rowData[o];if(null==n[t])continue;if(i){n[t]=null;continue}let l="";if("string"==s?l=n[t]:"integer"==s||"real"==s?l=n[t].toString():"boolean"==s&&(l=n[t]?"true":"false"),n[t]=null,"string"==e)n[t]=l;else if("integer"==e){let e=parseInt(l);n[t]=isFinite(e)?e:null}else if("real"==e){let e=parseFloat(l);n[t]=isFinite(e)?e:null}else"boolean"==e&&(n[t]="true"==l.toLowerCase())}this.data.colData[t].type=e}ensureColumn(t,e,s){for(let i=0;i<this.data.numCols;i++)if(this.data.colData[i].name==t)return this.data.colData[i].type!=e&&this.changeColumnType(i,e),this.data.colData[i].descr=s,i;return this.appendColumn(t,e,s)}reorderColumns(t){let e=!0;for(let s=0;s<t.length-1;s++)if(t[s]!=t[s+1]-1){e=!1;break}if(!e){this.data.colData=s.idxGet(this.data.colData,t);for(let e=0;e<this.data.numRows;e++)this.data.rowData[e]=s.idxGet(this.data.rowData[e],t)}}appendRow(){this.data.numRows++;let t=new Array;for(let e=0;e<this.data.numCols;e++)t.push(null);return this.data.rowData.push(t),this.data.numRows-1}appendRowFrom(t,e){return this.data.numRows++,this.data.rowData.push(t.data.rowData[e].slice(0)),this.data.numRows-1}insertRow(t){this.data.numRows++;let e=new Array;for(let t=0;t<this.data.numCols;t++)e.push(null);this.data.rowData.splice(t,0,e)}deleteRow(t){this.data.numRows--,this.data.rowData.splice(t,1)}deleteAllRows(){this.data.numRows=0,this.data.rowData=new Array}moveRowUp(t){let e=this.data.rowData[t];this.data.rowData[t]=this.data.rowData[t-1],this.data.rowData[t-1]=e}moveRowDown(t){let e=this.data.rowData[t];this.data.rowData[t]=this.data.rowData[t+1],this.data.rowData[t+1]=e}swapRows(t,e){s.swap(this.data.rowData,t,e)}exciseSingleRow(t){let e={title:this.data.title,description:this.data.description,numCols:this.data.numCols,numRows:1,numExtens:this.data.numExtens,colData:this.data.colData.slice(0),rowData:[this.data.rowData[t].slice(0)],extData:this.data.extData.slice(0)};return new re(e)}colIsPrimitive(t){"string"==typeof t&&(t=this.findColByName(t));let e=this.data.colData[t].type;return"string"==e||"real"==e||"integer"==e||"boolean"==e}findColByName(t,e){for(let s=0;s<this.data.numCols;s++)if(this.data.colData[s].name==t&&(null==e||this.data.colData[s].type==e))return s;return-1}firstColOfType(t){for(let e=0;e<this.data.numCols;e++)if(this.data.colData[e].type==t)return e;return-1}copyCell(t,e,s,i,o){if(this.setToNull(t,e),s.isNull(i,o))return;let n=s.getObject(i,o);this.setObject(t,e,re.convertType(n,s.colType(o),this.colType(e)))}static convertType(t,e,s){const i=e,o=s;if(null==t||i==o||"string"==typeof t&&""==t)return t;if("string"==o){if("integer"==i)return t.toString();if("real"==i)return t.toString();if("boolean"==i)return t?"true":"false"}else if("real"==o){if("string"==i)return T(t,null);if("integer"==i)return t;if("boolean"==i)return t?1:0}else if("integer"==o){if("string"==i)return M(t,null);if("real"==i)return Math.round(t);if("boolean"==i)return t?1:0}else if("boolean"==o){if("string"==i)return"true"==t.toLowerCase();if("integer"==i)return t>0;if("real"==i)return t>=.5}return null}toString(t,e){"string"==typeof e&&(e=this.findColByName(e));let s=this.data.rowData[t][e];return null==s?null:s.toString()}toInt(t,e){if(!this.colIsPrimitive(e))return null;let s=this.data.rowData[t][e];return null==s?null:parseInt(s)}toReal(t,e){if(!this.colIsPrimitive(e))return null;let s=this.data.rowData[t][e];return null==s?null:parseFloat(s)}}class ae{constructor(t,e,s){this.code=t,this.allowModify=!0,this.ds=e||new re,null!=s&&(this.allowModify=s)}isColumnReserved(t){return!1}areColumnsReserved(t){let e=s.booleanArray(!1,t.length);for(let s=0;s<t.length;s++)e[s]=this.isColumnReserved(t[s]);return e}rowFirstBlock(t){return!0}rowBlockCount(t){return 1}aspectUnion(t){}initiateNewRow(t){}columnEffectivelyBlank(t){return[]}numTextRenderings(t){return 0}produceTextRendering(t,e){return null}numGraphicRenderings(t){return 0}produceGraphicRendering(t,e,s){return null}numHeaderRenderings(){return 0}produceHeaderRendering(t){return null}}ae.TEXT_PLAIN=0,ae.TEXT_LINK=1,ae.TEXT_HTML=2;let he={};function ue(t){let e=t.CODE,s=t.NAME;he[e]={code:e,name:s,classdef:t}}class me{constructor(t){this.ds=t}list(){let t=[],e=[],s=new Set;for(let t=0;t<this.ds.numExtensions;t++)s.add(this.ds.getExtType(t));for(let i in he)s.has(i)?t.push(i):e.push(i);return[t,e]}instantiate(t){let e=he[t];return e?new e.classdef(this.ds):null}enumerate(){let t=[];for(let e=0;e<this.ds.numExtensions;e++){let s=this.ds.getExtType(e);he[s]&&t.push(this.instantiate(s))}return t}aspectName(t){let e=he[t];return e?e.name:null}}class de{constructor(){this.prefixes={},this.targetName="",this.targetURI="",this.organismName="",this.organismURI="",this.targetTypeName="",this.targetTypeURI="",this.cellName="",this.cellURI="",this.assayTypeName="",this.assayTypeURI="",this.assayDescription="",this.sourceName="",this.sourceURI="",this.sourceVersion="",this.documentName="",this.documentURI="",this.measureTypeName="",this.measureTypeURI="",this.unitNames=[],this.unitURIs=[]}}class ce extends ae{constructor(t,e){super(ce.CODE,t,e),this.setup()}static isAssayProvenance(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==ce.CODE)return!0;return!1}getHeader(){for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ce.CODE)return this.parseMetaData(this.ds.getExtData(t));return null}setHeader(t){let e=this.formatMetaData(t);for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ce.CODE)return void this.ds.setExtData(t,e);this.ds.appendExtension(ce.NAME,ce.CODE,e)}getMolecule(t){let e=this.ds.findColByName(ce.COLNAME_MOLECULE);return e<0?null:this.ds.getMolecule(t,e)}getName(t){let e=this.ds.findColByName(ce.COLNAME_NAME);return e<0?null:this.ds.getString(t,e)}getValue(t){let e=this.ds.findColByName(ce.COLNAME_VALUE);return e<0?null:this.ds.isNull(t,e)?Number.NaN:this.ds.getReal(t,e)}getError(t){let e=this.ds.findColByName(ce.COLNAME_ERROR);if(e<0)return null;if(this.ds.isNull(t,e))return Number.NaN;let s=this.ds.getReal(t,e);return s<=0?Number.NaN:s}getUnits(t){let e=this.ds.findColByName(ce.COLNAME_UNITS);return e<0?null:this.ds.getString(t,e)}getRelation(t){let e=this.ds.findColByName(ce.COLNAME_RELATION);return e<0?null:this.ds.getString(t,e)}getSourceURI(t){let e=this.ds.findColByName(ce.COLNAME_SOURCEURI);return e<0?null:this.ds.getString(t,e)}setMolecule(t,e){let s=this.ds.findColByName(ce.COLNAME_MOLECULE);s>=0&&this.ds.setMolecule(t,s,e)}setName(t,e){let s=this.ds.findColByName(ce.COLNAME_NAME);s>=0&&this.ds.setString(t,s,e)}setValue(t,e){let s=this.ds.findColByName(ce.COLNAME_VALUE);s<0||(Number.isNaN(e)?this.ds.setToNull(t,s):this.ds.setReal(t,s,e))}setError(t,e){let s=this.ds.findColByName(ce.COLNAME_ERROR);s<0||(Number.isNaN(e)?this.ds.setToNull(t,s):this.ds.setReal(t,s,e))}setUnits(t,e){let s=this.ds.findColByName(ce.COLNAME_UNITS);s>=0&&this.ds.setString(t,s,e)}setRelation(t,e){let s=this.ds.findColByName(ce.COLNAME_RELATION);s>=0&&this.ds.setString(t,s,e)}setSourceURI(t,e){let s=this.ds.findColByName(ce.COLNAME_SOURCEURI);s>=0&&this.ds.setString(t,s,e)}setup(){this.parseAndCorrect()}parseAndCorrect(){let t=new de,e=!1;for(let s=0;s<this.ds.numExtensions;s++)if(this.ds.getExtType(s)==ce.CODE){t=this.parseMetaData(this.ds.getExtData(s)),e=!0;break}if(this.allowModify&&(this.ds.ensureColumn(ce.COLNAME_MOLECULE,"molecule","Molecular structure of compound being measured"),this.ds.ensureColumn(ce.COLNAME_NAME,"string","Name of compound"),this.ds.ensureColumn(ce.COLNAME_VALUE,"real","Measured value"),this.ds.ensureColumn(ce.COLNAME_ERROR,"real","Experimental error of measurement"),this.ds.ensureColumn(ce.COLNAME_UNITS,"string","Units of measurement"),this.ds.ensureColumn(ce.COLNAME_RELATION,"string","Relation: exact, greater or less"),this.ds.ensureColumn(ce.COLNAME_SOURCEURI,"string","Source identifier for activity measurement")),!e&&this.allowModify){let e=this.formatMetaData(t);this.ds.appendExtension(ce.NAME,ce.CODE,e)}}parseMetaData(t){let e=new de;for(let s of t.split(/\r?\n/)){let t=s.indexOf("=");t<0||(s.startsWith("pfx:")?e.prefixes[se.skUnescape(s.substring(4,t))]=se.skUnescape(s.substring(t+1)):s.startsWith("targetName=")?e.targetName=se.skUnescape(s.substring(t+1)):s.startsWith("targetURI=")?e.targetURI=se.skUnescape(s.substring(t+1)):s.startsWith("organismName=")?e.organismName=se.skUnescape(s.substring(t+1)):s.startsWith("organismURI=")?e.organismURI=se.skUnescape(s.substring(t+1)):s.startsWith("targetTypeName=")?e.targetTypeName=se.skUnescape(s.substring(t+1)):s.startsWith("targetTypeURI=")?e.targetTypeURI=se.skUnescape(s.substring(t+1)):s.startsWith("cellName=")?e.cellName=se.skUnescape(s.substring(t+1)):s.startsWith("cellURI=")?e.cellURI=se.skUnescape(s.substring(t+1)):s.startsWith("assayTypeName=")?e.assayTypeName=se.skUnescape(s.substring(t+1)):s.startsWith("assayTypeURI=")?e.assayTypeURI=se.skUnescape(s.substring(t+1)):s.startsWith("assayDescription=")?e.assayDescription=se.skUnescape(s.substring(t+1)):s.startsWith("sourceName=")?e.sourceName=se.skUnescape(s.substring(t+1)):s.startsWith("sourceURI=")?e.sourceURI=se.skUnescape(s.substring(t+1)):s.startsWith("sourceVersion=")?e.sourceVersion=se.skUnescape(s.substring(t+1)):s.startsWith("documentName=")?e.documentName=se.skUnescape(s.substring(t+1)):s.startsWith("documentURI=")?e.documentURI=se.skUnescape(s.substring(t+1)):s.startsWith("measureTypeName=")?e.measureTypeName=se.skUnescape(s.substring(t+1)):s.startsWith("measureTypeURI=")?e.measureTypeURI=se.skUnescape(s.substring(t+1)):s.startsWith("unit:")&&(e.unitNames.push(se.skUnescape(s.substring(5,t))),e.unitURIs.push(se.skUnescape(s.substring(t+1)))))}return e}formatMetaData(t){let e="";for(let s in t.prefixes)e+="pfx:"+se.skEscape(s)+"="+se.skEscape(t.prefixes[s])+"\n";e+="targetName="+se.skEscape(t.targetName)+"\n",e+="targetURI="+se.skEscape(t.targetURI)+"\n",e+="organismName="+se.skEscape(t.organismName)+"\n",e+="organismURI="+se.skEscape(t.organismURI)+"\n",e+="targetTypeName="+se.skEscape(t.targetTypeName)+"\n",e+="targetTypeURI="+se.skEscape(t.targetTypeURI)+"\n",e+="cellName="+se.skEscape(t.cellName)+"\n",e+="cellURI="+se.skEscape(t.cellURI)+"\n",e+="assayTypeName="+se.skEscape(t.assayTypeName)+"\n",e+="assayTypeURI="+se.skEscape(t.assayTypeURI)+"\n",e+="assayDescription="+se.skEscape(t.assayDescription)+"\n",e+="sourceName="+se.skEscape(t.sourceName)+"\n",e+="sourceURI="+se.skEscape(t.sourceURI)+"\n",e+="sourceVersion="+se.skEscape(t.sourceVersion)+"\n",e+="documentName="+se.skEscape(t.documentName)+"\n",e+="documentURI="+se.skEscape(t.documentURI)+"\n",e+="measureTypeName="+se.skEscape(t.measureTypeName)+"\n",e+="measureTypeURI="+se.skEscape(t.measureTypeURI)+"\n";for(let s=0,i=Math.min(t.unitNames.length,t.unitURIs.length);s<i;s++)e+="unit:"+se.skEscape(t.unitNames[s])+"="+se.skEscape(t.unitURIs[s])+"\n";return e}plainHeading(){return ce.NAME}isColumnReserved(t){return t==ce.COLNAME_VALUE||t==ce.COLNAME_ERROR||t==ce.COLNAME_UNITS||t==ce.COLNAME_RELATION||t==ce.COLNAME_SOURCEURI}numTextRenderings(t){return 2}produceTextRendering(t,e){let s=this.getHeader();if(0==e){let e={name:"Activity",descr:"Activity measurement details for this record",text:"",type:ae.TEXT_PLAIN},s=this.getValue(t),i=this.getError(t),o=this.getUnits(t),n=this.getRelation(t);return e.text="",Number.isNaN(s)||(n&&(e.text+=n+" "),e.text+=s,Number.isNaN(i)||(e.text+="  "+i),o&&(e.text+=" "+o)),e}if(1==e){let e={name:"Source",descr:"Origin of the structure and activity measurement",text:"",type:ae.TEXT_LINK},i=this.getSourceURI(t);for(let t in s.prefixes)if(i.startsWith(t+":")){i=s.prefixes[t]+i.substring(t.length+1);break}return e.text=i,e}return null}}ce.CODE="org.mmi.aspect.AssayProvenance",ce.NAME="Assay Provenance",ce.COLNAME_MOLECULE="Molecule",ce.COLNAME_NAME="Name",ce.COLNAME_VALUE="Value",ce.COLNAME_ERROR="Error",ce.COLNAME_UNITS="Units",ce.COLNAME_RELATION="Relation",ce.COLNAME_SOURCEURI="SourceURI",ce.URI_UNIT_M="http://purl.obolibrary.org/obo/UO_0000062",ce.URI_UNIT_mM="http://purl.obolibrary.org/obo/UO_0000063",ce.URI_UNIT_uM="http://purl.obolibrary.org/obo/UO_0000064",ce.URI_UNIT_nM="http://purl.obolibrary.org/obo/UO_0000065",ce.URI_UNIT_pM="http://purl.obolibrary.org/obo/UO_0000066",ce.URI_UNIT_logM="http://www.bioassayontology.org/bao#BAO_0000101",ce.URI_UNIT_perM="http://www.bioassayontology.org/bao#BAO_0000102",ce.URI_UNIT_gL="http://purl.obolibrary.org/obo/UO_0000175",ce.URI_UNIT_mgL="http://purl.obolibrary.org/obo/UO_0000273",ce.URI_UNIT_ugL="http://purl.obolibrary.org/obo/UO_0000275",ce.URI_UNIT_binary="http://www.bioassayontology.org/bao#BAO_0080023",ue(ce);class pe{constructor(){this.colNameMolecule="",this.colNameValue="",this.thresholdValue=.5,this.thresholdRelation=">=",this.folding=0,this.noteField="",this.noteTitle="",this.noteOrigin="",this.noteComment=""}}class fe extends ae{constructor(t,e){super(fe.CODE,t,e),this.setup()}static isBayesianSource(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==fe.CODE)return!0;return!1}getModels(){let t="";for(let e=0;e<this.ds.numExtensions;e++)if(this.ds.getExtType(e)==fe.CODE){t=this.ds.getExtData(e);break}let e=[],s=null;for(let i of t.split("\n")){if("model:"==i){null!=s&&e.push(s),s={};continue}if(null==s)continue;let t=i.indexOf("=");t<0||(i.startsWith("colNameMolecule=")?s.colNameMolecule=se.skUnescape(i.substring(t+1)):i.startsWith("colNameValue=")?s.colNameValue=se.skUnescape(i.substring(t+1)):i.startsWith("thresholdValue=")?s.thresholdValue=parseFloat(i.substring(t+1)):i.startsWith("thresholdRelation=")?s.thresholdRelation=se.skUnescape(i.substring(t+1)):i.startsWith("folding=")?s.folding=parseInt(i.substring(t+1)):i.startsWith("noteField=")?s.noteField=se.skUnescape(i.substring(t+1)):i.startsWith("noteTitle=")?s.noteTitle=se.skUnescape(i.substring(t+1)):i.startsWith("noteOrigin=")?s.noteOrigin=se.skUnescape(i.substring(t+1)):i.startsWith("noteComment=")&&(s.noteComment=se.skUnescape(i.substring(t+1))))}return null!=s&&e.push(s),e}setModels(t){let e=[];for(let s of t)e.push("model:"),e.push("colNameMolecule="+se.skEscape(s.colNameMolecule)),e.push("colNameValue="+se.skEscape(s.colNameValue)),e.push("thresholdValue="+s.thresholdValue),e.push("thresholdRelation="+se.skEscape(s.thresholdRelation)),e.push("folding=%d"+s.folding),e.push("noteField="+se.skEscape(s.noteField)),e.push("noteTitle="+se.skEscape(s.noteTitle)),e.push("noteOrigin="+se.skEscape(s.noteOrigin)),e.push("noteComment="+se.skEscape(s.noteComment));let s=e.join("\n");for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==fe.CODE)return void this.ds.setExtData(t,s.toString());this.ds.appendExtension("BayesianSource",fe.CODE,s.toString())}setup(){if(this.allowModify){let t=this.getModels();this.setModels(t)}}plainHeading(){return fe.NAME}}fe.CODE="org.mmi.aspect.BayesianSource",fe.NAME="Bayesian Source",ue(fe);class ge{}class be{}class Ae extends ae{constructor(t,e){super(Ae.CODE,t,e),this.setup()}static isBayesianPrediction(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==Ae.CODE)return!0;return!1}getModels(){let t="";for(let e=0;e<this.ds.numExtensions;e++)if(this.ds.getExtType(e)==Ae.CODE){t=this.ds.getExtData(e);break}let e=[],s=null;for(let i of t.split("\n")){if("model:"==i){null!=s&&e.push(s),s={};continue}if(null==s)continue;let t=i.indexOf("=");t<0||(i.startsWith("colMolecule=")?s.colMolecule=se.skUnescape(i.substring(t+1)):i.startsWith("colRaw=")?s.colRaw=se.skUnescape(i.substring(t+1)):i.startsWith("colScaled=")?s.colScaled=se.skUnescape(i.substring(t+1)):i.startsWith("colArcTan=")?s.colArcTan=se.skUnescape(i.substring(t+1)):i.startsWith("colDomain=")?s.colDomain=se.skUnescape(i.substring(t+1)):i.startsWith("colAtoms=")?s.colAtoms=se.skUnescape(i.substring(t+1)):i.startsWith("name=")?s.name=se.skUnescape(i.substring(t+1)):i.startsWith("description=")?s.description=se.skUnescape(i.substring(t+1)):i.startsWith("targetName=")?s.targetName=se.skUnescape(i.substring(t+1)):i.startsWith("isOffTarget=")&&(s.isOffTarget="true"==i.substring(t+1)))}return null!=s&&e.push(s),e}setModels(t){let e=[];for(let s of t)e.push("model:"),e.push("colMolecule="+se.skEscape(s.colMolecule)),e.push("colRaw="+se.skEscape(s.colRaw)),e.push("colScaled="+se.skEscape(s.colScaled)),e.push("colArcTan="+se.skEscape(s.colArcTan)),e.push("colDomain="+se.skEscape(s.colDomain)),e.push("colAtoms="+se.skEscape(s.colAtoms)),e.push("name="+se.skEscape(s.name)),e.push("description="+se.skEscape(s.description)),e.push("targetName="+se.skEscape(s.targetName)),e.push("isOffTarget="+s.isOffTarget);let s=e.join("\n");for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==fe.CODE)return void this.ds.setExtData(t,s.toString());this.ds.appendExtension("BayesianPrediction",Ae.CODE,s.toString())}getOutcome(t,e){let s=new be;s.raw=this.ds.getReal(t,e.colRaw),s.scaled=this.ds.getReal(t,e.colScaled),s.arctan=this.ds.getReal(t,e.colArcTan),s.domain=this.ds.getReal(t,e.colDomain);let i=this.ds.getString(t,e.colAtoms);if(i){s.atoms=[];for(let t of i.split(","))s.atoms.push(parseFloat(t))}return s}setOutcome(t,e,s){let i=this.ds.findColByName(e.colRaw,"real");i>=0&&this.ds.setReal(t,i,s.raw),i=this.ds.findColByName(e.colScaled,"real"),i>=0&&this.ds.setReal(t,i,s.scaled),i=this.ds.findColByName(e.colArcTan,"real"),i>=0&&this.ds.setReal(t,i,s.arctan),i=this.ds.findColByName(e.colDomain,"real"),i>=0&&this.ds.setReal(t,i,s.domain),i=this.ds.findColByName(e.colAtoms,"string"),i>=0&&this.ds.setString(t,i,s.atoms?s.atoms.toString():null)}setup(){if(this.allowModify){let t=this.getModels();this.setModels(t)}}plainHeading(){return fe.NAME}}Ae.CODE="org.mmi.aspect.BayesianPrediction",Ae.NAME="Bayesian Prediction",ue(Ae);class ye extends ae{constructor(t,e){super(ye.CODE,t,e),this.header={units:[],fields:[]},this.setup()}static isMeasurementData(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==ye.CODE)return!0;return!1}getHeader(){return this.header}setHeader(t){this.header=t;let e=this.formatMetaData(t);for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ye.CODE)return void this.ds.setExtData(t,e);this.ds.appendExtension(ye.NAME,ye.CODE,e)}effectHeader(t){this.setHeader(t),this.ensureFields()}rename(t,e){let s=this.header.fields[t].name;if(s!=e){this.header.fields[t].name=e,this.setHeader(this.header);for(let t of[ye.SUFFIX_VALUE,ye.SUFFIX_ERROR,ye.SUFFIX_UNITS,ye.SUFFIX_MOD]){let i=this.ds.findColByName(s+t);i>=0&&this.ds.changeColumnName(i,e+t,this.ds.colDescr(i))}}}reservedColumns(t){let e=this.header.fields[t].name;return[e+ye.SUFFIX_VALUE,e+ye.SUFFIX_ERROR,e+ye.SUFFIX_UNITS,e+ye.SUFFIX_MOD]}getValue(t,e){return this.getValueField(t,this.header.fields[e])}getValueField(t,e){let s={value:Number.NaN,error:Number.NaN,units:"",mod:""},i=this.ds.findColByName(e.name+ye.SUFFIX_VALUE,"real"),o=this.ds.findColByName(e.name+ye.SUFFIX_ERROR,"real"),n=this.ds.findColByName(e.name+ye.SUFFIX_UNITS,"string"),l=this.ds.findColByName(e.name+ye.SUFFIX_MOD,"string");return i>=0&&this.ds.notNull(t,i)&&(s.value=this.ds.getReal(t,i)),o>=0&&this.ds.notNull(t,o)&&(s.error=this.ds.getReal(t,o)),n>=0&&(s.units=this.ds.getString(t,n)),l>=0&&(s.mod=this.ds.getString(t,l)),s}setValue(t,e,s){let i=this.header.fields[e].name,o=this.ds.findColByName(i+ye.SUFFIX_VALUE,"real"),n=this.ds.findColByName(i+ye.SUFFIX_ERROR,"real"),l=this.ds.findColByName(i+ye.SUFFIX_UNITS,"string"),r=this.ds.findColByName(i+ye.SUFFIX_MOD,"string");o>=0&&(isNaN(s.value)?this.ds.setToNull(t,o):this.ds.setReal(t,o,s.value)),n>=0&&(isNaN(s.error)?this.ds.setToNull(t,n):this.ds.setReal(t,n,s.error)),l>=0&&this.ds.setString(t,l,s.units),r>=0&&this.ds.setString(t,r,s.mod)}clearValue(t,e){let s=this.header.fields[e].name,i=this.ds.findColByName(s+ye.SUFFIX_VALUE,"real"),o=this.ds.findColByName(s+ye.SUFFIX_ERROR,"real"),n=this.ds.findColByName(s+ye.SUFFIX_UNITS,"string"),l=this.ds.findColByName(s+ye.SUFFIX_MOD,"string");i>=0&&this.ds.setToNull(t,i),o>=0&&this.ds.setToNull(t,o),n>=0&&this.ds.setToNull(t,n),l>=0&&this.ds.setToNull(t,l)}getDescr(t,e){let s=this.ds.findColByName(this.header.fields[e].name);return s<0?"":this.ds.colDescr(s)}setDescr(t,e,s){let i=this.ds.findColByName(this.header.fields[e].name);i>=0&&this.ds.changeColumnName(i,this.ds.colName(i),s)}setup(){this.parseAndCorrect()}parseAndCorrect(){this.header={units:[],fields:[]};let t=!1;for(let e=0;e<this.ds.numExtensions;e++)if(this.ds.getExtType(e)==ye.CODE){this.header=this.parseMetaData(this.ds.getExtData(e)),t=!0;break}if(this.ensureFields(),!t&&this.allowModify){let t=this.formatMetaData(this.header);this.ds.appendExtension(ye.NAME,ye.CODE,t)}}ensureFields(){for(let t of this.header.fields){let e="Measurement",s=this.ds.findColByName(t.name);s>=0&&(e=this.ds.colDescr(s)),this.allowModify&&(this.ds.ensureColumn(t.name+ye.SUFFIX_VALUE,"real",e),this.ds.ensureColumn(t.name+ye.SUFFIX_ERROR,"real","Error"),this.ds.ensureColumn(t.name+ye.SUFFIX_UNITS,"string","Units"),this.ds.ensureColumn(t.name+ye.SUFFIX_MOD,"string","Modifier"))}}parseMetaData(t){let e={units:[],fields:[]};for(let s of t.split(/\r?\n/)){let t=s.indexOf("=");if(!(t<0))if(s.startsWith("unit=")){let i=s.substring(t+1).split(",");i.length>=2&&e.units.push({name:se.skUnescape(i[0]),uri:se.skUnescape(i[1])})}else if(s.startsWith("field=")){let i=s.substring(t+1).split(","),o={name:se.skUnescape(i[0]),units:[],defnURI:[]};for(let t=1;t<i.length;t++)o.units.push(se.skUnescape(i[t]));e.fields.push(o)}else if(s.startsWith("definition=")){let i=s.substring(t+1).split(",");if(i.length>=2){let t=e.fields.find((t=>t.name==i[0]));if(!t)continue;for(let e=1;e<i.length;e++)t.defnURI.push(se.skUnescape(i[e]))}}}return e}formatMetaData(t){let e=[];for(let s of t.units)e.push("unit="+se.skEscape(s.name)+","+se.skEscape(s.uri));for(let i of t.fields){let t="field="+se.skEscape(i.name);for(let e of i.units)t+=","+se.skEscape(e);if(e.push(t),s.notBlank(i.defnURI)){t="definition="+se.skEscape(i.name);for(let e of i.defnURI)t+=","+se.skEscape(e);e.push(t)}}return e.join("\n")}plainHeading(){return ye.NAME}isColumnReserved(t){return this.areColumnsReserved([t])[0]}areColumnsReserved(t){let e=new Set;for(let t of this.header.fields)e.add(t.name+ye.SUFFIX_VALUE),e.add(t.name+ye.SUFFIX_ERROR),e.add(t.name+ye.SUFFIX_UNITS),e.add(t.name+ye.SUFFIX_MOD);let s=[];for(let i of t)s.push(e.has(i));return s}numTextRenderings(t){return this.header.fields.length}produceTextRendering(t,e){let s=this.header.fields[e],i=this.ds.findColByName(s.name),o={name:s.name,descr:i<0?"":this.ds.colDescr(i),text:"",type:ae.TEXT_PLAIN},n=this.getValue(t,e);return Number.isNaN(n.value)||(n.mod&&(o.text+=n.mod+" "),o.text+=n.value,Number.isNaN(n.error)||(o.text+="  "+n.error),n.units&&(o.text+=" "+n.units)),o}}ye.CODE="org.mmi.aspect.MeasurementData",ye.NAME="Measurement Data",ye.SUFFIX_VALUE="",ye.SUFFIX_ERROR="_error",ye.SUFFIX_UNITS="_units",ye.SUFFIX_MOD="_mod",ue(ye);class Ee{}class Me extends ae{constructor(t,e){super(Me.CODE,t,e),this.fields=[],this.setup()}static isBinaryData(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==Me.CODE)return!0;return!1}getFields(){return gt(this.fields)}setFields(t){this.fields=gt(t);let e=this.formatMetaData(t);for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ye.CODE)return void this.ds.setExtData(t,e);this.ds.appendExtension(ye.NAME,ye.CODE,e)}getValue(t,e){let s=this.getDestValue(t,e);return null!=s?s:this.getSourceValue(t,e)}getSourceValue(t,e){let s=this.ds.findColByName(e.colNameSource);if(s<0||this.ds.isNull(t,s))return null;let i=this.ds.colType(s),o=0;if("boolean"==i)return this.ds.getBoolean(t,s);if("integer"==i)o=this.ds.getInteger(t,s);else{if("real"!=i)return null;o=this.ds.getReal(t,s)}return">"==e.thresholdRelation?o>e.thresholdValue:"<"==e.thresholdRelation?o<e.thresholdValue:">="==e.thresholdRelation?o>=e.thresholdValue:"<="==e.thresholdRelation?o<=e.thresholdValue:null}getDestValue(t,e){return this.ds.getBoolean(t,e.colNameDest)}setup(){this.parseAndCorrect()}parseAndCorrect(){let t=!1;for(let e=0;e<this.ds.numExtensions;e++)if(this.ds.getExtType(e)==ye.CODE){this.fields=this.parseMetaData(this.ds.getExtData(e)),t=!0;break}if(!t&&this.allowModify){let t=this.formatMetaData(this.fields);this.ds.appendExtension(ye.NAME,ye.CODE,t)}}parseMetaData(t){let e=[],s=null;for(let i of t.split(/\r?\n/)){if("field:"==i){null!=s&&e.push(s),s={colNameSource:"",colNameDest:"",thresholdValue:.5,thresholdRelation:">="};continue}if(null==s)continue;let t=i.indexOf("=");t<0||(i.startsWith("colNameSource=")?s.colNameSource=se.skUnescape(i.substring(t+1)):i.startsWith("colNameDest=")?s.colNameDest=se.skUnescape(i.substring(t+1)):i.startsWith("thresholdValue=")?s.thresholdValue=parseFloat(i.substring(t+1)):i.startsWith("thresholdRelation=")&&(s.thresholdRelation=se.skUnescape(i.substring(t+1))))}return null!=s&&e.push(s),e}formatMetaData(t){let e=[];for(let s of t)e.push("field:"),e.push("colNameSource="+se.skEscape(s.colNameSource)),e.push("colNameDest="+se.skEscape(s.colNameDest)),e.push("thresholdValue="+s.thresholdValue),e.push("thresholdRelation="+se.skEscape(s.thresholdRelation));return e.join("\n")}plainHeading(){return Me.NAME}isColumnReserved(t){return!1}}var Te,xe,ve,Ce,Ne,Se,we,Oe,qe,Be,ke,Re,Le,De,Ie;Me.CODE="org.mmi.aspect.BinaryData",Me.NAME="Binary Data",ue(Me),function(t){t.Role="role",t.Pressure="pressure",t.TurnoverNumber="turnover_number",t.EnantiomericExcess="enantiomeric_excess",t.Time="time",t.Heat="heat",t.Light="light"}(Te||(Te={})),function(t){t[t.Experiment=0]="Experiment",t[t.Step=1]="Step",t[t.Reactant=2]="Reactant",t[t.Reagent=3]="Reagent",t[t.Product=4]="Product"}(xe||(xe={})),function(t){t[t.Boolean=0]="Boolean",t[t.Number=1]="Number",t[t.Optional=2]="Optional",t[t.String=3]="String"}(ve||(ve={})),function(t){t.Reagent="reagent",t.Catalyst="catalyst",t.Solvent="solvent"}(Ce||(Ce={}));class Pe{static unpackMeta(t){if(!t)return[];let e=[];for(let s of t.split("\n"))if(s){let t=s.indexOf("="),i=se.skUnescape(t<0?s:s.substring(0,t)),o=t<0?null:se.skUnescape(s.substring(t+1)),n=this.VALUES[i];null==o||n!=ve.Number&&n!=ve.Optional||(o=parseFloat(o)),e.push([i,o])}return e}static packMeta(t){let e=[];for(let[s,i]of t)null==i?e.push(se.skEscape(s)):e.push(se.skEscape(s)+"="+se.skEscape(i.toString()));return e.join("\n")}static withMetaKey(t,e,s){let i=this.unpackMeta(t),o=i.find((t=>t[0]==e));return null!=s?o?o[1]=s:i.push([e,s]):i=i.filter((t=>t[0]!=e)),this.packMeta(i)}static describeMeta(t,e){let s=(t,e)=>{if(null==t)return"";if(0==t)return"0";let s=Math.ceil(-Math.log10(Math.abs(t)));s=Math.max(0,Math.max(s,e));let i=t.toFixed(s);if(i.indexOf(".")<0)return i;for(;i.endsWith("0");)i=i.substring(0,i.length-1);return i.endsWith(".")&&(i=i.substring(0,i.length-1)),i};if(t==Te.Role)return e?`role: ${e}`:null;if(t==Te.Pressure)return null==e?null:`${s(e,2)} atm`;if(t==Te.TurnoverNumber)return null==e?null:`${s(e,2)} turnover${1==e?"":"s"}`;if(t==Te.EnantiomericExcess)return null==e?null:`${s(e,2)}% ee`;if(t==Te.Time){if(null==e)return null;if(e<1){let t=60*e;return`${s(t,2)} min${1==t?"":"s"}`}return`${s(e,2)} hour${1==e?"":"s"}`}return t==Te.Heat?null==e?"":`${s(e,2)} C`:t==Te.Light?null==e?"h":`${s(e,2)} nm`:null}}Pe.APPLICABILITY={[Te.Role]:[xe.Reagent],[Te.Pressure]:[xe.Reactant,xe.Reagent],[Te.TurnoverNumber]:[xe.Reagent],[Te.EnantiomericExcess]:[xe.Product],[Te.Time]:[xe.Step],[Te.Heat]:[xe.Step],[Te.Light]:[xe.Step]},Pe.NAMES={[Te.Role]:"Role",[Te.Pressure]:"Pressure",[Te.TurnoverNumber]:"Turnover Number",[Te.EnantiomericExcess]:"Enantiomeric Excess",[Te.Time]:"Time",[Te.Heat]:"Heat",[Te.Light]:"Light"},Pe.UNITS={[Te.Pressure]:"atm",[Te.TurnoverNumber]:null,[Te.EnantiomericExcess]:"%",[Te.Time]:"hr",[Te.Heat]:"C",[Te.Light]:"nm"},Pe.VALUES={[Te.Role]:ve.String,[Te.Pressure]:ve.Number,[Te.TurnoverNumber]:ve.Number,[Te.EnantiomericExcess]:ve.Number,[Te.Time]:ve.Number,[Te.Heat]:ve.Optional,[Te.Light]:ve.Optional},function(t){t[t.Primary=1]="Primary",t[t.Secondary=2]="Secondary",t[t.Product=3]="Product",t[t.Independent=4]="Independent"}(Ne||(Ne={})),function(t){t[t.Unknown=0]="Unknown",t[t.Actual=1]="Actual",t[t.Virtual=2]="Virtual",t[t.Conflict=3]="Conflict"}(Se||(Se={}));class _e{constructor(t,e,s,i){this.comp=t,this.step=e,this.type=s,this.idx=i,this.role=0,this.molw=0,this.valueEquiv=0,this.statEquiv=0,this.valueMass=ze.UNSPECIFIED,this.statMass=0,this.valueVolume=ze.UNSPECIFIED,this.statVolume=0,this.valueMoles=ze.UNSPECIFIED,this.statMoles=0,this.valueDensity=ze.UNSPECIFIED,this.statDensity=0,this.valueConc=ze.UNSPECIFIED,this.statConc=0,this.valueYield=ze.UNSPECIFIED,this.statYield=0}}class Fe{constructor(){this.step=0,this.idx=0,this.massReact=[],this.massProd=[],this.massWaste=[],this.massProdWaste=[],this.molwReact=[],this.molwProd=[],this.impliedWaste=0,this.isBlank=!1}}class ze{constructor(t){this.entry=t,this.quantities=[],this.primaryMoles=[],this.idxPrimary=[],this.idxYield=[],this.allMassReact=[],this.allMassProd=[],this.allMassWaste=[],this.greenMetrics=[]}static isStoichZero(t){return!this.isStoichUnity(t)&&0==parseFloat(t)}static isStoichUnity(t){if(!t||"1"==t)return!0;let[e,s]=this.extractStoichFraction(t);return 0!=e&&e==s}static extractStoichFraction(t){if(!t)return[1,1];let e=1,s=1,i=t.indexOf("/");if(i<0){let s=parseFloat(t);s>=0&&(e=s)}else{let o=parseFloat(t.substring(0,i)),n=parseFloat(t.substring(i+1));o>=0&&(e=o),n>=0&&(s=n)}return[e,s]}static extractStoichValue(t){let[e,s]=this.extractStoichFraction(t);return s<=1?e:e/s}static stoichAsRatio(t){let[e,s]=this.extractStoichFraction(t);return e==Math.floor(e)?[e,s]:this.stoichFractAsRatio(e)}static stoichFractAsRatio(t){if(t==Math.floor(t))return[t,1];const e=ze.MAX_DENOM;if(null==ze.RATIO_FRACT){ze.RATIO_FRACT=[];for(let t=2;t<=e;t++)for(let s=1;s<t&&s<e-1;s++)ze.RATIO_FRACT.push(1*s/t)}let s=Math.floor(t),i=t-s,o=Number.MAX_VALUE,n=1,l=1;for(let t=0,s=2;s<=e;s++)for(let r=1;r<s&&r<e-1;r++){let e=Math.abs(ze.RATIO_FRACT[t++]-i);e<o&&(o=e,n=r,l=s)}return[n+s*l,l]}static impliedReagentStoich(t,e){if(Ht.isBlank(t.mol)||0==e.length)return 0;let i=s.numberArray(-1,e.length),o=t.mol,n=0;for(let t=1;t<=o.numAtoms;t++){let s=o.atomMapNum(t);if(0==s)continue;let l=0;for(let t=0;t<e.length;t++){let n=e[t].mol;if(Ht.isBlank(n))continue;let r=0;for(let t=1;t<=n.numAtoms;t++)n.atomMapNum(t)==s&&r++;if(r>0){let n=0;for(let t=1;t<=o.numAtoms;t++)o.atomMapNum(t)==s&&n++;i[t]<0&&(i[t]=ze.extractStoichValue(e[t].stoich)),l+=r*i[t]/n}}n=Math.max(n,l)}return n}static componentRatio(t,e){let s=[],i=[],o=0==e?t.steps[0].reactants:t.steps[e-1].products;for(let t of o){let[e,o]=this.stoichAsRatio(t.stoich);s.push(e),i.push(o)}for(let o of t.steps[e].reagents){let n=this.impliedReagentStoich(o,t.steps[e].products),[l,r]=0==n?[0,1]:this.stoichFractAsRatio(n);s.push(0==l?1:l),i.push(r)}for(let o of t.steps[e].products){let[t,e]=this.stoichAsRatio(o.stoich);s.push(0==t?1:t),i.push(e)}let n=1;for(let t=0;t<s.length;t++)i[t]>1&&n%i[t]!=0&&(n*=i[t]);let l=[],r=[],a=[],h=0;for(let t=0;t<o.length;t++,h++)l.push(s[h]*n/i[h]);for(let o=0;o<t.steps[e].reagents.length;o++,h++)r.push(s[h]*n/i[h]);for(let o=0;o<t.steps[e].products.length;o++,h++)a.push(s[h]*n/i[h]);return[l,r,a]}calculate(){for(this.classifyTypes();this.calculateSomething(););this.allMassReact=[],this.allMassProd=[],this.allMassWaste=[];for(let t=0;t<this.quantities.length;t++){let e=this.quantities[t];if(e.type==ke.Reactant||e.type==ke.Reagent){if(0==e.valueEquiv&&e.type==ke.Reagent)continue;this.allMassReact.push(e.valueMass)}else e.type==ke.Product&&(e.comp.waste?this.allMassWaste.push(e.valueMass):(this.allMassProd.push(e.valueMass),this.calculateGreenMetrics(t)))}}get numQuantities(){return this.quantities.length}getQuantity(t){return this.quantities[t]}getAllQuantities(){return this.quantities.slice(0)}get numGreenMetrics(){return this.greenMetrics.length}getGreenMetrics(t){return this.greenMetrics[t]}getAllGreenMetrics(){return this.greenMetrics.slice(0)}getAllMassReact(){return this.allMassReact.slice(0)}getAllMassProd(){return this.allMassProd.slice(0)}getAllMassWaste(){return this.allMassWaste.slice(0)}findComponent(t,e,s){for(let i of this.quantities)if(i.step==t&&i.type==e&&i.idx==s)return i;return null}static formatMolWeight(t){return t==ze.UNSPECIFIED?"":N(t,6)+" g/mol"}static formatMass(t){return t==ze.UNSPECIFIED?"":t<=1e-6?N(1e6*t,6)+" g":t<=.001?N(1e3*t,6)+" mg":t>=1e3?N(.001*t,6)+" kg":N(t,6)+" g"}static formatVolume(t){return t==ze.UNSPECIFIED?"":t<=1e-6?N(1e6*t,6)+" nL":t<=.001?N(1e3*t,6)+" L":t>=1e3?N(.001*t,6)+" L":N(t,6)+" mL"}static formatMoles(t){return t==ze.UNSPECIFIED?"":t<=1e-9?N(1e9*t,6)+" nmol":t<=1e-6?N(1e6*t,6)+" mol":t<=.001?N(1e3*t,6)+" mmol":N(t,6)+" mol"}static formatDensity(t){return t==ze.UNSPECIFIED?"":N(t,6)+" g/mL"}static formatConc(t){return t==ze.UNSPECIFIED?"":t<=1e-9?N(1e9*t,6)+" nmol/L":t<=1e-6?N(1e6*t,6)+" mol/L":t<=.001?N(1e3*t,6)+" mmol/L":N(t,6)+" mol/L"}static formatPercent(t){return t==ze.UNSPECIFIED?"":N(t,6)+"%"}static formatEquiv(t){return t==ze.UNSPECIFIED?"":N(t,4)+" equiv"}classifyTypes(){for(let t=0;t<this.entry.steps.length;t++){let e=this.entry.steps[t];for(let s=0;s<e.reactants.length;s++)this.quantities.push(new _e(e.reactants[s],t,ke.Reactant,s));for(let s=0;s<e.reagents.length;s++)this.quantities.push(new _e(e.reagents[s],t,ke.Reagent,s));for(let s=0;s<e.products.length;s++)this.quantities.push(new _e(e.products[s],t,ke.Product,s))}for(let t=0;t<this.quantities.length;t++){let e=this.quantities[t];if(e.type==ke.Reagent)if(null!=e.comp.equiv)e.valueEquiv=e.comp.equiv;else{let t=ze.impliedReagentStoich(e.comp,this.entry.steps[e.step].products);t>0&&(e.valueEquiv=t)}else e.valueEquiv=ze.extractStoichValue(e.comp.stoich);null!=e.comp.mol&&(e.molw=Ht.molecularWeight(e.comp.mol)),e.role=4,0==e.step&&e.type==ke.Reactant?e.comp.primary?(e.role=1,this.idxPrimary.push(t)):e.role=2:e.type==ke.Reagent||e.type!=ke.Product||e.comp.waste?e.valueEquiv>0&&(e.role=2):(e.role=3,this.idxYield.push(t)),null!=e.comp.mass&&(e.valueMass=e.comp.mass),null!=e.comp.volume&&(e.valueVolume=e.comp.volume),null!=e.comp.moles&&(e.valueMoles=e.comp.moles),null!=e.comp.density&&(e.valueDensity=e.comp.density),null!=e.comp.conc&&(e.valueConc=e.comp.conc),null!=e.comp.yield&&(e.valueYield=e.comp.yield),e.statEquiv=e.valueEquiv==ze.UNSPECIFIED?0:1,e.statMass=e.valueMass==ze.UNSPECIFIED?0:1,e.statVolume=e.valueVolume==ze.UNSPECIFIED?0:1,e.statMoles=e.valueMoles==ze.UNSPECIFIED?0:1,e.statDensity=e.valueDensity==ze.UNSPECIFIED?0:1,e.statConc=e.valueConc==ze.UNSPECIFIED?0:1,e.statYield=e.valueYield==ze.UNSPECIFIED?0:1}if(0==this.idxPrimary.length)for(let t=0;t<this.quantities.length;t++){let e=this.quantities[t];e.type==ke.Reactant&&0==e.step&&(e.role=1,this.idxPrimary.push(t))}}calculateSomething(){let t=!1;for(let e of this.quantities){if(e.molw>0&&e.valueMass==ze.UNSPECIFIED&&1==e.statMoles&&(e.valueMass=e.valueMoles*e.molw,e.statMass=2,t=!0),e.molw>0&&e.valueMass!=ze.UNSPECIFIED&&e.valueMoles==ze.UNSPECIFIED&&(e.valueMoles=e.valueMass/e.molw,e.statMoles=2,t=!0),e.molw>0&&1==e.statMass&&1==e.statMoles){let t=e.valueMass/e.molw;this.closeEnough(e.valueMoles,t)||(e.statMass=3,e.statMoles=3)}let s=1==e.statConc||1==e.statVolume&&(1==e.statMass||1==e.statMoles);if(s||(e.valueDensity>0&&e.valueMass==ze.UNSPECIFIED&&e.valueVolume!=ze.UNSPECIFIED&&(e.valueMass=e.valueVolume*e.valueDensity,e.statMass=2,t=!0),e.valueDensity>0&&e.valueMass!=ze.UNSPECIFIED&&e.valueVolume==ze.UNSPECIFIED&&(e.valueVolume=e.valueMass/e.valueDensity,e.statVolume=2,t=!0),e.valueDensity==ze.UNSPECIFIED&&e.valueMass!=ze.UNSPECIFIED&&e.valueVolume!=ze.UNSPECIFIED&&e.valueConc==ze.UNSPECIFIED&&(1!=e.statMass&&1!=e.statMoles||(e.valueDensity=e.valueMass/e.valueVolume,e.statDensity=2,t=!0))),s&&(e.valueConc>0&&e.valueMoles==ze.UNSPECIFIED&&e.valueVolume!=ze.UNSPECIFIED&&(e.valueMoles=.001*e.valueVolume*e.valueConc,e.statMoles=2,t=!0),e.valueConc>0&&e.valueMoles!=ze.UNSPECIFIED&&e.valueVolume==ze.UNSPECIFIED&&(e.valueVolume=1e3*e.valueMoles/e.valueConc,e.statVolume=2,t=!0),e.valueConc==ze.UNSPECIFIED&&e.valueMass!=ze.UNSPECIFIED&&e.valueVolume!=ze.UNSPECIFIED&&(e.valueConc=1e3*e.valueMoles/e.valueVolume,e.statConc=2,t=!0),1==e.statConc&&e.valueMoles>0&&1==e.statVolume)){let t=1e3*e.valueMoles/e.valueConc;this.closeEnough(e.valueVolume,t)||(e.statConc=3,1==e.statMass&&(e.statMass=3),1==e.statMoles&&(e.statMoles=3),e.statVolume=3)}e.molw>0&&e.valueMass==ze.UNSPECIFIED&&e.valueMoles!=ze.UNSPECIFIED&&(e.valueMass=e.valueMoles*e.molw,e.statMass=2,t=!0),1==e.statDensity&&1==e.statConc&&(e.statDensity=3,e.statConc=3)}if(t)return!0;let e=!1,i=this.entry.steps.length,o=s.numberArray(0,i),n=s.numberArray(0,i),l=this.primaryMoles=s.numberArray(0,i);for(let t of this.quantities){let e=-1;if(0==t.step&&t.type==ke.Reactant&&t.comp.primary)e=t.step;else{if(!(t.step<i-1&&t.type==ke.Product)||t.comp.waste)continue;e=t.step+1}n[e]<0||(1!=t.statMoles?(o[e]++,n[e]+=t.valueEquiv,l[e]+=t.valueMoles):n[e]=-1)}if(n[0]<=0){o[0]=0,n[0]=0,l[0]=0;for(let t of this.idxPrimary){let e=this.quantities[t];if(0==e.statMoles){o[0]=0,n[0]=-1,l[0]=0;break}o[0]++,n[0]+=e.valueEquiv,l[0]+=e.valueMoles}}let r=s.numberArray(0,i);for(let t=0;t<i;t++)r[t]=0==o[t]||n[t]<=0?0:l[t]/n[t],r[t]>0&&(e=!0);if(!e)for(let t=0;t<i;t++){let i=[];for(let e of this.quantities){if(e.step!=t||3!=e.role)continue;if(0==e.statMoles||e.valueMoles<=0||e.valueEquiv<=0)continue;let s=e.valueYield>0?.01*e.valueYield:1;i.push(e.valueMoles/(e.valueEquiv*s))}i.length>0&&(r[t]=s.sum(i)/i.length,e=!0)}if(!e)return!1;for(let e of this.quantities)if(e.type==ke.Product&&0!=r[e.step]&&(e.valueYield==ze.UNSPECIFIED&&e.valueMoles!=ze.UNSPECIFIED&&(e.valueYield=100*e.valueMoles/(r[e.step]*e.valueEquiv),e.statYield=2,t=!0),e.valueYield!=ze.UNSPECIFIED&&e.valueMoles==ze.UNSPECIFIED&&(e.valueMoles=.01*e.valueYield*(r[e.step]*e.valueEquiv),e.statMoles=2,t=!0),e.valueMoles>0&&1==e.statYield)){let t=100*e.valueMoles/(r[e.step]*e.valueEquiv);this.closeEnough(e.valueYield,t)||(1==e.statMass&&(e.statMass=3),1==e.statMoles&&(e.statMoles=3),e.statYield=3)}if(t)return!0;for(let e of this.quantities)0!=r[e.step]&&(e.valueMass==ze.UNSPECIFIED&&e.valueMoles==ze.UNSPECIFIED&&e.valueEquiv>0&&(e.valueMoles=r[e.step]*e.valueEquiv,e.statMoles=2,t=!0),e.valueMoles!=ze.UNSPECIFIED&&e.valueEquiv==ze.UNSPECIFIED&&(e.valueEquiv=e.valueMoles/r[e.step],e.statEquiv=2,t=!0));return t}calculateGreenMetrics(t){let e=this.quantities[t],i=new Fe;i.step=e.step,i.idx=e.idx,i.isBlank=!0;for(let t=0;t<this.quantities.length;t++){let e=this.quantities[t];if(e.step>i.step)continue;let s=e.valueEquiv;0==s&&e.type==ke.Reagent||(e.valueMass!=ze.UNSPECIFIED&&(i.isBlank=!1),e.type==ke.Reactant||e.type==ke.Reagent?(i.massReact.push(e.valueMass),e.step==i.step&&s>0&&e.molw>0&&i.molwReact.push(s*e.molw)):e.type==ke.Product&&(e.comp.waste?i.massWaste.push(e.valueMass):(e.step==i.step&&i.massProd.push(e.valueMass),s>0&&e.molw>0&&(e.step==i.step?i.molwProd.push(s*e.molw):e.step==i.step-1&&i.molwReact.push(s*e.molw))),e.step==i.step&&i.massProdWaste.push(e.valueMass)))}i.impliedWaste=s.sum(i.massReact)-s.sum(i.massProdWaste),Math.abs(i.impliedWaste)>.001&&(i.impliedWaste=0),this.greenMetrics.push(i)}closeEnough(t,e){if(t<=0||e<=0)return!0;let s=t/e;return s>=.99&&s<=1.01}}ze.UNSPECIFIED=-1,ze.MAX_DENOM=16,ze.RATIO_FRACT=null;class Ue{constructor(){this.UNITS_PER_EM=2048,this.INV_UNITS_PER_EM=1/this.UNITS_PER_EM,this.PANOSE_1="2 11 6 4 3 5 4 4 2 4",this.ASCENT=1638,this.DESCENT=-410,this.MISSING_HORZ=2048,this.MISSING_DATA="M256 0v1536h1536v-1536h-1536zM384 128h1280v1280h-1280v-1280z",this.ASCENT_FUDGE=.9,this.UNICODE=[" ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],this.HORIZ_ADV_X=[720,806,940,1676,1302,2204,1488,550,930,930,1302,1676,745,930,745,930,1302,1302,1302,1302,1302,1302,1302,1302,1302,1302,930,930,1676,1676,1676,1117,2048,1400,1404,1430,1578,1295,1177,1588,1539,862,931,1419,1140,1726,1532,1612,1235,1612,1424,1400,1262,1499,1400,2025,1403,1260,1403,930,930,930,1676,1302,1302,1230,1276,1067,1276,1220,720,1276,1296,562,705,1212,562,1992,1296,1243,1276,1276,874,1067,807,1296,1212,1676,1212,1212,1076,1300,930,1300,1676,720,806,1302,1302,1302,1302,930,1302,1302,2048,1117,1320,1676,930,2048,1302,1110,1676,1110,1110,1302,1314,1302,745,1302,1110,1117,1320,2048,2048,2048,1117,1400,1400,1400,1400,1400,1400,2016,1430,1295,1295,1295,1295,862,862,862,862,1588,1532,1612,1612,1612,1612,1612,1676,1612,1499,1499,1499,1499,1260,1240,1270,1230,1230,1230,1230,1230,1230,1956,1067,1220,1220,1220,1220,562,562,562,562,1253,1296,1243,1243,1243,1243,1243,1676,1243,1296,1296,1296,1296,1212,1276,930,1302,1302,1400,930,1538,1782,1105,1804,1543,1859,562,1400,1404,1160,1440,1295,1403,1539,1612,862,1419,1404,1726,1532,1329,1612,1539,1235,1377,1262,1260,1677,1403,1783,1676,862,1260,1276,1050,1296,562,1293,1276,1270,1212,1245,1050,937,1296,1278,562,1212,1212,1310,1212,1030,1243,1305,1280,1040,1291,1016,1293,1618,1208,1683,1666,562,1293,1243,1293,1666,1302,1489,1676,1489,1676,740,745,1676,2048,1302,1676,1676,1676,1676],this.GLYPH_DATA=["","M515 1489l-26 -1079h-170l-28 1079h224zM505 0h-204v211h204v-211z","M772 1556l-43 -579h-132l-43 579h218zM386 1556l-43 -579h-132l-43 579h218z","M1481 932h-333l-92 -376h308v-135h-343l-104 -421h-129l104 421h-270l-104 -421h-129l104 421h-298v135h333l92 376h-308v135h343l105 422h129l-105 -422h270l105 422h129l-105 -422h298v-135zM1022 934h-274l-94 -380h274z","M1160 380q0 -155 -121 -257.5t-317 -121.5v-362h-118v357q-132 1 -248 25.5t-201 63.5v198h16q19 -14 68 -40.5t95 -43.5q52 -19 121.5 -35.5t148.5 -19.5v433q-40 8 -74 15.5t-63 15.5q-163 41 -234 123.5t-71 203.5q0 148 116.5 250t325.5 119v272h118v-270 q101 -2 207 -24t178 -51v-196h-14q-75 46 -156.5 81.5t-214.5 44.5v-431q30 -5 65 -13.5t61 -13.5q149 -32 230.5 -110t81.5 -213zM604 747v413q-107 -8 -180 -58.5t-73 -140.5q0 -91 54 -137t199 -77zM971 354q0 94 -58.5 137.5t-190.5 68.5v-414q120 12 184.5 61t64.5 147 z","M884 1076q0 -224 -94.5 -333t-272.5 -109q-182 0 -275 109t-93 332q0 224 95 333t273 109q181 0 274 -110t93 -331zM1575 1489l-780 -1489h-165l780 1489h165zM2055 413q0 -224 -95 -333t-273 -109q-181 0 -274 110t-93 331q0 224 94.5 333t272.5 109q182 0 275 -109 t93 -332zM706 1076q0 172 -44.5 240t-144.5 68q-102 0 -146 -68t-44 -241t44 -240.5t146 -67.5q100 0 144.5 67.5t44.5 241.5zM1877 413q0 172 -44.5 240t-144.5 68q-102 0 -146 -68t-44 -241t44 -240.5t146 -67.5q100 0 144.5 67.5t44.5 241.5z","M792 1191q0 95 -56.5 149.5t-144.5 54.5q-92 0 -150 -61.5t-58 -150.5q0 -75 39.5 -133t170.5 -137q98 35 148.5 102.5t50.5 175.5zM986 315l-478 466q-31 -15 -62 -39.5t-62 -66.5q-28 -39 -46 -94t-18 -124q0 -146 85.5 -235.5t242.5 -89.5q93 0 184.5 45.5 t153.5 137.5zM1287 909v-96q0 -96 -25 -216t-85 -229l378 -368h-246l-229 224q-115 -142 -235 -198.5t-247 -56.5q-208 0 -345.5 121.5t-137.5 318.5q0 92 26 159t61 116q35 47 87 88.5t105 72.5q-110 72 -158.5 145t-48.5 184q0 67 26.5 127.5t79.5 110.5q50 48 130.5 78 t177.5 30q173 0 280 -87.5t107 -221.5q0 -44 -12 -99.5t-41 -99.5q-32 -49 -91 -94t-153 -77l371 -362q14 40 21 88t8 100q2 56 1.5 125t-0.5 117h195z","M386 1556l-43 -579h-136l-43 579h222z","M783 -412h-229q-177 203 -275 443t-98 541t98 541t275 443h229v-10q-81 -73 -154.5 -168.5t-136.5 -222.5q-60 -123 -97.5 -271t-37.5 -312q0 -171 36.5 -313t98.5 -270q60 -123 137 -222.5t154 -168.5v-10z","M749 572q0 -301 -98 -541t-275 -443h-229v10q77 69 154.5 168.5t136.5 222.5q62 128 98.5 270t36.5 313q0 164 -37 312t-98 271q-63 127 -136.5 222.5t-154.5 168.5v10h229q177 -203 275 -443t98 -541z","M1137 887l-64 -110l-362 213l6 -360h-129l5 360l-361 -214l-65 110l381 207l-381 207l65 110l362 -213l-6 359h129l-7 -359l363 212l64 -110l-380 -205z","M1466 572h-545v-545h-166v545h-545v160h545v545h166v-545h545v-160z","M575 285l-282 -655h-146l174 655h254z","M777 561h-624v181h624v-181z","M492 0h-239v285h239v-285z","M860 1556l-717 -1860h-173l714 1860h176z","M1167 745q0 -401 -125.5 -588.5t-389.5 -187.5q-268 0 -391.5 190t-123.5 584q0 397 125 586.5t390 189.5q268 0 391.5 -192.5t123.5 -581.5zM904 291q35 81 47.5 190.5t12.5 263.5q0 152 -12.5 264t-48.5 190q-35 77 -95.5 116t-155.5 39q-94 0 -155.5 -39t-97.5 -118 q-34 -74 -46.5 -193t-12.5 -261q0 -156 11 -261t47 -188q33 -78 93.5 -119t160.5 -41q94 0 156 39t96 118z","M1084 0h-806v152h310v998h-310v136q63 0 135 10.5t109 30.5q46 25 72.5 63.5t30.5 103.5h155v-1342h304v-152z","M1169 0h-1008v209q105 90 210.5 180t196.5 179q192 186 263 295.5t71 236.5q0 116 -76.5 181.5t-213.5 65.5q-91 0 -197 -32t-207 -98h-10v210q71 35 189.5 64t229.5 29q229 0 359 -110.5t130 -299.5q0 -85 -21.5 -158.5t-63.5 -139.5q-39 -62 -91.5 -122t-127.5 -133 q-107 -105 -221 -203.5t-213 -182.5h801v-171z","M1038 717q48 -43 79 -108t31 -168q0 -102 -37 -187t-104 -148q-75 -70 -176.5 -103.5t-222.5 -33.5q-124 0 -244 29.5t-197 64.5v209h15q85 -56 200 -93t222 -37q63 0 134 21t115 62q46 44 68.5 97t22.5 134q0 80 -25.5 132.5t-70.5 82.5q-45 31 -109 42.5t-138 11.5h-90 v166h70q152 0 242.5 63.5t90.5 185.5q0 54 -23 94.5t-64 66.5q-43 26 -92 36t-111 10q-95 0 -202 -34t-202 -96h-10v209q71 35 189.5 64.5t229.5 29.5q109 0 192 -20t150 -64q72 -48 109 -116t37 -159q0 -124 -87.5 -216.5t-206.5 -116.5v-14q48 -8 110 -33.5t105 -63.5z ","M1203 419h-221v-419h-192v419h-713v230l721 840h184v-910h221v-160zM790 579v672l-577 -672h577z","M1157 473q0 -104 -38 -199t-104 -160q-72 -70 -171.5 -107.5t-230.5 -37.5q-122 0 -235 25.5t-191 61.5v211h14q82 -52 192 -88.5t216 -36.5q71 0 137.5 20t118.5 70q44 43 66.5 103t22.5 139q0 77 -26.5 130t-73.5 85q-52 38 -126.5 53.5t-166.5 15.5q-88 0 -169.5 -12 t-140.5 -24v767h896v-175h-703v-396q43 4 88 6t78 2q121 0 212 -20.5t167 -72.5q80 -55 124 -142t44 -218z","M1191 483q0 -227 -149.5 -370.5t-366.5 -143.5q-110 0 -200 34t-159 101q-86 83 -132.5 220t-46.5 330q0 198 42.5 351t135.5 272q88 113 227 176.5t324 63.5q59 0 99 -5t81 -18v-191h-10q-28 15 -84.5 28.5t-115.5 13.5q-215 0 -343 -134.5t-149 -363.5 q84 51 165.5 77.5t188.5 26.5q95 0 167.5 -17.5t148.5 -70.5q88 -61 132.5 -154t44.5 -226zM988 475q0 93 -27.5 154t-90.5 106q-46 32 -102 42t-117 10q-85 0 -158 -20t-150 -62q-2 -22 -3 -42.5t-1 -51.5q0 -158 32.5 -249.5t89.5 -144.5q46 -44 99.5 -64.5t116.5 -20.5 q145 0 228 88.5t83 254.5z","M1173 1266l-674 -1266h-214l717 1314h-848v175h1019v-223z","M1180 415q0 -193 -150.5 -321t-378.5 -128q-242 0 -385.5 125t-143.5 320q0 124 72 224.5t203 159.5v6q-120 64 -177.5 140t-57.5 190q0 168 138 280t351 112q223 0 356 -107t133 -272q0 -101 -63 -198.5t-185 -152.5v-6q140 -60 214 -148t74 -224zM943 1142 q0 107 -82.5 170.5t-210.5 63.5q-126 0 -206.5 -60t-80.5 -162q0 -72 40.5 -124.5t122.5 -93.5q37 -18 106.5 -47t135.5 -48q99 66 137 137t38 164zM974 396q0 92 -40.5 147.5t-158.5 111.5q-47 22 -103 41t-149 53q-90 -49 -144.5 -133t-54.5 -190q0 -135 93 -223t236 -88 q146 0 233.5 75t87.5 206z","M1167 834q0 -195 -44.5 -354t-134.5 -271q-91 -114 -228 -176t-322 -62q-52 0 -98 5.5t-82 17.5v191h10q29 -15 82 -28.5t118 -13.5q221 0 346.5 132.5t145.5 365.5q-93 -56 -175 -80t-179 -24q-92 0 -166.5 18t-149.5 70q-88 61 -132.5 155t-44.5 225q0 228 150 371 t366 143q108 0 200 -33.5t161 -100.5q85 -83 131 -213.5t46 -337.5zM965 877q0 155 -32 249t-88 146q-47 45 -101 64.5t-117 19.5q-144 0 -227.5 -90t-83.5 -253q0 -95 27 -155t91 -105q45 -31 99 -41.5t120 -10.5q78 0 158 21t150 61q1 21 2.5 41.5t1.5 52.5z","M585 832h-239v285h239v-285zM585 0h-239v285h239v-285z","M585 832h-239v285h239v-285zM658 285l-282 -655h-146l174 655h254z","M1408 77l-1154 513v124l1154 513v-180l-910 -395l910 -395v-180z","M1431 782h-1186v160h1186v-160zM1431 362h-1186v160h1186v-160z","M1422 590l-1154 -513v180l910 395l-910 395v180l1154 -513v-124z","M1005 1139q0 -98 -35 -174.5t-92 -135.5q-56 -57 -129 -107t-155 -97v-225h-179v305q65 37 140.5 81t123.5 89q58 52 90 107.5t32 141.5q0 113 -76.5 168.5t-197.5 55.5q-108 0 -204.5 -34t-152.5 -69h-10v204q70 27 177.5 48.5t203.5 21.5q215 0 339.5 -104.5 t124.5 -275.5zM610 0h-204v211h204v-211z","M1870 663q0 -139 -40.5 -269t-115.5 -237h-440l-27 116q-74 -60 -142 -92t-156 -32q-168 0 -268.5 127t-100.5 355q0 227 123 362t294 135q73 0 129 -16.5t121 -49.5v48h159v-842h243q42 75 63.5 187.5t21.5 201.5q0 164 -45.5 298t-133.5 230t-218 147.5t-295 51.5 q-160 0 -292.5 -58t-227.5 -156q-96 -98 -150.5 -234.5t-54.5 -290.5q0 -165 52 -301.5t147 -233.5q99 -101 232 -152.5t290 -51.5q86 0 177.5 11t175.5 35v-142q-97 -21 -181 -28.5t-173 -7.5q-186 0 -345 63.5t-273 177.5q-115 115 -179 276t-64 356q0 185 67 344.5 t183 276.5t275 184t340 67q196 0 350 -62t260 -174t162.5 -269.5t56.5 -350.5zM1245 408v518q-63 29 -113 41.5t-107 12.5q-129 0 -202 -90t-73 -256q0 -163 58 -246.5t181 -83.5q67 0 134 31t122 73z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523z","M1323 458q0 -111 -42 -196t-113 -140q-84 -66 -184.5 -94t-255.5 -28h-528v1489h441q163 0 244 -12t155 -50q82 -43 119 -110.5t37 -161.5q0 -106 -54 -180.5t-144 -119.5v-8q151 -31 238 -132.5t87 -256.5zM990 1129q0 54 -18 91t-58 60q-47 27 -114 33.5t-166 6.5h-236 v-430h256q93 0 148 9.5t102 39.5t66.5 77.5t19.5 112.5zM1117 450q0 90 -27 143t-98 90q-48 25 -116.5 32.5t-166.5 7.5h-311v-554h262q130 0 213 13.5t136 49.5q56 39 82 89t26 129z","M1350 108q-55 -24 -99.5 -45t-116.5 -44q-61 -19 -132.5 -32.5t-157.5 -13.5q-162 0 -294.5 45.5t-230.5 142.5q-96 95 -150 241.5t-54 340.5q0 184 52 329t150 245q95 97 229.5 148t298.5 51q120 0 239.5 -29t265.5 -102v-235h-15q-123 103 -244 150t-259 47 q-113 0 -203.5 -36.5t-161.5 -113.5q-69 -75 -107.5 -189.5t-38.5 -264.5q0 -157 42.5 -270t109.5 -184q70 -74 163.5 -109.5t197.5 -35.5q143 0 268 49t234 147h14v-232z","M1458 743q0 -203 -88.5 -368t-235.5 -256q-102 -63 -227.5 -91t-330.5 -28h-376v1489h372q218 0 346.5 -31.5t217.5 -86.5q152 -95 237 -253t85 -375zM1251 746q0 175 -61 295t-182 189q-88 50 -187 69.5t-237 19.5h-186v-1149h186q143 0 249.5 21t195.5 78 q111 71 166.5 187t55.5 290z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176z","M1151 1313h-753v-420h647v-176h-647v-717h-198v1489h951v-176z","M1442 110q-122 -56 -266.5 -97.5t-279.5 -41.5q-174 0 -319 48t-247 144q-103 97 -159 242.5t-56 340.5q0 357 208.5 563.5t572.5 206.5q127 0 259.5 -30.5t285.5 -103.5v-235h-18q-31 24 -90 63t-116 65q-69 31 -156.5 51.5t-198.5 20.5q-250 0 -395.5 -160.5 t-145.5 -434.5q0 -289 152 -449.5t414 -160.5q96 0 191.5 19t167.5 49v365h-399v174h595v-639z","M1339 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152z","M746 387q0 -196 -119.5 -302t-320.5 -106q-48 0 -128 8.5t-134 20.5v185h11q41 -14 101 -29t123 -15q92 0 146.5 21t80.5 60q27 40 34.5 98t7.5 134v869h-315v158h513v-1102z","M1397 0h-257l-589 663l-148 -158v-505h-198v1489h198v-777l723 777h240l-665 -700z","M1142 0h-942v1489h198v-1313h744v-176z","M1526 0h-198v1283l-414 -873h-118l-411 873v-1283h-185v1489h270l397 -829l384 829h275v-1489z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1174 1039q0 -99 -34.5 -183.5t-96.5 -146.5q-77 -77 -182 -115.5t-265 -38.5h-198v-555h-198v1489h404q134 0 227 -22.5t165 -70.5q85 -57 131.5 -142t46.5 -215zM968 1034q0 77 -27 134t-82 93q-48 31 -109.5 44.5t-155.5 13.5h-196v-595h167q120 0 195 21.5t122 68.5 q47 48 66.5 101t19.5 119z","M1528 -365q-60 -15 -118.5 -21.5t-119.5 -6.5q-174 0 -279.5 95.5t-114.5 273.5q-24 -4 -46.5 -5.5t-43.5 -1.5q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5 q91 -100 139.5 -245t48.5 -329q0 -273 -111.5 -460t-299.5 -262q4 -114 54 -177t182 -63q41 0 97.5 12.5t80.5 22.5h27v-182zM1292 744q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1432 0h-257l-498 592h-279v-592h-198v1489h417q135 0 225 -17.5t162 -62.5q81 -51 126.5 -128.5t45.5 -196.5q0 -161 -81 -269.5t-223 -163.5zM969 1070q0 64 -22.5 113.5t-74.5 83.5q-43 29 -102 40.5t-139 11.5h-233v-562h200q94 0 164 16.5t119 61.5q45 42 66.5 96.5 t21.5 138.5z","M1282 425q0 -87 -40.5 -172t-113.5 -144q-80 -64 -186.5 -100t-256.5 -36q-161 0 -289.5 30t-261.5 89v248h14q113 -94 261 -145t278 -51q184 0 286.5 69t102.5 184q0 99 -48.5 146t-147.5 73q-75 20 -162.5 33t-185.5 33q-198 42 -293.5 143.5t-95.5 264.5 q0 187 158 306.5t401 119.5q157 0 288 -30t232 -74v-234h-14q-85 72 -223.5 119.5t-283.5 47.5q-159 0 -255.5 -66t-96.5 -170q0 -93 48 -146t169 -81q64 -14 182 -34t200 -41q166 -44 250 -133t84 -249z","M1262 1313h-532v-1313h-198v1313h-532v176h1262v-176z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891z","M1374 1489l-542 -1489h-264l-542 1489h212l467 -1310l467 1310h202z","M1933 1489l-387 -1489h-223l-313 1236l-306 -1236h-218l-394 1489h203l313 -1238l308 1238h201l311 -1250l311 1250h194z","M1336 1489l-514 -736l513 -753h-229l-406 613l-416 -613h-216l519 744l-507 745h228l401 -605l410 605h217z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211z","M1288 0h-1162v184l913 1129h-879v176h1106v-179l-922 -1134h944v-176z","M759 -392h-520v1948h520v-143h-346v-1662h346v-143z","M960 -304h-173l-717 1860h176z","M691 -392h-520v143h346v1662h-346v143h520v-1948z","M1490 684h-198l-455 627l-454 -629h-197l589 807h126z","M1306 -300h-1310v120h1310v-120z","M762 1302h-149l-273 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5z","M1168 567q0 -140 -39.5 -252t-106.5 -188q-71 -79 -156 -118.5t-187 -39.5q-95 0 -166 22.5t-140 60.5l-12 -52h-176v1556h188v-556q79 65 168 106.5t200 41.5q198 0 312.5 -152t114.5 -429zM974 562q0 200 -66 303.5t-213 103.5q-82 0 -166 -35.5t-156 -91.5v-640 q80 -36 137.5 -50t130.5 -14q156 0 244.5 102.5t88.5 321.5z","M1011 70q-94 -45 -178.5 -70t-179.5 -25q-121 0 -222 35.5t-173 107.5q-73 72 -113 182t-40 257q0 274 150.5 430t397.5 156q96 0 188.5 -27t169.5 -66v-209h-10q-86 67 -177.5 103t-178.5 36q-160 0 -252.5 -107.5t-92.5 -315.5q0 -202 90.5 -310.5t254.5 -108.5 q57 0 116 15t106 39q41 21 77 44.5t57 40.5h10v-207z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -18.5t143 -57.5v484h188v-1556zM903 275v641q-76 34 -136 47t-131 13q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640z","M786 1374h-10q-31 9 -81 18.5t-88 9.5q-121 0 -175.5 -53.5t-54.5 -193.5v-38h339v-158h-333v-959h-188v959h-127v158h127v37q0 199 99 305.5t286 106.5q63 0 113.5 -6t92.5 -14v-172z","M1091 127q0 -284 -129 -417t-397 -133q-89 0 -173.5 12.5t-166.5 35.5v192h10q46 -18 146 -44.5t200 -26.5q96 0 159 23t98 64q35 39 50 94t15 123v102q-85 -68 -162.5 -101.5t-197.5 -33.5q-200 0 -317.5 144.5t-117.5 407.5q0 144 40.5 248.5t110.5 180.5 q65 71 158 110.5t185 39.5q97 0 162.5 -19.5t138.5 -59.5l12 48h176v-990zM903 307v609q-75 34 -139.5 48.5t-128.5 14.5q-155 0 -244 -104t-89 -302q0 -188 66 -285t219 -97q82 0 164.5 31.5t151.5 84.5z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1556h188v-563q88 73 182 114t193 41q181 0 276 -109t95 -314v-725z","M387 1304h-212v195h212v-195zM375 0h-188v1117h188v-1117z","M533 1304h-212v195h212v-195zM521 -27q0 -196 -100 -296t-268 -100q-40 0 -105.5 8t-109.5 20v179h10q28 -11 75.5 -25t92.5 -14q72 0 116 20t66 60t28.5 96.5t6.5 137.5v900h-233v158h421v-1144z","M1199 0h-248l-448 489l-122 -116v-373h-188v1556h188v-998l543 559h237l-519 -516z","M375 0h-188v1556h188v-1556z","M1815 0h-188v636q0 72 -6.5 139t-27.5 107q-23 43 -66 65t-124 22q-79 0 -158 -39.5t-158 -100.5q3 -23 5 -53.5t2 -60.5v-715h-188v636q0 74 -6.5 140.5t-27.5 106.5q-23 43 -66 64.5t-124 21.5q-77 0 -154.5 -38t-154.5 -97v-834h-188v1117h188v-124q88 73 175.5 114 t186.5 41q114 0 193.5 -48t118.5 -133q114 96 208 138.5t201 42.5q184 0 271.5 -111.5t87.5 -311.5v-725z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-725z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z","M1168 572q0 -136 -39 -248.5t-110 -190.5q-66 -74 -155.5 -114.5t-189.5 -40.5q-87 0 -157.5 19t-143.5 59v-468h-188v1529h188v-117q75 63 168.5 105.5t199.5 42.5q202 0 314.5 -152.5t112.5 -423.5zM974 567q0 202 -69 302t-212 100q-81 0 -163 -35t-157 -92v-633 q80 -36 137.5 -49t130.5 -13q157 0 245 106t88 314z","M1091 -412h-188v538q-87 -75 -173 -111.5t-186 -36.5q-199 0 -317.5 153.5t-118.5 423.5q0 144 41.5 254.5t109.5 185.5q66 73 155 113t188 40q90 0 159.5 -20t141.5 -59l12 48h176v-1529zM903 284v632q-78 35 -138 49t-130 14q-163 0 -248 -110.5t-85 -304.5 q0 -196 68.5 -301.5t215.5 -105.5q82 0 164 35.5t153 91.5z","M882 912h-10q-42 10 -81.5 14.5t-93.5 4.5q-87 0 -168 -38.5t-156 -99.5v-793h-188v1117h188v-165q112 90 197.5 127.5t174.5 37.5q49 0 71 -2.5t66 -9.5v-193z","M983 322q0 -153 -126.5 -251t-345.5 -98q-124 0 -227.5 29.5t-173.5 64.5v211h10q89 -67 198 -106.5t209 -39.5q124 0 194 40t70 126q0 66 -38 100t-146 58q-40 9 -104.5 21t-117.5 26q-147 39 -208.5 114.5t-61.5 185.5q0 69 28.5 130t86.5 109q56 47 142.5 74.5 t193.5 27.5q100 0 202.5 -24.5t170.5 -59.5v-201h-10q-72 53 -175 89.5t-202 36.5q-103 0 -174 -39.5t-71 -117.5q0 -69 43 -104q42 -35 136 -57q52 -12 116.5 -24t107.5 -22q131 -30 202 -103q71 -74 71 -196z","M765 10q-53 -14 -115.5 -23t-111.5 -9q-171 0 -260 92t-89 295v594h-127v158h127v321h188v-321h388v-158h-388v-509q0 -88 4 -137.5t28 -92.5q22 -40 60.5 -58.5t117.5 -18.5q46 0 96 13.5t72 22.5h10v-169z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117z","M1151 1117l-452 -1117h-189l-449 1117h204l346 -889l343 889h197z","M1590 1117l-291 -1117h-174l-287 861l-285 -861h-173l-294 1117h196l205 -865l279 865h155l286 -865l194 865h189z","M1152 0h-237l-317 429l-319 -429h-219l436 557l-432 560h237l315 -422l316 422h220l-439 -550z","M1151 1117l-652 -1529h-201l208 466l-445 1063h204l343 -828l346 828h197z","M995 0h-902v139l651 821h-637v157h871v-134l-654 -824h671v-159z","M1113 -392h-150q-179 0 -290.5 99.5t-111.5 287.5v149q0 169 -83 264.5t-254 95.5h-51v156h51q171 0 254 95.5t83 264.5v149q0 188 111.5 287.5t290.5 99.5h150v-138h-114q-136 0 -197.5 -63t-61.5 -203v-175q0 -139 -77 -233.5t-214 -149.5v-24q137 -55 214 -149.5 t77 -233.5v-175q0 -140 61.5 -203t197.5 -63h114v-138z","M552 -392h-174v1948h174v-1948z","M1127 504h-51q-171 0 -254 -95.5t-83 -264.5v-149q0 -188 -111.5 -287.5t-290.5 -99.5h-150v138h114q136 0 197.5 63t61.5 203v175q0 139 77 233.5t214 149.5v24q-137 55 -214 149.5t-77 233.5v175q0 140 -61.5 203t-197.5 63h-114v138h150q179 0 290.5 -99.5 t111.5 -287.5v-149q0 -169 83 -264.5t254 -95.5h51v-156z","M1489 927q-2 -99 -22.5 -195t-65.5 -171q-46 -77 -111 -121t-165 -44q-94 0 -167 39.5t-157 141.5q-102 125 -148 157t-96 32q-94 0 -144 -87.5t-59 -283.5h-167q2 100 22.5 194.5t64.5 171.5q43 74 112 119.5t165 45.5q93 0 166.5 -38.5t158.5 -142.5q80 -98 131 -143.5 t112 -45.5q103 0 151.5 101t51.5 270h167z","","M505 1278h-204v211h204v-211zM515 0h-224l26 1079h170z","M1120 74q-71 -30 -161 -53.5t-194 -26.5v-355h-118v359q-227 21 -357.5 165t-130.5 394q0 242 133.5 391.5t354.5 171.5v355h118v-351q104 -3 197 -25t158 -53v-203h-11q-55 44 -142 85t-202 50v-839q120 10 206.5 52.5t137.5 83.5h11v-201zM647 142v834 q-135 -20 -216 -125t-81 -294q0 -181 76 -286t221 -129z","M1163 0h-1026v207q118 32 169.5 126.5t51.5 279.5h-176v138h176v310q0 200 126.5 328.5t331.5 128.5q105 0 181 -17t140 -34v-206h-10q-62 42 -138 66t-162 24q-140 0 -209.5 -82.5t-69.5 -226.5v-291h415v-138h-415v-61q0 -126 -62 -219.5t-160 -150.5v-11h837v-171z ","M1168 257l-110 -110l-236 234q-44 -26 -81 -37t-89 -11q-46 0 -89.5 12.5t-79.5 35.5l-236 -236l-109 113l233 234q-23 37 -35 81.5t-12 87.5q0 52 11 88.5t37 79.5l-234 237l111 110l235 -235q36 23 79.5 35.5t88.5 12.5q44 0 88 -12t81 -35l234 234l113 -109l-235 -237 q24 -38 36 -79.5t12 -89.5q0 -45 -12.5 -89t-35.5 -80zM832 661q0 73 -52.5 129t-127.5 56q-73 0 -126.5 -55t-53.5 -130q0 -74 52.5 -129.5t127.5 -55.5q73 0 126.5 54.5t53.5 130.5z","M1191 1489l-448 -831v-94h372v-138h-370v-426h-188v426h-370v138h372v73l-451 852h212l332 -659l336 659h203z","M552 758h-174v798h174v-798zM552 -392h-174v798h174v-798z","M1128 601q0 -106 -59 -187t-158 -136v-7q97 -46 141 -118.5t44 -162.5q0 -77 -33 -146t-98 -119q-72 -56 -169 -83t-221 -27q-87 0 -170.5 13.5t-175.5 44.5v194h10q79 -37 169 -62t198 -25q134 0 215 48.5t81 135.5q0 56 -19.5 88.5t-64.5 57.5q-41 23 -113 41.5 t-154 38.5q-214 52 -296 133q-83 81 -83 210q0 98 57 182.5t159 141.5v7q-101 48 -143 121t-42 162q0 81 32 146.5t99 117.5q64 50 163.5 79t227.5 29q87 0 171 -14t175 -43v-194h-10q-58 27 -152.5 57t-215.5 30q-127 0 -211.5 -46t-84.5 -133q0 -57 21.5 -92.5t64.5 -58.5 t109 -41.5t157 -39.5q200 -46 290 -125q89 -79 89 -218zM881 399q28 33 43 65.5t15 90.5q0 51 -16.5 86t-45.5 58q-28 24 -67 39.5t-83 27.5q-39 11 -85.5 21.5t-116.5 30.5q-18 -9 -49 -31.5t-53 -46.5q-24 -26 -43 -69t-19 -92q0 -50 15.5 -85t44.5 -59q27 -23 67.5 -39 t84.5 -27q38 -10 86 -22t115 -31q20 11 53 34.5t54 48.5z","M958 1304h-199v195h199v-195zM545 1304h-199v195h199v-195z","M1889 655q0 -358 -253.5 -611.5t-611.5 -253.5t-611.5 253.5t-253.5 611.5t253.5 611.5t611.5 253.5t611.5 -253.5t253.5 -611.5zM1773 655q0 310 -219.5 532t-529.5 222t-529.5 -222t-219.5 -532t219.5 -532t529.5 -222t529.5 222t219.5 532zM1375 258 q-86 -39 -165.5 -58.5t-157.5 -19.5q-227 0 -359 123t-132 357q0 225 134.5 354t356.5 129q89 0 175 -24t148 -52v-181h-16q-54 40 -138.5 75t-173.5 35q-142 0 -221.5 -85.5t-79.5 -250.5q0 -159 76.5 -246t224.5 -87q83 0 161.5 29t150.5 81h16v-179z","M944 554h-170v94q-28 -20 -52.5 -38.5t-68.5 -37.5q-45 -20 -85.5 -30.5t-113.5 -10.5q-128 0 -215.5 85t-87.5 217q0 106 46.5 173.5t123.5 103.5q78 36 197.5 51.5t255.5 21.5v18q0 53 -18 85t-51 51q-34 18 -77.5 23t-91.5 5q-84 0 -168 -24t-123 -38h-14v172 q45 13 137 29t169 16q217 0 312 -84.5t95 -243.5v-638zM774 796v245q-69 -4 -160.5 -12t-145.5 -23q-64 -18 -103 -56.5t-39 -106.5q0 -76 45.5 -114t139.5 -38q82 0 147.5 33.5t115.5 71.5z","M1146 191l-528 419v85l528 418v-188l-357 -273l357 -273v-188zM716 162l-550 446v89l550 445v-196l-371 -294l371 -294v-196z","M1456 57h-171v545h-1075v160h1246v-705z","M777 561h-624v181h624v-181z","M1889 655q0 -358 -253.5 -611.5t-611.5 -253.5t-611.5 253.5t-253.5 611.5t253.5 611.5t611.5 253.5t611.5 -253.5t253.5 -611.5zM1773 655q0 310 -219.5 532t-529.5 222t-529.5 -222t-219.5 -532t219.5 -532t529.5 -222t529.5 222t219.5 532zM1581 215h-223l-331 355 h-162v-355h-165v915h312q94 0 155 -8t120 -39q63 -34 92.5 -82.5t29.5 -121.5q0 -97 -56.5 -161.5t-155.5 -102.5zM1229 868q0 36 -14 64t-47 46q-31 17 -66 22t-88 5h-149v-309h127q62 0 107 9.5t74 32.5q31 25 43.5 55t12.5 75z","M1306 1668h-1305l-5 120h1310v-120z","M956 1116q0 -168 -116 -284t-285 -116t-285 115.5t-116 284.5q0 168 116 284t285 116q170 0 285.5 -116t115.5 -284zM791 1116q0 102 -67 171.5t-169 69.5t-169 -69.5t-67 -171.5q0 -104 68.5 -172.5t167.5 -68.5q102 0 169 70t67 171z","M1461 179h-1246v158h540v422h-540v158h540v545h166v-545h540v-158h-540v-422h540v-158z","M967 566h-760v156q100 62 183.5 117t134.5 96q131 103 168 154.5t37 135.5q0 69 -53.5 107t-143.5 38q-89 0 -175 -30.5t-134 -61.5h-13v180q71 26 158.5 43.5t174.5 17.5q180 0 273.5 -78.5t93.5 -203.5q0 -99 -48.5 -174.5t-163.5 -165.5q-55 -43 -132.5 -94 t-143.5 -92h544v-145z","M956 817q0 -75 -33 -131.5t-89 -90.5q-57 -35 -131 -51.5t-163 -16.5q-94 0 -176.5 15t-156.5 43v179h14q41 -36 138.5 -65.5t190.5 -29.5q100 0 166.5 35.5t66.5 110.5q0 85 -59 115t-171 30h-143v141h128q112 0 165.5 38.5t53.5 106.5q0 61 -49.5 96.5t-153.5 35.5 q-77 0 -174.5 -31t-141.5 -67h-14v178q74 27 160.5 44.5t176.5 17.5q175 0 271.5 -68t96.5 -174q0 -89 -55 -146t-144 -83v-8q95 -17 160.5 -72.5t65.5 -151.5z","M963 1676l-273 -374h-149l179 374h243z","M1124 0h-178l-10 118q-59 -65 -123.5 -102t-155.5 -37q-86 0 -149.5 35t-129.5 99v-525h-188v1529h188v-838q32 -39 109.5 -80t168.5 -41q93 0 159.5 33.5t120.5 93.5v832h188v-1117z","M1106 -363h-148v1722h-214v-1722h-149v956q-206 5 -332 129t-126 328q0 207 130 323t373 116h466v-1852z","M492 511h-239v283h239v-283z","M880 -89q0 -162 -91.5 -248t-237.5 -86q-37 0 -95 7t-103 19v160h9q26 -10 70 -23t94 -13q104 0 153 39t49 127q0 29 -3 65.5t-6 61.5h153q2 -19 5 -45t3 -64z","M914 566h-615v122h234v568h-242v112q45 0 99 6.5t84 18.5q37 16 59 38t25 62h135v-805h221v-122z","M996 1025q0 -235 -122 -364.5t-315 -129.5q-201 0 -319.5 132.5t-118.5 361.5t118.5 362t319.5 133q193 0 315 -130t122 -365zM814 1025q0 172 -67.5 258t-187.5 86q-122 0 -189 -87t-67 -257t67 -256.5t189 -86.5q120 0 187.5 85.5t67.5 257.5z","M1154 608l-550 -446v196l371 294l-371 294v196l550 -445v-89zM702 610l-528 -419v188l357 273l-357 273v188l528 -418v-85z","M545 565h-165v681h-209v117q102 0 165 22t72 108h137v-928zM1410 1489l-780 -1489h-165l780 1489h165zM1857 220h-163v-220h-150v220h-465v185l466 539h149v-591h163v-133zM1548 353v400l-353 -400h353z","M545 565h-165v681h-209v117q102 0 165 22t72 108h137v-928zM1410 1489l-780 -1489h-165l780 1489h165zM1955 0h-688v148q91 69 158 121t106 89q109 103 141 157.5t32 136.5q0 70 -44 107t-120 37q-70 0 -141.5 -30t-112.5 -62h-15v179q65 27 140.5 44t152.5 17 q157 0 241.5 -79t84.5 -201q0 -93 -41 -167t-147 -168q-49 -43 -119.5 -96t-125.5 -94h498v-139z","M793 826q0 -71 -30 -127t-78 -90q-53 -37 -114.5 -53t-140.5 -16q-82 0 -153.5 15t-136.5 43v175h17q37 -35 114 -64.5t156 -29.5q84 0 139 36.5t55 108.5q0 83 -50 112.5t-141 29.5h-140v139h125q87 0 134.5 38t47.5 104q0 60 -41 95.5t-128 35.5q-66 0 -142.5 -31 t-113.5 -66h-17v175q64 27 139 44t154 17q152 0 237 -70t85 -168q0 -87 -48.5 -143.5t-125.5 -82.5v-8q80 -16 138.5 -70.5t58.5 -148.5zM1500 1489l-780 -1489h-165l780 1489h165zM1913 220h-163v-220h-150v220h-465v185l466 539h149v-591h163v-133zM1604 353v400 l-353 -400h353z","M712 1278h-204v211h204v-211zM958 40q-83 -30 -176 -50t-205 -20q-215 0 -339.5 104.5t-124.5 275.5q0 98 34.5 173t93.5 137q58 62 136.5 112.5t146.5 91.5v225h179v-305q-60 -33 -139 -81.5t-125 -88.5q-54 -47 -88 -109t-34 -140q0 -113 76.5 -168.5t197.5 -55.5 q103 0 201.5 33t155.5 70h10v-204z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM862 1675h-149l-273 374h243z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM955 2049l-273 -374h-149l179 374h243z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1033 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1119 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5 t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1005 1677h-199v195h199v-195zM592 1677h-199v195h199v-195z","M1374 0h-211l-148 415h-640l-148 -415h-201l519 1407q-89 44 -142.5 123.5t-53.5 181.5q0 143 102 240t248 97q147 0 248.5 -97t101.5 -240q0 -100 -52.5 -181.5t-141.5 -123.5zM899 1710q0 86 -57 143.5t-143 57.5t-143 -58t-57 -143q0 -86 57.5 -143.5t142.5 -57.5 q86 0 143 57.5t57 143.5zM953 585l-258 715l-259 -715h517z","M1901 0h-944v556h-524l-212 -556h-207l594 1489h1293v-176h-749v-408h749v-176h-749v-553h749v-176zM957 723v601h-219l-239 -601h458z","M1350 108q-55 -24 -99.5 -45t-116.5 -44q-11 -3 -24 -7.5t-31 -7.5q2 -19 3.5 -44.5t1.5 -48.5q0 -162 -93.5 -248t-240.5 -86q-38 0 -97.5 7t-104.5 19v162h9q26 -10 71.5 -24t95.5 -14q106 0 155 40t49 126q0 19 -1 41.5t-3 42.5q-19 -2 -40.5 -3t-39.5 -1 q-162 0 -294.5 45.5t-230.5 142.5q-96 95 -150 241.5t-54 340.5q0 184 52 329t150 245q95 97 229.5 148t298.5 51q120 0 239.5 -29t265.5 -102v-235h-15q-123 103 -244 150t-259 47q-113 0 -203.5 -36.5t-161.5 -113.5q-69 -75 -107.5 -189.5t-38.5 -264.5q0 -157 42.5 -270 t109.5 -184q70 -74 163.5 -109.5t197.5 -35.5q143 0 268 49t234 147h14v-232z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM822 1675h-149l-273 374h243z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM993 2049l-273 -374h-149l179 374h243z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM1031 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM1038 1677h-199v195h199v-195zM625 1677h-199v195h199v-195z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM568 1675h-149l-273 374h243z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM725 2049l-273 -374h-149l179 374h243z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM776 1670h-159l-185 256l-184 -256h-155l228 379h227z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM738 1677h-199v195h199v-195zM325 1677h-199v195h199v-195z","M1468 743q0 -203 -88.5 -368t-235.5 -256q-102 -63 -227.5 -91t-330.5 -28h-376v740h-196v143h196v606h372q218 0 347 -31.5t217 -86.5q152 -95 237 -253t85 -375zM1261 746q0 175 -61 295t-182 189q-88 50 -187 69.5t-237 19.5h-188v-436h361v-143h-361v-570h188 q143 0 249.5 21t195.5 78q111 71 166.5 187t55.5 290z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489zM1208 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5 q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM932 1675h-149l-273 374h243z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1083 2049l-273 -374h-149l179 374h243z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1136 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1207 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228 t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1307 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1289 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1108 1677h-199v195h199v-195zM695 1677h-199v195h199v-195z","M1385 216l-111 -111l-436 440l-436 -440l-111 111l440 436l-440 436l111 111l436 -440l436 440l111 -111l-440 -436z","M1498 744q0 -184 -49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-115 0 -215.5 29t-179.5 84l-159 -228h-132l205 294q-101 100 -155.5 250t-54.5 346q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q118 0 215 -27.5t179 -82.5l142 201h132 l-188 -268q101 -100 156.5 -248.5t55.5 -350.5zM1097 1260q-57 46 -129 68.5t-161 22.5q-110 0 -200 -38.5t-156 -116.5q-64 -76 -98.5 -190.5t-34.5 -261.5q0 -140 29.5 -252t87.5 -188zM1295 744q0 139 -30 253t-88 189l-664 -957q60 -45 132.5 -68t161.5 -23 q110 0 201.5 40t153.5 116q67 82 100 194.5t33 255.5z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM932 1675h-149l-273 374h243z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1073 2049l-273 -374h-149l179 374h243z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1084 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1056 1677h-199v195h199v-195zM643 1677h-199v195h199v-195z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM935 2049l-273 -374h-149l179 374h243z","M1174 787q0 -92 -35 -176.5t-95 -141.5q-78 -75 -187.5 -111t-260.5 -36h-198v-322h-198v1489h198v-270h205q133 0 230 -22.5t164 -66.5q83 -53 130 -138t47 -205zM968 782q0 72 -26 125.5t-82 88.5q-48 30 -112 42.5t-154 12.5h-196v-563h167q119 0 195 20.5t123 65.5 q44 41 64.5 92t20.5 116z","M1165 481q0 -214 -135.5 -359.5t-354.5 -145.5q-44 0 -101.5 7.5t-93.5 20.5v165h10q42 -24 91.5 -33t105.5 -9q74 0 129 29t88 78q35 52 50.5 115.5t15.5 139.5q0 166 -105.5 250.5t-303.5 84.5v150q157 0 234 59.5t77 188.5q0 35 -11 68t-41 64q-27 29 -71 46.5 t-105 17.5q-57 0 -103 -14.5t-86 -53.5q-37 -36 -59.5 -102t-22.5 -161v-1087h-188v1080q0 124 36 215.5t100 153.5q60 58 149.5 87.5t183.5 29.5q183 0 297.5 -87t114.5 -238q0 -112 -71 -201t-184 -121v-9q164 -37 259 -148.5t95 -280.5z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM738 1302h-149l-273 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM934 1676l-273 -374h-149l179 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM961 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM1038 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5 q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM926 1304h-199v195h199v-195zM513 1304h-199v195h199v-195z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM956 1630q0 -143 -102 -242t-248 -99q-144 0 -247 98.5t-103 242.5 q0 143 102 241t248 98q147 0 248.5 -98t101.5 -241zM811 1630q0 86 -58.5 145.5t-146.5 59.5t-146.5 -59t-58.5 -146t59 -146t146 -59q88 0 146.5 59t58.5 146z","M1855 559h-819q0 -114 30 -195t85 -133q52 -48 123 -70.5t157 -22.5q111 0 217.5 41.5t172.5 93.5h12v-205q-78 -35 -184.5 -64.5t-215.5 -29.5q-166 0 -284.5 52t-194.5 155q-21 -19 -67 -59t-96 -68q-63 -36 -137 -59.5t-189 -23.5q-150 0 -255.5 97t-105.5 249 q0 124 54 200.5t155 118.5q95 39 241 53t308 17v61q0 65 -23 107.5t-64 65.5q-40 23 -96 31.5t-116 8.5q-79 0 -168.5 -21t-179.5 -57h-13v191q55 15 158 34t204 19q159 0 264.5 -46.5t162.5 -137.5q69 82 170 134t226 52q217 0 342.5 -128t125.5 -379v-82zM1673 703 q-5 68 -23.5 119t-50.5 88q-34 39 -88.5 61t-133.5 22q-133 0 -223 -75t-115 -215h634zM894 298q-20 53 -30.5 119t-10.5 141q-105 -3 -201 -7.5t-178 -25.5q-79 -20 -127.5 -65.5t-48.5 -128.5q0 -95 58 -141t176 -46q99 0 195.5 43t166.5 111z","M1011 70q-33 -15 -71.5 -30.5t-67.5 -24.5q3 -19 5.5 -47.5t2.5 -56.5q0 -162 -91.5 -248t-237.5 -86q-37 0 -95 7t-103 19v160h9q26 -10 70 -23t94 -13q104 0 153 39t49 127q0 22 -1.5 45t-3.5 43q-16 -2 -30.5 -4t-39.5 -2q-121 0 -222 35.5t-173 107.5 q-73 72 -113 182t-40 257q0 274 150.5 430t397.5 156q96 0 188.5 -27t169.5 -66v-209h-10q-86 67 -177.5 103t-178.5 36q-160 0 -252.5 -107.5t-92.5 -315.5q0 -202 90.5 -310.5t254.5 -108.5q57 0 116 15t106 39q41 21 77 44.5t57 40.5h10v-207z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM759 1302h-149l-273 374h243z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM960 1676l-273 -374h-149l179 374h243z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM986 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM951 1304h-199v195h199v-195zM538 1304h-199v195h199v-195z","M375 0h-188v1117h188v-1117zM401 1302h-149l-273 374h243z","M375 0h-188v1117h188v-1117zM582 1676l-273 -374h-149l179 374h243z","M572 1297h-151l-143 267l-142 -267h-147l178 379h227zM375 0h-188v1117h188v-1117z","M557 1304h-189v195h189v-195zM194 1304h-189v195h189v-195zM375 0h-188v1117h188v-1117z","M1137 637q0 -324 -142 -496t-383 -172q-229 0 -367.5 135t-138.5 380q0 226 137 358t339 132q108 0 185.5 -26.5t163.5 -79.5q-32 112 -99.5 219t-154.5 181l-264 -162l-66 97l237 142q-84 67 -156 107.5t-165 87.5v16h295q35 -25 84 -58.5t86 -59.5l210 128l66 -97 l-186 -109q153 -147 236 -325.5t83 -397.5zM847 226q49 59 75 143.5t26 234.5q0 32 -1.5 59.5t-3.5 57.5q-75 45 -157.5 66.5t-168.5 21.5q-147 0 -231.5 -87.5t-84.5 -239.5q0 -180 84.5 -267t227.5 -87q66 0 127.5 22t106.5 76z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-725zM1075 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5 t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M732 1302h-149l-273 374h243z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M933 1676l-273 -374h-149l179 374h243z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M963 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M1038 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M928 1304h-199v195h199v-195zM515 1304h-199v195h199v-195z","M957 1022h-238v275h238v-275zM1466 572h-1256v160h1256v-160zM957 7h-238v275h238v-275z","M1137 558q0 -273 -140 -431t-375 -158q-84 0 -155.5 21t-130.5 60l-133 -198h-110l171 256q-75 77 -116.5 190t-41.5 260q0 273 139.5 431.5t376.5 158.5q87 0 158 -22t125 -57l116 172h111l-155 -231q76 -76 118 -188t42 -264zM813 930q-37 29 -86.5 43.5t-104.5 14.5 q-155 0 -240 -110t-85 -320q0 -97 17 -171t52 -128zM946 558q0 97 -17.5 173t-51.5 130l-448 -671q39 -31 86.5 -46t106.5 -15q150 0 237 108.5t87 320.5z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM764 1302h-149l-273 374h243z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM945 1676l-273 -374h-149l179 374h243z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM985 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM955 1304h-199v195h199v-195zM542 1304h-199v195h199v-195z","M1151 1117l-652 -1529h-201l208 466l-445 1063h204l343 -828l346 828h197zM928 1676l-273 -374h-149l179 374h243z","M1168 572q0 -136 -39 -248.5t-110 -190.5q-66 -74 -155.5 -114.5t-189.5 -40.5q-87 0 -157.5 19t-143.5 59v-468h-188v1968h188v-556q75 63 168.5 105.5t199.5 42.5q202 0 314.5 -152.5t112.5 -423.5zM974 567q0 202 -69 302t-212 100q-81 0 -163 -35t-157 -92v-633 q80 -36 137.5 -49t130.5 -13q157 0 245 106t88 314z","M585 832h-239v285h239v-285zM658 285l-282 -655h-146l174 655h254z","M773 1676l-49 -384h-145l-49 384h243z","M765 1676l-49 -384h-128l-49 384h226zM1048 1304h-191v195h191v-195zM447 1304h-191v195h191v-195z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM250 1489l-49 -384h-145l-49 384h243z","M585 832h-239v285h239v-285z","M1424 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM243 1489l-49 -384h-145l-49 384h243z","M1582 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489zM243 1489l-49 -384h-145l-49 384h243z","M968 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM243 1489l-49 -384h-145l-49 384h243z","M1501 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1483 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM243 1489l-49 -384h-145l-49 384h243z","M1537 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM243 1489l-49 -384h-145l-49 384h243z","M1751 0h-576v387q60 38 119.5 82t103.5 101q45 59 71 138.5t26 185.5q0 206 -127 330.5t-347 124.5t-347 -124.5t-127 -330.5q0 -106 26 -185.5t71 -138.5q45 -57 104 -101t119 -82v-387h-576v174h410v124q-157 90 -258.5 246t-101.5 350q0 276 187.5 451t492.5 175 t492.5 -175t187.5 -451q0 -194 -101.5 -350t-258.5 -246v-124h410v-174zM243 1489l-49 -384h-145l-49 384h243z","M375 0h-188v1117h188v-1117zM379 1676l-56 -384h-84l-56 384h196zM615 1304h-171v195h171v-195zM118 1304h-171v195h171v-195z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523z","M1323 458q0 -111 -42 -196t-113 -140q-84 -66 -184.5 -94t-255.5 -28h-528v1489h441q163 0 244 -12t155 -50q82 -43 119 -110.5t37 -161.5q0 -106 -54 -180.5t-144 -119.5v-8q151 -31 238 -132.5t87 -256.5zM990 1129q0 54 -18 91t-58 60q-47 27 -114 33.5t-166 6.5h-236 v-430h256q93 0 148 9.5t102 39.5t66.5 77.5t19.5 112.5zM1117 450q0 90 -27 143t-98 90q-48 25 -116.5 32.5t-166.5 7.5h-311v-554h262q130 0 213 13.5t136 49.5q56 39 82 89t26 129z","M1162 1313h-764v-1313h-198v1489h962v-176z","M1414 0h-1388l562 1489h264zM1147 168l-432 1147l-431 -1147h863z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176z","M1288 0h-1162v184l913 1129h-879v176h1106v-179l-922 -1134h944v-176z","M1339 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1120 713h-627v179h627v-179z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152z","M1397 0h-257l-589 663l-148 -158v-505h-198v1489h198v-777l723 777h240l-665 -700z","M1378 0h-213l-468 1285l-468 -1285h-203l556 1489h240z","M1526 0h-198v1283l-414 -873h-118l-411 873v-1283h-185v1489h270l397 -829l384 829h275v-1489z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489z","M1215 1313h-1101v176h1101v-176zM1163 729h-997v176h997v-176zM1215 0h-1101v176h1101v-176z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1339 0h-198v1313h-743v-1313h-198v1489h1139v-1489z","M1174 1039q0 -99 -34.5 -183.5t-96.5 -146.5q-77 -77 -182 -115.5t-265 -38.5h-198v-555h-198v1489h404q134 0 227 -22.5t165 -70.5q85 -57 131.5 -142t46.5 -215zM968 1034q0 77 -27 134t-82 93q-48 31 -109.5 44.5t-155.5 13.5h-196v-595h167q120 0 195 21.5t122 68.5 q47 48 66.5 101t19.5 119z","M1280 0h-1162v184l620 600l-600 526v179h1096v-176h-832l586 -506v-26l-630 -605h922v-176z","M1262 1313h-532v-1313h-198v1313h-532v176h1262v-176z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211z","M1572 755q0 -140 -44.5 -248.5t-123.5 -181.5q-85 -79 -207 -125.5t-260 -49.5v-166h-197v166q-134 3 -257 48t-210 127q-79 74 -123.5 182t-44.5 248q0 136 43 238t119 178q81 81 202.5 128t270.5 51v155h197v-155q148 -3 271 -52t202 -127q75 -73 118.5 -177t43.5 -239 zM1366 763q0 99 -32 182t-91 140q-58 56 -129 82t-177 28v-890q94 2 171 30.5t127 75.5q65 60 98 147t33 205zM740 305v890q-106 -1 -177 -28t-129 -82t-90.5 -140t-32.5 -182q0 -112 33.5 -203t97.5 -149q49 -45 126.5 -75t171.5 -31z","M1336 1489l-514 -736l513 -753h-229l-406 613l-416 -613h-216l519 744l-507 745h228l401 -605l410 605h217z","M1604 910q0 -157 -40.5 -264.5t-117.5 -174.5q-80 -69 -192.5 -104t-263.5 -45v-322h-197v322q-154 11 -267 47t-188 102q-78 69 -118.5 176t-40.5 263v579h198v-602q0 -109 29.5 -180t81.5 -115q53 -45 130 -68.5t175 -30.5v996h197v-996q97 8 175 30.5t131 68.5 q56 49 83 115.5t27 179.5v602h198v-579z","M1568 0h-576v387q60 38 119.5 82t103.5 101q45 59 71 138.5t26 185.5q0 206 -127 330.5t-347 124.5t-347 -124.5t-127 -330.5q0 -106 26 -185.5t71 -138.5q45 -57 104 -101t119 -82v-387h-576v174h410v124q-157 90 -258.5 246t-101.5 350q0 276 187.5 451t492.5 175 t492.5 -175t187.5 -451q0 -194 -101.5 -350t-258.5 -246v-124h410v-174z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM738 1677h-199v195h199v-195zM325 1677h-199v195h199v-195z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM939 1677h-199v195h199v-195zM526 1677h-199v195h199v-195z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -22t143 -61v52h188v-1117zM903 275v636q-76 34 -136 49.5t-131 15.5q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5zM743 1676l-49 -384h-145l-49 384h243z","M1006 64q-107 -48 -210 -69t-218 -21q-79 0 -161 16t-152 56q-69 39 -112.5 102.5t-43.5 157.5q0 96 56.5 168t177.5 110v7q-91 24 -145 90t-54 158q0 89 47.5 147.5t112.5 92.5q64 33 145 49t160 16q98 0 180 -16.5t172 -44.5v-207h-13q-66 51 -163.5 79t-197.5 28 q-45 0 -84 -5.5t-81 -25.5q-35 -15 -60.5 -48.5t-25.5 -77.5q0 -61 28 -95t76 -49q45 -14 97 -15.5t105 -1.5h111v-166h-158q-62 0 -112 -4.5t-92 -21.5q-41 -17 -65.5 -54t-24.5 -96q0 -53 26 -90t67 -58q37 -19 87.5 -29t106.5 -10q102 0 218 36t187 98h13v-206zM721 1676 l-49 -384h-145l-49 384h243z","M1119 -412h-188v1048q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-1137zM802 1676l-49 -384h-145l-49 384h243z","M375 0h-188v1117h188v-1117zM403 1676l-49 -384h-145l-49 384h243z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM760 1676l-49 -384h-128l-49 384h226zM1043 1304h-191 v195h191v-195zM442 1304h-191v195h191v-195z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -22t143 -61v52h188v-1117zM903 275v636q-76 34 -136 49.5t-131 15.5q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5z","M1165 444q0 -202 -134.5 -334t-339.5 -132q-79 0 -167 22t-151 64v-476h-188v1490q0 224 126.5 351t349.5 127q90 0 164.5 -21.5t133.5 -67.5q57 -43 91 -112t34 -160q0 -127 -69.5 -221.5t-196.5 -131.5v-17q159 -26 253 -125.5t94 -255.5zM971 449q0 89 -34.5 144.5 t-92.5 86.5q-59 32 -132 43t-146 11h-36v160h36q66 0 131 14.5t104 44.5q46 34 68.5 83t22.5 134q0 112 -69 170t-178 58q-73 0 -125 -26.5t-85 -70.5q-32 -44 -47 -102.5t-15 -120.5v-862q66 -38 141 -53.5t147 -15.5q149 0 229.5 78.5t80.5 223.5z","M1151 1117l-457 -1061v-468h-188v468l-445 1061h204l343 -828l346 828h197z","M1139 551q0 -272 -138.5 -427t-376.5 -155q-241 0 -379.5 151.5t-138.5 413.5q0 141 43 239.5t107 162.5q69 72 159 113t182 58q-76 63 -166 130.5t-192 139.5v179h810v-158h-561v-10q68 -46 179 -124t204 -162q150 -136 209 -261.5t59 -289.5zM945 551q0 135 -55 249 t-165 200q-66 -8 -138.5 -32t-138.5 -77q-63 -50 -105.5 -137t-42.5 -214q0 -201 85 -305t241 -104q153 0 236 105.5t83 314.5z","M1006 64q-107 -48 -210 -69t-218 -21q-79 0 -161 16t-152 56q-69 39 -112.5 102.5t-43.5 157.5q0 96 56.5 168t177.5 110v7q-91 24 -145 90t-54 158q0 89 47.5 147.5t112.5 92.5q64 33 145 49t160 16q98 0 180 -16.5t172 -44.5v-207h-13q-66 51 -163.5 79t-197.5 28 q-45 0 -84 -5.5t-81 -25.5q-35 -15 -60.5 -48.5t-25.5 -77.5q0 -61 28 -95t76 -49q45 -14 97 -15.5t105 -1.5h111v-166h-158q-62 0 -112 -4.5t-92 -21.5q-41 -17 -65.5 -54t-24.5 -96q0 -53 26 -90t67 -58q37 -19 87.5 -29t106.5 -10q102 0 218 36t187 98h13v-206z","M922 75q32 -40 46 -85.5t14 -85.5q0 -84 -45 -168.5t-112 -147.5h-179v14q90 79 128 138.5t38 128.5q0 57 -30.5 95t-77.5 38h-145q-229 0 -340 116t-111 345q0 140 46 268t124 247q75 112 173.5 214.5t206.5 196.5v9h-460v158h744v-135q-117 -78 -231.5 -181 t-204.5 -223q-89 -117 -146 -257t-57 -283q0 -34 3 -70t15 -76q10 -38 34.5 -75.5t63.5 -61.5q36 -22 96.5 -24.5t116.5 -2.5h86q71 0 122 -26t82 -66z","M1119 -412h-188v1048q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-1137z","M1141 768q0 -190 -23 -316.5t-59 -210.5q-58 -135 -163 -203.5t-257 -68.5t-257 68.5t-163 203.5q-37 84 -59.5 210.5t-22.5 316.5q0 174 22.5 305.5t60.5 214.5q57 130 162.5 199t256.5 69t256.5 -69t162.5 -199q37 -84 60 -215t23 -305zM952 858q-4 143 -28.5 250 t-56.5 161q-41 70 -95 98.5t-133 28.5t-133 -28.5t-95 -98.5q-34 -55 -57.5 -161.5t-27.5 -249.5h626zM952 697h-626q0 -142 23 -258.5t59 -178.5q40 -69 96 -100t135 -31t135 31t96 100q36 62 59 178.5t23 258.5z","M375 0h-188v1117h188v-1117z","M1192 0h-248l-451 489l-112 -109v-380h-188v1117h188v-550l384 417q72 79 135.5 107t126.5 28q28 0 58 -1t37 -1v-166h-11q-16 2 -39.5 3t-36.5 1q-47 0 -85.5 -23.5t-67.5 -56.5l-251 -271z","M1151 0h-205l-328 829l-361 -829h-196l465 1056l-215 500h211z","M1125 0h-186v118q-74 -78 -141.5 -108.5t-145.5 -30.5q-75 0 -135 27t-144 107v-525h-188v1529h188v-838q32 -39 111 -80t170 -41q93 0 161 33.5t122 93.5v832h188v-1117z","M1151 1117l-452 -1117h-189l-449 1117h204l346 -889l343 889h197z","M1041 -96q0 -85 -45.5 -169t-111.5 -147h-180v14q92 79 129.5 139t37.5 128q0 55 -29 94t-75 39h-140q-140 0 -232.5 27t-155.5 84q-66 60 -100.5 135.5t-34.5 163.5q0 78 25 144t73 119q44 49 112.5 83.5t144.5 53.5v11q-125 28 -200 110.5t-75 186.5q0 83 43.5 150.5 t133.5 125.5v6h-228v154h824v-158h-256q-68 0 -122.5 -14.5t-102.5 -48.5q-45 -32 -72 -83t-27 -118q0 -79 32.5 -128t83.5 -75q45 -23 104 -34t139 -11h170v-165h-295q-66 0 -118.5 -20t-99.5 -59q-43 -37 -68.5 -90t-25.5 -112q0 -102 37.5 -159t101.5 -82 q63 -25 139.5 -28.5t166.5 -3.5h28q68 0 119.5 -23.5t84.5 -60.5q31 -35 48 -82.5t17 -96.5z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z","M1120 0h-188v955h-559v-955h-188v1117h935v-1117z","M1172 577q0 -258 -138.5 -428.5t-360.5 -170.5q-65 0 -146.5 18t-153.5 61v-469h-188v1058q0 123 35.5 215.5t101.5 158.5q62 62 155.5 95t195.5 33q243 0 371 -147t128 -424zM978 565q0 218 -80 320t-226 102q-158 0 -228.5 -96t-70.5 -278v-403q73 -34 132.5 -48.5 t134.5 -14.5q162 0 250 111t88 307z","M1018 -96q0 -87 -47 -172t-109 -144h-177v14q86 75 124.5 135.5t38.5 131.5q0 54 -30 93.5t-75 39.5h-92q-117 0 -216 30t-174 97q-73 66 -114.5 170t-41.5 250q0 270 155.5 432t414.5 162q84 0 164 -18.5t147 -45.5v-211h-12q-94 62 -172.5 87t-146.5 25 q-166 0 -260.5 -119t-94.5 -312q0 -112 28.5 -183t78.5 -116q50 -44 114.5 -63.5t139.5 -19.5h100q115 0 186 -76.5t71 -186.5z","M1137 558q0 -281 -140.5 -435t-373.5 -154q-241 0 -379 158t-138 431q0 275 141 432.5t378 157.5q55 0 108 -11t82 -20h480v-165h-288q62 -73 96 -170t34 -224zM943 558q0 215 -82 322t-236 107q-161 0 -243 -112t-82 -317q0 -209 83.5 -318t239.5 -109q152 0 236 107.5 t84 319.5z","M1006 952h-404v-952h-188v952h-404v165h996v-165z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710z","M1514 576q0 -259 -171.5 -417t-440.5 -173v-398h-187v398q-130 6 -240.5 46.5t-191.5 109.5q-85 74 -132 172t-47 232q0 159 59 296t192 275h229v-17q-136 -99 -210 -232t-74 -300q0 -189 112.5 -304t301.5 -121v1000q33 2 70.5 2.5t76.5 0.5q304 0 478.5 -149.5 t174.5 -420.5zM1319 586q0 184 -112 293.5t-305 109.5v-846q206 10 311.5 126t105.5 317z","M1160 -412h-213l-346 619l-350 -619h-203l444 770l-433 759h213l335 -600l339 600h203l-433 -751z","M1507 446q0 -114 -48 -198t-127 -137q-82 -55 -182 -82.5t-215 -32.5v-408h-187v408q-115 6 -214.5 32t-182.5 83q-80 54 -127.5 137.5t-47.5 197.5v671h188v-612q0 -113 37.5 -180.5t89.5 -102.5q56 -38 123 -53t134 -19v967h187v-967q67 5 134 19t123 53 q59 40 93 101.5t34 181.5v612h188v-671z","M1553 503q0 -96 -23.5 -192.5t-74.5 -171.5q-55 -80 -133.5 -124.5t-193.5 -44.5q-96 0 -177 49.5t-118 116.5h-6q-39 -68 -113 -117t-176 -49q-113 0 -194.5 46.5t-132.5 122.5t-74.5 171.5t-23.5 192.5q0 170 57 308.5t201 305.5h228v-17q-135 -108 -214.5 -262 t-79.5 -337q0 -66 8 -122.5t38 -119.5q26 -55 72.5 -91.5t117.5 -36.5q51 0 86.5 12.5t55.5 29.5q22 18 36.5 40t20.5 37v584h186v-584q9 -17 23 -39t35 -39q24 -19 52.5 -30t86.5 -11q70 0 117 35.5t74 92.5q25 55 36 116t11 126q0 182 -78.5 336t-215.5 263v17h228 q144 -167 201 -305.5t57 -308.5z","M557 1304h-189v195h189v-195zM194 1304h-189v195h189v-195zM375 0h-188v1117h188v-1117z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM953 1304h-199v195h199v-195zM540 1304h-199v195h199 v-195z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M743 1676l-49 -384h-145l-49 384h243z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM768 1676l-49 -384h-145l-49 384h243z","M1553 503q0 -96 -23.5 -192.5t-74.5 -171.5q-55 -80 -133.5 -124.5t-193.5 -44.5q-96 0 -177 49.5t-118 116.5h-6q-39 -68 -113 -117t-176 -49q-113 0 -194.5 46.5t-132.5 122.5t-74.5 171.5t-23.5 192.5q0 170 57 308.5t201 305.5h228v-17q-135 -108 -214.5 -262 t-79.5 -337q0 -66 8 -122.5t38 -119.5q26 -55 72.5 -91.5t117.5 -36.5q51 0 86.5 12.5t55.5 29.5q22 18 36.5 40t20.5 37v584h186v-584q9 -17 23 -39t35 -39q24 -19 52.5 -30t86.5 -11q70 0 117 35.5t74 92.5q25 55 36 116t11 126q0 182 -78.5 336t-215.5 263v17h228 q144 -167 201 -305.5t57 -308.5zM955 1676l-49 -384h-145l-49 384h243z","M1145 837q0 -164 -39 -344t-121 -303q-85 -124 -186.5 -173t-214.5 -49q-192 0 -313.5 126.5t-121.5 329.5q0 228 134.5 372.5t336.5 144.5q90 0 169.5 -26t158.5 -91q2 26 3 55.5t1 55.5q0 217 -79 318t-231 101q-78 0 -169.5 -31.5t-169.5 -86.5h-11v194 q81 44 181.5 66.5t196.5 22.5q137 0 239.5 -54.5t164.5 -178.5q42 -86 56.5 -189t14.5 -260zM942 678q-60 47 -136 74t-148 27q-141 0 -225 -91t-84 -261q0 -145 67.5 -221.5t179.5 -76.5q128 0 209.5 97t115.5 287q6 33 11.5 73t9.5 92z","M1438 0h-1388l562 1489h264zM1171 168l-432 1147l-431 -1147h863z","M1532 1315h-200v-1508h-198v1508h-592v-1508h-198v1508h-200v174h1388v-174z","M1369 -189h-1182v191l673 668l-663 631v188h1133v-176h-891l648 -601v-72l-666 -653h948v-176z","M1456 572h-1236v160h1236v-160z","M843 1489l-780 -1489h-165l780 1489h165z","M492 511h-239v283h239v-283z","M1737 1788l-880 -1939h-102l-384 993h-237v139h393l313 -821l730 1628h167z","M1887 663q0 -239 -122.5 -372.5t-329.5 -133.5q-133 0 -244 76.5t-180 222.5q-79 -151 -184.5 -225t-248.5 -74q-191 0 -304 135.5t-113 349.5q0 238 125 372t327 134q134 0 245 -77t179 -222q79 150 185.5 224.5t247.5 74.5q191 0 304 -135.5t113 -349.5zM967 729 q-63 117 -155 175.5t-188 58.5q-138 0 -216 -83.5t-78 -237.5q0 -133 63.5 -216t182.5 -83q110 0 172 48.5t119 142.5q34 57 52.5 92.5t47.5 102.5zM1718 663q0 134 -64 216.5t-182 82.5q-88 0 -152.5 -35.5t-138.5 -155.5q-30 -48 -55.5 -99.5t-44.5 -95.5 q60 -115 153.5 -174.5t189.5 -59.5q138 0 216 83t78 238z","M1168 1367h-10q-32 8 -89.5 18.5t-89.5 10.5q-129 0 -181 -61q-53 -61 -53 -210v-1123q0 -206 -104 -315q-105 -110 -293 -110q-52 0 -106.5 5.5t-103.5 15.5v178h10q33 -8 87 -18.5t88 -10.5q129 0 182 61q52 61 52 210v1123q0 204 104 315q104 110 293 110 q58 0 109 -5.5t105 -15.5v-178z","M1431 1104q-20 -194 -111 -293t-249 -99q-77 0 -147 37.5t-126 82.5q-65 52 -117 79.5t-96 27.5q-75 0 -117 -48t-70 -172h-155q23 182 112.5 280t248.5 98q72 0 143 -37t130 -83q61 -48 114.5 -77.5t98.5 -29.5q76 0 120.5 54.5t63.5 179.5h157zM1432 588 q-25 -184 -112 -281.5t-250 -97.5q-72 0 -144 37.5t-129 82.5q-39 31 -103 69t-110 38q-78 0 -121 -55t-63 -179h-157q19 192 110.5 292t249.5 100q77 0 146 -37t127 -83q35 -28 97 -67.5t116 -39.5q75 0 117 49.5t69 171.5h157z","M1431 362h-608l-104 -335h-153l104 335h-425v156h474l84 268h-558v156h606l105 335h153l-105 -335h427v-156h-476l-83 -268h559v-156z","M1408 303l-1154 483v124l1154 483v-183l-889 -362l889 -362v-183zM1408 0h-1154v160h1154v-160z","M1422 786l-1154 -483v183l889 362l-889 362v183l1154 -483v-124zM1422 0h-1154v160h1154v-160z"],this.OUTLINE_X=[[],[291,301,505,515],[168,211,729,772,554],[195,389,917,1364,1481,1481,1288,760,312,195],[155,604,722,1129.8,1160,1107,722,604,278.5,191.1,162,155],[149,172.3,242,630,1687,1844.3,1960,2031.3,2055,2031.8,1962,1575,517,359.8,244,172.8],[115,149.4,252.5,407.6,598,1555,1287,961.3,881,757.5,601,423.5,293,213.5,187],[164,207,343,386],[181,205.5,279,554,783,783,554,279,205.5],[147,376,651,724.5,749,724.5,651,376,147],[167,232,588,717,1073,1137,1137,1073,717,588,232,167],[210,755,921,1466,1466,921,755,210],[147,293,575,321],[153,777,777,153],[253,492,492,253],[-30,143,860,684],[137,167.9,260.5,420.1,652,881.4,1041.5,1135.6,1167,1136.1,1043.5,883.9,652,422,262,168.3],[278,1084,1084,780,625,278],[161,1169,1169,1106,1073.5,976,821.3,617,387.5,198,161],[167,364,608,830.5,1007,1111,1148,1117,1080,971,821,629,399.5,210,167],[77,790,982,1203,1203,982,798,77],[187,378,613,843.5,1015,1119,1157,1147,251,187],[137,183.5,316,475,675,875.1,1041.5,1153.6,1191,1046,965,866,542,315,179.5],[154,285,499,1173,1173,154],[122,157.9,265.5,433.6,651,859.6,1029.5,1142.4,1180,1140,1106.8,1007,851.5,651,456.8,300,196.5,162],[113,258,340,438,760,988,1122.5,1167,1121,990,829,629,429.5,263,150.5],[346,585,585,346],[230,376,658,585,346],[254,1408,1408,254],[245,1431,1431,245],[268,1422,1422,268],[160,406,610,970,1005,973.9,880.5,733.4,541,337.5,160],[176,240,419,692,1037,1210,1391,1714,1829.5,1870,1813.5,1651,1391,1041,701,426,243],[26,1374,832,568],[200,728,983.5,1168,1281,1323,1196,1159,1040,885,641,200],[115,169,319,549.5,844,1001.5,1134,1250.5,1350,1350,1084.5,845,546.5,317,167],[200,576,906.5,1134,1369.5,1458,1373,1136,918.5,572,200],[200,1181,1181,200],[200,398,1045,1151,1151,200],[115,171,330,577,896,1175.5,1442,1442,1441,1155.5,896,570.9,323.5,167.1],[200,1339,1339,200],[137,725,725,137],[44,178,306,486.6,626.5,716.1,746,746,233,44],[205,1397,1366,205],[200,1142,1142,398,200],[200,1526,1526,200],[200,1336,1336,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,398,1043,1139.5,1174,1127.5,996,831,604,200],[115,163.5,302,520.5,1010.5,1133.1,1290,1409.5,1528,1528,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,1432,1130.5,1004,842,617,200],[134,395.5,685,941.5,1128,1241.5,1282,1222,990,702,480.3,301,182.5,143,134],[0,532,730,1262,1262,0],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,178],[26,568,832,1374,238],[92,486,1546,1933,295],[68,1335,1336,80],[6,532,730,1254,225],[126,1288,1288,1266,160,126],[239,759,759,239],[70,787,960,246],[171,691,691,171],[186,383,1490,901,775],[-4,1306,1306,-4],[340,613,762,583],[104,130.3,209,325.5,465,1053,1053,1020,924,772.5,567,362,203],[185,679,866,1022,1128.5,1168,1139.4,1053.5,918.1,373,185],[105,145,258,431,653,832.5,1011,1011,841.5,653,430.1,255.5,142.6],[108,137.4,225.5,363.6,543,1091,1091,903,258,148.5],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,997.5,849.1,649,428.6,255.5,143.4],[68,195,383,716,786,786,693.5,580,415,294,68],[108,225,391.5,565,798.3,962,1058.8,1091,1091,602,417,259,148.5],[185,1119,1119,1095.3,1024,373,185],[175,187,375,387,387,175],[-62,47.5,153,304,421,496,521,533,533,321,100,-62],[193,1199,1161,381,193],[187,375,375,187],[185,1815,1815,1793.1,1727.5,1615.9,1456,735,185],[185,1119,1119,1095.3,1024,907.5,748,185],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,833.3,622,409.4,245.5,140.9],[185,373,1019,1129,1168,1139.9,1055.5,920.6,741,185],[108,137.6,226.5,365.1,903,1091,1091,602,414,259,149.5],[185,373,882,882,816,745,185],[110,283.5,511,706.9,856.5,951.4,983,939,768.5,566,372.5,230,143.5,115,110],[62,211.3,278,387.5,538,649.5,765,765,377,189,62],[177,201.5,275,392.5,549,1111,1111,177],[61,510,699,1151,265],[86,380,1299,1590,766],[60,1152,1152,64],[61,298,499,1151,265],[93,995,995,978,107,93],[173,588.9,672.5,800.9,963,1113,1113,963,800.9,672.5,588.9,173],[378,552,552,378],[187,337,499.1,627.5,711.1,1127,1127,711.1,627.5,499.1,337,187],[187,354,1125,1290,1401,1466.5,1489,1322,551,386,274,209.5],[],[291,515,505,301],[159,191.6,289.5,647,765,1120,1120,765,647,292.5,192.4],[137,1163,1163,1137,997,816,630.6,484.5,389.6,182,137],[138,247,1058,1168,1168,1055,249,138],[108,187,557,745,1115,1191,320],[378,552,552,378],[172,229,404.5,575,796,965,1063,1096,1128,1071,896,725,497.5,334,235,203],[346,958,958,346],[159,222.4,412.5,692.1,1024,1355.9,1635.5,1825.6,1889,1825.6,1635.5,1355.9,1024,692.1,412.5,222.4],[151,238.5,454,944,944,920.3,849,723.5,537,368,231],[166,716,1146,1146,716,166],[210,1285,1456,1456,210],[153,777,777,153],[159,222.4,412.5,692.1,1024,1355.9,1635.5,1825.6,1889,1825.6,1635.5,1355.9,1024,692.1,412.5,222.4],[-4,1,1306,1306],[154,183,270,399.3,555,710.8,840,927,956,927.1,840.5,711.4,555,399.3,270,183],[215,1461,1461,921,755,215],[207,967,967,911,887.6,817.5,544,369.5,211,207],[207,363.5,540,703,834,923,956,929,904.9,832.5,561,384.5,224,207],[541,690,963,720],[190,378,1124,1124,190],[137,168.5,595,1106,1106,640,425.3,267,169.5],[253,492,492,253],[353,456,551,788.5,857.1,880,877,872,719,353],[291,299,914,914,693,558,291],[121,150.6,239.5,378.6,559,734.3,874,965.5,996,965.5,874,734.3,559,378.6,239.5,150.6],[174,604,1154,1154,604,174],[171,465,1694,1857,1857,1694,1410,545,408,171],[171,465,1955,1955,1890,1805.5,1410,545,408,171],[140,555,1750,1913,1913,1750,1500,448,294,155,140],[113,144.1,237.5,384.6,577,782,958,958,712,508,147.5],[26,1374,862,683,440],[26,1374,955,712,533],[26,1374,1033,805,578,350],[26,1374,1119,990,541,367,288],[26,1374,1005,806,393],[26,1374,1049,1023.6,947.5,834.6,699,564,451,374.5,349],[14,1901,1901,608],[115,169,548,652.5,750,990.5,1350,1350,1084.5,845,546.5,317,167],[200,1181,1181,643,400,200],[200,1181,1181,993,750,200],[200,1181,1181,803,576,200],[200,1181,1181,1038,426,200],[137,725,725,389,146,137],[137,725,725,482,137],[93,137,725,776,548,321],[126,137,725,738,738,126],[14,210,586,916.5,1144,1379.5,1468,1383,1146,929,582,210,14],[200,1336,1336,1208,1079,630,456,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,753,510,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1083,840,303,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1136,908,681,453,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1207,1078,629,455,163],[112,160.5,299,517.5,803,1089.5,1307,1445.5,1495,1446.5,1108,909,496,160],[291,402,1274,1385,1385,1274,402,291],[115,120,252,1092.5,1310,1448.5,1498,1474,1342,806,521.5,303,163],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,753,510,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,1073,830,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,856,629,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,1056,444,178],[6,532,730,1254,935,692],[200,398,1044,1139,1174,1127,997,398,200],[185,675,873.1,1029.5,1131.1,1165,1066,1037.4,951.5,819.9,654,470.5,321,221,185],[104,130.3,209,325.5,465,1053,1053,1020,559,316,203],[104,130.3,209,325.5,465,1053,1053,934,691,203],[104,130.3,209,325.5,465,1053,1053,961,733,506,278,203],[104,130.3,209,325.5,465,1053,1053,1038,909,460,286,207],[104,130.3,209,325.5,465,1053,1053,926,314,203],[104,130.3,209,325.5,465,1053,1053,956,930.6,854.5,741.6,606,471,358,281.5,256],[104,130.4,209.5,326.1,465,1433,1648.5,1833,1855,1855,1823.6,1729.5,1581.1,1387,564,360,202],[105,145,353,456,551,788.5,857.1,1011,1011,841.5,653,430.1,255.5,142.6],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,997.5,580,337,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,960,717,255.5,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,986,758,531,303,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,951,339,143.4],[-21,187,375,401,222],[160,187,375,582,339],[-11,187,375,572,394,167],[5,187,375,557,557,5],[106,140.6,244.5,405.6,612,828.3,995,1101.5,1137,1004,938,263],[185,1119,1119,1075,946,497,323,244,185],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,553,310,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,933,690,245.5,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,963,735,508,280,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1038,909,460,286,207],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,928,729,316,140.9],[210,719,957,1466,1466,957,719,210],[93,203,833.3,997,1102,1137,1132,1021,409.4,245.5,140.9,106],[177,201.5,275,392.5,549,1111,1111,585,342,177],[177,201.5,275,392.5,549,1111,1111,945,702,177],[177,201.5,275,392.5,549,1111,1111,757,530,177],[177,201.5,275,392.5,549,1111,1111,955,343,177],[61,298,499,1151,928,685],[185,373,1019,1129,1168,1139.9,1055.5,920.6,373,185],[230,376,658,585,346],[530,579,724,773],[256,588,716,1048,1048,765,539,256],[7,26,1374,832],[346,585,585,346],[0,49,443,1424,1424,443],[0,49,443,1582,1582,443],[0,49,380,968,968,380],[0,49,354.5,493,711.5,997,1283.5,1501,1639.5,1689,1640.5,1501,1284.5,997],[0,49,815,1013,1537,289],[0,49,291,1751,1751,1701,1654.1,1513.5,1296.6,1021],[-53,187,375,615,615,379,183,-53],[26,1374,832,568],[200,728,983.5,1168,1281,1323,1196,1159,1040,885,641,200],[200,398,1162,1162,200],[26,1414,852,588],[200,1181,1181,200],[126,1288,1288,1266,160,126],[200,1339,1339,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[137,725,725,137],[205,1397,1366,205],[26,1378,822,582],[200,1526,1526,200],[200,1336,1336,200],[114,1215,1215,114],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,1339,1339,200],[200,398,1043,1139.5,1174,1127.5,996,831,604,200],[118,1280,1280,1234,138,118],[0,532,730,1262,1262,0],[6,532,730,1254,225],[105,149.5,273,740,937,1404,1527.5,1572,1528.5,1410,937,740,267,148],[68,1335,1336,80],[179,219.5,338,793,990,1446,1563.5,1604,1604,179],[108,1568,1568,1518,1471.1,1330.5,1113.6,838,562.4,345.5,204.9,158,108],[126,137,725,738,738,126],[6,532,730,1254,939,740,327],[108,137.4,225.5,363.6,543,1091,1091,743,500,148.5],[109,152.5,265,417,578,796,1006,1006,961,721,478,191.5,144],[185,931,1119,1119,1095.3,802,559,185],[160,187,375,403],[177,207.8,300,448,646,846,994,1085.5,1116,1116,1043,760,534,251,177],[108,137.4,225.5,363.6,543,1091,1091,604,416.5,258,148.5],[185,373,1030.5,1131.4,1165,1084,1050,959,825.5,661,462.1,311.5,216.6,185],[61,506,694,1151,265],[106,140.6,244.5,408.6,624,837.1,1000.5,1104.4,1139,1049,239],[109,152.5,265,417,578,796,1006,1006,961,789,609,449,304,191.5,144],[108,135.8,219,646,825,937,982,942,198],[185,931,1119,1119,1095.3,1024,907.5,748,185],[137,159.5,219,382,639,896,1059,1118,1141,1118,1058,895.5,639,382.5,220,159.5],[187,375,375,187],[193,1192,1122,1085,1027,193],[61,1151,522,311],[185,373,1125,1125,185],[61,510,699,1151,265],[104,138.5,239,704,884,995.5,1041,957,133],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,833.3,622,409.4,245.5,140.9],[185,1120,1120,185],[185,373,1033.5,1137.4,1172,1140,1044,887.3,673,477.5,322,220.5,185],[105,146.5,261,685,862,971,1018,986,839,675,441.9,260.5,143.9],[106,140.5,244,407.8,623,832.9,996.5,1101.9,1295,1295,625,412,247,141.3],[10,414,602,1006,1006,10],[177,207.8,300,448,646,846,994,1085.5,1116,1116,177],[104,151,283,715,902,1342.5,1471.1,1514,1470.4,1339.5,1132.6,861,784.5,714,355,163],[48,1160,1149,59],[176,223.5,748,935,1459,1507,1507,176],[113,136.5,211,343.5,538,1128,1321.5,1455,1529.5,1553,1496,1295,371,170],[5,187,375,557,557,5],[177,207.8,300,448,646,846,994,1085.5,1116,1116,953,341,177],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,743,500,140.9],[177,207.8,300,448,646,846,994,1085.5,1116,1116,768,525,177],[113,136.5,211,343.5,538,1128,1321.5,1455,1529.5,1553,1496,955,712,170],[149,179.4,270.5,409.6,584,798.5,985,1106,1145,1130.5,1074,909.5,670,473.5,292],[50,1438,876,612],[144,344,1332,1532,1532,144],[187,1369,1369,1330,197,187],[220,1456,1456,220],[-102,63,843,678],[253,492,492,253],[134,755,857,1737,1570,134],[161,189.3,274,406.5,578,1435,1620.9,1764.5,1856.4,1887,1858.8,1774,1641.5,1470,613,430.3,286,192.3],[138,241.5,348,515.3,641,719,1168,1168,1063,954,786.3,661,583,138],[243,400,1070,1214,1320,1432,1431,1274,604,462.4,355.5,243],[245,566,719,1431,1431,1109,956,245],[254,1408,1408,254],[268,1422,1422,268]],this.OUTLINE_Y=[[],[1489,0,0,1489],[1556,977,977,1556,1556],[421,0,0,421,932,1067,1489,1489,1067,556],[85,-361,-361,238.1,380,1231,1576,1576,1185,1071.5,935,283],[1075,880.5,743,0,-29,-1.8,80,217.8,413,607.5,745,1489,1517,1489.8,1408,1270.3],[409,230.9,90.5,-.6,-31,0,909,1333.4,1432.5,1498.1,1520,1490,1412,1301.5,1174],[1556,977,977,1556],[572,286.3,31,-412,-412,1556,1556,1113,857.8],[-412,-412,31,286.3,572,857.8,1113,1556,1556],[886,776,630,630,777,887,1299,1409,1556,1556,1410,1300],[572,27,27,572,732,1277,1277,732],[-370,-370,285,285],[561,561,742,742],[0,0,285,285],[-304,-304,1556,1556],[743,400,159,16.5,-31,15.9,156.5,397.4,745,1084.9,1326.5,1470.9,1519,1471.6,1329.5,1088.1],[0,0,152,1494,1494,1286],[0,0,171,1110,1279.4,1409.5,1492.4,1520,1491,1427,209],[63,-1.5,-31,2.5,106,254,441,1161,1320,1436,1500,1520,1490.5,1426,272],[419,0,0,419,579,1489,1489,649],[56,-5.5,-31,6.5,114,274,473,1489,1489,267],[654,324,104,3,-31,4.9,112.5,276.9,483,1494,1512,1517,1453.5,1277,1005],[1314,0,0,1266,1489,1489],[411,233.5,91,-2.8,-34,-2,94,238.3,415,1144,1294.5,1416,1496.3,1523,1495,1411,1285,1131],[1005,-6,-23.5,-29,33,209,480,834,1171.5,1385,1485.5,1519,1483.3,1376,1211.8],[0,0,1117,1117],[-370,-370,285,1117,1117],[590,77,1227,714],[362,362,942,942],[77,590,714,1227],[1245,0,0,964.5,1139,1293.4,1414.5,1492.9,1519,1497.5,1449],[647,291,15,-162.5,-226,-218.5,-190,157,394,663,1013.5,1283,1457,1519,1452,1268,991.5],[0,0,1489,1489],[0,0,28,122,262,458,1155,1316.5,1427,1477,1489,1489],[743,402.5,161,18.5,-27,-13.5,19,63,108,1385,1487,1516,1465,1317,1072],[0,0,28,119,375,743,1118,1371,1457.5,1489,1489],[0,0,1489,1489],[0,0,717,1313,1489,1489],[746,405.5,163,19,-29,12.5,110,749,1382,1485.5,1516,1464.4,1309.5,1065.4],[0,0,1489,1489],[0,0,1489,1489],[8,-12.5,-21,5.5,85,213.5,387,1489,1489,193],[0,0,1489,1489],[0,0,176,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,709,855.5,1039,1254,1396,1466.5,1489,1489],[744,415,172,21,-297.5,-369.1,-393,-386.5,-365,-183,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1280.5,1409,1471.5,1489,1489],[92,3,-27,9,109,253,425,1412,1486,1516,1486.1,1396.5,1260.1,1090,340],[1313,0,0,1313,1489,1489],[598,313,115,6,-31,4,115,315.5,598,1489,1489],[1489,0,0,1489,1489],[1489,0,0,1489,1489],[0,0,1489,1489],[1489,0,0,1489,1489],[0,0,176,1489,1489,184],[-392,-392,1556,1556],[1556,-304,-304,1556],[-392,-392,1556,1556],[682,682,684,1489,1489],[-300,-300,-180,-180],[1676,1302,1302,1676],[324,182.8,69,-6,-31,0,758,939,1058,1124.5,1144,1126,1093],[0,-31,8.5,127,315,567,812.8,996,1110,1556,1556],[557,300,118,10.5,-25,0,70,1050,1116,1143,1104,987,801.5],[550,306.8,123,7.5,-31,0,1556,1556,992,803],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1016,1115,1148,1107.8,987,797.8],[959,0,0,959,1374,1546,1560,1566,1539.4,1459.5,1117],[569,-375,-410.5,-423,-389.8,-290,-119.3,127,1117,1148,1108.5,998,817.5],[0,0,725,906,1039,1556,1556],[1304,0,0,1304,1499,1499],[-395,-415,-423,-398,-323,-199,-27,1304,1499,1499,1117,-216],[0,0,1117,1556,1556],[0,0,1556,1556],[0,0,725,902.9,1036.5,1120.1,1148,1148,1117],[0,0,725,906,1039,1120.8,1148,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1108.4,1148,1108.4,989.5,802.4],[-412,-412,133,323.5,572,813.4,995.5,1109.9,1148,1117],[555,314.1,131.5,16.4,-412,-412,1117,1148,1108,995,809.5],[0,0,912,1105,1114.5,1117,1117],[67,2.5,-27,-2.5,71,182.8,322,1060,1119.5,1144,1116.5,1042,933,803,278],[959,189.8,70,1,-22,-13,10,1117,1438,1438,1117],[392,209.1,76.5,-4.1,-31,0,1117,1117],[1117,0,0,1117,1117],[1117,0,0,1117,1117],[0,0,1117,1117],[1117,-412,-412,1117,1117],[0,0,159,1117,1117,139],[504,-170.9,-292.5,-367.1,-392,-392,1556,1556,1531.1,1456.5,1334.9,660],[-392,-392,1556,1556],[-392,-392,-367.1,-292.5,-170.9,504,660,1334.9,1456.5,1531.1,1556,1556],[395,395,396,440,561,732,927,927,926,880.5,761,589.5],[],[0,0,1489,1489],[557,333.5,163,-361,-361,74,1046,1475,1475,948.5,775.9],[0,0,171,1467,1501,1518,1485.9,1389.5,1243.1,751,207],[258,145,147,257,1067,1176,1176,1066],[1489,426,0,0,426,1489,1489],[-392,-392,1556,1556],[533,-327,-371.5,-385,-358,-275,-156,-10,601,1462,1505,1519,1490,1411,1293.5,1147],[1304,1304,1499,1499],[655,323.1,43.5,-146.6,-210,-146.6,43.5,323.1,655,986.9,1266.5,1456.6,1520,1456.6,1266.5,986.9],[833,616,531,554,1192,1332.4,1435.5,1498.9,1520,1504,1475],[608,162,191,1113,1142,697],[602,57,57,762,762],[561,561,742,742],[655,323.1,43.5,-146.6,-210,-146.6,43.5,323.1,655,986.9,1266.5,1456.6,1520,1456.6,1266.5,986.9],[1788,1668,1668,1788],[1116,960.4,831.5,744.9,716,745,832,961,1116,1271,1400,1487,1516,1487,1400,1271],[179,179,917,1462,1462,917],[566,566,711,1237,1350.4,1440.5,1519,1501.5,1458,722],[585,542,527,543.5,595,685.5,817,1278,1374.5,1452,1520,1502.5,1458,764],[1302,1302,1676,1676],[-412,-412,0,1117,1117],[1050,866,-363,-363,1489,1489,1460,1373,1234.3],[511,511,794,794],[-397,-416,-423,-337,-232,-89,-25,20,20,-237],[1256,566,566,688,1493,1493,1368],[1025,820.1,663.5,564.1,531,563.4,660.5,816.4,1025,1233.8,1390,1487.5,1520,1486.8,1387,1230],[191,162,608,697,1142,1113],[1246,0,0,220,353,944,1489,1493,1493,1363],[1246,0,0,139,664,865,1489,1493,1493,1363],[598,0,0,220,353,944,1489,1517,1500,1456,773],[350,195.6,74.5,-3.9,-30,-10,40,244,1489,1489,523],[0,0,1675,2049,2049],[0,0,2049,2049,1675],[0,0,1670,2049,2049,1670],[0,0,1992,1992,1987,1910,1682],[0,0,1872,1872,1872],[0,0,1712,1843.5,1952,2024.8,2049,2024.8,1952,1843.5,1712],[0,0,1489,1489],[743,402.5,-397,-416,-423,-337,108,1385,1487,1516,1465,1317,1072],[0,0,1489,2049,2049,1489],[0,0,1489,2049,2049,1489],[0,0,1489,2049,2049,1489],[0,0,1489,1872,1872,1489],[0,0,1489,2049,2049,1489],[0,0,2049,2049,1489],[1670,0,0,1670,2049,2049],[1677,0,0,1677,1872,1872],[740,0,0,28,119,375,743,1118,1371,1457.5,1489,1489,883],[0,0,1489,1992,1992,1987,1910,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,2049,2049,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,2049,2049,1318,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1670,2049,2049,1670,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1992,1992,1987,1910,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1872,1872,1872,1070.5],[216,105,105,216,1088,1199,1199,1088],[744,-146,-146,20,172,414.5,744,1611,1611,1520,1468,1318,1070.5],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,1872,1872,1489],[1489,0,0,1489,2049,2049],[0,0,469,610.5,787,992,1130,1489,1489],[0,-24,12.4,121.5,284.1,481,1241,1376,1479,1544.3,1566,1536.5,1449,1295.5,1080],[324,182.8,69,-6,-31,0,758,939,1676,1676,1093],[324,182.8,69,-6,-31,0,758,1676,1676,1093],[324,182.8,69,-6,-31,0,758,1297,1676,1676,1297,1093],[324,182.8,69,-6,-31,0,758,1619,1619,1614,1537,1309],[324,182.8,69,-6,-31,0,758,1499,1499,1093],[324,182.8,69,-6,-31,0,758,1630,1761.8,1871,1944.5,1969,1944.5,1871,1761.8,1630],[317,178.8,68,-4.8,-29,-26,3.5,68,559,641,861.3,1020,1116,1148,1146,1127,1093],[557,300,-397,-416,-423,-337,-232,70,1050,1116,1143,1104,987,801.5],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1016,1676,1676,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1676,1676,987,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1297,1676,1676,1297,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1499,1499,797.8],[1676,0,0,1302,1676],[1302,0,0,1676,1676],[1297,0,0,1297,1676,1676],[1304,0,0,1304,1499,1499],[484,266.5,104,2.8,-31,12,141,351,637,1469,1566,1556],[0,0,725,1619,1619,1614,1537,1309,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1676,1676,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1676,1676,989.5,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1297,1676,1676,1297,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,1619,1619,1614,1537,1309],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1499,1499,1499,802.4],[572,7,7,572,732,1297,1297,732],[-148,-148,8.5,127,313.8,558,1241,1241,1108.4,989.5,802.4,558],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1499,1499,1117],[1117,-412,-412,1117,1676,1676],[-412,-412,133,323.5,572,813.4,995.5,1109.9,1556,1556],[-370,-370,285,1117,1117],[1676,1292,1292,1676],[1304,1292,1292,1304,1499,1676,1676,1499],[1489,0,0,1489],[832,832,1117,1117],[1489,1105,0,0,1489,1489],[1489,1105,0,0,1489,1489],[1489,1105,0,0,1489,1489],[1489,1105,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520],[1489,1105,0,0,1489,1489],[1489,1105,0,0,174,894,1144.8,1345,1476.3,1520],[1304,0,0,1304,1499,1676,1676,1499],[0,0,1489,1489],[0,0,28,122,262,458,1155,1316.5,1427,1477,1489,1489],[0,0,1313,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,176,1489,1489,184],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1489,1489],[0,0,709,855.5,1039,1254,1396,1466.5,1489,1489],[0,0,176,1489,1489,184],[1313,0,0,1313,1489,1489],[1489,0,0,1489,1489],[755,507,325,-16,-16,325,506.5,755,994,1171,1505,1505,1171,993],[0,0,1489,1489],[910,647,471,0,0,471,645.5,910,1489,1489],[0,0,174,894,1144.8,1345,1476.3,1520,1476.3,1345,1144.8,894,174],[1677,0,0,1677,1872,1872],[1489,0,0,1489,1872,1872,1872],[550,306.8,123,7.5,-31,0,1117,1676,1676,803],[306,148.5,46,-10,-26,-5,64,270,1083,1676,1676,986.5,839],[0,-412,-412,725,906,1676,1676,1117],[1676,0,0,1676],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1499,1676,1676,1499,1117],[550,306.8,123,7.5,-31,0,1117,1148,1108,992,803],[-412,-412,110,259.5,444,1195,1355,1467,1534.5,1556,1524.3,1429,1277.8,1078],[1117,-412,-412,1117,1117],[534,299.6,120.5,6.9,-31,7.8,124,308.3,551,1556,1556],[306,148.5,46,-10,-26,-5,64,270,1083,1127.5,1144,1128,1079,986.5,839],[463,262.3,118,-412,-412,-264.5,-96,1556,1556],[0,-412,-412,725,906,1039,1120.8,1148,1117],[768,451.5,241,37.5,-31,37.5,241,451.5,768,1073,1288,1487,1556,1487,1288,1073.5],[0,0,1117,1117],[0,0,1117,1118,1119,1117],[0,0,1556,1556],[-412,-412,0,1117,1117],[1117,0,0,1117,1117],[412,248.5,113,-412,-412,-265,-96,1556,1556],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1108.4,1148,1108.4,989.5,802.4],[0,0,1117,1117],[-412,-412,148.5,340.9,577,821.5,1001,1111.3,1148,1115,1020,861.5,646],[549,299,129,-412,-412,-268,-96,1079,1124.5,1143,1102.5,981,792],[558,313.8,127,8.5,-31,7.5,123,308.8,952,1117,1148,1108.6,990.5,803.6],[952,0,0,952,1117,1117],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1117],[546,314,142,-412,-412,159,342.3,576,816.6,996.5,1108.6,1146,1145.5,1143,1117,842],[-412,-412,1117,1117],[446,248.5,-412,-412,248,446,1117,1117],[503,310.5,139,16.5,-30,-30,14.5,139,310.5,503,811.5,1117,1117,811.5],[1304,0,0,1304,1499,1499],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1499,1499,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1676,1676,802.4],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1676,1676,1117],[503,310.5,139,16.5,-30,-30,14.5,139,310.5,503,811.5,1676,1676,811.5],[424,240.1,94.5,-.4,-32,17,190,493,837,1097,1286,1464.5,1519,1496.5,1430],[0,0,1489,1489],[1315,-193,-193,1315,1489,1489],[-189,-189,-13,1489,1489,2],[572,572,732,732],[0,0,1489,1489],[511,511,794,794],[842,-151,-151,1788,1788,981],[642,447.6,292.5,190.9,157,157,190.4,290.5,450.4,663,857.4,1012.5,1114.1,1148,1148,1114.5,1014,854],[-402,-417.5,-423,-395.5,-313,-179.8,1367,1545,1560.5,1566,1538.5,1456,1321.8,-224],[202,202,209,233.4,306.5,588,1104,1104,1097,1072.5,999,719],[362,27,27,362,942,1277,1277,942],[0,0,1393,910],[0,0,910,1393]],this.KERN_C1=["'","'","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-",".",".","A","A","A","A","A","A","A","A","A","A","A","A","B","B","B","B","C","D","D","D","D","D","D","D","F","F","F","F","F","F","F","F","F","F","F","F","F","I","J","J","J","J","K","K","K","K","K","K","K","K","K","K","K","K","L","L","L","L","L","L","L","L","L","L","L","L","L","L","O","O","O","O","O","O","P","P","P","P","P","P","P","P","P","P","Q","Q","R","R","R","R","R","R","R","R","R","R","S","S","S","S","S","S","S","S","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","U","U","U","U","V","V","V","V","V","V","V","V","V","V","V","V","V","V","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","X","X","X","X","X","X","X","X","X","X","X","X","X","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","a","a","a","b","b","b","c","c","e","f","f","f","f","f","f","f","f","f","f","f","f","h","h","h","k","k","k","k","m","m","m","n","n","n","o","o","o","o","o","p","p","p","r","r","r","r","r","t","t","v","v","v","v","v","v","v","v","w","w","w","w","w","x","x","x","x","x","x","x","x","y","y","y","y","y","y","y","y","y","y","y","y","y","z","z","z","z","z","z","z","z","z","","","","","","","","","","","","",""],this.KERN_C2=["","A","","","z","y","x","w","v","a","Z","Y","X","W","V","T","S","J","I","A","-",",","y","w","v","u","t","Y","W","V","U","T","S","-","T",".","-",",","-","Z","Y","X","W","T",".",",","","","","o","e","a","T","A","?",";",":",".",",","-","","A",".",",","","","","y","w","v","u","o","e","a","O","-","","","y","v","Y","W","V","T","O","J","G","C","-","'","Z","Y","X","T",".",",","","","","o","e","a","Y","A",".",",",".",",","","","y","u","o","e","a","Y","T","-","","y","w","v","S","A",".",",","","","","","","z","y","w","v","u","s","r","o","g","e","c","a","T","S","O","G","C","A","?",";",":",".","-",",","","A",".",",","","","","y","u","o","e","a","A",";",":",".","-",",","","","","y","u","r","o","e","a","A",";",":",".","-",",","","","","","y","u","o","e","a","O","G","C","-","","","","","v","u","s","r","q","p","o","n","m","g","e","d","a","O","A",";",":",".","-",",","","","","","y","w","o","e","a","Z","O","G","C","-","y","w","v","y",".",",","T","-","T","}","y","]","\\","?",".","-",",","*",")","'",'"',"y","w","v","","o","e","-","y","w","v","y","w","v","y","x","v",".",",","y",".",",","","a",".","-",",","y","-","","","o","e","a",".","-",",","","a",".","-",",","","","o","g","e","d","c","-","","","","q","o","g","e","d","c","a",".","-",",","","","q","o","g","e","d","c","-","-","-","Z","Y","X","T",".",",","y","x","v",".",","],this.KERN_K=[100,100,20,50,40,40,50,20,40,20,30,140,80,50,50,150,20,100,30,50,160,130,50,30,50,10,20,80,50,60,10,120,10,50,60,20,-10,20,50,20,20,10,20,50,50,50,50,100,110,50,50,100,-30,100,-60,60,60,300,300,30,10,10,20,20,70,60,20,80,70,80,50,70,70,60,20,110,20,20,110,110,160,100,110,170,20,-100,20,20,160,120,20,20,10,50,30,30,50,50,70,50,50,50,-20,50,300,300,30,30,50,50,55,20,50,50,40,20,60,100,20,30,20,30,22,20,20,20,220,240,50,130,40,170,200,200,200,200,180,200,220,210,220,220,240,70,12,50,40,40,120,-60,200,200,290,150,290,20,10,20,20,100,100,70,65,60,100,100,100,60,80,80,290,50,290,100,100,60,65,60,60,100,100,100,50,80,80,220,50,290,60,50,10,10,80,30,60,60,50,10,10,10,80,130,140,20,80,100,110,110,100,130,100,130,100,100,130,130,120,140,20,80,200,200,290,140,290,60,50,20,20,65,40,60,60,50,10,20,20,20,60,16,10,16,5,20,30,60,20,140,-100,10,-100,-100,-110,120,50,130,-50,-100,-60,-60,20,10,20,20,20,20,100,20,10,20,20,10,20,15,20,15,20,30,5,20,30,40,36,290,20,290,10,40,18,40,18,18,40,180,40,180,20,20,70,20,70,24,20,24,10,24,10,20,50,18,40,18,10,18,10,18,10,18,40,190,40,190,12,10,10,12,10,12,10,10,20,50,20,20,20,10,50,30,30,15,20,15,20,30],this.pathCache=[],this.pathMissing=null,this.ctxReference=null;for(let t=this.GLYPH_DATA.length-1;t>=0;t--)this.pathCache[t]=null}getKerning(t,e){const s=this.KERN_K.length;for(let i=0;i<s;i++)if(this.KERN_C1[i]==t&&this.KERN_C2[i]==e)return-this.KERN_K[i];return 0}static measureText(t,e){return this.main.measureText(t,e)}measureText(t,e){let s=Ue.main,i=e/s.UNITS_PER_EM,o=0;for(let e=0;e<t.length;e++){let i=t.charAt(e),n=this.getIndex(i);n<0?o+=s.MISSING_HORZ:(o+=s.HORIZ_ADV_X[n],e<t.length-1&&(o+=s.getKerning(i,t.charAt(e+1))))}return[o*i,s.ASCENT*i*s.ASCENT_FUDGE,-s.DESCENT*i]}static measureWidths(t,e){return this.main.measureWidths(t,e)}measureWidths(t,e){let s=Ue.main,i=e/s.UNITS_PER_EM,o=[0],n=0;for(let e=0;e<t.length;e++){let l=t.charAt(e),r=this.getIndex(l);r<0?(n+=s.MISSING_HORZ,o.push(n*i)):(n+=s.HORIZ_ADV_X[r],e<t.length-1&&(n+=s.getKerning(l,t.charAt(e+1))),o.push(n*i))}return o}getIndex(t){return this.UNICODE.indexOf(t)}getRawGlyph(t){return this.GLYPH_DATA[t]}getGlyphPath(t){let e=this.pathCache[t];return null!=e||(e=new Path2D(this.GLYPH_DATA[t]),this.pathCache[t]=e),e}getMissingPath(){return this.pathMissing||(this.pathMissing=new Path2D(this.MISSING_DATA)),this.pathMissing}getOutlineX(t){return this.OUTLINE_X[t].slice(0)}getOutlineY(t){return this.OUTLINE_Y[t].slice(0)}initNativeFont(t){if(null!=t||!this.ctxReference)if(null==t){let t=b("<canvas/>").appendTo(document.body);this.ctxReference=t.el.getContext("2d"),t.remove()}else this.ctxReference=t}static measureTextNative(t,e,s,i={}){return this.main.measureTextNative(t,e,s,i)}measureTextNative(t,e,s,i={}){if(!this.ctxReference)throw"Calling measureTextNative without having called initNativeFont first";this.ctxReference.save();let o="";i.bold&&(o+="bold "),i.italic&&(o+="italic "),this.ctxReference.font=o+s+"px "+e;let n=this.ctxReference.measureText(t);this.ctxReference.restore();const l=this.ASCENT_FUDGE*this.ASCENT/this.UNITS_PER_EM;return[n.width,s*l,s*(-this.DESCENT/this.ASCENT)*l]}}Ue.main=new Ue;class Ye{constructor(t){if(t)this.data=ft(t);else{t={name:"default",pointScale:20,resolutionDPI:100,fontSize:.65,lineSize:.075,bondSep:.2,defaultPadding:.2,foreground:0,background:16777215,atomCols:new Array(112)};for(let e=0;e<=111;e++)t.atomCols[e]=0;this.data=t}}static defaultBlackOnWhite(t){let e=new Ye;return t&&(e.data.pointScale=t),e}static defaultWhiteOnBlack(t){let e=new Ye;t&&(e.data.pointScale=t),e.data.foreground=16777215,e.data.background=0;for(let t=0;t<=111;t++)e.data.atomCols[t]=16777215;return e}static defaultColourOnWhite(t){let e=Ye.defaultBlackOnWhite(t);return e.data.atomCols[0]=4210752,e.data.atomCols[1]=8421504,e.data.atomCols[6]=0,e.data.atomCols[7]=255,e.data.atomCols[8]=16711680,e.data.atomCols[9]=16744576,e.data.atomCols[15]=16744448,e.data.atomCols[16]=8421376,e.data.atomCols[17]=49152,e.data.atomCols[35]=12599296,e}static defaultColourOnBlack(t){let e=Ye.defaultWhiteOnBlack(t);return e.data.atomCols[0]=10526880,e.data.atomCols[1]=8421504,e.data.atomCols[6]=16777215,e.data.atomCols[7]=4210943,e.data.atomCols[8]=16728128,e.data.atomCols[9]=16744576,e.data.atomCols[15]=16744448,e.data.atomCols[16]=16776960,e.data.atomCols[17]=4259648,e.data.atomCols[35]=16744512,e}static defaultPrintedPublication(){let t=Ye.defaultBlackOnWhite(9.6);return t.data.resolutionDPI=600,t.data.fontSize=.8,t.data.bondSep=.27,t.data.lineSize=.0625,t}}class Xe{constructor(){this.colAtom={},this.colBond={},this.dottedRectOutline={},this.dottedBondCross={},this.hideAtoms=new Set,this.hideBonds=new Set,this.atomFrameDotSz=[],this.atomFrameCol=[],this.atomCircleSz=[],this.atomCircleCol=[],this.atomDecoText=[],this.atomDecoCol=[],this.atomDecoSize=[],this.bondDecoText=[],this.bondDecoCol=[],this.bondDecoSize=[],this.overlapAtoms=[]}}!function(t){t[t.Normal=1]="Normal",t[t.Inclined=2]="Inclined",t[t.Declined=3]="Declined",t[t.Unknown=4]="Unknown",t[t.Dotted=5]="Dotted",t[t.DotDir=6]="DotDir",t[t.IncDouble=7]="IncDouble",t[t.IncTriple=8]="IncTriple",t[t.IncQuadruple=9]="IncQuadruple"}(we||(we={}));class He{constructor(t,e,s,i=new Xe){this.mol=t,this.measure=e,this.policy=s,this.effects=i,this.points=[],this.lines=[],this.rings=[],this.paths=[],this.space=[],this.wantArtifacts=!0,this.artifacts=null,this.bondOrder=[],this.atomCharge=[],this.atomUnpaired=[],this.artifactCharge=new Map,this.artifactUnpaired=new Map,this.artifactFract=new Map}static guestimateSize(t,e,s,i){let o=t.boundary(),n=o.minX(),l=o.minY(),r=o.maxX(),a=o.maxY(),h=e.data.fontSize*this.FONT_CORRECT;for(let e=1;e<=t.numAtoms;e++)if(t.atomExplicit(e)){let s=0;for(let i of t.atomElement(e))"|{}^".includes(i)||s++;let i=t.atomHydrogens(e)>0?1:0;const o=.35*h*(s+i),u=.5*h*(1+i),m=t.atomX(e),d=t.atomY(e);n=Math.min(n,m-o),r=Math.max(r,m+o),l=Math.min(l,d-u),a=Math.max(a,d+u)}let u=Math.max(1,r-n)*e.data.pointScale,m=Math.max(1,a-l)*e.data.pointScale;return s>0&&u>s&&(m*=s/u,u=s),i>0&&m>i&&(u*=i/m,m=i),[u,m]}getMolecule(){return this.mol}getMeasure(){return this.measure}getPolicy(){return this.policy}getEffects(){return this.effects}getScale(){return this.scale}setWantArtifacts(t){this.wantArtifacts=t}getArtifacts(){return this.artifacts}setArtifacts(t){this.artifacts=t}arrange(){const{mol:t,measure:e,policy:i,effects:o}=this;this.scale=e.scale(),this.bondSepPix=i.data.bondSep*e.scale(),this.lineSizePix=i.data.lineSize*e.scale(),this.fontSizePix=i.data.fontSize*e.scale()*He.FONT_CORRECT,this.ymul=e.yIsUp()?-1:1;let n=null;if(this.wantArtifacts&&null==this.artifacts){this.artifacts=new Dt(t),n=s.booleanArray(!1,t.numAtoms);for(let t of this.artifacts.getResPaths())for(let e of t.atoms)n[e-1]=!0;for(let t of this.artifacts.getResRings())for(let e of t.atoms)n[e-1]=!0;for(let t of this.artifacts.getArenes()){n[t.centre-1]=!0;for(let e of t.atoms)n[e-1]=!0}}this.setupBondOrders();for(let e=1;e<=t.numAtoms;e++){if(t.atomElement(e).length>2&&0==t.atomHydrogens(e)){this.points.push(null),this.space.push(null);continue}let s={anum:e,text:t.atomExplicit(e)||this.atomIsWeirdLinear(e)?t.atomElement(e):null,fsz:this.fontSizePix,bold:t.atomMapNum(e)>0,col:this.policy.data.atomCols[t.atomicNumber(e)],oval:new p(this.measure.angToX(t.atomX(e)),this.measure.angToY(t.atomY(e)),0,0)},i=this.effects.colAtom[e];if(i&&(s.col=i),n&&n[e-1]&&"C"==t.atomElement(e)&&(s.text=null),null!=s.text){let t=this.measure.measureText(s.text,s.fsz);const e=1.1;s.oval.rw=.5*t[0]*e,s.oval.rh=.5*t[1]*e}this.points.push(s),this.space.push(this.computeSpacePoint(s))}for(let e=1;e<=t.numAtoms;e++)null==this.points[e-1]&&this.processLabel(e);let l=s.booleanArray(!1,t.numBonds);for(let s=1;s<=t.numBonds;s++){let i=t.bondFrom(s),o=t.bondTo(s),n=t.bondType(s),r=this.bondOrder[s-1];if(r<0)continue;let a=this.effects.colBond[s];a||(a=this.policy.data.foreground),l[s-1]=2==r&&(n==ne.BONDTYPE_NORMAL||n==ne.BONDTYPE_UNKNOWN);let h=this.points[i-1],u=this.points[o-1],m=h.oval.cx,d=h.oval.cy,c=u.oval.cx,p=u.oval.cy;if(Math.abs(c-m)<=1&&Math.abs(p-d)<=1){l[s-1]=!1;continue}if(l[s-1])continue;let g=(1==r&&n==ne.BONDTYPE_NORMAL?.25:.5)*e.scale(),b=this.backOffAtom(i,m,d,c,p,g),A=this.backOffAtom(o,c,p,m,d,g);this.ensureMinimumBondLength(b,A,m,d,c,p,g);let y=this.lineSizePix,E=0,M=we.Normal;if(1==r&&n==ne.BONDTYPE_INCLINED?(M=we.Inclined,E=.15*e.scale()):1==r&&n==ne.BONDTYPE_DECLINED?(M=we.Declined,E=.15*e.scale()):n==ne.BONDTYPE_UNKNOWN?(M=we.Unknown,E=.2*e.scale()):0==r?M=n==ne.BONDTYPE_INCLINED||n==ne.BONDTYPE_DECLINED?we.DotDir:we.Dotted:2!=r&&3!=r&&4!=r||n!=ne.BONDTYPE_INCLINED&&n!=ne.BONDTYPE_DECLINED||(M=2==r?we.IncDouble:3==r?we.IncTriple:we.IncQuadruple,E=(2==r?.2:.25)*e.scale()),0==r){let e=A[0]-b[0],s=A[1]-b[1],n=1/U(e,s),l=.5*e*n*this.bondSepPix,r=.5*s*n*this.bondSepPix;t.atomAdjCount(i)>1&&(b[0]+=l,b[1]+=r),t.atomAdjCount(o)>1&&(A[0]-=l,A[1]-=r)}if(1!=r&&n==ne.BONDTYPE_DECLINED&&([b,A]=[A,b]),r>1&&(n==ne.BONDTYPE_NORMAL||n==ne.BONDTYPE_UNKNOWN)){let t=this.orthogonalDelta(b[0],b[1],A[0],A[1],this.bondSepPix),e=-.5*(r-1);for(let n=0;n<r;n++,e++){let n=b[0]+e*t[0],l=b[1]+e*t[1],r=A[0]+e*t[0],h=A[1]+e*t[1],u={bnum:s,bfr:i,bto:o,type:M,line:new f(n,l,r,h),size:y,head:E,col:a};this.lines.push(u),this.space.push(this.computeSpaceLine(u))}}else{let t={bnum:s,bfr:i,bto:o,type:M,line:new f(b[0],b[1],A[0],A[1]),size:y,head:E,col:a};this.lines.push(t),this.space.push(this.computeSpaceLine(t))}}let r=this.orderedRingList();for(let e=0;e<r.length;e++)for(let s=0;s<r[e].length;s++){let i=t.findBond(r[e][s],r[e][s<r[e].length-1?s+1:0]);l[i-1]&&(this.processDoubleBond(i,r[e]),l[i-1]=!1)}for(let e=1;e<=t.numBonds;e++)l[e-1]&&this.processDoubleBond(e,this.priorityDoubleSubstit(e));let a=s.numberArray(0,t.numAtoms);for(let e=1;e<=t.numAtoms;e++)a[e-1]=null==this.points[e-1].text?0:t.atomHydrogens(e);for(let e=0;e<t.numAtoms;e++)a[e]>0&&this.placeHydrogen(e,a[e],!0)&&(a[e]=0);for(let e=0;e<t.numAtoms;e++)a[e]>0&&this.placeHydrogen(e,a[e],!1);for(let e=1;e<=t.numAtoms;e++)if(t.atomIsotope(e)!=ne.ISOTOPE_NATURAL){let s=t.atomIsotope(e).toString(),o=i.data.atomCols[t.atomicNumber(e)];this.placeAdjunct(e,s,.6*this.fontSizePix,o,150*J)}for(let e=1;e<=t.numAtoms;e++){let s="",o=this.atomCharge[e-1];-1==o?s="-":1==o?s="+":o<-1?s=Math.abs(o)+"-":o>1&&(s=o+"+");for(let t=this.atomUnpaired[e-1];t>0;t--)s+=".";if(0==s.length)continue;let n=i.data.atomCols[t.atomicNumber(e)];this.placeAdjunct(e,s,1==s.length?.8*this.fontSizePix:.6*this.fontSizePix,n,30*J)}for(let t=0;t<o.atomDecoText.length;t++){let e=o.atomDecoText[t];e&&this.annotateAtom(t+1,e,o.atomDecoCol[t],o.atomDecoSize[t]*this.scale*He.FONT_CORRECT)}for(let t=0;t<o.bondDecoText.length;t++){let e=o.bondDecoText[t];e&&this.annotateBond(t+1,e,o.bondDecoCol[t],o.bondDecoSize[t]*this.scale*He.FONT_CORRECT)}for(let e=0;e<Math.min(o.atomCircleSz.length,t.numAtoms);e++)if(o.atomCircleSz[e]>0){let t=o.atomCircleSz[e]*this.scale,s=this.points[e],i=new c(s.oval.cx-t,s.oval.cy-t,2*t,2*t),n={anum:0,bnum:0,box:i,px:[i.minX(),i.maxX(),i.maxX(),i.minX()],py:[i.minY(),i.minY(),i.maxY(),i.maxY()]};this.space.push(n)}if(null!=this.artifacts){for(let t of this.artifacts.getResPaths())this.createCurvedPath(t.atoms,this.artifactFract.get(t),0),this.delocalisedAnnotation(t.atoms,this.artifactCharge.get(t),this.artifactUnpaired.get(t));for(let t of this.artifacts.getResRings())this.createCircularRing(t.atoms),this.delocalisedAnnotation(t.atoms,this.artifactCharge.get(t),this.artifactUnpaired.get(t));for(let e of this.artifacts.getArenes()){let s=e.atoms.length>2;if(s)for(let i=0;i<e.atoms.length;i++){let o=i<e.atoms.length-1?i+1:0;if(0==t.findBond(e.atoms[i],e.atoms[o])){s=!1;break}}let i=2==e.atoms.length;this.createBondCentroid(e.centre,e.atoms),i||(s?this.createCircularRing(e.atoms):this.createCurvedPath(e.atoms,!1,e.centre)),this.delocalisedAnnotation(e.atoms,this.artifactCharge.get(e),this.artifactUnpaired.get(e))}}let h=new Yt(t);for(let t of h.getIDList())this.processPolymerUnit(h.getUnit(t),h.getUnits())}numPoints(){return this.points.length}getPoint(t){return this.points[t]}getPoints(){return this.points}numLines(){return this.lines.length}getLine(t){return this.lines[t]}getLines(){return this.lines}numRings(){return this.rings.length}getRing(t){return this.rings[t]}getRings(){return this.rings}numPaths(){return this.paths.length}getPath(t){return this.paths[t]}getPaths(){return this.paths}numSpace(){return this.space.length}getSpace(t){return this.space[t]}getSpaces(){return this.space}offsetEverything(t,e){for(let s of this.points)s.oval.offsetBy(t,e);for(let s of this.lines)s.line.offsetBy(t,e);for(let s of this.rings)s.cx+=t,s.cy+=e;for(let i of this.paths)s.addTo(i.px,t),s.addTo(i.py,e);for(let i of this.space)i.box.offsetBy(t,e),s.addTo(i.px,t),s.addTo(i.py,e)}offsetOrigin(){let t=this.determineBoundary();0==t[0]&&0==t[1]||this.offsetEverything(-t[0],-t[1])}scaleEverything(t){if(1!=t){this.scale*=t;for(let e of this.points)e.oval.scaleBy(t),e.fsz*=t;for(let e of this.lines)e.line.scaleBy(t),e.size*=t,e.head*=t;for(let e of this.rings)e.cx*=t,e.cy*=t,e.rw*=t,e.rh*=t,e.size*=t;for(let e of this.paths)s.mulBy(e.px,t),s.mulBy(e.py,t),e.size*=t;for(let e of this.space)e.box.scaleBy(t),s.mulBy(e.px,t),s.mulBy(e.py,t)}}determineBoundary(t){if(null==t&&(t=0),0==this.space.length)return[0,0,2*t,2*t];let e=s.numberArray(0,4),i=this.space[0];e[0]=i.box.x,e[1]=i.box.y,e[2]=i.box.x+i.box.w,e[3]=i.box.y+i.box.h;for(let t=this.space.length-1;t>0;t--)i=this.space[t],e[0]=Math.min(e[0],i.box.x),e[1]=Math.min(e[1],i.box.y),e[2]=Math.max(e[2],i.box.x+i.box.w),e[3]=Math.max(e[3],i.box.y+i.box.h);return e}determineBoundaryBox(){let[t,e,s,i]=this.determineBoundary();return new c(t,e,s-t,i-e)}squeezeInto(t,e,i,o,n){null!=n&&n>0&&(t+=n,e+=n,i-=2*n,o-=2*n);let l=this.determineBoundary(0),r=l[2]-l[0],a=l[3]-l[1];if(r>i||a>o){let t=1;r>i&&(t=i/r),a>o&&(t=Math.min(t,o/a)),this.scaleEverything(t),s.mulBy(l,t)}this.offsetEverything(t-l[0]+.5*(i-l[2]+l[0]),e-l[1]+.5*(o-l[3]+l[1]))}limitBounds(t,e){let s=this.determineBoundary(0);if(s[0]==s[2]&&s[1]==s[3])return;let i=Math.min(1,Math.min(t/(s[2]-s[0]),e/(s[3]-s[1])));this.offsetEverything(-s[0],-s[1]),this.scaleEverything(i)}monochromate(t){for(let e of this.points)e.col=t;for(let e of this.lines)e.col=t}clone(){let t=new He(this.mol,this.measure,this.policy,this.effects);t.scale=this.scale,t.bondSepPix=this.bondSepPix,t.lineSizePix=this.lineSizePix,t.fontSizePix=this.fontSizePix,t.ymul=this.ymul;for(let e of this.points)t.points.push(ft(e));for(let e of this.lines)t.lines.push(ft(e));for(let e of this.space)t.space.push(ft(e));return t}setupBondOrders(){const t=this.mol;for(let e=0;e<t.numBonds;e++)this.bondOrder[e]=t.bondOrder(e+1);for(let e=0;e<t.numAtoms;e++)this.atomCharge[e]=t.atomCharge(e+1),this.atomUnpaired[e]=t.atomUnpaired(e+1);let e=(e,s)=>{let i=0,o=0;for(let t of s)i+=this.atomCharge[t-1],o+=this.atomUnpaired[t-1],this.atomCharge[t-1]=this.atomUnpaired[t-1]=0;this.artifactCharge.set(e,i),this.artifactUnpaired.set(e,o);for(let e of s)for(let i of t.atomAdjList(e))if(!s.includes(i)){let s=t.findBond(e,i);this.bondOrder[s-1]>=0&&(this.bondOrder[s-1]=1)}};if(null!=this.artifacts){for(let s of this.artifacts.getResPaths()){let i=0,o=0,n=0;for(let e=0;e<s.atoms.length;e++){i+=t.atomCharge(s.atoms[e]),o+=t.atomUnpaired(s.atoms[e]);let l=t.findBond(s.atoms[e],s.atoms[e<s.atoms.length-1?e+1:0]);l>0&&(n+=t.bondOrder(l))}let l=(2*n-i+o)/s.atoms.length<1;this.artifactFract.set(s,l);for(let e=0;e<s.atoms.length-1;e++){let i=t.findBond(s.atoms[e],s.atoms[e+1]);i>0&&(this.bondOrder[i-1]=l?-1:1)}e(s,s.atoms)}for(let s of this.artifacts.getResRings()){for(let e=0;e<s.atoms.length;e++){let i=t.findBond(s.atoms[e],s.atoms[e<s.atoms.length-1?e+1:0]);i>0&&(this.bondOrder[i-1]=1)}e(s,s.atoms)}for(let s of this.artifacts.getArenes()){let i=2==s.atoms.length;for(let e=0;e<s.atoms.length;e++){if(!i){let i=t.findBond(s.atoms[e],s.atoms[e<s.atoms.length-1?e+1:0]);i>0&&(this.bondOrder[i-1]=1)}let o=t.findBond(s.centre,s.atoms[e]);o>0&&(this.bondOrder[o-1]=-1)}e(s,s.atoms)}}}placeAdjunct(t,e,i,o,n){let l=this.measure.measureText(e,i),r=this.points[t-1],a=r.oval.cx,h=r.oval.cy,u=.55*l[0],m=.55*l[1];if(".."==e){let e=this.mol.atomAdjBonds(t).filter((t=>0==this.mol.bondOrder(t)));if(1==e.length){let s=this.getPoint(this.mol.bondOther(e[0],t)-1),n=s.oval.cx-a,l=s.oval.cy-h,r=1/U(n,l),d=.15*i,c=l*r*2.5*d,f=-n*r*2.5*d,g=1.2*(u+m)*r;return[n,l]=[n*g,l*g],this.points.push({anum:0,text:".",fsz:i,bold:!1,col:o,oval:new p(a+n+c,h+l+f,d,d)}),void this.points.push({anum:0,text:".",fsz:i,bold:!1,col:o,oval:new p(a+n-c,h+l-f,d,d)})}}let d=0,f=0,g=0,b=s.numberArray(0,4),A=s.numberArray(0,4),y=10,E=!1;for(let t=.5*(r.oval.rw+r.oval.rh);!E&&t<1.5*this.measure.scale();t+=.1*this.measure.scale()){const e=5*J;for(let s=0;!E&&s<Math.PI-1e-4;s+=e)for(let i=-1;i<=1;i+=2){let o=s*i+(i>0?e:0),l=n+o,r=t*Math.cos(l),c=t*Math.sin(l)*-this.ymul,p=a+r-u,M=a+r+u,T=h+c-m,x=h+c+m;b[0]=p,A[0]=T,b[1]=M,A[1]=T,b[2]=M,A[2]=x,b[3]=p,A[3]=x;let v=this.countPolyViolations(b,A,null,!1),C=10*v+Math.abs(o)+10*t,N=0==v&&Math.abs(o)<(y+1)*J;if((0==d||N||C<d)&&(d=C,f=r,g=c),N){E=!0;break}}y+=5}r={anum:0,text:e,fsz:i,bold:!1,col:o,oval:new p(a+f,h+g,u,m)},this.points.push(r);let M={anum:0,bnum:0,box:new c(r.oval.cx-u,r.oval.cy-m,2*u,2*m),px:[r.oval.cx-u,r.oval.cx+u,r.oval.cx+u,r.oval.cx-u],py:[r.oval.cy-m,r.oval.cy-m,r.oval.cy+m,r.oval.cy+m]};this.space.push(M)}processLabel(t){let e=this.mol.atomX(t),i=this.mol.atomY(t),o=0,n=0,l=this.mol.atomAdjList(t);for(let t=0;t<l.length;t++){let s=Math.atan2(this.mol.atomY(l[t])-i,this.mol.atomX(l[t])-e)*tt;s>=-15&&s<=15?n+=3:s>=-85&&s<=85?n++:s>85&&s<95||s<-85&&s>-95||(s>165||s<-165?o+=3:o++)}let r=this.mol.atomElement(t),a=r.indexOf("|"),h=r.indexOf("{"),u=0;0==o&&0==n&&a<0&&h<0||(u=o<n?-1:n<o?1:jt.congestionPoint(this.mol,e-1,i)<.5*jt.congestionPoint(this.mol,e+1,i)?-1:1);let m=null,d=null,c=null,f=0;if(a<0&&h<0)0==u?m=[r]:u<0?(m=[r.substring(0,r.length-1),r.substring(r.length-1)],f=1):m=[r.substring(0,1),r.substring(1)];else{let t=[],e=[],i=[],o=r.split("|");u<0&&(o=s.reverse(o));let n="";for(let s=0;s<o.length;s++){let l=u>=0&&0==s||u<0&&s==o.length-1;u<0&&0==f&&s==o.length-1&&(f=t.length);let r=0;n="";for(let a=0;a<o[s].length;a++){let h=o[s].charAt(a);"{"==h||"}"==h?(n.length>0&&(t.push(n.toString()),e.push(r),i.push(l)),n="",r="{"==h?-1:0):"^"==h&&-1==r&&0==n.length?r=1:n+=h}n.length>0&&(t.push(n.toString()),e.push(r),i.push(l))}for(m=t,d=e,c=i;f<m.length-1&&0!=d[f];)f++}let g=s.numberArray(0,m.length),b=0;for(let t=0;t<m.length;t++)g[t]=this.measure.measureText(m[t],this.fontSizePix)[0],null!=d&&0!=d[t]&&(g[t]*=.6),b+=g[t];let A=this.measure.angToX(e),y=this.measure.angToY(i);for(let t=0;t<f;t++)A-=g[t];A-=.5*g[f];for(let e=0;e<m.length;e++){let s={anum:e==f||null!=c&&c[e]?t:0,text:m[e],fsz:this.fontSizePix,bold:!1,col:this.policy.data.atomCols[this.mol.atomicNumber(t)],oval:new p(A+.5*g[e],y,.5*g[e]*1.1,.5*this.fontSizePix*1.1)};null!=d&&0!=d[e]&&(s.fsz*=.6,d[e]<0?s.oval.cy+=.7*s.fsz*(this.measure.yIsUp()?-1:1):s.oval.cy-=.3*s.fsz*(this.measure.yIsUp()?-1:1)),e==f?(this.points[t-1]=s,this.space[t-1]=this.computeSpacePoint(s)):(this.points.push(s),this.space.push(this.computeSpacePoint(s))),A+=g[e]}}atomIsWeirdLinear(t){let e=this.mol.atomAdjBonds(t);if(2!=e.length)return!1;for(let t=0;t<e.length;t++)if(3==this.mol.bondOrder(e[t]))return!1;let s=this.mol.atomAdjList(t),i=Math.atan2(this.mol.atomY(s[0])-this.mol.atomY(t),this.mol.atomX(s[0])-this.mol.atomX(t)),o=Math.atan2(this.mol.atomY(s[1])-this.mol.atomY(t),this.mol.atomX(s[1])-this.mol.atomX(t));return Math.abs(st(i,o))>=175*J}backOffAtom(t,e,s,i,o,n){if(e==i&&s==o)return[e,s];let l=!1,r=0,h=0,u=0,m=0;for(let n=0;n<this.space.length;n++){let d=this.space[n];if(d.anum!=t)continue;const c=d.px.length;if(0!=c)for(let t=0;t<c;t++){let n=t<c-1?t+1:0,p=d.px[t],f=d.py[t],g=d.px[n],b=d.py[n];if(!a.doLineSegsIntersect(e,s,i,o,p,f,g,b))continue;let A=a.lineIntersect(e,s,i,o,p,f,g,b);l||(r=e-i,h=s-o,u=U(r,h),m=u,l=!0),m=Math.min(m,U(A[0]-i,A[1]-o))}}if(l){m=Math.max(n,m-.1*this.measure.scale());let t=1/u;return[i+m*t*r,o+m*t*h]}return[e,s]}ensureMinimumBondLength(t,e,s,i,o,n,l){let r=e[0]-t[0],a=e[1]-t[1],h=X(r,a);if(h>=V((l=Math.min(l,U(o-s,n-i)))-1e-4))return;let u=Math.sqrt(h),m=U(t[0]-s,t[1]-i),d=U(o-e[0],n-e[1]),c=1-l/u,p=1/(m+d),f=m*c*p,g=d*c*p;t[0]-=r*f,t[1]-=a*f,e[0]+=r*g,e[1]+=a*g}orderedRingList(){let t=[],e=[6,5,7,4,3];for(let s=0;s<e.length;s++){let i=this.mol.findRingsOfSize(e[s]);for(let e=0;e<i.length;e++)t.push(i[e])}let i=t.length,o=s.numberArray(0,this.mol.numAtoms);for(let e=0;e<i;e++){let s=t[e];for(let t=0;t<s.length;t++)o[s[t]-1]++}let n=s.numberArray(0,i);for(let e=0;e<i;e++){let s=t[e];for(let t=0;t<s.length;t++)n[e]+=o[s[t]-1]}let l=s.idxSort(n),r=s.numberArray(0,i),a=0;for(let e=0;e<i;e++){let s=t[l[e]];for(let t=0;t<s.length;t++){let i=this.mol.findBond(s[t],s[t+1<s.length?t+1:0]);2==this.mol.bondOrder(i)&&r[e]++}a=Math.max(a,r[e])}let h=[];for(let e=a;e>=0;e--)for(let s=0;s<i;s++)r[s]==e&&h.push(t[l[s]]);return h}orthogonalDelta(t,e,s,i,o){let n=e-i,l=s-t,r=X(n,l),a=r>0?o/Math.sqrt(r):1;return[n*a,l*a]}processDoubleBond(t,e){let s=this.mol.bondFrom(t),i=this.mol.bondTo(t),o=this.mol.atomAdjList(s),n=this.mol.atomAdjList(i),l=this.points[s-1],r=this.points[i-1],a=l.oval.cx,h=l.oval.cy,u=r.oval.cx,m=r.oval.cy;const d=.5*this.measure.scale();let c=this.backOffAtom(s,a,h,u,m,d),p=this.backOffAtom(i,u,m,a,h,d);this.ensureMinimumBondLength(c,p,a,h,u,m,d),a=c[0],h=c[1],u=p[0],m=p[1];let g=u-a,b=m-h,A=Math.atan2(b,g),y=0,E=0,M=0,T=0,x=0,v=0,C=0,N=0,S=!1;for(let t=0;t<o.length;t++)if(o[t]!=i){let i=this.mol.bondOrder(this.mol.findBond(s,o[t]));if(0==i)continue;if(i>1){S=!0;break}let n=!1;for(let s=0;s<(null==e?0:e.length);s++)e[s]==o[t]&&(n=!0);let l=st(Math.atan2(this.points[o[t]-1].oval.cy-h,this.points[o[t]-1].oval.cx-a),A);if(Math.abs(l)*tt>175){S=!0;break}l>0?(n&&y++,x=o[t]):(n&&E++,v=o[t])}for(let t=0;t<n.length;t++)if(n[t]!=s){let s=this.mol.bondOrder(this.mol.findBond(i,n[t]));if(0==s)continue;if(s>1){S=!0;break}let o=!1;for(let s=0;s<(null==e?0:e.length);s++)e[s]==n[t]&&(o=!0);let l=st(Math.atan2(this.points[n[t]-1].oval.cy-m,this.points[n[t]-1].oval.cx-u),A);if(Math.abs(l)*tt>175){S=!0;break}l>0?(o&&M++,C=n[t]):(o&&T++,N=n[t])}let w=0;S||y>1||E>1||M>1||T>1||y>0&&E>0||M>0&&T>0||(y>0||M>0?w=1:(E>0||T>0)&&(w=-1));let O=this.lineSizePix,q=this.orthogonalDelta(a,h,u,m,this.bondSepPix),B=a,k=h,R=u,L=m,D=0,I=0,P=0,_=0;if(0==w?(B=a+.5*q[0],k=h+.5*q[1],R=u+.5*q[0],L=m+.5*q[1],D=a-.5*q[0],I=h-.5*q[1],P=u-.5*q[0],_=m-.5*q[1]):w>0?(D=a+q[0],I=h+q[1],P=u+q[0],_=m+q[1],o.length>1&&null==this.points[s-1].text&&(D+=q[1],I-=q[0]),n.length>1&&null==this.points[i-1].text&&(P-=q[1],_+=q[0])):w<0&&(D=a-q[0],I=h-q[1],P=u-q[0],_=m-q[1],o.length>1&&null==this.points[s-1].text&&(D+=q[1],I-=q[0]),n.length>1&&null==this.points[i-1].text&&(P-=q[1],_+=q[0])),0!=w&&(this.mol.atomElement(s).length<=2&&1==this.mol.atomAdjCount(s)&&null!=this.points[s-1].text&&this.bumpAtomPosition(s,.5*q[0]*w,.5*q[1]*w),this.mol.atomElement(i).length<=2&&1==this.mol.atomAdjCount(i)&&null!=this.points[i-1].text&&this.bumpAtomPosition(i,.5*q[0]*w,.5*q[1]*w)),0==w&&!S){let e=null;null!=this.points[s-1].text||this.mol.bondInRing(t)||(e=this.adjustBondPosition(x,s,B,k,R,L),null!=e&&(B=e[0],k=e[1]),e=this.adjustBondPosition(v,s,D,I,P,_),null!=e&&(D=e[0],I=e[1])),null!=this.points[i-1].text||this.mol.bondInRing(t)||(e=this.adjustBondPosition(C,i,R,L,B,k),null!=e&&(R=e[0],L=e[1]),e=this.adjustBondPosition(N,i,P,_,D,I),null!=e&&(P=e[0],_=e[1]))}let F=this.mol.bondType(t)==ne.BONDTYPE_UNKNOWN?we.Unknown:we.Normal,z=F==we.Unknown?.1*this.scale:0,U=this.effects.colBond[t];U||(U=this.policy.data.foreground);let Y={bnum:t,bfr:s,bto:i,type:F,line:new f(B,k,R,L),size:O,head:z,col:U},X={bnum:t,bfr:s,bto:i,type:F,line:new f(D,I,P,_),size:O,head:z,col:U};this.lines.push(Y),this.lines.push(X),this.space.push(this.computeSpaceLine(Y)),this.space.push(this.computeSpaceLine(X))}placeHydrogen(t,e,i){let o=Ue.main;const n=.6,l=o.getIndex("H");let r=this.points[t],a=r.fsz*o.INV_UNITS_PER_EM,u=e>=2?e.toString():"",m=o.getOutlineX(l),d=o.getOutlineY(l),f=o.HORIZ_ADV_X[l],g=f;for(let t=0;t<u.length;t++){let e=u.charAt(t),i=o.getIndex(e);if(0==t)g+=o.getKerning("H",e);else{let s=u.charAt(t-1);g+=o.getKerning(s,e)*n}let l=o.getOutlineX(i),r=o.getOutlineY(i);s.addTo(l,g/n),s.addTo(r,-.4*o.ASCENT),s.mulBy(l,n),s.mulBy(r,n),m=m.concat(l),d=d.concat(r),g+=o.HORIZ_ADV_X[i]*n}if(u.length>0){let t=new h(m,d,0);m=t.hullX,d=t.hullY}let b=-.5*f,A=.5*o.ASCENT;for(let t=0;t<m.length;t++)m[t]=r.oval.cx+(b+m[t])*a,d[t]=r.oval.cy+(A-d[t])*a*this.ymul;let y=0,E=0,M=this.measure.measureText(r.text,r.fsz);if(i){let t=[0,1,2,3],e=[1,0,2,3],i=[2,3,0,1],o=[3,2,0,1],n=t,l=this.mol.atomAdjList(r.anum);if(0==l.length){let s=["O","S","F","Cl","Br","I"];n=0==this.mol.atomCharge(r.anum)&&0==this.mol.atomUnpaired(r.anum)&&s.indexOf(this.mol.atomElement(r.anum))>=0?e:t}else{let t=!0,s=!0,a=!0,h=!0;const u=this.mol.atomX(r.anum),m=this.mol.atomY(r.anum);for(let e=0;e<l.length;e++){const i=this.mol.atomX(l[e]),o=this.mol.atomY(l[e]);i>u+.01&&(t=!1),i<u-.01&&(s=!1),o<m-.01&&(a=!1),o>m+.01&&(h=!1)}t||(s?n=e:a?n=o:h&&(n=i))}for(let t=0;t<4;t++){let e=0,i=0;0==n[t]?e=.5*M[0]+.5*f*a:1==n[t]?e=-.5*M[0]-(g-.5*f)*a:2==n[t]?i=(1.1*M[1]+.5*M[2])*-this.ymul:3==n[t]&&(i=(1.1*M[1]+.5*M[2])*this.ymul),s.addTo(m,e),s.addTo(d,i);let o=this.countPolyViolations(m,d,null,!0);if(s.addTo(m,-e),s.addTo(d,-i),0==o){y=e,E=i;break}}if(0==y&&0==E)return!1}else{const t=s.min(d),e=s.max(m),i=s.min(d),o=s.max(d),n=.5*(t+e),l=.5*(i+o),a=1+this.measure.scale()*this.policy.data.fontSize*He.FONT_CORRECT*.1/Math.max(e-n,o-l),h=m.length;let u=m.slice(0),c=d.slice(0);for(let t=0;t<h;t++)u[t]=(u[t]-n)*a+n,c[t]=(c[t]-l)*a+l;let p=0,f=0,g=0;for(let t=.5*(r.oval.rw+r.oval.rh);t<1.5*this.measure.scale();t+=.1*this.measure.scale()){let e=!1;for(let i=0;i<2*Math.PI;i+=5*J){let o=t*Math.cos(i),n=t*Math.sin(i);s.addTo(u,o),s.addTo(c,n);let l=this.countPolyViolations(u,c,null,!1);s.addTo(u,-o),s.addTo(c,-n),0==l&&(e=!0);let a=10*l+this.spatialCongestion(r.oval.cx+o,r.oval.cy+n,.5)+2*t;(0==p||a<p)&&(p=a,f=t,g=i,y=o,E=n)}if(e)break}}let T=this.measure.measureText("H",r.fsz);const x=1.1;let v={anum:0,text:"H",fsz:r.fsz,bold:r.bold,col:r.col,oval:new p(r.oval.cx+y,r.oval.cy+E,.5*T[0]*x,.5*T[1]*x)};if(this.points.push(v),u.length>0){const t=n*r.fsz;T=this.measure.measureText(u,t);let e={anum:0,text:u,fsz:t,bold:r.bold,col:r.col,oval:new p(v.oval.cx+.5*f*r.fsz*o.INV_UNITS_PER_EM+.5*T[0],v.oval.cy+.4*r.fsz,.5*T[0]*x,.5*T[1]*x)};this.points.push(e)}s.addTo(m,y),s.addTo(d,E);let C=s.min(m),N=s.min(d),S={anum:0,bnum:0,box:new c(C,N,s.max(m)-C,s.max(d)-N),px:m,py:d};return this.space.push(S),!0}computeSpacePoint(t){let e={anum:t.anum,bnum:0,box:new c,px:[],py:[]};const i=Ue.main;let o=[],n=[],l=0,r=0;if(null!=t.text)for(let e=0;e<t.text.length;e++){let a=t.text.charAt(e),h=i.getIndex(a);if(h>=0){if(0==l)o=i.getOutlineX(h),n=i.getOutlineY(h),r=1;else{let t=i.getOutlineX(h),e=i.getOutlineY(h);t.length>0&&(s.addTo(t,l),o=o.concat(t),n=n.concat(e),r++)}l+=i.HORIZ_ADV_X[h]}else l+=i.MISSING_HORZ;if(e<t.text.length-1){let s=t.text.charAt(e+1);l+=i.getKerning(a,s)}}if(o.length>0){if(r>1){let t=new h(o,n,0);o=t.hullX,n=t.hullY}let a=-.5*l,u=.5*i.ASCENT,m=t.fsz*i.INV_UNITS_PER_EM;for(let e=0;e<o.length;e++)o[e]=t.oval.cx+(a+o[e])*m,n[e]=t.oval.cy+(u-n[e])*m*this.ymul;e.px=o,e.py=n;let d=s.min(o),p=s.min(n);e.box=new c(d,p,s.max(o)-d,s.max(n)-p)}else e.box=c.fromOval(t.oval),e.box.w>0&&e.box.h>0&&(e.px=[e.box.minX(),e.box.maxX(),e.box.maxX(),e.box.minX()],e.py=[e.box.minY(),e.box.minY(),e.box.maxY(),e.box.maxY()]);return e}computeSpaceLine(t){let e={anum:0,bnum:t.bnum,box:new c,px:[],py:[]};if(t.type==we.Normal||t.type==we.Dotted||t.type==we.DotDir)e.px=[t.line.x1,t.line.x2],e.py=[t.line.y1,t.line.y2];else{const s=t.line.x2-t.line.x1,i=t.line.y2-t.line.y1,o=t.head/Math.sqrt(s*s+i*i),n=o*i,l=-o*s;t.type==we.Unknown?(e.px=[t.line.x1+n,t.line.x1-n,t.line.x2-n,t.line.x2+n],e.py=[t.line.y1+l,t.line.y1-l,t.line.y2-l,t.line.y2+l]):(e.px=[t.line.x1,t.line.x2-n,t.line.x2+n],e.py=[t.line.y1,t.line.y2-l,t.line.y2+l])}return e.box.x=s.min(e.px)-t.size,e.box.y=s.min(e.py)-t.size,e.box.w=s.max(e.px)-e.box.x+t.size,e.box.h=s.max(e.py)-e.box.y+t.size,e}bumpAtomPosition(t,e,i){let o=this.points[t-1];o.oval.cx+=e,o.oval.cy+=i;for(let o=this.space.length-1;o>=0;o--){let n=this.space[o-1];null!=n&&n.anum==t&&(n.box.x+=e,n.box.y+=i,s.addTo(n.px,e),s.addTo(n.py,i))}}spaceSubset(t,e,s,i){let o=[];for(let n of this.space)a.rectsIntersect(t,e,s,i,n.box.x,n.box.y,n.box.w,n.box.h)&&o.push(n);return o}countPolyViolations(t,e,i,o){null==i&&(i=this.space);let n=0;const l=t.length,r=i.length;let h=new c,u=new c;for(let s=0;s<l;s++){let m=s<l-1?s+1:0;h.x=Math.min(t[s],t[m])-1,h.y=Math.min(e[s],e[m])-1,h.w=Math.max(t[s],t[m])-h.x+2,h.h=Math.max(e[s],e[m])-h.y+2;for(let l=0;l<r;l++){let r=i[l];if(null==r.px)continue;if(u.x=r.box.x-1,u.y=r.box.y-1,u.w=r.box.w+1,u.h=r.box.h+1,!h.intersects(u))continue;let d=r.px.length;for(let i=0;i<d;i++){let l=i<d-1?i+1:0;if(u.x=Math.min(r.px[i],r.px[l])-1,u.y=Math.min(r.py[i],r.py[l])-1,u.w=Math.max(r.px[i],r.px[l])-u.x+2,u.h=Math.max(r.py[i],r.py[l])-u.y+2,h.intersects(u)){if(a.doLineSegsIntersect(t[s],e[s],t[m],e[m],r.px[i],r.py[i],r.px[l],r.py[l])){if(o)return 1;n++;break}if(1==d)break}}}}h.x=s.min(t),h.y=s.min(e),h.w=s.max(t)-h.x,h.h=s.max(e)-h.y;for(let s=r-1;s>=0;s--){let r=i[s];if(u.x=r.box.x,u.y=r.box.y,u.w=r.box.w,u.h=r.box.h,h.intersects(u)){for(let s=r.px.length-1;s>=0;s--)if(a.pointInPolygon(r.px[s],r.py[s],t,e)){if(o)return 1;n++;break}for(let s=0;s<l;s++)if(a.pointInPolygon(t[s],e[s],r.px,r.py)){if(o)return 1;n++;break}}}return n}adjustBondPosition(t,e,s,i,o,n){if(0==t||0==e)return null;for(let l=0;l<this.lines.length;l++){let r=this.lines[l];if(1!=this.mol.bondOrder(r.bnum)||this.mol.bondType(r.bnum)!=ne.BONDTYPE_NORMAL)continue;let h=!1;if(this.mol.bondFrom(r.bnum)==t&&this.mol.bondTo(r.bnum)==e);else{if(this.mol.bondFrom(r.bnum)!=e||this.mol.bondTo(r.bnum)!=t)continue;h=!0}let u=st(Math.atan2(r.line.y2-r.line.y1,r.line.x2-r.line.x1),Math.atan2(n-i,o-s))*tt;if(u>-5&&u<5||u>175||u<-175)continue;let m=a.lineIntersect(r.line.x1,r.line.y1,r.line.x2,r.line.y2,s,i,o,n);return 0==this.mol.atomRingBlock(e)&&(h?(r.line.x1=m[0],r.line.y1=m[1]):(r.line.x2=m[0],r.line.y2=m[1])),m}return null}priorityDoubleSubstit(t){let e=this.mol.bondFrom(t),s=this.mol.bondTo(t),i=this.mol.atomAdjList(e),o=this.mol.atomAdjList(s),n=this.points[e-1],l=this.points[s-1],r=n.oval.cx,a=n.oval.cy,h=l.oval.cx,u=l.oval.cy,m=h-r,d=u-a,c=Math.atan2(d,m),p=0,f=0,g=0,b=0;for(let t=0;t<i.length;t++)if(i[t]!=s)if(st(Math.atan2(this.points[i[t]-1].oval.cy-a,this.points[i[t]-1].oval.cx-r),c)>0){if(0!=p)return null;p=i[t]}else{if(0!=f)return null;f=i[t]}for(let t=0;t<o.length;t++)if(o[t]!=e)if(st(Math.atan2(this.points[o[t]-1].oval.cy-u,this.points[o[t]-1].oval.cx-h),c)>0){if(0!=g)return null;g=o[t]}else{if(0!=b)return null;b=o[t]}let A=(p>0?1:0)+(f>0?1:0),y=(g>0?1:0)+(b>0?1:0);if(1==A&&0==y)return[p>0?p:f];if(0==A&&1==y)return[g>0?g:b];if(1==A&&1==y){if(p>0&&g>0)return[p,g];if(f>0&&b>0)return[f,b];let t=this.orthogonalDelta(r,a,h,u,this.bondSepPix);return this.spatialCongestion(.5*(r+h)+t[0],.5*(a+u)+t[1])<this.spatialCongestion(.5*(r+h)-t[0],.5*(a+u)-t[1])?[p>0?p:g]:[f>0?f:b]}return 2==A&&1==y?0==g?[f,b]:[p,g]:1==A&&2==y?0==p?[f,b]:[p,g]:null}spatialCongestion(t,e,s){null==s&&(s=.001);let i=0;for(let o=0;o<this.points.length;o++){let n=this.points[o];if(null==n)continue;let l=n.oval.cx-t,r=n.oval.cy-e;i+=1/(l*l+r*r+s)}return i}annotateAtom(t,e,s,i){let[o,n]=this.measure.measureText(e,i),l=this.points[t-1],r=l.oval.cx,a=l.oval.cy,h=.6*o,u=.6*n,m=[];for(let e of this.mol.atomAdjList(t)){let t=this.points[e-1].oval.cx-r,s=this.points[e-1].oval.cy-a;m.push(Math.atan2(s,t))}let d=.5*(l.oval.rw+l.oval.rh),f=.1*this.scale,g=K/36,b=Number.POSITIVE_INFINITY,A=0,y=0,E=[0,0,0,0],M=[0,0,0,0],T=h+d+8*f,x=u+d+8*f,v=this.spaceSubset(r-T,a-x,2*T,2*x);for(let t=0;t<8;t++){let e=d+t*f;for(let t=0;t<36;t++){let s=g*t,i=e*Math.cos(s),o=e*Math.sin(s),n=r+i-h,l=r+i+h,d=a+o-u,c=a+o+u;E[0]=n,M[0]=d,E[1]=l,M[1]=d,E[2]=l,M[2]=c,E[3]=n,M[3]=c;let p=1e3*this.countPolyViolations(E,M,v,!1);for(let t of m)p-=Math.abs(st(s,t));p<b&&(b=p,A=i,y=o)}if(b<500)break}let C=r+A,N=a+y,S={anum:0,text:e,fsz:i,bold:!1,col:s,oval:new p(C,N,h,u)};this.points.push(S);let w={anum:0,bnum:0,box:new c(C-h,N-u,2*h,2*u),px:[C-h,C+h,C+h,C-h],py:[N-u,N-u,N+u,N+u]};this.space.push(w)}annotateBond(t,e,s,i){let[o,n]=this.measure.measureText(e,i),l=this.mol.bondFrom(t),r=this.mol.bondTo(t),a=this.points[l-1],h=this.points[r-1],u=.5*(a.oval.cx+h.oval.cx),m=.5*(a.oval.cy+h.oval.cy),d=.6*o,f=.6*n,g=Math.atan2(h.oval.cy-a.oval.cy,h.oval.cx-a.oval.cx),b=[g,g+Math.PI];for(let t of this.mol.atomAdjList(l))if(t!=r){let e=this.points[t-1].oval.cx-this.points[l-1].oval.cx,s=this.points[t-1].oval.cy-this.points[l-1].oval.cy;b.push(Math.atan2(s,e))}for(let t of this.mol.atomAdjList(r))if(t!=l){let e=this.points[t-1].oval.cx-this.points[r-1].oval.cx,s=this.points[t-1].oval.cy-this.points[r-1].oval.cy;b.push(Math.atan2(s,e))}let A=.2*this.scale*this.bondOrder[t-1],y=.1*this.scale,E=K/36,M=Number.POSITIVE_INFINITY,T=0,x=0,v=[0,0,0,0],C=[0,0,0,0],N=d+A+8*y,S=f+A+8*y,w=this.spaceSubset(u-N,m-S,2*N,2*S);for(let t=0;t<8;t++){let e=A+t*y;for(let t=0;t<36;t++){let s=E*t,i=e*Math.cos(s),o=e*Math.sin(s),n=u+i-d,l=u+i+d,r=m+o-f,a=m+o+f;v[0]=n,C[0]=r,v[1]=l,C[1]=r,v[2]=l,C[2]=a,v[3]=n,C[3]=a;let h=1e3*this.countPolyViolations(v,C,w,!1);for(let t of b)h-=Math.abs(st(s,t));h<M&&(M=h,T=i,x=o)}if(M<500)break}let O=u+T,q=m+x,B={anum:0,text:e,fsz:i,bold:!1,col:s,oval:new p(O,q,d,f)};this.points.push(B);let k={anum:0,bnum:0,box:new c(O-d,q-f,2*d,2*f),px:[O-d,O+d,O+d,O-d],py:[q-f,q-f,q+f,q+f]};this.space.push(k)}boxOverlaps(t,e,s,i,o,n){let l=t,r=e,h=t+s,u=e+i;for(let t=0;t<this.points.length;t++){if(null!=o&&!o[t])continue;let e=this.points[t],s=e.oval.cx-e.oval.rw,i=e.oval.cy-e.oval.rh,n=e.oval.cx+e.oval.rw,a=e.oval.cy+e.oval.rh;if(!(h<s||l>n||u<i||r>a))return!0}for(let t=0;t<this.lines.length;t++){if(null!=n&&!n[t])continue;let e=this.lines[t],s=e.line.x1,i=e.line.y1,o=e.line.x2,m=e.line.y2;if(!(h<Math.min(s,o)||l>Math.max(s,o)||u<Math.min(i,m)||r>Math.max(i,m))){if(s>=l&&s<=h&&i>=r&&i<=u)return!0;if(o>=l&&o<=h&&m>=r&&m<=u)return!0;if(a.doLineSegsIntersect(s,i,o,m,l,r,h,r))return!0;if(a.doLineSegsIntersect(s,i,o,m,l,u,h,u))return!0;if(a.doLineSegsIntersect(s,i,o,m,l,r,l,u))return!0;if(a.doLineSegsIntersect(s,i,o,m,h,r,h,u))return!0}}return!1}resolveLineCrossings(t,e){for(;;){let s=!1;for(let i=0;i<this.lines.length;i++){let o=this.lines[i];if(o.bnum==t&&(o.type==we.Normal||o.type==we.Dotted||o.type==we.DotDir))for(let t=0;t<this.lines.length;t++){let i=this.lines[t];if(i.bnum!=e)continue;if(i.type==we.DotDir&&(i.type=we.Dotted),i.type!=we.Normal&&i.type!=we.Dotted)continue;if(o.bfr==i.bfr||o.bfr==i.bto||o.bto==i.bfr||o.bto==i.bto)continue;if(!a.doLineSegsIntersect(o.line.x1,o.line.y1,o.line.x2,o.line.y2,i.line.x1,i.line.y1,i.line.x2,i.line.y2))continue;let n=a.lineIntersect(o.line.x1,o.line.y1,o.line.x2,o.line.y2,i.line.x1,i.line.y1,i.line.x2,i.line.y2),l=i.line.x2-i.line.x1,r=i.line.y2-i.line.y1,h=Math.abs(l)>Math.abs(r)?(n[0]-i.line.x1)/l:(n[1]-i.line.y1)/r,u=U(l,r),m=i.size/u*(i.type==we.Normal?2:4);if(h>m&&h<1-m){let t={bnum:i.bnum,bfr:i.bfr,bto:i.bto,type:i.type,line:i.line.clone(),size:i.size,head:i.head,col:i.col};this.lines.push(t),i.line.x2=i.line.x1+l*(h-m),i.line.y2=i.line.y1+r*(h-m),t.line.x1=t.line.x1+l*(h+m),t.line.y1=t.line.y1+r*(h+m),s=!0}else h>m?(i.line.x2=i.line.x1+l*(h-m),i.line.y2=i.line.y1+r*(h-m),s=!0):h<1-m&&(i.line.x1=i.line.x1+l*(h+m),i.line.y1=i.line.y1+r*(h+m),s=!0)}}if(!s)break}}createCircularRing(t){let e=0,i=0;for(let s of t){let t=this.points[s-1];e+=t.oval.cx,i+=t.oval.cy}e/=t.length,i/=t.length;let o=[],n=[],l=!0,r=Number.NaN;for(let s of t){let a=this.points[s-1],h=a.oval.cx-e,u=a.oval.cy-i,m=h-a.oval.rw,d=h+a.oval.rw,c=u-a.oval.rh,p=u+a.oval.rh;o.push(m),n.push(u),o.push(m),n.push(c),o.push(m),n.push(p),o.push(h),n.push(c),o.push(h),n.push(p),o.push(d),n.push(u),o.push(d),n.push(c),o.push(d),n.push(p);let f=U(h,u),g=Math.atan2(u,h);const b=.7;o.push(b*f*Math.cos(g)),n.push(b*f*Math.sin(g));for(let l of this.mol.atomAdjList(s))if(t.indexOf(l)>=0){let t=this.points[l-1],s=.5*(a.oval.cx+t.oval.cx)-e,r=.5*(a.oval.cy+t.oval.cy)-i,h=U(s,r),u=Math.atan2(r,s);o.push(b*h*Math.cos(u)),n.push(b*h*Math.sin(u))}l&&(Number.isFinite(r)?Math.abs(r-f)>1&&(l=!1):r=f)}let h={atoms:t,cx:e,cy:i,rw:0,rh:0,size:0};if(l)h.rw=h.rh=a.fitCircle(o,n);else{let l=s.min(o)-10*s.range(o),r=s.max(o)+10*s.range(o),u=s.min(n)-10*s.range(n),m=s.max(n)+10*s.range(n),d=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,p=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){let o=s<t.length-1?s+1:0,n=this.points[t[s]-1],h=this.points[t[o]-1],g=n.oval.cx-e-.1*(h.oval.cx-n.oval.cx),b=n.oval.cy-i-.1*(h.oval.cy-n.oval.cy),A=h.oval.cx-e+.1*(h.oval.cx-n.oval.cx),y=h.oval.cy-i+.1*(h.oval.cy-n.oval.cy);if(a.doLineSegsIntersect(g,b,A,y,l,0,r,0)){let t=a.lineIntersect(g,b,A,y,l,0,r,0);d=Math.min(d,t[0]),c=Math.max(c,t[0])}if(a.doLineSegsIntersect(g,b,A,y,0,u,0,m)){let t=a.lineIntersect(g,b,A,y,0,u,0,m);p=Math.min(p,t[1]),f=Math.max(f,t[1])}}let g=a.fitEllipse(o,n,d,p,c,f);h.rw=g[0],h.rh=g[1]}h.size=this.lineSizePix,this.rings.push(h)}createCurvedPath(t,e,i){const o=t.length;let n=[],l=[],r=[];for(let e=0;e<o;e++){let s=this.points[t[e]-1];n.push(s.oval.cx),l.push(s.oval.cy),r.push(null!=s.text)}let a=[],h=[];const u=.25*ne.IDEALBOND*this.scale;for(let t=0;t<o-1;t++){let e=n[t+1]-n[t],s=l[t+1]-l[t],i=u*W(U(e,s));a.push(s*i),h.push(-e*i)}let m=s.numberArray(0,o),d=s.numberArray(0,o),c=s.numberArray(0,o),p=s.numberArray(0,o);const f=r[0]?1.2:.7;if(e){const t=-h[0],e=a[0];m[0]=n[0]+t*f,d[0]=l[0]+e*f,c[0]=n[0]+t*f,p[0]=l[0]+e*f}else m[0]=n[0]+a[0]*f,d[0]=l[0]+h[0]*f,c[0]=n[0]-a[0]*f,p[0]=l[0]-h[0]*f;let g=0,b=0;for(let e=1;e<o-1;e++){const s=r[e]?1.2:.7,o=s;m[e]=n[e]+s*(a[e-1]+a[e]),d[e]=l[e]+s*(h[e-1]+h[e]),c[e]=n[e]-o*(a[e-1]+a[e]),p[e]=l[e]-o*(h[e-1]+h[e]);for(let s of this.mol.atomAdjList(t[e]))if(t.indexOf(s)<0&&s!=i){let t=this.points[s-1],i=t.oval.cx-n[e],o=t.oval.cy-l[e];i*(m[e]-n[e])+o*(d[e]-n[e])>o*(c[e]-n[e])+o*(p[e]-n[e])?g++:b++}}let A=o-1,y=r[A]?1.2:.7;if(e){let t=-h[A-1],e=a[A-1];m[A]=n[A]-t*y,d[A]=l[A]-e*y,c[A]=n[A]-t*y,p[A]=l[A]-e*y}else m[A]=n[A]+a[A-1]*y,d[A]=l[A]+h[A-1]*y,c[A]=n[A]-a[A-1]*y,p[A]=l[A]-h[A-1]*y;let E=0,M=0;for(let t=0;t<o-1;t++)E+=U(m[t+1]-m[t],d[t+1]-d[t]),M+=U(c[t+1]-c[t],p[t+1]-p[t]);E*=g+1,M*=b+1;let T=E<M?m:c,x=E<M?d:p,v={atoms:t,px:null,py:null,ctrl:null,size:this.lineSizePix};this.splineInterpolate(v,T,x),this.paths.push(v)}createBondCentroid(t,e){let s=this.points[t-1],i=s.oval.cx,o=s.oval.cy,n=0,l=0;for(let t of e)s=this.points[t-1],n+=s.oval.cx,l+=s.oval.cy;n/=e.length,l/=e.length,e.length<=2&&(n-=.1*(n-i),l-=.1*(l-o));const r=.25*this.measure.scale();let a=this.backOffAtom(t,i,o,n,l,r);this.ensureMinimumBondLength(a,[n,l],i,o,n,l,r);let h={bnum:0,bfr:t,bto:0,type:we.Normal,line:new f(a[0],a[1],n,l),size:this.lineSizePix,head:0,col:this.policy.data.foreground};this.lines.push(h),this.space.push(this.computeSpaceLine(h))}splineInterpolate(t,e,i){const o=e.length,n=.25;for(let l=0;l<o;l++)if(0==l){let o=e[l+1]-e[l],r=i[l+1]-i[l],a=e[l]+n*o,h=i[l]+n*r;t.px=s.append(t.px,e[l]),t.py=s.append(t.py,i[l]),t.ctrl=s.append(t.ctrl,!1),t.px=s.append(t.px,a),t.py=s.append(t.py,h),t.ctrl=s.append(t.ctrl,!0)}else if(l==o-1){let o=e[l]-e[l-1],r=i[l]-i[l-1],a=e[l]-n*o,h=i[l]-n*r;t.px=s.append(t.px,a),t.py=s.append(t.py,h),t.ctrl=s.append(t.ctrl,!0),t.px=s.append(t.px,e[l]),t.py=s.append(t.py,i[l]),t.ctrl=s.append(t.ctrl,!1)}else{let o=e[l+1]-e[l-1],r=i[l+1]-i[l-1],a=W(U(o,r));o*=a,r*=a;let h=n*U(e[l]-e[l-1],i[l]-i[l-1]),u=n*U(e[l+1]-e[l],i[l+1]-i[l]),m=e[l]-o*h,d=i[l]-r*h,c=e[l]+o*u,p=i[l]+r*u;t.px=s.append(t.px,m),t.py=s.append(t.py,d),t.ctrl=s.append(t.ctrl,!0),t.px=s.append(t.px,e[l]),t.py=s.append(t.py,i[l]),t.ctrl=s.append(t.ctrl,!1),t.px=s.append(t.px,c),t.py=s.append(t.py,p),t.ctrl=s.append(t.ctrl,!0)}}delocalisedAnnotation(t,e,s){const i=this.mol;let o="";if(-1==e?o="-":1==e?o="+":e<-1?o=Math.abs(e)+"-":e>1&&(o=e+"+"),s>0)for(let t=0;t<s;t++)o+=".";if(0==o.length)return;const n=t.length;let l=0,r=0;for(let e of t)l+=i.atomX(e),r+=i.atomY(e);l/=n,r/=n;let a=jt.congestionPoint(i,l,r);for(let e=1;e<n-1;e++){let s=.5*(i.atomX(t[e-1])+i.atomX(t[e+1])),o=.5*(i.atomY(t[e-1])+i.atomY(t[e+1])),n=jt.congestionPoint(i,s,o);n<a&&(a=n,l=s,r=o)}let h=.8*this.fontSizePix,u=this.measure.measureText(o,h),m=.55*u[0],d=.55*u[1],f={anum:0,text:o,fsz:h,bold:!1,col:this.policy.data.foreground,oval:new p(this.measure.angToX(l),this.measure.angToY(r),m,d)};this.points.push(f);let g={anum:0,bnum:0,box:new c(f.oval.cx-m,f.oval.cy-d,2*m,2*d),px:[f.oval.cx-m,f.oval.cx+m,f.oval.cx+m,f.oval.cx-m],py:[f.oval.cy-d,f.oval.cy-d,f.oval.cy+d,f.oval.cy+d]};this.space.push(g)}processPolymerUnit(t,e){if(4==s.len(t.bondConn))return void this.processPolymerUnitPair(t);let i=[];const{mol:o,measure:n}=this;for(let s=1;s<=o.numBonds;s++){let n=o.bondFrom(s),l=o.bondTo(s),r=t.atoms.indexOf(n)>=0,a=t.atoms.indexOf(l)>=0,h=null;if(r&&!a)h={a1:n,a2:l};else{if(!a||r)continue;h={a1:l,a2:n}}h.x1=o.atomX(h.a1),h.y1=o.atomY(h.a1),h.x2=o.atomX(h.a2),h.y2=o.atomY(h.a2),h.shared=!1;for(let s of e)if(t!==s&&s.atoms.includes(h.a2)){h.shared=!0;break}let u=e.filter((e=>e===t||e.atoms.includes(h.a1)&&!e.atoms.includes(h.a2)));if(u.length>1){u.sort(((t,e)=>t.atoms.length-e.atoms.length));for(let e=0;e<u.length;e++)u[e]===t&&(h.nestOrder=e);h.nestCount=u.length}i.push(h)}let l=0,r=t.atoms.map((t=>o.atomX(t))),a=t.atoms.map((t=>o.atomY(t))),h=s.min(r),u=s.min(a),m=s.max(r),d=s.max(a);for(let t=1;t<i.length;t++){let e=i[l],s=i[t],o=e.x2-h-e.y2+u;s.x2-h-s.y2+u>o&&(l=t)}let c=!1,g=!1;if(2==i.length){let t=i[0==l?1:0],e=i[l],s=Math.atan2(t.y2-t.y1,t.x2-t.x1),o=Math.atan2(e.y2-e.y1,e.x2-e.x1);c=(s>145*J||s<-145*J)&&o<35*J&&o>-35*J}else if(0==i.length){let t=.5*(u+d);i.push({x1:h,y1:t,x2:h-1,y2:t}),i.push({x1:m,y1:t,x2:m+1,y2:t}),l=1,g=!0}let b=(g?.5*(d-u+1):c?1:.5)*this.scale,A=.2*this.scale;const y={bnum:0,bfr:0,bto:0,type:we.Normal,size:this.lineSizePix,head:0,col:this.policy.data.foreground},E={anum:0,fsz:.7*this.fontSizePix,bold:!1,col:this.policy.data.foreground};for(let e=0;e<i.length;e++){let s=i[e],o=n.angToX(s.x1),r=n.angToY(s.y1),a=n.angToX(s.x2),h=n.angToY(s.y2);if(s.shared&&(a-=.1*(a-o),h-=.1*(h-r)),s.nestCount>1){let t=a-o,e=h-r,i=(s.nestOrder+1)/s.nestCount;a=o+t*i,h=r+e*i}let u=.5*(o+a),m=.5*(r+h);c&&(o=a=u,r=h=m,e==l?(o--,a++):(o++,a--));let d=W(U(a-o,h-r)),g=(a-o)*d,M=(h-r)*d,T=M,x=-g,v=u-b*T,C=m-b*x,N=u+b*T,S=m+b*x,w=v-A*g,O=C-A*M,q=N-A*g,B=S-A*M,k=Object.assign(Object.assign({},y),{line:new f(w,O,v,C)}),R=Object.assign(Object.assign({},y),{line:new f(v,C,N,S)}),L=Object.assign(Object.assign({},y),{line:new f(N,S,q,B)});if(this.lines.push(k),this.lines.push(R),this.lines.push(L),this.space.push(this.computeSpaceLine(k)),this.space.push(this.computeSpaceLine(R)),this.space.push(this.computeSpaceLine(L)),e==l){let e,i;s.shared?[e,i]=[v-.5*this.scale*T,C-.5*this.scale*x]:[e,i]=[v+2*A*g,C+2*A*M];let o=Object.assign(Object.assign({},E),{text:"n",oval:new p(e,i,0,0)});if(this.points.push(o),this.space.push(this.computeSpacePoint(o)),null!=t.connect){let o="?";t.connect==_t.HeadToTail?o="ht":t.connect==_t.HeadToHead?o="hh":t.connect==_t.Random&&(o="eu"),s.shared?[e,i]=[N+.5*this.scale*T,S+.5*this.scale*x]:[e,i]=[N+2.5*A*g,S+2.5*A*M];let n=Object.assign(Object.assign({},E),{text:o,oval:new p(e,i,0,0)});this.points.push(n),this.space.push(this.computeSpacePoint(n))}}}}processPolymerUnitPair(t){const{mol:e,measure:i}=this;let o=[],n=[];for(let s of t.bondConn){let t=e.bondFrom(s),l=e.bondTo(s);o.push(i.angToX(.5*(e.atomX(t)+e.atomX(l)))),n.push(i.angToY(.5*(e.atomY(t)+e.atomY(l))))}let l=.25*s.sum(o),r=.25*s.sum(n),a=.5*this.scale,h=[],u=[];for(let[t,e]of[[0,1],[2,3]]){let s=o[e]-o[t],i=n[e]-n[t],m=a*W(U(s,i)+.001);[s,i]=[s*m,i*m],o[t]-=2*s,n[t]-=2*i,o[e]+=2*s,n[e]+=2*i;let d=i,c=-s,p=X(.5*(o[t]+o[e])+d-l,.5*(n[t]+n[e])+c-r);X(.5*(o[t]+o[e])-d-l,.5*(n[t]+n[e])-c-r)<p&&([d,c]=[-d,-c]),h.push(d,d),u.push(c,c)}const m={bnum:0,bfr:0,bto:0,type:we.Normal,size:this.lineSizePix,head:0,col:this.policy.data.foreground},d={anum:0,fsz:.7*this.fontSizePix,bold:!1,col:this.policy.data.foreground};let c=(t,e,s,i)=>{let o=Object.assign(Object.assign({},m),{line:new f(t,e,s,i)});this.lines.push(o),this.space.push(this.computeSpaceLine(o))},g=(t,e,s)=>{let i=Object.assign(Object.assign({},d),{text:s,oval:new p(t,e,0,0)});this.points.push(i),this.space.push(this.computeSpacePoint(i))};c(o[0],n[0],o[1],n[1]),c(o[0],n[0],o[0]+h[0],n[0]+u[0]),c(o[1],n[1],o[1]+h[1],n[1]+u[1]),c(o[2],n[2],o[3],n[3]),c(o[2],n[2],o[2]+h[2],n[2]+u[2]),c(o[3],n[3],o[3]+h[3],n[3]+u[3]);let b=s.min(o),A=s.min(n),y=[];for(let t=0;t<4;t++)y.push(o[t]-b+n[t]-A);let E=s.idxMax(y);g(o[E]-h[E],n[E]-u[E],"n");let M=E+(E%2==1?-1:1),T=(M+2)%4;g(o[T]-.5*h[T],n[T]-.5*u[T],"*"),g(o[M]-.5*h[M],n[M]-.5*u[M],"*")}}He.FONT_CORRECT=1.5,function(t){t[t.Arrow=1]="Arrow",t[t.Plus=2]="Plus",t[t.Reactant=3]="Reactant",t[t.Reagent=4]="Reagent",t[t.Product=5]="Product",t[t.StepNote=6]="StepNote"}(Oe||(Oe={})),function(t){t[t.None=0]="None",t[t.Primary=1]="Primary",t[t.Waste=2]="Waste",t[t.Implied=3]="Implied"}(qe||(qe={}));class je{constructor(){this.annot=qe.None,this.box=new c}clone(){let t=new je;return t.type=this.type,t.srcIdx=this.srcIdx,t.step=this.step,t.side=this.side,t.refIdx=this.refIdx,t.mol=this.mol,t.text=this.text,t.leftNumer=this.leftNumer,t.leftDenom=this.leftDenom,t.fszText=this.fszText,t.fszLeft=this.fszLeft,t.annot=this.annot,t.box=this.box.clone(),t.padding=this.padding,t}}class Ve{constructor(t,e,s){this.entry=t,this.measure=e,this.policy=s,this.width=0,this.height=0,this.components=[],this.limitTotalW=1e3,this.limitTotalH=1e3,this.limitStructW=0,this.limitStructH=0,this.includeReagents=!0,this.includeNames=!1,this.includeStoich=!0,this.includeAnnot=!1,this.includeBlank=!1,this.includeDetails=!1,this.includeAtomMap=!1,this.colourAtomMap=10295926,this.allowVertical=!0,this.padding=0,this.scale=s.data.pointScale,this.limitStructW=this.limitStructH=10*this.scale,this.padding=.25*this.scale}arrange(){this.createComponents();let t=this.scale*this.policy.data.fontSize,e=this.scale*this.policy.data.fontSize*1.5;for(let i of this.components){if(i.type==Oe.Plus)i.box=new c(0,0,.5*this.scale,.5*this.scale);else if(i.type==Oe.Arrow);else{let o=0,n=0;if(Ht.notBlank(i.mol)){let t=d.fromArray(He.guestimateSize(i.mol,this.policy));if(i.type==Oe.Reagent&&t.scaleBy(.7),i.leftNumer){i.fszLeft=e;let s=this.measure.measureText(i.leftNumer,e),o=s[0],n=s[1]+s[2];i.leftDenom&&(o=Math.max(o,this.measure.measureText(i.leftDenom,e)[0])),t.w+=o+Ve.COMP_GAP_LEFT*n,t.h=Math.max(t.h,n*(i.leftDenom?2:1))}t.fitInto(this.limitStructW,this.limitStructH),o=t.w,n=t.h}if(s.notBlank(i.text)){Ht.notBlank(i.mol)&&(n+=.5*t);for(let e of i.text){i.fszText=t;let s=this.measure.measureText(e,t);o=Math.max(o,s[0]),n+=s[1]+s[2]}}0!=i.annot&&(o+=Ve.COMP_ANNOT_SIZE*this.scale),(Ht.isBlank(i.mol)&&!i.text&&this.includeBlank||0==o||0==n)&&(o=Math.max(o,2*this.scale),n=Math.max(n,2*this.scale)),i.box=new c(0,0,o,n)}i.padding=this.padding,i.box=new c(0,0,i.box.w+2*this.padding,i.box.h+2*this.padding)}if(this.allowVertical){let t=null,e=0;for(let s=this.entry.steps.length+1;s>=1;s--)for(let i=0;i<=1;i++){let o=[];for(let t of this.components)o.push(t.clone());this.arrangeComponents(o,s,i>0);let n=this.scoreArrangement(o);(null==t||n>e)&&(t=o,e=n)}this.components=t}else this.arrangeComponents(this.components,this.entry.steps.length+1,!1);this.width=this.height=0;for(let t of this.components)this.width=Math.max(this.width,t.box.maxX()),this.height=Math.max(this.height,t.box.maxY())}get numComponents(){return this.components.length}getComponent(t){return this.components[t]}getComponents(){return this.components}scaleComponents(t){if(1!=t){this.scale*=t,this.width*=t,this.height*=t;for(let e of this.components)e.box.scaleBy(t),e.fszText*=t,e.fszLeft*=t,e.padding*=t}}static toExpType(t){return t==Oe.Reactant?ke.Reactant:t==Oe.Reagent?ke.Reagent:t==Oe.Product?ke.Product:null}createComponents(){for(let t=0;t<this.entry.steps[0].reactants.length;t++)t>0&&this.createSegregator(Oe.Plus,0,-1),this.createReactant(t,0);0==this.components.length&&this.includeBlank&&this.createBlank(Oe.Reactant,0);for(let t=0;t<this.entry.steps.length;t++){if(this.createSegregator(Oe.Arrow,t,0),this.includeReagents){let e=!1;for(let s=0;s<this.entry.steps[t].reagents.length;s++)this.createReagent(s,t),e=!0;!e&&this.includeBlank&&this.createBlank(Oe.Reagent,t)}this.includeDetails&&this.createStepMeta(t);let e=!1;for(let s=0;s<this.entry.steps[t].products.length;s++)s>0&&this.createSegregator(Oe.Plus,t,1),this.createProduct(s,t),e=!0;!e&&this.includeBlank&&this.createBlank(Oe.Product,t)}}createReactant(t,e){let s=this.entry.steps[e].reactants[t],i=new je;if(i.type=Oe.Reactant,i.srcIdx=t,i.step=e,i.side=-1,Ht.notBlank(s.mol)&&(i.mol=s.mol),s.name&&(this.includeNames||Ht.isBlank(s.mol))&&(i.text=this.wordWrapName(s.name,i.mol)),this.includeDetails&&this.supplementText(i,s),Ht.notBlank(s.mol)&&this.includeStoich&&!ze.isStoichZero(s.stoich)&&!ze.isStoichUnity(s.stoich)){let t=s.stoich.indexOf("/");t>=0?(i.leftNumer=s.stoich.substring(0,t),i.leftDenom=s.stoich.substring(t+1)):i.leftNumer=s.stoich}this.includeAnnot&&Ht.notBlank(s.mol)&&s.primary&&(i.annot=qe.Primary),this.components.push(i)}createReagent(t,e){let s=this.entry.steps[e].reagents[t],i=new je;if(i.type=Oe.Reagent,i.srcIdx=t,i.step=e,i.side=0,Ht.notBlank(s.mol)&&(i.mol=s.mol),s.name&&(this.includeNames||Ht.isBlank(s.mol))&&(i.text=this.wordWrapName(s.name,i.mol)),this.includeDetails&&this.supplementText(i,s),this.includeAnnot){let t=ze.impliedReagentStoich(s,this.entry.steps[e].products);t>0&&(i.annot=qe.Implied),t>0&&1!=t&&($(t,Math.round(t))?i.leftNumer=Math.round(t).toString():i.leftNumer=t.toString())}this.components.push(i)}createProduct(t,e){let s=this.entry.steps[e].products[t],i=new je;if(i.type=Oe.Product,i.srcIdx=t,i.step=e,i.side=1,Ht.notBlank(s.mol)&&(i.mol=s.mol),s.name&&(this.includeNames||Ht.isBlank(s.mol))&&(i.text=this.wordWrapName(s.name,i.mol)),this.includeDetails&&this.supplementText(i,s),this.includeStoich&&!ze.isStoichZero(s.stoich)&&!ze.isStoichUnity(s.stoich)){let t=s.stoich.indexOf("/");t>=0?(i.leftNumer=s.stoich.substring(0,t),i.leftDenom=s.stoich.substring(t+1)):i.leftNumer=s.stoich}this.includeAnnot&&Ht.notBlank(s.mol)&&s.waste&&(i.annot=qe.Waste),this.components.push(i)}createSegregator(t,e,s){let i=new je;i.type=t,i.step=e,i.side=s,this.components.push(i)}createStepMeta(t){let e=[];for(let[i,o]of Pe.unpackMeta(this.entry.steps[t].meta)){if(!s.safeArray(Pe.APPLICABILITY[i]).includes(xe.Step))continue;let t=Pe.describeMeta(i,o);null!=t&&e.push(t)}if(0==e.length)return;let i=new je;i.type=Oe.StepNote,i.step=t,i.side=0,i.text=e,this.components.push(i)}createBlank(t,e){let s=new je;s.type=t,s.step=e,s.side=t==Oe.Reactant?-1:t==Oe.Product?1:0,s.srcIdx=-1,this.components.push(s)}arrangeComponents(t,e,s){let i=[],o=[],n=[],l=[],r=[],a=[];i.push(this.gatherBlock(t,0,-1)),n.push(this.arrangeMainBlock(i[0],s)),r.push(this.findMidBlock(i[0],n[0]));for(let h=0;h<this.entry.steps.length;h++){let u=h+1>=e;i.push(this.gatherBlock(t,h,1)),n.push(this.arrangeMainBlock(i[h+1],s&&!u)),r.push(this.findMidBlock(i[h+1],n[h+1])),o.push(this.gatherBlock(t,h,0)),u?l.push(this.arrangeVerticalArrowBlock(o[h])):l.push(this.arrangeHorizontalArrowBlock(o[h])),a.push(this.findMidBlock(o[h],l[h]))}let h=0;for(let t=0;t<e;t++)h=Math.max(h,r[t].y),t>0&&(h=Math.max(h,a[t-1].y));let u=d.zero();for(let t=0;t<e;t++)u.w+=n[t].w,u.h=Math.max(u.h,h+(n[t].h-r[t].y)),t>0&&(u.w+=l[t-1].w,u.h=Math.max(u.h,h+(l[t-1].h-a[t-1].y)));let m=0,c=0;for(let t=0;t<e;t++)t>0&&(this.originateBlock(o[t-1],m,h-a[t-1].y),m+=l[t-1].w),this.originateBlock(i[t],m,h-r[t].y),c=m+r[t].x,m+=n[t].w;let p=u.h,f=0;for(let t=e;t<=this.entry.steps.length;t++)m=c-a[t-1].x,f=Math.min(f,m),this.originateBlock(o[t-1],m,p),p+=l[t-1].h,u.w=Math.max(u.w,m+l[t-1].w),m=c-r[t].x,f=Math.min(f,m),this.originateBlock(i[t],m,p),p+=n[t].h,u.w=Math.max(u.w,m+n[t].w);if(f<0)for(let e of t)e.box.x-=f}gatherBlock(t,e,s){let i=[];for(let o of t)o.side==s&&o.step==e&&i.push(o);return i}arrangeMainBlock(t,e){let s=d.zero();if(e)for(let e of t)s.w=Math.max(s.w,e.box.w),s.h+=e.box.h;else for(let e of t)s.w+=e.box.w,s.h=Math.max(s.h,e.box.h);if(s.w=Math.max(s.w,2*this.scale),s.h=Math.max(s.h,2*this.scale),e){let e=0;for(let i of t)i.box.x=.5*(s.w-i.box.w),i.box.y=e,e+=i.box.h}else{let e=0;for(let i of t)i.box.x=e,i.box.y=.5*(s.h-i.box.h),e+=i.box.w}return s}arrangeHorizontalArrowBlock(t){let e=null;for(let s of t)s.type==Oe.Arrow&&(e=s,s.box.w=2*this.scale+2*s.padding,s.box.h=.5*this.scale+2*s.padding);let s=t.length>>1;for(let s of t)e.box.w=Math.max(s.box.w,e.box.w);let i=d.zero(),o=0,n=0,l=!1;for(let i of t)i.type!=Oe.Arrow&&(i.box.x=.5*(e.box.w-i.box.w),i.box.y=n,n+=i.box.h,o++,o==s&&(e.box.x=0,e.box.y=n,n+=e.box.h,l=!0));return l||(e.box.x=0,e.box.y=n,n+=e.box.h),i.w=e.box.w,i.h=n,i}arrangeVerticalArrowBlock(t){let e=null;for(let s of t)s.type==Oe.Arrow&&(e=s,s.box.w=.5*this.scale+2*s.padding,s.box.h=2*this.scale+2*s.padding);let s=t.length>>1,i=d.zero(),o=d.zero(),n=0;for(let e of t)e.type!=Oe.Arrow&&(n<s?(i.w=Math.max(i.w,e.box.w),i.h+=e.box.h):(o.w=Math.max(o.w,e.box.w),o.h+=e.box.h),n++);let l=new d(i.w+o.w+e.box.w,Math.max(e.box.h,Math.max(i.h,o.h)));e.box=new c(i.w,0,e.box.w,l.h);let r=.5*(l.h-i.h),a=.5*(l.h-o.h);n=0;for(let e of t)e.type!=Oe.Arrow&&(n<s?(e.box.x=i.w-e.box.w,e.box.y=r,r+=e.box.h):(e.box.x=l.w-o.w,e.box.y=a,a+=e.box.h),n++);return l}findMidBlock(t,e){let s=0,i=m.zero();for(let e of t)e.type!=Oe.Plus&&e.type!=Oe.Arrow||(i.x+=e.box.midX(),i.y+=e.box.midY(),s++);if(0==s)i.x=.5*e.w,i.y=.5*e.h;else if(s>1){let t=1/s;i.x*=t,i.y*=t}return i}scoreArrangement(t){let e=0;for(let s of t)e=Math.max(e,s.box.maxX());let s=0;return s-=Math.abs(e-this.limitTotalW),s}originateBlock(t,e,s){for(let i of t)i.box.x+=e,i.box.y+=s}supplementText(t,e){t.text||(t.text=[]),e.mass>0&&t.text.push(ze.formatMass(e.mass)),e.volume>0&&t.text.push(ze.formatVolume(e.volume)),e.moles>0&&t.text.push(ze.formatMoles(e.moles)),e.conc>0&&t.text.push(ze.formatConc(e.conc)),null!=e.yield&&e.yield>=0&&t.text.push(ze.formatPercent(e.yield)),e.equiv>0&&t.text.push(ze.formatEquiv(e.equiv));for(let[s,i]of Pe.unpackMeta(e.meta)){let e=Pe.describeMeta(s,i);e&&t.text.push(e)}}wordWrapName(t,e){let s=0;Ht.notBlank(e)&&(s=(e.boundary().w+2)*this.scale);let i=Math.max(s,10*this.scale),o=this.scale*this.policy.data.fontSize;if(this.measure.measureText(t,o)[0]<i)return[t];let n=()=>{let e=[],s=t,n=0;for(;s.length>0;){let t=Ue.measureWidths(s,o),l=0;for(;l<t.length&&t[l]<i;)l++;for(let e=l;e>5;e--){if(" "==s[e]){l=e,n++;break}if(t[e]<.8*i)break}e.push(s.substring(0,l)),s=s.substring(l).trimLeft()}return[e,n]},[l,r]=n();for(;i>50;i-=o){let[t,e]=n();if(t.length>l.length)break;e>=r&&([l,r]=[t,e])}return l}}Ve.COMP_GAP_LEFT=.5,Ve.COMP_ANNOT_SIZE=1;class We{constructor(t,e,s){this.offsetX=t,this.offsetY=e,this.pointScale=s,this.invScale=1/s}scale(){return this.pointScale}angToX(t){return t*this.pointScale+this.offsetX}angToY(t){return t*-this.pointScale+this.offsetY}xToAng(t){return(t-this.offsetX)*this.invScale}yToAng(t){return(t-this.offsetY)*-this.invScale}yIsUp(){return!1}measureText(t,e){return Ue.main.measureText(t,e)}}!function(t){t[t.Centre=0]="Centre",t[t.Left=1]="Left",t[t.Right=2]="Right",t[t.Baseline=0]="Baseline",t[t.Middle=4]="Middle",t[t.Top=8]="Top",t[t.Bottom=16]="Bottom"}(Be||(Be={}));class Ge{constructor(t){this.types=[],this.prims=[],this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.scale=1,this.density=1,this.charMissing=!1,this.lowX=null,this.lowY=null,this.highX=null,this.highY=null;const e=Ue.main;if(this.charMask=s.booleanArray(!1,e.UNICODE.length),null!=t){null!=t.size&&(this.width=t.size[0],this.height=t.size[1]),null!=t.types&&(this.types=t.types),null!=t.prims&&(this.prims=t.prims);for(let t of this.prims)if(5==t[0]){let s=t[4];for(let t=0;t<s.length;t++){let i=e.getIndex(s.charAt(t));i>=0?this.charMask[i]=!0:this.charMissing=!0}}}}drawLine(t,e,s,i,o,n){null==n&&(n=1);let l=this.findOrCreateType([1,n,o]);const r=.5*n;this.updateBounds(Math.min(t,s)-r,Math.min(e,i)-r),this.updateBounds(Math.max(t,s)+r,Math.max(e,i)+r),this.prims.push([1,l,t,e,s,i])}drawRect(t,e,s,i,o,n,l){null==o&&(o=Ge.NOCOLOUR),null==l&&(l=Ge.NOCOLOUR),null==n&&(n=1);let r=this.findOrCreateType([2,o,l,n]);const a=.5*n;this.updateBounds(t-a,e-a),this.updateBounds(t+s+a,e+i+a),this.prims.push([2,r,t,e,s,i])}drawOval(t,e,s,i,o,n,l){null==o&&(o=Ge.NOCOLOUR),null==l&&(l=Ge.NOCOLOUR),null==n&&(n=1);const r=.5*n;this.updateBounds(t-s-r,e-i-r),this.updateBounds(t+s+r,e+i+r);let a=this.findOrCreateType([3,o,l,n]);this.prims.push([3,a,t,e,s,i])}drawPath(t,e,s,i,o,n,l,r){null==o&&(o=Ge.NOCOLOUR),null==l&&(l=Ge.NOCOLOUR),null==n&&(n=1),null==r&&(r=!1);const a=.5*n;for(let s=0;s<t.length;s++)this.updateBounds(t[s]-a,e[s]-a),0!=a&&this.updateBounds(t[s]+a,e[s]+a);let h=this.findOrCreateType([4,o,l,n,r]);this.prims.push([4,h,t.length,ft(t),ft(e),ft(s),i])}drawPoly(t,e,s,i,o,n){this.drawPath(t,e,null,!0,s,i,o,n)}drawText(t,e,i,o,n,l,r){null==l&&(l=Be.Left|Be.Baseline),null==r&&(r=0);let a=1,h=0;0!=r&&([a,h]=[Math.cos(r*J),Math.sin(r*J)]);const u=Ue.main;for(let t=0;t<i.length;t++){let e=u.getIndex(i.charAt(t));e>=0?this.charMask[e]=!0:this.charMissing=!0}let m=u.measureText(i,o),d=0,c=0,p=0;0!=(l&Be.Left)||(p=0!=(l&Be.Right)?-m[0]:-.5*m[0]),0!=p&&(d+=p*a,c+=p*h);let f=0;0!=(l&Be.Middle)?f=.5*m[1]:0!=(l&Be.Top)?f=m[1]:0!=(l&Be.Bottom)&&(f=-m[2]),0!=f&&(d-=f*h,c+=f*a);let g=0,b=0,A=0,y=0,E=0;for(let t=0;t<i.length;t++){let e=i.charAt(t),o=u.getIndex(e);if(o>=0){let n=u.getOutlineX(o),l=u.getOutlineY(o);g=Math.min(g,E+s.min(n)),A=Math.max(A,E+s.max(n)),b=Math.min(b,-s.max(l)),y=Math.max(y,-s.min(l)),E+=u.HORIZ_ADV_X[o],t<i.length-1&&(E+=u.getKerning(e,i.charAt(t+1)))}else E+=u.MISSING_HORZ}const M=o*u.INV_UNITS_PER_EM;if(0==r)this.updateBounds(t+d+g*M,e+c+b*M),this.updateBounds(t+d+A*M,e+c+y*M);else{let s=g*M,i=b*M,o=A*M,n=y*M;this.updateBounds(t+d+s*a-i*h,e+c+s*h+i*a),this.updateBounds(t+d+o*a-i*h,e+c+o*h+i*a),this.updateBounds(t+d+o*a-n*h,e+c+o*h+n*a),this.updateBounds(t+d+s*a-n*h,e+c+s*h+n*a)}let T=this.findOrCreateType([5,o,n]);this.prims.push([5,T,t+d,e+c,i,r])}drawTextNative(t,e,s,i,o,n,l,r){r||(r={}),null==l&&(l=Be.Left|Be.Baseline);const a=Ue.main;for(let t=0;t<s.length;t++){let e=a.getIndex(s.charAt(t));e>=0?this.charMask[e]=!0:this.charMissing=!0}let h=a.measureTextNative(s,i,o,r),u=0,m=0;0!=(l&Be.Left)||(u=0!=(l&Be.Right)?-h[0]:-.5*h[0]),0!=(l&Be.Middle)?m+=.5*h[1]:0!=(l&Be.Top)?m+=h[1]:0!=(l&Be.Bottom)&&(m-=h[2]),this.updateBounds(t,e-h[1]),this.updateBounds(t+h[0],e+h[2]);let d=this.findOrCreateType([6,i,o,n,r]);this.prims.push([6,d,t+u,e+m,s])}boundLowX(){return this.lowX}boundLowY(){return this.lowY}boundHighX(){return this.highX}boundHighY(){return this.highY}getBounds(){return new c(this.lowX,this.lowY,this.highX-this.lowX,this.highY-this.lowY)}measure(){this.width=Math.ceil(this.highX-this.lowX),this.height=Math.ceil(this.highY-this.lowY)}normalise(){0==this.lowX&&0==this.lowY||this.transformPrimitives(-this.lowX,-this.lowY,1,1),this.width=Math.ceil(this.highX-this.lowX),this.height=Math.ceil(this.highY-this.lowY)}setSize(t,e){this.width=t,this.height=e}transformIntoBox(t){this.transformPrimitives(-this.lowX,-this.lowY,1,1);let e=Math.ceil(this.highX-this.lowX),s=Math.ceil(this.highY-this.lowY),i=1;if(e>t.w){let o=t.w/e;e=t.w,s*=o,i*=o}if(s>t.h){let o=t.h/s;s=t.h,e*=o,i*=o}let o=.5*(t.w-e),n=.5*(t.h-s);this.transformPrimitives(t.x+o,t.y+n,i,i)}scaleExtent(t,e){let s=this.highX-this.lowX,i=this.highY-this.lowY;if(s<=t&&i<=e)return;let o=Math.min(t/s,e/i);this.transformPrimitives(0,0,o,o)}transformPrimitives(t,e,s,i){if(0==t&&0==e&&1==s&&1==i)return;for(let o of this.prims){const n=o[0];if(1==n)o[2]=t+o[2]*s,o[3]=e+o[3]*i,o[4]=t+o[4]*s,o[5]=e+o[5]*i;else if(2==n)o[2]=t+o[2]*s,o[3]=e+o[3]*i,o[4]=o[4]*s,o[5]=o[5]*i;else if(3==n)o[2]=t+o[2]*s,o[3]=e+o[3]*i,o[4]*=s,o[5]*=i;else if(4==n){let n=o[2],l=o[3],r=o[4];for(let o=0;o<n;o++)l[o]=t+l[o]*s,r[o]=e+r[o]*i}else 5!=n&&6!=n||(o[2]=t+o[2]*s,o[3]=e+o[3]*i)}let o=.5*(s+i);if(1!=o)for(let t of this.types){const e=t[0];1==e?t[1]*=o:2==e||3==e||4==e?t[3]*=o:5==e?t[1]*=o:6==e&&(t[2]*=o)}this.lowX=t+this.lowX*s,this.lowY=e+this.lowY*i,this.highX=t+this.highX*s,this.highY=e+this.highY*i}renderInto(t){let e=x(t,"canvas",{width:this.width,height:this.height});return this.renderCanvas(e),e}renderCanvas(t,e){let s=t.getContext("2d");e&&s.clearRect(0,0,t.width,t.height);let i=this.width,o=this.height;this.density=pt(),t.style.width=i+"px",t.style.height=o+"px",t.width=i*this.density,t.height=o*this.density,this.renderContext(s)}renderContext(t){t.save(),t.scale(this.density,this.density),this.typeObj=[];for(let t=0;t<this.types.length;t++){let e=this.types[t];1==e[0]?this.typeObj[t]=this.setupTypeLine(e):2==e[0]?this.typeObj[t]=this.setupTypeRect(e):3==e[0]?this.typeObj[t]=this.setupTypeOval(e):4==e[0]?this.typeObj[t]=this.setupTypePath(e):5==e[0]?this.typeObj[t]=this.setupTypeText(e):6==e[0]&&(this.typeObj[t]=this.setupTypeTextNative(e))}for(let e=0;e<this.prims.length;e++){let s=this.prims[e];1==s[0]?this.renderLine(t,s):2==s[0]?this.renderRect(t,s):3==s[0]?this.renderOval(t,s):4==s[0]?this.renderPath(t,s):5==s[0]?this.renderText(t,s):6==s[0]&&this.renderTextNative(t,s)}t.restore()}createSVG(t=!1,e=!1){let s=g.parseXML("<svg/>"),i=s.documentElement;return i.setAttribute("xmlns","http://www.w3.org/2000/svg"),e&&i.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),i.setAttribute("width",this.width.toString()),i.setAttribute("height",this.height.toString()),i.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.renderSVG(i,e),t?g.toPrettyString(s):g.toString(s)}renderSVG(t,e=!1){this.typeObj=[];const s=Ue.main;let i=g.appendElement(t,"defs");if(this.charMissing){let t=g.appendElement(i,"path");t.setAttribute("id","missing"),t.setAttribute("d",s.MISSING_DATA),t.setAttribute("edge","none")}for(let t=0;t<s.UNICODE.length;t++)if(this.charMask[t]){let e=g.appendElement(i,"path");e.setAttribute("id","char"+t),e.setAttribute("d",s.GLYPH_DATA[t]),e.setAttribute("edge","none")}for(let t=0;t<this.types.length;t++){let e=this.types[t];1==e[0]?this.typeObj[t]=this.setupTypeLine(e):2==e[0]?this.typeObj[t]=this.setupTypeRect(e):3==e[0]?this.typeObj[t]=this.setupTypeOval(e):4==e[0]?this.typeObj[t]=this.setupTypePath(e):5==e[0]?this.typeObj[t]=this.setupTypeText(e):6==e[0]&&(this.typeObj[t]=this.setupTypeTextNative(e))}for(let s=0;s<this.prims.length;){let i=this.prims[s],o=1;if(4!=i[0]&&5!=i[0]&&6!=i[0])for(;s+o<this.prims.length&&this.prims[s+o][0]==i[0]&&this.prims[s+o][1]==i[1];o++);1==i[0]?1==o?this.svgLine1(t,i):this.svgLineN(t,i,s,o):2==i[0]?1==o?this.svgRect1(t,i):this.svgRectN(t,i,s,o):3==i[0]?1==o?this.svgOval1(t,i):this.svgOvalN(t,i,s,o):4==i[0]?this.svgPath(t,i):5==i[0]?this.svgText(t,i,e):6==i[0]&&this.svgTextNative(t,i),s+=o}}spool(t){for(let e of this.prims)if(1==e[0]){let[s,i,o,n,l,r]=e,[,a,h]=this.types[i];t.drawLine(o,n,l,r,h,a)}else if(2==e[0]){let[s,i,o,n,l,r]=e,[,a,h,u]=this.types[i];t.drawRect(o,n,l,r,a,u,h)}else if(3==e[0]){let[s,i,o,n,l,r]=e,[,a,h,u]=this.types[i];t.drawOval(o,n,l,r,a,u,h)}else if(4==e[0]){let[s,i,o,n,l,r,a]=e,[,h,u,m,d]=this.types[i];t.drawPath(n,l,r,a,h,m,u,d)}else if(5==e[0]){let[s,i,o,n,l,r]=e,[,a,h]=this.types[i];t.drawText(o,n,l,a,h,null,r)}else if(6==e[0]){let[s,i,o,n,l]=e,[,r,a,h]=this.types[i];t.drawTextNative(o,n,l,r,a,h)}}setupTypeLine(t){return{thickness:t[1]*this.scale,colour:t[2]}}setupTypeRect(t){return{edgeCol:t[1],fillCol:t[2],thickness:t[3]*this.scale}}setupTypeOval(t){return{edgeCol:t[1],fillCol:t[2],thickness:t[3]*this.scale}}setupTypePath(t){return{edgeCol:t[1],fillCol:t[2],thickness:t[3]*this.scale,hardEdge:t[4]}}setupTypeText(t){let e=t[1]*this.scale;return{colour:t[2],size:e}}setupTypeTextNative(t){let e=t[1],s=t[2]*this.scale;return{colour:t[3],family:e,size:s,opt:t[4]}}renderLine(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5],r=s.colour;i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n=this.offsetX+this.scale*n,l=this.offsetY+this.scale*l,null!=r&&(t.beginPath(),t.moveTo(i,o),t.lineTo(n,l),t.strokeStyle=B(r),t.lineWidth=s.thickness,t.lineCap="round",t.stroke())}renderRect(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5],r=s.edgeCol,a=s.fillCol;i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n*=this.scale,l*=this.scale,a!=Ge.NOCOLOUR&&(t.fillStyle=B(a),t.fillRect(i,o,n,l)),r!=Ge.NOCOLOUR&&(t.strokeStyle=B(r),t.lineWidth=s.thickness,t.lineCap="square",t.strokeRect(i,o,n,l))}renderOval(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5],r=s.edgeCol,a=s.fillCol;i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n*=this.scale,l*=this.scale,a!=Ge.NOCOLOUR&&(t.fillStyle=B(a),t.beginPath(),t.ellipse(i,o,n,l,0,0,2*Math.PI,!0),t.fill()),r!=Ge.NOCOLOUR&&(t.strokeStyle=B(r),t.lineWidth=s.thickness,t.beginPath(),t.ellipse(i,o,n,l,0,0,2*Math.PI,!0),t.stroke())}renderPath(t,e){let i=this.typeObj[e[1]],o=e[2];if(0==o)return;let n=s.duplicate(e[3]),l=s.duplicate(e[4]),r=e[5],a=e[6],h=i.edgeCol,u=i.fillCol;for(let t=0;t<o;t++)n[t]=this.offsetX+this.scale*n[t],l[t]=this.offsetY+this.scale*l[t];for(let e=1;e<=2;e++)if(!(1==e&&u==Ge.NOCOLOUR||2==e&&h==Ge.NOCOLOUR)){t.beginPath(),t.moveTo(n[0],l[0]);for(let e=1;e<o;e++)r&&r[e]?e<o-1&&!r[e+1]?(t.quadraticCurveTo(n[e],l[e],n[e+1],l[e+1]),e++):e<o-1&&!r[e+2]&&(t.bezierCurveTo(n[e],l[e],n[e+1],l[e+1],n[e+2],l[e+2]),e+=2):t.lineTo(n[e],l[e]);a&&t.closePath(),1==e?(t.fillStyle=B(i.fillCol),t.fill()):(t.strokeStyle=B(i.edgeCol),t.lineWidth=i.thickness,t.lineCap=i.hardEdge?"square":"round",t.lineJoin=i.hardEdge?"miter":"round",t.stroke())}}renderText(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=s.size,r=B(s.colour);i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o;let a=Ue.main,h=l/a.UNITS_PER_EM,u=0;for(let e=0;e<n.length;e++){let s=n.charAt(e),l=a.getIndex(s),m=null;l<0?(u+=a.MISSING_HORZ,m=a.getMissingPath()):m=a.getGlyphPath(l),m&&(t.save(),t.translate(i+u*h,o),t.scale(h,-h),t.fillStyle=r,t.fill(m),t.restore()),u+=a.HORIZ_ADV_X[l],e<n.length-1&&(u+=a.getKerning(s,n.charAt(e+1)))}}renderTextNative(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=s.family,r=s.size,a=s.opt,h=B(s.colour);i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,t.save();let u="";a.bold&&(u+="bold "),a.italic&&(u+="italic "),t.font=u+r+"px "+l,t.fillStyle=h,t.fillText(n,i,o),t.restore()}svgLine1(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5];if(i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n=this.offsetX+this.scale*n,l=this.offsetY+this.scale*l,s.colour!=Ge.NOCOLOUR){let e=g.appendElement(t,"line");e.setAttribute("x1",i.toString()),e.setAttribute("y1",o.toString()),e.setAttribute("x2",n.toString()),e.setAttribute("y2",l.toString()),this.defineSVGStroke(e,s.colour),e.setAttribute("stroke-width",s.thickness.toString()),e.setAttribute("stroke-linecap","round")}}svgLineN(t,e,s,i){let o=this.typeObj[e[1]];if(o.colour==Ge.NOCOLOUR)return;let n=g.appendElement(t,"g");this.defineSVGStroke(n,o.colour),n.setAttribute("stroke-width",o.thickness.toString()),n.setAttribute("stroke-linecap","round");for(let t=0;t<i;t++){let e=this.prims[s+t],i=e[2],o=e[3],l=e[4],r=e[5];i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,l=this.offsetX+this.scale*l,r=this.offsetY+this.scale*r;let a=g.appendElement(n,"line");a.setAttribute("x1",i.toString()),a.setAttribute("y1",o.toString()),a.setAttribute("x2",l.toString()),a.setAttribute("y2",r.toString())}}svgRect1(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5];i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n*=this.scale,l*=this.scale;let r=g.appendElement(t,"rect");r.setAttribute("x",i.toString()),r.setAttribute("y",o.toString()),r.setAttribute("width",n.toString()),r.setAttribute("height",l.toString()),this.defineSVGStroke(r,s.edgeCol),s.edgeCol!=Ge.NOCOLOUR&&(r.setAttribute("stroke-width",s.thickness.toString()),r.setAttribute("stroke-linecap","square")),this.defineSVGFill(r,s.fillCol)}svgRectN(t,e,s,i){let o=this.typeObj[e[1]],n=g.appendElement(t,"g");this.defineSVGStroke(n,o.edgeCol),o.edgeCol!=Ge.NOCOLOUR&&(n.setAttribute("stroke-width",o.thickness.toString()),n.setAttribute("stroke-linecap","square")),this.defineSVGFill(n,o.fillCol);for(let t=0;t<i;t++){let e=this.prims[s+t],i=e[2],o=e[3],l=e[4],r=e[5];i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,l*=this.scale,r*=this.scale;let a=g.appendElement(n,"rect");a.setAttribute("x",i.toString()),a.setAttribute("y",o.toString()),a.setAttribute("width",l.toString()),a.setAttribute("height",r.toString())}}svgOval1(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=e[5];i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,n*=this.scale,l*=this.scale;let r=g.appendElement(t,"ellipse");r.setAttribute("cx",i.toString()),r.setAttribute("cy",o.toString()),r.setAttribute("rx",n.toString()),r.setAttribute("ry",l.toString()),this.defineSVGStroke(r,s.edgeCol),s.edgeCol!=Ge.NOCOLOUR&&r.setAttribute("stroke-width",s.thickness.toString()),this.defineSVGFill(r,s.fillCol)}svgOvalN(t,e,s,i){let o=this.typeObj[e[1]],n=g.appendElement(t,"g");this.defineSVGStroke(n,o.edgeCol),o.edgeCol!=Ge.NOCOLOUR&&n.setAttribute("stroke-width",o.thickness.toString()),this.defineSVGFill(n,o.fillCol);for(let t=0;t<i;t++){let e=this.prims[s+t],i=e[2],o=e[3],l=e[4],r=e[5];i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o,l*=this.scale,r*=this.scale;let a=g.appendElement(n,"ellipse");a.setAttribute("cx",i.toString()),a.setAttribute("cy",o.toString()),a.setAttribute("rx",l.toString()),a.setAttribute("ry",r.toString())}}svgPath(t,e){let s=this.typeObj[e[1]],i=e[2];if(0==i)return;let o=e[3].slice(0),n=e[4].slice(0),l=e[5],r=e[6];for(let t=0;t<i;t++)o[t]=this.offsetX+this.scale*o[t],n[t]=this.offsetY+this.scale*n[t];let a="M "+o[0]+" "+n[0],h=1;for(;h<i;)l&&l[h]?l[h]&&h<i-1&&!l[h+1]?(a+=" Q "+o[h]+" "+n[h]+" "+o[h+1]+" "+n[h+1],h+=2):l[h]&&h<i-2&&l[h+1]&&!l[h+2]?(a+=" C "+o[h]+" "+n[h]+" "+o[h+1]+" "+n[h+1]+" "+o[h+2]+" "+n[h+2],h+=3):h++:(a+=" L "+o[h]+" "+n[h],h++);r&&(a+=" Z");let u=g.appendElement(t,"path");u.setAttribute("d",a),this.defineSVGStroke(u,s.edgeCol),s.edgeCol!=Ge.NOCOLOUR&&(u.setAttribute("stroke-width",s.thickness.toString()),u.setAttribute("stroke-linejoin",s.hardEdge?"miter":"round"),u.setAttribute("stroke-linecap",s.hardEdge?"square":"round")),this.defineSVGFill(u,s.fillCol)}svgText(t,e,s=!0){let i=this.typeObj[e[1]],o=e[2],n=e[3],l=e[4],r=e[5],a=i.size;o=this.offsetX+this.scale*o,n=this.offsetY+this.scale*n;let h=Ue.main,u=a/h.UNITS_PER_EM,m=t;0!=r&&(m=g.appendElement(m,"g"),m.setAttribute("transform",`rotate(${r},${o},${n})`));let d=g.appendElement(m,"g");d.setAttribute("transform","translate("+o+","+n+")"),this.defineSVGFill(d,i.colour);let c=g.appendElement(d,"g");c.setAttribute("transform","scale("+u+","+-u+")");let p=0;for(let t=0;t<l.length;t++){let e=l.charAt(t),i=h.getIndex(e),o=g.appendElement(c,"use"),n=i<0?"#missing":"#char"+i;s?o.setAttribute("xlink:href",n):o.setAttribute("href",n),o.setAttribute("x",p.toString()),i>=0?(p+=h.HORIZ_ADV_X[i],t<l.length-1&&(p+=h.getKerning(e,l.charAt(t+1)))):p+=h.MISSING_HORZ}}svgTextNative(t,e){let s=this.typeObj[e[1]],i=e[2],o=e[3],n=e[4],l=s.family,r=s.size,a=s.opt;i=this.offsetX+this.scale*i,o=this.offsetY+this.scale*o;let h=`fill: ${B(s.colour)}; font-family: ${l}; font-size: ${r};`;a.bold&&(h+=" font-weight: bold;"),a.italic&&(h+=" font-style: italic;");let u=g.appendElement(t,"text");u.setAttribute("xml:space","preserve"),u.setAttribute("x",i.toString()),u.setAttribute("y",o.toString()),u.setAttribute("style",h),g.setText(u,n)}defineSVGStroke(t,e){if(e==Ge.NOCOLOUR)return void t.setAttribute("stroke-opacity","0");t.setAttribute("stroke",w(e));let s=O(e);1!=s&&t.setAttribute("stroke-opacity",s.toString())}defineSVGFill(t,e){if(e==Ge.NOCOLOUR)return void t.setAttribute("fill-opacity","0");t.setAttribute("fill",w(e));let s=O(e);1!=s&&t.setAttribute("fill-opacity",s.toString())}findOrCreateType(t){for(let e=0;e<this.types.length;e++){if(this.types[e].length!=t.length)continue;let s=!0;for(let i=0;i<t.length;i++)if(t[i]!=this.types[e][i]){s=!1;break}if(s)return e}return this.types.push(t),this.types.length-1}updateBounds(t,e){if(null==this.lowX)return this.lowX=t,this.lowY=e,this.highX=t,void(this.highY=e);this.lowX=Math.min(this.lowX,t),this.lowY=Math.min(this.lowY,e),this.highX=Math.max(this.highX,t),this.highY=Math.max(this.highY,e)}}Ge.NOCOLOUR=-1;class $e{constructor(t,e){this.layout=t,this.vg=e,this.mol=t.getMolecule(),this.policy=t.getPolicy(),this.effects=t.getEffects(),this.scale=t.getScale(),this.invScale=1/this.scale}getMolecule(){return this.mol}getMetaVector(){return this.vg}getLayout(){return this.layout}getPolicy(){return this.policy}getEffects(){return this.effects}draw(){this.drawUnderEffects();let t=this.layout,e=this.effects,s=this.policy,i=this.vg;for(let s=0;s<t.numLines();s++){let o=t.getLine(s);e.hideBonds.has(o.bnum)||(o.type==we.Normal?i.drawLine(o.line.x1,o.line.y1,o.line.x2,o.line.y2,o.col,o.size):o.type==we.Inclined?this.drawBondInclined(o):o.type==we.Declined?this.drawBondDeclined(o):o.type==we.Unknown?this.drawBondUnknown(o):o.type==we.Dotted||o.type==we.DotDir?this.drawBondDotted(o):o.type!=we.IncDouble&&o.type!=we.IncTriple&&o.type!=we.IncQuadruple||this.drawBondIncMulti(o))}let o=s.data.foreground;for(let e of t.getRings())i.drawOval(e.cx,e.cy,e.rw,e.rh,o,e.size,Ge.NOCOLOUR);for(let e of t.getPaths())i.drawPath(e.px,e.py,e.ctrl,!1,o,e.size,Ge.NOCOLOUR,!1);for(let s=0;s<t.numPoints();s++){let o=t.getPoint(s);if(e.hideBonds.has(o.anum))continue;let n=o.text;if(null==n)continue;let l=o.fsz,r=o.oval.cx,a=o.oval.cy,h=o.oval.rw,u=o.col;for(;n.endsWith(".");){let t=h/n.length,e=.15*l;i.drawOval(r+h-t,a,e,e,Ge.NOCOLOUR,0,u),r-=t,h-=t,n=n.substring(0,n.length-1)}for(;n.startsWith("+");){let t=h/n.length,e=r-h+t,s=a,o=.18*l,m=.1*l;i.drawLine(e-o,s,e+o,s,u,m),i.drawLine(e,s-o,e,s+o,u,m),r+=t,h-=t,n=n.substring(1,n.length)}for(;n.startsWith("-");){let t=h/n.length,e=r-h+t,s=a,o=.18*l,m=.1*l;i.drawLine(e-o,s,e+o,s,u,m),r+=t,h-=t,n=n.substring(1,n.length)}n.length>0&&i.drawText(r,a,n,l,u,Be.Centre|Be.Middle)}this.drawOverEffects()}drawUnderEffects(){let t=this.mol,e=(this.policy,this.effects),s=this.layout,i=this.scale,o=this.vg;for(let n=0,l=Math.min(e.atomFrameDotSz.length,t.numAtoms);n<l;n++){if(e.hideAtoms.has(n+1))continue;let t=e.atomFrameDotSz[n]*i,l=e.atomFrameCol[n],r=s.getPoint(n),a=r.oval.rw+.1*i,h=r.oval.rh+.1*i,u=Math.ceil(2*a/(3*t)),m=Math.ceil(2*h/(3*t)),d=2*a/u,c=2*h/m;for(let e=0;e<=u;e++){let s=r.oval.cx-a+e*d;o.drawOval(s,r.oval.cy-h,t,t,Ge.NOCOLOUR,0,l),o.drawOval(s,r.oval.cy+h,t,t,Ge.NOCOLOUR,0,l)}for(let e=1;e<m;e++){let s=r.oval.cy-h+e*c;o.drawOval(r.oval.cx-a,s,t,t,Ge.NOCOLOUR,0,l),o.drawOval(r.oval.cx+a,s,t,t,Ge.NOCOLOUR,0,l)}}for(let t in e.dottedRectOutline){let n=parseInt(t),l=e.dottedRectOutline[t],r=s.getPoint(n-1),a=Math.max(r.oval.rw,.2*i),h=Math.max(r.oval.rh,.2*i),u=.05*i,m=Math.max(1,Math.round(a/(2*u))),d=Math.max(1,Math.round(h/(2*u))),c=2*a/m,p=2*h/d;for(let t=0;t<=m;t++){let e=r.oval.cx-a+t*c;o.drawOval(e,r.oval.cy-h,u,u,Ge.NOCOLOUR,0,l),o.drawOval(e,r.oval.cy+h,u,u,Ge.NOCOLOUR,0,l)}for(let t=1;t<d;t++){let e=r.oval.cy-h+t*p;o.drawOval(r.oval.cx-a,e,u,u,Ge.NOCOLOUR,0,l),o.drawOval(r.oval.cx+a,e,u,u,Ge.NOCOLOUR,0,l)}}for(let t in e.dottedBondCross){let n=parseInt(t),l=e.dottedBondCross[t],r=0,a=0,h=0,u=0,m=0;for(let t=0;t<s.numLines();t++){let e=s.getLine(t);e.bnum==n&&(r+=e.line.x1,a+=e.line.y1,h+=e.line.x2,u+=e.line.y2,m+=1)}if(m>1){let t=1/m;[r,a,h,u]=[r*t,a*t,h*t,u*t]}let d=h-r,c=u-a,p=.2*i*W(U(d,c)),f=c*p,g=-d*p,b=.5*(r+h),A=.5*(a+u),y=.05*i;for(let t of[-2,-1,1,2]){let e=b+t*f,s=A+t*g;o.drawOval(e,s,y,y,Ge.NOCOLOUR,0,l)}}}drawOverEffects(){let t=this.mol,e=(this.policy,this.effects),s=this.layout,i=this.scale,o=this.vg;for(let t of e.overlapAtoms){let e=s.getPoint(t-1),n=.2*i;o.drawLine(e.oval.cx-n,e.oval.cy-n,e.oval.cx+n,e.oval.cy+n,16711680,1),o.drawLine(e.oval.cx+n,e.oval.cy-n,e.oval.cx-n,e.oval.cy+n,16711680,1)}for(let n=0,l=Math.min(e.atomCircleSz.length,t.numAtoms);n<l;n++)if(e.atomCircleSz[n]>0){let t=e.atomCircleSz[n]*i,l=e.atomCircleCol[n],r=s.getPoint(n);o.drawOval(r.oval.cx,r.oval.cy,t,t,Ge.NOCOLOUR,0,l)}}drawBondInclined(t){let e=t.line.x1,s=t.line.y1,i=t.line.x2,o=t.line.y2,n=i-e,l=o-s,r=t.col,h=(t.size,t.head/Math.sqrt(n*n+l*l)),u=h*l,m=-h*n,d=[e,i-u,i+u],c=[s,o-m,o+m];if(null==this.layout.getPoint(t.bto-1).text&&2==this.mol.atomAdjCount(t.bto)){let n=null;for(let e=0;e<this.layout.numLines();e++){let s=this.layout.getLine(e);if(s.type==we.Normal&&(s.bfr==t.bto||s.bto==t.bto)){if(null!=n){n=null;break}n=s}}if(null!=n){let l=Math.atan2(s-o,e-i),r=Math.atan2(n.line.y1-n.line.y2,n.line.x1-n.line.x2);t.bto==n.bfr&&(r+=Math.PI);let h=Math.abs(st(l,r));if(h>105*J&&h<135*J){let t=a.lineIntersect(d[0],c[0],d[1],c[1],n.line.x1,n.line.y1,n.line.x2,n.line.y2),e=a.lineIntersect(d[0],c[0],d[2],c[2],n.line.x1,n.line.y1,n.line.x2,n.line.y2);d[1]=t[0],c[1]=t[1],d[2]=e[0],c[2]=e[1];let s=d[1]-d[0],i=c[1]-c[0],o=.5*n.size/U(s,i);d[1]+=s*o,c[1]+=i*o;let l=d[2]-d[0],r=c[2]-c[0];n.size,U(l,r),d[2]+=l*o,c[2]+=r*o}}}if(null==this.layout.getPoint(t.bto-1).text&&3==this.mol.atomAdjCount(t.bto)){let n=null,l=null;for(let e=0;e<this.layout.numLines();e++){let s=this.layout.getLine(e);if(s.type==we.Normal&&(s.bfr==t.bto||s.bto==t.bto))if(null==n)n=s;else{if(null!=l){n=l=null;break}l=s}}if(null!=n&&null!=l){let r=Math.atan2(s-o,e-i),h=Math.atan2(n.line.y1-n.line.y2,n.line.x1-n.line.x2),u=Math.atan2(l.line.y1-l.line.y2,l.line.x1-l.line.x2);t.bto==n.bfr&&(h+=Math.PI),t.bto==l.bfr&&(u+=Math.PI);let m=st(r,h),p=Math.abs(m),f=st(r,u),g=Math.abs(f),b=Math.abs(st(h,u));if(p>105*J&&p<135*J||g>105*J&&g<135*J||b>105*J&&b<135*J){m<0&&([n,l]=[l,n]);let t=a.lineIntersect(d[0],c[0],d[1],c[1],n.line.x1,n.line.y1,n.line.x2,n.line.y2),r=a.lineIntersect(d[0],c[0],d[2],c[2],l.line.x1,l.line.y1,l.line.x2,l.line.y2);d=[e,t[0],i,r[0]],c=[s,t[1],o,r[1]]}}}this.vg.drawPoly(d,c,Ge.NOCOLOUR,0,r,!0)}drawBondDeclined(t){let e=t.line.x1,s=t.line.y1,i=t.line.x2-e,o=t.line.y2-s,n=t.col,l=t.size,r=t.head,a=Math.sqrt(i*i+o*o),h=Math.ceil(2.5*a*this.invScale),u=r/a,m=u*o,d=-u*i,c=1/(h+1),p=1==this.mol.atomAdjCount(t.bto)&&null==this.layout.getPoint(t.bto-1).text?1:1-.15*this.scale/a;for(let t=0;t<=h+1;t++){let r=e+t*i*c*p,a=s+t*o*c*p,h=m*t*c,u=d*t*c;this.vg.drawLine(r-h,a-u,r+h,a+u,n,l)}}drawBondUnknown(t){let e=t.line.x1,i=t.line.y1,o=t.line.x2-e,n=t.line.y2-i,l=t.col,r=t.size,a=t.head,h=Math.sqrt(o*o+n*n),u=Math.ceil(3.5*h*this.invScale),m=a/h,d=m*n,c=-m*o,p=1+3*(u+1),f=s.numberArray(0,p),g=s.numberArray(0,p),b=s.booleanArray(!1,p);f[0]=e,g[0]=i,b[0]=!1;for(let t=0,s=1;t<=u;t++,s+=3){let l=e+t*o/(u+1),r=i+t*n/(u+1),a=e+(t+1)*o/(u+1),h=i+(t+1)*n/(u+1),m=(l+a)/2,p=(r+h)/2,A=t%2==0?1:-1;f[s]=l,f[s+1]=m+A*d,f[s+2]=a,g[s]=r,g[s+1]=p+A*c,g[s+2]=h,b[s]=!0,b[s+1]=!0,b[s+2]=!1}this.vg.drawPath(f,g,b,!1,l,r,Ge.NOCOLOUR,!1)}drawBondDotted(t){let e=t.line.x1,s=t.line.y1,i=t.line.x2,o=t.line.y2,n=i-e,l=o-s,r=t.col,a=t.size,h=a,u=U(n,l);if(u<.01)return;let m=.5*a/u;e+=m*n,s+=m*l,i-=m*n,o-=m*l,n=i-e,l=o-s;let d=Math.ceil(.2*u/h),c=1/(d+1);for(let i=0;i<=d+1;i++){let o=h;t.type==we.DotDir&&(o*=i*(1/(d+2))-.5+1);let a=e+i*n*c,u=s+i*l*c;this.vg.drawOval(a,u,o,o,Ge.NOCOLOUR,0,r)}}drawBondIncMulti(t){let e=t.line.x1,s=t.line.y1,i=t.line.x2,o=t.line.y2,n=i-e,l=o-s,r=t.col,a=(t.size,t.head/Math.sqrt(n*n+l*l)),h=a*l,u=-a*n;this.vg.drawPoly([e,i-h,i+h],[s,o-u,o+u],r,.05*this.scale,Ge.NOCOLOUR,!0),t.type==we.IncDouble?this.vg.drawLine(e,s,i,o,r,.03*this.scale):(this.vg.drawLine(e,s,i+.33*h,o+.33*u,r,.03*this.scale),this.vg.drawLine(e,s,i-.33*h,o-.33*u,r,.03*this.scale))}}class Qe{constructor(t,e){this.layout=t,this.vg=e,this.preDrawComponent=null,this.preDrawMolecule=null,this.postDrawMolecule=null,this.molDrawn=[],this.entry=t.entry,this.measure=t.measure,this.policy=t.policy,this.scale=t.scale,this.invScale=1/this.scale}draw(){this.molDrawn=s.anyArray(null,this.layout.components.length);for(let t=0;t<this.layout.components.length;t++){let e=this.layout.components[t];e.type==Oe.Arrow?this.drawSymbolArrow(e):e.type==Oe.Plus?this.drawSymbolPlus(e):this.drawComponent(t,e)}}drawComponent(t,e){let i=this.vg,o=this.policy,n=e.box.x+e.padding,l=e.box.y+e.padding,r=e.box.w-2*e.padding,a=e.box.h-2*e.padding;if(this.preDrawComponent&&this.preDrawComponent(i,t,e),e.srcIdx<0||Ht.isBlank(e.mol)&&s.isBlank(e.text)){let t=.5*a;i.drawText(n+.5*r,l+.5*a,"?",t,o.data.foreground,Be.Centre|Be.Middle)}else{if(s.notBlank(e.text)){let t=this.measure.measureText("!",e.fszText),s=t[1]+t[2],h=s*e.text.length,u=l+a-s*(e.text.length-1);for(let t of e.text)this.measure.measureText(t,e.fszText),i.drawText(n+.5*r,u,t,e.fszText,o.data.foreground,Be.Centre|Be.Baseline),u+=s;a-=h+.5*e.fszText}if(e.leftNumer){let t=this.measure.measureText(e.leftNumer,e.fszLeft);if(e.leftDenom){let s=this.measure.measureText(e.leftDenom,e.fszLeft),h=Math.max(t[0],s[0]),u=n+.5*h,m=l+.5*a;i.drawText(u,m,e.leftNumer,e.fszLeft,o.data.foreground,Be.Centre|Be.Bottom),i.drawText(u,m+t[2],e.leftDenom,e.fszLeft,o.data.foreground,Be.Centre|Be.Top),i.drawLine(n,m,n+h,m,o.data.foreground,.03*this.scale);let d=h+Ve.COMP_GAP_LEFT*(t[1]+t[2]);n+=d,r-=d}else{i.drawText(n,l+.5*a,e.leftNumer,e.fszLeft,o.data.foreground,Be.Left|Be.Middle);let s=t[0]+Ve.COMP_GAP_LEFT*(t[1]+t[2]);n+=s,r-=s}}if(0!=e.annot){let t=Ve.COMP_ANNOT_SIZE*this.scale;r-=t,this.drawAnnotation(e.annot,n+r,l,t,a)}if(Ht.notBlank(e.mol)){let h=new Xe;if(this.layout.includeAtomMap){h.atomDecoText=s.stringArray("",e.mol.numAtoms),h.atomDecoCol=s.numberArray(this.layout.colourAtomMap,e.mol.numAtoms),h.atomDecoSize=s.numberArray(.3,e.mol.numAtoms);for(let t=1;t<=e.mol.numAtoms;t++)e.mol.atomMapNum(t)>0&&(h.atomDecoText[t-1]=e.mol.atomMapNum(t).toString())}let u=new He(e.mol,this.layout.measure,o,h);u.arrange(),u.squeezeInto(n,l,r,a,0),this.preDrawMolecule&&this.preDrawMolecule(i,t,e,u),new $e(u,i).draw(),this.postDrawMolecule&&this.postDrawMolecule(i,t,e,u),this.molDrawn[t]=u}}}drawSymbolArrow(t){let e=t.box.x+t.padding,s=t.box.y+t.padding,i=t.box.w-2*t.padding,o=t.box.h-2*t.padding;i>o?this.drawArrow(e,s+.5*o,e+i,s+.5*o,o,this.policy.data.foreground,.05*this.scale):this.drawArrow(e+.5*i,s,e+.5*i,s+o,i,this.policy.data.foreground,.05*this.scale)}drawSymbolPlus(t){let e=this.vg,s=this.policy,i=t.box.x+t.padding,o=t.box.y+t.padding,n=i+t.box.w-2*t.padding,l=o+t.box.h-2*t.padding,r=.5*(i+n),a=.5*(o+l),h=.1*(n-i+l-o);e.drawLine(i,a,n,a,s.data.foreground,h),e.drawLine(r,o,r,l,s.data.foreground,h)}drawAnnotation(t,e,s,i,o){let n=this.vg,l=this.policy,r=i,a=e+i,h=s+o,u=a-r,m=s;if(t==qe.Primary?h=m+r:t==qe.Waste&&(m=h-r),t==qe.Primary){let t=.5*(u+a),e=.5*(m+h),s=.25*r,i=[t,t+.866*s,t+.866*s,t,t-.866*s,t-.866*s],o=[e-s,e-.5*s,e+.5*s,e+s,e+.5*s,e-.5*s],d=.05*this.scale;n.drawLine(i[0],o[0],i[3],o[3],l.data.foreground,d),n.drawLine(i[1],o[1],i[4],o[4],l.data.foreground,d),n.drawLine(i[2],o[2],i[5],o[5],l.data.foreground,d);let c=.1*r;n.drawOval(u+.5*r,m+.5*r,.5*r-c,.5*r-c,l.data.foreground,d,Ge.NOCOLOUR)}else if(t==qe.Waste){let t=u+.7*r,e=.5*(m+h),s=.25*r,i=.05*this.scale,o=[u+.1*r,t-s,t,t,t],a=[m,m,m,e-s,e],d=[!1,!1,!0,!1,!1];n.drawPath(o,a,d,!1,l.data.foreground,i,Ge.NOCOLOUR,!1);for(let s=0;s<4;s++){let o=e+.45*s*r*(1/3),a=.1*(3.1-s)*r;n.drawLine(t-a,o,t+a,o,l.data.foreground,i)}}else if(t==qe.Implied){let t=.5*r,e=.75*r,s=a-.5*t,i=m+.5*e,o=m+.25*e,h=.1*r*.5,u=.05*this.scale,d=l.data.foreground;n.drawLine(s,m,s,m+e,d,u),n.drawLine(a-t,o,a,o,d,u),n.drawLine(a-t,i,a,i,d,u),n.drawOval(a-t+h,m+e-h,h,h,0,0,d),n.drawOval(a-h,m+e-h,h,h,0,0,d)}}drawArrow(t,e,s,i,o,n,l){let r=s-t,a=i-e,h=W(U(r,a));r*=h,a*=h;let u=-r,m=s-r*o,d=i-a*o,c=[t+.5*a*l,m+.5*a*l,m+.5*a*o,s,m-.5*a*o,m-.5*a*l,t-.5*a*l],p=[e+.5*u*l,d+.5*u*l,d+.5*u*o,i,d-.5*u*o,d-.5*u*l,e-.5*u*l];this.vg.drawPoly(c,p,Ge.NOCOLOUR,0,n,!0)}}!function(t){t[t.Reactant=0]="Reactant",t[t.Reagent=1]="Reagent",t[t.Product=2]="Product"}(ke||(ke={}));class Ke{constructor(t,e){this.mol=null,this.name="",this.stoich="",this.mass=null,this.volume=null,this.moles=null,this.density=null,this.conc=null,this.yield=null,this.primary=!1,this.waste=!1,this.equiv=null,this.meta="",this.mol=t,e&&(this.name=e)}clone(){let t=new Ke(this.mol,this.name);return t.stoich=this.stoich,t.mass=this.mass,t.volume=this.volume,t.moles=this.moles,t.density=this.density,t.conc=this.conc,t.yield=this.yield,t.primary=this.primary,t.waste=this.waste,t.equiv=this.equiv,t.meta=this.meta,t}equals(t){return this.name==t.name&&this.stoich==t.stoich&&this.mass==t.mass&&this.volume==t.volume&&this.moles==t.moles&&this.density==t.density&&this.conc==t.conc&&this.yield==t.yield&&this.primary==t.primary&&this.waste==t.waste&&this.equiv==t.equiv&&this.meta==t.meta&&(this.mol===t.mol||null!=this.mol&&null!=t.mol&&0==this.mol.compareTo(t.mol))}isBlank(){return Ht.isBlank(this.mol)&&!this.name}}class Ze{constructor(){this.reactants=[],this.reagents=[],this.products=[],this.meta=""}clone(){let t=new Ze;for(let e of this.reactants)t.reactants.push(e.clone());for(let e of this.reagents)t.reagents.push(e.clone());for(let e of this.products)t.products.push(e.clone());return t.meta=this.meta,t}equals(t){if(this.reactants.length!=t.reactants.length)return!1;if(this.reagents.length!=t.reagents.length)return!1;if(this.products.length!=t.products.length)return!1;if(this.meta!=t.meta)return!1;for(let e=0;e<this.reactants.length;e++)if(!this.reactants[e].equals(t.reactants[e]))return!1;for(let e=0;e<this.reagents.length;e++)if(!this.reagents[e].equals(t.reagents[e]))return!1;for(let e=0;e<this.products.length;e++)if(!this.products[e].equals(t.products[e]))return!1;return!0}}class Je{constructor(){this.title="",this.createDate=null,this.modifyDate=null,this.doi="",this.meta="",this.steps=[]}clone(){let t=new Je;t.title=this.title,t.createDate=this.createDate,t.modifyDate=this.modifyDate,t.doi=this.doi,t.meta=this.meta;for(let e of this.steps)t.steps.push(e.clone());return t}deepClone(){let t=this.clone();for(let e of t.steps){for(let t of e.reactants)null!=t.mol&&(t.mol=t.mol.clone());for(let t of e.reagents)null!=t.mol&&(t.mol=t.mol.clone());for(let t of e.products)null!=t.mol&&(t.mol=t.mol.clone())}return t}equals(t){if(this.title!=t.title)return!1;if((null==this.createDate?0:this.createDate.getTime())!=(null==t.createDate?0:t.createDate.getTime()))return!1;if((null==this.modifyDate?0:this.modifyDate.getTime())!=(null==t.modifyDate?0:t.modifyDate.getTime()))return!1;if(this.doi!=t.doi||this.meta!=t.meta)return!1;if(this.steps.length!=t.steps.length)return!1;for(let e=0;e<this.steps.length;e++)if(!this.steps[e].equals(t.steps[e]))return!1;return!0}getComponent(t,e,s){return e==ke.Reactant?this.steps[t].reactants[s]:e==ke.Reagent?this.steps[t].reagents[s]:e==ke.Product?this.steps[t].products[s]:new Ke}}class ts extends ae{constructor(t,e){if(super(ts.CODE,t,e),0==Object.keys(ts.COLUMN_DESCRIPTIONS).length){let t=ts.COLUMN_DESCRIPTIONS;t[ts.COLNAME_EXPERIMENT_TITLE]="Title description for the experiment",t[ts.COLNAME_EXPERIMENT_CREATEDATE]="Date the experiment was created (seconds since 1970)",t[ts.COLNAME_EXPERIMENT_MODIFYDATE]="Date the experiment was last modified (seconds since 1970)",t[ts.COLNAME_EXPERIMENT_DOI]="Digital object identifiers (DOI) for the experiment (whitespace separated)",t[ts.COLNAME_EXPERIMENT_META]="Additional experiment metadata",t[ts.COLNAME_STEP_META]="Additional step metadata",t[ts.COLNAME_REACTANT_MOL]="Molecular structure of reactant",t[ts.COLNAME_REACTANT_NAME]="Name of reactant",t[ts.COLNAME_REACTANT_STOICH]="Stoichiometry of reactant",t[ts.COLNAME_REACTANT_MASS]="Mass quantity of reactant (g)",t[ts.COLNAME_REACTANT_VOLUME]="Volume quantity of reactant (mL)",t[ts.COLNAME_REACTANT_MOLES]="Molar quantity of reactant (mol)",t[ts.COLNAME_REACTANT_DENSITY]="Density of reactant (g/mL)",t[ts.COLNAME_REACTANT_CONC]="Concentration of reactant (mol/L)",t[ts.COLNAME_REACTANT_PRIMARY]="Whether the reactant is used for yield calculation",t[ts.COLNAME_REACTANT_META]="Additional reactant metadata",t[ts.COLNAME_REAGENT_MOL]="Molecular structure of reagent",t[ts.COLNAME_REAGENT_NAME]="Name of reagent",t[ts.COLNAME_REAGENT_EQUIV]="Molar equivalents of reagent",t[ts.COLNAME_REAGENT_MASS]="Mass quantity of reagent (g)",t[ts.COLNAME_REAGENT_VOLUME]="Volume quantity of reagent (mL)",t[ts.COLNAME_REAGENT_MOLES]="Molar quantity of reagent (mol)",t[ts.COLNAME_REAGENT_DENSITY]="Density of reagent (g/mL)",t[ts.COLNAME_REAGENT_CONC]="Concentration of reagent (mol/L)",t[ts.COLNAME_REAGENT_META]="Additional reagent metadata",t[ts.COLNAME_PRODUCT_MOL]="Molecular structure of product",t[ts.COLNAME_PRODUCT_NAME]="Name of product",t[ts.COLNAME_PRODUCT_STOICH]="Stoichiometry of product",t[ts.COLNAME_PRODUCT_MASS]="Mass quantity of reactant (g)",t[ts.COLNAME_PRODUCT_VOLUME]="Volume quantity of reactant (mL)",t[ts.COLNAME_PRODUCT_MOLES]="Molar quantity of reactant (mol)",t[ts.COLNAME_PRODUCT_DENSITY]="Density of reactant (g/mL)",t[ts.COLNAME_PRODUCT_CONC]="Concentration of reactant (mol/L)",t[ts.COLNAME_PRODUCT_YIELD]="Yield of product (%)",t[ts.COLNAME_PRODUCT_WASTE]="Whether the product is an unwanted byproduct",t[ts.COLNAME_PRODUCT_META]="Additional product metadata"}this.setup()}static isExperiment(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==ts.CODE)return!0;return!1}isFirstStep(t){if(this.ds.notNull(t,ts.COLNAME_EXPERIMENT_CREATEDATE))return!0;let e=this.ds.getMolecule(t,ts.COLNAME_REACTANT_MOL+"1");return!!Ht.notBlank(e)||!!this.ds.getString(t,ts.COLNAME_REACTANT_NAME+"1")}numberOfSteps(t){if(t>=this.ds.numRows)return 0;let e=1;for(;t+e<this.ds.numRows&&!this.isFirstStep(t+e);)e++;return e}getEntry(t){let e=new Je,s=this.ds.getString(t,ts.COLNAME_EXPERIMENT_TITLE);s&&(e.title=s);let i=this.ds.getReal(t,ts.COLNAME_EXPERIMENT_CREATEDATE);i&&(e.createDate=new Date(1e3*i));let o=this.ds.getReal(t,ts.COLNAME_EXPERIMENT_MODIFYDATE);o&&(e.modifyDate=new Date(1e3*o));let n=this.ds.getString(t,ts.COLNAME_EXPERIMENT_DOI);n&&(e.doi=n);let l=this.ds.getString(t,ts.COLNAME_EXPERIMENT_META);l&&(e.meta=l);let[r,a,h]=this.countComponents();for(let s=t;s<this.ds.numRows&&!(s>t&&this.isFirstStep(s));s++){let i=new Ze;if(s==t)for(let t=1;t<=r;t++){let e=this.fetchReactant(s,t);if(null==e)break;i.reactants.push(e)}for(let t=1;t<=a;t++){let e=this.fetchProduct(s,t);if(null==e)break;i.products.push(e)}for(let t=1;t<=h;t++){let e=this.fetchReagent(s,t);if(null==e)break;i.reagents.push(e)}i.meta=this.ds.getString(s,ts.COLNAME_STEP_META),e.steps.push(i)}return e}setEntry(t,e){this.putEntry(t,e,!0)}addEntry(t){this.putEntry(this.ds.numRows,t,!1)}insertEntry(t,e){this.putEntry(t,e,!1)}deleteEntry(t){for(let e=t+this.numberOfSteps(t)-1;e>=t;e--)this.ds.deleteRow(e)}setup(){this.parseAndCorrect()}parseAndCorrect(){let t=this.ds,e=-1,s=-1,i=-1,o="",n="",l="";for(let r=0;r<t.numExtensions;r++)t.getExtType(r)==ts.CODE_RXN?(e=r,o=t.getExtData(r)):t.getExtType(r)==ts.CODE_YLD?(s=r,n=t.getExtData(r)):t.getExtType(r)==ts.CODE&&(i=r,l=t.getExtData(r));let[r,a,h]=this.parseReactionMetaData(o),u=`nreactants=${r}\nnproducts=${a}\nnreagents=${h}\n`;e>=0?t.setExtData(e,u):t.appendExtension(ts.NAME_RXN,ts.CODE_RXN,u),s>=0?t.setExtData(s,""):t.appendExtension(ts.NAME_YLD,ts.CODE_YLD,""),i>=0?t.setExtData(i,""):t.appendExtension(ts.NAME,ts.CODE,""),this.forceColumn(ts.COLNAME_EXPERIMENT_TITLE,"string"),this.forceColumn(ts.COLNAME_EXPERIMENT_CREATEDATE,"real"),this.forceColumn(ts.COLNAME_EXPERIMENT_MODIFYDATE,"real"),this.forceColumn(ts.COLNAME_EXPERIMENT_DOI,"string"),this.forceColumn(ts.COLNAME_EXPERIMENT_META,"string"),this.forceColumn(ts.COLNAME_STEP_META,"string");for(let t=1;t<=r;t++)this.forceReactantColumns(t);for(let t=1;t<=h;t++)this.forceReagentColumns(t);for(let t=1;t<=a;t++)this.forceProductColumns(t)}forceColumn(t,e,s){let i=t+(null==s?"":s);this.ds.ensureColumn(i,e,ts.COLUMN_DESCRIPTIONS[t])}forceReactantColumns(t){this.forceColumn(ts.COLNAME_REACTANT_MOL,"molecule",t),this.forceColumn(ts.COLNAME_REACTANT_NAME,"string",t),this.forceColumn(ts.COLNAME_REACTANT_STOICH,"string",t),this.forceColumn(ts.COLNAME_REACTANT_MASS,"real",t),this.forceColumn(ts.COLNAME_REACTANT_VOLUME,"real",t),this.forceColumn(ts.COLNAME_REACTANT_MOLES,"real",t),this.forceColumn(ts.COLNAME_REACTANT_DENSITY,"real",t),this.forceColumn(ts.COLNAME_REACTANT_CONC,"real",t),this.forceColumn(ts.COLNAME_REACTANT_PRIMARY,"boolean",t),this.forceColumn(ts.COLNAME_REACTANT_META,"string",t)}forceReagentColumns(t){this.forceColumn(ts.COLNAME_REAGENT_MOL,"molecule",t),this.forceColumn(ts.COLNAME_REAGENT_NAME,"string",t),this.forceColumn(ts.COLNAME_REAGENT_EQUIV,"real",t),this.forceColumn(ts.COLNAME_REAGENT_MASS,"real",t),this.forceColumn(ts.COLNAME_REAGENT_VOLUME,"real",t),this.forceColumn(ts.COLNAME_REAGENT_MOLES,"real",t),this.forceColumn(ts.COLNAME_REAGENT_DENSITY,"real",t),this.forceColumn(ts.COLNAME_REAGENT_CONC,"real",t),this.forceColumn(ts.COLNAME_REAGENT_META,"string",t)}forceProductColumns(t){this.forceColumn(ts.COLNAME_PRODUCT_MOL,"molecule",t),this.forceColumn(ts.COLNAME_PRODUCT_NAME,"string",t),this.forceColumn(ts.COLNAME_PRODUCT_STOICH,"string",t),this.forceColumn(ts.COLNAME_PRODUCT_MASS,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_VOLUME,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_MOLES,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_DENSITY,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_CONC,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_YIELD,"real",t),this.forceColumn(ts.COLNAME_PRODUCT_WASTE,"boolean",t),this.forceColumn(ts.COLNAME_PRODUCT_META,"string",t)}parseReactionMetaData(t){let e=1,s=1,i=0;for(let o of t.split(/\r?\n/))o.startsWith("nreactants=")?e=Math.max(e,Math.min(100,parseInt(o.substring(11)))):o.startsWith("nproducts=")?s=Math.max(s,Math.min(100,parseInt(o.substring(10)))):o.startsWith("nreagents=")&&(i=Math.max(i,Math.min(100,parseInt(o.substring(10)))));return[e,s,i]}countComponents(){let t=0,e=0,s=0;for(let i=0;i<this.ds.numExtensions;i++)if(this.ds.getExtType(i)==ts.CODE_RXN){[t,e,s]=this.parseReactionMetaData(this.ds.getExtData(i));break}return[t,e,s]}fetchReactant(t,e){let s=this.ds.getMolecule(t,`${ts.COLNAME_REACTANT_MOL}${e}`),i=this.ds.getString(t,`${ts.COLNAME_REACTANT_NAME}${e}`);if(Ht.isBlank(s)&&!i)return null;let o=new Ke(s,i),n=this.ds.getString(t,`${ts.COLNAME_REACTANT_STOICH}${e}`);n&&(o.stoich=n),o.mass=this.ds.getReal(t,`${ts.COLNAME_REACTANT_MASS}${e}`),o.volume=this.ds.getReal(t,`${ts.COLNAME_REACTANT_VOLUME}${e}`),o.moles=this.ds.getReal(t,`${ts.COLNAME_REACTANT_MOLES}${e}`),o.density=this.ds.getReal(t,`${ts.COLNAME_REACTANT_DENSITY}${e}`),o.conc=this.ds.getReal(t,`${ts.COLNAME_REACTANT_CONC}${e}`);let l=this.ds.getBoolean(t,`${ts.COLNAME_REACTANT_PRIMARY}${e}`);return null!=l&&(o.primary=l),o.meta=this.ds.getString(t,`${ts.COLNAME_REACTANT_META}${e}`),o}fetchProduct(t,e){let s=this.ds.getMolecule(t,`${ts.COLNAME_PRODUCT_MOL}${e}`),i=this.ds.getString(t,`${ts.COLNAME_PRODUCT_NAME}${e}`);if(Ht.isBlank(s)&&!i)return null;let o=new Ke(s,i),n=this.ds.getString(t,`${ts.COLNAME_PRODUCT_STOICH}${e}`);n&&(o.stoich=n),o.mass=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_MASS}${e}`),o.volume=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_VOLUME}${e}`),o.moles=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_MOLES}${e}`),o.density=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_DENSITY}${e}`),o.conc=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_CONC}${e}`),o.yield=this.ds.getReal(t,`${ts.COLNAME_PRODUCT_YIELD}${e}`);let l=this.ds.getBoolean(t,`${ts.COLNAME_PRODUCT_WASTE}${e}`);return null!=l&&(o.waste=l),o.meta=this.ds.getString(t,`${ts.COLNAME_PRODUCT_META}${e}`),o}fetchReagent(t,e){let s=this.ds.getMolecule(t,`${ts.COLNAME_REAGENT_MOL}${e}`),i=this.ds.getString(t,`${ts.COLNAME_REAGENT_NAME}${e}`);if(Ht.isBlank(s)&&!i)return null;let o=new Ke(s,i);return o.mass=this.ds.getReal(t,`${ts.COLNAME_REAGENT_MASS}${e}`),o.volume=this.ds.getReal(t,`${ts.COLNAME_REAGENT_VOLUME}${e}`),o.moles=this.ds.getReal(t,`${ts.COLNAME_REAGENT_MOLES}${e}`),o.density=this.ds.getReal(t,`${ts.COLNAME_REAGENT_DENSITY}${e}`),o.conc=this.ds.getReal(t,`${ts.COLNAME_REAGENT_CONC}${e}`),o.equiv=this.ds.getReal(t,`${ts.COLNAME_REAGENT_EQUIV}${e}`),o.meta=this.ds.getString(t,`${ts.COLNAME_REAGENT_META}${e}`),o}putEntry(t,e,s){let[i,o,n]=this.countComponents(),[l,r,a]=[i,o,n];for(let t of e.steps)l=Math.max(l,t.reactants.length),r=Math.max(r,t.products.length),a=Math.max(a,t.reagents.length);if(l!=i||r!=o||a!=n){let t=`nreactants=${l}\nnproducts=${r}\nnreagents=${a}`,e=!1;for(let s=0;s<this.ds.numExtensions;s++)if(this.ds.getExtType(s)==ts.CODE_RXN){this.ds.setExtData(s,t),e=!0;break}e||this.ds.appendExtension(ts.NAME_RXN,ts.CODE_RXN,t)}for(let t=1;t<=l;t++)this.forceReactantColumns(t);for(let t=1;t<=a;t++)this.forceReagentColumns(t);for(let t=1;t<=r;t++)this.forceProductColumns(t);let h=s?this.numberOfSteps(t):0,u=e.steps.length;if(h>u)for(let e=u;e<h;e++)this.ds.deleteRow(t+u-1);else if(u>h)for(let e=h;e<u;e++)this.ds.insertRow(t+h);this.ds.setString(t,ts.COLNAME_EXPERIMENT_TITLE,e.title),this.ds.setReal(t,ts.COLNAME_EXPERIMENT_CREATEDATE,null==e.createDate?null:.001*e.createDate.getTime()),this.ds.setReal(t,ts.COLNAME_EXPERIMENT_MODIFYDATE,null==e.modifyDate?null:.001*e.modifyDate.getTime()),this.ds.setString(t,ts.COLNAME_EXPERIMENT_DOI,e.doi),this.ds.setString(t,ts.COLNAME_EXPERIMENT_META,e.meta);for(let s=0;s<e.steps.length;s++){let i=t+s,o=e.steps[s];if(0==s)for(let t=0;t<o.reactants.length;t++){let e=o.reactants[t],s=t+1;this.ds.setMolecule(i,`${ts.COLNAME_REACTANT_MOL}${s}`,e.mol),this.ds.setString(i,`${ts.COLNAME_REACTANT_NAME}${s}`,e.name),this.ds.setString(i,`${ts.COLNAME_REACTANT_STOICH}${s}`,e.stoich),this.ds.setReal(i,`${ts.COLNAME_REACTANT_MASS}${s}`,e.mass),this.ds.setReal(i,`${ts.COLNAME_REACTANT_VOLUME}${s}`,e.volume),this.ds.setReal(i,`${ts.COLNAME_REACTANT_MOLES}${s}`,e.moles),this.ds.setReal(i,`${ts.COLNAME_REACTANT_DENSITY}${s}`,e.density),this.ds.setReal(i,`${ts.COLNAME_REACTANT_CONC}${s}`,e.conc),this.ds.setBoolean(i,`${ts.COLNAME_REACTANT_PRIMARY}${s}`,e.primary),this.ds.setString(i,`${ts.COLNAME_REACTANT_META}${s}`,e.meta)}for(let t=0;t<o.reagents.length;t++){let e=o.reagents[t],s=t+1;this.ds.setMolecule(i,`${ts.COLNAME_REAGENT_MOL}${s}`,e.mol),this.ds.setString(i,`${ts.COLNAME_REAGENT_NAME}${s}`,e.name),this.ds.setReal(i,`${ts.COLNAME_REAGENT_EQUIV}${s}`,e.equiv),this.ds.setReal(i,`${ts.COLNAME_REAGENT_MASS}${s}`,e.mass),this.ds.setReal(i,`${ts.COLNAME_REAGENT_VOLUME}${s}`,e.volume),this.ds.setReal(i,`${ts.COLNAME_REAGENT_MOLES}${s}`,e.moles),this.ds.setReal(i,`${ts.COLNAME_REAGENT_DENSITY}${s}`,e.density),this.ds.setReal(i,`${ts.COLNAME_REAGENT_CONC}${s}`,e.conc),this.ds.setString(i,`${ts.COLNAME_REAGENT_META}${s}`,e.meta)}for(let t=0;t<o.products.length;t++){let e=o.products[t],s=t+1;this.ds.setMolecule(i,`${ts.COLNAME_PRODUCT_MOL}${s}`,e.mol),this.ds.setString(i,`${ts.COLNAME_PRODUCT_NAME}${s}`,e.name),this.ds.setString(i,`${ts.COLNAME_PRODUCT_STOICH}${s}`,e.stoich),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_MASS}${s}`,e.mass),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_VOLUME}${s}`,e.volume),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_MOLES}${s}`,e.moles),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_DENSITY}${s}`,e.density),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_CONC}${s}`,e.conc),this.ds.setReal(i,`${ts.COLNAME_PRODUCT_YIELD}${s}`,e.yield),this.ds.setBoolean(i,`${ts.COLNAME_PRODUCT_WASTE}${s}`,e.waste),this.ds.setString(i,`${ts.COLNAME_PRODUCT_META}${s}`,e.meta)}this.ds.setString(i,ts.COLNAME_STEP_META,o.meta)}for(let s=0;s<e.steps.length;s++){let i=t+s;for(let t=s>0?0:e.steps[s].reactants.length;t<l;t++){let e=t+1;this.ds.setToNull(i,`${ts.COLNAME_REACTANT_MOL}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_NAME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_STOICH}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_MASS}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_VOLUME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_MOLES}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_DENSITY}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_CONC}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_PRIMARY}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REACTANT_META}${e}`)}for(let t=e.steps[s].reagents.length;t<a;t++){let e=t+1;this.ds.setToNull(i,`${ts.COLNAME_REAGENT_MOL}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_NAME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_EQUIV}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_MASS}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_VOLUME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_MOLES}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_DENSITY}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_CONC}${e}`),this.ds.setToNull(i,`${ts.COLNAME_REAGENT_META}${e}`)}for(let t=e.steps[s].products.length;t<r;t++){let e=t+1;this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_MOL}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_NAME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_STOICH}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_MASS}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_VOLUME}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_MOLES}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_DENSITY}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_CONC}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_WASTE}${e}`),this.ds.setToNull(i,`${ts.COLNAME_PRODUCT_META}${e}`)}}}plainHeading(){return ts.NAME}rowFirstBlock(t){return this.isFirstStep(t)}rowBlockCount(t){return this.numberOfSteps(t)}initiateNewRow(t){let e=.001*(new Date).getTime();this.ds.setReal(t,ts.COLNAME_EXPERIMENT_CREATEDATE,e)}columnEffectivelyBlank(t){return[ts.COLNAME_EXPERIMENT_CREATEDATE]}isColumnReserved(t){return this.areColumnsReserved([t])[0]}areColumnsReserved(t){let e=s.booleanArray(!1,t.length);for(let s=0;s<t.length;s++){let i=t[s];if(ts.ALL_COLUMN_LITERALS.indexOf(i)>=0)e[s]=!0;else for(let t of ts.ALL_COLUMN_PREFIXES)if(i.startsWith(t)){e[s]=!0;break}}return e}numGraphicRenderings(t){return 1}produceGraphicRendering(t,e,s){let i=new We(0,0,s.data.pointScale),o=new Ve(this.getEntry(t),i,s);o.limitTotalW=50*s.data.pointScale,o.limitTotalH=50*s.data.pointScale,o.includeStoich=!0,o.includeAnnot=!1,o.arrange();let n=new Ge;return new Qe(o,n).draw(),n.normalise(),{name:"Scheme",metavec:n}}}ts.CODE="org.mmi.aspect.Experiment",ts.CODE_RXN="org.mmi.aspect.Reaction",ts.CODE_YLD="org.mmi.aspect.Yield",ts.NAME="Experiment",ts.NAME_RXN="Reaction",ts.NAME_YLD="Yield",ts.COLNAME_EXPERIMENT_TITLE="ExperimentTitle",ts.COLNAME_EXPERIMENT_CREATEDATE="ExperimentCreateDate",ts.COLNAME_EXPERIMENT_MODIFYDATE="ExperimentModifyDate",ts.COLNAME_EXPERIMENT_DOI="ExperimentDOI",ts.COLNAME_EXPERIMENT_META="ExperimentMeta",ts.COLNAME_STEP_META="ExperimentStepMeta",ts.COLNAME_REACTANT_MOL="ReactantMol",ts.COLNAME_REACTANT_NAME="ReactantName",ts.COLNAME_REACTANT_STOICH="ReactantStoich",ts.COLNAME_REACTANT_MASS="ReactantMass",ts.COLNAME_REACTANT_VOLUME="ReactantVolume",ts.COLNAME_REACTANT_MOLES="ReactantMoles",ts.COLNAME_REACTANT_DENSITY="ReactantDensity",ts.COLNAME_REACTANT_CONC="ReactantConc",ts.COLNAME_REACTANT_PRIMARY="ReactantPrimary",ts.COLNAME_REACTANT_META="ReactantMeta",ts.COLNAME_REAGENT_MOL="ReagentMol",ts.COLNAME_REAGENT_NAME="ReagentName",ts.COLNAME_REAGENT_EQUIV="ReagentEquiv",ts.COLNAME_REAGENT_MASS="ReagentMass",ts.COLNAME_REAGENT_VOLUME="ReagentVolume",ts.COLNAME_REAGENT_MOLES="ReagentMoles",ts.COLNAME_REAGENT_DENSITY="ReagentDensity",ts.COLNAME_REAGENT_CONC="ReagentConc",ts.COLNAME_REAGENT_META="ReagentMeta",ts.COLNAME_PRODUCT_MOL="ProductMol",ts.COLNAME_PRODUCT_NAME="ProductName",ts.COLNAME_PRODUCT_STOICH="ProductStoich",ts.COLNAME_PRODUCT_MASS="ProductMass",ts.COLNAME_PRODUCT_VOLUME="ProductVolume",ts.COLNAME_PRODUCT_MOLES="ProductMoles",ts.COLNAME_PRODUCT_DENSITY="ProductDensity",ts.COLNAME_PRODUCT_CONC="ProductConc",ts.COLNAME_PRODUCT_YIELD="ProductYield",ts.COLNAME_PRODUCT_WASTE="ProductWaste",ts.COLNAME_PRODUCT_META="ProductMeta",ts.COLUMN_DESCRIPTIONS={},ts.ALL_COLUMN_LITERALS=[ts.COLNAME_EXPERIMENT_TITLE,ts.COLNAME_EXPERIMENT_CREATEDATE,ts.COLNAME_EXPERIMENT_MODIFYDATE,ts.COLNAME_EXPERIMENT_DOI,ts.COLNAME_EXPERIMENT_META,ts.COLNAME_STEP_META],ts.ALL_COLUMN_PREFIXES=[ts.COLNAME_REACTANT_MOL,ts.COLNAME_REACTANT_NAME,ts.COLNAME_REACTANT_STOICH,ts.COLNAME_REACTANT_MASS,ts.COLNAME_REACTANT_VOLUME,ts.COLNAME_REACTANT_MOLES,ts.COLNAME_REACTANT_DENSITY,ts.COLNAME_REACTANT_CONC,ts.COLNAME_REACTANT_PRIMARY,ts.COLNAME_REACTANT_META,ts.COLNAME_REAGENT_MOL,ts.COLNAME_REAGENT_NAME,ts.COLNAME_REAGENT_EQUIV,ts.COLNAME_REAGENT_MASS,ts.COLNAME_REAGENT_VOLUME,ts.COLNAME_REAGENT_MOLES,ts.COLNAME_REAGENT_DENSITY,ts.COLNAME_REAGENT_CONC,ts.COLNAME_REAGENT_META,ts.COLNAME_PRODUCT_MOL,ts.COLNAME_PRODUCT_NAME,ts.COLNAME_PRODUCT_STOICH,ts.COLNAME_PRODUCT_MASS,ts.COLNAME_PRODUCT_VOLUME,ts.COLNAME_PRODUCT_MOLES,ts.COLNAME_PRODUCT_DENSITY,ts.COLNAME_PRODUCT_CONC,ts.COLNAME_PRODUCT_YIELD,ts.COLNAME_PRODUCT_WASTE,ts.COLNAME_PRODUCT_META],ue(ts),function(t){t.Structure="structure",t.Name="name",t.Quantity="quantity",t.Bound="bound",t.Error="error",t.Ratio="ratio",t.Units="units",t.Relation="relation",t.Identifier="identifier",t.Link="link",t.Property="property"}(Re||(Re={}));class es extends ae{constructor(t,e){super(es.CODE,t,e),this.header={attributes:[]},this.setup()}static isMixture(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==es.CODE)return!0;return!1}getHeader(){return this.header}setHeader(t){this.header=t;let e=this.formatMetaData(t);for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==es.CODE)return void this.ds.setExtData(t,e);this.ds.appendExtension(es.NAME,es.CODE,e)}setup(){this.parseAndCorrect()}parseAndCorrect(){this.header={attributes:[]};let t=!1;for(let e=0;e<this.ds.numExtensions;e++)if(this.ds.getExtType(e)==es.CODE){this.header=this.parseMetaData(this.ds.getExtData(e)),t=!0;break}if(!t&&this.allowModify){let t=this.formatMetaData(this.header);this.ds.appendExtension(es.NAME,es.CODE,t)}}parseMetaData(t){let e={attributes:[]};for(let s of t.split(/\r?\n/)){let t=s.indexOf("=");if(!(t<0)&&s.startsWith("attr=")){let i=s.substring(t+1).split(",");if(i.length<3)continue;let o=se.skUnescape(i[0]),n=[];"0"!=i[1]&&(n=i[1].split(".").map((t=>parseInt(t))));let l=i[2],r=[];for(let t=3;t<i.length;t++)r.push(se.skUnescape(i[t]));e.attributes.push({column:o,position:n,type:l,info:r})}}return e}formatMetaData(t){let e=[];for(let i of t.attributes){let t=[se.skEscape(i.column)];if(s.isBlank(i.position)?t.push("0"):t.push(i.position.join(".")),t.push(i.type),i.info)for(let e of i.info)t.push(se.skEscape(e));e.push("attr="+t.join(","))}return e.join("\n")}plainHeading(){return ye.NAME}isColumnReserved(t){return this.areColumnsReserved([t])[0]}areColumnsReserved(t){let e=new Set;for(let t of this.header.attributes)e.add(t.column);let s=[];for(let i of t)s.push(e.has(i));return s}}es.CODE="org.mmi.aspect.Mixture",es.NAME="Mixture",es.SUFFIX_VALUE="",ue(es);class ss extends ae{constructor(t,e){super(ss.CODE,t,e),this.setup()}static isSARTable(t){for(let e=0;e<t.numExtensions;e++)if(t.getExtType(e)==ss.CODE)return!0;return!1}getFields(){for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ss.CODE)return this.parseMetaData(this.ds.getExtData(t));return null}setFields(t){let e=this.formatMetaData(t);for(let t=0;t<this.ds.numExtensions;t++)if(this.ds.getExtType(t)==ss.CODE)return void this.ds.setExtData(t,e);this.ds.appendExtension(ss.NAME,ss.CODE,e)}getEntry(t){let e=this.getFields(),s={construct:this.ds.getMolecule(t,e.construct),locked:!!this.ds.getBoolean(t,e.locked),scaffold:this.ds.getMolecule(t,e.scaffold),substNames:[],substituents:[]};for(let i of e.substituents)s.substNames.push(i),s.substituents.push(this.ds.getMolecule(t,i));return s}setEntry(t,e){let s=this.getFields(),i=this.ds.findColByName(s.construct,"molecule");i>=0&&this.ds.setMolecule(t,i,e.construct);let o=this.ds.findColByName(s.locked,"boolean");o>=0&&this.ds.setBoolean(t,o,e.locked);let n=this.ds.findColByName(s.scaffold,"molecule");n>=0&&this.ds.setMolecule(t,n,e.scaffold);for(let i=0;i<s.substituents.length;i++){let o=this.ds.findColByName(s.substituents[i],"molecule");o>=0&&this.ds.setMolecule(t,o,e.substituents[i])}}createSubstituents(t){if(0==t.length)return;let e=this.getFields(),s=!1;for(let i of t)e.substituents.indexOf(i)<0&&(e.substituents.push(i),this.ds.ensureColumn(i,"molecule",ss.DESCR_SUBSTITUENT),s=!0);s&&this.setFields(e)}static isAttachment(t,e){return 0==t.atomicNumber(e)&&!Ht.hasAbbrev(t,e)&&1==t.atomAdjCount(e)}setup(){this.parseAndCorrect()}parseAndCorrect(){let t={construct:"Molecule",locked:"Molecule_locked",scaffold:"Scaffold",substituents:[],metadata:[]},e=!1;for(let s=0;s<this.ds.numExtensions;s++)if(this.ds.getExtType(s)==ss.CODE){t=this.parseMetaData(this.ds.getExtData(s)),e=!0;break}this.ds.ensureColumn(t.construct,"molecule",ss.DESCR_CONSTRUCT),this.ds.ensureColumn(t.locked,"boolean",ss.DESCR_LOCKED),this.ds.ensureColumn(t.scaffold,"molecule",ss.DESCR_SCAFFOLD);for(let e of t.substituents)this.ds.ensureColumn(e,"molecule",ss.DESCR_SUBSTITUENT);if(!e){let e=this.formatMetaData(t);this.ds.appendExtension(ss.NAME,ss.CODE,e)}}parseMetaData(t){let e={construct:null,locked:null,scaffold:null,substituents:[],metadata:[]};for(let s of t.split(/\r?\n/)){let t=s.indexOf("=");if(t<0)continue;let i=s.substring(0,t),o=s.substring(t+1);if("field"==i){let t=o.split(",");if(t.length>=3){let s=t[0],i=se.skUnescape(t[1]);if("construct"==s){e.construct=i,e.locked=i+"_locked";continue}if("scaffold"==s){e.scaffold=i;continue}if("substituent"==s){e.substituents.push(i);continue}}}e.metadata.push(s)}return e}formatMetaData(t){let e="";e+="field=construct,"+se.skEscape(t.construct)+",\n",e+="field=scaffold,"+se.skEscape(t.scaffold)+",\n";for(let s of t.substituents)e+="field=substituent,"+se.skEscape(s)+",\n";for(let s of t.metadata)e+=s+"\n";return e}plainHeading(){return ss.NAME}isColumnReserved(t){return this.areColumnsReserved([t])[0]}areColumnsReserved(t){let e=this.getFields(),i=new Set;i.add(e.construct),i.add(e.locked),i.add(e.scaffold);for(let t of e.substituents)i.add(t);let o=s.booleanArray(!1,t.length);for(let e=0;e<t.length;e++)o[e]=i.has(t[e]);return o}numGraphicRenderings(t){return 2+this.getFields().substituents.length}produceGraphicRendering(t,e,s){let i=this.getFields(),o=this.ds;if(e==ss.RENDER_CONSTRUCT){let e=o.getMolecule(t,i.construct),n=new Ge;if(Ht.notBlank(e)){let t=new Xe;for(let s=1;s<=e.numAtoms;s++)e.atomMapNum(s)>0&&(t.colAtom[s]=618095);for(let s=1;s<=e.numBonds;s++){let i=e.atomMapNum(e.bondFrom(s)),o=e.atomMapNum(e.bondTo(s));i>0&&o>0?t.colBond[s]=618095:(i>0||o>0)&&(t.dottedBondCross[s]=6316128)}let i=new We(0,0,s.data.pointScale),o=new He(e,i,s,t);o.arrange(),new $e(o,n).draw()}else n.drawText(0,0,"?",15,0);return n.normalise(),{name:i.construct,metavec:n}}if(e==ss.RENDER_SCAFFOLD){let e=o.getMolecule(t,i.scaffold),n=new Ge;if(Ht.notBlank(e)){let l=new Xe;for(let s=1;s<=e.numAtoms;s++)if(ss.isAttachment(e,s)){let n=!1,r=e.atomElement(s);t:for(let e of i.substituents){let s=o.getMolecule(t,e);if(null!=s)for(let t=1;t<=s.numAtoms;t++)if(s.atomElement(t)==r||"R"==s.atomElement(t)&&r==e){n=!0;break t}}l.colAtom[s]=n?618095:16711680,l.dottedRectOutline[s]=n?8421504:16711680}let r=new We(0,0,s.data.pointScale),a=new He(e,r,s,l);a.arrange(),new $e(a,n).draw()}else n.drawText(0,0,"?",15,0);return n.normalise(),{name:i.scaffold,metavec:n}}if(e>=ss.RENDER_SUBSTITUENT&&e<ss.RENDER_SUBSTITUENT+i.substituents.length){let n=e-ss.RENDER_SUBSTITUENT,l=i.substituents[n],r=o.getMolecule(t,l),a=new Ge;if(Ht.notBlank(r)){let t=new Xe;for(let e=1;e<=r.numAtoms;e++)ss.isAttachment(r,e)&&(t.colAtom[e]=618095,t.dottedRectOutline[e]=8421504);let e=new We(0,0,s.data.pointScale),i=new He(r,e,s,t);i.arrange(),new $e(i,a).draw()}else{let e="?",s=o.getMolecule(t,i.scaffold);if(Ht.notBlank(s)){e="n/a";for(let t=1;t<=s.numAtoms;t++)if(s.atomElement(t)==l){e="?";break}if("?"==e)for(let s=0;s<i.substituents.length;s++)if(s!=n){let n=o.getMolecule(t,i.substituents[s]);if(Ht.notBlank(n))for(let t=1;t<=n.numAtoms;t++)if(n.atomElement(t)==l){e="n/a";break}}}a.drawText(0,0,e,15,0)}return a.normalise(),{name:l,metavec:a}}return null}}ss.CODE="org.mmi.aspect.SARTable",ss.NAME="SAR Table",ss.DESCR_CONSTRUCT="Structure of constructed molecule",ss.DESCR_LOCKED="Whether constructed molecule should be rebuilt",ss.DESCR_SCAFFOLD="Decorated core scaffold of molecule",ss.DESCR_SUBSTITUENT="Substituent fragment to be attached to scaffold",ss.RENDER_CONSTRUCT=0,ss.RENDER_SCAFFOLD=1,ss.RENDER_SUBSTITUENT=2,ue(ss),function(t){t.AtomAromatic="yAROMATIC",t.BondAromatic="yAROMATIC",t.AtomChiralMDLOdd="yCHIRAL_MDL_ODD",t.AtomChiralMDLEven="yCHIRAL_MDL_EVEN",t.AtomChiralMDLRacemic="yCHIRAL_MDL_RACEMIC"}(Le||(Le={}));class is{static noteAromaticAtoms(t){const e=t.numAtoms;let i=s.booleanArray(!1,e);for(let s=1;s<=e;s++)i[s-1]=t.atomTransient(s).indexOf(Le.AtomAromatic)>=0;return i}static noteAromaticBonds(t){const e=t.numBonds;let i=s.booleanArray(!1,e);for(let s=1;s<=e;s++)i[s-1]=t.bondTransient(s).indexOf(Le.BondAromatic)>=0;return i}}!function(t){t[t.O0=0]="O0",t[t.O01=1]="O01",t[t.O1=2]="O1",t[t.O12=3]="O12",t[t.O2=4]="O2",t[t.O23=5]="O23",t[t.O3=6]="O3",t[t.O3X=7]="O3X"}(De||(De={})),function(t){t[t.N1X=-3]="N1X",t[t.N1=-2]="N1",t[t.N01=-1]="N01",t[t.Z0=0]="Z0",t[t.P01=1]="P01",t[t.P1=2]="P1",t[t.P1X=3]="P1X"}(Ie||(Ie={}));class os{constructor(t){this.mol=t,this.paths=[],t&&this.calculate()}clone(){let t=new os(null);return t.mol=this.mol,t.maskBlock=this.maskBlock,t.paths=this.paths.slice(0),t}getBondOrders(){const t=this.mol;let e=[];for(let s=1;s<=t.numBonds;s++)e.push(t.bondOrder(s));for(let t of this.paths){let s=t.numer/t.denom;for(let t=1;t<=5;t++)G(s,t)&&(s=t);for(let i of t.bonds)e[i-1]=s}return e}getBondClasses(){const t=this.mol;let e=[];for(let s=1;s<=t.numBonds;s++){let i=t.bondOrder(s);e.push(0==i?0:1==i?2:2==i?4:3==i?6:7)}for(let t of this.paths){let s=t.numer/t.denom,i=G(s,0)?0:G(s,1)?2:G(s,2)?4:G(s,3)?6:s<1?1:s<2?3:s<3?5:7;for(let s of t.bonds)e[s-1]=i}return e}getChargeClasses(){const t=this.mol;let e=[];for(let s=1;s<=t.numAtoms;s++){let i=t.atomCharge(s);e.push(0==i?0:-1==i?-2:1==i?2:i<-1?-3:3)}for(let s of this.paths){let i=0;for(let e of s.atoms)i+=t.atomCharge(e);i/=s.atoms.length;let o=G(i,0)?0:G(i,-1)?-2:G(i,1)?2:i>-1&&i<0?-1:i>0&&i<1?1:i<-1?-3:3;for(let t of s.atoms)e[t-1]=o}return e}getAggregateCharges(){const t=this.mol;let e=[];for(let s=1;s<=t.numAtoms;s++)e[s-1]=t.atomCharge(s);for(let t of this.paths){let s=0;for(let i of t.atoms)s+=e[i-1];for(let i of t.atoms)e[i-1]=s}return e}toString(){let t="blocking="+JSON.stringify(this.maskBlock)+"; paths="+this.paths.length;for(let e of this.paths)t+=" ["+e.numer+"/"+e.denom+";a="+JSON.stringify(e.atoms)+";b="+JSON.stringify(e.bonds)+"]";return t}calculate(){const t=this.mol,e=t.numAtoms,i=t.numBonds;let o=s.booleanArray(!1,e),n=s.booleanArray(!1,e),l=s.booleanArray(!1,e),r=s.numberArray(0,e);for(let s=0;s<e;s++)r[s]=t.atomHydrogens(s+1);for(let e=1;e<=i;e++){let s=t.bondOrder(e),i=t.bondFrom(e),a=t.bondTo(e);if(1!=s&&(o[i-1]=!0,o[a-1]=!0),s>=2)n[i-1]=!0,n[a-1]=!0;else{let e=qt.ELEMENT_BLOCKS[t.atomicNumber(i)],s=qt.ELEMENT_BLOCKS[t.atomicNumber(a)];(e>=3||s>=3)&&(l[i-1]=!0,l[a-1]=!0)}r[i-1]+=s,r[a-1]+=s,t.bondTransient(e).indexOf(Le.BondAromatic)>=0&&(n[i-1]=!0,n[a-1]=!0)}let a=s.booleanArray(!1,e);for(let s=1;s<=e;s++)if(!n[s-1]){let e=0;for(let i of t.atomAdjList(s))(n[i-1]||l[i-1])&&e++;e>=2&&(a[s-1]=!0)}for(let t=0;t<e;t++)a[t]&&(n[t]=!0);this.maskBlock=s.booleanArray(!1,e);let h=s.booleanArray(!1,e);const u=[qt.ELEMENT_H,qt.ELEMENT_B,qt.ELEMENT_C,qt.ELEMENT_N,qt.ELEMENT_O,qt.ELEMENT_F,qt.ELEMENT_Al,qt.ELEMENT_Si,qt.ELEMENT_P,qt.ELEMENT_S,qt.ELEMENT_Cl,qt.ELEMENT_Ga,qt.ELEMENT_Ge,qt.ELEMENT_As,qt.ELEMENT_Se,qt.ELEMENT_Br,qt.ELEMENT_In,qt.ELEMENT_Sn,qt.ELEMENT_Sb,qt.ELEMENT_Te,qt.ELEMENT_I,qt.ELEMENT_Tl,qt.ELEMENT_Pb,qt.ELEMENT_Bi,qt.ELEMENT_Po,qt.ELEMENT_At],m=[qt.ELEMENT_B,qt.ELEMENT_Al,qt.ELEMENT_Si,qt.ELEMENT_Ga,qt.ELEMENT_Ge,qt.ELEMENT_In,qt.ELEMENT_Sn,qt.ELEMENT_Tl,qt.ELEMENT_Pb],d=[qt.ELEMENT_N,qt.ELEMENT_O,qt.ELEMENT_F,qt.ELEMENT_P,qt.ELEMENT_S,qt.ELEMENT_Cl,qt.ELEMENT_As,qt.ELEMENT_Se,qt.ELEMENT_Br,qt.ELEMENT_Sb,qt.ELEMENT_Te,qt.ELEMENT_I,qt.ELEMENT_Bi,qt.ELEMENT_Po,qt.ELEMENT_At];t:for(let s=0;s<e;s++){const e=s+1;if(o[s]||n[s])continue;if(0!=t.atomCharge(e)||0!=t.atomUnpaired(e))continue;const i=t.atomicNumber(e);if(0!=i){if(!(u.indexOf(i)<0)&&r[s]==qt.ELEMENT_BONDING[i]){if(m.indexOf(i)>=0)for(let s of t.atomAdjList(e))if(d.indexOf(t.atomicNumber(s))>=0)continue t;if(d.indexOf(i)>=0)for(let s of t.atomAdjList(e))if(m.indexOf(t.atomicNumber(s))>=0)continue t;if(h[s]=!0,i==qt.ELEMENT_C){let i=!1;for(let s of t.atomAdjList(e))u.indexOf(t.atomicNumber(s))<0&&(i=!0);i||(this.maskBlock[s]=!0)}else i==qt.ELEMENT_H&&(this.maskBlock[s]=!0)}}else this.maskBlock[s]=!0}t:for(let s=0;s<e;s++)if(h[s]&&!this.maskBlock[s]){for(let e of t.atomAdjList(s+1))if(!h[e-1])continue t;this.maskBlock[s]=!0}let c=Bt.fromMolecule(t);for(let t=0;t<e;t++)this.maskBlock[t]&&c.isolateNode(t);for(let o of c.calculateComponentGroups()){if(1==o.length)continue;let n=s.idxMask(o,e);s.addTo(o,1);let l={atoms:o,bonds:[],numer:0,denom:0};for(let e=1;e<=i;e++)n[t.bondFrom(e)-1]&&n[t.bondTo(e)-1]&&l.bonds.push(e);let r=0,a=0;for(let e of l.atoms){let s=t.atomHydrogens(e);for(let i of t.atomAdjList(e))n[i-1]||s++;let i=t.atomicNumber(e),o=qt.ELEMENT_VALENCE[i]-t.atomCharge(e)-s,l=qt.ELEMENT_SHELL[i]-qt.ELEMENT_VALENCE[i]-s;r+=o,a+=l}let h=Math.min(r,a);l.numer=h,l.denom=2*l.bonds.length,this.paths.push(l)}}}class ns{constructor(t){this.meta=t,this.mol=t.mol,this.priority=s.numberArray(0,this.mol.numAtoms),this.chiralTetra=s.numberArray(ns.STEREO_NONE,this.mol.numAtoms),this.cistransBond=s.numberArray(ns.STEREO_NONE,this.mol.numBonds),this.squarePlanar=s.numberArray(ns.STEREO_NONE,this.mol.numAtoms)}calculate(){this.isH=s.booleanArray(!1,this.mol.numAtoms);for(let t=this.mol.numAtoms;t>=1;t--)this.isH[t-1]="H"==this.mol.atomElement(t);this.buildPriority(),this.buildTetraChirality(),this.buildBondCisTrans(),this.buildPlanarCisTrans(),this.buildOctaChirality()}atomPriority(t){return this.priority[t-1]}atomTetraChirality(t){return this.chiralTetra[t-1]}bondSideStereo(t){return this.cistransBond[t-1]}atomPlanarStereo(t){return this.squarePlanar[t-1]}getPriorities(){return this.priority.slice(0)}getAtomTetraChiral(){return this.chiralTetra.slice(0)}getBondSideStereo(){return this.cistransBond.slice(0)}static create(t){let e=new ns(t);return e.calculate(),e}static rubricTetrahedral(t,e){if(t.atomAdjCount(e)<3||t.atomAdjCount(e)+t.atomHydrogens(e)!=4)return null;let i=t.atomAdjBonds(e),o=!1;for(let s=0;s<i.length;s++){let n=t.bondType(i[s]);if(n==ne.BONDTYPE_UNKNOWN)return null;t.bondFrom(i[s])==e&&(n!=ne.BONDTYPE_INCLINED&&n!=ne.BONDTYPE_DECLINED||(o=!0))}if(!o&&!t.is3D())return null;let n=t.atomAdjList(e),l=[0,0,0,0],r=[0,0,0,0],a=[0,0,0,0],h=0,u=0;for(let s=0;s<i.length;s++){const o=t.bondFrom(i[s]),m=t.bondType(i[s]);if(l[s]=t.atomX(n[s])-t.atomX(e),r[s]=t.atomY(n[s])-t.atomY(e),t.is3D()?a[s]=t.atomZ(n[s])-t.atomZ(e):o==e&&(m==ne.BONDTYPE_INCLINED?(a[s]=1,u++):m==ne.BONDTYPE_DECLINED&&(a[s]=-1,u++)),Y(l[s],r[s],a[s])<1e-4&&(h++,h>1))return null}if(3==i.length)if(n.push(0),t.is3D()||1!=u){l[3]=-(l[0]+l[1]+l[2]),r[3]=-(r[0]+r[1]+r[2]),a[3]=-(a[0]+a[1]+a[2]);let t=H(l[3],r[3],a[3]);if(t<1e-4)return null;let e=1/Math.sqrt(t);l[3]*=e,r[3]*=e,a[3]*=e}else{let t=Math.atan2(r[0],l[0]),e=Math.atan2(r[1],l[1]),s=Math.atan2(r[2],l[2]),i=1,o=2;it(e,t)>it(s,t)&&(o=1,i=2),l[0]=1.5,r[0]=0,l[1]=-.75,r[i]=1.3,l[2]=-.75,r[o]=-1.3}let m=0,d=0;for(let t=1;t<=6;t++){let e=0,s=0;1==t?(e=1,s=2):2==t?(e=2,s=3):3==t?(e=3,s=1):4==t?(e=2,s=1):5==t?(e=3,s=2):6==t&&(e=1,s=3);let i=r[e]*a[s]-r[s]*a[e]-l[0],o=a[e]*l[s]-a[s]*l[e]-r[0],n=l[e]*r[s]-l[s]*r[e]-a[0];t<=3?m+=i*i+o*o+n*n:d+=i*i+o*o+n*n}return d>m&&s.swap(n,2,3),n}static rubricSquarePlanar(t,e){if(4!=t.atomAdjCount(e))return null;if(!t.is3D()){let s=0,i=0;for(let o of t.atomAdjBonds(e)){let e=t.bondType(o);e==ne.BONDTYPE_INCLINED?s++:e==ne.BONDTYPE_DECLINED&&i++}if(2==s&&2==i);else if(2==s&&0==i);else if(0!=s||2!=i)return null}let i=t.atomAdjList(e),o=Ht.atomVec3(t,e),n=s.sub(Ht.atomVec3(t,i[0]),o),l=s.sub(Ht.atomVec3(t,i[1]),o),r=s.sub(Ht.atomVec3(t,i[2]),o),h=s.sub(Ht.atomVec3(t,i[3]),o);for(let t of[n,l,r,h]){let e=H(t[0],t[1],t[2]);if(e<1e-4)continue;let s=1/Math.sqrt(e);t[0]*=s,t[1]*=s,t[2]*=s}let u=a.dist2(n,l),m=a.dist2(n,r),d=a.dist2(n,h);u>m&&u>=d?(s.swap(i,1,2),[l,r]=[r,l]):d>m&&(s.swap(i,3,2),[r,h]=[h,r]);const c=(t.is3D()?80:45)*J,p=(t.is3D()?100:135)*J,f=a.acuteAngle(n,l);if(f<c||f>p)return null;const g=a.acuteAngle(l,r);if(g<c||g>p)return null;const b=a.acuteAngle(r,h);if(b<c||b>p)return null;const A=a.acuteAngle(h,n);return A<c||A>p?null:i}static rubricBipyrimidal(t,e){const i=t.atomAdjCount(e);if(4!=i&&5!=i)return null;let o=0,n=0,l=t.atomAdjList(e),r=t.atomAdjBonds(e);if(!t.is3D()){for(let e=0;e<l.length;e++)if(t.bondType(r[e])==ne.BONDTYPE_INCLINED){if(o>0)return null;o=l[e]}else if(t.bondType(r[e])==ne.BONDTYPE_DECLINED){if(n>0)return null;n=l[e]}if(0==o||0==n)return null;let s=Math.atan2(t.atomY(o)-t.atomY(e),t.atomX(o)-t.atomX(e)),i=Math.atan2(t.atomY(n)-t.atomY(e),t.atomX(n)-t.atomX(e));if(Math.abs(st(s,i))>160*J)return null}let h=Ht.atomVec3(t,e),u=[[],[],[],[],[]];for(let e=0;e<i;e++){u[e]=s.sub(Ht.atomVec3(t,l[e]),h);const i=a.magnitude(u[e]);if(i<.1)return null;s.mulBy(u[e],1/i),l[e]==o?u[e][2]+=1:l[e]==n&&(u[e][2]-=1)}let m=0,d=0;const c=175*J;for(let t=0;t<i-1;t++)if(l[t]!=o&&l[t]!=n)for(let e=t+1;e<i;e++)if(l[e]!=o&&l[e]!=n&&a.acuteAngle(u[t],u[e])>c){if(0!=m)return null;m=l[t],d=l[e]}if(t.is3D())for(let t of l)t!=m&&t!=d&&(0==o?o=t:0==n&&(n=t));if(!m||!d)return null;let p=null,f=u[l.indexOf(o)],g=u[l.indexOf(n)],b=u[l.indexOf(m)],A=u[l.indexOf(d)],y=0;if(5==i){for(let t=0;t<i;t++)if(l[t]!=o&&l[t]!=n&&l[t]!=m&&l[t]!=d){y=l[t],p=u[t];break}}else{p=[0,0,0],p=s.sub(p,f),p=s.sub(p,g);const t=a.magnitude(p);if(t<.1)return null;s.mulBy(p,1/t)}let E=s.sub(A,b),M=a.crossProduct(E,p);return a.dist2(M,f)<a.dist2(M,g)?[y,o,n,m,d]:[y,o,n,d,m]}static rubricOctahedral(t,e){const i=t.atomAdjCount(e);if(5!=i&&6!=i)return null;let o=t.atomAdjList(e),n=t.atomAdjBonds(e);if(5==i&&(o.push(0),n.push(0)),!t.is3D()){let e=0;for(let s of n)if(s>0){const i=t.bondType(s);i!=ne.BONDTYPE_INCLINED&&i!=ne.BONDTYPE_DECLINED||e++}if(5==i&&e<1||6==i&&e<2)return null}let l=Ht.atomVec3(t,e),r=[[],[],[],[],[],[]];for(let h=0;h<i;h++){r[h]=Ht.atomVec3(t,o[h]),s.subFromArray(r[h],l);let i=a.magnitude(r[h]);if(i<.1)return null;s.mulBy(r[h],1/i);let u=t.bondType(n[h]);u==ne.BONDTYPE_INCLINED?t.bondFrom(n[h])==e?r[h][2]+=1:r[h][2]-=1:u==ne.BONDTYPE_DECLINED&&(t.bondFrom(n[h])==e?r[h][2]-=1:r[h][2]+=1)}if(5==i){r[5]=[0,0,0];for(let t=0;t<5;t++)s.subFromArray(r[5],r[t]);let t=a.magnitude(r[5]);if(t<.1)return null;s.mulBy(r[5],1/t)}let h=[-1,-1,-1,-1,0,1],u=a.acuteAngle(r[0],r[1]);for(let t=0;t<5;t++)for(let e=0==t?2:t+1;e<6;e++){let s=a.acuteAngle(r[t],r[e]);s>u&&(h[4]=t,h[5]=e,u=s)}let m=s.sub(r[h[5]],r[h[4]]),d=Number.POSITIVE_INFINITY;for(let t=0;t<6;t++)if(t!=h[4]&&t!=h[5]){let e=Math.abs(90*J-a.acuteAngle(r[t],m));e<d&&(h[0]=t,d=e)}for(let t=1;t<=2;t++){let e=a.crossProduct(m,r[h[t-1]]),s=Number.POSITIVE_INFINITY;for(let i=0;i<6;i++){if(i==h[4]||i==h[5]||i==h[0]||i==h[1])continue;let o=a.acuteAngle(r[i],e);o<s&&(h[t]=i,s=o)}}for(let t=0;t<6;t++)if(h.indexOf(t)<0){h[3]=t;break}let c=[0,0,0,0,0,0];for(let t=0;t<6;t++)c[t]=h[t]<0?0:o[h[t]];return c}static rubricBondSides(t,e){const i=t.bondFrom(e),o=t.bondTo(e),n=t.atomAdjCount(i),l=t.atomAdjCount(o);if(n<2||n>3||l<2||l>3)return null;let r=t.atomAdjList(i),h=t.atomAdjList(o),u=0,m=0,d=0,c=0;for(let t=0;t<r.length;t++)r[t]!=o&&(0==u?u=r[t]:m=r[t]);for(let t=0;t<h.length;t++)h[t]!=i&&(0==d?d=h[t]:c=h[t]);if(u>0&&m>0&&"H"==t.atomElement(u)){let t=u;u=m,m=t}if(d>0&&c>0&&"H"==t.atomElement(d)){let t=d;d=c,c=t}let p=Ht.atomVec3(t,i),f=Ht.atomVec3(t,o),g=s.sub(f,p),b=s.sub(Ht.atomVec3(t,u),p),A=s.sub(Ht.atomVec3(t,d),f);const y=.1*.1;let E=a.crossProduct(b,g);if(a.magnitude2(E)<y)return null;let M=a.crossProduct(A,g);if(a.magnitude2(M)<y)return null;let T=s.neg(E),x=a.dist2(E,M)<a.dist2(T,M),v=x,C=x,N=x,S=null,w=null,O=null,q=null,B=null;if(m>0)if(S=s.sub(Ht.atomVec3(t,m),p),a.magnitude2(S)<y){if("H"!=t.atomElement(m))return null}else{if(O=a.crossProduct(S,g),a.magnitude2(O)<y)return null;B=s.neg(O),v=a.dist2(O,M)>a.dist2(B,M)}if(c>0)if(w=s.sub(Ht.atomVec3(t,c),f),a.magnitude2(w)<y){if("H"!=t.atomElement(c))return null}else{if(q=a.crossProduct(w,g),a.magnitude2(q)<y)return null;C=a.dist2(E,q)>a.dist2(T,q)}return null!=O&&null!=q&&(N=a.dist2(O,q)<a.dist2(B,q)),x&&v&&C&&N?[u,m,d,c]:x||v||C||N?null:[u,m,c,d]}buildTetraChirality(){const t=this.mol,e=t.numAtoms,o=t.numBonds;let n=s.booleanArray(!1,e);for(let e=1;e<=o;e++)t.bondType(e)!=ne.BONDTYPE_INCLINED&&t.bondType(e)!=ne.BONDTYPE_DECLINED||(n[t.bondFrom(e)-1]=!0);t:for(let o=1;o<=e;o++){this.chiralTetra[o-1]=ns.STEREO_NONE;let e=t.atomAdjList(o);if(4!=e.length&&(3!=e.length||1!=t.atomHydrogens(o)))continue;if(3==e.length&&(this.isH[e[0]-1]||this.isH[e[1]-1]||this.isH[e[2]-1]))continue;for(let t=0;t<e.length-1;t++)for(let s=t+1;s<e.length;s++)if(this.priority[e[t]-1]==this.priority[e[s]-1])continue t;if(!n[o-1]&&!t.is3D()){this.chiralTetra[o-1]=ns.STEREO_UNKNOWN;continue}let l=ns.rubricTetrahedral(t,o);if(null==l)continue;let r=[0==l[0]?0:this.priority[l[0]-1],0==l[1]?0:this.priority[l[1]-1],0==l[2]?0:this.priority[l[2]-1],0==l[3]?0:this.priority[l[3]-1]];r=s.idxSort(r);let a=i.parityIdentity(r);this.chiralTetra[o-1]=0==(1&a)?ns.STEREO_POS:ns.STEREO_NEG}}buildBondCisTrans(){const t=this.mol,e=(t.numAtoms,t.numBonds);let i=s.booleanArray(!1,e);for(let e=3;e<=7;e++)for(let s of t.findRingsOfSize(e))for(let e=0;e<s.length;e++)i[t.findBond(s[e],s[e<s.length-1?e+1:0])-1]=!0;t:for(let s=1;s<=e;s++){if(this.cistransBond[s-1]=ns.STEREO_NONE,2!=t.bondOrder(s)||this.meta.isBondAromatic(s)||i[s-1])continue;let e=t.bondFrom(s),o=t.bondTo(s),n=t.atomAdjList(e),l=t.atomAdjList(o);if(n.length<=1||l.length<=1||n.length>3||l.length>3)continue;if(2==n.length&&(this.isH[n[0]-1]||this.isH[n[1]-1]))continue;if(2==l.length&&(this.isH[l[0]-1]||this.isH[l[1]-1]))continue;for(let t=0;t<n.length-1;t++)if(n[t]!=e)for(let s=t+1;s<n.length;s++)if(n[s]!=e&&this.priority[n[t]-1]==this.priority[n[s]-1])continue t;for(let t=0;t<l.length-1;t++)if(l[t]!=o)for(let e=t+1;e<l.length;e++)if(l[e]!=o&&this.priority[l[t]-1]==this.priority[l[e]-1])continue t;if(t.bondType(s)==ne.BONDTYPE_UNKNOWN){this.cistransBond[s-1]=ns.STEREO_UNKNOWN;continue}let r=ns.rubricBondSides(t,s);if(null==r)continue;let a=0==r[0]?0:this.priority[r[0]-1],h=0==r[1]?0:this.priority[r[1]-1],u=0==r[2]?0:this.priority[r[2]-1],m=0==r[3]?0:this.priority[r[3]-1];this.cistransBond[s-1]=a<h==u<m?ns.STEREO_POS:ns.STEREO_NEG}}buildPlanarCisTrans(){const t=this.mol,e=t.numAtoms;t.numBonds;t:for(let s=1;s<=e;s++){if(this.squarePlanar[s-1]=ns.STEREO_NONE,4!=t.atomAdjCount(s))continue;if(qt.ELEMENT_BLOCKS[t.atomicNumber(s)]<3)continue;let e=t.atomAdjList(s);for(let t=0;t<e.length;t++){let s=0;for(let i=0;i<e.length;i++)this.priority[e[t]-1]==this.priority[e[i]-1]&&s++;if(s>=3)continue t}let o=ns.rubricSquarePlanar(t,s);if(null==o)continue;let n=[0==o[0]?0:this.priority[o[0]-1],0==o[1]?0:this.priority[o[1]-1],0==o[2]?0:this.priority[o[2]-1],0==o[3]?0:this.priority[o[3]-1]],l=i.parityOrder(n);this.squarePlanar[s-1]=0==(1&l)?ns.STEREO_POS:ns.STEREO_NEG}}buildOctaChirality(){}buildPriority(){const t=this.mol,e=t.numAtoms,i=t.numBonds;let o=[];for(let i=0;i<e;i++)o.push(s.numberArray(-1,t.atomHydrogens(i+1)));for(let e=1;e<=i;e++){let s=t.bondFrom(e)-1,i=t.bondTo(e)-1,n=t.bondOrder(e);if(this.meta.isBondAromatic(e)&&(n=2),s!=i)for(let t=0;t<n;t++)o[s].push(i),o[i].push(s)}this.priority=s.numberArray(0,e);let n=!1;for(let s=0;s<e;s++)this.priority[s]=t.atomicNumber(s+1),1==this.priority[s]&&(n=!0);let l=[];for(let t=0;t<e;t++)l.push([]);for(;;){for(let t=0;t<e;t++){let e=o[t],i=[];for(let t=0;t<e.length;t++)i.push(e[t]<0?1:this.priority[e[t]]);s.sort(i),l[t]=i}let t=this.sortAndGroup(this.priority),i=n?0:1,r=!1;for(let e=0;e<t.length;e++){let s=t[e];for(let t=0;t<s.length-1;){const e=s[t],i=s[t+1];let o=0,n=Math.max(l[e].length,l[i].length);for(let t=0;t<n;t++){let s=t<l[e].length?l[e][t]:0,n=t<l[i].length?l[i][t]:0;if(s<n){o=-1;break}if(s>n){o=1;break}}o>0?(s[t]=i,s[t+1]=e,t>0&&t--):t++}for(let t=0;t<s.length;t++){if(0==t)i++;else if(l[s[t]].length!=l[s[t-1]].length)i++,r=!0;else for(let e=0;e<l[s[t]].length;e++)if(l[s[t]][e]!=l[s[t-1]][e]){i++,r=!0;break}this.priority[s[t]]=i}}if(!r)break}}sortAndGroup(t){let e=new Set;for(let s of t)e.add(s);let i=Array.from(e);s.sort(i);let o=[];for(let t=0;t<i.length;t++)o.push([]);for(let e=0;e<t.length;e++)o[i.indexOf(t[e])].push(e);return o}}ns.STEREO_NONE=0,ns.STEREO_POS=1,ns.STEREO_NEG=2,ns.STEREO_UNKNOWN=3,ns.STEREO_BROKEN=4,ns.RUBRIC_EQUIV_TETRA=[[0,1,2,3],[0,2,3,1],[0,3,1,2],[1,0,3,2],[1,2,0,3],[1,3,2,0],[2,0,1,3],[2,1,3,0],[2,3,0,1],[3,0,2,1],[3,1,0,2],[3,2,1,0]],ns.RUBRIC_EQUIV_SIDES=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],ns.RUBRIC_EQUIV_SQUARE=[[0,1,2,3],[0,3,2,1],[1,2,3,0],[1,0,3,2],[2,1,0,3],[2,3,0,1],[3,2,1,0],[3,0,1,2]],ns.RUBRIC_EQUIV_BIPY=[[0,1,2,3,4],[1,2,0,3,4],[2,0,1,3,4],[0,2,1,4,3],[1,0,2,4,3],[2,1,0,4,3]],ns.RUBRIC_EQUIV_OCTA=[[0,1,2,3,4,5],[0,3,2,1,5,4],[0,4,2,5,3,1],[0,5,2,4,1,3],[1,0,3,2,5,4],[1,2,3,0,4,5],[1,4,3,5,0,2],[1,5,3,4,2,0],[2,1,0,3,5,4],[2,3,0,1,4,5],[2,4,0,5,1,3],[2,5,0,4,3,1],[3,0,1,2,4,5],[3,2,1,0,5,4],[3,4,1,5,2,0],[3,5,1,4,0,2],[4,0,5,2,1,3],[4,1,5,3,2,0],[4,2,5,0,3,1],[4,3,5,1,0,2],[5,0,4,2,3,1],[5,1,4,3,0,2],[5,2,4,0,1,3],[5,3,4,1,2,0]];class ls{constructor(t){this.mol=t,this.atomArom=null,this.bondArom=null,this.rubricTetra=null,this.rubricSquare=null,this.rubricBipy=null,this.rubricOcta=null,this.rubricSides=null,this.hash=null,this.heavyHash=null,this.uniqueElements=null,this.dots=null,this.piAtom=null}calculateStrictAromaticity(){let t=this.mol;this.atomArom=s.booleanArray(!1,t.numAtoms),this.bondArom=s.booleanArray(!1,t.numBonds);let e=t.findRingsOfSize(6);const i=e.length;if(0==i)return;this.ensurePiAtoms();let o=s.booleanArray(!1,i);for(let s=0;s<i;s++)for(let i=0;i<e[s].length;i++){let n=e[s][i];if(!this.piAtom[n-1]){o[s]=!0;break}let l=t.findBond(n,e[s][i==e[s].length-1?0:i+1]),r=t.bondOrder(l);if(1!=r&&2!=r){o[s]=!0;break}}for(;;){let s=!1;for(let n=0;n<i;n++)if(!o[n]){let i=!0,l=!0;for(let s=0;s<e[n].length;s++){let o=t.findBond(e[n][s],e[n][s==e[n].length-1?0:s+1]);if(this.bondArom[o-1])continue;let r=t.bondOrder(o);i=i&&r==2-(1&s),l=l&&r==1+(1&s)}if(!i&&!l)continue;for(let s=0;s<e[n].length;s++){let i=t.findBond(e[n][s],e[n][s==e[n].length-1?0:s+1]);this.bondArom[i-1]=!0}o[n]=!0,s=!0}if(!s)break}for(let e=0;e<this.bondArom.length;e++)this.bondArom[e]&&(this.atomArom[t.bondFrom(e+1)-1]=!0,this.atomArom[t.bondTo(e+1)-1]=!0)}calculateRelaxedAromaticity(){let t=this.mol;this.atomArom=s.booleanArray(!1,t.numAtoms),this.bondArom=s.booleanArray(!1,t.numBonds),this.ensurePiAtoms();const e=t.numAtoms,i=t.numBonds;let o=s.numberArray(0,e),n=s.booleanArray(!1,e);for(let s=1;s<=e;s++){let e=t.atomicNumber(s);o[s-1]=(2==qt.ELEMENT_BLOCKS[e]?qt.ELEMENT_VALENCE[e]:0)-t.atomCharge(s)-t.atomHydrogens(s)-t.atomUnpaired(s)}for(let e=1;e<=i;e++){const s=t.bondFrom(e),i=t.bondTo(e),l=t.bondOrder(e);if(o[s-1]-=l,o[i-1]-=l,2==l){const e=t.atomRingBlock(s),o=t.atomRingBlock(i);e>0&&e!=o&&(n[s-1]=!0),o>0&&o!=e&&(n[i-1]=!0)}}let l=[];for(let e=3;e<=7;e++)for(let s of t.findRingsOfSize(e)){let i=!0;for(let l=0;l<e;l++){const r=s[l];if(!this.piAtom[r-1]&&o[r-1]<2&&!n[r-1]){i=!1;break}let a=t.findBond(r,s[l<e-1?l+1:0]),h=t.bondOrder(a);if(1!=h&&2!=h){i=!1;break}}i&&l.push(s)}for(;l.length>0;){let e=!1;for(let i=0;i<l.length;i++){let n=l[i],r=[0];for(let e=0;e<n.length;e++){const i=n[e],l=t.findBond(i,n[e<n.length-1?e+1:0]),a=t.findBond(i,n[e>0?e-1:n.length-1]);if(this.bondArom[l-1])for(let t=r.length-1;t>=0;t--){const e=r[t]+2;r.indexOf(e)<0&&(r=s.append(r,e))}else(2==t.bondOrder(l)||o[i-1]>=2&&1==t.bondOrder(l)&&1==t.bondOrder(a))&&s.addTo(r,2)}let a=!1;for(let t of r){if(2==t&&3==n.length){a=!0;break}if(6==t){a=!0;break}}if(a){for(let e=0;e<n.length;e++){let s=n[e],i=t.findBond(s,n[e<n.length-1?e+1:0]);this.atomArom[s-1]=!0,this.bondArom[i-1]=!0}l.splice(i,1),i--,e=!0}}if(!e)break}}calculateStereoRubric(){const t=this.mol,e=t.numAtoms,s=t.numBonds;this.rubricTetra=new Array(e),this.rubricSquare=new Array(e),this.rubricBipy=new Array(e),this.rubricOcta=new Array(e),this.rubricSides=new Array(s);for(let s=1;s<=e;s++){let e=qt.ELEMENT_BLOCKS[t.atomicNumber(s)],i=t.atomAdjCount(s),o=t.atomHydrogens(s),n=0,l=0;for(let e of t.atomAdjBonds(s))t.bondType(e)==ne.BONDTYPE_INCLINED&&t.bondFrom(e)==s?n++:t.bondType(e)==ne.BONDTYPE_DECLINED&&t.bondFrom(e)==s&&l++;(2==e&&(3==i&&1==o||4==i&&0==o)||e>=3&&4==i&&1==n&&1==l)&&(this.rubricTetra[s-1]=ns.rubricTetrahedral(t,s)),e>=3&&4==i&&0==o&&(this.rubricSquare[s-1]=ns.rubricSquarePlanar(t,s)),e>=3&&(4==i||5==i)&&0==o&&(this.rubricBipy[s-1]=ns.rubricBipyrimidal(t,s)),(e>=3&&(5==i||6==i)&&0==o||2==e&&6==i&&0==o)&&(this.rubricOcta[s-1]=ns.rubricOctahedral(t,s))}for(let e=1;e<=t.numBonds;e++){if(2!=t.bondOrder(e)||t.bondType(e)==ne.BONDTYPE_UNKNOWN||this.isBondAromatic(e))continue;let s=t.bondFrom(e),i=t.bondTo(e),o=qt.ELEMENT_BLOCKS[t.atomicNumber(s)],n=qt.ELEMENT_BLOCKS[t.atomicNumber(i)],l=t.atomAdjCount(s),r=t.atomHydrogens(s),a=t.atomAdjCount(i),h=t.atomHydrogens(i);2==o&&2==n&&l+r==3&&r<=1&&a+h==3&&h<=1&&(this.rubricSides[e-1]=ns.rubricBondSides(t,e))}}removeHydrogens(){let t=this.mol,e=t.numAtoms,i=t.numBonds,o=s.booleanArray(!0,e),n=s.booleanArray(!0,i);for(let s=1;s<=e;s++)Ht.boringHydrogen(t,s)&&(o[s-1]=!1,n[t.atomAdjBonds(s)[0]-1]=!1);if(!s.allTrue(o)&&(t=Ht.subgraphMask(t,o),this.atomArom&&(this.atomArom=s.maskGet(this.atomArom,o)),this.bondArom&&(this.bondArom=s.maskGet(this.bondArom,n)),this.rubricTetra||this.rubricSquare||this.rubricBipy||this.rubricOcta||this.rubricSides)){this.rubricTetra&&(this.rubricTetra=s.maskGet(this.rubricTetra,o)),this.rubricSquare&&(this.rubricSquare=s.maskGet(this.rubricSquare,o)),this.rubricBipy&&(this.rubricBipy=s.maskGet(this.rubricBipy,o)),this.rubricOcta&&(this.rubricOcta=s.maskGet(this.rubricOcta,o)),this.rubricSides&&(this.rubricSides=s.maskGet(this.rubricSides,n));let t=s.prepend(s.add(s.maskMap(o),1),0);for(let e=0;e<s.len(this.rubricTetra);e++)this.rubricTetra[e]&&(this.rubricTetra[e]=s.idxGet(t,this.rubricTetra[e]));for(let e=0;e<s.len(this.rubricSquare);e++)this.rubricSquare[e]&&(this.rubricSquare[e]=s.idxGet(t,this.rubricSquare[e]));for(let e=0;e<s.len(this.rubricBipy);e++)this.rubricBipy[e]&&(this.rubricBipy[e]=s.idxGet(t,this.rubricBipy[e]));for(let e=0;e<s.len(this.rubricOcta);e++)this.rubricOcta[e]&&(this.rubricOcta[e]=s.idxGet(t,this.rubricOcta[e]));for(let e=0;e<s.len(this.rubricSides);e++)this.rubricSides[e]&&(this.rubricSides[e]=s.idxGet(t,this.rubricSides[e]))}}calculateSkeletonHash(){if(null==ls.skeletonHash)throw"Skeleton hash not available.";this.hash=ls.skeletonHash(this.mol)}calculateHeavyHash(){let t=!1;for(let e=1;e<=this.mol.numAtoms;e++)if("H"==this.mol.atomElement(e)){t=!0;break}if(!t)return void(this.heavyHash=this.getSkeletonHash());let e=this.mol.clone();for(let t=e.numAtoms;t>=1;t--)"H"==e.atomElement(t)&&e.deleteAtomAndBonds(t);this.heavyHash=ls.skeletonHash(e)}isAtomAromatic(t){return null!=this.atomArom&&this.atomArom[t-1]}isBondAromatic(t){return null!=this.bondArom&&this.bondArom[t-1]}bondOrderArom(t){return null!=this.bondArom&&this.bondArom[t-1]?-1:this.mol.bondOrder(t)}getAtomAromaticity(){return null==this.atomArom?null:this.atomArom.slice(0)}getBondAromaticity(){return null==this.bondArom?null:this.bondArom.slice(0)}getSkeletonHash(){return null==this.hash&&this.calculateSkeletonHash(),this.hash}getHeavyHash(){return null==this.heavyHash&&this.calculateHeavyHash(),this.heavyHash}getDotPath(){return null==this.dots&&(this.dots=new os(this.mol)),this.dots}getUniqueElements(){if(null==this.uniqueElements){this.uniqueElements=[];for(let t=1;t<=this.mol.numAtoms;t++){let e=this.mol.atomElement(t);this.uniqueElements.indexOf(e)<0&&this.uniqueElements.push(e)}}return this.uniqueElements}equivalentTo(t,e=1e3){if(null==ls.isomorphMatch)throw"Isomorph search unavailable.";if(this.mol.numAtoms!=t.mol.numAtoms||this.mol.numBonds!=t.mol.numBonds)return!1;if(null==this.hash&&this.calculateSkeletonHash(),null==t.hash&&t.calculateSkeletonHash(),this.hash!=t.hash)return!1;if(0==this.mol.compareTo(t.mol))return!0;let s=this.getUniqueElements(),i=t.getUniqueElements();for(let t=0;t<s.length;t++)if(!i.includes(s[t]))return!1;return ls.isomorphMatch(this,t,e)}static createRubric(t){if(null==t)return null;let e=new ls(t);return e.calculateStereoRubric(),e}static createStrict(t){if(null==t)return null;let e=new ls(t);return e.calculateStrictAromaticity(),e}static createStrictRubric(t){if(null==t)return null;let e=new ls(t);return e.calculateStrictAromaticity(),e.calculateStereoRubric(),e}static createRelaxed(t){if(null==t)return null;let e=new ls(t);return e.calculateRelaxedAromaticity(),e}static createRelaxedRubric(t){if(null==t)return null;let e=new ls(t);return e.calculateRelaxedAromaticity(),e.calculateStereoRubric(),e}ensurePiAtoms(){if(null==this.piAtom){this.piAtom=s.booleanArray(!1,this.mol.numAtoms);for(let t=1;t<=this.mol.numBonds;t++)2==this.mol.bondOrder(t)&&(this.piAtom[this.mol.bondFrom(t)-1]=!0,this.piAtom[this.mol.bondTo(t)-1]=!0)}}}ls.skeletonHash=null,ls.isomorphMatch=null;let rs=[];const as=4294967295;function hs(){return as}function us(t,e){return rs[255&(t^e)]^t>>>8}function ms(t){return t^as}class ds{constructor(t,e){this.meta=t,this.kind=e,this.hookApplyNewFP=null,this.hookConsiderNewFP=null,this.identity=[],this.resolvedChiral=[],this.atomGroup=[],this.fplist=[],this.amask=[],this.atomAdj=[],this.bondAdj=[],function(){if(!(rs.length>0))for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)0!=(1&e)?e=3988292384^e>>>1:e>>>=1;rs.push(e)}}()}calculate(){let t=this.meta.mol,e=t.numAtoms;this.identity=s.numberArray(0,e),this.resolvedChiral=s.booleanArray(!1,e);for(let t=0;t<e;t++)this.atomGroup.push([]);this.amask=s.booleanArray(!1,e);for(let s=0;s<e;s++)this.amask[s]=t.atomicNumber(s+1)>=2&&!Ht.hasAbbrev(t,s+1),this.atomAdj.push([]),this.bondAdj.push([]);for(let s=0;s<e;s++)if(this.amask[s]){this.atomAdj[s]=t.atomAdjList(s+1),this.bondAdj[s]=t.atomAdjBonds(s+1);for(let t=this.atomAdj[s].length-1;t>=0;t--)this.amask[this.atomAdj[s][t]-1]||(this.atomAdj[s].splice(t,1),this.bondAdj[s].splice(t,1))}for(let t=0;t<e;t++)this.amask[t]&&(this.identity[t]=this.initialIdentityECFP(t+1),this.atomGroup[t]=[t+1],this.applyNewFP({hashCode:this.identity[t],iteration:0,atoms:this.atomGroup[t],centralAtom:t+1}));let i=this.kind;for(let t=1;t<=i;t++){let i=s.numberArray(0,e);for(let s=0;s<e;s++)this.amask[s]&&(i[s]=this.circularIterate(t,s+1));this.identity=i;for(let s=0;s<e;s++)this.amask[s]&&(this.atomGroup[s]=this.growAtoms(this.atomGroup[s]),this.considerNewFP({hashCode:this.identity[s],iteration:t,atoms:this.atomGroup[s],centralAtom:s+1}))}}static create(t,e){t instanceof ne&&(t=ls.createStrictRubric(t));let s=new ds(t,e);return s.calculate(),s}getMolecule(){return this.meta.mol}get numFP(){return this.fplist.length}getFP(t){return this.fplist[t]}getFingerprints(){return this.fplist.slice(0)}getUniqueHashes(){let t=new Set;for(let e of this.fplist)t.add(e.hashCode);return s.sorted(Array.from(t))}getFoldedHashes(t){let e=t-1,i=new Set;for(let t of this.fplist)i.add(t.hashCode&e);return s.sorted(Array.from(i))}static tanimoto(t,e){let s=0,i=0,o=t.length,n=e.length;if(0==o&&0==n)return 0;let l=0,r=0;for(;l<o||r<n;){if(l==o){i+=n-r;break}if(r==n){i+=o-l;break}let a=t[l],h=e[r];a==h?(s+=1,l+=1,r+=1):a<h?l+=1:r+=1,i+=1}return s/i}initialIdentityECFP(t){const e=this.meta.mol;let s=e.atomAdjList(t),i=0,o=e.atomHydrogens(t);for(let t of s)"H"==e.atomElement(t)?o++:i++;let n=e.atomicNumber(t),l=Math.max(0,qt.ELEMENT_BONDING[n]-o),r=e.atomCharge(t),a=e.atomRingBlock(t)>0?1:0,h=hs();return h=us(h,i<<4|l),h=us(h,n),h=us(h,r+128),h=us(h,o<<4|a),ms(h)}circularIterate(t,e){let o=this.atomAdj[e-1],n=this.bondAdj[e-1],l=s.numberArray(0,2+2*o.length);l[0]=t,l[1]=this.identity[e-1];for(let t=0;t<o.length;t++)l[2*t+2]=this.meta.isBondAromatic(n[t])?15:this.meta.mol.bondOrder(n[t]),l[2*t+3]=this.identity[o[t]-1];let r=0;for(;r<o.length-1;){let t=2+2*r;l[t]>l[t+2]||l[t]==l[t+2]&&l[t+1]>l[t+3]?(s.swap(l,t,t+2),s.swap(l,t+1,t+3),r>0&&r--):r++}let a=hs();for(let t=0;t<l.length;t+=2){a=us(a,l[t]);let e=l[t+1];a=us(a,e>>24),a=us(a,e>>16&255),a=us(a,e>>8&255),a=us(a,255&e)}if(!this.resolvedChiral[e-1]&&s.len(this.meta.rubricTetra)>0&&null!=this.meta.rubricTetra[e-1]){let t=this.meta.rubricTetra[e-1],s=[0==t[0]?0:this.identity[t[0]-1],0==t[1]?0:this.identity[t[1]-1],0==t[2]?0:this.identity[t[2]-1],0==t[3]?0:this.identity[t[3]-1]];s[0]!=s[1]&&s[0]!=s[2]&&s[0]!=s[3]&&s[1]!=s[2]&&s[1]!=s[3]&&s[2]!=s[3]&&(a=us(a,i.parityOrder(s)+1),this.resolvedChiral[e-1]=!0)}return ms(a)}growAtoms(t){let e=s.booleanArray(!1,this.meta.mol.numAtoms);for(let s=0;s<t.length;s++){e[t[s]-1]=!0;for(let i of this.atomAdj[t[s]-1])e[i-1]=!0}return s.add(s.maskIdx(e),1)}applyNewFP(t){this.hookConsiderNewFP&&this.hookConsiderNewFP(t),this.hookApplyNewFP&&this.hookApplyNewFP(t),this.fplist.push(t)}considerNewFP(t){this.hookConsiderNewFP&&this.hookConsiderNewFP(t);let e=-1,i=null;for(let o=0;o<this.fplist.length;o++){let n=this.fplist[o];if(s.equals(n.atoms,t.atoms)){i=n,e=o;break}}e<0?this.fplist.push(t):i.iteration<t.iteration||i.hashCode<t.hashCode||(this.fplist[e]=t,this.hookApplyNewFP&&this.hookApplyNewFP(t))}}ds.CLASS_ECFP0=0,ds.CLASS_ECFP2=1,ds.CLASS_ECFP4=2,ds.CLASS_ECFP6=3;class cs{constructor(t,e){this.classType=t,this.folding=e,this.numActive=0,this.inHash={},this.training=[],this.activity=[],this.contribs={},this.lowThresh=0,this.highThresh=0,this.range=0,this.invRange=0,this.estimates=null,this.rocX=null,this.rocY=null,this.rocType=null,this.rocAUC=Number.NaN,this.trainingSize=0,this.trainingActives=0,this.atomicSlopeA=Number.NaN,this.atomicInterceptB=Number.NaN,this.truthTP=0,this.truthFP=0,this.truthTN=0,this.truthFN=0,this.precision=Number.NaN,this.recall=Number.NaN,this.specificity=Number.NaN,this.statF1=Number.NaN,this.statKappa=Number.NaN,this.statMCC=Number.NaN,this.noteTitle=null,this.noteOrigin=null,this.noteField=null,this.noteComments=null,null==this.folding&&(this.folding=0)}addMolecule(t,e,s){if(Ht.isBlank(t)&&null==s)throw"Molecule cannot be blank or null.";if(null==s){let e=ls.createStrictRubric(t),i=new ds(e,this.classType);i.calculate(),s=0==this.folding?i.getUniqueHashes():i.getFoldedHashes(this.folding)}e&&this.numActive++,this.training.push(s),this.activity.push(e);for(let t of s){let s=this.inHash[t];null==s&&(s=[0,0]),e&&s[0]++,s[1]++,this.inHash[t]=s}}build(){this.trainingSize=this.training.length,this.trainingActives=this.numActive,this.contribs=[];const t=1/this.training.length,e=this.numActive*t;for(let t in this.inHash){let s=parseInt(t);const i=this.inHash[s],o=(i[0]+1)/(i[1]*e+1),n=Math.log(o);this.contribs[s]=n}this.lowThresh=Number.POSITIVE_INFINITY,this.highThresh=Number.NEGATIVE_INFINITY;for(let t of this.training){let e=0;for(let s of t)e+=this.contribs[s];this.lowThresh=Math.min(this.lowThresh,e),this.highThresh=Math.max(this.highThresh,e)}this.range=this.highThresh-this.lowThresh,this.invRange=this.range>0?1/this.range:0}predictMolecule(t){if(Ht.isBlank(t))throw"Molecule cannot be blank or null.";let e=ls.createStrictRubric(t),s=new ds(e,this.classType);s.calculate();let i=0==this.folding?s.getUniqueHashes():s.getFoldedHashes(this.folding);return this.predictFP(i)}predictFP(t){let e=0;for(let s of t){let t=this.contribs[s];null!=t&&(e+=t)}return e}scalePredictor(t){return 0==this.range?t>=this.highThresh?1:0:(t-this.lowThresh)*this.invRange}scaleArcTan(t){const e=1/Math.PI;return Math.atan(2*t-1)*e+.5}calculateOverlap(t){if(Ht.isBlank(t))throw"Molecule cannot be blank or null.";let e=ls.createStrictRubric(t),s=new ds(e,this.classType);s.calculate();let i=0==this.folding?s.getUniqueHashes():s.getFoldedHashes(this.folding);return this.calculateOverlapFP(i)}calculateOverlapFP(t){if(0==t.length)return 0;let e=0;for(let s of t)null!=this.contribs[s]&&e++;return 1==t.length?e:e/t.length}calculateAtomPredictors(t){const e=t.numAtoms;let i=s.numberArray(0,e),o=new Set,n=this.determineCoverage(t,o);for(let t in n){let o=this.contribs[t];if(null==o)continue;let l=n[t],r=1/s.maskCount(l);for(let t=0;t<e;t++)l[t]&&(i[t]+=o*r)}if(!isNaN(this.atomicSlopeA)){for(let t=0;t<e;t++)i[t]=this.atomicSlopeA*i[t]+this.atomicInterceptB;return i}let l=0;for(let t of o){let e=this.contribs[t];null!=e&&(l+=e)}const r=1/e;s.addTo(i,-s.sum(i)*r);let a=0;for(let t of i)a+=t*t;a=Math.sqrt(a*r),a>.001&&s.mulBy(i,.25/a);let h=2*(this.scalePredictor(l)-.5);return h<-1?h=-1:h>1&&(h=1),s.addTo(i,h),i}validateLeaveOneOut(){const t=this.training.length;this.estimates=[];for(let e=0;e<t;e++)this.estimates.push(this.singleLeaveOneOut(e));this.calculateROC(),this.calculateTruth(),this.rocType="leave-one-out"}validateFiveFold(){this.rocType="five-fold",this.validateNfold(5)}validateThreeFold(){this.rocType="three-fold",this.validateNfold(3)}clearTraining(){this.training=[],this.activity=[]}serialise(){let t=[],e=this.classType==ds.CLASS_ECFP0?"ECFP0":this.classType==ds.CLASS_ECFP2?"ECFP2":this.classType==ds.CLASS_ECFP4?"ECFP4":this.classType==ds.CLASS_ECFP6?"ECFP6":"?";t.push("Bayesian!("+e+","+this.folding+","+this.lowThresh+","+this.highThresh+")");let i=[];for(let t in this.contribs)i.push(parseInt(t));s.sort(i);for(let e of i){const s=this.contribs[e];t.push(e+"="+s)}if(t.push("training:size="+this.trainingSize),t.push("training:actives="+this.trainingActives),Number.isNaN(this.rocAUC)||t.push("roc:auc="+this.rocAUC),null!=this.rocType&&t.push("roc:type="+this.rocType),null!=this.rocX&&null!=this.rocY){let e="roc:x=";for(let t=0;t<this.rocX.length;t++)e+=(0==t?"":",")+this.rocX[t];t.push(e);let s="roc:y=";for(let t=0;t<this.rocY.length;t++)s+=(0==t?"":",")+this.rocY[t];t.push(s)}if((this.truthTP>0||this.truthFP>0||this.truthTN>0||this.truthFP>0)&&(t.push("truth:TP="+this.truthTP),t.push("truth:FP="+this.truthFP),t.push("truth:TN="+this.truthTN),t.push("truth:FN="+this.truthFN),t.push("truth:precision="+this.precision),t.push("truth:recall="+this.recall),t.push("truth:specificity="+this.specificity),t.push("truth:F1="+this.statF1),t.push("truth:kappa="+this.statKappa),t.push("truth:MCC="+this.statMCC)),isNaN(this.atomicSlopeA)||isNaN(this.atomicInterceptB)||(t.push("atomic:slope="+this.atomicSlopeA),t.push("atomic:intercept="+this.atomicInterceptB)),this.noteTitle&&t.push("note:title="+this.noteTitle),this.noteOrigin&&t.push("note:origin="+this.noteOrigin),this.noteField&&t.push("note:field="+this.noteField),this.noteComments)for(let e of this.noteComments)t.push("note:comment="+e);return t.push("!End"),t.join("\n")}static deserialise(t){let e=t.split("\n"),s=0;function i(){return s>=e.length?null:e[s++].trim()}let o=i();if(null==o||!o.startsWith("Bayesian!(")||!o.endsWith(")"))throw"Not a serialised Bayesian model.";let n=o.substring(10,o.length-1).split(",");if(n.length<4)throw"Invalid header content";let l="ECFP0"==n[0]?ds.CLASS_ECFP0:"ECFP2"==n[0]?ds.CLASS_ECFP2:"ECFP4"==n[0]?ds.CLASS_ECFP4:"ECFP6"==n[0]?ds.CLASS_ECFP6:0;if(0==l)throw"Unknown fingerprint type: "+n[0];let r=parseInt(n[1]);if(r>0)for(let t=r;t>0;t>>=1)if(1==(1&t)&&1!=t){r=-1;break}if(r<0)throw"Fingerprint folding "+n[1]+" invalid: must be 0 or power of 2.";let a=new cs(l,r);a.lowThresh=parseFloat(n[2]),a.highThresh=parseFloat(n[3]),a.range=a.highThresh-a.lowThresh,a.invRange=a.range>0?1/a.range:0;const h=new RegExp("^(-?\\d+)=([\\d\\.Ee-]+)");for(;;){if(o=i(),null==o)throw"Missing correct terminator line.";if("!End"==o)break;let t=h.exec(o);if(null!=t){let e=parseInt(t[1]),s=parseFloat(t[2]);a.contribs[e]=s}else if(o.startsWith("training:size="))a.trainingSize=parseInt(o.substring(14));else if(o.startsWith("training:actives="))a.trainingActives=parseInt(o.substring(17));else if(o.startsWith("roc:auc="))a.rocAUC=parseFloat(o.substring(8));else if(o.startsWith("roc:type="))a.rocType=o.substring(9);else if(o.startsWith("roc:x=")){a.rocX=[];for(let t of o.substring(6).split(","))a.rocX.push(parseFloat(t))}else if(o.startsWith("roc:y=")){a.rocY=[];for(let t of o.substring(6).split(","))a.rocY.push(parseFloat(t))}else o.startsWith("truth:TP=")?a.truthTP=parseInt(o.substring(9),0):o.startsWith("truth:FP=")?a.truthFP=parseInt(o.substring(9),0):o.startsWith("truth:TN=")?a.truthTN=parseInt(o.substring(9),0):o.startsWith("truth:FN=")?a.truthFN=parseInt(o.substring(9),0):o.startsWith("truth:precision=")?a.precision=parseFloat(o.substring(16)):o.startsWith("truth:recall=")?a.recall=parseFloat(o.substring(13)):o.startsWith("truth:specificity=")?a.specificity=parseFloat(o.substring(18)):o.startsWith("truth:F1=")?a.statF1=parseFloat(o.substring(9)):o.startsWith("truth:kappa=")?a.statKappa=parseFloat(o.substring(12)):o.startsWith("truth:MCC=")?a.statMCC=parseFloat(o.substring(10)):o.startsWith("atomic:slope=")?a.atomicSlopeA=parseFloat(o.substring(13)):o.startsWith("atomic:intercept=")?a.atomicInterceptB=parseFloat(o.substring(17)):o.startsWith("note:title=")?a.noteTitle=o.substring(11):o.startsWith("note:origin=")?a.noteOrigin=o.substring(12):o.startsWith("note:field=")?a.noteField=o.substring(11):o.startsWith("note:comment=")&&(null==a.noteComments&&(a.noteComments=[]),a.noteComments.push(o.substring(13)))}return a}singleLeaveOneOut(t){let e=this.activity[t],s=new Set;for(let e of this.training[t])s.add(e);const i=1/(this.training.length-1),o=(e?this.numActive-1:this.numActive)*i;let n=0;for(let t in this.inHash){const i=parseInt(t);if(!s.has(i))continue;const l=this.inHash[i],r=(l[0]-(e?1:0)+1)/((l[1]-1)*o+1);n+=Math.log(r)}return n}validateNfold(t){const e=this.training.length;let i=s.numberArray(0,e),o=0;for(let t=0;t<e;t++)this.activity[t]&&(i[o++]=t);for(let t=0;t<e;t++)this.activity[t]||(i[o++]=t);let n=[];for(let e=0;e<t;e++)n.push(this.buildPartial(i,e,t));this.estimates=s.numberArray(0,e);for(let s=0;s<e;s++)this.estimates[i[s]]=this.estimatePartial(i,s,n[s%t]);this.calculateROC(),this.calculateTruth()}buildPartial(t,e,s){const i=this.training.length;let o=0,n=0,l={};for(let r=0;r<i;r++)if(r%s!=e){const e=this.activity[t[r]];e&&o++,n++;for(let s of this.training[t[r]]){let t=l[s];null==t&&(t=[0,0]),e&&t[0]++,t[1]++,l[s]=t}}let r={};const a=o*(1/n);for(let t in l){let e=parseInt(t);const s=l[e],i=(s[0]+1)/(s[1]*a+1),o=Math.log(i);r[e]=o}return r}estimatePartial(t,e,s){let i=0;for(let o of this.training[t[e]]){let t=s[o];null!=t&&(i+=t)}return i}calculateROC(){const t=this.training.length;let e=s.idxSort(this.estimates),i=[];i.push(this.lowThresh-.01*this.range);for(let s=0;s<t-1;s++){const t=this.estimates[e[s]],o=this.estimates[e[s+1]];t!=o&&i.push(.5*(t+o))}i.push(this.highThresh+.01*this.range),this.rocX=[],this.rocY=[];let o=[],n=0,l=0,r=0,a=1/this.numActive,h=1/(t-this.numActive);for(let s=0;s<i.length;s++){const u=i[s];for(;r<t&&!(u<this.estimates[e[r]]);r++)this.activity[e[r]]?n++:l++;const m=l*h,d=n*a,c=o.length;c>0&&m==this.rocX[c-1]&&d==this.rocY[c-1]||(this.rocX[c]=1-m,this.rocY[c]=1-d,o[c]=u)}this.rocX=s.reverse(this.rocX),this.rocY=s.reverse(this.rocY),o=s.reverse(o),this.calibrateThresholds(this.rocX,this.rocY,o),this.rocAUC=0;for(let t=0;t<o.length-1;t++){const e=this.rocX[t+1]-this.rocX[t],s=.5*(this.rocY[t]+this.rocY[t+1]);this.rocAUC+=e*s}let u=[],m=[];u.push(this.rocX[0]),m.push(this.rocY[0]);for(let t=1;t<o.length-1;t++)X(this.rocX[t]-u[u.length-1],this.rocY[t]-m[m.length-1])<4e-6||(u.push(this.rocX[t]),m.push(this.rocY[t]));u.push(this.rocX[o.length-1]),m.push(this.rocY[o.length-1])}calculateTruth(){let t=.5*(this.lowThresh+this.highThresh);this.truthTP=this.truthFP=this.truthTN=this.truthFN=0;for(let e=0;e<this.activity.length;e++){let s=this.activity[e],i=this.estimates[e]>=t;s&&i?this.truthTP++:!s&&i?this.truthFP++:s&&!i?this.truthFN++:s||i||this.truthTN++}const e=this.truthTP,s=this.truthFP,i=this.truthTN,o=this.truthFN;let n=1/this.activity.length;this.precision=e/(e+s),this.recall=e/(e+o),this.specificity=i/(i+s),this.statF1=this.precision*this.recall*2/(this.precision+this.recall);let l=(e+i)*n,r=(e+s)*n*(e+o)*n+(s+i)*n*(o+i)*n;this.statKappa=(l-r)/(1-r);let a=e*i-s*o,h=(e+s)*(e+o)*(i+s)*(i+o);this.statMCC=a/Math.sqrt(h)}calibrateThresholds(t,e,s){const i=s.length;let o=0;for(let s=1;s<i;s++)e[s]-t[s]>e[o]-t[o]&&(o=s);const n=s[o];let l=0,r=i-1;for(;l<o-1&&!(t[l]>0);l++);for(;r>o+1&&!(e[r]<1);r--);let a=Math.min(s[l]-n,n-s[r]);this.lowThresh=n-a,this.highThresh=n+a,this.range=2*a,this.invRange=this.range>0?1/this.range:0}determineCoverage(t,e){const i=t.numAtoms;let o={};const n=0==this.folding?4294967295:this.folding-1;let l=ls.createStrictRubric(t),r=new ds(l,this.classType),a=t=>{let e=t.hashCode&n;if(null==this.contribs[e])return;let l=o[e];null==l&&(l=s.booleanArray(!1,i),o[e]=l);for(let e of t.atoms)l[e-1]=!0};if(r.hookApplyNewFP=a,r.hookConsiderNewFP=a,r.calculate(),null!=e){let t=0==this.folding?r.getUniqueHashes():r.getFoldedHashes(this.folding);for(let s of t)e.add(s)}return o}}class ps{constructor(t,e=null){this.mol=t,this.pri=e}generate(){return 0==this.mol.numAtoms?"":(this.walkSequence(),this.findLinks(),this.assemble())}walkSequence(){const t=this.mol,e=t.numAtoms,i=this.pri;this.seq=[];let o=s.booleanArray(!1,e),n=1;null!=i&&(n=s.idxMin(i)+1);for(let s=0;s<e&&(this.seq.push(n),o[n-1]=!0,s!=e-1);s++){let s=t.atomAdjList(n),l=t.atomConnComp(n);n=0;for(let t=0;t<s.length;t++)if(!o[s[t]-1]){if(null==i){n=s[t];break}(0==n||i[s[t]-1]<i[n-1])&&(n=s[t])}if(!(n>0)){for(let s=1;s<=e;s++)if(!o[s-1]&&t.atomConnComp(s)==l){if(null==i){n=s;break}(0==n||i[s-1]<i[n-1])&&(n=s)}if(!(n>0)){for(let t=1;t<=e;t++)if(!o[t-1]){if(null==i){n=t;break}(0==n||i[t-1]<i[n-1])&&(n=t)}if(0==n)throw"Walk sequence failed."}}}}findLinks(){const t=this.mol,e=t.numAtoms,i=this.pri,o=this.seq;this.link=[],this.conn=[];for(let t=0;t<e;t++)this.link.push([]),this.conn.push([]);let n=s.numberArray(0,e);for(let t=0;t<e;t++)n[o[t]-1]=t;let l=s.numberArray(-1,e+1);for(let r=0;r<e;r++){let a=r>0?o[r-1]:0,h=o[r],u=r<e-1?o[r+1]:0;for(let t=1;t<=e;t++)l[t]>=0&&r>l[t]&&(l[t]=-1);let m=t.atomAdjList(h);if(null!=i)for(let t=0;t<m.length-1;)n[m[t]-1]>n[m[t+1]-1]?(s.swap(m,t,t+1),t>0&&t--):t++;for(let t=0;t<m.length;t++){if(m[t]==a||m[t]==u)continue;let s=m[t];if(n[h-1]>n[s-1])continue;let i=-1;for(let t=1;t<=e;t++)if(l[t]<0){i=t,l[t]=Math.max(n[h-1],n[s-1]);break}this.link[h-1].push(i),this.conn[h-1].push(s),this.link[s-1].push(i),this.conn[s-1].push(h)}}}assemble(){const t=this.mol,e=t.numAtoms,s=this.seq,i=this.link,o=this.conn;let n="";const l=["C","N","O","P","S"];for(let r=0;r<e;r++){let e=r>0?s[r-1]:0,a=s[r],h=e>0?t.findBond(e,a):0;if(e>0&&0==h&&(n+="."),h>0){let e=t.bondOrder(h);2==e?n+="=":3==e&&(n+="#")}let u=t.atomElement(a);qt.ELEMENTS.indexOf(u)<0&&(u="*");let m=t.atomCharge(a);l.indexOf(u)>=0&&0==m?n+=u:(n+="["+u,m>0&&(n+="+"+m),m<0&&(n+=m),n+="]");let d=i[a-1];if(null!=d)for(let e=0;e<d.length;e++){h=t.findBond(a,o[a-1][e]);let s=t.bondOrder(h);2==s?n+="=":3==s&&(n+="#"),d[e]<10?n+=d[e]:n+="%"+d[e]}}return n}}class fs{constructor(t,e,s=[]){this.mol=t,this.resBonds=e,this.atomHyd=s,this.maxIter=1e3,this.bondOrders=[],this.tolerant=!1,this.mol=t,this.resBonds=e,this.atomHyd=s;for(let e=1;e<=t.numBonds;e++)this.bondOrders.push(t.bondOrder(e))}perform(){const{mol:t}=this;if(null==this.atomHyd){this.atomHyd=[];for(let e=1;e<=t.numAtoms;e++)this.atomHyd.push(t.atomHExplicit(e))}this.correctInputMask();let e=new Bt(t.numAtoms);for(let s=1;s<=t.numBonds;s++)this.resBonds[s-1]&&e.addEdge(t.bondFrom(s)-1,t.bondTo(s)-1);let s=e.calculateComponentGroups();for(let t=0;t<s.length;t++)s[t].length>=2&&this.processComponent(s[t])}correctInputMask(){const{mol:t,atomHyd:e}=this,i=t.numAtoms,o=t.numBonds;let n=s.booleanArray(!1,i);for(let s=1;s<=i;s++){let i=t.atomicNumber(s),o=i==qt.ELEMENT_C?4:i==qt.ELEMENT_N||i==qt.ELEMENT_P||i==qt.ELEMENT_B?3:i==qt.ELEMENT_O||i==qt.ELEMENT_S?2:-1;o<0?n[s-1]=!0:(o+=t.atomCharge(s),e[s-1]>0&&(o-=e[s-1]),t.atomAdjCount(s)>=o&&(n[s-1]=!0))}for(let e=1;e<=o;e++)this.resBonds[e-1]||1==t.bondOrder(e)||(n[t.bondFrom(e)-1]=!0,n[t.bondTo(e)-1]=!0);this.resBonds=this.resBonds.slice(0);for(let e=0;e<o;e++)this.resBonds[e]&&(n[t.bondFrom(e+1)-1]||n[t.bondTo(e+1)-1])&&(this.bondOrders[e]=1,this.resBonds[e]=!1)}processComponent(t){const{mol:e,resBonds:i,bondOrders:o,atomHyd:n}=this;let l=t.length;if(2==l)return void(o[e.findBond(t[0]+1,t[1]+1)-1]=2);let r=s.booleanArray(!1,l);for(let s=0;s<l;s++){let i=t[s],o=i+1;r[s]=n[i]==ne.HEXPLICIT_UNKNOWN&&"N"==e.atomElement(o)&&e.atomAdjCount(o)-e.atomCharge(o)<=2}let a=new Bt(l),h=a.calculateGravity(),u=s.idxMask(t,e.numAtoms),m=0;for(let t=1;t<=e.numBonds;t++)i[t-1]&&u[e.bondFrom(t)-1]&&u[e.bondTo(t)-1]&&m++;let d=s.numberArray(0,m),c=s.numberArray(0,m),p=s.numberArray(0,m),f=s.numberArray(0,m);m=0;for(let s=1;s<=e.numBonds;s++)if(i[s-1]&&u[e.bondFrom(s)-1]&&u[e.bondTo(s)-1]){let i=t.indexOf(e.bondFrom(s)-1),o=t.indexOf(e.bondTo(s)-1);d[m]=i,c[m]=o,p[m]=h[i]+h[o],f[m]=s,a.addEdge(i,o),m++}let g=s.numberArray(0,m);g[0]=s.idxMax(p);let b=s.booleanArray(!1,m);b[g[0]]=!0;for(let t=1;t<m;t++){let e=-1;for(let s=t-1;s>=0;s--){for(let t=0;t<m;t++)b[t]||d[t]!=d[g[s]]&&d[t]!=c[g[s]]&&c[t]!=d[g[s]]&&c[t]!=c[g[s]]||(e<0||p[t]>p[e])&&(e=t);if(e>=0)break}if(e<0)throw"Graph walk failed";g[t]=e,b[e]=!0}let A=[];A.push([!0]),A.push([!1]);let y=null,E=0,M=Math.ceil(.5*m),T=0;for(;A.length>0;){let t=A[0],e=s.append(t,!1),i=s.append(t,!0);if(this.validPath(e,g,d,c,a,r)||(e=null),this.validPath(i,g,d,c,a,r)||(i=null),s.len(e)==m){let t=s.maskCount(e);t>E&&(y=e,E=t),e=null}if(s.len(i)==m){let t=s.maskCount(i);t>E&&(y=i,E=t),i=null}if(E>=M)break;if(null==e&&null==i?A.shift():null!=e&&null!=i?(A[0]=e,A.splice(1,0,i)):A[0]=null!=e?e:i,T++,T>this.maxIter){if(null!=y)break;if(this.tolerant)return;throw"Resonance localisation exceeded maximum iteration count"}}if(null==y){if(this.tolerant)return;throw"Unable to find a solution to the resonance block."}for(let t=0;t<m;t++)o[f[g[t]]-1]=y[t]?2:1}validPath(t,e,i,o,n,l){let r=n.numNodes,a=s.numberArray(0,r),h=s.numberArray(0,r);for(let s=0;s<t.length;s++){let n=i[e[s]],l=o[e[s]];t[s]?(h[n]++,h[l]++):(a[n]++,a[l]++)}for(let t=0;t<r;t++){if(h[t]>1)return!1;if(!l[t]&&n.numEdges(t)>1&&a[t]==n.numEdges(t))return!1}return!0}}class gs{}function bs(t){gs.RESOURCE_URL=t;try{document}catch(t){return}document&&Es("main",function(){let t=w(gs.lowlight);return`\n\t\t.wmk-button\n\t\t{\n\t\t\tdisplay: inline-block;\n\t\t\tpadding: 6px 12px;\n\t\t\tmargin-bottom: 0;\n\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\tfont-size: 14px;\n\t\t\tfont-weight: normal;\n\t\t\tline-height: 1.42857143;\n\t\t\ttext-align: center;\n\t\t\twhite-space: nowrap;\n\t\t\tvertical-align: middle;\n\t\t\tcursor: pointer;\n\t\t\tbackground-image: none;\n\t\t\tborder: 1px solid transparent;\n\t\t\tborder-radius: 4px;\n\t\t\t-ms-touch-action: manipulation; touch-action: manipulation;\n\t\t\t-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;\n\t\t}\n\t\t.wmk-button:focus,\n\t\t.wmk-button:active:focus,\n\t\t.wmk-button.active:focus,\n\t\t.wmk-button.focus,\n\t\t.wmk-button:active.focus,\n\t\t.wmk-button.active.focus\n\t\t{\n\t\t\toutline: thin dotted;\n\t\t\toutline: 5px auto -webkit-focus-ring-color;\n\t\t\toutline-offset: -2px;\n\t\t}\n\t\t.wmk-button:hover,\n\t\t.wmk-button:focus,\n\t\t.wmk-button.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\ttext-decoration: none;\n\t\t}\n\t\t.wmk-button:active,\n\t\t.wmk-button.active\n\t\t{\n\t\t\tbackground-image: none;\n\t\t\toutline: 0;\n\t\t\t-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);\n\t\t\tbox-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);\n\t\t}\n\t\t.wmk-button.disabled,\n\t\t.wmk-button[disabled],\n\t\tfieldset[disabled] .wmk-button\n\t\t{\n\t\t\tcursor: not-allowed;\n\t\t\tfilter: alpha(opacity=65);\n\t\t\t-webkit-box-shadow: none;\n\t\t\tbox-shadow: none;\n\t\t\topacity: .65;\n\t\t}\n\t\ta.wmk-button.disabled,\n\t\tfieldset[disabled] a.wmk-button\n\t\t{\n\t\t\tpointer-events: none;\n\t\t}\n\n\t\t/* shrunken button */\n\n\t\t.wmk-button-small\n\t\t{\n\t\t\tpadding: 2px 4px;\n\t\t\tline-height: 1;\n\t\t\tfont-size: 12px;\n\t\t}\n\n\t\t/* default button */\n\n\t\t.wmk-button-default\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #fff;\n\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\tborder-color: #ccc;\n\t\t}\n\t\t.wmk-button-default:focus,\n\t\t.wmk-button-default.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #8c8c8c;\n\t\t}\n\t\t.wmk-button-default:hover\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #adadad;\n\t\t}\n\t\t.wmk-button-default:active,\n\t\t.wmk-button-default.active,\n\t\t.open > .dropdown-toggle.wmk-button-default\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #adadad;\n\t\t}\n\t\t.wmk-button-default:active:hover,\n\t\t.wmk-button-default.active:hover,\n\t\t.open > .dropdown-toggle.wmk-button-default:hover,\n\t\t.wmk-button-default:active:focus,\n\t\t.wmk-button-default.active:focus,\n\t\t.open > .dropdown-toggle.wmk-button-default:focus,\n\t\t.wmk-button-default:active.focus,\n\t\t.wmk-button-default.active.focus,\n\t\t.open > .dropdown-toggle.wmk-button-default.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #d4d4d4;\n\t\t\tborder-color: #8c8c8c;\n\t\t}\n\t\t.wmk-button-default:active,\n\t\t.wmk-button-default.active,\n\t\t.open > .dropdown-toggle.wmk-button-default\n\t\t{\n\t\t\tbackground-image: none;\n\t\t}\n\t\t.wmk-button-default.disabled:hover,\n\t\t.wmk-button-default[disabled]:hover,\n\t\tfieldset[disabled] .wmk-button-default:hover,\n\t\t.wmk-button-default.disabled:focus,\n\t\t.wmk-button-default[disabled]:focus,\n\t\tfieldset[disabled] .wmk-button-default:focus,\n\t\t.wmk-button-default.disabled.focus,\n\t\t.wmk-button-default[disabled].focus,\n\t\tfieldset[disabled] .wmk-button-default.focus\n\t\t{\n\t\t\tbackground-color: #fff;\n\t\t\tborder-color: #ccc;\n\t\t}\n\t\t.wmk-button-default .badge\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #333;\n\t\t}\n\n\t\t/* primary button */\n\n\t\t.wmk-button-primary\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #008FD2;\n\t\t\tbackground-image: linear-gradient(to right bottom, ${w(gs.lowlightEdge1)}, ${w(gs.lowlightEdge2)});\n\t\t\tborder-color: #00C0C0;\n\t\t}\n\t\t.wmk-button-primary:focus,\n\t\t.wmk-button-primary.focus\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: ${t};\n\t\t\tborder-color: #122b40;\n\t\t}\n\t\t.wmk-button-primary:hover\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #286090;\n\t\t\tborder-color: #204d74;\n\t\t}\n\t\t.wmk-button-primary:active,\n\t\t.wmk-button-primary.active,\n\t\t.open > .dropdown-toggle.wmk-button-primary\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #286090;\n\t\t\tborder-color: #20744d;\n\t\t}\n\t\t.wmk-button-primary:active:hover,\n\t\t.wmk-button-primary.active:hover,\n\t\t.open > .dropdown-toggle.wmk-button-primary:hover,\n\t\t.wmk-button-primary:active:focus,\n\t\t.wmk-button-primary.active:focus,\n\t\t.open > .dropdown-toggle.wmk-button-primary:focus,\n\t\t.wmk-button-primary:active.focus,\n\t\t.wmk-button-primary.active.focus,\n\t\t.open > .dropdown-toggle.wmk-button-primary.focus\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: ${w(gs.highlight)};\n\t\t\tbackground-image: linear-gradient(to right bottom, ${w(gs.highlightEdge1)}, ${w(gs.highlightEdge2)});\n\t\t\tborder-color: #12802b;\n\t\t}\n\t\t.wmk-button-primary:active,\n\t\t.wmk-button-primary.active,\n\t\t.open > .dropdown-toggle.wmk-button-primary\n\t\t{\n\t\t\tbackground-image: none;\n\t\t}\n\t\t.wmk-button-primary.disabled:hover,\n\t\t.wmk-button-primary[disabled]:hover,\n\t\tfieldset[disabled] .wmk-button-primary:hover,\n\t\t.wmk-button-primary.disabled:focus,\n\t\t.wmk-button-primary[disabled]:focus,\n\t\tfieldset[disabled] .wmk-button-primary:focus,\n\t\t.wmk-button-primary.disabled.focus,\n\t\t.wmk-button-primary[disabled].focus,\n\t\tfieldset[disabled] .wmk-button-primary.focus\n\t\t{\n\t\t\tbackground-color: #337ab7;\n\t\t\tborder-color: #2ea46d;\n\t\t}\n\t\t.wmk-button-primary .badge\n\t\t{\n\t\t\tcolor: #337ab7;\n\t\t\tbackground-color: #fff;\n\t\t}\n\t`}())}gs.BASE_URL=null,gs.RESOURCE_URL=null,gs.foreground=0,gs.background=16777215,gs.lowlight=2412752,gs.lowlightEdge1=4707794,gs.lowlightEdge2=36817,gs.highlight=65280,gs.highlightEdge1=51801,gs.highlightEdge2=34384,gs.error=16711680;let As=new Set;function ys(t){return As.has(t)}function Es(t,e){if(As.has(t))return!1;let s=document.createElement("style");return s.innerHTML=e,document.head.appendChild(s),As.add(t),!0}class Ms{static readXML(t){let e;if(e=g.customParser?(new g.customParser).parseFromString(t,"application/xml"):(new DOMParser).parseFromString(t,"application/xml"),null==e)return null;let s=e.documentElement;if(null==s)return null;let i=new re,o=at(s,"Summary");if(null==o)return null;i.title=L(at(o,"Title")),i.description=L(at(o,"Description"));let n=at(s,"Extension");if(null!=n){let t=ht(n,"Ext");for(let e=0;e<t.length;e++){let s=t[e];i.appendExtension(s.getAttribute("name"),s.getAttribute("type"),L(s))}}let l=at(s,"Header"),r=parseInt(l.getAttribute("ncols")),a=ht(l,"Column");if(a.length!=r)return null;for(let t=0;t<r;t++){let e=a[t];if(parseInt(e.getAttribute("id"))!=t+1)return null;i.appendColumn(e.getAttribute("name"),e.getAttribute("type"),L(e))}let h=0;for(let t of ht(at(s,"Content"),"Row")){if(parseInt(t.getAttribute("id"))!=h+1)return null;i.appendRow();for(let e of ht(t,"Cell")){let t=parseInt(e.getAttribute("id"))-1,s=i.colType(t),o=L(e);""==o||("molecule"==s?i.setObject(h,t,o):"string"==s?i.setString(h,t,o):"real"==s?i.setReal(h,t,parseFloat(o)):"integer"==s?i.setInteger(h,t,parseInt(o)):"boolean"==s?i.setBoolean(h,t,"true"==o||"false"!=o&&null):"extend"==s&&i.setExtend(h,t,o)),e=e.nextElementSibling,t++}t=t.nextElementSibling,h++}return i}static readJSON(t){if(!t.colData||!t.rowData)throw"Not a JSON-formatted datasheet.";return new re(gt(t))}static writeXML(t){let e;e=g.customParser?(new g.customParser).parseFromString("<DataSheet/>","application/xml"):(new DOMParser).parseFromString("<DataSheet/>","application/xml");let s=e.createElement("Summary");e.documentElement.appendChild(s);let i=e.createElement("Title"),o=e.createElement("Description");s.appendChild(i),i.appendChild(e.createTextNode(t.title)),s.appendChild(o),o.appendChild(e.createCDATASection(t.description));let n=e.createElement("Extension");e.documentElement.appendChild(n);for(let s=0;s<t.numExtensions;s++){let i=e.createElement("Ext");n.appendChild(i),i.setAttribute("name",t.getExtName(s)),i.setAttribute("type",t.getExtType(s)),i.appendChild(e.createCDATASection(t.getExtData(s)))}let l=e.createElement("Header");e.documentElement.appendChild(l),l.setAttribute("nrows",t.numRows.toString()),l.setAttribute("ncols",t.numCols.toString());for(let s=0;s<t.numCols;s++){let i=e.createElement("Column");l.appendChild(i),i.setAttribute("id",(s+1).toString()),i.setAttribute("name",t.colName(s)),i.setAttribute("type",t.colType(s)),i.appendChild(e.createTextNode(t.colDescr(s)))}let r=e.createElement("Content");e.documentElement.appendChild(r);for(let s=0;s<t.numRows;s++){let i=e.createElement("Row");i.setAttribute("id",(s+1).toString()),r.appendChild(i);for(let o=0;o<t.numCols;o++){let n=e.createElement("Cell");n.setAttribute("id",(o+1).toString()),i.appendChild(n);let l=t.colType(o),r=null;if(t.isNull(s,o));else if("molecule"==l){let i=t.getObject(s,o);i instanceof ne&&(i=se.writeNative(i)),r=e.createCDATASection(i)}else"string"==l?r=e.createCDATASection(t.getString(s,o)):"real"==l?r=e.createTextNode(t.getReal(s,o).toString()):"integer"==l?r=e.createTextNode(t.getInteger(s,o).toString()):"boolean"==l?r=e.createTextNode(t.getBoolean(s,o).toString()):"extend"==l&&(r=e.createCDATASection(t.getExtend(s,o)));null!=r&&n.appendChild(r)}}return g.customSerial?(new g.customSerial).serializeToString(e.documentElement):(new XMLSerializer).serializeToString(e.documentElement)}static writeJSON(t){let e=t.data,s=t.numRows,i=t.numCols,o=new Array(s);for(let t=0;t<s;t++)o[t]=new Array(i);for(let n=0;n<i;n++){let i="molecule"==t.colType(n);for(let t=0;t<s;t++){let s=e.rowData[t][n];null!=s&&i&&(s=s.toString()),o[t][n]=s}}return{title:e.title,description:e.description,colData:gt(e.colData),rowData:o,extData:gt(e.extData)}}}const Ts=["rings","termgrp","funcgrp","protgrp","nonplrings","largerings","crownethers","ligmonodent","ligbident","ligtrident","ligmultident","cagecmplx","aminoacids","biomolecules","saccharides"];class xs{constructor(){this.abbrevs=[]}static needsSetup(){return!this.main}static setupData(){return t=this,e=void 0,i=function*(){if(!this.main){if(!gs.RESOURCE_URL)throw"RPC resource URL not defined.";this.main=new xs;for(let t of Ts){let e=gs.RESOURCE_URL+"/data/templates/"+t+".ds",s=yield Ct(e),i=Ms.readXML(s),o=i.firstColOfType("molecule"),n=i.findColByName("Abbrev","string");if(!(o<0||n<0))for(let t=0;t<i.numRows;t++){let e=i.getMoleculeClone(t,o),s=i.getString(t,n);if(!e||!s)continue;let l=0,r=0;for(let t=1;t<=e.numAtoms;t++)e.atomElement(t)==Ht.TEMPLATE_ATTACHMENT&&(0==r&&(r=t),e.setAtomElement(t,Ht.ABBREV_ATTACHMENT),l++);1==l&&(r>1&&e.swapAtoms(1,r),this.main.submitAbbreviation(s,e))}}}},new((s=void 0)||(s=Promise))((function(o,n){function l(t){try{a(i.next(t))}catch(t){n(t)}}function r(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,r)}a((i=i.apply(t,e||[])).next())}));var t,e,s,i}getAbbrevs(){return this.abbrevs.slice(0)}submitAbbreviation(t,e,s=!1){let i=e.clone();this.submitFragment(t,i,s)}submitMolecule(t,e=!1){let s=t.clone();for(let t=1;t<=s.numAtoms;t++){let i=Ht.getAbbrev(s,t);i&&this.submitFragment(s.atomElement(t),i,e)}}substituteAbbrevName(t,e){let s=Ht.getAbbrev(t,e);if(!s)return!1;for(let i of this.abbrevs)if(i.frag.numAtoms==s.numAtoms&&jt.sketchEquivalent(s,i.frag))return t.setAtomElement(e,i.name),!0;return!1}submitFragment(t,e,s){if("?"==t)return;let i=0,o=0,n=e.atomAdjList(1);for(let t of n)i+=e.atomX(t)-e.atomX(1),o+=e.atomY(t)-e.atomY(1);if(n.length>1){let t=1/n.length;i*=t,o*=t}if(U(i,o)>.1*.1){let t=Math.atan2(o,i);Math.abs(t)>2*J&&jt.rotateMolecule(e,-t)}let l=-1;for(let e=0;e<this.abbrevs.length;e++)if(this.abbrevs[e].name==t){l=e;break}let[r,a]=this.formatAbbrevLabel(t),h={name:t,frag:e,nameHTML:r,nameSearch:a};l<0?s?this.abbrevs.unshift(h):this.abbrevs.push(h):s&&l>0?(this.abbrevs.splice(l,1),this.abbrevs.unshift(h)):this.abbrevs[l]=h}formatAbbrevLabel(t){let e="",s="",i=(t,i)=>{i&&(e+="<"+i+">"),e+=bt(t),s+=t,i&&(e+="</"+i+">")};for(let e of t.split("|")){for(;;){let t=e.match(/^(.*?)\{(.*?)\}(.*)$/);if(!t)break;let s=t[1],o=t[2],n=t[3];i(s,null),o.startsWith("^")?i(o.substring(1),"sup"):i(o,"sub"),e=n}i(e,null)}return[e,s.toLowerCase()]}}xs.main=null;class vs{}vs.FMT_NATIVE="native",vs.FMT_XMLDS="xmlds",vs.FMT_MDLMOL="mdlmol",vs.FMT_MDLSDF="mdlsdf",vs.FMT_MDLRDF="mdlrdf",vs.FMT_MDLRXN="mdlrxn",vs.GFX_PNG="png",vs.GFX_PNGZIP="pngzip",vs.GFX_SVG="svg",vs.GFX_SVGZIP="svgzip",vs.GFX_PDF="pdf",vs.GFX_PDFZIP="pdfzip",vs.GFX_EPS="eps",vs.GFX_HTML="html",vs.GFX_OPENDOC_ODG="odg",vs.GFX_OPENDOC_ODT="odt",vs.GFX_OPENDOC_ODS="ods",vs.GFX_OOXML_DOCX="docx",vs.GFX_OOXML_XLSX="xlsx",vs.FORMAT_DESCR={native:"SketchEl Molecule",xmlds:"DataSheet XML",mdlmol:"MDL MOL (single molecule)",mdlsdf:"MDL SDF (molecules + data)",mdlrdf:"MDL RDF (reactions + data)",mdlrxn:"MDL RXN (single reaction)",png:"PNG image (raster)",pngzip:"ZIP (multiple PNG files)",svg:"SVG picture (vector)",svgzip:"ZIP (multiple SVG files)",pdf:"PDF diagram (vector)",pdfzip:"ZIP (multiple PDF files)",eps:"Encapsulated PostScript (vector)",html:"HTML with embedded SVG",odg:"OpenDocument Graphic",odt:"OpenDocument Text",ods:"OpenDocument SpreadSheet",docx:"Microsoft Word",xlsx:"Microsoft Excel"},vs.FORMAT_EXTN={native:".el",xmlds:".ds",mdlmol:".mol",mdlsdf:".sdf",mdlrdf:".rdf",mdlrxn:".rxn",png:".png",pngzip:"_png.zip",svg:".svg",svgzip:"_svg.zip",pdf:".pdf",pdfzip:"_pdf.zip",eps:".eps",html:".html",odg:".odg",odt:".odt",ods:".ods",docx:".docx",xlsx:".xlsx"},vs.FORMAT_MIMETYPE={native:"chemical/x-sketchel",xmlds:"chemical/x-datasheet",mdlmol:"chemical/x-mdl-molfile",mdlsdf:"chemical/x-mdl-sdfile",mdlrdf:"chemical/x-mdl-rdfile",mdlrxn:"chemical/x-mdl-rxnfile",png:"image/png",pngzip:"application/zip",svg:"image/png",svgzip:"application/zip",pdf:"application/pdf",pdfzip:"application/zip",eps:"image/eps",html:"text/html",odg:"application/vnd.oasis.opendocument.graphics",odt:"application/vnd.oasis.opendocument.text",ods:"application/vnd.oasis.opendocument.spreadsheet",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};var Cs=function(t,e,s,i){return new(s||(s=Promise))((function(o,n){function l(t){try{a(i.next(t))}catch(t){n(t)}}function r(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,r)}a((i=i.apply(t,e||[])).next())}))};let Ns=null;const Ss=["units"];class ws{constructor(){this.roots=[],this.mapTerms=new Map,this.alreadyLoaded=new Set}static get main(){return Ns}static init(){return Cs(this,void 0,void 0,(function*(){if(!Ns){Ns=new ws;for(let t of Ss){let e=gs.RESOURCE_URL+"/data/ontology/"+t+".onto";Ns.loadFromURL(e)}}}))}getRoots(){return this.roots}hasTerm(t){return this.mapTerms.has(t)}getBranch(t){return this.mapTerms.get(t)}getBranchList(t){if("string"==typeof t){let e=this.mapTerms.get(t);if(!e)throw`Unknown branch URI: ${t}`;if(e.length>1)throw`Ambiguous branch URI occurs more than once: ${t}`;t=e[0]}let e=[],i=t=>{e.push(t);for(let e of s.safeArray(t.children))i(e)};return i(t),e}loadFromURL(t){return Cs(this,void 0,void 0,(function*(){if(this.alreadyLoaded.has(t))return;this.alreadyLoaded.add(t);let e=yield Ct(t);if(!e)throw`Resource not found: ${t}`;this.loadContent(e)}))}loadContent(t){let e=[],s=0;for(let i of t.split(/\n/)){if(s++,i=i.trim(),!i||i.startsWith("#"))continue;let t=i.indexOf("http");if(t<0)throw`Line ${s} invalid, no URI term: ${i}`;let o=0;for(let e=0;e<t;e++)"-"==i.charAt(e)&&o++;let n=i.substring(t);if(t=n.indexOf(" "),t<0)throw`Line ${s} invalid, no label: ${i}`;let l=n.substring(t+1);n=n.substring(0,t);let r=null;if(0==o&&(r=this.roots.find((t=>t.uri==n))),!r){if(r={uri:n,label:l,parent:null,children:[],depth:o},0==o)this.roots.push(r);else{for(let t=e.length-1;t>=0;t--)if(e[t].depth==o-1){r.parent=e[t],e[t].children.push(r);break}if(!r.parent)throw`Line ${s} invalid hierarchy, no parent found`}let t=this.mapTerms.get(n);t?t.push(r):this.mapTerms.set(n,[r])}e.push(r)}}debugString(t){let e=[],s=t=>{e.push("* ".repeat(t.depth)+`<${t.uri}> "${t.label}"`);for(let e of t.children)s(e)};return s(t),e.join("\n")}}var Os,qs;!function(t){t.Charges="qC:",t.Aromatic="qA:",t.Elements="qE:",t.ElementsNot="qE!",t.RingSizes="qR:",t.RingSizesNot="qR!",t.RingBlock="qB:",t.NumRings="qN:",t.Adjacency="qJ:",t.BondSums="qO:",t.Valences="qV:",t.Hydrogens="qH:",t.Isotopes="qI:",t.SubFrags="qX:",t.SubFragsNot="qX!"}(Os||(Os={})),function(t){t.RingSizes="qR:",t.RingSizesNot="qR!",t.RingBlock="qB:",t.NumRings="qN:",t.Orders="qO:"}(qs||(qs={}));class Bs{static hasAnyQueryAtom(t,e){let s=t.atomExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith("q"))return!0;return!1}static hasAnyQueryBond(t,e){let s=t.bondExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith("q"))return!0;return!1}static hasQueryAtom(t,e,s){let i=t.atomExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith(s))return!0;return!1}static hasQueryBond(t,e,s){let i=t.bondExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith(s))return!0;return!1}static deleteQueryAtom(t,e,s){let i=t.atomExtra(e),o=!1;for(let t=i.length-1;t>=0;t--)i[t].startsWith(s)&&(i.splice(t,1),o=!0);o&&t.setAtomExtra(e,i)}static deleteQueryBond(t,e,s){let i=t.bondExtra(e),o=!1;for(let t=i.length-1;t>=0;t--)i[t].startsWith(s)&&(i.splice(t,1),o=!0);o&&t.setBondExtra(e,i)}static deleteQueryAtomAll(t,e){t.setAtomExtra(e,t.atomExtra(e).filter((t=>!t.startsWith("q"))))}static deleteQueryBondAll(t,e){t.setBondExtra(e,t.bondExtra(e).filter((t=>!t.startsWith("q"))))}static queryAtomString(t,e,s){let i=t.atomExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith(s))return i[t].substring(s.length);return null}static queryAtomStringList(t,e,i){let o=t.atomExtra(e),n=null;if(null!=o)for(let t of o)t.startsWith(i)&&(n=s.append(n,t.substring(i.length)));return n}static queryBondString(t,e,s){let i=t.bondExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith(s))return i[t].substring(s.length);return null}static setQueryAtom(t,e,s,i){if(!i)return void this.deleteQueryAtom(t,e,s);let o=s+i,n=t.atomExtra(e);for(let t=n.length-1;t>=0;t--)n[t].startsWith(s)&&(null!=o?(n[t]=o,o=null):n.splice(t,1));null!=o&&n.push(o),t.setAtomExtra(e,n)}static setQueryAtomList(t,e,i,o){if(s.isBlank(o))return void this.deleteQueryAtom(t,e,i);let n=t.atomExtra(e);for(let t=n.length-1;t>=0;t--)n[t].startsWith(i)&&n.splice(t,1);for(let t of o)n.push(i+t);t.setAtomExtra(e,n)}static setQueryBond(t,e,s,i){if(!i)return void this.deleteQueryBond(t,e,s);let o=s+i,n=t.bondExtra(e);for(let t=n.length-1;t>=0;t--)n[t].startsWith(s)&&(null!=o?(n[t]=o,o=null):n.splice(t,1));null!=o&&n.push(o),t.setBondExtra(e,n)}static queryAtomCharges(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.Charges))}static queryAtomAromatic(t,e){return this.parseBoolean(this.queryAtomString(t,e,Os.Aromatic))}static queryAtomElements(t,e){return this.parseStrings(this.queryAtomString(t,e,Os.Elements))}static queryAtomElementsNot(t,e){return this.parseStrings(this.queryAtomString(t,e,Os.ElementsNot))}static queryAtomRingSizes(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.RingSizes))}static queryAtomRingSizesNot(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.RingSizesNot))}static queryAtomRingBlock(t,e){return this.parseBoolean(this.queryAtomString(t,e,Os.RingBlock))}static queryAtomNumRings(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.NumRings))}static queryAtomAdjacency(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.Adjacency))}static queryAtomBondSums(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.BondSums))}static queryAtomValences(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.Valences))}static queryAtomHydrogens(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.Hydrogens))}static queryAtomIsotope(t,e){return this.parseIntegers(this.queryAtomString(t,e,Os.Isotopes))}static queryAtomSubFrags(t,e){return this.parseMolecules(this.queryAtomStringList(t,e,Os.SubFrags))}static queryAtomSubFragsNot(t,e){return this.parseMolecules(this.queryAtomStringList(t,e,Os.SubFragsNot))}static queryBondRingSizes(t,e){return this.parseIntegers(this.queryBondString(t,e,qs.RingSizes))}static queryBondRingSizesNot(t,e){return this.parseIntegers(this.queryBondString(t,e,qs.RingSizesNot))}static queryBondRingBlock(t,e){return this.parseBoolean(this.queryBondString(t,e,qs.RingBlock))}static queryBondNumRings(t,e){return this.parseIntegers(this.queryBondString(t,e,qs.NumRings))}static queryBondOrders(t,e){return this.parseIntegers(this.queryBondString(t,e,qs.Orders))}static setQueryAtomCharges(t,e,s){this.setQueryAtom(t,e,Os.Charges,this.formatIntegers(s))}static setQueryAtomAromatic(t,e,s){this.setQueryAtom(t,e,Os.Aromatic,this.formatBoolean(s))}static setQueryAtomElements(t,e,s){this.setQueryAtom(t,e,Os.Elements,this.formatStrings(s))}static setQueryAtomElementsNot(t,e,s){this.setQueryAtom(t,e,Os.ElementsNot,this.formatStrings(s))}static setQueryAtomRingSizes(t,e,s){this.setQueryAtom(t,e,Os.RingSizes,this.formatIntegers(s))}static setQueryAtomRingSizesNot(t,e,s){this.setQueryAtom(t,e,Os.RingSizesNot,this.formatIntegers(s))}static setQueryAtomRingBlock(t,e,s){this.setQueryAtom(t,e,Os.RingBlock,this.formatBoolean(s))}static setQueryAtomNumRings(t,e,s){this.setQueryAtom(t,e,Os.NumRings,this.formatIntegers(s))}static setQueryAtomAdjacency(t,e,s){this.setQueryAtom(t,e,Os.Adjacency,this.formatIntegers(s))}static setQueryAtomBondSums(t,e,s){this.setQueryAtom(t,e,Os.BondSums,this.formatIntegers(s))}static setQueryAtomValences(t,e,s){this.setQueryAtom(t,e,Os.Valences,this.formatIntegers(s))}static setQueryAtomHydrogens(t,e,s){this.setQueryAtom(t,e,Os.Hydrogens,this.formatIntegers(s))}static setQueryAtomIsotope(t,e,s){this.setQueryAtom(t,e,Os.Isotopes,this.formatIntegers(s))}static setQueryAtomSubFrags(t,e,s){this.setQueryAtomList(t,e,Os.SubFrags,this.formatMolecules(s))}static setQueryAtomSubFragsNot(t,e,s){this.setQueryAtomList(t,e,Os.SubFragsNot,this.formatMolecules(s))}static setQueryBondRingSizes(t,e,s){this.setQueryBond(t,e,qs.RingSizes,this.formatIntegers(s))}static setQueryBondRingSizesNot(t,e,s){this.setQueryBond(t,e,qs.RingSizesNot,this.formatIntegers(s))}static setQueryBondRingBlock(t,e,s){this.setQueryBond(t,e,qs.RingBlock,this.formatBoolean(s))}static setQueryBondNumRings(t,e,s){this.setQueryBond(t,e,qs.NumRings,this.formatIntegers(s))}static setQueryBondOrders(t,e,s){this.setQueryBond(t,e,qs.Orders,this.formatIntegers(s))}static parseIntegers(t){if(!t)return null;let e=t.split(","),s=new Array(e.length);for(let t=0;t<e.length;t++)s[t]=parseInt(e[t]);return s}static parseStrings(t){return t?t.split(","):null}static parseBoolean(t){return t?"yes"==t:null}static parseMolecules(t){if(!t)return null;let e=[];for(let s of t){let t=ne.fromString(s);Ht.notBlank(t)&&e.push(t)}return e}static formatIntegers(t){if(s.isBlank(t))return null;let e="";for(let s=0;s<t.length;s++)s>0&&(e+=","),e+=t[s];return e}static formatStrings(t){if(s.isBlank(t))return null;let e="";for(let s=0;s<t.length;s++)s>0&&(e+=","),e+=t[s];return e}static formatBoolean(t){return t?"yes":"no"}static formatMolecules(t){if(s.isBlank(t))return null;let e=[];for(let s of t)Ht.notBlank(s)&&e.push(s.toString());return e}}class ks{constructor(t=null){this.minPortionWidth=80,this.maxPortionWidth=80,this.maximumWidth=0,this.maximumHeight=0,this.minPortionHeight=20,this.maxPortionHeight=0,this.topMargin=50,this.title="Dialog",this.allowScroller=!0,this.callbackClose=null,this.callbackShown=null,this.parent=A(t),Es("dialog","\n    *.wmk-dialog\n    {\n        font-family: 'Open Sans', sans-serif;\n\t\tfont-size: 16px;\n\t\tcolor: black;\n\t\tuser-select: none;\n    }\n")}onClose(t){this.callbackClose=t}onShown(t){this.callbackShown=t}open(){let t=this.parent||b(document.body),e=this.domObscureBackground=b("<div/>").appendTo(t);e.css({position:"fixed","z-index":2e4}),e.css({left:"0",right:"0",top:"0",bottom:"0"}),e.css({"background-color":"black",opacity:.8}),e.onClick((()=>this.close()));let s=this.domObscureForeground=b("<div/>").appendTo(t);s.css({position:"fixed","z-index":20001}),s.css({left:"0",right:"0",top:"0",bottom:"0"});let i=this.domPanelBoundary=b('<div class="wmk-dialog"/>').appendTo(s);i.css({"min-width":this.minPortionWidth+"%"}),this.maximumWidth>0?i.css({"max-width":this.maximumWidth+"px"}):null!=this.maxPortionWidth&&i.css({"max-width":this.maxPortionWidth+"%"}),this.maximumHeight>0?i.css({"max-height":this.maximumHeight+"px"}):this.maxPortionHeight>0&&i.css({"max-height":this.maxPortionHeight+"vh"}),i.css({"background-color":"white","border-radius":"6px",border:"1px solid black"}),i.css({position:"absolute"}),i.css({left:50-.5*this.minPortionWidth+"%"}),i.css({top:this.topMargin+"px"}),i.css({"min-height":this.minPortionHeight+"%"});let o=b("<div/>").appendTo(i).css({display:"flex"});o.css({"flex-direction":"column","align-items":"stretch"}),this.maximumHeight>0?o.css({"max-height":this.maximumHeight+"px"}):this.maxPortionHeight>0&&o.css({"max-height":this.maxPortionHeight+"vh"});let n=this.domTitle=b("<div/>").appendTo(o);n.css({"flex-shrink":"0","flex-grow":"0"}),n.css({margin:"0",padding:"0"}),n.css({"background-color":"#F0F0F0"}),n.css({"background-image":"linear-gradient(to right bottom, #FFFFFF, #E0E0E0)"}),n.css({"border-bottom":"1px solid #C0C0C0"}),n.css({"border-radius":"6px 6px 0 0"});let l=b("<div/>").appendTo(o).css({width:"100%"});l.css({"flex-shrink":"1","flex-grow":"0"}),this.allowScroller&&l.css({"overflow-y":"auto"}),this.domBody=b("<div/>").appendTo(l).css({padding:"0.5em"});let r=b("<table/>").appendTo(n),a=b("<tr/>").appendTo(r);r.attr({width:"100%"});let h=b('<td valign="center"/>').appendTo(a).css({padding:"0.5em"});b("<font/>").appendTo(h).css({"font-size":"1.5em","font-weight":"600"}).setText(this.title);let u=this.domTitleButtons=b('<td align="right" valign="center"/>').appendTo(a).css({padding:"0.5em"});this.domClose=b('<button class="wmk-button wmk-button-default">Close</button>').appendTo(u),this.domClose.onClick((()=>this.close())),this.populate(),this.repositionSize(),this.callbackShown&&this.callbackShown(this)}close(){this.domObscureBackground.remove(),this.domObscureForeground.remove(),this.callbackClose&&this.callbackClose(this)}bump(){this.repositionSize()}bodyDOM(){return this.domBody}buttonsDOM(){return this.domTitleButtons}populate(){this.bodyDOM().setText("Empty dialog box.")}repositionSize(){let t=window.innerWidth,e=this.domPanelBoundary.width();this.domPanelBoundary.css({left:.5*(t-e)+"px"})}}let Rs=null,Ls=null,Ds=0;function Is(t,e,s,i){Fs.ensureGlobal(),t.jquery&&(t=t[0]);let o=b(t),n=new Fs(o,e,s,null==i?1e3:i);o.onMouseEnter((()=>n.start())),o.onMouseLeave((()=>n.stop()))}function Ps(t,e,s,i){t.jquery&&(t=t[0]),_s(),Fs.ensureGlobal(),new Fs(b(t),s,i,0).raise(e)}function _s(){null!=Ls&&(Ds++,Ls.lower())}class Fs{constructor(t,e,s,i){this.widget=t,this.bodyHTML=e,this.titleHTML=s,this.delay=i}static ensureGlobal(){null==Rs&&(Rs=b("<div/>").css({position:"absolute","z-index":22e3,display:"none"}),Rs.css({"background-color":"#F0F0FF","background-image":"linear-gradient(to right bottom, #FFFFFF, #D0D0FF)"}),Rs.css({color:"black",border:"1px solid black","border-radius":"4px"}),Rs.appendTo(document.body))}start(){Rs.setCSS("display","none"),this.watermark=++Ds,window.setTimeout((()=>{this.watermark==Ds&&this.raise()}),this.delay)}stop(){this.watermark==Ds&&this.lower(),Ds++}raise(t){if(!this.widget.exists())return;Ls=this;let e=Rs;e.css({"max-width":"20em"}),e.empty();let s=b("<div/>").appendTo(e).css({padding:"0.3em"}),i=null!=this.titleHTML&&this.titleHTML.length>0,o=null!=this.bodyHTML&&this.bodyHTML.length>0;i&&b("<div/>").appendTo(s).setHTML("<b>"+this.titleHTML+"</b>"),i&&o&&s.appendHTML("<hr/>"),o&&b("<div/>").appendTo(s).setHTML(this.bodyHTML);let n=window.innerWidth,l=window.innerHeight,r=this.widget.el.getBoundingClientRect(),a=r.left,h=r.top,u=a+r.width,m=h+r.height;t&&(a+=t.x,h+=t.y,u=a+t.w,m=h+t.h);let d=()=>{let t=e.width(),s=e.height(),i=0,o=0;a+t<n?i=a:t<u&&(i=u-t),o=m+2+s<l?m+2:h-2-s>0?h-2-s:m+2,i+=window.pageXOffset,o+=window.pageYOffset,e.css({left:`${i}px`,top:`${o}px`})};d(),e.setCSS("display","block"),setTimeout((()=>d()),1);let c=()=>{this.watermark==Ds&&(this.widget.isVisible()?setTimeout(c,100):e.setCSS("display","none"))};setTimeout(c,100)}lower(){Rs.setCSS("display","none")}}class zs{constructor(){this.tagType="div",this.domContent=null}get contentDOM(){return this.domContent}render(t){t.jquery&&(t=t[0]);let e=this.tagType;this.domContent=b(`<${e}/>`).appendTo(t)}remove(){this.domContent&&this.domContent.remove(),this.domContent=null}addTooltip(t,e){Is(this.contentDOM,t,e)}}var Us,Ys;!function(t){t[t.Left=0]="Left",t[t.Right=1]="Right",t[t.Top=2]="Top",t[t.Bottom=3]="Bottom",t[t.Centre=4]="Centre"}(Us||(Us={}));class Xs extends zs{constructor(t,e,s,i,o){super(),this.position=t,this.parentX=e,this.parentY=s,this.parentWidth=i,this.parentHeight=o,this.idealSize=50,this.width=0,this.height=0,this.selectedButton=null,this.highlightButton=null,this.maxButtonColumns=0,this.maxButtonRows=0,this.border=8421504,this.background=16777215,this.buttonColNorm1=4707794,this.buttonColNorm2=36817,this.buttonColActv1=3211113,this.buttonColActv2=34384,this.buttonColSel1=16777215,this.buttonColSel2=14737632,this.canvas=null,this.stack=[],this.display=[],this.hasBigButtons=!0,this.prefabImgSize=44,this.gripHeight=30,this.gripWidth=50,this.isRaised=!0,this.outPadding=2,this.inPadding=2,this.x=0,this.y=0,this.isMacLike=!1,this.isMacLike=!!navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)}setParentSize(t,e){this.parentWidth=t,this.parentHeight=e}get topBank(){return this.stack.length>0?this.stack[this.stack.length-1]:null}get stackSize(){return this.stack.length}render(t){super.render(t),this.contentDOM.css({position:"absolute",width:`${this.width}px`,height:`${this.height}px`}),this.contentDOM.addClass("no_selection"),this.layoutButtons();let e="position: absolute; left: 0; top: 0;";e+="pointer-events: none;",this.canvas=x(this.contentDOM.el,"canvas",{width:this.width,height:this.height,style:"position: absolute; left: 0; top: 0;pointer-events: none;"}),this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.applyOffset(),this.redraw(),this.contentDOM.onClick((t=>this.mouseClick(t))),this.contentDOM.onDblClick((t=>this.mouseDoubleClick(t))),this.contentDOM.onMouseDown((t=>{t.preventDefault(),this.mouseDown(t)})),this.contentDOM.onMouseUp((t=>this.mouseUp(t))),this.contentDOM.onMouseOver((t=>this.mouseOver(t))),this.contentDOM.onMouseLeave((t=>this.mouseOut(t))),this.contentDOM.onMouseMove((t=>this.mouseMove(t)))}pushBank(t){t.buttonView=this,t.isSubLevel=this.stack.length>0,t.init(),this.stack.push(t),null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw())}popBank(){0!=this.stack.length&&(s.last(this.stack).bankClosed(),this.stack.length--,null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}refreshBank(){null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw())}getSelectedButton(){return this.selectedButton}setSelectedButton(t){t!=this.selectedButton&&(this.selectedButton=t,this.redraw())}cycleSelected(t){let e=this.display.filter((t=>"*"!=t.id));e.sort(((t,e)=>1e4*t.y+t.x-(1e4*e.y+e.x)));let s=0,i=e.length;for(let t=0;t<i;t++)if(e[t].id==this.selectedButton){s=t;break}this.selectedButton=e[(s+t+i)%i].id,this.redraw()}raiseBank(){this.isRaised||(this.isRaised=!0,this.contentDOM&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}lowerBank(){this.isRaised&&(this.isRaised=!1,this.contentDOM&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}getHasBigButtons(){return this.hasBigButtons}setHasBigButtons(t){this.hasBigButtons=t,this.prefabImgSize=t?44:36,this.idealSize=t?50:40}withinOutline(t,e){let s=this.width,i=this.height;if(t<0||t>s||e<0||e>i)return!1;if(this.position==Us.Centre||0==this.stack.length)return!0;if(this.position==Us.Left){let o=.5*i-1,n=this.gripHeight,l=.5*this.gripWidth;return t<s-n||e>o-l&&e<o+l}if(this.position==Us.Right){let s=.5*i-1,o=this.gripHeight,n=.5*this.gripWidth;return t>o||e>s-n&&e<s+n}if(this.position==Us.Top){let o=.5*s-1,n=this.gripHeight,l=.5*this.gripWidth;return e<i-n||t>o-l&&t<o+l}if(this.position==Us.Bottom){let i=.5*s-1,o=this.gripHeight,n=.5*this.gripWidth;return e>o||t>i-n&&t<i+n}return!0}gripSize(){return this.gripHeight}sizeForButtons(t){return this.idealSize*t+this.inPadding*(t-1)+2*this.outPadding}layoutButtons(){if(null==this.contentDOM)return;let t=this.outPadding,e=this.inPadding;if(this.removeDisplayButtons(),0==this.stack.length)return this.width=10,this.height=10,void(this.position==Us.Left||this.position==Us.Right?this.height=this.parentHeight:this.position!=Us.Top&&this.position!=Us.Bottom||(this.width=this.parentWidth));if(!this.isRaised)return this.position==Us.Left||this.position==Us.Right?(this.width=this.gripHeight,this.height=this.gripWidth+2*t):this.position!=Us.Top&&this.position!=Us.Bottom||(this.width=this.gripWidth+2*t,this.height=this.gripHeight),void this.addGripButton();let s=this.stack[this.stack.length-1];s.buttons=[],s.update();let i=0,o=0;1==this.stack.length||(this.position==Us.Left||this.position==Us.Right?o=this.gripHeight+e:this.position!=Us.Top&&this.position!=Us.Bottom||(i=this.gripHeight+e));let n=null,l=null;if(this.position==Us.Left||this.position==Us.Right){let i=Math.floor((this.parentHeight-2*t-e)/(this.idealSize+e)),o=Math.ceil(.5*i);for(let t=i;t>=o;t--){let e=Math.ceil(s.buttons.length/t);for(let i=e;i<=e+1;i++){let e=this.layoutMaxHeight(s,t,i),o=this.scoreLayout(e)+1*e[0].length;(null==n||o<l)&&(n=e,l=o)}}}else if(this.position==Us.Top||this.position==Us.Bottom){let o=Math.floor((this.parentWidth-2*t-e-i)/(this.idealSize+e)),r=Math.ceil(.5*o);for(let t=o;t>=r;t--){let e=this.layoutMaxWidth(s,t),i=this.scoreLayout(e)+1*e.length;(null==n||i<l)&&(n=e,l=i)}}let r=n[0].length,a=n.length;if(this.width=2*t+e+(this.idealSize+e)*r+i,this.height=2*t+e+(this.idealSize+e)*a+o,this.position==Us.Left||this.position==Us.Right?this.width+=this.gripHeight:this.position!=Us.Top&&this.position!=Us.Bottom||(this.height+=this.gripHeight),this.addGripButton(),i>0||o>0){let s={id:"!",x:t+e,y:t+e,width:i-e,height:o-e};this.position==Us.Right?s.x+=this.gripHeight:this.position==Us.Bottom&&(s.y+=this.gripHeight),0==i&&(s.width=r*this.idealSize+e*(r-1)),0==o&&(s.height=a*this.idealSize+e*(a-1)),this.display.push(s)}for(let l=0;l<a;l++)for(let a=0;a<r;a++)for(let r=0;r<s.buttons.length;r++)if(n[l][a]==s.buttons[r].id){let n={id:s.buttons[r].id};n.x=t+e+i+(this.idealSize+e)*a,n.y=t+e+o+(this.idealSize+e)*l,this.position==Us.Right?n.x+=this.gripHeight:this.position==Us.Bottom&&(n.y+=this.gripHeight),n.width=this.idealSize,n.height=this.idealSize,this.display.push(n)}}addGripButton(){if(this.position==Us.Centre)return;let t={id:"*"};this.position==Us.Left?(t.width=this.gripHeight-3,t.height=this.gripWidth-6,t.x=this.width-t.width-3-1,t.y=.5*(this.height-t.height)):this.position==Us.Right?(t.width=this.gripHeight-3,t.height=this.gripWidth-6,t.x=4,t.y=.5*(this.height-t.height)):this.position==Us.Top?(t.width=this.gripWidth-6,t.height=this.gripHeight-3,t.x=.5*(this.width-t.width),t.y=this.height-t.height-3-1):this.position==Us.Bottom&&(t.width=this.gripWidth-6,t.height=this.gripHeight-3,t.x=.5*(this.width-t.width),t.y=4),this.display.push(t)}replaceCanvas(){this.contentDOM.empty();for(let t=0;t<this.display.length;t++)this.display[t].imgDOM=null,this.display[t].helpSpan=null;let t="position: absolute; left: 0; top: 0;";t+="pointer-events: none;",this.canvas=x(this.contentDOM.el,"canvas",{width:this.width,height:this.height,style:"position: absolute; left: 0; top: 0;pointer-events: none;"})}removeDisplayButtons(){this.contentDOM.empty(),this.display=[]}applyOffset(){let t,e;this.position==Us.Left?(t=0,e=.5*(this.parentHeight-this.height)):this.position==Us.Right?(t=this.parentWidth-this.width,e=.5*(this.parentHeight-this.height)):this.position==Us.Top?(t=.5*(this.parentWidth-this.width),e=0):this.position==Us.Bottom?(t=.5*(this.parentWidth-this.width),e=this.parentHeight-this.height):(t=.5*(this.parentWidth-this.width),e=.5*(this.parentHeight-this.height)),this.x=this.parentX+t,this.y=this.parentY+e,this.contentDOM.css({position:"absolute"}),_(this.contentDOM,this.x,this.y,this.width,this.height)}redraw(){if(!this.contentDOM||!this.canvas)return;let t=pt();this.canvas.width=this.width*t,this.canvas.height=this.height*t,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px";let e=this.canvas.getContext("2d");e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height);let s=this.traceOutline();e.fillStyle=B(this.background),e.fill(s),e.strokeStyle=B(this.border),e.lineWidth=1,e.stroke(s),this.stack.length>0&&this.stack[this.stack.length-1],this.contentDOM.css({width:this.width+"px",height:this.height+"px"});for(let t=0;t<this.display.length;t++){const i=this.display[t],o=this.buttonFromID(i.id);let n,l;if(null!=this.highlightButton&&i.id==this.highlightButton?(n=this.buttonColActv1,l=this.buttonColActv2):null!=this.selectedButton&&i.id==this.selectedButton?(n=this.buttonColSel1,l=this.buttonColSel2):(n=this.buttonColNorm1,l=this.buttonColNorm2),e.save(),s=ut(i.x+.5,i.y+.5,i.x+i.width-1,i.y+i.height-1,5),null!=l){let t=e.createLinearGradient(i.x,i.y,i.x+i.width,i.y+i.height);t.addColorStop(0,B(n)),t.addColorStop(1,B(l)),e.fillStyle=t}else e.fillStyle=B(n);if(e.fill(s),e.strokeStyle=B(this.border),e.lineWidth=.5,e.stroke(s),e.restore(),null!=i.imgDOM&&(i.imgDOM.remove(),i.imgDOM=null),null!=o){if(null==i.helpSpan){i.helpSpan=b('<span style="position: absolute;"/>').appendTo(this.contentDOM);let t=o.helpText;if(o.mnemonic){for(;t.endsWith(".");)t=t.substring(0,t.length-1);let e=o.mnemonic,s=e.match(/^(.*)CmdOrCtrl(.*)$/);s&&(e=s[1]+(this.isMacLike?"Cmd":"Ctrl")+s[2]),t+=" ["+e+"]"}this.addTooltip(i.helpSpan.el.outerHTML,t)}_(i.helpSpan,i.x,i.y,i.width,i.height)}if(null==o);else if(null!=o.imageFN&&null==i.imgDOM){i.imgDOM=b("<img/>").appendTo(this.contentDOM).css({position:"absolute","pointer-events":"none"}),i.imgDOM.setAttr("src",gs.RESOURCE_URL+"/img/actions/"+o.imageFN+".svg");const t=this.prefabImgSize,e=i.x+Math.floor(.5*(i.width-t)),s=i.y+Math.floor(.5*(i.height-t));_(i.imgDOM,e,s,t,t)}else if(null!=o.metavec){let t=o.metavec instanceof Ge?o.metavec:new Ge(o.metavec);t.offsetX=i.x+Math.floor(.5*(i.width-t.width)),t.offsetY=i.y+Math.floor(.5*(i.height-t.height)),t.renderContext(e)}else if(null!=o.text){let t=this.idealSize,s=new Ge({size:[t,t]}),n=.6*t,l=Ue.main.measureText(o.text,n);l[1]+l[2]>t&&(n*=t/(l[1]+l[2]),l=Ue.main.measureText(o.text,n)),l[0]>t&&(n*=t/l[0],l=Ue.main.measureText(o.text,n));let r=.5*(t-l[0]),a=.5*(t+l[1]);s.drawText(r-1,a,o.text,n,0),s.drawText(r+1,a,o.text,n,0),s.drawText(r,a-1,o.text,n,0),s.drawText(r,a+1,o.text,n,0),s.drawText(r,a,o.text,n,16777215),s.offsetX=i.x+Math.floor(.5*(i.width-s.width)),s.offsetY=i.y+Math.floor(.5*(i.height-s.height)),s.renderContext(e)}if(null!=o&&o.isSubMenu){e.save();let t=i.x+i.width-3,s=i.y+i.height-3;e.beginPath(),e.moveTo(t,s),e.lineTo(t-6,s),e.lineTo(t,s-6),e.closePath(),e.fillStyle="black",e.fill(),e.restore()}if("*"==i.id){e.save(),s=new Path2D;let t,o,n=this.isRaised;this.position==Us.Left||this.position==Us.Right?(t=[.2,.7,.7],o=[.5,.3,.7],this.position==Us.Left&&(n=!n)):this.position!=Us.Top&&this.position!=Us.Bottom||(t=[.5,.3,.7],o=[.2,.7,.7],this.position==Us.Top&&(n=!n)),n&&(t=[1-t[0],1-t[1],1-t[2]],o=[1-o[0],1-o[1],1-o[2]]),s.moveTo(i.x+i.width*t[0],i.y+i.height*o[0]),s.lineTo(i.x+i.width*t[1],i.y+i.height*o[1]),s.lineTo(i.x+i.width*t[2],i.y+i.height*o[2]),s.closePath(),e.fillStyle="white",e.strokeStyle="black",e.lineWidth=0,e.fill(s),e.stroke(s),e.restore()}else if("!"==i.id){e.save();let t=new Path2D,s=new Path2D,o=5,n=i.width-2*o,l=i.height-2*o;for(let e=5;e<n+l-1;e+=12){let r=0,a=e,h=e,u=0;if(a>l){let t=a-l;r+=t,a-=t}if(h>n){let t=h-n;h-=t,u+=t}t.moveTo(i.x+o+r,i.y+o+a),t.lineTo(i.x+o+h,i.y+o+u),s.moveTo(i.x+o+r+1,i.y+o+a),s.lineTo(i.x+o+h+1,i.y+o+u)}e.lineWidth=1,e.strokeStyle="#404040",e.stroke(t),e.strokeStyle="white",e.stroke(s),e.restore()}}e.restore()}delayedRedraw(){window.setTimeout((()=>this.redraw()),100)}buttonFromID(t){let e=this.stack[this.stack.length-1];for(let s=0;s<e.buttons.length;s++)if(e.buttons[s].id==t)return e.buttons[s];return null}displayFromID(t){for(let e=0;e<this.display.length;e++)if(this.display[e].id==t)return this.display[e];return null}traceOutline(){let t=this.width,e=this.height,s=t-1,i=e-1;if(this.position==Us.Centre||0==this.stack.length)return ut(.5,.5,t-.5,e-.5,8);let o=new Path2D;if(this.position==Us.Left){let t=.5*e-1,n=this.gripHeight,l=.5*this.gripWidth;o.moveTo(.5,.5),o.lineTo(.5+s-n-8,.5),o.bezierCurveTo(.5+s-n,.5,.5+s-n,.5,.5+s-n,8.5),o.lineTo(.5+s-n,.5+t-l),o.lineTo(.5+s-8,.5+t-l),o.bezierCurveTo(.5+s,.5+t-l,.5+s,.5+t-l,.5+s,.5+t-l+8),o.lineTo(.5+s,.5+t+l-8),o.bezierCurveTo(.5+s,.5+t+l,.5+s,.5+t+l,.5+s-8,.5+t+l),o.lineTo(.5+s-n,.5+t+l),o.lineTo(.5+s-n,.5+i-8),o.bezierCurveTo(.5+s-n,.5+i,.5+s-n,.5+i,.5+s-n-8,.5+i),o.lineTo(.5,.5+i)}else if(this.position==Us.Right){let n=.5*e-1,l=this.gripHeight,r=.5*this.gripWidth;o.moveTo(t-.5,.5),o.lineTo(t-(.5+s-l-8),.5),o.bezierCurveTo(t-(.5+s-l),.5,t-(.5+s-l),.5,t-(.5+s-l),8.5),o.lineTo(t-(.5+s-l),.5+n-r),o.lineTo(t-(.5+s-8),.5+n-r),o.bezierCurveTo(t-(.5+s),.5+n-r,t-(.5+s),.5+n-r,t-(.5+s),.5+n-r+8),o.lineTo(t-(.5+s),.5+n+r-8),o.bezierCurveTo(t-(.5+s),.5+n+r,t-(.5+s),.5+n+r,t-(.5+s-8),.5+n+r),o.lineTo(t-(.5+s-l),.5+n+r),o.lineTo(t-(.5+s-l),.5+i-8),o.bezierCurveTo(t-(.5+s-l),.5+i,t-(.5+s-l),.5+i,t-(.5+s-l-8),.5+i),o.lineTo(t-.5,.5+i)}else if(this.position==Us.Top){let n=.5*t-1,l=this.gripHeight,r=.5*this.gripWidth;o.moveTo(.5,e-(.5+i)),o.lineTo(.5,e-(.5+l+8)),o.bezierCurveTo(.5,e-(.5+l),.5,e-(.5+l),8.5,e-(.5+l)),o.lineTo(.5+n-r,e-(.5+l)),o.lineTo(.5+n-r,e-8.5),o.bezierCurveTo(.5+n-r,e-.5,.5+n-r,e-.5,.5+n-r+8,e-.5),o.lineTo(.5+n+r-8,e-.5),o.bezierCurveTo(.5+n+r,e-.5,.5+n+r,e-.5,.5+n+r,e-8.5),o.lineTo(.5+n+r,e-(.5+l)),o.lineTo(.5+s-8,e-(.5+l)),o.bezierCurveTo(.5+s,e-(.5+l),.5+s,e-(.5+l),.5+s,e-(.5+l+8)),o.lineTo(.5+s,e-(.5+i))}else if(this.position==Us.Bottom){let e=.5*t-1,n=this.gripHeight,l=.5*this.gripWidth;o.moveTo(.5,.5+i),o.lineTo(.5,.5+n+8),o.bezierCurveTo(.5,.5+n,.5,.5+n,8.5,.5+n),o.lineTo(.5+e-l,.5+n),o.lineTo(.5+e-l,8.5),o.bezierCurveTo(.5+e-l,.5,.5+e-l,.5,.5+e-l+8,.5),o.lineTo(.5+e+l-8,.5),o.bezierCurveTo(.5+e+l,.5,.5+e+l,.5,.5+e+l,8.5),o.lineTo(.5+e+l,.5+n),o.lineTo(.5+s-8,.5+n),o.bezierCurveTo(.5+s,.5+n,.5+s,.5+n,.5+s,.5+n+8),o.lineTo(.5+s,.5+i)}return o}layoutMaxWidth(t,e){if(0==t.buttons.length)return[[null]];let s=new Array(t.buttons.length),i=new Array(t.buttons.length),o=0,n=0,l=0,r=0;for(let a=0;a<t.buttons.length;a++)l=Math.max(o+1,l),r=Math.max(n+1,r),s[a]=o,i[a]=n,o++,o>=e&&(o=0,n++);let a=new Array(r);for(let t=0;t<r;t++)a[t]=new Array(l);for(let e=0;e<t.buttons.length;e++)a[i[e]][s[e]]=t.buttons[e].id;return a}layoutMaxHeight(t,e,s){if(0==t.buttons.length)return[[null]];let i=new Array(t.buttons.length),o=new Array(t.buttons.length),n=0,l=0,r=0,a=0;for(let e=0;e<t.buttons.length;e++)r=Math.max(n+1,r),a=Math.max(l+1,a),i[e]=n,o[e]=l,n++,n>=s&&(n=0,l++);let h=new Array(a);for(let t=0;t<a;t++)h[t]=new Array(r);for(let e=0;e<t.buttons.length;e++)h[o[e]][i[e]]=t.buttons[e].id;return h}scoreLayout(t){let e=0,s=t.length,i=t[0].length;for(let o=0;o<s;o++)for(let s=0;s<i;s++)null==t[o][s]&&e++;return this.maxButtonRows>0&&s>this.maxButtonRows&&(e+=100*(s-this.maxButtonRows)),this.maxButtonColumns>0&&i>this.maxButtonColumns&&(e+=100*(i-this.maxButtonColumns)),e}pickButtonIndex(t,e){for(let s=0;s<this.display.length;s++){let i=this.display[s];if(t>=i.x&&e>=i.y&&t<i.x+i.width&&e<i.y+i.height)return s}return-1}pickButtonID(t,e){let s=this.pickButtonIndex(t,e);if(!(s<0))return this.display[s].id}triggerButton(t){"*"!=t?"!"!=t?this.stack[this.stack.length-1].hitButton(t):this.popBank():this.isRaised?this.lowerBank():this.raiseBank()}mouseClick(t){}mouseDoubleClick(t){t.stopImmediatePropagation()}mouseDown(t){this.contentDOM.parent().grabFocus();let e=P(t,this.contentDOM);if(!this.withinOutline(e[0],e[1]))return;let s=this.pickButtonID(e[0],e[1]);s!=this.highlightButton&&(this.highlightButton=s,this.redraw()),t.stopPropagation()}mouseUp(t){let e=P(t,this.contentDOM);if(!this.withinOutline(e[0],e[1]))return;let s=this.pickButtonID(e[0],e[1]);null!=s&&this.highlightButton==s?(this.highlightButton=void 0,this.triggerButton(s),this.delayedRedraw()):(this.highlightButton=void 0,this.delayedRedraw()),t.stopPropagation()}mouseOver(t){let e=P(t,this.contentDOM);this.withinOutline(e[0],e[1])&&t.stopPropagation()}mouseOut(t){let e=P(t,this.contentDOM);if(this.withinOutline(e[0],e[1])){if(null!=this.highlightButton){let e=P(t,this.contentDOM);this.pickButtonID(e[0],e[1])!=this.highlightButton&&(this.highlightButton=null,this.delayedRedraw())}t.stopPropagation()}else null!=this.highlightButton&&(this.highlightButton=null,this.delayedRedraw())}mouseMove(t){let e=P(t,this.contentDOM);this.withinOutline(e[0],e[1])}}class Hs{constructor(){this.isSubLevel=!1,this.buttons=[]}init(){}claimKey(t){return!1}bankClosed(){}static matchKey(t,e,s){if(null==e||""==e)return!1;let i=!1,o=!1,n=!1,l=!1,r=e;for(;;)if(r.startsWith("Shift+"))i=!0,r=r.substring(6);else if(r.startsWith("Ctrl+"))o=!0,r=r.substring(5);else if(r.startsWith("Alt+"))n=!0,r=r.substring(4);else{if(!r.startsWith("Cmd+"))break;l=!0,r=r.substring(4)}return i==t.shiftKey&&o==t.ctrlKey&&n==t.altKey&&l==t.metaKey&&(s&&(r=s),r.toLowerCase()==t.key.toLowerCase())}}class js{constructor(t,e,s){this.metalAtom=e,this.ligandAttach=s,this.ligands=[],this.mol=t.clone()}generate(){const{mol:t,metalAtom:e,ligandAttach:i,ligands:o}=this;let n=Bt.fromMolecule(t);n.isolateNode(e-1);for(let l of n.calculateComponentGroups()){s.addTo(l,1);let n=!1;for(let t of i)if(l.indexOf(t)>=0){n=!0;break}if(!n)continue;let r={atoms:l,attach:[]};r.atoms=l;let a=!1;for(let s of r.atoms)if(t.findBond(s,e)>0){a=!0;break}for(let s of r.atoms)(t.findBond(s,e)>0||!a&&i.includes(s))&&r.attach.push(s);o.push(r);for(let s of r.attach)0==t.findBond(s,e)&&this.makeLigandBond(s)}if(0==o.length)throw new Error("No ligand atoms");let l=t.atomAdjList(e);for(let t of o)l=s.exclude(l,t.attach);let r=t.atomX(e),h=t.atomY(e),u=new Array(l.length);for(let e=0;e<l.length;e++)u[e]=Math.atan2(t.atomY(l[e])-h,t.atomX(l[e])-r);for(let e of o)if(1==e.attach.length){let s=e.attach[0];e.avgTheta=Math.atan2(t.atomY(s)-h,t.atomX(s)-r),this.orientLigand(e)}else{let i=new Array(e.attach.length);for(let s=0;s<e.attach.length;s++){let o=e.attach[s];i[s]=Math.atan2(t.atomY(o)-h,t.atomX(o)-r)}i=a.sortAngles(i);let o=i[0];for(let t=0;t<i.length;t++)i[t]=it(i[t],o);e.avgTheta=o+s.sum(i)/i.length,this.orientLigand(e)}if(0==l.length)o.sort(((t,e)=>j(t.avgTheta-e.avgTheta))),this.arrangeLigandsFree(o);else if(1==l.length)o.sort(((t,e)=>j(it(t.avgTheta,u[0])-it(e.avgTheta,u[0])))),this.arrangeLigandsRange(o,u[0],K,!0);else{let t=s.idxSort(u);for(let e=0;e<t.length;e++){let s=(e+1)%t.length,i=u[t[e]],n=it(u[t[s]],i),l=[];for(let t of o)it(t.avgTheta,i)<n&&l.push(t);0!=l.length&&(l.sort(((t,e)=>j(it(t.avgTheta,i)-it(e.avgTheta,i)))),this.arrangeLigandsRange(l,i,n,!0))}}return this.resolveClashes(),t}makeLigandBond(t){const{mol:e,metalAtom:s}=this;let i=e.atomCharge(s),o=e.atomCharge(t);if(i>0&&o<0)return e.setAtomCharge(s,i-1),e.setAtomCharge(t,o+1),void e.addBond(s,t,1);if(i<0&&o>0)return e.setAtomCharge(s,i+1),e.setAtomCharge(t,o-1),void e.addBond(s,t,1);let n=0;e.atomHExplicit(t)==ne.HEXPLICIT_UNKNOWN&&e.atomHydrogens(t)>0&&(n=1),e.addBond(s,t,n)}orientLigand(t){const{mol:e,metalAtom:i}=this;let o=e.atomX(i),n=e.atomY(i),l=t.atoms.length,r=t.attach.length,h=new Array(r);for(let e=0;e<r;e++)h[e]=t.atoms.indexOf(t.attach[e]);let u=new Array(l),m=new Array(l),d=Ht.arrayAtomX(e),c=Ht.arrayAtomY(e),p=s.max(d)-s.min(d)+s.max(c)-s.min(c),f=p*Math.cos(t.avgTheta),g=p*Math.sin(t.avgTheta);for(let s=0;s<l;s++)u[s]=e.atomX(t.atoms[s])+f,m[s]=e.atomY(t.atoms[s])+g;let b=s.sum(u)/l,A=s.sum(m)/l,y=[];for(let t=0;t<l;t++){let e=Number.POSITIVE_INFINITY;for(let s of h)e=Math.min(e,X(u[t]-u[s],m[t]-m[s]));y.push(1/(1+Math.sqrt(e)))}let E=Number.POSITIVE_INFINITY,M=null,T=null;for(let e=0;e<360;e+=15){let s=Math.cos(e*J),i=Math.sin(e*J),r=new Array(l),a=new Array(l),h=0;for(let e=0;e<l;e++){let l=u[e]-b,d=m[e]-A;r[e]=b+l*s-d*i,a[e]=A+l*i+d*s;let c=U(r[e]-o,a[e]-n);t.attach.indexOf(t.atoms[e])>=0?h+=c:h-=c*y[e]}h<E&&(E=h,M=r,T=a)}if(u=M,m=T,1==r)f=ne.IDEALBOND*Math.cos(t.avgTheta),g=ne.IDEALBOND*Math.sin(t.avgTheta),s.addTo(u,o+f-u[h[0]]),s.addTo(m,n+g-m[h[0]]);else{let e=new Array(r),i=s.numberArray(0,r),d=s.numberArray(0,r),c=s.numberArray(0,r);for(let t=0;t<r;t++){let s=u[h[t]]-o,l=m[h[t]]-n;e[t]=Math.atan2(l,s),r>2&&(i[t]=U(s,l),d[t]=s/i[t],c[t]=l/i[t])}s.addTo(i,-s.min(i));let p=a.idxSortAngles(e),f=new Array(r),g=new Array(r),b=new Array(r),A=new Array(r),y=45*J/(r-1),E=t.avgTheta-.5*y;for(let t=0;t<r;t++)f[t]=u[h[p[t]]],g[t]=m[h[p[t]]],b[t]=o+ne.IDEALBOND*Math.cos(E)+i[t]*d[t],A[t]=n+ne.IDEALBOND*Math.sin(E)+i[t]*c[t],E+=y/(r-1);let M=a.superimpose(f,g,b,A);for(let t=0;t<l;t++){let[e,s]=a.applyAffine(u[t],m[t],M);u[t]=e,m[t]=s}}for(let s=0;s<l;s++)e.setAtomPos(t.atoms[s],u[s],m[s])}arrangeLigandsFree(t){if(1==t.length)return;let e=s.last(t).avgTheta;e+=.5*it(s.first(t).avgTheta,e),this.arrangeLigandsRange(t,e,K,!1)}arrangeLigandsRange(t,e,s,i){const{mol:o,metalAtom:n}=this;let l=o.atomX(n),r=o.atomY(n),a=t.length,h=new Array(a),u=new Array(a),m=0;for(let e=0;e<a;e++){let[s,i]=this.determineThetaBounds(t[e]);h[e]=s,u[e]=it(i,s),m+=u[e]}let d=(s-m)/(a+(i?1:0)),c=e+(i?d:.5*d);for(let e=0;e<a;e++){let s=c-h[e],i=Math.cos(s),n=Math.sin(s);for(let s of t[e].atoms){let t=o.atomX(s)-l,e=o.atomY(s)-r;o.setAtomPos(s,l+t*i-e*n,r+t*n+e*i)}c+=u[e]+d}}determineThetaBounds(t){const{mol:e,metalAtom:i}=this;let o=[],n=e.atomX(i),l=e.atomY(i);for(let s=0;s<t.attach.length;s++){let i=e.atomX(t.attach[s])-n,r=e.atomY(t.attach[s])-l;o.push(Math.atan2(r,i))}s.sort(o);let r=Number.POSITIVE_INFINITY,a=0,h=0;for(let t=0;t<o.length;t++){let t=0;for(let e=0;e<o.length-1;e++)t+=it(o[e+1],o[e]);t<r&&(r=t,a=s.first(o),h=s.last(o)),o.push(o.shift())}return[a,h]}resolveClashes(){const{mol:t,metalAtom:e,ligands:i}=this,o=t.numAtoms,n=t.numBonds,l=this.ligands.length;let r=s.numberArray(-1,o),h=s.numberArray(-1,n);for(let s=1;s<=o;s++)t.atomConnComp(s)==t.atomConnComp(e)&&(r[s-1]=0);for(let t=0;t<l;t++)for(let e of i[t].atoms)r[e-1]=t+1;for(let e=1;e<=n;e++){let s=r[t.bondFrom(e)-1],i=r[t.bondTo(e)-1];s<0||i<0||s==i&&(h[e-1]=s)}let u=new Array(l),m=new Array(l),d=t.atomX(e),c=t.atomY(e);for(let e=0;e<l;e++){let s=i[e],o=0,n=0;for(let e of s.attach)o+=t.atomX(e)-d,n+=t.atomY(e)-c;o/=s.attach.length,n/=s.attach.length;let l=1/U(o,n);u[e]=.5*o*l,m[e]=.5*n*l}const p=V(.5);for(let e=0;e<12;e++){let e=s.booleanArray(!1,l);t:for(let i=0;i<o-1;i++)if(!(r[i]<0))for(let n=i+1;n<o;n++)if(r[n]>=0&&r[n]!=r[i]&&(X(t.atomX(i+1)-t.atomX(n+1),t.atomY(i+1)-t.atomY(n+1))<p&&(r[i]>0&&(e[r[i]-1]=!0),r[n]>0&&(e[r[n]-1]=!0)),s.allTrue(e)))break t;if(s.anyFalse(e))t:for(let i=0;i<n-1;i++){if(h[i]<0)continue;let o=t.atomX(t.bondFrom(i+1)),l=t.atomY(t.bondFrom(i+1)),r=t.atomX(t.bondTo(i+1)),u=t.atomY(t.bondTo(i+1));for(let m=i+1;m<n;m++)if(h[m]>=0&&h[m]!=h[i]){let n=t.atomX(t.bondFrom(m+1)),d=t.atomY(t.bondFrom(m+1)),c=t.atomX(t.bondTo(m+1)),p=t.atomY(t.bondTo(m+1));if(a.doLineSegsIntersect(o,l,r,u,n,d,c,p)&&(h[i]>0&&(e[h[i]-1]=!0),h[m]>0&&(e[h[m]-1]=!0)),s.allTrue(e))break t}}if(s.allFalse(e))break;for(let s=0;s<l;s++)if(e[s])for(let e of i[s].atoms)t.setAtomPos(e,t.atomX(e)+u[s],t.atomY(e)+m[s])}}}class Vs{constructor(){this.attdist=0,this.guided=!1,this.bridged=!1,this.scoreModifier=0,this.chainSelect=0}}class Ws{constructor(t,e,s){this.mol=t,this.templ=e,this.abbrev=s,this.perms=[],this.numAttach=0,this.withGuideOnly=!1,this.guidetempl=null,this.guideidx=[],this.guideadj=[],this.timeLimit=5;let i=new Dt(t),o=new Dt(e);o.harmoniseNumbering(i),o.rewriteMolecule();let n=new Yt(t),l=new Yt(e);l.harmoniseNumbering(n),l.rewriteMolecule(),this.huntForGuides()}permuteNone(){let t=this.mol.clone(),e=this.templ.clone();if(t.numAtoms>0){let s=t.boundary(),i=e.boundary(),o=s.maxX()+1-i.minX(),n=.5*(s.minY()+s.maxY())-.5*(i.minY()+i.maxY());jt.translateMolecule(e,o,n)}else{let t=e.boundary();jt.translateMolecule(e,-t.midX(),-t.midY())}t.boundary();let s=e.boundary(),i=s.midX(),o=s.midY(),n=[0,30,45,60,90,120,135,150,180,210,225,240,270,300,315,330];t:for(let s=0;s<n.length;s++){let l=e.clone();jt.rotateMolecule(l,-n[s]*J,i,o);for(let t=0;t<this.perms.length;t++)if(jt.sketchEquivalent(l,this.perms[t].display))continue t;let r=new Vs;r.mol=t.clone(),r.mol.append(l),r.display=l,r.srcidx=this.sourceIndex(r.mol,t),r.attdist=0,r.guided=!1,this.perms.push(r)}}permuteAtom(t){this.numAttach=1;let e=(new Date).getTime(),s=this.mol.clone(),i=this.templ.clone(),o=[];if(null!=this.guidetempl){let i=jt.mirrorImage(this.guidetempl.clone());for(let n=0;n<this.guideidx.length&&!((new Date).getTime()-e>1e3*this.timeLimit);n++)this.composeGuidedOne(o,s,this.guidetempl,t,this.guideidx[n]),this.composeGuidedOne(o,s,i,t,this.guideidx[n])}if(!this.withGuideOnly){let n=i.clone();jt.mirrorImage(n);for(let l=1;l<=i.numAtoms&&!((new Date).getTime()-e>1e3*this.timeLimit);l++)this.composeDirectOne(o,s,i,t,l),this.composeDirectOne(o,s,n,t,l),this.composeBridge(o,s,i,t,l),this.composeBridge(o,s,n,t,l)}this.affixRawPermutations(o)}permuteBond(t,e){this.numAttach=2;let s=(new Date).getTime(),i=this.mol.clone(),o=this.templ.clone(),n=[];if(null!=this.guidetempl){let o=jt.mirrorImage(this.guidetempl.clone());for(let l=0;l<this.guideidx.length&&!((new Date).getTime()-s>1e3*this.timeLimit);l++){let s=this.guideidx[l],r=this.guidetempl.atomAdjList(s);for(let l=0;l<r.length;l++){let a=r[l];this.composeGuidedTwo(n,i,this.guidetempl,t,e,s,a,!0),this.composeGuidedTwo(n,i,this.guidetempl,e,t,s,a,!0),this.composeGuidedTwo(n,i,o,t,e,s,a,!0),this.composeGuidedTwo(n,i,o,e,t,s,a,!0),this.composeGuidedTwo(n,i,this.guidetempl,t,e,s,a,!1),this.composeGuidedTwo(n,i,this.guidetempl,e,t,s,a,!1),this.composeGuidedTwo(n,i,o,t,e,s,a,!1),this.composeGuidedTwo(n,i,o,e,t,s,a,!1)}}}if(!this.withGuideOnly){let l=o.clone();jt.mirrorImage(l);for(let r=1;r<=o.numBonds&&!((new Date).getTime()-s>1e3*this.timeLimit);r++){let s=o.bondFrom(r),a=o.bondTo(r);this.composeDirectTwo(n,i,o,t,e,s,a),this.composeDirectTwo(n,i,l,t,e,s,a),this.composeDirectTwo(n,i,o,t,e,a,s),this.composeDirectTwo(n,i,l,t,e,a,s)}}this.affixRawPermutations(n)}permuteMulti(t){this.numAttach=t.length;let e=(new Date).getTime(),s=this.mol.clone(),i=this.templ.clone(),o=[];if(null!=this.guidetempl){let e=jt.mirrorImage(this.guidetempl.clone());this.guideidx.length==t.length&&(this.composeGuidedMulti(o,s,this.guidetempl,t,this.guideidx,!0),this.composeGuidedMulti(o,s,e,t,this.guideidx,!0)),this.guideadj.length==t.length&&(this.composeGuidedMulti(o,s,this.guidetempl,t,this.guideadj,!1),this.composeGuidedMulti(o,s,e,t,this.guideadj,!1))}if(!this.withGuideOnly){let n=i.clone();jt.mirrorImage(n);for(let l=1;l<=i.numAtoms&&!((new Date).getTime()-e>1e3*this.timeLimit);l++)this.composeDirectMulti(o,s,i,t,l),this.composeDirectMulti(o,s,n,t,l)}this.affixRawPermutations(o)}huntForGuides(){this.guideidx=[],this.guideadj=[];for(let t=1;t<=this.templ.numAtoms;t++)if("X"==this.templ.atomElement(t)&&this.templ.atomAdjCount(t)>0){this.guideidx.push(t);let e=this.templ.atomAdjList(t);for(let t=0;t<e.length;t++)this.guideadj.indexOf(e[t])<0&&this.guideadj.push(e[t])}if(this.guideidx.length>0){this.guidetempl=this.templ.clone();for(let t=this.guideidx.length-1;t>=0;t--)this.templ.deleteAtomAndBonds(this.guideidx[t])}}composeDirectOne(t,e,s,i,o){let n=Xt.primeDirections(e,i),l=Xt.primeDirections(s,o),r=jt.atomBondAngles(e,i),a=jt.atomBondAngles(s,o),h=[],u=[],m=[];for(let t=0;t<r.length;t++)for(let e=0;e<l.length;e++)h.push(r[t]),u.push(l[e]),m.push(-51);for(let t=0;t<n.length;t++)for(let e=0;e<a.length;e++)h.push(n[t]),u.push(a[e]),m.push(0);for(let t=0;t<n.length;t++)for(let e=0;e<l.length;e++)h.push(n[t]),u.push(l[e]),m.push(0);let d=Bt.fromMolecule(s).calculateBFS(0),c=e.atomX(i),p=e.atomY(i),f=s.atomX(o),g=s.atomY(o);for(let n=0;n<h.length;n++){let l=st(h[n],u[n]),r=s.clone();jt.translateMolecule(r,c-f,p-g),jt.rotateMolecule(r,l,c,p);let a=e.clone(),b=a.numAtoms;a.append(r);let A=this.sourceIndex(a,e);if(Xt.mergeFragmentsMask(a,this.asMask(A)),a.numAtoms==b)continue;let y=new Vs;y.mol=a,y.display=r,y.srcidx=A,y.molidx=[i],y.temidx=[o],y.attdist=d[o-1],y.guided=!1,y.scoreModifier=m[n],this.removeExtraGuides(y,e),t.push(y)}}composeDirectTwo(t,e,s,i,o,n,l){let r=Math.atan2(e.atomY(o)-e.atomY(i),e.atomX(o)-e.atomX(i)),a=Math.atan2(s.atomY(l)-s.atomY(n),s.atomX(l)-s.atomX(n)),h=.5*(e.atomX(i)+e.atomX(o)),u=.5*(e.atomY(i)+e.atomY(o)),m=s.clone();jt.translateMolecule(m,h-.5*(s.atomX(n)+s.atomX(l)),u-.5*(s.atomY(n)+s.atomY(l))),jt.rotateMolecule(m,r-a,h,u),m.setAtomPos(n,e.atomX(i),e.atomY(i)),m.setAtomPos(l,e.atomX(o),e.atomY(o));let d=e.clone(),c=d.numAtoms;d.append(m);let p=this.sourceIndex(d,e);if(Xt.mergeFragmentsMask(d,this.asMask(p)),d.numAtoms==c)return;let f=Bt.fromMolecule(s).calculateBFS(0),g=new Vs;g.mol=d,g.display=m,g.srcidx=p,g.molidx=[i,o],g.temidx=[n,l],g.attdist=Math.min(f[n-1],f[l-1]),g.guided=!1,this.removeExtraGuides(g,e),t.push(g)}composeDirectMulti(t,e,s,i,o){let n=s.clone(),l=e.atomX(i[0]),r=e.atomY(i[0]);jt.translateMolecule(n,l-n.atomX(o),r-n.atomY(o));let a=e.atomX(i[1])-l,h=e.atomY(i[1])-r,u=Math.atan2(h,a),m=U(a,h),d=Bt.fromMolecule(s).calculateBFS(1),c=[];for(let s=1;s<=n.numAtoms;s++)if(o!=s){let a=n.atomX(s)-n.atomX(o),h=n.atomY(s)-n.atomY(o),p=U(a,h);if(Math.abs(p-m)>.1)continue;let f=Math.atan2(h,a);jt.rotateMolecule(n,u-f,l,r),c=[o,s];for(let t=2;t<i.length;t++){let s=!1;for(let o=1;o<=n.numAtoms;o++)if(c.indexOf(o)<0&&U(e.atomX(i[t])-n.atomX(o),e.atomY(i[t])-n.atomY(o))<.1*.1){s=!0,c.push(o);break}if(!s)break}if(c.length<i.length)continue;let g=d.length;for(let t=0;t<c.length;t++)g=Math.min(g,d[c[t]-1]);let b=0,A=0;for(let t=0;t<i.length;t++)b+=e.atomX(i[t])-n.atomX(c[t]),A+=e.atomY(i[t])-n.atomY(c[t]);let y=1/i.length;b*=y,A*=y,jt.translateMolecule(n,b,A);let E=e.clone(),M=E.numAtoms;E.append(n);let T=this.sourceIndex(E,e);for(let t=0;t<c.length;t++){let e=E.atomX(i[t]),s=E.atomY(i[t]);E.setAtomPos(M+c[t],e,s)}if(Xt.mergeFragmentsMask(E,this.asMask(T)),E.numAtoms==M)continue;let x=new Vs;x.mol=E,x.display=n.clone(),x.srcidx=T,x.molidx=i.slice(0),x.temidx=c.slice(0),x.attdist=Math.min(d[o-1],d[s-1]),x.guided=!1,this.removeExtraGuides(x,e),t.push(x)}}composeBridge(t,e,s,i,o){let n=0!=e.atomRingBlock(i)||e.atomAdjCount(i)>=3,l=0!=s.atomRingBlock(o)||s.atomAdjCount(o)>=3;if(!n||!l)return;let r=Xt.primeDirections(e,i),a=Xt.primeDirections(s,o),h=Bt.fromMolecule(s).calculateBFS(0);for(let n=0;n<r.length;n++)for(let l=0;l<a.length;l++){let u=e.atomX(i),m=e.atomY(i),d=s.atomX(o),c=s.atomY(o),p=ne.IDEALBOND*Math.cos(r[n]),f=ne.IDEALBOND*Math.sin(r[n]),g=st(r[n],Math.PI+a[l]),b=s.clone();jt.translateMolecule(b,u-d+p,m-c+f),jt.rotateMolecule(b,g,u+p,m+f);let A=e.clone(),y=A.numAtoms+o,E=A.numAtoms;A.append(b);let M=this.sourceIndex(A,e);if(A.addBond(i,y,1),y=b.addAtom("C",u,m),b.addBond(o,y,1),Xt.mergeFragmentsMask(A,this.asMask(M)),A.numAtoms==E)continue;let T=new Vs;T.mol=A,T.display=b,T.srcidx=M,T.molidx=[i],T.temidx=[y],T.attdist=h[o-1],T.bridged=!0,T.guided=!1,this.removeExtraGuides(T,e),t.push(T)}}composeGuidedOne(t,e,s,i,o){if(0==s.atomAdjCount(o))return;let n=Xt.primeDirections(e,i);if(s.atomAdjCount(o)>1&&e.atomAdjCount(i)>0){let t=0,s=0,o=e.atomAdjList(i);for(let n=0;n<o.length;n++)t+=e.atomX(o[n])-e.atomX(i),s+=e.atomY(o[n])-e.atomY(i);let l=Math.atan2(s,t),r=!0;for(let t=0;t<n.length;t++)if(Math.abs(st(l,n[t]))<3*tt){r=!1;break}r&&n.push(l)}let l=s.atomX(o),r=s.atomY(o),a=0,h=0,u=s.atomAdjList(o);for(let t=0;t<u.length;t++)a+=s.atomX(u[t])-l,h+=s.atomY(u[t])-r;a/=u.length,h/=u.length;let m=Math.atan2(h,a),d=0;if(1==u.length){let t=e.atomElement(i),o=s.atomElement(u[0]);"C"!=t&&t==o&&(d=1)}for(let a=0;a<n.length;a++){let h=s.clone();if(2==this.guideidx.length)for(let t=1;t<=h.numAtoms;t++)if(t!=o&&"X"==h.atomElement(t)){h.setAtomElement(t,Ws.RESERVED_GUIDESYMBOL);break}jt.rotateMolecule(h,n[a]-m,l,r),jt.translateMolecule(h,e.atomX(i)-l,e.atomY(i)-r);let u=e.clone(),c=u.numAtoms;u.append(h);let p=this.sourceIndex(u,e);if(Xt.mergeFragmentsMask(u,this.asMask(p)),u.numAtoms==c)continue;let f=0;for(let t=1;t<=u.numAtoms;t++)if(u.atomElement(t)==Ws.RESERVED_GUIDESYMBOL){let e=u.atomAdjList(t);1==e.length&&(f=e[0],f>t&&f--),u.deleteAtomAndBonds(t),p.splice(t-1,1);break}let g=new Vs;g.mol=u,g.display=h,g.srcidx=p,g.molidx=[i],g.temidx=[o],g.attdist=0,g.guided=!0,g.scoreModifier=d,g.chainSelect=f,this.removeExtraGuides(g,e),t.push(g)}}composeGuidedTwo(t,e,s,i,o,n,l,r){let a=e.atomX(i),h=e.atomY(i),u=s.atomX(n),m=s.atomY(n),d=s.atomX(l),c=s.atomY(l),p=Math.atan2(e.atomY(o)-h,e.atomX(o)-a),f=Math.atan2(c-m,d-u),g=1==e.atomAdjCount(i),b=e.clone(),A=s.clone();jt.rotateMolecule(A,p-f,u,m),r?(jt.translateMolecule(A,a-u,h-m),b.setAtomPos(o,A.atomX(l),A.atomY(l))):(jt.translateMolecule(A,e.atomX(o)-A.atomX(l),e.atomY(o)-A.atomY(l)),A.setAtomPos(n,a,h));let y=b.numAtoms;b.append(A);let E=this.sourceIndex(b,e);if(Xt.mergeFragmentsMask(b,this.asMask(E)),b.numAtoms==y)return;let M=new Vs;M.mol=b,M.display=A,M.srcidx=E,M.molidx=[i,o],M.temidx=[n,l],M.attdist=g?1:0,M.guided=!0,this.removeExtraGuides(M,e),t.push(M)}composeGuidedMulti(t,e,i,o,n,l){let r=0,a=0,h=0,u=0;for(let t=0;t<o.length;t++)r+=e.atomX(o[t]),a+=e.atomY(o[t]);for(let t=0;t<n.length;t++)h+=i.atomX(n[t]),u+=i.atomY(n[t]);r/=o.length,a/=o.length,h/=n.length,u/=n.length;let m=e.numAtoms;for(let d=0;d<o.length;d++)for(let c=0;c<n.length;c++){let p=e.clone(),f=i.clone(),g=Math.atan2(p.atomY(o[d])-a,p.atomX(o[d])-r),b=Math.atan2(f.atomY(n[c])-u,f.atomX(n[c])-h);jt.rotateMolecule(f,g-b,h,u),jt.translateMolecule(f,r-h,a-u),p.append(f);let A=this.sourceIndex(p,e),y=s.numberArray(0,n.length),E=n.slice(0);s.sort(E);let M=s.booleanArray(!1,m);for(let t=E.length-1;t>=0;t--){let e=E[t]+m,s=0,i=0;for(let t=0;t<o.length;t++)if(!M[o[t]-1]){let n=U(p.atomX(o[t])-p.atomX(e),p.atomY(o[t])-p.atomY(e));(0==s||n<i)&&(s=o[t],i=n)}if(!l){if(U(p.atomX(e)-p.atomX(s),p.atomY(e)-p.atomY(s))>.1*.1){let e=f.addAtom("C",p.atomX(s),p.atomY(s));f.addBond(e,E[t],0)}p.setAtomPos(s,p.atomX(e),p.atomY(e))}y[t]=s,M[s-1]=!0;let n=p.atomAdjList(e);for(let t=0;t<n.length;t++){let i=p.findBond(e,n[t]);p.addBond(s,n[t],p.bondOrder(i),p.bondType(i))}p.deleteAtomAndBonds(e),A.splice(e-1,1),f.setAtomPos(E[t],p.atomX(s),p.atomY(s))}for(let t=p.numAtoms;t>m;t--)if("X"==p.atomElement(t)){p.deleteAtomAndBonds(t),A.splice(t-1,1);for(let e=0;e<E.length;e++)t<E[e]&&E[e]--}for(let t=f.numAtoms;t>=1;t--)"X"==f.atomElement(t)&&f.setAtomElement(t,"C");let T=new Vs;T.mol=p,T.display=f,T.srcidx=A,T.molidx=y,T.temidx=E,T.attdist=0,T.guided=!0,this.removeExtraGuides(T,e),t.push(T)}}affixRawPermutations(t){let e=t.length;if(0==e)return;let i=s.booleanArray(!0,e);for(let s=0;s<e-1;s++)if(i[s]){let o=t[s];for(let n=s+1;n<e;n++)if(i[n]){let e=t[n];jt.sketchEquivalent(o.mol,e.mol)&&(o.scoreModifier+o.attdist>e.scoreModifier+e.attdist&&(t[s]=e,t[n]=o),i[n]=!1)}}let o=s.numberArray(0,e),n=0;for(let s=0;s<e;s++)i[s]?(o[s]=this.scorePermutation(t[s]),o[s]<1e3&&n++):o[s]=0;if(n>0)for(let t=0;t<e;t++)i[t]&&o[t]>=1e3&&(i[t]=!1);let l=[],r=[];for(let t=0;t<e;t++)i[t]&&(l.push(o[t]),r.push(t));let a=s.idxSort(l);for(let e=0;e<a.length;e++){let s=t[r[a[e]]];s.guided&&this.perms.push(s)}for(let e=0;e<a.length;e++){let s=t[r[a[e]]];s.guided||this.perms.push(s)}}removeExtraGuides(t,e){Ht.removeDuplicateBonds(t.mol);for(let e=t.temidx.length-1;e>=0;e--){let s=t.display.atomElement(t.temidx[e]);"X"!=s&&s!=Ws.RESERVED_GUIDESYMBOL||(t.molidx.splice(e,1),t.temidx.splice(e,1))}for(let s=t.display.numAtoms;s>=1;s--){let i=t.display.atomElement(s);if("X"==i||i==Ws.RESERVED_GUIDESYMBOL)if(jt.atomAtPoint(e,t.display.atomX(s),t.display.atomY(s))>0)t.display.setAtomElement(s,"C");else{t.display.deleteAtomAndBonds(s);for(let e=0;e<t.temidx.length;e++)t.temidx[e]>s&&t.temidx[e]--}}}scorePermutation(t){let e=this.mol,i=t.display,o=t.mol,n=.2*t.attdist+t.scoreModifier;n+=jt.congestionMolecule(o,.001),n-=o.numAtoms;let l=e.numAtoms,r=i.numAtoms,a=[],h=[],u=[],m=[];for(let t=0;t<l;t++)a.push(e.atomX(t+1)),h.push(e.atomY(t+1));for(let t=0;t<r;t++)u.push(i.atomX(t+1)),m.push(i.atomY(t+1));for(let e=0;e<l;e++)for(let s=0;s<r;s++){if(U(a[e]-u[s],h[e]-m[s])>jt.OVERLAP_THRESHOLD_SQ)continue;let i=!1;for(let o=0;o<t.molidx.length;o++)if(t.molidx[o]==e+1&&t.temidx[o]==s+1){i=!0;break}i||(n+=100)}if(!t.guided)for(let s=0;s<t.molidx.length;s++){let o=e.atomElement(t.molidx[s]);if("C"==o||"O"==o||"S"==o||"N"==o||"P"==o)continue;let l=e.atomAdjList(t.molidx[s]),r=i.atomAdjList(t.temidx[s]);if(!(l.length+r.length>=4))for(let o=0;o<l.length;o++)for(let d=0;d<r.length;d++){let c=l[o],p=r[d],f=e.bondOrder(e.findBond(t.molidx[s],c)),g=i.bondOrder(i.findBond(t.temidx[s],p)),b=0;if(1==f&&1==g||1==f&&2==g||2==f&&1==g)b=120;else{if(!(2==f&&2==g||1==f&&3==g||3==f&&1==g))continue;b=180}let A=a[c-1]-a[t.molidx[s]-1],y=h[c-1]-h[t.molidx[s]-1],E=u[p-1]-u[t.temidx[s]-1],M=m[p-1]-m[t.temidx[s]-1],T=Math.abs(st(Math.atan2(y,A),Math.atan2(M,E)))*tt;Math.abs(T-b)>5&&(n+=50)}}for(let t=1;t<=o.numAtoms;t++)if("C"==o.atomElement(t)||"N"==o.atomElement(t)){let e=o.atomAdjBonds(t),s=0;for(let t=0;t<e.length;t++){let i=o.bondOrder(e[t]);if(s+=i,0==i){s=0;break}}s>4&&(n+=1e3)}if(t.molidx.length>=2){let o=s.booleanArray(!1,l);for(let e=0;e<t.molidx.length;e++)o[t.molidx[e]-1]=!0;for(let s=1;s<=e.numBonds;s++){let l=e.bondFrom(s),r=e.bondTo(s);if(!o[l-1]||!o[r-1])continue;let a=t.molidx.indexOf(l),h=t.molidx.indexOf(r),u=i.findBond(t.temidx[a],t.temidx[h]);0!=u&&e.bondOrder(s)!=i.bondOrder(u)&&(n+=1)}}return n}sourceIndex(t,e){let i=s.numberArray(0,t.numAtoms);for(let t=e.numAtoms;t>=1;t--)i[t-1]=t;return i}asMask(t){let e=s.booleanArray(!1,t.length);for(let s=0;s<t.length;s++)e[s]=0!=t[s];return e}}Ws.RESERVED_GUIDESYMBOL="XXX",function(t){t[t.Delete=1]="Delete",t[t.Clear=2]="Clear",t[t.Copy=3]="Copy",t[t.Cut=4]="Cut",t[t.SelectAll=5]="SelectAll",t[t.SelectNone=6]="SelectNone",t[t.SelectPrevComp=7]="SelectPrevComp",t[t.SelectNextComp=8]="SelectNextComp",t[t.SelectSide=9]="SelectSide",t[t.SelectGrow=10]="SelectGrow",t[t.SelectShrink=11]="SelectShrink",t[t.SelectChain=12]="SelectChain",t[t.SelectSmRing=13]="SelectSmRing",t[t.SelectRingBlk=14]="SelectRingBlk",t[t.SelectCurElement=15]="SelectCurElement",t[t.SelectToggle=16]="SelectToggle",t[t.SelectUnCurrent=17]="SelectUnCurrent",t[t.Element=18]="Element",t[t.AtomPos=19]="AtomPos",t[t.Charge=20]="Charge",t[t.Connect=21]="Connect",t[t.Disconnect=22]="Disconnect",t[t.MetalLigate=23]="MetalLigate",t[t.BondOrder=24]="BondOrder",t[t.BondType=25]="BondType",t[t.BondGeom=26]="BondGeom",t[t.BondAtom=27]="BondAtom",t[t.BondSwitch=28]="BondSwitch",t[t.BondRotate=29]="BondRotate",t[t.BondAddTwo=30]="BondAddTwo",t[t.BondInsert=31]="BondInsert",t[t.Join=32]="Join",t[t.Nudge=33]="Nudge",t[t.NudgeLots=34]="NudgeLots",t[t.NudgeFar=35]="NudgeFar",t[t.Flip=36]="Flip",t[t.Scale=37]="Scale",t[t.Rotate=38]="Rotate",t[t.BondDist=39]="BondDist",t[t.AlignAngle=40]="AlignAngle",t[t.AlignRegular=41]="AlignRegular",t[t.AdjustTorsion=42]="AdjustTorsion",t[t.Move=43]="Move",t[t.Ring=44]="Ring",t[t.TemplateFusion=45]="TemplateFusion",t[t.AbbrevTempl=46]="AbbrevTempl",t[t.AbbrevGroup=47]="AbbrevGroup",t[t.AbbrevFormula=48]="AbbrevFormula",t[t.AbbrevClear=49]="AbbrevClear",t[t.AbbrevExpand=50]="AbbrevExpand",t[t.BondArtifactPath=51]="BondArtifactPath",t[t.BondArtifactRing=52]="BondArtifactRing",t[t.BondArtifactArene=53]="BondArtifactArene",t[t.BondArtifactClear=54]="BondArtifactClear",t[t.PolymerBlock=55]="PolymerBlock",t[t.AddHydrogens=56]="AddHydrogens",t[t.RemoveHydrogens=57]="RemoveHydrogens",t[t.QueryClear=58]="QueryClear",t[t.QueryCopy=59]="QueryCopy",t[t.QueryPaste=60]="QueryPaste",t[t.QuerySetAtom=61]="QuerySetAtom",t[t.QuerySetBond=62]="QuerySetBond",t[t.QueryBondAny=63]="QueryBondAny"}(Ys||(Ys={}));class Gs{constructor(t,e,i,o){this.input=t,this.activity=e,this.param=i,this.owner=o,this.toClipboard=null,this.output={mol:null,currentAtom:-1,currentBond:-1,selectedMask:null};let n=this.input.mol.numAtoms;for(null==this.input.selectedMask&&(this.input.selectedMask=s.booleanArray(!1,n));this.input.selectedMask.length<n;)this.input.selectedMask.push(!1);if(this.subjectMask=this.input.selectedMask.slice(0),this.subjectLength=s.maskCount(this.subjectMask),this.subjectIndex=[],this.hasSelected=this.subjectLength>0,0==this.subjectLength){if(this.input.currentAtom>0)this.subjectLength=1,this.subjectMask[this.input.currentAtom-1]=!0,this.subjectIndex=[this.input.currentAtom];else if(this.input.currentBond>0){let t=this.input.mol.bondFrom(this.input.currentBond),e=this.input.mol.bondTo(this.input.currentBond),s=Math.min(t,e),i=Math.max(t,e);this.subjectLength=2,this.subjectMask[s-1]=!0,this.subjectMask[i-1]=!0,this.subjectIndex=[s,i]}}else this.subjectIndex=s.maskIdx(this.subjectMask),s.addTo(this.subjectIndex,1)}setOwner(t){this.owner=t}evaluate(){return!0}execute(){let t=this.param;if(this.activity==Ys.Delete)this.execDelete();else if(this.activity==Ys.Clear)this.execClear();else if(this.activity==Ys.Copy)this.execCopy(!1);else if(this.activity==Ys.Cut)this.execCopy(!0);else if(this.activity==Ys.SelectAll)this.execSelectAll(!0);else if(this.activity==Ys.SelectNone)this.execSelectAll(!1);else if(this.activity==Ys.SelectPrevComp)this.execSelectComp(-1);else if(this.activity==Ys.SelectNextComp)this.execSelectComp(1);else if(this.activity==Ys.SelectSide)this.execSelectSide();else if(this.activity==Ys.SelectGrow)this.execSelectGrow();else if(this.activity==Ys.SelectShrink)this.execSelectShrink();else if(this.activity==Ys.SelectChain)this.execSelectChain();else if(this.activity==Ys.SelectSmRing)this.execSelectSmRing();else if(this.activity==Ys.SelectRingBlk)this.execSelectRingBlk();else if(this.activity==Ys.SelectCurElement)this.execSelectCurElement();else if(this.activity==Ys.SelectToggle)this.execSelectToggle();else if(this.activity==Ys.SelectUnCurrent)this.execSelectUnCurrent();else if(this.activity==Ys.Element)this.execElement(t.element,t.positionX,t.positionY,t.keepAbbrev);else if(this.activity==Ys.Charge)this.execCharge(t.delta);else if(this.activity==Ys.Connect)this.execConnect(1,ne.BONDTYPE_NORMAL);else if(this.activity==Ys.Disconnect)this.execDisconnect();else if(this.activity==Ys.MetalLigate)this.execMetalLigate();else if(this.activity==Ys.BondOrder)this.execBond(t.order,ne.BONDTYPE_NORMAL);else if(this.activity==Ys.BondType)this.execBond(1,t.type);else if(this.activity==Ys.BondGeom)this.execBondGeom(t.geom);else if(this.activity==Ys.BondAtom)this.execBondAtom(t.order,t.type,t.element,t.x1,t.y1,t.x2,t.y2);else if(this.activity==Ys.BondSwitch)this.execBondSwitch();else if(this.activity==Ys.BondRotate)this.execBondRotate();else if(this.activity==Ys.BondAddTwo)this.execBondAddTwo();else if(this.activity==Ys.BondInsert)this.execBondInsert();else if(this.activity==Ys.Join)this.execJoin();else if(this.activity==Ys.Nudge)this.execNudge(t.dir,.1);else if(this.activity==Ys.NudgeLots)this.execNudge(t.dir,1);else if(this.activity==Ys.NudgeFar)this.execNudgeFar(t.dir);else if(this.activity==Ys.Flip)this.execFlip(t.axis);else if(this.activity==Ys.Scale)this.execScale(t.mag);else if(this.activity==Ys.Rotate)this.execRotate(t.theta,t.centreX,t.centreY);else if(this.activity==Ys.BondDist)this.execBondDist(t.dist);else if(this.activity==Ys.AlignAngle)this.execAlignAngle(t.angle);else if(this.activity==Ys.AlignRegular)this.execAlignRegular();else if(this.activity==Ys.AdjustTorsion)this.execAdjustTorsion(t.angle);else if(this.activity==Ys.Move)this.execMove(t.refAtom,t.deltaX,t.deltaY);else if(this.activity==Ys.Ring)this.execRing(t.ringX,t.ringY,t.aromatic);else{if(this.activity==Ys.TemplateFusion)return this.execTemplateFusion(ne.fromString(t.fragNative)),void(this.owner&&this.owner.setPermutations(this.output.permutations));this.activity==Ys.AbbrevTempl?this.execAbbrevTempl():this.activity==Ys.AbbrevGroup?this.execAbbrevGroup():this.activity==Ys.AbbrevFormula?this.execAbbrevFormula():this.activity==Ys.AbbrevClear?this.execAbbrevClear():this.activity==Ys.AbbrevExpand?this.execAbbrevExpand():this.activity==Ys.BondArtifactPath||this.activity==Ys.BondArtifactRing||this.activity==Ys.BondArtifactArene||this.activity==Ys.BondArtifactClear?this.execBondArtifact(this.activity):this.activity==Ys.PolymerBlock?this.execPolymerBlock():this.activity==Ys.AddHydrogens?this.execAddHydrogens():this.activity==Ys.RemoveHydrogens?this.execRemoveHydrogens():this.activity==Ys.QueryClear?this.execQueryClear():this.activity==Ys.QueryCopy?this.execQueryCopy():this.activity==Ys.QueryPaste?this.execQueryPaste():this.activity==Ys.QuerySetAtom?this.execQuerySetAtom():this.activity==Ys.QuerySetBond?this.execQuerySetBond():this.activity==Ys.QueryBondAny&&this.execQueryBondAny()}this.finish()}finish(){this.owner&&(null!=this.output.mol||this.output.currentAtom>=0||this.output.currentBond>=0||null!=this.output.selectedMask?(this.owner.setState(this.output,!0),null!=this.errmsg&&this.owner.showMessage(this.errmsg,!1)):null!=this.errmsg&&this.owner.showMessage(this.errmsg,!0))}execDelete(){if(!this.requireSubject())return;let t=this.input.mol;if(this.output.mol=t.clone(),this.zapSubject(),this.input.currentBond>0&&!this.hasSelected)return this.output.mol.deleteBond(this.input.currentBond),void(this.output.currentBond=0);if(1==this.subjectLength&&this.subjectIndex[0]==this.input.currentAtom){let e=t.atomAdjList(this.input.currentAtom);1==e.length&&(this.output.currentAtom=e[0],this.output.currentAtom>this.input.currentAtom&&this.output.currentAtom--)}for(let t=this.subjectLength-1;t>=0;t--)this.output.mol.deleteAtomAndBonds(this.subjectIndex[t])}execCopy(t){let e=this.input.mol;this.subjectLength>0&&(e=Ht.subgraphWithAttachments(e,this.subjectMask)),this.owner?this.owner.performCopy(e):this.toClipboard=e.toString(),t&&(this.zapSubject(),this.output.mol=Ht.subgraphMask(this.input.mol,s.notMask(this.subjectMask)))}execClear(){this.output.mol=new ne,this.zapSubject()}execSelectAll(t){let e=!0;for(let s=0;s<this.input.mol.numAtoms;s++)if(this.subjectMask[s]!=t){e=!1;break}e?this.errmsg=t?"All atoms already selected.":"All atoms already deselected.":this.output.selectedMask=s.booleanArray(t,this.input.mol.numAtoms)}execSelectComp(t){let e=Ht.componentList(this.input.mol);if(1==e.length&&this.hasSelected&&this.subjectLength==this.input.mol.numAtoms)return void(this.errmsg="All atoms already selected.");let i=this.pickSelectedGroup(e,t);this.output.selectedMask=s.booleanArray(!1,this.input.mol.numAtoms);for(let t=0;t<e[i].length;t++)this.output.selectedMask[e[i][t]-1]=!0}execSelectSide(){if(!this.requireCurrent())return;let t=this.input.mol,e=this.input.currentAtom,i=this.input.currentBond;if(e>0&&0==t.atomAdjCount(e))return void(this.errmsg="Current atom has no neighbours.");if(i>0&&1==t.atomAdjCount(t.bondFrom(i))&&1==t.atomAdjCount(t.bondTo(i)))return void(this.errmsg="Current bond has no neighbours.");let o=e>0?Ht.getAtomSides(t,e):Ht.getBondSides(t,i),n=this.pickSelectedGroup(o,1);this.output.selectedMask=s.booleanArray(!1,t.numAtoms);for(let t=0;t<o[n].length;t++)this.output.selectedMask[o[n][t]-1]=!0}execSelectGrow(){if(!this.requireSubject())return;let t=this.input.mol,e=this.input.currentAtom,s=this.input.currentBond;if(this.output.selectedMask=this.input.selectedMask.slice(0),this.hasSelected)for(let e=1;e<=t.numBonds;e++){let s=t.bondFrom(e)-1,i=t.bondTo(e)-1;this.input.selectedMask[s]&&!this.input.selectedMask[i]?this.output.selectedMask[i]=!0:this.input.selectedMask&&!this.input.selectedMask[s]&&(this.output.selectedMask[s]=!0)}else e>0?this.output.selectedMask[e-1]=!0:(this.output.selectedMask[t.bondFrom(s)-1]=!0,this.output.selectedMask[t.bondTo(s)-1]=!0)}execSelectShrink(){if(!this.requireSelected())return;let t=this.input.mol,e=s.numberArray(0,t.numAtoms);for(let s=1;s<=t.numBonds;s++){let i=t.bondFrom(s)-1,o=t.bondTo(s)-1;this.input.selectedMask[i]&&this.input.selectedMask[o]&&(e[i]++,e[o]++)}this.output.selectedMask=this.input.selectedMask.slice(0);for(let s=0;s<t.numAtoms;s++)this.output.selectedMask[s]=this.input.selectedMask[s]&&e[s]>=2}execSelectChain(){if(!this.requireSubject())return;let t=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);for(let e=1;e<=t.numBonds;e++){let s=t.bondFrom(e)-1,i=t.bondTo(e)-1;this.input.selectedMask[s]&&!this.input.selectedMask[i]&&0==t.atomRingBlock(i+1)?this.output.selectedMask[i]=!0:this.input.selectedMask[i]&&!this.input.selectedMask[s]&&0==t.atomRingBlock(s+1)&&(this.output.selectedMask[s]=!0)}}execSelectSmRing(){if(this.requireSubject()){this.output.selectedMask=this.input.selectedMask.slice(0);for(let t=3;t<=8;t++){let e=this.input.mol.findRingsOfSize(t);for(let t=0;t<e.length;t++){let s=!1;for(let i=0;i<e[t].length;i++)if(this.subjectMask[e[t][i]-1]){s=!0;break}if(s)for(let s=0;s<e[t].length;s++)this.output.selectedMask[e[t][s]-1]=!0}}}}execSelectRingBlk(){if(!this.requireSubject())return;let t=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);let e=0;for(let s=1;s<=t.numAtoms;s++)e=Math.max(e,t.atomRingBlock(s));if(0==e)return;let i=s.booleanArray(!1,e);for(let e=1;e<=t.numAtoms;e++){let s=t.atomRingBlock(e);s>0&&this.subjectMask[e-1]&&(i[s-1]=!0)}for(let e=1;e<=t.numAtoms;e++){let s=t.atomRingBlock(e);s>0&&i[s-1]&&(this.output.selectedMask[e-1]=!0)}}execSelectCurElement(){if(!this.requireCurrent())return;let t=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);let e="",s="";this.input.currentAtom>0?e=t.atomElement(this.input.currentAtom):(e=t.atomElement(t.bondFrom(this.input.currentBond)),s=t.atomElement(t.bondTo(this.input.currentBond)));for(let i=1;i<=t.numAtoms;i++)t.atomElement(i)!=e&&t.atomElement(i)!=s||(this.output.selectedMask[i-1]=!0)}execSelectToggle(){if(this.requireCurrent())if(this.output.selectedMask=this.input.selectedMask.slice(0),this.input.currentAtom>0)this.output.selectedMask[this.input.currentAtom-1]=!this.output.selectedMask[this.input.currentAtom-1];else{let t=this.input.mol.bondFrom(this.input.currentBond),e=this.input.mol.bondTo(this.input.currentBond),s=!this.input.selectedMask[t-1]||!this.input.selectedMask[e-1];this.output.selectedMask[t-1]=s,this.output.selectedMask[e-1]=s}}execSelectUnCurrent(){this.requireCurrent()&&(this.output.selectedMask=this.input.selectedMask.slice(0),this.input.currentAtom>0?this.output.selectedMask[this.input.currentAtom-1]=!1:(this.output.selectedMask[this.input.mol.bondFrom(this.input.currentBond)-1]=!1,this.output.selectedMask[this.input.mol.bondTo(this.input.currentBond)-1]=!1))}execElement(t,e,s,i){if(this.subjectLength>0&&!["A","X","Y","Z","Q","M","T","E","R"].includes(t)){let e=!1;for(let s=0;s<this.subjectLength;s++)if(this.input.mol.atomElement(this.subjectIndex[s])!=t){e=!0;break}if(!e)return void(this.errmsg="Elements not changed.")}let o=this.output.mol=this.input.mol.clone(),n=e=>{if("A"==t)Bs.setQueryAtomElementsNot(o,e,["H"]),Bs.deleteQueryAtom(o,e,Os.Elements);else if("X"==t)Bs.setQueryAtomElements(o,e,["F","Cl","Br","I"]),Bs.deleteQueryAtom(o,e,Os.ElementsNot);else if("Y"==t)Bs.setQueryAtomElements(o,e,["O","S","Se","Te"]),Bs.deleteQueryAtom(o,e,Os.ElementsNot);else if("Z"==t)Bs.setQueryAtomElements(o,e,["F","Cl","Br","O","S"]),Bs.deleteQueryAtom(o,e,Os.ElementsNot);else if("Q"==t)Bs.setQueryAtomElementsNot(o,e,["H","C"]),Bs.deleteQueryAtom(o,e,Os.Elements);else if("M"==t){const t=["H","B","C","N","O","F","Si","P","S","Cl","As","Se","Br","Te","I"];Bs.setQueryAtomElementsNot(o,e,t),Bs.deleteQueryAtom(o,e,Os.Elements)}else if("T"==t){const t=["Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr"];Bs.setQueryAtomElements(o,e,t),Bs.deleteQueryAtom(o,e,Os.ElementsNot)}else if("E"==t){const t=["B","N","O","F","Al","Si","P","S","Cl","Zn","Ga","Se","As","Se","Br","Cd","In","Sn","Sb","Te","I","Hg","Tl","Pb","Bi","Pb","At"];Bs.setQueryAtomElements(o,e,t),Bs.deleteQueryAtom(o,e,Os.ElementsNot)}else"R"==t&&(Bs.setQueryAtomElements(o,e,["C","N","O","S","P","H"]),Bs.deleteQueryAtom(o,e,Os.ElementsNot))};if(0==o.numAtoms)o.addAtom(t,0,0),n(o.numAtoms);else if(0==this.subjectLength)null!=e&&null!=s?o.addAtom(t,e,s):Xt.placeNewAtom(o,t),n(o.numAtoms);else for(let e=0;e<this.subjectLength;e++)i?o.setAtomElement(this.subjectIndex[e],t):Ht.setAtomElement(o,this.subjectIndex[e],t),n(this.subjectIndex[e])}execCharge(t){if(this.requireSubject()){this.output.mol=this.input.mol.clone();for(let e=0;e<this.subjectLength;e++){let s=Math.max(-20,Math.min(20,this.input.mol.atomCharge(this.subjectIndex[e])+t));this.output.mol.setAtomCharge(this.subjectIndex[e],s)}}}execConnect(t,e){if(!this.requireSubject())return;let s=Xt.pickAtomsToConnect(this.input.mol,this.subjectIndex);if(null!=s){this.output.mol=this.input.mol.clone();for(let i=0;i<s.length;i+=2)Ht.addBond(this.output.mol,s[i],s[i+1],t,e)}else this.errmsg="Subject atoms contain no bonds suitable for connection."}execDisconnect(){let t=[],e=this.input.mol;if(this.hasSelected)for(let s=1;s<=e.numBonds;s++)this.subjectMask[e.bondFrom(s)-1]&&this.subjectMask[e.bondTo(s)-1]&&t.push(s);else if(this.input.currentAtom>0)for(let s of e.atomAdjBonds(this.input.currentAtom))t.push(s);else this.input.currentBond>0&&t.push(this.input.currentBond);if(0==t.length)return void(this.errmsg="Subject atoms contain no bonds suitable for disconnection.");let i=s.booleanArray(!1,e.numBonds);for(let e of t)i[e-1]=!0;this.output.mol=this.input.mol.clone();for(let t=e.numBonds;t>=1;t--)i[t-1]&&this.output.mol.deleteBond(t)}execMetalLigate(){if(!this.requireSubject())return;let t=this.input.mol,e=this.subjectIndex.slice(0),i=this.input.currentAtom;if(0==i)for(let e of this.subjectIndex){let s=t.atomicNumber(e);if(qt.ELEMENT_BLOCKS[s]>=3){i=e;break}}if(0==i)for(let e of this.subjectIndex){let s=t.atomicNumber(e);if(qt.ELEMENT_ROWS[s]>=3){i=e;break}}if(0==i)return void(this.errmsg="Unsure which is the metal atom: try indicating as current.");let o=e.indexOf(i);if(o>=0&&e.splice(o,1),0==e.length&&(e=t.atomAdjList(i)),0!=e.length){t=new js(t,i,e).generate(),this.output.mol=t,this.output.currentAtom=i,this.output.currentBond=-1,this.output.selectedMask=s.booleanArray(!1,t.numAtoms);for(let t of e)this.output.selectedMask[t-1]=!0}else this.errmsg="Metal centre has no attachments: try selecting atom join-points."}execBond(t,e){if(!this.requireSubject())return;if(1==this.subjectLength)return void this.performBondNew(this.subjectIndex[0],t,e);let s=Ht.subgraphMask(this.input.mol,this.subjectMask),i=!0;for(let t=s.numAtoms;t>=1;t--)if(1!=s.atomConnComp(t)){i=!1;break}i?this.performBondChange(t,e):this.execConnect(t,e)}execBondGeom(t){let e=2==this.subjectLength?this.input.mol.findBond(this.subjectIndex[0],this.subjectIndex[1]):0;0==this.subjectLength||this.subjectLength>2||2==this.subjectLength&&0==e?this.errmsg="The subject must be a single atom or bond.":1==this.subjectLength?this.performBondGeomAtom(t,this.subjectIndex[0]):this.performBondGeomBond(t,e)}execBondAtom(t,e,s,i,o,n,l){let r=this.input.mol,a=jt.atomAtPoint(r,i,o,.01),h=jt.atomAtPoint(r,n,l,.01);a>0&&a==h||a>0&&h>0&&r.findBond(a,h)>0||(this.output.mol=r.clone(),0==a&&(a=this.output.mol.addAtom("C",i,o)),0==h&&(h=this.output.mol.addAtom(s,n,l)),this.output.mol.addBond(a,h,t,e))}execBondSwitch(){if(!this.requireSubject())return;let t=this.input.mol,e=0,s=[];if(1==this.subjectLength){e=this.subjectIndex[0];let i=t.atomAdjList(e);for(let e=0;e<i.length;e++)1==t.atomAdjCount(i[e])&&s.push(i[e])}else if(2==this.subjectLength&&t.findBond(this.subjectIndex[0],this.subjectIndex[1])>0){let i=t.atomAdjCount(this.subjectIndex[0]),o=t.atomAdjCount(this.subjectIndex[1]);i>1&&1==o?(e=this.subjectIndex[0],s.push(this.subjectIndex[1])):1==i&&o>1&&(e=this.subjectIndex[1],s.push(this.subjectIndex[0]))}if(0==e||0==s.length)return void(this.errmsg="Subject must include a terminal bond.");let i=Xt.guessAtomGeometry(t,e,1);0!=i.length?(this.output.mol=Xt.switchAtomGeometry(t,e,s,i),null==this.output.mol&&(this.errmsg="No alternative geometries identified.")):this.errmsg="No alternative geometries identified."}execBondRotate(){let t=this.input.currentBond;if(0==t)return void(this.errmsg="There must be a current bond.");let e=this.input.mol;if(e.bondInRing(t))return void(this.errmsg="Cannot rotate a ring-bond.");if(1==e.atomAdjCount(e.bondFrom(t))||1==e.atomAdjCount(e.bondTo(t)))return void(this.errmsg="Terminal bonds do not rotate.");e=e.clone();let[i,o,n]=this.mobileSide(t),l=e.atomX(i),r=e.atomY(i),a=Math.atan2(e.atomY(i)-e.atomY(o),e.atomX(i)-e.atomX(o));for(let t of n)if(t!=i){let s=e.atomX(t)-l,i=e.atomY(t)-r,o=U(s,i),n=Math.atan2(i,s);n=a-st(n,a),e.setAtomPos(t,l+o*Math.cos(n),r+o*Math.sin(n))}let h=s.idxMask(s.add(n,-1),e.numAtoms);for(let t=1;t<=e.numBonds;t++)if(h[e.bondFrom(t)-1]&&h[e.bondTo(t)-1]){let s=e.bondType(t);s==ne.BONDTYPE_INCLINED?e.setBondType(t,ne.BONDTYPE_DECLINED):s==ne.BONDTYPE_DECLINED&&e.setBondType(t,ne.BONDTYPE_INCLINED)}jt.sketchEquivalent(this.input.mol,e)?this.errmsg="Rotation has no effect.":this.output.mol=e}execBondAddTwo(){if(1!=this.subjectLength)return void(this.errmsg="Subject must be a single atom.");let t=this.subjectIndex[0];if(this.input.mol.atomAdjCount(t)<2)return void(this.errmsg="Subject atom must already have at least 2 bonds.");let e=Xt.calculateNewBondAngles(this.input.mol,t,1);if(0==e.length&&(e=Xt.exitVectors(this.input.mol,t)),0==e.length)return void(this.errmsg="Could not find a suitable geometry for new substituents.");let s=e[0],i=this.input.mol.atomX(t),o=this.input.mol.atomY(t);if(e.length>1){let t=0;for(let n=0;n<e.length;n++){let l=i+ne.IDEALBOND*Math.cos(e[n]),r=o+ne.IDEALBOND*Math.sin(e[n]),a=jt.congestionPoint(this.input.mol,l,r);(0==n||a<t)&&(t=a,s=e[n])}}let n=s-30*J,l=s+30*J,r=this.input.mol.clone(),a=r.addAtom("C",i+ne.IDEALBOND*Math.cos(n),o+ne.IDEALBOND*Math.sin(n)),h=r.addAtom("C",i+ne.IDEALBOND*Math.cos(l),o+ne.IDEALBOND*Math.sin(l));r.addBond(t,a,1),r.addBond(t,h,1),this.output.mol=r}execBondInsert(){let t=this.input.mol,e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");if(t.bondInRing(e))return void(this.errmsg="Cannot insert into a ring-bond.");let[i,o,n]=this.mobileSide(e);t=t.clone(),t.setBondOrder(e,1);let l=s.booleanArray(!1,t.numAtoms);for(let t of n)l[t-1]=!0;let r=Ht.subgraphWithAttachments(t,l);for(let e=t.numAtoms;e>=1;e--)l[e-1]&&e!=i&&(t.deleteAtomAndBonds(e),e<i&&(i-=1));t.setAtomElement(i,"C"),t.setAtomCharge(i,0),t.setAtomUnpaired(i,0),t.setAtomHExplicit(i,ne.HEXPLICIT_UNKNOWN),t.setAtomIsotope(i,ne.ISOTOPE_NATURAL),t.setAtomMapNum(i,0),t.setAtomExtra(i,[]),t.setAtomTransient(i,[]);let a=new Ws(t,r,"");a.withGuideOnly=!0,a.permuteAtom(i),0!=a.perms.length?(this.output.mol=a.perms[0].mol,this.zapSubject(),this.output.currentAtom=i):this.errmsg="Unable to insert."}execJoin(){this.requireSubject()&&(this.output.mol=Xt.joinOverlappingAtoms(this.input.mol,this.subjectMask),null==this.output.mol?this.errmsg="Subject contains no overlapping atoms.":this.zapSubject())}execNudge(t,e){if(!this.requireSubject())return;let s=e*("left"==t?-1:"right"==t?1:0),i=e*("down"==t?-1:"up"==t?1:0);this.output.mol=this.input.mol.clone();for(let t=0;t<this.subjectLength;t++){let e=this.output.mol.atomX(this.subjectIndex[t]),o=this.output.mol.atomY(this.subjectIndex[t]);this.output.mol.setAtomPos(this.subjectIndex[t],e+s,o+i)}}execNudgeFar(t){if(!this.requireSubject())return;if(this.subjectLength==this.input.mol.numAtoms)return void(this.errmsg="Cannot apply to entire molecule.");let e="left"==t?-1:"right"==t?1:0,s="down"==t?-1:"up"==t?1:0;this.output.mol=Xt.moveToEdge(this.input.mol,this.subjectMask,e,s),null==this.output.mol&&this.execNudge(t,1)}execFlip(t){if(this.input.mol.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");let e="ver"==t,i=0,o=0,n=this.subjectMask,l=this.input.mol;if(this.input.currentAtom>0){if(i=l.atomX(this.input.currentAtom),o=l.atomY(this.input.currentAtom),!this.hasSelected){n=s.booleanArray(!1,l.numAtoms);let t=l.atomConnComp(this.input.currentAtom);for(let e=1;e<=l.numAtoms;e++)n[e-1]=l.atomConnComp(e)==t}}else if(this.input.currentBond>0){let t=l.bondFrom(this.input.currentBond),e=l.bondTo(this.input.currentBond);if(i=.5*(l.atomX(t)+l.atomX(e)),o=.5*(l.atomY(t)+l.atomY(e)),!this.hasSelected){n=s.booleanArray(!1,l.numAtoms);let e=l.atomConnComp(t);for(let t=1;t<=l.numAtoms;t++)n[t-1]=l.atomConnComp(t)==e}}else if(0==this.subjectLength){let t=l.boundary();i=.5*(t.minX()+t.maxX()),o=.5*(t.minY()+t.maxY()),n=s.booleanArray(!0,l.numAtoms)}else{for(let t=0;t<this.subjectLength;t++)i+=l.atomX(this.subjectIndex[t]),o+=l.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;i*=t,o*=t}this.output.mol=l.clone();for(let t=1;t<=l.numAtoms;t++)n[t-1]&&(e?this.output.mol.setAtomY(t,2*o-this.output.mol.atomY(t)):this.output.mol.setAtomX(t,2*i-this.output.mol.atomX(t)))}execScale(t){const{mol:e,currentAtom:i,currentBond:o}=this.input;if(e.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");if(i>0){let o=[];for(let t of this.subjectIndex)t!=i&&e.findBond(i,t)>0&&o.push(t);let n=Bt.fromMolecule(e);n.isolateNode(i-1);let l=!1;for(let r of n.calculateComponentGroups()){s.addTo(r,1);let n=0,a=0,h=0;for(let t of r)o.includes(t)&&(a+=e.atomX(t)-e.atomX(i),h+=e.atomY(t)-e.atomY(i),n++);if(0!=n&&([a,h]=[a/n,h/n],!(Math.abs(a)<.1&&Math.abs(h)<.1))){[a,h]=[a*(t-1),h*(t-1)],this.output.mol||(this.output.mol=e.clone());for(let t of r)this.output.mol.setAtomPos(t,this.output.mol.atomX(t)+a,this.output.mol.atomY(t)+h);l=!0}}if(l)return}let n;if(2==this.subjectLength&&(n=e.findBond(this.subjectIndex[0],this.subjectIndex[1]))>0&&!e.bondInRing(n)){let s=this.subjectIndex[0],i=this.subjectIndex[1],o=e.clone();o.deleteBond(n);let l=[],r=[];for(let t=1;t<=o.numAtoms;t++)o.atomConnComp(t)==o.atomConnComp(s)?l.push(t):o.atomConnComp(t)==o.atomConnComp(i)&&r.push(t);let a=(e.atomX(i)-e.atomX(s))*(t-1),h=(e.atomY(i)-e.atomY(s))*(t-1);if(l.length==r.length&&(a*=.5,h*=.5),this.output.mol=e.clone(),l.length<=r.length)for(let t=0;t<l.length;t++){let e=l[t];this.output.mol.setAtomPos(e,this.output.mol.atomX(e)-a,this.output.mol.atomY(e)-h)}if(r.length<=l.length)for(let t=0;t<r.length;t++){let e=r[t];this.output.mol.setAtomPos(e,this.output.mol.atomX(e)+a,this.output.mol.atomY(e)+h)}return}let l=0,r=0;if(i>0)l=e.atomX(i),r=e.atomY(i);else if(o>0){let t=e.bondFrom(o),s=e.bondTo(o);l=.5*(e.atomX(t)+e.atomX(s)),r=.5*(e.atomY(t)+e.atomY(s))}else{for(let t=0;t<this.subjectLength;t++)l+=e.atomX(this.subjectIndex[t]),r+=e.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;l*=t,r*=t}this.output.mol=e.clone();for(let e=0;e<this.subjectLength;e++){let s=this.output.mol.atomX(this.subjectIndex[e]),i=this.output.mol.atomY(this.subjectIndex[e]);this.output.mol.setAtomPos(this.subjectIndex[e],(s-l)*t+l,(i-r)*t+r)}}execRotate(t,e,i){t*=J;let o=this.input.mol;if(null!=e&&null!=i){this.output.mol=o.clone();let n=0==this.subjectLength?s.booleanArray(!0,o.numAtoms):this.subjectMask;return void jt.rotateAtoms(this.output.mol,n,e,i,t)}if(o.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");let n=0,l=0,r=this.subjectMask;if(this.input.currentAtom>0){if(n=o.atomX(this.input.currentAtom),l=o.atomY(this.input.currentAtom),!this.hasSelected){r=s.booleanArray(!1,o.numAtoms);let t=o.atomConnComp(this.input.currentAtom);for(let e=1;e<=o.numAtoms;e++)r[e-1]=o.atomConnComp(e)==t}if(1==s.maskCount(r)&&r[this.input.currentAtom-1])return void(this.errmsg="Component is isolated.")}else if(this.input.currentBond>0){let t=o.bondFrom(this.input.currentBond),e=o.bondTo(this.input.currentBond);if(n=.5*(o.atomX(t)+o.atomX(e)),l=.5*(o.atomY(t)+o.atomY(e)),!this.hasSelected){r=s.booleanArray(!1,o.numAtoms);let e=o.atomConnComp(t);for(let t=1;t<=o.numAtoms;t++)r[t-1]=o.atomConnComp(t)==e}}else if(0==this.subjectLength){let t=o.boundary();n=.5*(t.minX()+t.maxX()),l=.5*(t.minY()+t.maxY()),r=s.booleanArray(!0,o.numAtoms)}else{if(1==this.subjectLength)return void(this.errmsg="Component is isolated.");for(let t=0;t<this.subjectLength;t++)n+=o.atomX(this.subjectIndex[t]),l+=o.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;n*=t,l*=t}this.output.mol=o.clone(),jt.rotateAtoms(this.output.mol,r,n,l,t)}execBondDist(t){let e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");let s=this.input.mol.clone();if(s.bondInRing(e)){let i=s.bondFrom(e),o=s.bondTo(e),n=s.atomX(o)-s.atomX(i),l=s.atomY(o)-s.atomY(i),r=U(n,l),a=1/r,h=this.isSelected(i),u=this.isSelected(o),m=n*(t-r)*a,d=l*(t-r)*a;h&&!u?s.setAtomPos(i,s.atomX(i)-m,s.atomY(i)-d):u&&!h?s.setAtomPos(o,s.atomX(o)+m,s.atomY(o)+d):(s.setAtomPos(i,s.atomX(i)-.5*m,s.atomY(i)-.5*d),s.setAtomPos(o,s.atomX(o)+.5*m,s.atomY(o)+.5*d))}else{let[i,o,n]=this.mobileSide(e),l=s.atomX(o)-s.atomX(i),r=s.atomY(o)-s.atomY(i),a=U(l,r),h=1/a,u=l*(t-a)*h,m=r*(t-a)*h;for(let t of n)s.setAtomPos(t,s.atomX(t)-u,s.atomY(t)-m)}this.output.mol=s}execAlignAngle(t){let e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");let s=this.input.mol.clone();if(s.bondInRing(e))return void(this.errmsg="Cannot align a ring-bond.");let[i,o,n]=this.mobileSide(e),l=s.atomX(o),r=s.atomY(o),a=t-Math.atan2(s.atomY(i)-r,s.atomX(i)-l),h=Math.cos(a),u=Math.sin(a);for(let t of n){let e=s.atomX(t)-l,i=s.atomY(t)-r;s.setAtomPos(t,l+e*h-i*u,r+e*u+i*h)}this.output.mol=s}execAlignRegular(){if(0==this.input.currentBond)return void(this.errmsg="There must be a current bond.");let t=this.input.mol.clone(),e=t.bondFrom(this.input.currentBond),i=t.bondTo(this.input.currentBond),o=Math.atan2(t.atomY(i)-t.atomY(e),t.atomX(i)-t.atomX(e))*tt;o<0&&(o+=360);let n=30*Math.round(o/30);if(Math.abs(o-n)<.001)return;let l=(n-o)*J,r=this.input.selectedMask;if(s.allFalse(r)){let s=t.atomConnComp(e);for(let e=1;e<=t.numAtoms;e++)r[e-1]=s==t.atomConnComp(e)}let a=.5*(t.atomX(e)+t.atomX(i)),h=.5*(t.atomY(e)+t.atomY(i));for(let e=1;e<=t.numAtoms;e++)if(r[e-1]){let s=t.atomX(e)-a,i=t.atomY(e)-h,o=Math.atan2(i,s)+l,n=U(s,i);t.setAtomPos(e,a+n*Math.cos(o),h+n*Math.sin(o))}this.output.mol=t}execAdjustTorsion(t){if(0==this.input.currentAtom||3!=s.maskCount(this.input.selectedMask))return void(this.errmsg="Must be 3 selected atoms and a current atom.");let e=this.input.mol.clone(),i=this.input.currentAtom,o=[];for(let t=1;t<=e.numAtoms;t++)t!=i&&this.input.selectedMask[t-1]&&o.push(t);let n=e.findBond(i,o[0])>0?o.shift():e.findBond(i,o[1])>0?o.pop():0;if(0==n||0==e.findBond(n,o[0]))return void(this.errmsg="Selected atoms must be consecutive.");let l=o[0],r=e.atomX(n),a=e.atomY(n),h=Math.atan2(e.atomY(i)-a,e.atomX(i)-r),u=t-st(Math.atan2(e.atomY(l)-a,e.atomX(l)-r),h),m=[],d=[];if(0==e.atomRingBlock(i)||e.atomRingBlock(i)!=e.atomRingBlock(l)){let t=Bt.fromMolecule(e);t.removeEdge(n-1,i-1),t.removeEdge(n-1,l-1);let s=t.calculateComponents();for(let e=0;e<t.numNodes;e++)s[e]==s[i-1]?m.push(e+1):s[e]==s[l-1]&&d.push(e+1)}e.atomRingBlock(i)>0&&e.atomRingBlock(i)==e.atomRingBlock(n)&&(m=[i]),e.atomRingBlock(l)>0&&e.atomRingBlock(l)==e.atomRingBlock(n)&&(d=[l]),jt.rotateAtoms(e,s.idxMask(s.add(m,-1),e.numAtoms),r,a,-.5*u),jt.rotateAtoms(e,s.idxMask(s.add(d,-1),e.numAtoms),r,a,.5*u),this.output.mol=e}execMove(t,e,i){let o=this.subjectIndex;if(0==s.len(o)){if(0==t)return;o=[t]}this.output.mol=this.input.mol.clone();for(let t of o)this.output.mol.setAtomPos(t,this.output.mol.atomX(t)+e,this.output.mol.atomY(t)+i)}execRing(t,e,i){let o=t.length,n=s.numberArray(0,o),l=s.numberArray(0,o),r=this.input.mol.clone();for(let s=0;s<o;s++)n[s]=jt.atomAtPoint(r,t[s],e[s]),0==n[s]&&(n[s]=r.addAtom("C",t[s],e[s]));for(let t=0;t<o;t++){let e=t<o-1?t+1:0;l[t]=r.findBond(n[t],n[e]),0==l[t]&&(l[t]=r.addBond(n[t],n[e],1))}if(i){let t=s.numberArray(0,o),e=s.booleanArray(!1,o);for(let s=0;s<o;s++){t[s]=qt.ELEMENT_BONDING[r.atomicNumber(n[s])]+r.atomCharge(n[s]),r.atomHExplicit(n[s])!=ne.HEXPLICIT_UNKNOWN&&(t[s]-=r.atomHExplicit(n[s]));for(let e of r.atomAdjBonds(n[s]))t[s]-=r.bondOrder(e);r.bondOrder(l[s])>=2&&(e[s]=!0,s<o-1?(e[s]=!0,s++):e[0]=!0)}for(let s=0;s<o;s++){let i=s<o-1?s+1:0;e[s]||e[i]||t[s]>0&&t[i]>0&&(r.setBondOrder(l[s],2),e[s]=!0,e[i]=!0,t[s]--,t[i]--)}}this.output.mol=r}execTemplateFusion(t){let e=this.input.mol,s=new Ws(e,t,"");0==this.subjectLength?s.permuteNone():1==this.subjectLength?s.permuteAtom(this.subjectIndex[0]):2==this.subjectLength&&e.findBond(this.subjectIndex[0],this.subjectIndex[1])>0?s.permuteBond(this.subjectIndex[0],this.subjectIndex[1]):s.permuteMulti(this.subjectIndex);let i=[];for(let t of s.perms){let e={};e.mol=t.mol.toString(),e.display=t.display.toString(),e.molidx=t.molidx,e.temidx=t.temidx,e.srcidx=t.srcidx,i.push(e)}this.output.permutations=i}execAbbrevTempl(){}execAbbrevGroup(){if(!this.requireSubject())return;if(!this.checkAbbreviationReady())return;let t=Ht.convertToAbbrev(this.input.mol,s.notMask(this.subjectMask),"?");null!=t?(this.output.mol=t,this.zapSubject(),this.output.currentAtom=t.numAtoms):this.errmsg="Inline abbreviations must be terminal with exactly one attachment point."}execAbbrevFormula(){if(!this.requireSubject())return;if(!this.checkAbbreviationReady())return;let t=this.input.mol.clone();for(let e=1;e<=t.numAtoms;e++)t.setAtomHExplicit(e,t.atomHydrogens(e));let e=Ht.subgraphMask(t,this.subjectMask),i=Ht.molecularFormula(e,!0),o=Ht.convertToAbbrev(this.input.mol,s.notMask(this.subjectMask),i);null!=o?(this.output.mol=o,this.zapSubject(),this.output.currentAtom=o.numAtoms):this.errmsg="Inline abbreviations must be terminal with exactly one attachment point."}execAbbrevClear(){let t=[];for(let e of this.subjectIndex)Ht.hasAbbrev(this.input.mol,e)&&t.push(e);if(0==t.length)return void(this.errmsg="No abbreviations to clear.");let e=this.input.mol.clone();for(let s of t)Ht.clearAbbrev(e,s);this.output.mol=e}execAbbrevExpand(){let t=[];for(let e of this.subjectIndex)Ht.hasAbbrev(this.input.mol,e)&&t.push(e);if(0==t.length)return void(this.errmsg="No abbreviations to expand.");let e=this.input.mol.clone();for(let s of t)Ht.expandOneAbbrev(e,s,!0);this.output.mol=e,this.zapSubject()}execBondArtifact(t){if(!this.requireAtoms()||!this.requireSubject())return;let e=new Dt(this.input.mol.clone()),s=this.subjectIndex.slice(0),i=this.input.currentAtom;if(i>0&&s.indexOf(i)<0&&s.push(i),t==Ys.BondArtifactPath){if(!e.createPath(s))return void(this.errmsg="Path artifact not suitable.")}else if(t==Ys.BondArtifactRing){if(!e.createRing(s))return void(this.errmsg="Ring artifact not suitable.")}else if(t==Ys.BondArtifactArene){if(!e.createArene(s))return void(this.errmsg="Arene artifact not suitable.")}else if(t==Ys.BondArtifactClear&&!e.removeArtifact(s)){if(this.removePolymerBlock(s))return;return void(this.errmsg="No artifact removed.")}e.rewriteMolecule(),this.output.mol=e.mol}execPolymerBlock(){this.requireAtoms()&&this.requireSubject()&&this.owner&&this.owner.performPolymerBlock(this.subjectIndex)}execAddHydrogens(){let t=this.input.mol.clone();if(!this.requireAtoms())return;let e=this.subjectIndex;0==e.length&&(e=s.identity1(t.numAtoms));for(let s of e){let e=t.atomHydrogens(s);e>0&&Xt.placeAdditionalHydrogens(t,s,e)}t.numAtoms!=this.input.mol.numAtoms?this.output.mol=t:this.errmsg="Nothing needs to be added."}execRemoveHydrogens(){if(!this.requireAtoms())return;let t=this.input.mol,e=this.subjectMask;s.allFalse(e)&&(e=s.booleanArray(!0,t.numAtoms));let i=s.booleanArray(!0,t.numAtoms);for(let s=1;s<=t.numAtoms;s++)if(Ht.boringHydrogen(t,s)){let o=t.atomAdjList(s)[0];(e[s-1]||e[o-1])&&(i[s-1]=!1)}s.allTrue(i)?this.errmsg="Nothing to be deleted.":this.output.mol=Ht.subgraphMask(t,i)}execQueryClear(){if(!this.requireSubject())return;let t=this.input.mol.clone();const{currentBond:e}=this.input;if(e>0&&Bs.hasAnyQueryBond(t,e))return Bs.deleteQueryBondAll(t,e),void(this.output.mol=t);let s=!1;for(let e of this.subjectIndex)Bs.hasAnyQueryAtom(t,e)&&(Bs.deleteQueryAtomAll(t,e),s=!0);for(let e=1;e<=t.numBonds;e++)this.subjectMask[t.bondFrom(e)-1]&&this.subjectMask[t.bondTo(e)-1]&&Bs.hasAnyQueryBond(t,e)&&(Bs.deleteQueryBondAll(t,e),s=!0);s?this.output.mol=t:this.errmsg="No query terms to clear."}execQueryCopy(){if(!this.requireSubject())return;const{mol:t,currentBond:e}=this.input;if(e>0){if(!Bs.hasAnyQueryBond(t,e))return void(this.errmsg="Bond has no query terms.");let s=new ne;s.addAtom("*",0,0),s.addAtom("*",ne.IDEALBOND,0),s.addBond(1,2,1),s.setBondExtra(1,t.bondExtra(e).filter((t=>t.startsWith("q")))),this.toClipboard=s.toString()}else if(1==this.subjectLength){let e=this.subjectIndex[0];if(!Bs.hasAnyQueryAtom(t,e))return void(this.errmsg="Atom has no query terms.");let s=new ne;s.addAtom("*",0,0),s.setAtomExtra(1,t.atomExtra(e).filter((t=>t.startsWith("q")))),this.toClipboard=s.toString()}else this.errmsg="Subject has to be a single atom or bond."}execQueryPaste(){if(!this.requireSubject())return;let t=this.param.qmol;if(t){if(1==t.numAtoms&&"*"==t.atomElement(1)&&Bs.hasAnyQueryAtom(t,1)){let e=this.output.mol=this.input.mol.clone(),s=t.atomExtra(1).filter((t=>t.startsWith("q")));for(let t of this.subjectIndex){let i=e.atomExtra(t).filter((t=>t.startsWith("q")));e.setAtomExtra(t,[...i,...s])}return}if(2==t.numAtoms&&"*"==t.atomElement(1)&&"*"==t.atomElement(2)&&1==t.numBonds&&Bs.hasAnyQueryBond(t,1)){let e=this.output.mol=this.input.mol.clone(),s=t.bondExtra(1).filter((t=>t.startsWith("q")));for(let t=1;t<=e.numBonds;t++)if(this.subjectMask[e.bondFrom(t)-1]&&this.subjectMask[e.bondTo(t)-1]){let i=e.bondExtra(t).filter((t=>t.startsWith("q")));e.setBondExtra(t,[...i,...s])}return}}this.errmsg="Unable to paste query terms."}execQuerySetAtom(){}execQuerySetBond(){}execQueryBondAny(){if(!this.requireSubject())return;const{mol:t,currentBond:e}=this.input;let s=[];for(let e=1;e<=t.numBonds;e++)this.subjectMask[t.bondFrom(e)-1]&&this.subjectMask[t.bondTo(e)-1]&&s.push(e);if(0!=s.length){this.output.mol=this.input.mol.clone();for(let t of s)this.output.mol.setBondOrder(t,0),Bs.setQueryBondOrders(this.output.mol,t,[-1,0,1,2,3,4])}else this.errmsg="Must select at least one bond."}requireSubject(){return 0==this.subjectLength&&(this.errmsg="Subject required: current atom/bond or selected atoms."),this.subjectLength>0}requireAtoms(){return 0==this.input.mol.numAtoms&&(this.errmsg="There are no atoms."),this.input.mol.numAtoms>0}requireCurrent(){return 0!=this.input.currentAtom||0!=this.input.currentBond||(this.errmsg="There must be a current atom or bond.",!1)}requireSelected(){return this.hasSelected||(this.errmsg="No atoms are selected."),this.hasSelected}pickSelectedGroup(t,e){if(0==this.subjectLength)return 0;for(let s=0;s<t.length;s++){let i=t[s],o=!0;for(let t=0;t<i.length;t++)if(!this.subjectMask[i[t]-1]){o=!1;break}if(o)return s+=e,s<0?s+t.length:s>=t.length?s-t.length:s}for(let e=0;e<t.length;e++){let s=t[e];for(let t=0;t<s.length;t++)if(this.subjectMask[s[t]-1])return e}return 0}zapSubject(){this.output.currentAtom=0,this.output.currentBond=0,this.output.selectedMask=s.booleanArray(!1,this.input.mol.numAtoms)}performBondNew(t,e,s){let i=this.input.mol,o=Xt.calculateNewBondAngles(i,t,e);if(0==o.length&&(o=Xt.exitVectors(i,t)),0==o.length)return void(this.errmsg="Could not find a suitable geometry for a new substituent.");let n=0,l=0,r=0;for(let e=0;e<o.length;e++){let s=i.atomX(t)+ne.IDEALBOND*Math.cos(o[e]),a=i.atomY(t)+ne.IDEALBOND*Math.sin(o[e]),h=jt.congestionPoint(i,s,a);qt.ELEMENT_BLOCKS[i.atomicNumber(t)]<=2?h+=1e-8*Math.abs(et(o[e])):h+=1e-8*Math.abs(st(.5*Math.PI,o[e])),(0==e||h<r)&&(r=h,n=s,l=a)}this.output.mol=i.clone();let a=jt.atomAtPoint(this.output.mol,n,l);0==a&&(a=this.output.mol.addAtom("C",n,l)),Ht.addBond(this.output.mol,t,a,e,s)}performBondChange(t,e){let s=this.input.mol,i=[];for(let t=1;t<=s.numBonds;t++)this.subjectMask[s.bondFrom(t)-1]&&this.subjectMask[s.bondTo(t)-1]&&i.push(t);let o=e==ne.BONDTYPE_DECLINED||e==ne.BONDTYPE_INCLINED,n=o||e==ne.BONDTYPE_UNKNOWN,l=o;for(let o=0;o<i.length&&!l;o++){let n=i[o];(s.bondOrder(n)!=t&&e==ne.BONDTYPE_NORMAL||s.bondType(n)!=e)&&(l=!0)}if(l){this.output.mol=s.clone();for(let s=0;s<i.length;s++){let l=i[s],r=this.output.mol.bondFrom(l),a=this.output.mol.bondTo(l);o&&this.output.mol.bondType(l)==e?this.output.mol.setBondFromTo(l,a,r):this.output.mol.bondOrder(l)!=t||this.output.mol.bondType(l)!=e?n||t==this.output.mol.bondOrder(l)?this.output.mol.setBondType(l,e):this.output.mol.setBondOrder(l,t):o&&this.output.mol.setBondFromTo(l,a,r)}}else this.errmsg="No bond changes made."}performBondGeomAtom(t,e){let s=this.input.mol,i=s.atomAdjList(e).length,o=Xt.GEOM_ANGLES[t].length;if(i>o)return void(this.errmsg="The current atom has more bonds than does the selected geometry.");if(0==i)return void this.performBondNew(e,1,ne.BONDTYPE_NORMAL);if(i==o)return this.output.mol=Xt.refitAtomGeometry(s,e,t),void(null==this.output.mol&&(this.errmsg="Could not re-fit the atom geometry."));let n=jt.atomBondAngles(s,e),l=Xt.mapAngleSubstituent(t,n);if(null==l)return this.output.mol=Xt.refitAtomGeometry(s,e,t),void(null==this.output.mol&&(this.errmsg="Could not re-fit the atom geometry."));this.output.mol=s.clone();let r=Xt.pickNewAtomDirection(s,e,l),a=this.output.mol.atomX(e)+ne.IDEALBOND*Math.cos(r),h=this.output.mol.atomY(e)+ne.IDEALBOND*Math.sin(r),u=jt.atomAtPoint(this.output.mol,a,h);0==u&&(u=this.output.mol.addAtom("C",a,h)),Ht.addBond(this.output.mol,e,u,1)}performBondGeomBond(t,e){let s=this.input.mol,i=s.bondFrom(e),o=s.bondTo(e),n=s.atomAdjCount(i),l=s.atomAdjCount(o);if(n>1&&1==l);else{if(!(1==n&&l>1))return void(this.errmsg="One end of the bond must be terminal.");{let t=n;n=l,l=t}}let r=s.atomAdjList(i),a=s.atomX(i),h=s.atomY(i),u=s.atomX(o),m=s.atomY(o),d=[];for(let t=0;t<r.length;t++)r[t]!=o&&d.push(Math.atan2(s.atomY(r[t])-h,s.atomX(r[t])-a));let c=Xt.mapAngleSubstituent(t,d);if(null==c)return void(this.errmsg="No alternative geometries identified.");let p=K+1,f=0,g=0,b=Math.atan2(m-h,u-a),A=U(u-a,m-h);for(let t=0;t<c.length;t++){let e=st(c[t],b);if(e<0&&(e+=K),t>0&&e>p)continue;let i=a+A*Math.cos(e+b),o=h+A*Math.sin(e+b);jt.atomAtPoint(s,i,o)>0||(p=e,f=i,g=o)}p>K?this.errmsg="No alternative geometries identified.":(this.output.mol=s.clone(),this.output.mol.setAtomPos(o,f,g))}checkAbbreviationReady(){let t=0,e=this.input.mol,s=this.subjectMask;for(let i=1;i<=e.numBonds;i++){let o=e.bondFrom(i),n=e.bondTo(i),l=0;if(s[o-1]&&!s[n-1]&&Ht.hasAbbrev(e,o)||s[n-1]&&!s[o-1]&&Ht.hasAbbrev(e,n))return this.errmsg="Already an abbreviation.",!1;if(s[o-1]&&!s[n-1]?l=o:s[n-1]&&!s[o-1]&&(l=n),0==l||l==t);else{if(0!=t)return this.errmsg="The selected group must be terminal.",!1;t=l}}return!0}mobileSide(t){let{mol:e}=this.input,i=e.bondFrom(t),o=e.bondTo(t),n=Bt.fromMolecule(e);n.removeEdge(i-1,o-1);let l=[],r=[];for(let t of n.calculateComponentGroups())t.includes(i-1)&&(l=s.add(t,1)),t.includes(o-1)&&(r=s.add(t,1));let a=l.length*(e.atomRingBlock(i)>0?2:1),h=r.length*(e.atomRingBlock(o)>0?2:1),u=!1,m=!1;for(let t of l)if(this.isSelected(t)){u=!0;break}for(let t of r)if(this.isSelected(t)){m=!0;break}if(u&&!m);else if(m&&!u||h<a)return[o,i,r];return[i,o,l]}isSelected(t){let e=this.input.selectedMask;return!!e&&e[t-1]}removePolymerBlock(t){let e=new Yt(this.input.mol.clone());for(let s of e.getIDList()){let i=e.getUnit(s);for(let o of t)if(i.atoms.includes(o))return e.removeUnit(s),e.rewriteMolecule(),this.output.mol=e.mol,!0}return!1}}const $s=["He","Ar","Kr","Xe","Rn"],Qs=["Li","Na","K","Rb","Cs","Fr","Sc","Be","Mg","Ca","Sr","Ba","Ra","Y"],Ks=["B","Al","Si","Ga","Ge","As","Se","In","Sn","Sb","Te","Tl","Pb","Bi","Po","At"],Zs=["Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg"],Js=["La","Ce","Pr","Nd","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Ac","Th","Pa","U"],ti=["*","A","X","Y","Z","Q","M","T","E","L","R","R0","R1","R2","R3","R4","R5","R6","R7","R8"];var ei;!function(t){t[t.Main=0]="Main",t[t.Atom=1]="Atom",t[t.Bond=2]="Bond",t[t.Select=3]="Select",t[t.Move=4]="Move",t[t.Abbrev=5]="Abbrev",t[t.SBlock=6]="SBlock",t[t.PBlock=7]="PBlock",t[t.DBlock=8]="DBlock",t[t.FBlock=9]="FBlock",t[t.Noble=10]="Noble"}(ei||(ei={}));const si=[{id:"undo",imageFN:"MainUndo",helpText:"Undo last change.",mnemonic:"CmdOrCtrl+Z"},{id:"redo",imageFN:"MainRedo",helpText:"Cancel last undo.",mnemonic:"CmdOrCtrl+Shift+Z"},{id:"zoomin",imageFN:"MainZoomIn",helpText:"Zoom in.",mnemonic:"="},{id:"zoomout",imageFN:"MainZoomOut",helpText:"Zoom out.",mnemonic:"-"},{id:"zoomfit",imageFN:"MainZoomFit",helpText:"Show whole diagram onscreen.",mnemonic:""},{id:"selside",imageFN:"MainSelSide",helpText:"Select alternate side of current atom or bond.",mnemonic:"E"},{id:"selall",imageFN:"MainSelAll",helpText:"Select all atoms.",mnemonic:"Shift+A"},{id:"selnone",imageFN:"MainSelNone",helpText:"Clear selection.",mnemonic:"Shift+Q"},{id:"delete",imageFN:"MainDelete",helpText:"Delete selected atoms and bonds.",mnemonic:"D"},{id:"cut",imageFN:"MainCut",helpText:"Copy selection to clipboard, and remove.",mnemonic:"CmdOrCtrl+X"},{id:"copy",imageFN:"MainCopy",helpText:"Copy selection to clipboard.",mnemonic:"CmdOrCtrl+C"},{id:"paste",imageFN:"MainPaste",helpText:"Paste clipboard contents."},{id:"atom",imageFN:"MainAtom",helpText:"Open the Atom submenu.",isSubMenu:!0,mnemonic:"A"},{id:"bond",imageFN:"MainBond",helpText:"Open the Bond submenu.",isSubMenu:!0,mnemonic:"B"},{id:"select",imageFN:"MainSelect",helpText:"Open the Selection submenu.",isSubMenu:!0,mnemonic:"S"},{id:"move",imageFN:"MainMove",helpText:"Open the Move submenu.",isSubMenu:!0,mnemonic:"M"}],ii=[{id:"element:C",text:"C",helpText:"Change elements to Carbon.",mnemonic:"Shift+C"},{id:"element:N",text:"N",helpText:"Change elements to Nitrogen.",mnemonic:"Shift+N"},{id:"element:O",text:"O",helpText:"Change elements to Oxygen.",mnemonic:"Shift+O"},{id:"element:S",text:"S",helpText:"Change elements to Sulfur.",mnemonic:"Shift+S"},{id:"element:P",text:"P",helpText:"Change elements to Phosphorus.",mnemonic:"Shift+P"},{id:"element:H",text:"H",helpText:"Change elements to Hydrogen.",mnemonic:"Shift+H"},{id:"element:F",text:"F",helpText:"Change elements to Fluorine.",mnemonic:"Shift+F"},{id:"element:Cl",text:"Cl",helpText:"Change elements to Chlorine.",mnemonic:"Shift+L"},{id:"element:Br",text:"Br",helpText:"Change elements to Bromine.",mnemonic:"Shift+B"},{id:"element:I",text:"I",helpText:"Change elements to Iodine.",mnemonic:"Shift+I"},{id:"plus",imageFN:"AtomPlus",helpText:"Increase the atom charge.",mnemonic:"Shift+=",key:"+"},{id:"minus",imageFN:"AtomMinus",helpText:"Decrease the atom charge.",mnemonic:"Shift+-",key:"_"},{id:"abbrev",imageFN:"AtomAbbrev",helpText:"Open list of common labels.",isSubMenu:!0,mnemonic:""},{id:"sblock",imageFN:"AtomSBlock",helpText:"Open list of s-block elements.",isSubMenu:!0,mnemonic:""},{id:"pblock",imageFN:"AtomPBlock",helpText:"Open list of p-block elements.",isSubMenu:!0,mnemonic:""},{id:"dblock",imageFN:"AtomDBlock",helpText:"Open list of d-block elements.",isSubMenu:!0,mnemonic:""},{id:"fblock",imageFN:"AtomFBlock",helpText:"Open list of f-block elements.",isSubMenu:!0,mnemonic:""},{id:"noble",imageFN:"AtomNoble",helpText:"Open list of noble elements.",isSubMenu:!0,mnemonic:""}],oi=[{id:"one",imageFN:"BondOne",helpText:"Create or set bonds to single.",mnemonic:"1"},{id:"two",imageFN:"BondTwo",helpText:"Create or set bonds to double.",mnemonic:"2"},{id:"three",imageFN:"BondThree",helpText:"Create or set bonds to triple.",mnemonic:"3"},{id:"four",imageFN:"BondFour",helpText:"Create or set bonds to quadruple.",mnemonic:""},{id:"zero",imageFN:"BondZero",helpText:"Create or set bonds to zero-order.",mnemonic:"0"},{id:"inclined",imageFN:"BondUp",helpText:"Create or set bonds to inclined.",mnemonic:"5"},{id:"declined",imageFN:"BondDown",helpText:"Create or set bonds to declined.",mnemonic:"6"},{id:"squig",imageFN:"BondSquig",helpText:"Create or set bonds to unknown stereochemistry.",mnemonic:"4"},{id:"bondQAny",imageFN:"BondQAny",helpText:"Query bond that matches anything."},{id:"addtwo",imageFN:"BondAddTwo",helpText:"Add two new bonds to the subject atom.",mnemonic:"Shift+D"},{id:"insert",imageFN:"BondInsert",helpText:"Insert a methylene into the subject bond.",mnemonic:""},{id:"switch",imageFN:"BondSwitch",helpText:"Cycle through likely bond geometries.",mnemonic:""},{id:"rotate",imageFN:"BondRotate",helpText:"Rotate bond to invert substituent orientation.",mnemonic:""},{id:"linear",imageFN:"BondLinear",helpText:"Apply linear geometry.",mnemonic:"Shift+V"},{id:"trigonal",imageFN:"BondTrigonal",helpText:"Apply trigonal geometry.",mnemonic:"Shift+W"},{id:"tetra1",imageFN:"BondTetra1",helpText:"Apply tetrahedral geometry #1.",mnemonic:"Shift+E"},{id:"tetra2",imageFN:"BondTetra2",helpText:"Apply tetrahedral geometry #2.",mnemonic:"Shift+R"},{id:"sqplan",imageFN:"BondSqPlan",helpText:"Apply square planar geometry.",mnemonic:"Shift+T"},{id:"octa1",imageFN:"BondOcta1",helpText:"Apply octahedral geometry #1.",mnemonic:"Shift+Y"},{id:"octa2",imageFN:"BondOcta2",helpText:"Apply octahedral geometry #2.",mnemonic:"Shift+U"},{id:"metalligate",imageFN:"BondMetalLigate",helpText:"Arrange ligands around metal centre.",mnemonic:""},{id:"artifactpath",imageFN:"BondArtifactPath",helpText:"Add a path bond artifact.",mnemonic:""},{id:"artifactring",imageFN:"BondArtifactRing",helpText:"Add a ring bond artifact.",mnemonic:""},{id:"artifactarene",imageFN:"BondArtifactArene",helpText:"Add an arene bond artifact.",mnemonic:""},{id:"artifactclear",imageFN:"BondArtifactClear",helpText:"Remove a bond artifact.",mnemonic:""},{id:"polymer",imageFN:"BondPolymer",helpText:"Create a polymer block.",mnemonic:""}],ni=[{id:"selgrow",imageFN:"SelectionGrow",helpText:"Add adjacent atoms to selection.",mnemonic:""},{id:"selshrink",imageFN:"SelectionShrink",helpText:"Unselect exterior atoms.",mnemonic:""},{id:"selchain",imageFN:"SelectionChain",helpText:"Extend selection to non-ring atoms.",mnemonic:""},{id:"smallring",imageFN:"SelectionSmRing",helpText:"Extend selection to small rings.",mnemonic:""},{id:"ringblock",imageFN:"SelectionRingBlk",helpText:"Extend selection to ring blocks.",mnemonic:""},{id:"curelement",imageFN:"SelectionCurElement",helpText:"Select all atoms of current element type.",mnemonic:""},{id:"selprev",imageFN:"MainSelPrev",helpText:"Select previous connected component.",mnemonic:"["},{id:"selnext",imageFN:"MainSelNext",helpText:"Select next connected component.",mnemonic:"]"},{id:"toggle",imageFN:"SelectionToggle",helpText:"Toggle selection of current.",mnemonic:","},{id:"uncurrent",imageFN:"SelectionUncurrent",helpText:"Undefine current object.",mnemonic:"."},{id:"join",imageFN:"MoveJoin",helpText:"Overlapping atoms will be joined as one.",mnemonic:""},{id:"new",imageFN:"MainNew",helpText:"Clear the molecular structure.",mnemonic:""},{id:"inline",imageFN:"AtomInline",helpText:"Make selected atoms into an inline abbreviation.",mnemonic:"/"},{id:"formula",imageFN:"AtomFormula",helpText:"Make selected atoms into their molecule formula.",mnemonic:"\\"},{id:"expandabbrev",imageFN:"AtomExpandAbbrev",helpText:"Expand out the inline abbreviation.",mnemonic:"Shift+/",key:"/"},{id:"clearabbrev",imageFN:"AtomClearAbbrev",helpText:"Remove inline abbreviation.",mnemonic:"Shift+\\",key:"\\"}],li=[{id:"up",imageFN:"MoveUp",helpText:"Move subject atoms up slightly.",mnemonic:"Shift+Up",key:"ArrowUp"},{id:"down",imageFN:"MoveDown",helpText:"Move subject atoms down slightly.",mnemonic:"Shift+Down",key:"ArrowDown"},{id:"left",imageFN:"MoveLeft",helpText:"Move subject atoms slightly to the left.",mnemonic:"Shift+Left",key:"ArrowLeft"},{id:"right",imageFN:"MoveRight",helpText:"Move subject atoms slightly to the right.",mnemonic:"Shift+Right",key:"ArrowRight"},{id:"uplots",imageFN:"MoveUpLots",helpText:"Move subject atoms up somewhat.",mnemonic:""},{id:"downlots",imageFN:"MoveDownLots",helpText:"Move subject atoms down somewhat.",mnemonic:""},{id:"leftlots",imageFN:"MoveLeftLots",helpText:"Move subject atoms somewhat to the left.",mnemonic:""},{id:"rightlots",imageFN:"MoveRightLots",helpText:"Move subject atoms somewhat to the right.",mnemonic:""},{id:"upfar",imageFN:"MoveUpFar",helpText:"Move subject atoms far up.",mnemonic:""},{id:"downfar",imageFN:"MoveDownFar",helpText:"Move subject atoms far down.",mnemonic:""},{id:"leftfar",imageFN:"MoveLeftFar",helpText:"Move subject atoms far to the left.",mnemonic:""},{id:"rightfar",imageFN:"MoveRightFar",helpText:"Move subject atoms far to the right.",mnemonic:""},{id:"rotp01",imageFN:"MoveRotP01",helpText:"Rotate 1 counter-clockwise.",mnemonic:""},{id:"rotm01",imageFN:"MoveRotM01",helpText:"Rotate 1 clockwise.",mnemonic:""},{id:"rotp05",imageFN:"MoveRotP05",helpText:"Rotate 5 counter-clockwise.",mnemonic:""},{id:"rotm05",imageFN:"MoveRotM05",helpText:"Rotate 5 clockwise.",mnemonic:""},{id:"rotp15",imageFN:"MoveRotP15",helpText:"Rotate 15 counter-clockwise.",mnemonic:""},{id:"rotm15",imageFN:"MoveRotM15",helpText:"Rotate 15 clockwise.",mnemonic:""},{id:"rotp30",imageFN:"MoveRotP30",helpText:"Rotate 30 counter-clockwise.",mnemonic:"Shift+[",key:"{"},{id:"rotm30",imageFN:"MoveRotM30",helpText:"Rotate 30 clockwise.",mnemonic:"Shift+]",key:"}"},{id:"hflip",imageFN:"MoveHFlip",helpText:"Flip subject atoms horizontally.",mnemonic:"Shift+,",key:","},{id:"vflip",imageFN:"MoveVFlip",helpText:"Flip subject atoms vertically.",mnemonic:"Shift+.",key:"."},{id:"shrink",imageFN:"MoveShrink",helpText:"Decrease subject bond distances.",mnemonic:"Shift+Z"},{id:"grow",imageFN:"MoveGrow",helpText:"Increase subject bond distances.",mnemonic:"Shift+X"}];class ri extends Hs{constructor(t,e=ei.Main){super(),this.owner=t,this.cmdType=e}update(){if(this.cmdType==ei.Main)for(let t of si)this.buttons.push(t);else if(this.cmdType==ei.Atom)for(let t of ii)this.buttons.push(t);else if(this.cmdType==ei.Bond)for(let t of oi)this.buttons.push(t);else if(this.cmdType==ei.Select)for(let t of ni)this.buttons.push(t);else if(this.cmdType==ei.Move)for(let t of li)this.buttons.push(t);else this.cmdType==ei.Abbrev?this.populateElements(ti):this.cmdType==ei.SBlock?this.populateElements(Qs):this.cmdType==ei.PBlock?this.populateElements(Ks):this.cmdType==ei.DBlock?this.populateElements(Zs):this.cmdType==ei.FBlock?this.populateElements(Js):this.cmdType==ei.Noble&&this.populateElements($s)}populateElements(t){for(let e of t)this.buttons.push({id:`element:${e}`,text:e,helpText:`Change elements to ${e}.`})}hitButton(t){let e=0,s=null;if(t.startsWith("element:")){let i=t.substring(8);e=Ys.Element,s={element:i}}else"delete"==t?e=Ys.Delete:"undo"==t?this.owner.canUndo()?this.owner.performUndo():this.owner.showMessage("Nothing to undo."):"redo"==t?this.owner.canRedo()?this.owner.performRedo():this.owner.showMessage("Nothing to redo."):"cut"==t?e=Ys.Cut:"copy"==t?e=Ys.Copy:"paste"==t?this.owner.performPaste():"new"==t?e=Ys.Clear:"zoomfit"==t?this.owner.autoScale():"zoomout"==t?this.owner.zoom(.8):"zoomin"==t?this.owner.zoom(1.25):"selall"==t?e=Ys.SelectAll:"selnone"==t?e=Ys.SelectNone:"selprev"==t?e=Ys.SelectPrevComp:"selnext"==t?e=Ys.SelectNextComp:"selside"==t?e=Ys.SelectSide:"plus"==t?(e=Ys.Charge,s={delta:1}):"minus"==t?(e=Ys.Charge,s={delta:-1}):"one"==t?(e=Ys.BondOrder,s={order:1}):"two"==t?(e=Ys.BondOrder,s={order:2}):"three"==t?(e=Ys.BondOrder,s={order:3}):"four"==t?(e=Ys.BondOrder,s={order:4}):"zero"==t?(e=Ys.BondOrder,s={order:0}):"inclined"==t?(e=Ys.BondType,s={type:ne.BONDTYPE_INCLINED}):"declined"==t?(e=Ys.BondType,s={type:ne.BONDTYPE_DECLINED}):"squig"==t?(e=Ys.BondType,s={type:ne.BONDTYPE_UNKNOWN}):"linear"==t?(e=Ys.BondGeom,s={geom:Ft.Linear}):"trigonal"==t?(e=Ys.BondGeom,s={geom:Ft.Trigonal}):"tetra1"==t?(e=Ys.BondGeom,s={geom:Ft.Tetra1}):"tetra2"==t?(e=Ys.BondGeom,s={geom:Ft.Tetra2}):"sqplan"==t?(e=Ys.BondGeom,s={geom:Ft.SqPlan}):"octa1"==t?(e=Ys.BondGeom,s={geom:Ft.Octa1}):"octa2"==t?(e=Ys.BondGeom,s={geom:Ft.Octa2}):"switch"==t?e=Ys.BondSwitch:"rotate"==t?e=Ys.BondRotate:"connect"==t?e=Ys.Connect:"disconnect"==t?e=Ys.Disconnect:"metalligate"==t?e=Ys.MetalLigate:"artifactpath"==t?e=Ys.BondArtifactPath:"artifactring"==t?e=Ys.BondArtifactRing:"artifactarene"==t?e=Ys.BondArtifactArene:"artifactclear"==t?e=Ys.BondArtifactClear:"polymer"==t?e=Ys.PolymerBlock:"addtwo"==t?e=Ys.BondAddTwo:"insert"==t?e=Ys.BondInsert:"curelement"==t?e=Ys.SelectCurElement:"selgrow"==t?e=Ys.SelectGrow:"selshrink"==t?e=Ys.SelectShrink:"selprev"==t?e=Ys.SelectPrevComp:"selnext"==t?e=Ys.SelectNextComp:"selchain"==t?e=Ys.SelectChain:"smallring"==t?e=Ys.SelectSmRing:"ringblock"==t?e=Ys.SelectRingBlk:"toggle"==t?e=Ys.SelectToggle:"uncurrent"==t?e=Ys.SelectUnCurrent:"join"==t?e=Ys.Join:"inline"==t?e=Ys.AbbrevGroup:"formula"==t?e=Ys.AbbrevFormula:"clearabbrev"==t?e=Ys.AbbrevClear:"expandabbrev"==t?e=Ys.AbbrevExpand:"up"==t?(e=Ys.Nudge,s={dir:"up"}):"down"==t?(e=Ys.Nudge,s={dir:"down"}):"left"==t?(e=Ys.Nudge,s={dir:"left"}):"right"==t?(e=Ys.Nudge,s={dir:"right"}):"uplots"==t?(e=Ys.NudgeLots,s={dir:"up"}):"downlots"==t?(e=Ys.NudgeLots,s={dir:"down"}):"leftlots"==t?(e=Ys.NudgeLots,s={dir:"left"}):"rightlots"==t?(e=Ys.NudgeLots,s={dir:"right"}):"upfar"==t?(e=Ys.NudgeFar,s={dir:"up"}):"downfar"==t?(e=Ys.NudgeFar,s={dir:"down"}):"leftfar"==t?(e=Ys.NudgeFar,s={dir:"left"}):"rightfar"==t?(e=Ys.NudgeFar,s={dir:"right"}):"rotp01"==t?(e=Ys.Rotate,s={theta:1}):"rotm01"==t?(e=Ys.Rotate,s={theta:-1}):"rotp05"==t?(e=Ys.Rotate,s={theta:5}):"rotm05"==t?(e=Ys.Rotate,s={theta:-5}):"rotp15"==t?(e=Ys.Rotate,s={theta:15}):"rotm15"==t?(e=Ys.Rotate,s={theta:-15}):"rotp30"==t?(e=Ys.Rotate,s={theta:30}):"rotm30"==t?(e=Ys.Rotate,s={theta:-30}):"hflip"==t?(e=Ys.Flip,s={axis:"hor"}):"vflip"==t?(e=Ys.Flip,s={axis:"ver"}):"shrink"==t?(e=Ys.Scale,s={mag:1/1.1}):"grow"==t?(e=Ys.Scale,s={mag:1.1}):"bondQAny"==t?e=Ys.QueryBondAny:"atom"==t?this.buttonView.pushBank(new ri(this.owner,ei.Atom)):"bond"==t?this.buttonView.pushBank(new ri(this.owner,ei.Bond)):"select"==t?this.buttonView.pushBank(new ri(this.owner,ei.Select)):"move"==t?this.buttonView.pushBank(new ri(this.owner,ei.Move)):"abbrev"==t?this.buttonView.pushBank(new ri(this.owner,ei.Abbrev)):"sblock"==t?this.buttonView.pushBank(new ri(this.owner,ei.SBlock)):"pblock"==t?this.buttonView.pushBank(new ri(this.owner,ei.PBlock)):"dblock"==t?this.buttonView.pushBank(new ri(this.owner,ei.DBlock)):"fblock"==t?this.buttonView.pushBank(new ri(this.owner,ei.FBlock)):"noble"==t?this.buttonView.pushBank(new ri(this.owner,ei.Noble)):alert('Unhandled command: "'+t+'"');e>0&&new Gs(this.owner.getState(),e,s,this.owner).execute()}claimKey(t){for(let e of[si,ii,oi,ni,li])for(let s of e)if(Hs.matchKey(t,s.mnemonic,s.key))return this.hitButton(s.id),!0;return!1}}class ai{constructor(t,e,s){this.state=t,this.sketcher=e,this.proxyClip=s}populate(){const{state:t,sketcher:e}=this;let i=[];(e.canUndo()||e.canRedo())&&(e.canUndo()&&i.push({label:"Undo",accelerator:"CmdOrCtrl+Z",click:()=>e.performUndo()}),e.canRedo()&&i.push({label:"Redo",accelerator:"CmdOrCtrl+Shift+Z",click:()=>e.performRedo()}),i.push(null)),(t.currentAtom>0||t.currentBond>0)&&i.push({label:"Edit",accelerator:"Enter",click:()=>e.editCurrent()}),this.maybeAppend(i,"Delete","D",Ys.Delete),this.maybeAppend(i,"Cut","CmdOrCtrl+X",Ys.Cut),this.maybeAppend(i,"Copy","CmdOrCtrl+C",Ys.Copy),this.proxyClip.canAlwaysGet()&&i.push({label:"Paste",accelerator:"CmdOrCtrl+V",click:()=>e.performPaste()}),this.maybeAppend(i,"Charge +","Shift+=",Ys.Charge,{delta:1}),this.maybeAppend(i,"Charge -","Shift+-",Ys.Charge,{delta:-1}),this.maybeAppend(i,"Bond Order 0","0",Ys.BondOrder,{order:0}),this.maybeAppend(i,"Bond Order 1","1",Ys.BondOrder,{order:1}),this.maybeAppend(i,"Bond Order 2","2",Ys.BondOrder,{order:2}),this.maybeAppend(i,"Bond Order 3","3",Ys.BondOrder,{order:3}),this.maybeAppend(i,"Bond Order 4",null,Ys.BondOrder,{order:4}),this.maybeAppend(i,"Unknown Stereochemistry","4",Ys.BondType,{type:ne.BONDTYPE_UNKNOWN}),this.maybeAppend(i,"Bond Wedge Up","5",Ys.BondType,{type:ne.BONDTYPE_INCLINED}),this.maybeAppend(i,"Bond Wedge Down","6",Ys.BondType,{type:ne.BONDTYPE_DECLINED}),this.maybeAppend(i,"Switch Geometry",null,Ys.BondSwitch),this.maybeAppend(i,"Add Two Bonds","Shift+D",Ys.BondAddTwo),this.maybeAppend(i,"Insert Atom",null,Ys.BondInsert),this.maybeAppend(i,"Join Atoms",null,Ys.Join),this.maybeAppend(i,"Abbreviate Group","/",Ys.AbbrevGroup),this.maybeAppend(i,"Abbreviate Formula","\\",Ys.AbbrevFormula),this.maybeAppend(i,"Clear Abbreviation","Shift+\\",Ys.AbbrevClear),this.maybeAppend(i,"Expand Abbreviation","Shift+/",Ys.AbbrevExpand);let o=this.rotateSubMenu();s.notBlank(o)&&i.push({label:"Rotate",subMenu:o});let n=this.querySubMenu();s.notBlank(n)&&i.push({label:"Query",subMenu:n});let l=new Yt(t.mol);for(let s of l.getUnits()){let o=t.currentAtom,n=0;if(t.currentBond>0&&([o,n]=t.mol.bondFromTo(t.currentBond)),s.atoms.includes(o)||s.atoms.includes(n)){let t="Polymer Block ("+s.atoms.length+" atom"+(1==s.atoms.length?"":"s")+")";i.push({label:t,click:()=>e.performPolymerBlock(s.atoms)})}}return i.length>0&&i.push(null),i.push({label:"Scale to Fit",click:()=>e.autoScale()}),i.push({label:"Zoom In",accelerator:"=",click:()=>e.zoom(1.25)}),i.push({label:"Zoom Out",accelerator:"-",click:()=>e.zoom(.8)}),i}maybeAppend(t,e,s,i,o=null){let n=new Gs(this.state,i,o);n.execute(),(n.output.mol||n.toClipboard)&&t.push({label:e,accelerator:s,click:()=>{this.sketcher.setState(n.output,!0),n.toClipboard&&this.proxyClip.setString(n.toClipboard)}})}rotateSubMenu(){let t=[];return this.maybeAppend(t,"Bond",null,Ys.BondRotate),this.maybeAppend(t,"+1 ",null,Ys.Rotate,{theta:1}),this.maybeAppend(t,"-1 ",null,Ys.Rotate,{theta:-1}),this.maybeAppend(t,"+5 ",null,Ys.Rotate,{theta:5}),this.maybeAppend(t,"-5 ",null,Ys.Rotate,{theta:-5}),this.maybeAppend(t,"+15 ",null,Ys.Rotate,{theta:15}),this.maybeAppend(t,"-15 ",null,Ys.Rotate,{theta:-15}),this.maybeAppend(t,"+30 ","Shift+[",Ys.Rotate,{theta:30}),this.maybeAppend(t,"-30 ","Shift+]",Ys.Rotate,{theta:-30}),this.maybeAppend(t,"H-Flip","Shift+,",Ys.Flip,{axis:"hor"}),this.maybeAppend(t,"V-Flip","Shift+.",Ys.Flip,{axis:"ver"}),this.maybeAppend(t,"Align",null,Ys.AlignRegular),t}querySubMenu(){let t=[];return this.maybeAppend(t,"Clear",null,Ys.QueryClear),this.maybeAppend(t,"Copy",null,Ys.QueryCopy),t}}var hi,ui,mi,di;!function(t){t[t.None=0]="None",t[t.Press=1]="Press",t[t.Lasso=2]="Lasso",t[t.Pan=3]="Pan",t[t.Zoom=4]="Zoom",t[t.Rotate=5]="Rotate",t[t.Move=6]="Move",t[t.Erasor=7]="Erasor",t[t.Atom=8]="Atom",t[t.Bond=9]="Bond",t[t.Charge=10]="Charge",t[t.Ring=11]="Ring"}(hi||(hi={})),function(t){t[t.None=0]="None",t[t.Stereochemistry=1]="Stereochemistry",t[t.MappingNumber=2]="MappingNumber",t[t.AtomIndex=3]="AtomIndex"}(ui||(ui={}));class ci extends zs{constructor(){super(),this.mol=null,this.policy=null,this.offsetX=0,this.offsetY=0,this.pointScale=1,this.viewOpt={decoration:ui.Stereochemistry,showOxState:!0,showQuery:!0,showArtifacts:!0},this.width=0,this.height=0,this.border=8421504,this.borderRadius=4,this.background=16316664,this.canvasUnder=null,this.canvasMolecule=null,this.canvasOver=null,this.divMessage=null,this.layout=null,this.metavec=null,this.stereo=null,this.guidelines=null,this.filthy=!1,this.dragType=hi.None,this.currentAtom=0,this.currentBond=0,this.hoverAtom=0,this.hoverBond=0,this.selectedMask=null,this.opAtom=0,this.opBond=0,this.opBudged=!1,this.opShift=!1,this.opCtrl=!1,this.opAlt=!1,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.clickX=0,this.clickY=0,this.mouseX=0,this.mouseY=0,this.dragGuides=null,this.templatePerms=null,this.currentPerm=0,this.fusionBank=null,this.cursorWatermark=0,this.cursorDX=0,this.cursorDY=0,this.toolAtomSymbol="",this.toolBondOrder=0,this.toolBondType=0,this.toolChargeDelta=0,this.toolRingArom=!1,this.toolRingFreeform=!1,this.toolRotateIncr=0,this.redrawCacheKey="",this.abbrevPolicy=Ye.defaultBlackOnWhite(),this.abbrevPolicy.data.foreground=13684944,this.abbrevPolicy.data.atomCols=s.numberArray(13684944,this.abbrevPolicy.data.atomCols.length)}render(t){if(!this.width||!this.height)throw"Sketcher.render called without width and height";super.render(t),this.container=b("<div/>").appendTo(this.contentDOM),this.container.css({position:"relative",width:this.width+"px",height:this.height+"px"}),this.container.css({"background-color":B(this.background)}),this.border!=Ge.NOCOLOUR&&(this.container.css({border:"1px solid "+B(this.border)}),this.container.css({"border-radius":this.borderRadius+"px"})),this.container.css({outline:"none"}),this.container.attr({tabindex:"0"});let e={position:"absolute",left:"0",top:"0",width:`${this.width}px`,height:`${this.height}`,"pointer-events":"none"};this.divInfo=b("<div/>").appendTo(this.container).css({position:"absolute",left:"0",top:"0","pointer-events":"none"}),this.canvasUnder=b("<canvas/>").appendTo(this.container).css(e),this.canvasMolecule=b("<canvas/>").appendTo(this.container).css(e),this.canvasOver=b("<canvas/>").appendTo(this.container).css(e),this.divMessage=b("<div/>").appendTo(this.container).css(e),this.divMessage.css({"text-align":"center","vertical-align":"middle","font-weight":"bold","font-size":"120%"})}getState(){return{mol:this.mol.clone(),currentAtom:this.currentAtom,currentBond:this.currentBond,selectedMask:null==this.selectedMask?null:this.selectedMask.slice(0)}}getSelected(t){return!(null==this.selectedMask||t>this.selectedMask.length)&&this.selectedMask[t-1]}getLassoed(t){return!(null==this.lassoMask||t>this.lassoMask.length)&&this.lassoMask[t-1]}scale(){return this.pointScale}angToX(t){return t*this.pointScale+this.offsetX}angToY(t){return t*-this.pointScale+this.offsetY}xToAng(t){return(t-this.offsetX)/this.pointScale}yToAng(t){return(t-this.offsetY)/-this.pointScale}scaleToAng(t){return t/this.pointScale}angToScale(t){return t*this.pointScale}yIsUp(){return!1}measureText(t,e){return Ue.main.measureText(t,e)}delayedRedraw(){null!=this.canvasMolecule&&(this.filthy=!0,window.setTimeout((()=>{this.filthy&&this.redraw()}),10))}layoutMolecule(){let t=this.mol;this.hoverAtom>0&&Ht.hasAbbrev(t,this.hoverAtom)&&(t=t.clone(),t.setAtomElement(this.hoverAtom,""),t.setAtomCharge(this.hoverAtom,0),t.setAtomUnpaired(this.hoverAtom,0),Ht.clearAbbrev(t,this.hoverAtom));let e=this.sketchEffects(t);this.layout=new He(t,this,this.policy,e),this.layout.setWantArtifacts(this.viewOpt.showArtifacts),this.layout.arrange()}redrawMetaVector(){if(this.metavec=new Ge,new $e(this.layout,this.metavec).draw(),this.hoverAtom>0&&Ht.hasAbbrev(this.mol,this.hoverAtom)){let t=Ht.getAbbrev(this.mol,this.hoverAtom);this.orientAbbreviation(this.hoverAtom,t),this.abbrevPolicy.data.pointScale=this.policy.data.pointScale;let e=new He(t,this,this.abbrevPolicy,new Xe);e.arrange(),new $e(e,this.metavec).draw()}}redraw(){this.filthy=!1,this.redrawInfo(),this.redrawUnder(),this.redrawMolecule(),this.redrawOver()}redrawInfo(){let t=JSON.stringify([this.width,this.height,this.mol.toString()]);if(t==this.redrawCacheKey)return;if(this.redrawCacheKey=t,this.divInfo.empty(),this.divInfo.css({visibility:"hidden",left:"0",top:"0"}),0==this.mol.numAtoms)return;let e=b("<div/>").appendTo(this.divInfo);e.css({display:"inline-block","text-align":"right","font-family":"sans-serif","font-size":"80%",color:"#C0C0C0"});let s=Ht.molecularFormula(this.mol,["<sub>","</sub>","<sup>","</sup>"]),i=0;for(let t=1;t<=this.mol.numAtoms;t++)i+=this.mol.atomCharge(t);-1==i?s+="<sup>-</sup>":i<-1?s+=`<sup>${i}</sup>`:1==i?s+="<sup>+</sup>":i>1&&(s+=`<sup>+${i}</sup>`),s+="<br>"+Ht.molecularWeight(this.mol).toFixed(2),e.setHTML(s),setTimeout((()=>{let t=e.width(),s=e.height();_(this.divInfo,this.width-t-1,1,t,s),this.divInfo.css({visibility:"visible"})}),1)}redrawUnder(){let t=14737632,e=10526880,s=8421504,i=12632256,o=13684944,n=pt();this.canvasUnder.elCanvas.width=this.width*n,this.canvasUnder.elCanvas.height=this.height*n,this.canvasUnder.css({width:`${this.width}px`,height:`${this.height}px`});let l=this.canvasUnder.elCanvas.getContext("2d");if(l.save(),l.scale(n,n),l.clearRect(0,0,this.width,this.height),this.hoverAtom>0){let e=new Yt(this.mol).getUnits();for(let t of e)t.atoms.includes(this.hoverAtom)&&this.drawPolymerUnit(l,t,e);let s=0;this.hoverAtom==this.currentAtom&&(s+=.1),this.getSelected(this.hoverAtom)&&(s+=.1),this.currentBond>0&&(this.mol.bondFrom(this.currentBond)==this.hoverAtom||this.mol.bondTo(this.currentBond)==this.hoverAtom)&&(s+=.1),this.drawAtomShade(l,this.hoverAtom,t,-1,s)}if(this.hoverBond>0){let e=this.mol.bondFrom(this.hoverBond),s=this.mol.bondTo(this.hoverBond),i=new Yt(this.mol).getUnits();for(let t of i)t.atoms.includes(e)&&t.atoms.includes(s)&&this.drawPolymerUnit(l,t,i);let o=0;this.hoverBond==this.currentBond&&(o+=.1),this.getSelected(e)&&this.getSelected(s)&&(o+=.1),this.drawBondShade(l,this.hoverBond,t,-1,o)}for(let t=1;t<=this.mol.numBonds;t++){let e=t==this.currentBond?.1:0,s=this.mol.bondFrom(t),n=this.mol.bondTo(t),r=this.getSelected(s),a=this.getSelected(n),h=this.getLassoed(s),u=this.getLassoed(n);r&&a?this.drawBondShade(l,t,i,-1,e):(r||h)&&(a||u)&&this.drawBondShade(l,t,o,-1,e)}for(let t=1;t<=this.mol.numAtoms;t++){let e=this.currentAtom==t?.1:0;this.getSelected(t)?this.drawAtomShade(l,t,i,-1,e):this.getLassoed(t)&&this.drawAtomShade(l,t,o,-1,e)}if(this.currentAtom>0&&this.drawAtomShade(l,this.currentAtom,e,s,0),this.currentBond>0&&this.drawBondShade(l,this.currentBond,e,s,0),(this.dragType==hi.Move||this.dragType==hi.Atom&&this.opAtom>0||this.dragType==hi.Bond)&&null!=this.dragGuides&&this.dragGuides.length>0)for(let t of this.dragGuides)for(let e=0;e<t.x.length;e++){let s=this.policy.data.lineSize*this.pointScale;l.strokeStyle="#C0C0C0",l.lineWidth=s,mt(l,t.sourceX,t.sourceY,t.destX[e],t.destY[e]),l.beginPath(),l.ellipse(t.destX[e],t.destY[e],2*s,2*s,0,0,K,!1),l.fillStyle="#C0C0C0",l.fill()}if(this.dragType==hi.Ring){let[t,e]=this.determineFauxRing(),s=null==t?0:t.length;if(s>0){let i=this.pointScale,o=this.policy.data.lineSize*i;l.strokeStyle="#C0C0C0",l.lineWidth=o;for(let i=0;i<s;i++){let o=i<s-1?i+1:0;mt(l,this.angToX(t[i]),this.angToY(e[i]),this.angToX(t[o]),this.angToY(e[o]))}if(this.toolRingArom){let i=0,o=0;for(let n=0;n<s;n++)i+=t[n],o+=e[n];i/=s,o/=s;let n=0;for(let l=0;l<s;l++)n+=U(t[l]-i,e[l]-o);n=this.angToScale(.5*n/s),l.beginPath(),l.ellipse(this.angToX(i),this.angToY(o),n,n,0,0,K,!1),l.stroke()}}}l.restore()}redrawMolecule(){let t=pt();this.canvasMolecule.elCanvas.width=this.width*t,this.canvasMolecule.elCanvas.height=this.height*t,this.canvasMolecule.css({width:`${this.width}px`,height:`${this.height}px`});let e=this.canvasMolecule.elCanvas.getContext("2d");if(e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height),null!=this.metavec&&this.metavec.renderContext(e),null!=this.templatePerms){let t=this.templatePerms[this.currentPerm];null!=t.metavec&&t.metavec.renderContext(e)}e.restore()}redrawOver(){let t=pt();this.canvasOver.elCanvas.width=this.width*t,this.canvasOver.elCanvas.height=this.height*t,this.canvasOver.css({width:`${this.width}px`,height:`${this.height}px`});let e=this.canvasOver.elCanvas.getContext("2d");if(e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height),(this.dragType==hi.Lasso||this.dragType==hi.Erasor)&&this.lassoX.length>1){let t=this.dragType==hi.Erasor,s=new Path2D;s.moveTo(this.lassoX[0],this.lassoY[0]);for(let t=1;t<this.lassoX.length;t++)s.lineTo(this.lassoX[t],this.lassoY[t]);s.closePath(),e.fillStyle=B(t?3506372608:4026531840),e.fill(s),e.strokeStyle=t?"#804040":"#808080",e.lineWidth=.5,e.stroke(s)}if(this.dragType==hi.Rotate){let[t,s,i,o]=this.determineDragTheta(),n=this.pointScale,l=this.policy.data.lineSize*n;e.strokeStyle="#E0E0E0",e.lineWidth=.5*l,mt(e,t,s,t+o,s),e.strokeStyle="#808080",e.lineWidth=l,mt(e,t,s,t+o*Math.cos(i),s+o*Math.sin(i)),e.beginPath(),e.ellipse(t,s,2*l,2*l,0,0,K,!1),e.fillStyle="#808080",e.fill();for(let o of this.subjectAtoms(!0,!1)){let n=this.angToX(this.mol.atomX(o)),r=this.angToY(this.mol.atomY(o)),a=Math.atan2(r-s,n-t),h=U(n-t,r-s),u=t+h*Math.cos(a+i),m=s+h*Math.sin(a+i);e.beginPath(),e.ellipse(u,m,2*l,2*l,0,0,K,!1),e.strokeStyle="black",e.lineWidth=.5,e.stroke()}}if(this.dragType==hi.Move){let[t,s]=this.determineMoveDelta(),i=this.pointScale,o=this.policy.data.lineSize*i;for(let i of this.subjectAtoms(!1,!0)){let n=this.angToX(this.mol.atomX(i)),l=this.angToY(this.mol.atomY(i));e.beginPath(),e.ellipse(n+t,l+s,2*o,2*o,0,0,K,!1),e.strokeStyle="black",e.lineWidth=.5,e.stroke()}}if(this.dragType==hi.Atom&&this.opAtom>0||this.dragType==hi.Bond){let t=this.dragType==hi.Atom?this.toolAtomSymbol:"C",s=this.dragType==hi.Bond?this.toolBondOrder:1,i=this.dragType==hi.Bond?this.toolBondType:ne.BONDTYPE_NORMAL;this.drawOriginatingBond(e,t,s,i)}this.viewOpt.showQuery&&this.drawQueryFeatures(e),e.restore()}subjectAtoms(t=!1,e=!1){let s=[];if(null!=this.selectedMask){for(let t=0;t<this.selectedMask.length;t++)this.selectedMask[t]&&s.push(t+1);if(s.length>0)return s}if(this.currentAtom>0?s.push(this.currentAtom):this.currentBond>0&&(s.push(this.mol.bondFrom(this.currentBond)),s.push(this.mol.bondTo(this.currentBond))),e&&0==s.length&&this.opAtom>0&&s.push(this.opAtom),t&&0==s.length)for(let t=1;t<=this.mol.numAtoms;t++)s.push(t);return s}updateLasso(t,e){if(this.dragType!=hi.Lasso&&this.dragType!=hi.Erasor)return;(t<0||e<0||t>this.width||e>this.height)&&(this.dragType=hi.None,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.delayedRedraw());let i=s.len(this.lassoX);i>0&&this.lassoX[i-1]==t&&this.lassoY[i-1]==e||(this.lassoX.push(t),this.lassoY.push(e),this.calculateLassoMask(),this.delayedRedraw())}calculateLassoMask(){this.lassoMask=new Array(this.mol.numAtoms);for(let t=0;t<this.mol.numAtoms;t++)this.lassoMask[t]=!1;for(let t=0;t<this.layout.numPoints();t++){let e=this.layout.getPoint(t);0!=e.anum&&(this.lassoMask[e.anum-1]=a.pointInPolygon(e.oval.cx,e.oval.cy,this.lassoX,this.lassoY))}}drawAtomShade(t,e,s,i,o){if(null==this.layout)return;let n=null;for(let t=0;t<this.layout.numPoints();t++)if(this.layout.getPoint(t).anum==e){n=this.layout.getPoint(t);break}if(null==n)return;let l=.2*this.pointScale,r=(V(l),n.oval.cx),a=n.oval.cy,h=Math.max(l,Math.max(n.oval.rw,n.oval.rh))+(.1+o)*this.pointScale;-1!=s&&(t.beginPath(),t.ellipse(r,a,h,h,0,0,K,!0),t.fillStyle=B(s),t.fill()),-1!=i&&(t.beginPath(),t.ellipse(r,a,h,h,0,0,K,!0),t.strokeStyle=B(i),t.lineWidth=1,t.stroke())}drawBondShade(t,e,s,i,o){if(null==this.layout)return;let n=0,l=0,r=0,a=0,h=0,u=0;for(let t=0;t<this.layout.numLines();t++){let s=this.layout.getLine(t);s.bnum==e&&(n+=s.line.x1,l+=s.line.y1,r+=s.line.x2,a+=s.line.y2,h++,u+=s.size+(.2+o)*this.pointScale)}if(0==h)return;let m=1/h;u*=m,n*=m,l*=m,r*=m,a*=m;let d=r-n,c=a-l,p=1/U(d,c);d*=p,c*=p;let f,g,b=c,A=-d,y=new Path2D,E=.8;y.moveTo(n+b*u,l+A*u),f=n+(b*u-d*u)*E,g=l+(A*u-c*u)*E,y.quadraticCurveTo(f,g,n-d*u,l-c*u),f=n+(-b*u-d*u)*E,g=l+(-A*u-c*u)*E,y.quadraticCurveTo(f,g,n-b*u,l-A*u),y.lineTo(r-b*u,a-A*u),f=r+(-b*u+d*u)*E,g=a+(-A*u+c*u)*E,y.quadraticCurveTo(f,g,r+d*u,a+c*u),f=r+(b*u+d*u)*E,g=a+(A*u+c*u)*E,y.quadraticCurveTo(f,g,r+b*u,a+A*u),y.closePath(),-1!=s&&(t.beginPath(),t.fillStyle=B(s),t.fill(y)),-1!=i&&(t.beginPath(),t.strokeStyle=B(i),t.lineWidth=1,t.stroke(y))}drawOriginatingBond(t,e,s,i){let o=this.clickX,n=this.clickY;if(this.opAtom>0)o=this.angToX(this.mol.atomX(this.opAtom)),n=this.angToY(this.mol.atomY(this.opAtom));else if(this.opBond>0){let[t,e]=this.mol.bondFromTo(this.opBond);o=this.angToX(.5*(this.mol.atomX(t)+this.mol.atomX(e))),n=this.angToY(.5*(this.mol.atomY(t)+this.mol.atomY(e)))}let l=this.mouseX,r=this.mouseY,a=this.snapToGuide(l,r),h=!1;a&&([l,r,h]=a);let u=this.pointScale;if(t.strokeStyle=h?"#4040FF":"#808080",t.lineWidth=this.policy.data.lineSize*u*(h?1.5:1),mt(t,o,n,l,r),"C"!=e){let s=this.policy.data.fontSize*u;t.font=ct(s);let i=t.measureText(e);t.fillStyle="#808080",t.fillText(e,l-.5*i.width,r+.5*s)}}drawQueryFeatures(t){const{layout:e,mol:s}=this;let i=[];for(let t=1;t<=s.numAtoms;t++)if(Bs.hasAnyQueryAtom(s,t)){let o=[];for(let e of s.atomExtra(t))e.startsWith("q")&&o.push(e);let n=e.getPoint(t-1);i.push({txt:o.join(","),x:n.oval.cx+n.oval.rw,y:n.oval.cy})}for(let t=1;t<=s.numBonds;t++)if(Bs.hasAnyQueryBond(s,t)){let o=[];for(let e of s.bondExtra(t))e.startsWith("q")&&o.push(e);let n=0,l=0,r=0;for(let s of e.getLines())s.bnum==t&&(n+=2,l+=s.line.x1+s.line.x2,r+=s.line.y1+s.line.y2);i.push({txt:o.join(","),x:l/n,y:r/n})}let o=.7*this.policy.data.fontSize*this.pointScale;for(let e of i)t.font=ct(o),t.fillStyle="#FF40C0",t.fillText(e.txt,e.x,e.y)}drawPolymerUnit(t,e,i){const{mol:o,layout:n}=this;let l=[],r=[],h=this.pointScale;for(let t of e.atoms){let e=n.getPoint(t-1),s=Math.max(.5*h,Math.max(e.oval.rw,e.oval.rh));const i=36,o=K/i;for(let t=0;t<i;t++){let i=t*o;l.push(e.oval.cx+s*Math.cos(i)),r.push(e.oval.cy+s*Math.sin(i))}}let u=[],m=[],d=[];for(let t=1;t<=o.numBonds;t++){let s=o.bondFrom(t),i=o.bondTo(t),a=e.atoms.includes(s),c=e.atoms.includes(i);if(!a&&!c)continue;c?a||(u.push(t),m.push(i),d.push(s)):(u.push(t),m.push(s),d.push(i));let p=n.getPoint(s-1),f=n.getPoint(i-1),g=p.oval.cx,b=p.oval.cy,A=f.oval.cx,y=f.oval.cy;a?c||([A,y]=[.5*(g+A),.5*(b+y)]):[g,b]=[.5*(g+A),.5*(b+y)];let E=A-g,M=y-b,T=U(E,M),x=W(T),v=M*x*.3*h,C=-E*x*.3*h,N=Math.ceil(2*T/h)+1,S=Math.ceil(2*U(v,C)/h)+1;for(let t=0;t<=N;t++)l.push(g-v+E*t/N),r.push(b-C+M*t/N),l.push(g+v+E*t/N),r.push(b+C+M*t/N);for(let t=1;t<S;t++)l.push(g-v+2*v*t/S),r.push(b-C+2*C*t/S),l.push(A-v+2*v*t/S),r.push(y-C+2*C*t/S)}let[c,p]=a.outlinePolygon(l,r,.5*h),f=new Path2D;f.moveTo(c[0],p[0]);for(let t=1;t<c.length;t++)f.lineTo(c[t],p[t]);f.closePath(),t.save(),t.fillStyle="#F9EFFF",t.fill(f),t.strokeStyle="#C0C0C0",t.lineWidth=1,t.stroke(f),t.restore();let g=[],b=[],A=[];if(4==s.len(e.bondConn))b.push([m[u.indexOf(e.bondConn[0])],m[u.indexOf(e.bondConn[2])]]),b.push([m[u.indexOf(e.bondConn[1])],m[u.indexOf(e.bondConn[3])]]);else if(2==s.len(u)&&null!=e.connect)e.connect!=_t.HeadToTail&&e.connect!=_t.Random||b.push([m[0],m[1]]),e.connect!=_t.HeadToHead&&e.connect!=_t.Random||(g.push(m[0]),g.push(m[1]));else for(let t of u){let n=o.bondFrom(t),l=o.bondTo(t);e.atoms.includes(l)&&([n,l]=[l,n]);let r=e.bondIncl.get(t),a=e.bondExcl.get(t),h=o.atomElement(l)!=Pt;for(let t of h?[e]:i)for(let i of t.atoms){let l=!1;for(let e of o.atomAdjList(i))if(!t.atoms.includes(e)){l=!0;break}if(l){if(s.notBlank(r)){let e=t.atomName.get(i),s=!1;if(e)for(let t of e)s=s||r.includes(t);if(!s)continue}if(s.notBlank(a)){let e=t.atomName.get(i),s=!1;if(e)for(let t of e)s=s||a.includes(t);if(s)continue}i==n?g.push(n):e===t?b.push([n,i]):A.push([n,i])}}}g=s.uniqueStable(g),b=s.maskGet(b,s.maskUnique(b.map((t=>s.min(t)*o.numAtoms+s.max(t))))),A=s.maskGet(A,s.maskUnique(A.map((t=>s.min(t)*o.numAtoms+s.max(t))))),t.save(),t.strokeStyle="#6329C1",t.lineWidth=2,t.setLineDash([1,1]),t.beginPath();for(let e of g){let s=n.getPoint(e-1),i=s.oval.cx,o=s.oval.cy,l=0,r=0,a=0;for(let t=0;t<u.length;t++)if(m[t]==e){let e=n.getPoint(d[t]-1);l+=e.oval.cx,r+=e.oval.cy,a++}a>1&&(l/=a,r/=a),l=i+.5*(l-i),r=o+.5*(r-o);let c=l-i,p=r-o,f=W(U(c,p)),g=p*f,b=-c*f,A=.5*(i+l),y=.5*(o+r);const E=2*h;t.moveTo(i,o),t.quadraticCurveTo(A+g*E,y+b*E,l,r),t.quadraticCurveTo(A-g*E,y-b*E,i,o)}for(let[e,s]of b){let i=o.atomX(e),n=o.atomY(e),l=o.atomX(s),r=o.atomY(s),a=l-i,h=r-n,u=W(U(a,h)),m=h*u,d=-a*u,c=.5*(i+l),p=.5*(n+r);const f=5;let g=c+m*f,b=p+d*f,A=c-m*f,y=p-d*f,[E,M]=jt.congestionPoint(o,g,b)<jt.congestionPoint(o,A,y)?[g,b]:[A,y];t.moveTo(this.angToX(i),this.angToY(n)),t.quadraticCurveTo(this.angToX(E),this.angToY(M),this.angToX(l),this.angToY(r))}for(let[e,s]of A){let i=n.getPoint(e-1),o=n.getPoint(s-1);t.moveTo(i.oval.cx,i.oval.cy),t.lineTo(o.oval.cx,o.oval.cy)}t.stroke(),t.restore()}determineFauxRing(){let t=this.opAtom,e=this.opBond,s=this.mol,i=t>0?s.atomX(t):e>0?.5*(s.atomX(s.bondFrom(e))+s.atomX(s.bondTo(e))):this.xToAng(this.clickX),o=t>0?s.atomY(t):e>0?.5*(s.atomY(s.bondFrom(e))+s.atomY(s.bondTo(e))):this.yToAng(this.clickY),n=this.xToAng(this.mouseX)-i,l=this.yToAng(this.mouseY)-o,r=Math.min(9,Math.round(2*U(n,l)/ne.IDEALBOND)+2);return r<3?[null,null]:e>0?Xt.proposeBondRing(s,r,e,n,l):t>0&&s.atomAdjCount(t)>0&&!this.toolRingFreeform?Xt.proposeAtomRing(s,r,t,n,l):Xt.proposeNewRing(s,r,i,o,n,l,!this.toolRingFreeform)}determineDragTheta(){let t=this.clickX,e=this.clickY,s=this.snapToGuide(t,e);null!=s&&(t=s[0],e=s[1]);let i=Math.atan2(this.mouseY-e,this.mouseX-t),o=U(this.mouseX-t,this.mouseY-e);return this.toolRotateIncr>0&&(i=Math.round(i/this.toolRotateIncr)*this.toolRotateIncr),[t,e,i,o]}determineMoveDelta(){let t=this.clickX,e=this.clickY,s=this.mouseX,i=this.mouseY;if(this.opAtom>0){t=this.angToX(this.mol.atomX(this.opAtom)),e=this.angToY(this.mol.atomY(this.opAtom));let o=this.snapToGuide(s,i);null!=o&&(s=o[0],i=o[1])}return[s-t,i-e]}snapToGuide(t,e){if(this.opBond>0){let s=this.pickObject(t,e);if(s<0){let[t,e]=this.mol.bondFromTo(-s);return[this.angToX(.5*(this.mol.atomX(t)+this.mol.atomX(e))),this.angToY(.5*(this.mol.atomY(t)+this.mol.atomY(e))),!1]}return null}let s=Number.POSITIVE_INFINITY,i=0,o=0,n=!1;const l=V(.5*this.pointScale);if(null!=this.dragGuides)for(let r=0;r<this.dragGuides.length;r++)for(let a=0;a<this.dragGuides[r].x.length;a++){let h=this.dragGuides[r].destX[a],u=this.dragGuides[r].destY[a],m=X(h-t,u-e);m<l&&m<s&&([s,i,o,n]=[m,h,u,!1])}for(let r=1;r<=this.mol.numAtoms;r++){let a=this.angToX(this.mol.atomX(r)),h=this.angToY(this.mol.atomY(r)),u=X(a-t,h-e);u<l&&u<s&&([s,i,o,n]=[u,a,h,!0])}return isFinite(s)?[i,o,n]:null}pickObjectCanvas(t,e,s={}){let i=.5*this.pointScale,o=0,n=Number.POSITIVE_INFINITY;if(!s.noAtoms)for(let s=0;s<this.layout.numPoints();s++){let l=this.layout.getPoint(s);if(0==l.anum)continue;let r=X(Math.abs(t-l.oval.cx),Math.abs(e-l.oval.cy));r>V(Math.max(i,Math.max(l.oval.rw,l.oval.rh)))||r<n&&(o=l.anum,n=r)}if(0!=o)return o;if(!s.noBonds)for(let s=0;s<this.layout.numLines();s++){let l=this.layout.getLine(s);if(0==l.bnum)continue;let r=l.line.x1,h=l.line.y1,u=l.line.x2,m=l.line.y2;if(t<Math.min(r,u)-i||e<Math.min(h,m)-i||t>Math.max(r,u)+i||e>Math.max(h,m)+i)continue;let d=a.pointLineSegDistance(t,e,r,h,u,m);d>i||d<n&&(o=-l.bnum,n=d)}return o}pickObject(t,e,s={}){return this.pickObjectCanvas(t,e,s)||0}sketchEffects(t){let e=new Xe;for(let s=1;s<=t.numAtoms;s++)Ht.hasAbbrev(t,s)&&s!=this.hoverAtom&&(e.dottedRectOutline[s]=8421504);if(e.overlapAtoms=jt.overlappingAtomList(t,.2),e.atomDecoText=s.stringArray("",t.numAtoms),e.atomDecoCol=s.numberArray(gs.foreground,t.numAtoms),e.atomDecoSize=s.numberArray(.3,t.numAtoms),e.bondDecoText=s.stringArray("",t.numBonds),e.bondDecoCol=s.numberArray(gs.foreground,t.numBonds),e.bondDecoSize=s.numberArray(.3,t.numBonds),this.viewOpt.showOxState)for(let s=1;s<=t.numAtoms;s++){let i=Ht.atomOxidationState(t,s);null!=i&&(e.atomDecoText[s-1]=Ht.oxidationStateText(i),e.atomDecoCol[s-1]=16744576)}if(this.viewOpt.decoration==ui.Stereochemistry){this.stereo||(this.stereo=ns.create(ls.createStrict(t)));t:for(let s=1;s<=t.numAtoms;s++){let i=this.stereo.atomTetraChirality(s);if(i!=ns.STEREO_NONE){for(let e of t.atomAdjBonds(s))if(1!=t.bondOrder(e))continue t;if(i==ns.STEREO_UNKNOWN)for(let e of t.atomAdjList(s))if(qt.ELEMENT_BLOCKS[t.atomicNumber(e)]>=3)continue t;e.atomDecoText[s-1]=i==ns.STEREO_POS?"R":i==ns.STEREO_NEG?"S":i==ns.STEREO_UNKNOWN?"R/S":"?",e.atomDecoCol[s-1]=40960}}for(let s=1;s<=t.numBonds;s++){let t=this.stereo.bondSideStereo(s);t!=ns.STEREO_NONE&&(e.bondDecoText[s-1]=t==ns.STEREO_POS?"Z":t==ns.STEREO_NEG?"E":t==ns.STEREO_UNKNOWN?"Z/E":"?",e.bondDecoCol[s-1]=40960)}}else if(this.viewOpt.decoration==ui.MappingNumber){e.atomDecoText=s.stringArray("",t.numAtoms),e.atomDecoCol=s.numberArray(8388863,t.numAtoms),e.atomDecoSize=s.numberArray(.3,t.numAtoms);for(let s=1;s<=t.numAtoms;s++)t.atomMapNum(s)>0&&(e.atomDecoText[s-1]=t.atomMapNum(s).toString())}else if(this.viewOpt.decoration==ui.AtomIndex){e.atomDecoText=s.stringArray("",t.numAtoms),e.atomDecoCol=s.numberArray(8388863,t.numAtoms),e.atomDecoSize=s.numberArray(.3,t.numAtoms);for(let s=1;s<=t.numAtoms;s++)e.atomDecoText[s-1]=s.toString()}return e}orientAbbreviation(t,e){const{mol:s}=this;if(Ht.isBlank(e))return;if(1!=this.mol.atomAdjCount(t))return;let i=s.atomAdjList(t)[0],o=s.atomX(t)-s.atomX(i),n=s.atomY(t)-s.atomY(i),l=e.atomAdjList(1),r=0,a=0,h=W(l.length);for(let t of l)r+=e.atomX(t)-e.atomX(1),a+=e.atomY(t)-e.atomY(1);r*=h,a*=h;let u=Math.atan2(n,o),m=Math.atan2(a,r);jt.rotateMolecule(e,u-m),1==l.length?(jt.translateMolecule(e,s.atomX(t)-e.atomX(l[0]),s.atomY(t)-e.atomY(l[0])),e.setAtomPos(1,s.atomX(i),s.atomY(i))):jt.translateMolecule(e,s.atomX(i)-e.atomX(1),s.atomY(i)-e.atomY(1));for(let t of e.atomAdjBonds(1)){let s=e.bondOther(t,1);e.atomHExplicit(s)==ne.HEXPLICIT_UNKNOWN&&e.setAtomHExplicit(s,Math.max(0,e.atomHydrogens(s)))}e.deleteAtomAndBonds(1)}}class pi{copyEvent(t,e){return!1}pasteEvent(t){return!1}}class fi{constructor(){this.handlers=[new pi]}pushHandler(t){this.handlers.push(t)}popHandler(){this.handlers.pop()}currentHandler(){return s.last(this.handlers)}triggerCopy(t){this.currentHandler().copyEvent(t,this)||document.execCommand(t?"cut":"copy")}triggerPaste(){this.currentHandler().pasteEvent(this)||document.execCommand("paste")}getString(){return null}setString(t){}setImage(t){}canSetHTML(){return!1}setHTML(t){}canAlwaysGet(){return!1}downloadString(t,e){}}class gi extends fi{constructor(){super(),this.lastContent=null,this.fakeTextArea=null,this.busy=!1,document.addEventListener("copy",(t=>this.busy?null:this.currentHandler().copyEvent(!1,this)?(t.preventDefault(),!1):void 0)),document.addEventListener("cut",(t=>this.busy?null:this.currentHandler().copyEvent(!0,this)?(t.preventDefault(),!1):void 0)),document.addEventListener("paste",(t=>{let e=window;this.lastContent=null,e.clipboardData&&e.clipboardData.getData?this.lastContent=e.clipboardData.getData("Text"):t.clipboardData&&t.clipboardData.getData&&(this.lastContent=t.clipboardData.getData("text/plain"));let s=this.currentHandler().pasteEvent(this);return this.lastContent=null,!s||(t.preventDefault(),!1)}))}getString(){return this.lastContent}setString(t){let e=()=>{null==this.fakeTextArea&&(this.fakeTextArea=document.createElement("textarea"),this.fakeTextArea.style.fontSize="12pt",this.fakeTextArea.style.border="0",this.fakeTextArea.style.padding="0",this.fakeTextArea.style.margin="0",this.fakeTextArea.style.position="fixed",this.fakeTextArea.style.left="-9999px",this.fakeTextArea.style.top=(window.pageYOffset||document.documentElement.scrollTop)+"px",this.fakeTextArea.setAttribute("readonly",""),document.body.appendChild(this.fakeTextArea)),this.fakeTextArea.value=t,this.fakeTextArea.select(),this.busy=!0,document.execCommand("copy"),this.busy=!1};navigator.clipboard?navigator.clipboard.writeText(t).then((()=>{}),e):e()}setImage(t){this.busy=!0;let e=new FileReader;e.onload=t=>{let e=t.target.result.toString();if(!e)return;let s=b("<img/>").attr({src:e});s.el.addEventListener("load",(()=>{let t=document.createRange();t.setStartBefore(s.el),t.setEndAfter(s.el),t.selectNode(s.el),window.getSelection().addRange(t),document.execCommand("copy"),s.remove(),this.busy=!1})),s.appendTo(document.body)},e.readAsDataURL(t)}}class bi extends zs{constructor(t,e=!1){if(super(),this.options=t,this.isVertical=e,this.padding=6,this.htmlLabels=!1,this.numCols=0,this.selidx=0,this.buttonDiv=[],this.auxCell=[],this.callbackSelect=null,0==t.length)throw"molsync.ui.OptionList: must provide a list of option labels.";ys("option")||Es("option",this.composeCSS())}getSelectedIndex(){return this.selidx}getSelectedValue(){return this.options[this.selidx]}getAuxiliaryCell(t){return this.auxCell[t].el}onSelect(t){this.callbackSelect=t}render(t){super.render(t),this.contentDOM.css({display:"inline-block","baseline-shift":"1.5em"}),this.buttonDiv=[],this.auxCell=[];let e=b('<table class="wmk-option-table"/>').appendTo(this.contentDOM),s=this.isVertical?null:b("<tr/>").appendTo(e);for(let t=0;t<this.options.length;t++){(this.isVertical||this.numCols>0&&t>0&&t%this.numCols==0)&&(s=b("<tr/>").appendTo(e));let i=b('<td class="wmk-option-cell"/>').appendTo(s),o=b('<div class="wmk-option"/>').appendTo(i);o.css({padding:`${this.padding}px`}),o.onClick((()=>this.clickButton(t))),this.buttonDiv.push(o),this.isVertical&&(i=b('<td style="vertical-align: middle;"/>').appendTo(s),this.auxCell.push(i))}this.updateButtons()}clickButton(t){t!=this.selidx&&(this.setSelectedIndex(t),this.callbackSelect&&this.callbackSelect(t,this))}setSelectedIndex(t){this.selidx!=t&&(this.selidx=t,this.updateButtons())}setSelectedValue(t){let e=this.options.indexOf(t);e>=0&&this.setSelectedIndex(e)}updateButtons(){for(let t=0;t<this.options.length&&t<this.buttonDiv.length;t++){let e=this.buttonDiv[t],s=this.options[t];0==s.length&&t==this.selidx?e.setText(""):0==s.length?e.setText(""):this.htmlLabels?e.setHTML(s):e.setText(s),e.removeClass("wmk-option-unselected wmk-option-selected"),t!=this.selidx?e.addClass("wmk-option-unselected"):e.addClass("wmk-option-selected")}}composeCSS(){w(gs.lowlight);let t=w(gs.lowlightEdge1),e=w(gs.lowlightEdge2);return w(gs.highlight),`\n\t\t\t.wmk-option\n\t\t\t{\n\t\t\t\tmargin-bottom: 0;\n\t\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tfont-weight: normal;\n\t\t\t\ttext-align: center;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tline-height: 1.2em;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.wmk-option-selected\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #008FD2;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${t}, ${e});\n\t\t\t}\n\t\t\t.wmk-option-unselected\n\t\t\t{\n\t\t\t\tcolor: #333;\n\t\t\t\tbackground-color: white;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\t}\n\t\t\t.wmk-option-unselected:hover\n\t\t\t{\n\t\t\t\tbackground-color: #808080;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #F0F0F0, #D0D0D0);\n\t\t\t}\n\t\t\t.wmk-option-unselected:active\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #00C000;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${w(gs.highlightEdge1)}, ${w(gs.highlightEdge2)});\n\t\t\t}\n\t\t\t.wmk-option-table\n\t\t\t{\n\t\t\t\tmargin: 1px;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-collapse: collapse;\n\t\t\t}\n\t\t\t.wmk-option-cell\n\t\t\t{\n\t\t\t\tmargin: 0;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-width: 1px;\n\t\t\t\tborder-style: solid;\n\t\t\t\tborder-color: #808080;\n\t\t\t}\n\t\t`}}class Ai extends zs{constructor(t){super(),this.options=t,this.unionHeight=!1,this.selidx=0,this.buttonDiv=[],this.panelDiv=[],this.padding=6,this.callbackSelect=null,ys("tabbar")||Es("tabbar",this.composeCSS())}onSelect(t){this.callbackSelect=t}getSelectedIndex(){return this.selidx}getSelectedValue(){return this.options[this.selidx]}getPanelDOM(t){let e="number"==typeof t?t:this.options.indexOf(t);return e<0?null:this.panelDiv[e]}render(t){super.render(t);let e=b("<div/>").appendTo(this.contentDOM).css({display:"grid"});e.css({"align-items":"center","justify-content":"start","grid-row-gap":"0.5em"});let s="[start] 1fr ";for(let t=0;t<this.options.length;t++)s+="[btn"+t+"] auto ";s+="[btnX] 1fr [end]",e.css({"grid-template-columns":s});let i=b("<div/>").appendTo(e);i.css({"grid-column":"start / end","grid-row":"1",height:"100%"}),i.css({"border-bottom":"1px solid #C0C0C0"});for(let t=0;t<this.options.length;t++){let s=b('<div class="wmk-tabbar-cell"/>').appendTo(e);s.css({"grid-column":"btn"+t,"grid-row":"1"});let i=b('<div class="wmk-tabbar"/>').appendTo(s);i.css({padding:`${this.padding}px`}),i.onClick((()=>this.clickButton(t))),this.buttonDiv.push(i);let o=b("<div/>").appendTo(e);o.css({"grid-column":"start / end","grid-row":"2"}),o.css({"align-self":"start","justify-self":"center",width:"100%"}),this.panelDiv.push(o)}this.updateButtons()}clickButton(t){t!=this.selidx&&(this.setSelectedIndex(t),this.callbackSelect&&this.callbackSelect(t,this))}setSelectedIndex(t){if(this.selidx==t)return;this.selidx=t;let e=this.contentDOM;e.setCSS("min-width",`${e.width()}px`),this.updateButtons()}setSelectedValue(t){let e=this.options.indexOf(t);e>=0&&this.setSelectedIndex(e)}rotateSelected(t){this.setSelectedIndex((this.selidx+t+this.options.length)%this.options.length)}updateButtons(){for(let t=0;t<this.options.length&&t<this.buttonDiv.length;t++){let e=this.buttonDiv[t],s=this.options[t];0==s.length&&t==this.selidx?e.setText(""):0==s.length?e.setText(""):e.setText(s),e.removeClass("wmk-tabbar-unselected wmk-tabbar-selected"),t!=this.selidx?e.addClass("wmk-tabbar-unselected"):e.addClass("wmk-tabbar-selected"),this.unionHeight?this.panelDiv[t].setCSS("visibility",t==this.selidx?"visible":"hidden"):this.panelDiv[t].setCSS("display",t==this.selidx?"block":"none")}}composeCSS(){w(gs.lowlight);let t=w(gs.lowlightEdge1),e=w(gs.lowlightEdge2);return w(gs.highlight),`\n\t\t\t.wmk-tabbar\n\t\t\t{\n\t\t\t\tmargin-bottom: 0;\n\t\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tfont-weight: normal;\n\t\t\t\ttext-align: center;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tvertical-align: middle;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.wmk-tabbar-selected\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #008FD2;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${t}, ${e});\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected\n\t\t\t{\n\t\t\t\tcolor: #333;\n\t\t\t\tbackground-color: white;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected:hover\n\t\t\t{\n\t\t\t\tbackground-color: #808080;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #F0F0F0, #D0D0D0);\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected:active\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #00C000;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${w(gs.highlightEdge1)}, ${w(gs.highlightEdge2)});\n\t\t\t}\n\t\t\t.wmk-tabbar-table\n\t\t\t{\n\t\t\t\tmargin: 1px;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-collapse: collapse;\n\t\t\t}\n\t\t\t.wmk-tabbar-cell\n\t\t\t{\n\t\t\t\tmargin: 0 -1px -1px 0;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-width: 1px;\n\t\t\t\tborder-style: solid;\n\t\t\t\tborder-color: #808080;\n\t\t\t}\n\t\t`}}class yi extends zs{constructor(t){super(),this.fields=t}render(t){super.render(t),this.divFields=b("<div/>").appendTo(this.contentDOM),this.fillTable();let e=b("<div/>").appendTo(this.contentDOM).css({"text-align":"center"});b('<button class="wmk-button wmk-button-default">Extra</button>').appendTo(e).onClick((()=>{this.fields.push(ne.PREFIX_EXTRA),this.fillTable()})),b('<button class="wmk-button wmk-button-default">Transient</button>').appendTo(e).css({"margin-left":"0.5em"}).onClick((()=>{this.fields.push(ne.PREFIX_TRANSIENT),this.fillTable()}))}getExtraFields(){let t=[];for(let e of this.fields)!e.startsWith(ne.PREFIX_TRANSIENT)&&e.length>1&&t.push(e);return t}getTransientFields(){let t=[];for(let e of this.fields)e.startsWith(ne.PREFIX_TRANSIENT)&&e.length>1&&t.push(e);return t}fillTable(){if(this.divFields.empty(),0==this.fields.length)return;let t=b("<table/>").appendTo(this.divFields).css({width:"100%"}),e=b("<tr/>").appendTo(t);b("<td/>").appendTo(e).css({"text-align":"right","font-weight":"bold","text-decoration":"underline"}).setText("Type"),b("<td/>").appendTo(e).css({"font-weight":"bold","text-decoration":"underline"}).setText("Value");for(let s=0;s<this.fields.length;s++){let i="?",o="";this.fields[s].length>0&&(i=this.fields[s].charAt(0),o=this.fields[s].substring(1)),e=b("<tr/>").appendTo(t);let n=b("<td/>").appendTo(e).css({"text-align":"right"}),l=b("<td/>").appendTo(e),r=b("<td/>").appendTo(e);b("<span/>").appendTo(n).css({padding:"0.2em",border:"1px solid black","background-color":"#C0C0C0"}).setText(i);let a=b('<input size="20"/>').appendTo(l).css({width:"100%",font:"inherit"});a.setValue(o),a.onInput((()=>{this.fields[s]=i+a.getValue()})),b('<button class="wmk-button wmk-button-small wmk-button-default"></button>').appendTo(r).css({"margin-left":"0.5em"}).onClick((()=>{this.fields.splice(s,1),this.fillTable()}))}}}!function(t){t[t.Atom=0]="Atom",t[t.Bond=1]="Bond"}(mi||(mi={})),function(t){t[t.Position=0]="Position",t[t.Link=1]="Link",t[t.Torsion=2]="Torsion"}(di||(di={}));class Ei extends zs{constructor(t,e,i){if(super(),this.type=t,this.mol=e,this.idx=i,this.posX=[],this.posY=[],this.linkA=[],this.linkB=[],this.torsA=[],this.torsB=[],this.hovered=null,t==mi.Atom){const t=i;let o=e.atomAdjList(t);this.atomSubset=[t,...o];for(let s of e.atomAdjBonds(t))this.linkA.push(0),this.linkB.push(this.atomSubset.indexOf(e.bondOther(s,t)));let n=[];for(let s of o)n.push(Math.atan2(-(e.atomY(s)-e.atomY(t)),e.atomX(s)-e.atomX(t)));let l=s.idxSort(n);for(let t=0;t<l.length;t++)this.torsA.push(l[t]+1),this.torsB.push(l[t<l.length-1?t+1:0]+1);this.selected={type:di.Position,idx:0}}else{const t=i;let s=e.bondFrom(t),o=e.bondTo(t);this.atomSubset=[...e.atomAdjList(s),...e.atomAdjList(o)];let n=(t,e)=>{this.linkA.push(this.atomSubset.indexOf(t)),this.linkB.push(this.atomSubset.indexOf(e))};n(s,o);for(let t of e.atomAdjList(s))t!=o&&n(s,t);for(let t of e.atomAdjList(o))t!=s&&n(o,t);this.selected={type:di.Link,idx:0}}}render(t){super.render(t);let e=b("<div/>").appendTo(this.contentDOM).css({"text-align":"center"});this.divDiagram=b("<div/>").appendTo(e).css({display:"inline-block"}),this.contentDOM.onClick((t=>this.mouseClick(P(t,this.divDiagram)))),this.contentDOM.onMouseMove((t=>this.mouseMove(P(t,this.divDiagram)))),this.redraw()}selectionAtoms(t){const e=this.atomSubset;return t.type==di.Position?[e[t.idx]]:t.type==di.Link?[e[this.linkA[t.idx]],e[this.linkB[t.idx]]]:t.type==di.Torsion?[e[0],e[this.torsA[t.idx]],e[this.torsB[t.idx]]]:null}redraw(){this.divDiagram.empty();this.posX=[],this.posY=[];const t=.25;for(let t of this.atomSubset)this.posX.push(this.mol.atomX(t)),this.posY.push(this.mol.atomY(t));let e=s.min(this.posX)-t,i=s.max(this.posX)+t,o=s.min(this.posY)-t,n=s.max(this.posY)+t;this.scale=Math.min(40,Math.min(246/(i-e),246/(n-o)));let l=.5*(250-(i-e)*this.scale),r=.5*(250-(n-o)*this.scale);for(let t=0;t<this.atomSubset.length;t++)this.posX[t]=l+(this.posX[t]-e)*this.scale,this.posY[t]=250-(r+(this.posY[t]-o)*this.scale);this.posRad=t*this.scale;let h=new Ge;h.setSize(250,250);let u=gs.foreground,m=gs.background,d=36817,c=4707794;for(let t=0;t<this.atomSubset.length;t++)this.hovered&&this.hovered.type==di.Position&&this.hovered.idx==t?h.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,u,1,m):this.selected&&this.selected.type==di.Position&&this.selected.idx==t?h.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,d,1,c):h.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,Ge.NOCOLOUR,0,u);for(let t of[1,2,3])for(let e=0;e<this.linkA.length;e++){let s=this.posX[this.linkA[e]],i=this.posY[this.linkA[e]],o=this.posX[this.linkB[e]],n=this.posY[this.linkB[e]];this.hovered&&this.hovered.type==di.Link&&this.hovered.idx==e?3==t&&(h.drawLine(s,i,o,n,u,.1*this.scale+2),h.drawLine(s,i,o,n,m,.1*this.scale)):this.selected&&this.selected.type==di.Link&&this.selected.idx==e?2==t&&(h.drawLine(s,i,o,n,d,.1*this.scale+2),h.drawLine(s,i,o,n,c,.1*this.scale)):1==t&&h.drawLine(s,i,o,n,u,.1*this.scale)}for(let t=0;t<this.torsA.length;t++){let e,i,o,n=this.posX[0],l=this.posY[0],r=.5*(this.posX[this.torsA[t]]-n),p=.5*(this.posY[this.torsA[t]]-l),f=.5*(this.posX[this.torsB[t]]-n),g=.5*(this.posY[this.torsB[t]]-l),b=.5*(U(r,p)+U(f,g)),A=Math.atan2(p,r)+10*J,y=Math.atan2(g,f)-10*J,E=st(y,A),M=b*Math.cos(A),T=b*Math.sin(A),x=b*Math.cos(y),v=b*Math.sin(y);if(E>0){let[t,r,h,u]=a.arcControlPoints(b,M,T,x,v);e=s.add([M,t,h,x],n),i=s.add([T,r,u,v],l),o=[!1,!0,!0,!1]}else{let t=A+.5*(E+K),r=b*Math.cos(t),h=b*Math.sin(t),[u,m,d,c]=a.arcControlPoints(b,M,T,r,h),[p,f,g,y]=a.arcControlPoints(b,r,h,x,v);e=s.add([M,u,d,r,p,g,x],n),i=s.add([T,m,c,h,f,y,v],l),o=[!1,!0,!0,!1,!0,!0,!1]}this.hovered&&this.hovered.type==di.Torsion&&this.hovered.idx==t?(h.drawPath(e,i,o,!1,u,.1*this.scale+2,Ge.NOCOLOUR,!1),h.drawPath(e,i,o,!1,m,.1*this.scale,Ge.NOCOLOUR,!1)):this.selected&&this.selected.type==di.Torsion&&this.selected.idx==t?(h.drawPath(e,i,o,!1,d,.1*this.scale+2,Ge.NOCOLOUR,!1),h.drawPath(e,i,o,!1,c,.1*this.scale,Ge.NOCOLOUR,!1)):h.drawPath(e,i,o,!1,u,.1*this.scale,Ge.NOCOLOUR,!1)}this.divDiagram.empty(),b(h.createSVG()).appendTo(this.divDiagram).css({"pointer-events":"none"})}mouseClick(t){if(event.stopPropagation(),this.type==mi.Bond)return;let e=this.whichSelection(t[0],t[1]);e&&(this.sameSelection(this.selected,e)||(this.selected=e,this.hovered=null,this.redraw(),this.callbackSelect(e)))}mouseMove(t){if(this.type==mi.Bond)return;let e=this.whichSelection(t[0],t[1]);e&&this.sameSelection(e,this.selected)&&(e=null),this.sameSelection(this.hovered,e)||(this.hovered=e,this.redraw())}whichSelection(t,e){let s=this.posX[0],i=this.posY[0];if(U(t-s,e-i)<=this.posRad)return{type:di.Position,idx:0};let o=0;for(let t=1;t<this.atomSubset.length;t++)o=Math.max(o,U(this.posX[t]-s,this.posY[t]-i)+this.posRad);if(U(t-s,e-i)>o)return null;let n=Math.atan2(e-i,t-s),l=null,r=Number.POSITIVE_INFINITY;for(let t=0;t<this.linkB.length;t++){let e=Math.abs(st(Math.atan2(this.posY[this.linkB[t]]-i,this.posX[this.linkB[t]]-s),n));e<10*J&&e<r&&(l={type:di.Link,idx:t},r=e)}for(let t=0;t<this.torsA.length;t++){let e=Math.atan2(this.posY[this.torsA[t]]-i,this.posX[this.torsA[t]]-s),o=e+.5*st(Math.atan2(this.posY[this.torsB[t]]-i,this.posX[this.torsB[t]]-s),e),a=Math.abs(st(o,n));a<r&&(l={type:di.Torsion,idx:t},r=a)}return l}sameSelection(t,e){return null==t&&null==e||null!=t&&null!=e&&t.type==e.type&&t.idx==e.idx}}const Mi=[1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,7,7,7,7,7,7,7,7,7,7],Ti=[1,18,1,2,13,14,15,16,17,18,1,2,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5,12.5,13.5,14.5,15.5,16.5,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5,12.5,13.5,14.5,15.5,16.5,3,4,5,6,7,8,9,10,11,12];class xi extends zs{constructor(){super(),this.divList=[],this.selectedAtno=0,Es("periodictable","\n\t*.wmk-periodictable-element\n\t{\n\t\tborder: 1px solid black;\n\t\tborder-radius: 2px;\n\t\tmargin: 0;\n\t\tmin-width: 2em;\n\t\tpadding: 0.4em 0 0.3em 0;\n\t\ttext-align: center;\n\t\tcolor: #FFFFFF;\n\t\tcursor: pointer;\n\t}\n\t*.wmk-periodictable-block1\n\t{\n\t\tbackground-color: #313062;\n\t}\n\t*.wmk-periodictable-block2\n\t{\n\t\tbackground-color: #205224;\n\t}\n\t*.wmk-periodictable-block3\n\t{\n\t\tbackground-color: #522818;\n\t}\n\t*.wmk-periodictable-block4\n\t{\n\t\tbackground-color: #575212;\n\t}\n\t*.wmk-periodictable-selected\n\t{\n\t\tbackground-color: #FFFFFF;\n\t\tcolor: #000000;\n\t\tcursor: default;\n\t}\n")}render(t){super.render(t);let e=b("<div/>").appendTo(this.contentDOM).css({display:"grid"});e.css({"align-items":"center","justify-content":"start",gap:"1px"});let s=Mi.map((t=>Math.round(2*t)+1)),i=Ti.map((t=>Math.round(2*t)+1)),o=s.length;for(let t=0;t<o;t++){let o=b("<div/>").appendTo(e);o.css({"grid-row":`${s[t]} / span 2`,"grid-column":`${i[t]} / span 2`}),o.addClass("wmk-periodictable-element");let n=qt.ELEMENT_BLOCKS[t+1];1==n?o.addClass("wmk-periodictable-block1"):2==n?o.addClass("wmk-periodictable-block2"):3==n?o.addClass("wmk-periodictable-block3"):4==n&&o.addClass("wmk-periodictable-block4");let l=qt.ELEMENTS[t+1];o.setText(l),this.divList.push(o),o.onClick((()=>{this.changeElement(l),this.callbackSelect(l)})),o.onDblClick((t=>{this.callbackDoubleClick(),t.preventDefault(),t.stopPropagation()}))}}onSelect(t){this.callbackSelect=t}onDoubleClick(t){this.callbackDoubleClick=t}changeElement(t){let e=qt.ELEMENTS.indexOf(t);e!=this.selectedAtno&&(this.selectedAtno>0&&this.divList[this.selectedAtno-1].removeClass("wmk-periodictable-selected"),this.selectedAtno=e,this.selectedAtno>0&&this.divList[this.selectedAtno-1].addClass("wmk-periodictable-selected"))}}class vi extends zs{constructor(t,e,s){super(),this.mol=t,this.atom=e,this.bond=s}render(t){super.render(t);let e=b("<div/>").appendTo(this.contentDOM);e.css({display:"grid","align-items":"center","justify-content":"start"}),e.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),e.css({"grid-template-columns":"[title] auto [value] auto [end]"});let s=0,i=()=>b('<input size="20"/>').appendTo(e).css({"grid-area":`${s} / value`}),o=()=>{let t=b("<div/>").appendTo(e).css({"grid-area":`${s} / value`,dispkay:"flex"}),i=b("<label/>").appendTo(t).css({"margin-right":"0.5em"}),o=b('<input type="checkbox"/>').appendTo(i);return i.appendText("Not"),[o,b('<input size="20"/>').appendTo(t).css({"flex-grow":"1"})]};this.atom>0?(b("<div>Charges</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputCharges=i(),b("<div>Aromatic</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.optAromatic=new bi(["Maybe","Yes","No"]),this.optAromatic.render(b("<div/>").appendTo(e).css({"grid-area":`${s} / value`})),b("<div>Elements</div>").appendTo(e).css({"grid-area":++s+" / title"}),[this.chkNotElements,this.inputElements]=o(),b("<div>Ring Sizes</div>").appendTo(e).css({"grid-area":++s+" / title"}),[this.chkNotRingSizes,this.inputRingSizes]=o(),b("<div>Ring Block</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.optRingBlock=new bi(["Maybe","Yes","No"]),this.optRingBlock.render(b("<div/>").appendTo(e).css({"grid-area":`${s} / value`})),b("<div># Small Rings</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputNumRings=i(),b("<div>Adjacency</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputAdjacency=i(),b("<div>Bond Sums</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputBondSums=i(),b("<div>Valences</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputValences=i(),b("<div>Hydrogens</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputHydrogens=i(),b("<div>Isotopes</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputIsotopes=i(),this.setupAtom()):(b("<div>Ring Sizes</div>").appendTo(e).css({"grid-area":++s+" / title"}),[this.chkNotRingSizes,this.inputRingSizes]=o(),b("<div>Ring Block</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.optRingBlock=new bi(["Maybe","Yes","No"]),this.optRingBlock.render(b("<div/>").appendTo(e).css({"grid-area":`${s} / value`})),b("<div># Small Rings</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputNumRings=i(),b("<div>Num Rings</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputNumRings=i(),b("<div>Bond Orders</div>").appendTo(e).css({"grid-area":++s+" / title"}),this.inputOrders=i(),this.setupBond())}updateAtom(){const{mol:t,atom:e}=this;Bs.deleteQueryAtomAll(t,e);let s=this.splitNumbers(this.inputCharges.getValue());s&&Bs.setQueryAtomCharges(t,e,s);let i=this.optAromatic.getSelectedIndex();i>0&&Bs.setQueryAtomAromatic(t,e,1==i);let o=this.splitStrings(this.inputElements.getValue());o&&(this.chkNotElements.elInput.checked?Bs.setQueryAtomElementsNot(t,e,o):Bs.setQueryAtomElements(t,e,o));let n=this.splitNumbers(this.inputRingSizes.getValue());n&&(this.chkNotRingSizes.elInput.checked?Bs.setQueryAtomRingSizesNot(t,e,n):Bs.setQueryAtomRingSizes(t,e,n));let l=this.optRingBlock.getSelectedIndex();l>0&&Bs.setQueryAtomRingBlock(t,e,1==l);let r=this.splitNumbers(this.inputNumRings.getValue());r&&Bs.setQueryAtomNumRings(t,e,r);let a=this.splitNumbers(this.inputAdjacency.getValue());a&&Bs.setQueryAtomAdjacency(t,e,a);let h=this.splitNumbers(this.inputBondSums.getValue());h&&Bs.setQueryAtomBondSums(t,e,h);let u=this.splitNumbers(this.inputValences.getValue());u&&Bs.setQueryAtomValences(t,e,u);let m=this.splitNumbers(this.inputHydrogens.getValue());m&&Bs.setQueryAtomHydrogens(t,e,m);let d=this.splitNumbers(this.inputIsotopes.getValue());d&&Bs.setQueryAtomIsotope(t,e,d)}updateBond(){const{mol:t,bond:e}=this;Bs.deleteQueryBondAll(t,e);let s=this.splitNumbers(this.inputRingSizes.getValue());s&&(this.chkNotRingSizes.elInput.checked?Bs.setQueryBondRingSizesNot(t,e,s):Bs.setQueryBondRingSizes(t,e,s));let i=this.optRingBlock.getSelectedIndex();i>0&&Bs.setQueryBondRingBlock(t,e,1==i);let o=this.splitNumbers(this.inputNumRings.getValue());o&&Bs.setQueryBondNumRings(t,e,o);let n=this.splitNumbers(this.inputOrders.getValue());n&&Bs.setQueryBondOrders(t,e,n)}setupAtom(){const{mol:t,atom:e}=this;let i=Bs.queryAtomCharges(t,e),o=Bs.queryAtomAromatic(t,e),n=Bs.queryAtomElements(t,e),l=Bs.queryAtomElementsNot(t,e),r=Bs.queryAtomRingSizes(t,e),a=Bs.queryAtomRingSizesNot(t,e),h=Bs.queryAtomRingBlock(t,e),u=Bs.queryAtomNumRings(t,e),m=Bs.queryAtomAdjacency(t,e),d=Bs.queryAtomBondSums(t,e),c=Bs.queryAtomValences(t,e),p=Bs.queryAtomHydrogens(t,e),f=Bs.queryAtomIsotope(t,e);Bs.queryAtomSubFrags(t,e),Bs.queryAtomSubFragsNot(t,e),this.inputCharges.setValue(s.notBlank(i)?i.join(","):""),this.optAromatic.setSelectedIndex(null==o?0:o?1:2),this.chkNotElements.elInput.checked=s.isBlank(n)&&s.notBlank(l),this.inputElements.setValue(s.notBlank(n)?n.join(","):s.notBlank(l)?l.join(","):""),this.chkNotRingSizes.elInput.checked=s.isBlank(r)&&s.notBlank(a),this.inputRingSizes.setValue(s.notBlank(r)?r.join(","):s.notBlank(a)?a.join(","):""),this.optRingBlock.setSelectedIndex(null==h?0:h?1:2),this.inputNumRings.setValue(s.notBlank(u)?u.join(","):""),this.inputAdjacency.setValue(s.notBlank(m)?m.join(","):""),this.inputBondSums.setValue(s.notBlank(d)?d.join(","):""),this.inputValences.setValue(s.notBlank(c)?c.join(","):""),this.inputHydrogens.setValue(s.notBlank(p)?p.join(","):""),this.inputIsotopes.setValue(s.notBlank(f)?f.join(","):"")}setupBond(){const{mol:t,bond:e}=this;let i=Bs.queryBondRingSizes(t,e),o=Bs.queryBondRingSizesNot(t,e),n=Bs.queryBondRingBlock(t,e),l=Bs.queryBondNumRings(t,e),r=Bs.queryBondOrders(t,e);this.chkNotRingSizes.elInput.checked=s.isBlank(i)&&s.notBlank(o),this.inputRingSizes.setValue(s.notBlank(i)?i.join(","):s.notBlank(o)?o.join(","):""),this.optRingBlock.setSelectedIndex(null==n?0:n?1:2),this.inputNumRings.setValue(s.notBlank(l)?l.join(","):""),this.inputOrders.setValue(s.notBlank(r)?r.join(","):"")}splitStrings(t){let e=[];if(t)for(let s of t.split(/[\s\,\;]+/))s&&e.push(s);return e.length?e:null}splitNumbers(t){let e=[];if(t)for(let s of t.split(/[\s\,\;]+/)){s.startsWith("+")&&(s=s.substring(1));let t=parseInt(s);isNaN(t)||e.push(t)}return e.length?e:null}}class Ci extends ks{constructor(t,e,s,i){super(),this.atom=e,this.proxyClip=s,this.callbackApply=i,this.newX=0,this.newY=0,this.tabs=null,this.abbrevList=null,this.svgAbbrev=null,this.abbrevIndices=[],this.currentAbbrev=-1,this.initMol=t,this.mol=t.clone(),this.title="Edit Atom",this.minPortionWidth=20,this.maxPortionWidth=95}populate(){this.proxyClip.pushHandler(new pi);let t=this.buttonsDOM(),e=this.bodyDOM();this.btnApply=b('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnApply.onClick((()=>this.applyChanges())),this.atom>0?(this.tabs=new Ai(["Atom","Abbreviation","Geometry","Query","Extra"]),this.tabs.render(e),this.tabs.onSelect((t=>this.selectedTab(t))),this.populateAtom(this.tabs.getPanelDOM("Atom")),this.populateAbbreviation(this.tabs.getPanelDOM("Abbreviation")),this.atom>0&&this.populateGeometry(this.tabs.getPanelDOM("Geometry")),this.populateQuery(this.tabs.getPanelDOM("Query")),this.populateExtra(this.tabs.getPanelDOM("Extra"))):this.populateAtom(e);let s=e.findAll("input,textarea");s.length>0&&s[0].grabFocus(!0);for(let t of s)t.css({font:"inherit"}),t.onKeyDown((t=>{"Enter"==t.key?this.applyChanges():"Escape"==t.key?this.close():"PageUp"==t.key?(this.tabs.rotateSelected(-1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()):"PageDown"==t.key&&(this.tabs.rotateSelected(1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()),t.stopPropagation()}))}close(){this.proxyClip.popHandler(),super.close()}applyChanges(){this.mol.keepTransient=!0,this.updateMolecule();let t=this.tabs?this.tabs.getSelectedValue():null;"Abbreviation"==t&&this.updateAbbrev(),"Geometry"==t&&this.updateGeometry(),"Query"==t&&this.updateQuery(),"Extra"==t&&this.updateExtra(),this.mol.keepTransient=!1,this.callbackApply&&this.callbackApply(this)}populateAtom(t){let e=b("<div/>").appendTo(t);e.css({display:"grid","align-items":"center","justify-content":"start"}),e.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),e.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),e.appendHTML('<div style="grid-area: 1 / col0;">Symbol</div>'),this.inputSymbol=b('<input size="20"/>').appendTo(e),this.inputSymbol.css({"grid-area":"1 / col1 / auto / col4}"}),this.inputSymbol.onInput((()=>this.periodicWidget.changeElement(this.inputSymbol.getValue()))),e.appendHTML('<div style="grid-area: 2 / col0;">Charge</div>'),this.inputCharge=b('<input type="number" size="6"/>').appendTo(e),this.inputCharge.css({"grid-area":"2 / col1"}),e.appendHTML('<div style="grid-area: 2 / col2;">Unpaired</div>'),this.inputUnpaired=b('<input type="number" size="6"/>').appendTo(e),this.inputUnpaired.css({"grid-area":"2 / col3"}),e.appendHTML('<div style="grid-area: 3 / col0;">Hydrogens</div>'),this.optionHydrogen=new bi(["Auto","None","1","2","3","4","Other"]),this.optionHydrogen.render(b('<div style="grid-area: 3 / col1 / auto / col3"/>').appendTo(e)),this.optionHydrogen.onSelect((t=>this.inputHydrogen.elInput.disabled=6!=t)),this.inputHydrogen=b('<input type="number" size="4"/>').appendTo(e),this.inputHydrogen.css({"grid-area":"3 / col3"}),this.inputHydrogen.elInput.disabled=!0,e.appendHTML('<div style="grid-area: 4 / col0;">Isotope</div>'),this.optionIsotope=new bi(["Natural","Enriched"]),this.optionIsotope.render(b('<div style="grid-area: 4 / col1 / auto / col3"/>').appendTo(e)),this.optionIsotope.onSelect((t=>this.inputIsotope.elInput.disabled=0==t)),this.inputIsotope=b('<input type="number" size="6"/>').appendTo(e),this.inputIsotope.css({"grid-area":"4 / col3"}),this.inputIsotope.elInput.disabled=!0,e.appendHTML('<div style="grid-area: 5 / col0;">Mapping</div>'),this.inputMapping=b('<input type="number" size="6"/>').appendTo(e),this.inputMapping.css({"grid-area":"5 / col1"}),e.appendHTML('<div style="grid-area: 5 / col2;">Index</div>'),this.inputIndex=b('<input type="number" size="6" readonly="readonly"/>').appendTo(e),this.inputIndex.css({"grid-area":"5 / col3"});let s=b("<div/>").appendTo(e).css({"grid-area":"6 / start / 6 / end"});this.periodicWidget=new xi,this.periodicWidget.onSelect((t=>this.inputSymbol.setValue(t))),this.periodicWidget.onDoubleClick((()=>this.applyChanges())),this.periodicWidget.render(s);const i=this.mol,o=this.atom;if(o>0){this.inputSymbol.setValue(i.atomElement(o)),this.inputCharge.setValue(i.atomCharge(o).toString()),this.inputUnpaired.setValue(i.atomUnpaired(o).toString());let t=i.atomHExplicit(o);t==ne.HEXPLICIT_UNKNOWN?(this.optionHydrogen.setSelectedIndex(0),this.inputHydrogen.setValue(i.atomHydrogens(o).toString()),this.inputHydrogen.elInput.disabled=!0):t<=4?(this.optionHydrogen.setSelectedIndex(t+1),this.inputHydrogen.setValue(t.toString()),this.inputHydrogen.elInput.disabled=!0):(this.optionHydrogen.setSelectedIndex(6),this.inputHydrogen.setValue(t.toString()),this.inputHydrogen.elInput.disabled=!1),this.optionIsotope.setSelectedIndex(i.atomIsotope(o)==ne.ISOTOPE_NATURAL?0:1),i.atomIsotope(o)!=ne.ISOTOPE_NATURAL&&this.inputIsotope.setValue(i.atomIsotope(o).toString()),this.inputIsotope.elInput.disabled=i.atomIsotope(o)==ne.ISOTOPE_NATURAL,this.inputMapping.setValue(i.atomMapNum(o).toString()),this.inputIndex.setValue(o.toString()),this.periodicWidget.changeElement(i.atomElement(o))}}populateAbbreviation(t){let e=b("<div/>").appendTo(t).css({display:"flex","align-items":"flex-start"});e.css({"max-width":"60vw","max-height":"50vh","overflow-y":"scroll"});let s=b("<div/>").appendTo(e).css({"margin-right":"0.5em",flex:"0 0"}),i=b("<div/>").appendTo(e).css({flex:"1 1 100%"});this.inputAbbrevSearch=b('<input size="10"/>').appendTo(s),this.inputAbbrevSearch.setAttr("placeholder","Search");let o="";this.inputAbbrevSearch.onKeyDown((t=>{"ArrowUp"==t.key?this.cycleAbbreviation(-1):"ArrowDown"==t.key&&this.cycleAbbreviation(1)})),this.inputAbbrevSearch.onInput((()=>{let t=this.inputAbbrevSearch.getValue();t!=o&&(o=t,this.fillAbbreviations())}));let n=b("<div/>").appendTo(s).css({"margin-top":"0.5em"});b('<button class="wmk-button wmk-button-default">Clear</button>').appendTo(n).onClick((()=>{this.selectAbbreviation(-1),this.atom>0&&Ht.hasAbbrev(this.mol,this.atom)&&this.applyChanges()})),this.tableAbbrev=b("<table/>").appendTo(i).css({"border-collapse":"collapse",width:"100%"}),this.fillAbbreviations()}populateGeometry(t){const{mol:e,atom:s}=this;let i=b("<div/>").appendTo(t).css({"text-align":"center"}),o=b("<div/>").appendTo(i).css({display:"inline-block"}),n=b("<div/>").appendTo(o);n.css({display:"grid","align-items":"center","justify-content":"start"}),n.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),n.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),this.geomWidget=new Ei(mi.Atom,e,s),this.geomWidget.render(b("<div/>").appendTo(n).css({"grid-area":"1 / col0 / auto / col4","text-align":"center"}));let l=b("<div/>").appendTo(n).css({"grid-area":"2 / col0"});this.inputGeom1=b('<input type="number" size="8"/>').appendTo(n).css({"grid-area":"2 / col1"});let r=b("<div/>").appendTo(n).css({"grid-area":"2 / col2"});this.inputGeom2=b('<input type="number" size="8"/>').appendTo(n).css({"grid-area":"2 / col3"}),this.geomWidget.callbackSelect=t=>{let s=this.geomWidget.selectionAtoms(t);if(t.type==di.Position)l.setText("Position X"),r.setText("Y"),this.inputGeom1.setValue(this.refGeom1=e.atomX(s[0]).toFixed(3)),this.inputGeom2.setValue(this.refGeom2=e.atomY(s[0]).toFixed(3));else if(t.type==di.Link){let t=e.atomX(s[1])-e.atomX(s[0]),i=e.atomY(s[1])-e.atomY(s[0]);l.setText("Distance"),r.setText("Angle"),this.inputGeom1.setValue(this.refGeom1=U(t,i).toFixed(3)),this.inputGeom2.setValue(this.refGeom2=(Math.atan2(i,t)*tt).toFixed(1))}else if(t.type==di.Torsion){let t=e.atomX(s[0]),i=e.atomY(s[0]),o=Math.atan2(e.atomY(s[1])-i,e.atomX(s[1])-t),n=Math.atan2(e.atomY(s[2])-i,e.atomX(s[2])-t);l.setText("Angle"),r.setText(""),this.inputGeom1.setValue(this.refGeom1=(it(o,n)*tt).toFixed(1)),this.inputGeom2.setValue(this.refGeom2="")}r.setCSS("display",t.type==di.Torsion?"none":"block"),this.inputGeom2.setCSS("display",t.type==di.Torsion?"none":"block")},this.geomWidget.callbackSelect(this.geomWidget.selected)}populateQuery(t){this.queryWidget=new vi(this.mol,this.atom,0),this.queryWidget.render(t)}populateExtra(t){let e=[...this.mol.atomExtra(this.atom),...this.mol.atomTransient(this.atom)];this.fieldsWidget=new yi(e),this.fieldsWidget.render(t)}updateMolecule(){let{mol:t,atom:e}=this;0==e&&(e=this.atom=t.addAtom("C",this.newX,this.newY));let s=this.inputSymbol.getValue();""!=s&&t.setAtomElement(e,s);let i=parseInt(this.inputCharge.getValue());i>-20&&i<20&&t.setAtomCharge(e,i);let o=parseInt(this.inputUnpaired.getValue());o>=0&&o<20&&t.setAtomUnpaired(e,o);let n=this.optionHydrogen.getSelectedIndex();if(0==n)t.setAtomHExplicit(e,ne.HEXPLICIT_UNKNOWN);else if(n<=5)t.setAtomHExplicit(e,n-1);else{let s=parseInt(this.inputHydrogen.getValue());s>=0&&s<20&&t.setAtomHExplicit(e,s)}if(1==this.optionIsotope.getSelectedIndex()){let s=parseInt(this.inputIsotope.getValue());s>=0&&s<300&&t.setAtomIsotope(e,s)}else t.setAtomIsotope(e,ne.ISOTOPE_NATURAL);let l=parseInt(this.inputMapping.getValue());isNaN(l)||t.setAtomMapNum(e,l)}updateAbbrev(){const{mol:t,atom:e}=this;if(this.currentAbbrev<0){let s=t.atomElement(e);Ht.clearAbbrev(t,e),t.setAtomElement(e,s)}else{let s=this.abbrevList[this.currentAbbrev];t.setAtomElement(e,s.name),Ht.setAbbrev(t,e,s.frag)}}updateGeometry(){let t=this.inputGeom1.getValue(),e=this.inputGeom2.getValue();if(this.refGeom1==t&&this.refGeom2==e)return;const{mol:i}=this;let o=this.geomWidget.selected,n=this.geomWidget.selectionAtoms(o);if(o.type==di.Position){let s=parseFloat(t),o=parseFloat(e);if(isNaN(s)||isNaN(o)||Math.abs(s)>1e6||Math.abs(o)>1e6)return;i.setAtomPos(n[0],s,o)}else if(o.type==di.Link){if(this.refGeom1!=t){let e=parseFloat(t);if(isNaN(e)||Math.abs(e)>100)return;let o=s.booleanArray(!1,i.numAtoms);o[n[1]-1]=!0;let l={mol:i,currentAtom:0,currentBond:i.findBond(n[0],n[1]),selectedMask:o},r=new Gs(l,Ys.BondDist,{dist:e});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}if(this.refGeom2!=e){let t=parseFloat(e);if(isNaN(t))return;let o=s.booleanArray(!1,i.numAtoms);o[n[1]-1]=!0;let l={mol:i,currentAtom:0,currentBond:i.findBond(n[0],n[1]),selectedMask:o},r=new Gs(l,Ys.AlignAngle,{angle:t*J});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}}else if(o.type==di.Torsion){let e=parseFloat(t);if(isNaN(e))return;let o=s.booleanArray(!1,i.numAtoms);for(let t of n)o[t-1]=!0;let l={mol:i,currentAtom:n[2],currentBond:0,selectedMask:o},r=new Gs(l,Ys.AdjustTorsion,{angle:e*J});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}}updateQuery(){this.queryWidget.updateAtom()}updateExtra(){this.mol.setAtomExtra(this.atom,this.fieldsWidget.getExtraFields()),this.mol.setAtomTransient(this.atom,this.fieldsWidget.getTransientFields())}fillAbbreviations(){if(xs.needsSetup())return void setTimeout((()=>xs.setupData().then((()=>this.fillAbbreviations()))),1);if(this.tableAbbrev.empty(),xs.main.submitMolecule(this.mol,!0),this.abbrevList=xs.main.getAbbrevs(),!this.svgAbbrev){this.svgAbbrev=[];let t=Ye.defaultColourOnWhite(10),e=new We(0,0,t.data.pointScale);for(let i of this.abbrevList){let o=new Xe,n=i.frag.clone();o.atomCircleSz=s.numberArray(0,n.numAtoms),o.atomCircleCol=s.numberArray(0,n.numAtoms);for(let t=1;t<=n.numAtoms;t++)n.atomElement(t)==Ht.ABBREV_ATTACHMENT&&(n.setAtomElement(t,"C"),o.atomCircleSz[t-1]=.2,o.atomCircleCol[t-1]=49152);let l=new He(n,e,t,o);l.arrange();let r=new Ge;new $e(l,r).draw(),r.normalise(),this.svgAbbrev.push(r.createSVG())}const{mol:i,atom:o}=this;if(o>0&&Ht.hasAbbrev(i,o)){let t=i.atomElement(o),e=Ht.molecularFormula(Ht.getAbbrev(i,o));for(let s=0;s<this.abbrevList.length;s++)if(t==this.abbrevList[s].name){e==Ht.molecularFormula(this.abbrevList[s].frag)&&(this.currentAbbrev=s);break}}}let t=b("<tr/>").appendTo(this.tableAbbrev);t.appendHTML("<td><u>Label</u></td>"),t.appendHTML("<td><u>Structure</u></td>"),this.abbrevEntries=[],this.abbrevIndices=[];let e=this.inputAbbrevSearch.getValue().toLowerCase();for(let t=0;t<this.abbrevList.length;t++){if(this.currentAbbrev!=t&&!this.abbrevList[t].nameSearch.includes(e))continue;let s={tr:b("<tr/>").appendTo(this.tableAbbrev),idx:t,bgcol:this.abbrevEntries.length%2==0?"#FFFFFF":"#F8F8F8"};s.tr.setCSS("background-color",this.currentAbbrev==s.idx?w(gs.lowlight):s.bgcol);let i=b("<td/>").appendTo(s.tr),o=b("<td/>").appendTo(s.tr);i.setHTML(this.abbrevList[t].nameHTML),b(this.svgAbbrev[t]).appendTo(o).css({display:"block","pointer-events":"none"}),s.tr.css({cursor:"pointer"}),s.tr.onClick((()=>this.selectAbbreviation(t))),s.tr.onDblClick((t=>this.applyChanges())),this.abbrevEntries.push(s),this.abbrevIndices.push(t)}}selectAbbreviation(t){if(this.currentAbbrev!=t){this.currentAbbrev=t;for(let t of this.abbrevEntries)t.tr.setCSS("background-color",this.currentAbbrev==t.idx?w(gs.lowlight):t.bgcol),this.currentAbbrev==t.idx&&t.tr.el.scrollIntoView({block:"nearest"})}}cycleAbbreviation(t){let e=this.abbrevIndices.length;if(0==e)return;let s=this.abbrevIndices.indexOf(this.currentAbbrev);s=s<0?t<0?e-1:0:(s+e+t)%e,this.selectAbbreviation(this.abbrevIndices[s])}selectedTab(t){0==t?this.inputSymbol.grabFocus():1==t?this.inputAbbrevSearch.grabFocus():2==t&&this.inputGeom1.grabFocus()}}class Ni extends ks{constructor(t,e,s,i){super(),this.bond=e,this.proxyClip=s,this.callbackApply=i,this.initMol=t,this.mol=t.clone(),this.title="Edit Bond",this.minPortionWidth=20,this.maxPortionWidth=95}populate(){this.proxyClip.pushHandler(new pi);let t=this.buttonsDOM(),e=this.bodyDOM();this.btnApply=b('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnApply.onClick((()=>this.applyChanges())),this.tabs=new Ai(["Bond","Geometry","Query","Extra"]),this.tabs.render(e),this.tabs.onSelect((t=>this.selectedTab(t))),this.populateBond(this.tabs.getPanelDOM("Bond")),this.populateGeometry(this.tabs.getPanelDOM("Geometry")),this.populateQuery(this.tabs.getPanelDOM("Query")),this.populateExtra(this.tabs.getPanelDOM("Extra"));let s=e.findAll("input,textarea");s.length>0&&s[0].grabFocus(!0);for(let t of s)t.css({font:"inherit"}),t.onKeyDown((t=>{"Enter"==t.key?this.applyChanges():"Escape"==t.key?this.close():"PageUp"==t.key?(this.tabs.rotateSelected(-1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()):"PageDown"==t.key&&(this.tabs.rotateSelected(1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()),t.stopPropagation()}))}close(){this.proxyClip.popHandler(),super.close()}applyChanges(){this.mol.keepTransient=!0,this.updateMolecule(),"Geometry"==this.tabs.getSelectedValue()&&this.updateGeometry(),"Query"==this.tabs.getSelectedValue()&&this.updateQuery(),"Extra"==this.tabs.getSelectedValue()&&this.updateExtra(),this.mol.keepTransient=!1,this.callbackApply&&this.callbackApply(this)}populateBond(t){const{mol:e,bond:s}=this;let i=b("<div/>").appendTo(t);i.css({display:"grid","align-items":"center","justify-content":"start"}),i.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),i.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),b("<div/>").appendTo(i).css({"grid-area":"1 / col0"}).setText("Order");let o=[];for(let t=0;t<=4;t++)o.push(`&nbsp;&nbsp;${t}&nbsp;&nbsp;`);this.optionOrder=new bi(o),this.optionOrder.htmlLabels=!0,this.optionOrder.setSelectedIndex(e.bondOrder(s)),this.optionOrder.render(b("<div/>").appendTo(i).css({"grid-column":"col1 / col4","grid-row":"1"})),b("<div/>").appendTo(i).css({"grid-area":"2 / col0"}).setText("Stereo"),this.optionStereo=new bi(["None","Up","Down","Unknown"]),this.optionStereo.setSelectedIndex(e.bondType(s)),this.optionStereo.render(b("<div/>").appendTo(i).css({"grid-column":"col1 / col4","grid-row":"2"})),b("<div/>").appendTo(i).css({"grid-area":"3 / col0"}).setText("From"),this.inputFrom=b('<input size="6"/>').appendTo(i).css({"grid-area":"3 / col1",font:"inherit"}),this.inputFrom.elInput.readOnly=!0,this.inputFrom.setValue(e.bondFrom(s).toString()),b("<div/>").appendTo(i).css({"grid-area":"3 / col2"}).setText("To"),this.inputTo=b('<input size="6"/>').appendTo(i).css({"grid-area":"3 / col3",font:"inherit"}),this.inputTo.elInput.readOnly=!0,this.inputTo.setValue(e.bondTo(s).toString()),b("<div/>").appendTo(i).css({"grid-area":"4 / col2"}).setText("Index"),this.inputIndex=b('<input size="6"/>').appendTo(i).css({"grid-area":"4 / col3",font:"inherit"}),this.inputIndex.elInput.readOnly=!0,this.inputIndex.setValue(s.toString())}populateGeometry(t){const{mol:e,bond:s}=this;let i=b("<div/>").appendTo(t).css({"text-align":"center"}),o=b("<div/>").appendTo(i).css({display:"inline-block"}),n=b("<div/>").appendTo(o);n.css({display:"grid","align-items":"center","justify-content":"start"}),n.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),n.css({"grid-template-columns":"[start col0] auto [col1] auto [col2]"}),this.geomWidget=new Ei(mi.Bond,e,s),this.geomWidget.render(b("<div/>").appendTo(n).css({"grid-area":"1 / col0 / auto / col2","text-align":"center"}));let l=b("<div/>").appendTo(n).css({"grid-area":"2 / col0"});this.inputGeom1=b('<input type="number" size="8"/>').appendTo(n).css({"grid-area":"2 / col1"}),this.geomWidget.callbackSelect=t=>{if(t.type==di.Link){let t=e.bondFrom(s),i=e.bondTo(s),o=e.atomX(i)-e.atomX(t),n=e.atomY(i)-e.atomY(t);l.setText("Distance"),this.inputGeom1.setValue(this.refGeom1=U(o,n).toFixed(3))}},this.geomWidget.callbackSelect(this.geomWidget.selected)}populateQuery(t){this.queryWidget=new vi(this.mol,0,this.bond),this.queryWidget.render(t)}populateExtra(t){let e=[...this.mol.bondExtra(this.bond),...this.mol.bondTransient(this.bond)];this.fieldsWidget=new yi(e),this.fieldsWidget.render(t)}updateMolecule(){let{mol:t,bond:e}=this;t.setBondOrder(e,this.optionOrder.getSelectedIndex()),t.setBondType(e,this.optionStereo.getSelectedIndex())}updateGeometry(){let t=this.inputGeom1.getValue();if(this.refGeom1==t)return;const{mol:e}=this;let s=this.geomWidget.selected,i=this.geomWidget.selectionAtoms(s);if(s.type==di.Link&&this.refGeom1!=t){let s=parseFloat(t);if(isNaN(s)||Math.abs(s)>100)return;let o={mol:e,currentAtom:0,currentBond:e.findBond(i[0],i[1]),selectedMask:null},n=new Gs(o,Ys.BondDist,{dist:s});return n.execute(),void(this.mol=n.output.mol)}}updateQuery(){this.queryWidget.updateBond()}updateExtra(){this.mol.setBondExtra(this.bond,this.fieldsWidget.getExtraFields()),this.mol.setBondTransient(this.bond,this.fieldsWidget.getTransientFields())}selectedTab(t){0==t?this.inputFrom.grabFocus():1==t&&this.inputGeom1.grabFocus()}}const Si="a".charCodeAt(0),wi="A".charCodeAt(0);function Oi(t){return String.fromCharCode(wi+Math.min(26,Math.max(0,t))-1)}function qi(t){return String.fromCharCode(Si+Math.min(26,Math.max(0,t))-1)}class Bi extends ks{constructor(t,e,i,o){super(),this.atoms=e,this.proxyClip=i,this.callbackApply=o,this.optionConnect=null,this.optionBondConn=null,this.currentID=0,this.unit=null,this.borderAtoms=[],this.outBonds=[],this.outAtoms=[],this.initMol=t,this.mol=t.clone(),this.title="Polymer Block",this.minPortionWidth=20,this.maxPortionWidth=95,this.polymer=new Yt(this.mol),e=s.sorted(e);for(let t of this.polymer.getIDList()){let i=this.polymer.getUnit(t);if(s.equals(e,i.atoms)){this.currentID=t,this.unit=i;break}}this.unit||(this.unit=new Ut(e)),this.umol=this.mol.clone();let n=s.booleanArray(!1,this.umol.numAtoms);for(let t=1;t<=this.mol.numBonds;t++){let e=this.mol.bondFrom(t),s=this.mol.bondTo(t),i=this.atoms.includes(e),o=this.atoms.includes(s);(i||o)&&(n[e-1]=n[s-1]=!0),i&&!o&&(this.borderAtoms.push(e),this.outBonds.push(t),this.outAtoms.push(s)),o&&!i&&(this.borderAtoms.push(s),this.outBonds.push(t),this.outAtoms.push(e))}this.borderAtoms=s.sortedUnique(this.borderAtoms),this.umap=s.maskMap(n),this.umol=Ht.subgraphMask(this.umol,n),new Yt(this.umol).removeAll()}populate(){this.proxyClip.pushHandler(new pi);let t=this.buttonsDOM(),e=this.bodyDOM();this.btnApply=b('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(t).css({"margin-left":"0.5em"}),0==this.currentID&&this.btnApply.setText("Create"),this.btnApply.onClick((()=>this.applyChanges())),this.currentID>0&&(this.btnRemove=b('<button class="wmk-button wmk-button-default">Remove</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnRemove.onClick((()=>this.applyRemove())));let i=b("<div/>").appendTo(e);i.css({display:"grid","align-items":"center","justify-content":"start"}),i.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),i.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4] auto [end]"}),b("<div/>").appendTo(i).css({"grid-area":"1 / col0"}).setText("# Atoms");let o=b('<input size="5"/>').appendTo(b("<div/>").appendTo(i).css({"grid-area":"1 / col1"}));o.elInput.readOnly=!0,o.setValue(this.unit.atoms.length.toString()),b("<div/>").appendTo(i).css({"grid-area":"1 / col2"}).setText("Out-bonds");let n=b('<input size="5"/>').appendTo(b("<div/>").appendTo(i).css({"grid-area":"1 / col3"}));n.elInput.readOnly=!0,n.setValue(this.outBonds.length.toString());let l=1;2==this.outBonds.length&&(l++,b("<div/>").appendTo(i).css({"grid-area":`${l} / col0`}).setText("Connectivity"),this.optionConnect=new bi(["Unknown","Head-to-Tail","Head-to-Head","Random"]),this.optionConnect.render(b("<div/>").appendTo(i).css({"grid-area":`${l} / col1 / auto / col4`})),this.unit.connect==_t.HeadToTail?this.optionConnect.setSelectedIndex(1):this.unit.connect==_t.HeadToHead?this.optionConnect.setSelectedIndex(2):this.unit.connect==_t.Random&&this.optionConnect.setSelectedIndex(3)),4==this.outBonds.length&&4==s.uniqueUnstable(this.outAtoms).length&&(l++,b("<div/>").appendTo(i).css({"grid-area":`${l} / col0`}).setText("2x2 Connectivity"),this.populate2x2Conn(b("<div/>").appendTo(i).css({"grid-area":`${l} / col1 / auto / end`})));let r=t=>{if(!t)return null;let e=[];for(let s of t.split(",")){let t=parseInt(s);if(!(t>0))return;e.push(t)}return e};for(let t=0;t<this.borderAtoms.length;t++){l++;let e=b("<div/>").appendTo(i).css({"grid-area":`${l} / col0`,"text-align":"right","padding-right":"0.5em"});0==t&&e.setText("Name "),b("<span/>").appendTo(e).css({color:"#008000"}).setText(Oi(t+1));let s=b('<input size="20"/>').appendTo(b("<div/>").appendTo(i).css({"grid-area":`${l} / col1 / auto / end`,width:"100%"})),o=this.borderAtoms[t],n=this.unit.atomName.get(o);n&&s.setValue(n.join(",")),s.onInput((()=>{let t=r(s.getValue());void 0!==t&&this.unit.atomName.set(o,t)}))}for(let t=0;t<this.outAtoms.length;t++){l++;let e=b("<div/>").appendTo(i).css({"grid-area":`${l} / col0`,"text-align":"right","padding-right":"0.5em"});0==t&&e.setText("Link "),b("<span/>").appendTo(e).css({color:"#800080"}).setText(qi(t+1)),b("<div/>").appendTo(i).css({"grid-area":`${l} / col1`}).setText("Include");let s=b('<input size="10"/>').appendTo(b("<div/>").appendTo(i).css({"grid-area":`${l} / col2`,width:"100%"}));b("<div/>").appendTo(i).css({"grid-area":`${l} / col3`}).setText("Exclude");let o=b('<input size="10"/>').appendTo(b("<div/>").appendTo(i).css({"grid-area":`${l} / col4`,width:"100%"})),n=this.outBonds[t],a=this.unit.bondIncl.get(n),h=this.unit.bondExcl.get(n);a&&s.setValue(a.join(",")),h&&o.setValue(h.join(",")),s.onInput((()=>{let t=r(s.getValue());void 0!==t&&this.unit.bondIncl.set(n,t)})),o.onInput((()=>{let t=r(o.getValue());void 0!==t&&this.unit.bondExcl.set(n,t)}))}l++,this.populateUncap(b("<div/>").appendTo(i).css({"grid-area":`${l} / col0 / auto / col4`,"text-align":"center"})),l++,this.divPreview=b("<div/>").appendTo(i).css({"grid-area":`${l} / col0 / auto / col4`,"text-align":"center"}),this.renderUnit();let a=e.findAll("input,textarea");a.length>0&&a[0].grabFocus(!0);for(let t of a)t.css({font:"inherit"}),t.onKeyDown((t=>{let e=t.keyCode||t.which;13==e&&this.applyChanges(),27==e&&this.close()}))}close(){this.proxyClip.popHandler(),super.close()}populate2x2Conn(t){const e=[[0,1,2,3],[0,1,3,2],[0,2,1,3],[0,2,3,1],[0,3,1,2],[0,3,2,1]];let i=[null],o=["None"],n=0;for(let t of e){let e=s.idxGet(this.outBonds,t);s.equals(e,this.unit.bondConn)&&(n=o.length),i.push(e),o.push(`${t[0]+1},${t[1]+1}:${t[2]+1},${t[3]+1}`)}this.optionBondConn=new bi(o),this.optionBondConn.setSelectedIndex(n),this.optionBondConn.render(t),this.optionBondConn.onSelect((t=>{this.unit.bondConn=i[t],this.renderUnit()}))}populateUncap(t){let e=[];t:for(let t of this.outAtoms)if(1==this.mol.atomAdjCount(t)&&"*"!=this.mol.atomElement(t)){for(let e of this.polymer.getUnits())if(e.atoms.includes(t))continue t;e.push(t)}if(0==e.length)return;let s=b('<button class="wmk-button wmk-button-default">Uncap Exterior</button>').appendTo(t);s.onClick((()=>{s.elInput.disabled=!0;for(let t of e)this.mol.setAtomElement(t,"*")}))}applyChanges(){if(this.optionConnect){let t=this.optionConnect.getSelectedIndex();0==t?this.unit.connect=null:1==t?this.unit.connect=_t.HeadToTail:2==t?this.unit.connect=_t.HeadToHead:3==t&&(this.unit.connect=_t.Random)}this.currentID&&this.polymer.removeUnit(this.currentID),this.currentID=this.polymer.createUnit(this.unit.clone()),this.polymer.rewriteMolecule(),this.callbackApply(this)}applyRemove(){this.currentID&&this.polymer.removeUnit(this.currentID),this.callbackApply(this)}renderUnit(){let t=this.umol.clone(),e=Ye.defaultColourOnWhite(20),i=new We(0,0,e.data.pointScale),o=new Xe;o.atomCircleSz=s.numberArray(0,t.numAtoms),o.atomCircleCol=s.numberArray(0,t.numAtoms),o.atomDecoText=s.stringArray(null,t.numAtoms),o.atomDecoCol=s.numberArray(null,t.numAtoms),o.atomDecoSize=s.numberArray(null,t.numAtoms);let n=this.borderAtoms.map((t=>this.umap[t-1]+1)),l=this.outAtoms.map((t=>this.umap[t-1]+1));for(let e=1;e<=t.numAtoms;e++){let s=n.indexOf(e),i=l.indexOf(e);s>=0&&(o.atomDecoText[e-1]=Oi(s+1),o.atomDecoCol[e-1]=32768,o.atomDecoSize[e-1]=.5),i>=0&&(t.setAtomCharge(e,0),t.setAtomUnpaired(e,0),t.setAtomIsotope(e,0),o.atomCircleSz[e-1]=.1,o.atomCircleCol[e-1]=16711935,o.atomDecoText[e-1]=qi(i+1),o.atomDecoCol[e-1]=8388736,o.atomDecoSize[e-1]=.5,t.setAtomElement(e,"C"))}let r=new He(t,i,e,o);r.arrange(),r.squeezeInto(0,0,300,300);let a=new Ge;if(this.unit.bondConn){const t=[[0,1,13135112,2,!1],[2,3,13135112,2,!1],[0,2,3234360584,1,!0],[1,3,3234360584,1,!0]];for(let[e,s,i,o,n]of t){let t=this.outAtoms[this.outBonds.indexOf(this.unit.bondConn[e])],l=this.outAtoms[this.outBonds.indexOf(this.unit.bondConn[s])],h=r.getPoint(t-1),u=r.getPoint(l-1);if(a.drawLine(h.oval.cx,h.oval.cy,u.oval.cx,u.oval.cy,i,o),n)for(let t of[.2,.4,.6,.8]){let e=h.oval.cx+t*(u.oval.cx-h.oval.cx),s=h.oval.cy+t*(u.oval.cy-h.oval.cy);a.drawOval(e,s,2,2,i,o,null)}}}new $e(r,a).draw(),a.normalise(),this.divPreview.empty(),b(a.createSVG()).appendTo(this.divPreview).css({"pointer-events":"none"})}}var ki,Ri=function(t,e,s,i){return new(s||(s=Promise))((function(o,n){function l(t){try{a(i.next(t))}catch(t){n(t)}}function r(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,r)}a((i=i.apply(t,e||[])).next())}))};class Li extends Hs{constructor(t,e){super(),this.owner=t,this.group=e,this.subgroups=null,this.templates=null}init(){let t=Ye.defaultBlackOnWhite();t.data.pointScale=10,t.data.lineSize*=1.5,t.data.bondSep*=1.5,(()=>{Ri(this,void 0,void 0,(function*(){0==Li.resourceData.length&&(yield this.loadResourceData()),null==this.group?this.prepareSubGroups():this.prepareTemplates()}))})()}update(){null==this.subgroups&&null==this.templates||(this.buttons=[],null==this.group?this.populateGroups():this.populateTemplates())}populateGroups(){let t=this.subgroups.groups,e=this.subgroups.titles,s=this.subgroups.preview;for(let i=0;i<t.length;i++)this.buttons.push({id:t[i],metavec:s[i],helpText:e[i]})}populateTemplates(){let t=this.templates.names,e=(this.templates.abbrev,this.templates.mnemonic,this.templates.preview);for(let s=0;s<t.length;s++)this.buttons.push({id:s.toString(),metavec:e[s],helpText:t[s]})}hitButton(t){if(null==this.group)this.buttonView.pushBank(new Li(this.owner,t));else{let e=parseInt(t),s={fragNative:this.templates.molecules[e]};new Gs(this.owner.getState(),Ys.TemplateFusion,s,this.owner).execute()}}loadResourceData(){return Ri(this,void 0,void 0,(function*(){for(let t of Ts){let e=gs.RESOURCE_URL+"/data/templates/"+t+".ds",s=yield Ct(e);Li.resourceList.push(t),Li.resourceData.push(Ms.readXML(s))}}))}prepareSubGroups(){this.subgroups={groups:Li.resourceList,titles:[],preview:[]};let t=this.buttonView.idealSize,e=.5*(t-2),s=Ye.defaultBlackOnWhite();s.data.pointScale=10;let i=new Xe,o=new We(0,0,s.data.pointScale);for(let n of Li.resourceData){this.subgroups.titles.push(n.title);let l=n.firstColOfType("molecule"),r=new Ge;for(let t=0,a=0;a<4&&t<n.numRows;t++){let h=n.getMolecule(t,l);if(Ht.isBlank(h))continue;let u=new He(h,o,s,i);u.arrange();let m=a%2,d=Math.floor(a/2);u.squeezeInto(1+m*e,1+d*e,e,e,1),new $e(u,r).draw(),a++}r.width=t,r.height=t,this.subgroups.preview.push(r)}this.buttonView.refreshBank()}prepareTemplates(){let t=Li.resourceList.indexOf(this.group),e=Li.resourceData[t];this.templates={molecules:[],names:[],abbrev:[],mnemonic:[],preview:[]};let s=this.buttonView.idealSize,i=Ye.defaultBlackOnWhite();i.data.pointScale=12;let o=new Xe,n=new We(0,0,i.data.pointScale),l=e.findColByName("Molecule"),r=e.findColByName("Name"),a=e.findColByName("Abbrev"),h=e.findColByName("Mnemonic");for(let t=0;t<e.numRows;t++){let u=e.getMolecule(t,l);this.templates.molecules.push(u.toString()),this.templates.names.push(e.getString(t,r)),this.templates.abbrev.push(e.getString(t,a)),this.templates.mnemonic.push(e.getString(t,h));let m=new He(u,n,i,o);m.arrange(),m.squeezeInto(0,0,s,s,2);let d=new Ge;new $e(m,d).draw(),d.width=s,d.height=s,this.templates.preview.push(d)}this.buttonView.refreshBank()}}Li.resourceList=[],Li.resourceData=[];class Di extends Hs{constructor(t){super(),this.owner=t}update(){this.buttons=[],this.buttons.push({id:"accept",imageFN:"GenericAccept",helpText:"Apply this template."}),this.buttons.push({id:"prev",imageFN:"TemplatePrev",helpText:"Show previous fusion option."}),this.buttons.push({id:"next",imageFN:"TemplateNext",helpText:"Show next fusion option."})}hitButton(t){"accept"==t?this.owner.templateAccept():"prev"==t?this.owner.templateRotate(-1):"next"==t&&this.owner.templateRotate(1)}bankClosed(){this.owner.clearPermutations()}}!function(t){t.Arrow="arrow",t.Rotate="rotate",t.Pan="pan",t.Drag="drag",t.Erasor="erasor",t.BondOrder0="bond:Order0",t.BondOrder1="bond:Order1",t.BondOrder2="bond:Order2",t.BondOrder3="bond:Order3",t.BondUnknown="bond:Unknown",t.BondInclined="bond:Inclined",t.BondDeclined="bond:Declined",t.RingAliph="ringAliph",t.RingArom="ringArom",t.AtomPlus="atomPlus",t.AtomMinus="atomMinus",t.BondPfx="bond:",t.ElementPfx="element:"}(ki||(ki={}));const Ii=[{id:ki.Arrow,imageFN:"ToolSelect",helpText:"Selection tool.",mnemonic:"Escape"},{id:ki.Rotate,imageFN:"ToolRotate",helpText:"Rotate subject atoms.",mnemonic:""},{id:ki.Pan,imageFN:"ToolPan",helpText:"Pan the viewport around the screen.",mnemonic:""},{id:ki.Drag,imageFN:"ToolDrag",helpText:"Drag selected atoms to new positions.",mnemonic:""},{id:ki.Erasor,imageFN:"ToolErasor",helpText:"Delete atoms or bonds by selecting.",mnemonic:"Delete"},{id:ki.BondOrder0,imageFN:"BondZero",helpText:"Create or change a bond to zero order.",mnemonic:"Shift+0",key:")"},{id:ki.BondOrder1,imageFN:"BondOne",helpText:"Create or change a bond to single.",mnemonic:"Shift+1",key:"!"},{id:ki.BondOrder2,imageFN:"BondTwo",helpText:"Create or change a bond to double.",mnemonic:"Shift+2",key:"@"},{id:ki.BondOrder3,imageFN:"BondThree",helpText:"Create or change a bond to triple.",mnemonic:"Shift+3",key:"#"},{id:ki.BondUnknown,imageFN:"BondSquig",helpText:"Create or change a bond to unknown stereochemistry.",mnemonic:"Shift+4",key:"$"},{id:ki.BondInclined,imageFN:"BondUp",helpText:"Create or change a bond to up-wedge.",mnemonic:"Shift+5",key:"%"},{id:ki.BondDeclined,imageFN:"BondDown",helpText:"Create or change a bond to down-wedge.",mnemonic:"Shift+6",key:"^"},{id:ki.RingAliph,imageFN:"ToolRing",helpText:"Create plain ring.",mnemonic:"Shift+7",key:"&"},{id:ki.RingArom,imageFN:"ToolArom",helpText:"Create aromatic ring.",mnemonic:"Shift+8",key:"*"},{id:ki.AtomPlus,imageFN:"AtomPlus",helpText:"Increase charge on atom.",mnemonic:""},{id:ki.AtomMinus,imageFN:"AtomMinus",helpText:"Decrease charge on atom.",mnemonic:""},{id:ki.ElementPfx+"C",text:"C",helpText:"Change elements to Carbon.",mnemonic:""},{id:ki.ElementPfx+"N",text:"N",helpText:"Change elements to Nitrogen.",mnemonic:""},{id:ki.ElementPfx+"O",text:"O",helpText:"Change elements to Oxygen.",mnemonic:""},{id:ki.ElementPfx+"S",text:"S",helpText:"Change elements to Sulfur.",mnemonic:""},{id:ki.ElementPfx+"P",text:"P",helpText:"Change elements to Phosphorus.",mnemonic:""},{id:ki.ElementPfx+"H",text:"H",helpText:"Change elements to Hydrogen.",mnemonic:""},{id:ki.ElementPfx+"F",text:"F",helpText:"Change elements to Fluorine.",mnemonic:""},{id:ki.ElementPfx+"Cl",text:"Cl",helpText:"Change elements to Chlorine.",mnemonic:""},{id:ki.ElementPfx+"Br",text:"Br",helpText:"Change elements to Bromine.",mnemonic:""},{id:ki.ElementPfx+"A",text:"A",helpText:"Pick other element.",mnemonic:""}];class Pi extends Hs{constructor(t){super(),this.owner=t}update(){for(let t of Ii)this.buttons.push(t);this.buttonView.setSelectedButton("arrow")}hitButton(t){this.buttonView.setSelectedButton(t)}claimKey(t){for(let e of Ii)if(Hs.matchKey(t,e.mnemonic,e.key))return this.hitButton(e.id),!0;return!1}}var _i;class Fi extends ci{constructor(){super(),this.inDialog=!1,this.initialFocus=!0,this.useToolBank=!0,this.lowerToolBank=!1,this.useCommandBank=!0,this.lowerCommandBank=!1,this.useTemplateBank=!0,this.lowerTemplateBank=!1,this.debugOutput=void 0,this.beenSetup=!1,this.undoStack=[],this.redoStack=[],this.fadeWatermark=0,this.toolView=null,this.commandView=null,this.templateView=null,this.proxyClip=null,this.proxyMenu=null}setSize(t,e){this.width=t,this.height=e}defineMolecule(t,e=!0,s=!1,i=!1){if(0!=t.compareTo(this.mol)){s&&this.stashUndo(),this.stopTemplateFusion(),this.mol=t.clone(),this.onChangeMolecule&&this.onChangeMolecule(this.mol),this.guidelines=[];for(let t=1;t<=this.mol.numAtoms;t++)for(let e of Xt.guidelineSprouts(this.mol,t))this.guidelines.push(e);this.beenSetup&&(i||(this.currentAtom=this.currentBond=0,this.selectedMask=null),this.stereo=null,this.hoverAtom=0,this.hoverBond=0,e?this.autoScale():this.renderMolecule())}}defineClipboard(t){this.proxyClip=t}defineContext(t){this.proxyMenu=t}defineMoleculeString(t,e,s){this.defineMolecule(ne.fromString(t),e,s)}defineRenderPolicy(t){this.policy=t,this.pointScale=t.data.pointScale}defineBackground(t,e,s){null!=t&&(this.border=t),null!=e&&(this.borderRadius=e),null!=s&&(this.background=s)}clearMolecule(){this.defineMolecule(new ne,!0,!0)}getMolecule(){return this.mol.clone()}setup(t){this.beenSetup=!0,null==this.mol&&(this.mol=new ne),null==this.policy&&(this.policy=Ye.defaultColourOnWhite(),this.pointScale=this.policy.data.pointScale),this.layoutMolecule(),this.centreAndShrink(),this.redrawMetaVector(),t&&t()}setupAsync(){return t=this,e=void 0,i=function*(){return new Promise((t=>this.setup((()=>t()))))},new((s=void 0)||(s=Promise))((function(o,n){function l(t){try{a(i.next(t))}catch(t){n(t)}}function r(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,r)}a((i=i.apply(t,e||[])).next())}));var t,e,s,i}render(t){super.render(t),this.centreAndShrink(),this.redraw();let e=0;this.useCommandBank&&(this.commandView=new Xs(Us.Bottom,0,0,this.width,this.height),this.lowerCommandBank&&this.commandView.lowerBank(),this.commandView.setHasBigButtons(!1),this.commandView.pushBank(new ri(this)),this.commandView.render(this.container),e=this.commandView.height),this.useToolBank&&(this.toolView=new Xs(Us.Left,0,0,this.width,this.height-e),this.lowerToolBank&&this.toolView.lowerBank(),this.toolView.setHasBigButtons(!1),this.toolView.pushBank(new Pi(this)),this.toolView.render(this.container)),this.useTemplateBank&&(this.templateView=new Xs(Us.Right,0,0,this.width,this.height-e),this.lowerTemplateBank&&this.templateView.lowerBank(),this.templateView.setHasBigButtons(!0),this.templateView.pushBank(new Li(this,null)),this.templateView.render(this.container)),this.container.onClick((t=>this.mouseClick(t))),this.container.onDblClick((t=>this.mouseDoubleClick(t))),this.container.onMouseDown((t=>this.mouseDown(t))),this.container.onMouseUp((t=>this.mouseUp(t))),this.container.onMouseOver((t=>this.mouseOver(t))),this.container.onMouseLeave((t=>this.mouseOut(t))),this.container.onMouseMove((t=>this.mouseMove(t))),this.container.onKeyPress((t=>this.keyPressed(t))),this.container.onKeyDown((t=>this.keyDown(t))),this.container.onKeyUp((t=>this.keyUp(t))),this.container.onTouchStart((t=>this.touchStart(t))),this.container.onTouchMove((t=>this.touchMove(t))),this.container.onTouchCancel((t=>this.touchCancel(t))),this.container.onTouchEnd((t=>this.touchEnd(t))),this.contentDOM.onContextMenu((t=>this.contextMenu(t))),this.container.el.addEventListener("dragover",(t=>{t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"})),this.container.el.addEventListener("drop",(t=>{t.stopPropagation(),t.preventDefault(),this.dropInto(t.dataTransfer)})),this.initialFocus&&this.grabFocus()}get decoration(){return this.viewOpt.decoration}set decoration(t){this.viewOpt.decoration!=t&&(this.viewOpt.decoration=t,this.renderMolecule())}get showOxState(){return this.viewOpt.showOxState}set showOxState(t){this.viewOpt.showOxState!=t&&(this.viewOpt.showOxState=t,this.renderMolecule())}get showQuery(){return this.viewOpt.showQuery}set showQuery(t){this.viewOpt.showQuery!=t&&(this.viewOpt.showQuery=t,this.renderMolecule())}get showArtifacts(){return this.viewOpt.showArtifacts}set showArtifacts(t){this.viewOpt.showArtifacts!=t&&(this.viewOpt.showArtifacts=t,this.renderMolecule())}changeSize(t,e){if(t!=this.width||e!=this.height){this.width=t,this.height=e;for(let s of[this.container,this.canvasUnder,this.canvasMolecule,this.canvasOver])s.css({width:`${t}px`,height:`${e}px`});for(let s of[this.commandView,this.toolView,this.templateView])s&&(s.setParentSize(t,e),s.refreshBank());this.autoScale()}}showMessage(t,e=!1){let s=++this.fadeWatermark;this.divMessage.css({color:e?"#FF0000":"#008000"}),this.divMessage.setText(t);let i=(null==this.toolView?0:this.toolView.width)+2,o=(null==this.templateView?0:this.templateView.width)+2,n=(null==this.commandView?0:this.commandView.height)+2;this.divMessage.css({left:i+"px"}),this.divMessage.css({width:this.width-i-o+"px"}),this.divMessage.css({height:this.height-n+"px"}),window.setTimeout((()=>{s==this.fadeWatermark&&this.divMessage.setText("")}),5e3)}clearMessage(){""!=this.divMessage.getText()&&(this.fadeWatermark++,this.divMessage.setText(""))}autoScale(){this.pointScale=this.policy.data.pointScale,this.layoutMolecule(),this.centreAndShrink(),this.redrawMetaVector(),this.layoutTemplatePerm(),this.delayedRedraw()}anySelected(){if(null==this.selectedMask)return!1;for(let t=0;t<this.selectedMask.length;t++)if(this.selectedMask[t])return!0;return!1}setSelected(t,e){if(null==this.selectedMask){this.selectedMask=new Array(this.mol.numAtoms);for(let t=this.selectedMask.length-1;t>=0;t--)this.selectedMask[t]=!1}for(;this.selectedMask.length<this.mol.numAtoms;)this.selectedMask.push(!1);this.selectedMask[t-1]=e,this.delayedRedraw()}changeCurrentAtom(t){this.currentAtom!=t&&(this.currentAtom=t,this.currentBond=0,this.delayedRedraw())}changeCurrentBond(t){this.currentBond!=t&&(this.currentBond=t,this.currentAtom=0,this.delayedRedraw())}clearSubject(){0==this.currentAtom&&0==this.currentBond&&s.allFalse(this.selectedMask)||(this.currentAtom=0,this.currentBond=0,this.selectedMask=s.booleanArray(!1,this.mol.numAtoms),this.delayedRedraw())}setState(t,e=!0){this.stopTemplateFusion(),null!=t.mol&&this.defineMolecule(t.mol.clone(),!1,e,!0),t.currentAtom>=0&&(this.currentAtom=t.currentAtom),t.currentBond>=0&&(this.currentBond=t.currentBond),null!=t.selectedMask&&(this.selectedMask=null==t.selectedMask?null:t.selectedMask.slice(0)),this.delayedRedraw()}stashUndo(){if(0==this.undoStack.length&&0==this.mol.numAtoms)return;let t=this.getState();for(this.undoStack.push(t);this.undoStack.length>Fi.UNDO_SIZE;)this.undoStack.splice(0,1);this.redoStack=[]}setPermutations(t){this.templatePerms=t,this.pickTemplatePermutation(0),this.fusionBank=new Di(this),this.templateView.pushBank(this.fusionBank),0==this.mol.numAtoms&&this.centreAndShrink()}stopTemplateFusion(){null!=this.fusionBank&&this.templateView.popBank()}clearPermutations(){null!=this.templatePerms&&(this.templatePerms=null,this.delayedRedraw(),this.fusionBank=null)}templateAccept(){let t=ne.fromString(this.templatePerms[this.currentPerm].mol);this.templateView.popBank(),this.defineMolecule(t,!1,!0,!1)}templateRotate(t){let e=(this.currentPerm+t)%this.templatePerms.length;e<0&&(e+=this.templatePerms.length),this.pickTemplatePermutation(e)}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}performUndo(){if(0==this.undoStack.length)return;let t=this.getState();this.redoStack.push(t),this.setState(this.undoStack.pop(),!1)}performRedo(){if(0==this.redoStack.length)return;let t=this.getState();this.undoStack.push(t),this.setState(this.redoStack.pop(),!1)}performCopy(t){t||(t=this.getMolecule()),this.proxyClip&&this.proxyClip.setString(t.toString())}performCopySelection(t){new Gs(this.getState(),t?Ys.Cut:Ys.Copy,{},this).execute()}performPaste(){if(this.proxyClip&&this.proxyClip.canAlwaysGet()){let t=this.proxyClip.getString();this.pasteText(t)}}performActivity(t,e={}){new Gs(this.getState(),t,e,this).execute()}zoom(t){let e=.5*this.width,s=.5*this.height,i=Math.min(10*this.policy.data.pointScale,Math.max(.1*this.policy.data.pointScale,this.pointScale*t));i!=this.pointScale&&(this.offsetX=e-i/this.pointScale*(e-this.offsetX),this.offsetY=s-i/this.pointScale*(s-this.offsetY),this.pointScale=i,this.layoutMolecule(),this.redrawMetaVector(),this.layoutTemplatePerm(),this.delayedRedraw())}editCurrent(){this.currentAtom>0?this.editAtom(this.currentAtom):this.currentBond>0&&this.editBond(this.currentBond)}pasteText(t){let e=se.readUnknown(t);if(!e){let s=Ms.readXML(t);if(s)t:for(let t=0;t<s.numRows;t++)for(let i=0;i<s.numCols;i++)if("molecule"==s.colType(i)&&s.notNull(t,i)){e=s.getMolecule(t,i);break t}}null!=e?this.pasteMolecule(e):alert("Text from clipboard is not a valid molecule.")}pasteMolecule(t){if(0==this.mol.numAtoms)return void this.defineMolecule(t,!0,!0,!0);let e=new Gs(this.getState(),Ys.QueryPaste,{qmol:t});if(e.execute(),e.output.mol)return void this.defineMolecule(e.output.mol,!1,!0,!0);let s={fragNative:t.toString()};new Gs(this.getState(),Ys.TemplateFusion,s,this).execute()}pickTemplatePermutation(t){this.templatePerms[t],this.currentPerm=t,this.layoutTemplatePerm(),this.delayedRedraw()}performPolymerBlock(t){let e=new Bi(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,e.open()}grabFocus(){this.container.grabFocus()}hasFocus(){return this.container.hasFocus()}centreAndShrink(){if(0==this.mol.numAtoms||null==this.layout)return this.offsetX=.5*this.width,this.offsetY=.5*this.height,void(this.pointScale=this.policy.data.pointScale);let t=this.layout.determineBoundary(0),e=this.width-6,s=this.height-6,i=t[2]-t[0],o=t[3]-t[1],n=1;if(i>e){let t=e/i;n*=t,i*=t,o*=t}if(o>s){let t=s/o;n*=t,i*=t,o*=t}n<1&&(this.pointScale*=n,this.layout.offsetEverything(this.offsetX*n,this.offsetY*n),this.layout.scaleEverything(n),t=this.layout.determineBoundary(0));let l=.5*(e-i)-t[0],r=.5*(s-o)-t[1];this.offsetX+=l,this.offsetY+=r,this.layout.offsetEverything(l,r)}layoutTemplatePerm(){if(this.currentPerm<0||null==this.templatePerms)return;let t=this.templatePerms[this.currentPerm],e=new Ye(this.policy.data);e.data.foreground=8421504,e.data.atomCols=e.data.atomCols.slice(0);for(let t in e.data.atomCols)e.data.atomCols[t]=8421504;let s=new Xe,i=new He(ne.fromString(t.display),this,e,s);i.arrange(),t.metavec=new Ge,new $e(i,t.metavec).draw()}renderMolecule(){this.layoutMolecule(),this.redrawMetaVector(),this.delayedRedraw()}pickObjectCanvas(t,e){if(null==this.layout)return 0;if(null!=this.toolView){let s=this.container.offset(),i=this.toolView.contentDOM.offset();if(this.toolView.withinOutline(t+s.x-i.x,e+s.y-i.y))return null}if(null!=this.commandView){let s=this.container.offset(),i=this.commandView.contentDOM.offset();if(this.commandView.withinOutline(t+s.x-i.x,e+s.y-i.y))return null}if(null!=this.templateView){let s=this.container.offset(),i=this.templateView.contentDOM.offset();if(this.templateView.withinOutline(t+s.x-i.x,e+s.y-i.y))return null}return super.pickObjectCanvas(t,e)}updateHoverCursor(t,e){let s=this.toolView?this.toolView.selectedButton:"",i=s&&s!=ki.Pan&&s!=ki.Rotate,o=0;this.dragType==hi.None&&i&&(o=this.pickObject(t,e));let n=o>0?o:0,l=o<0?-o:0,r=this.hoverAtom>0&&Ht.hasAbbrev(this.mol,this.hoverAtom)?this.hoverAtom:0,a=n>0&&Ht.hasAbbrev(this.mol,n)?n:0;n==this.hoverAtom&&l==this.hoverBond||(this.hoverAtom=n,this.hoverBond=l,r!=a&&(this.layoutMolecule(),this.redrawMetaVector()),this.delayedRedraw())}determineDragGuide(t){if(0==this.opAtom||0==this.mol.atomAdjCount(this.opAtom)){let e={atom:this.opAtom,orders:[t],x:[],y:[],sourceX:0==this.opAtom?this.clickX:this.angToX(this.mol.atomX(this.opAtom)),sourceY:0==this.opAtom?this.clickY:this.angToY(this.mol.atomY(this.opAtom)),destX:[],destY:[]},s=0==this.opAtom?this.xToAng(this.clickX):this.mol.atomX(this.opAtom),i=0==this.opAtom?this.yToAng(this.clickY):this.mol.atomY(this.opAtom);for(let t=0;t<12;t++){let o=K*t/12,n=ne.IDEALBOND*Math.cos(o),l=ne.IDEALBOND*Math.sin(o);e.x.push(s+n),e.y.push(i+l),e.destX.push(e.sourceX+n*this.pointScale),e.destY.push(e.sourceY-l*this.pointScale)}return[e]}if(null==this.guidelines)return null;let e=null,s=null;for(let i=0;i<this.guidelines.length;i++){let o=this.guidelines[i];if(o.atom==this.opAtom){if(o.orders.indexOf(t)>=0){e=o;break}o.orders.indexOf(1)>=0&&(s=o)}}if(null==e&&(e=s),null==e)return[];let i=ft(e);i.sourceX=this.angToX(this.mol.atomX(i.atom)),i.sourceY=this.angToY(this.mol.atomY(i.atom)),i.destX=[],i.destY=[];for(let t=0;t<i.x.length;t++)i.destX.push(this.angToX(i.x[t])),i.destY.push(this.angToY(i.y[t]));return[i]}determineMoveGuide(){let t=this.subjectAtoms(!1,!0);if(0==t.length||t.length==this.mol.numAtoms)return null;let e=[];for(let s=0;s<this.guidelines.length;s++){let i=this.guidelines[s];if(!(i.orders.indexOf(1)<0||t.indexOf(i.atom)>=0)){i=ft(i),i.sourceX=this.angToX(this.mol.atomX(i.atom)),i.sourceY=this.angToY(this.mol.atomY(i.atom)),i.destX=[],i.destY=[];for(let t=0;t<i.x.length;t++)i.destX.push(this.angToX(i.x[t])),i.destY.push(this.angToY(i.y[t]));e.push(i)}}return e}editAtom(t){if(0==t)return;let e=new Ci(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,e.open()}editBond(t){if(0==t)return;let e=new Ni(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,e.open()}hitArrowKey(t,e){let s=++this.cursorWatermark;this.cursorDX+=t,this.cursorDY+=e,setTimeout((()=>{s==this.cursorWatermark&&this.cursorJumpDirection()}),100)}cursorJumpDirection(){let t=Math.atan2(this.cursorDY,this.cursorDX);this.currentAtom>0?this.jumpFromCurrentAtom(t):this.currentBond>0?this.jumpFromCurrentBond(t):this.jumpFromNowhere(t),this.cursorDX=0,this.cursorDY=0,this.cursorWatermark=0}jumpFromCurrentAtom(t){let e=this.mol.atomAdjList(this.currentAtom),s=0,i=Number.MAX_VALUE;for(let o of e){let e=this.mol.atomX(o)-this.mol.atomX(this.currentAtom),n=this.mol.atomY(o)-this.mol.atomY(this.currentAtom),l=Math.atan2(n,e),r=Math.abs(st(l,t));r<35*J&&r<i&&([s,i]=[o,r])}if(s>0)return void this.changeCurrentBond(this.mol.findBond(this.currentAtom,s));let o=0,n=Number.MIN_VALUE;for(let s=1;s<=this.mol.numAtoms;s++)if(s!=this.currentAtom&&e.indexOf(s)<0){let e=this.mol.atomX(s)-this.mol.atomX(this.currentAtom),i=this.mol.atomY(s)-this.mol.atomY(this.currentAtom),l=Math.atan2(i,e),r=Math.abs(st(l,t));if(r>45*J)continue;let a=Math.cos(r),h=Math.pow(a,2)/(X(e,i)+.001);h>n&&([o,n]=[s,h])}o>0&&this.changeCurrentAtom(o)}jumpFromCurrentBond(t){let[e,s]=this.mol.bondFromTo(this.currentBond),i=Math.atan2(this.mol.atomY(s)-this.mol.atomY(e),this.mol.atomX(s)-this.mol.atomX(e));Math.abs(st(t,i))<50*J&&this.changeCurrentAtom(s),Math.abs(st(t,i+Math.PI))<50*J&&this.changeCurrentAtom(e)}jumpFromNowhere(t){if(0==this.mol.numAtoms)return;if(1==this.mol.numAtoms)return void this.changeCurrentAtom(1);let e=0,s=0;for(let t=1;t<=this.mol.numAtoms;t++)e+=this.mol.atomX(t),s+=this.mol.atomY(t);let i=1/this.mol.numAtoms;e*=i,s*=i;let o=0,n=Number.MIN_VALUE;for(let i=1;i<=this.mol.numAtoms;i++){let l=this.mol.atomX(i)-e,r=this.mol.atomY(i)-s,a=Math.atan2(r,l),h=Math.cos(Math.abs(st(t+Math.PI,a)))*U(l,r);h>n&&([o,n]=[i,h])}o>0&&this.changeCurrentAtom(o)}createRing(t,e){const{mol:i}=this;let o=null,n=null;if(this.currentAtom>0){let e=0,l=0,r=i.atomAdjList(this.currentAtom),a=i.atomX(this.currentAtom),h=i.atomY(this.currentAtom);for(let t of r)e-=i.atomX(t)-a,l-=i.atomY(t)-h;if(Math.abs(e)<.001&&Math.abs(l)<.001)if(r.length>=2){let t=r.map((t=>Math.atan2(i.atomY(t)-a,i.atomX(t)-h)));s.sort(t);let o=Number.POSITIVE_INFINITY;for(let s=0;s<t.length;s++){let n=st(t[(s+1)%t.length],t[s]),r=Math.cos(n),u=Math.sin(n),m=jt.congestionPoint(i,a+r,h+u);m<o&&([o,e,l]=[m,r,u])}}else[e,l]=[1,0];[o,n]=Xt.proposeAtomRing(this.mol,t,this.currentAtom,e,l)}else if(this.currentBond>0){let e=i.bondFrom(this.currentBond),s=i.bondTo(this.currentBond),l=i.atomX(e),r=i.atomY(e),a=i.atomX(s),h=i.atomY(s),u=.5*(l+a),m=.5*(r+h),d=r-h,c=a-l,[p,f]=jt.congestionPoint(i,u-d,m-c)<jt.congestionPoint(i,u+d,m+c)?[-d,-c]:[d,c];[o,n]=Xt.proposeBondRing(this.mol,t,this.currentBond,p,f)}else{let e=0,s=0;if(i.numAtoms>0){let t=i.boundary();[e,s]=[t.maxX()+ne.IDEALBOND,t.midY()]}[o,n]=Xt.proposeNewRing(this.mol,t,e,s,1,0,!1)}if(!o)return;let l={ringX:o,ringY:n,aromatic:e};new Gs(this.getState(),Ys.Ring,l,this).execute()}mouseClick(t){return t.stopPropagation(),this.grabFocus(),!1}mouseDoubleClick(t){if(t.stopPropagation(),t.preventDefault(),this.toolView.selectedButton!=ki.Arrow)return;let e=P(t,this.container),s=this.pickObject(e[0],e[1]);if(s>0){let t=s;this.editAtom(t)}else{let t=-s;this.editBond(t)}return!1}mouseDown(t){if(t.stopPropagation(),t.preventDefault(),this.clearMessage(),t.ctrlKey&&!t.shiftKey&&!t.altKey)return void this.contextMenu(t);let[e,s]=P(t,this.container);return this.interactStart(e,s,t.shiftKey,t.ctrlKey,t.altKey),!1}mouseUp(t){t.stopPropagation();let[e,s]=P(t,this.container);return this.interactEnd(e,s),!1}mouseOver(t){t.stopPropagation();let[e,s]=P(t,this.container);return this.updateHoverCursor(e,s),this.updateLasso(e,s),!1}mouseOut(t){t.stopPropagation();let[e,s]=P(t,this.container);return this.updateHoverCursor(e,s),this.updateLasso(e,s),!1}mouseMove(t){t.stopPropagation();let[e,s]=P(t,this.container);if(this.updateHoverCursor(e,s),this.dragType!=hi.None)return this.interactDrag(e,s),!1}keyPressed(t){}keyDown(t){let e=t.key;if("Escape"==e)for(let e of[this.templateView,this.commandView,this.toolView])if(null!=e&&e.stackSize>1)return e.popBank(),t.preventDefault(),void t.stopPropagation();let s=(t.shiftKey?"S":"")+(t.ctrlKey||t.metaKey?"C":"")+(t.altKey?"A":""),i=!(t.shiftKey||t.ctrlKey||t.altKey||t.metaKey);if("Enter"==e)this.editCurrent();else if("ArrowLeft"==e&&i)this.hitArrowKey(-1,0);else if("ArrowRight"==e&&i)this.hitArrowKey(1,0);else if("ArrowUp"==e&&i)this.hitArrowKey(0,1);else if("ArrowDown"==e&&i)this.hitArrowKey(0,-1);else if("z"==e&&"C"==s)this.performUndo();else if("Z"==e&&"SC"==s)this.performRedo();else if("z"==e&&i)this.toolView.cycleSelected(-1);else if("x"==e&&i)this.toolView.cycleSelected(1);else if(null!=this.toolView&&this.toolView.topBank.claimKey(t));else if(null!=this.commandView&&this.commandView.topBank.claimKey(t));else if(null!=this.templateView&&this.templateView.topBank.claimKey(t));else if("#"==e&&"SC"==s)this.createRing(3,!1);else if("$"==e&&"SC"==s)this.createRing(4,!1);else if("%"==e&&"SC"==s)this.createRing(5,!1);else if("^"==e&&"SC"==s)this.createRing(6,!1);else if("&"==e&&"SC"==s)this.createRing(7,!1);else if("3"==e&&"CA"==s)this.createRing(3,!0);else if("4"==e&&"CA"==s)this.createRing(4,!0);else if("5"==e&&"CA"==s)this.createRing(5,!0);else if("6"==e&&"CA"==s)this.createRing(6,!0);else if("7"==e&&"CA"==s)this.createRing(7,!0);else if("c"==e&&"C"==s&&this.proxyClip)this.proxyClip.triggerCopy(!1);else if("x"==e&&"C"==s&&this.proxyClip)this.proxyClip.triggerCopy(!0);else{if("v"!=e||"C"!=s||!this.proxyClip||!this.proxyClip.canAlwaysGet())return;this.proxyClip.triggerPaste()}t.preventDefault(),t.stopPropagation()}keyUp(t){}touchStart(t){let[e,s]=P(t.touches[0],this.container);null!=this.pickObjectCanvas(e,s)&&(this.interactStart(e,s,t.shiftKey,t.ctrlKey,t.altKey),t.preventDefault())}touchMove(t){if(this.dragType!=hi.None){let[e,s]=P(t.touches[0],this.container);this.interactDrag(e,s)}t.preventDefault()}touchCancel(t){}touchEnd(t){if(this.dragType!=hi.None){let[e,s]=[this.mouseX,this.mouseY];this.interactEnd(e,s),t.preventDefault()}}mouseWheel(t){}contextMenu(t){if(t.preventDefault(),t.stopPropagation(),this.dragType=hi.None,!this.proxyMenu)return;let[e,s]=P(t,this.container),i=this.pickObject(e,s);i>0?this.changeCurrentAtom(i):i<0&&this.changeCurrentBond(-i);let o=this.getState(),n=new ai(o,this,this.proxyClip).populate();this.proxyMenu.openContextMenu(n,t)}interactStart(t,e,s,i,o){this.dragType=hi.Press,this.opBudged=!1,this.dragGuides=null,this.mouseX=t,this.mouseY=e,this.clickX=t,this.clickY=e;let n=this.pickObject(t,e);this.opAtom=n>0?n:0,this.opBond=n<0?-n:0,this.opShift=s,this.opCtrl=i,this.opAlt=o;let l="";if(null!=this.toolView&&(l=this.toolView.selectedButton),l==ki.Arrow)this.opShift||this.opCtrl||this.opAlt?this.opShift||this.opCtrl||!this.opAlt?!this.opShift&&this.opCtrl&&this.opAlt&&(this.dragType=hi.Zoom):this.dragType=hi.Pan:this.dragType=hi.Press;else if(l==ki.Rotate)this.dragType=hi.Rotate,this.toolRotateIncr=this.opShift?0:15*J;else if(l==ki.Pan)this.dragType=hi.Pan;else if(l==ki.Drag)this.dragType=hi.Move,this.opAtom>0&&(this.dragGuides=this.determineMoveGuide()),this.delayedRedraw();else if(l==ki.Erasor)this.dragType=hi.Erasor,this.lassoX=[t],this.lassoY=[e],this.lassoMask=[];else if(l==ki.RingAliph)this.dragType=hi.Ring,this.toolRingArom=!1,this.toolRingFreeform=this.opShift;else if(l==ki.RingArom)this.dragType=hi.Ring,this.toolRingArom=!0,this.toolRingFreeform=this.opShift;else if(l==ki.AtomPlus)this.dragType=hi.Charge,this.toolChargeDelta=1;else if(l==ki.AtomMinus)this.dragType=hi.Charge,this.toolChargeDelta=-1;else if(l.startsWith(ki.BondPfx)){if(this.dragType=hi.Bond,this.toolBondOrder=1,this.toolBondType=ne.BONDTYPE_NORMAL,l==ki.BondOrder0?this.toolBondOrder=0:l==ki.BondOrder2?this.toolBondOrder=2:l==ki.BondOrder3?this.toolBondOrder=3:l==ki.BondUnknown?this.toolBondType=ne.BONDTYPE_UNKNOWN:l==ki.BondInclined?this.toolBondType=ne.BONDTYPE_INCLINED:l==ki.BondDeclined&&(this.toolBondType=ne.BONDTYPE_DECLINED),this.opBond>0){let[t,e]=this.mol.bondFromTo(this.opBond),s=!1;for(let i of new Yt(this.mol).getUnits()){let o=i.atoms.includes(t),n=i.atoms.includes(e);if(o&&!n||n&&!o){s=!0;break}}s&&(this.toolBondOrder=0,this.toolBondType=ne.BONDTYPE_NORMAL)}0==this.opBond&&(this.dragGuides=this.determineDragGuide(this.toolBondOrder))}else l.startsWith(ki.ElementPfx)&&(this.dragType=hi.Atom,this.toolAtomSymbol=l.substring(ki.ElementPfx.length),this.dragGuides=this.determineDragGuide(1))}interactDrag(t,e){if(!this.opBudged){let s=t-this.clickX,i=e-this.clickY;s*s+i*i>4&&(this.opBudged=!0)}if(this.dragType==hi.Press&&0==this.opAtom&&0==this.opBond&&this.opBudged&&(this.dragType=hi.Lasso,this.lassoX=[t],this.lassoY=[e],this.lassoMask=[]),this.dragType==hi.Lasso||this.dragType==hi.Erasor)this.updateLasso(t,e);else if(this.dragType==hi.Pan){let s=t-this.mouseX,i=e-this.mouseY;0==s&&0==i||(this.offsetX+=s,this.offsetY+=i,this.layout.offsetEverything(s,i),this.metavec.transformPrimitives(s,i,1,1),this.currentPerm>=0&&null!=this.templatePerms&&this.templatePerms[this.currentPerm].metavec.transformPrimitives(s,i,1,1),this.delayedRedraw()),this.mouseX=t,this.mouseY=e}else if(this.dragType==hi.Zoom){let s=e-this.mouseY;if(0!=s){s=Math.min(50,Math.max(-50,s));let t=this.pointScale*(1-.01*s);t=Math.min(10,Math.max(.1,t));let e=this.clickX-t/this.pointScale*(this.clickX-this.offsetX),i=this.clickY-t/this.pointScale*(this.clickY-this.offsetY);this.pointScale=t,this.offsetX=e,this.offsetY=i,this.delayedRedraw()}this.mouseX=t,this.mouseY=e}else this.dragType!=hi.Rotate&&this.dragType!=hi.Move&&this.dragType!=hi.Atom&&this.dragType!=hi.Bond&&this.dragType!=hi.Ring||(this.mouseX=t,this.mouseY=e,this.delayedRedraw())}interactEnd(t,e){this.opBudged?this.interactEndDrag(t,e):this.interactEndClick(t,e),this.dragType=hi.None,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.dragGuides=null,this.delayedRedraw()}interactEndClick(t,e){let i=this.pickObject(t,e),o=i>0?i:0,n=i<0?-i:0;if(this.dragType==hi.Press)this.opShift||this.opCtrl||this.opAlt?!this.opShift||this.opCtrl||this.opAlt||o>0&&this.setSelected(o,!this.getSelected(o)):0==o&&0==n?s.anyTrue(this.selectedMask)?this.selectedMask=null:this.currentAtom>0?this.currentAtom=0:this.currentBond>0&&(this.currentBond=0):o!=this.currentAtom||n!=this.currentBond?(this.currentAtom=o,this.currentBond=n):0==o&&0==n&&this.anySelected()&&(this.selectedMask=null);else if(this.dragType==hi.Move)0==i&&(s.anyTrue(this.selectedMask)?this.selectedMask=null:this.currentAtom>0?this.currentAtom=0:this.currentBond>0&&(this.currentBond=0));else if(this.dragType==hi.Erasor){if(this.opAtom>0||this.opBond>0){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:[]});new Gs(t,Ys.Delete,{},this).execute()}}else if(this.dragType==hi.Atom){let t=this.toolAtomSymbol;if("A"==t){let t=new Ci(this.mol,this.opAtom,this.proxyClip,(()=>{let e=0==this.mol.numAtoms;0!=this.mol.compareTo(t.mol)&&this.defineMolecule(t.mol,e,!0),t.close()}));0==this.opAtom&&(t.newX=this.xToAng(this.clickX),t.newY=this.yToAng(this.clickY)),t.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,t.open()}else if(t){let e={element:t,keepAbbrev:!0};if(0==this.opAtom){let t=this.xToAng(this.clickX),s=this.yToAng(this.clickY);0==this.mol.numAtoms&&(this.offsetX=this.clickX,this.offsetY=this.clickY,t=0,s=0),e.positionX=t,e.positionY=s}let s=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:0,selectedMask:null});new Gs(s,Ys.Element,e,this).execute()}}else if(this.dragType==hi.Charge){if(this.opAtom>0||this.opBond>0){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:null});new Gs(t,Ys.Charge,{delta:this.toolChargeDelta},this).execute()}}else if(this.dragType==hi.Bond){let t,e=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:null});t=this.toolBondType==ne.BONDTYPE_NORMAL?new Gs(e,Ys.BondOrder,{order:this.toolBondOrder},this):new Gs(e,Ys.BondType,{type:this.toolBondType},this),t.execute()}}interactEndDrag(t,e){if(this.dragType==hi.Lasso){if(this.lassoX.length>=2){this.calculateLassoMask();for(let t=1;t<=this.mol.numAtoms;t++)this.getLassoed(t)&&!this.getSelected(t)&&this.setSelected(t,!0)}this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.delayedRedraw()}else if(this.dragType==hi.Erasor){let t=!1;for(let e=0;e<this.lassoMask.length;e++)if(this.lassoMask[e]){t=!0;break}if(t){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:0,currentBond:0,selectedMask:this.lassoMask});new Gs(t,Ys.Delete,{},this).execute()}}else if(this.dragType==hi.Rotate){let[t,e,s,i]=this.determineDragTheta(),o=-s*tt,n=this.xToAng(t),l=this.yToAng(e);new Gs(this.getState(),Ys.Rotate,{theta:o,centreX:n,centreY:l},this).execute()}else if(this.dragType==hi.Move){let[t,e]=this.determineMoveDelta(),s=this.pointScale;new Gs(this.getState(),Ys.Move,{refAtom:this.opAtom,deltaX:t/s,deltaY:-e/s},this).execute()}else if(this.dragType==hi.Ring){let[t,e]=this.determineFauxRing();if(null!=t){let s={ringX:t,ringY:e,aromatic:this.toolRingArom};new Gs(this.getState(),Ys.Ring,s,this).execute()}}else if(this.dragType==hi.Atom&&this.opAtom>0){let t=this.mouseX,e=this.mouseY,s=this.snapToGuide(t,e);null!=s&&([t,e]=s);let i={order:1,type:ne.BONDTYPE_NORMAL,element:this.toolAtomSymbol,x1:this.mol.atomX(this.opAtom),y1:this.mol.atomY(this.opAtom),x2:this.xToAng(t),y2:this.yToAng(e)};"A"==this.toolAtomSymbol&&(i.element=window.prompt("Enter element symbol:","")),""!=i.element&&new Gs(this.getState(),Ys.BondAtom,i,this).execute()}else if(this.dragType==hi.Bond){let t=this.mouseX,e=this.mouseY,s=this.snapToGuide(t,e);if(null!=s&&([t,e]=s,this.opBond>0)){let s=this.pickObject(t,e,{noAtoms:!0});if(s<0)return void this.connectPolymerBlock(this.opBond,-s)}let i={order:this.toolBondOrder,type:this.toolBondType,element:"C",x1:0==this.opAtom?this.xToAng(this.clickX):this.mol.atomX(this.opAtom),y1:0==this.opAtom?this.yToAng(this.clickY):this.mol.atomY(this.opAtom),x2:this.xToAng(t),y2:this.yToAng(e)};new Gs(this.getState(),Ys.BondAtom,i,this).execute()}}dropInto(t){let e=t.items,s=t.files;const i=[".el",".mol"],o=["text/plain","chemical/x-sketchel","x-mdl-molfile"];for(let t=0;t<e.length;t++)if("string"==e[t].kind&&o.indexOf(e[t].type)>=0)return void e[t].getAsString((t=>{let e=ne.fromString(t);null!=e?this.defineMolecule(e,!0,!0,!0):console.log("Dragged data is not a SketchEl molecule: "+t)}));for(let t=0;t<s.length;t++)for(let e of i)if(s[t].name.endsWith(e)){let e=new FileReader;return e.onload=t=>{let s=e.result,i=se.readUnknown(s.toString());null!=i?this.defineMolecule(i,!0,!0):console.log("Dragged file is not a recognised molecule: "+s)},void e.readAsText(s[t])}}connectPolymerBlock(t,e){let[i,o]=this.mol.bondFromTo(t),[n,l]=this.mol.bondFromTo(e),r=this.getState(),a=new Yt(r.mol),h=null,u=null,m=0;for(let t of a.getUnits()){if(!h||t.atoms.length<h.atoms.length){let e=t.atoms.includes(i),s=t.atoms.includes(o);e&&!s?h=t:s&&!e&&([h,i,o]=[t,o,i])}if(!u||t.atoms.length<u.atoms.length){let e=t.atoms.includes(n),s=t.atoms.includes(l);e&&!s?u=t:s&&!e&&([u,n,l]=[t,l,n])}for(let e of t.atomName.values())m=Math.max(m,s.max(e))}if(!h||!u)return!1;let d=s.first(h.atomName.get(i));d||(d=++m,h.atomName.set(i,[d]));let c=s.first(u.atomName.get(n));c||(c=++m,u.atomName.set(n,[c])),h.bondIncl.set(t,s.append(h.bondIncl.get(t),c)),u.bondIncl.set(e,s.append(u.bondIncl.get(e),d)),a.rewriteMolecule(),this.setState(r)}}Fi.UNDO_SIZE=20;class zi extends ks{constructor(t,e=null){super(e),this.mol=t,this.sketcher=new Fi,this.proxyClip=null,this.proxyMenu=null,this.callbackSave=null,this.title="Edit Compound",this.minPortionWidth=20,this.maxPortionWidth=95}onSave(t){this.callbackSave=t}getMolecule(){return this.sketcher.getMolecule()}getSketcher(){return this.sketcher}defineClipboard(t){this.proxyClip=t;let e=new pi;e.copyEvent=(t,e)=>(this.sketcher.performCopySelection(t),!0),e.pasteEvent=t=>(this.sketcher.pasteText(t.getString()),!0),t.pushHandler(e),this.sketcher.defineClipboard(t)}defineContext(t){this.proxyMenu=t,this.sketcher.defineContext(this.proxyMenu)}close(){this.proxyClip&&this.proxyClip.popHandler(),super.close()}populate(){let t=this.buttonsDOM(),e=this.bodyDOM();this.btnClear=b('<button class="wmk-button wmk-button-default">Clear</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnClear.onClick((()=>this.sketcher.clearMolecule())),this.btnCopy=b('<button class="wmk-button wmk-button-default">Copy</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnCopy.onClick((()=>this.actionCopy())),t.append(this.domClose),this.domClose.css({"margin-left":"0.5em"}),this.btnSave=b('<button class="wmk-button wmk-button-primary">Save</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnSave.onClick((()=>{this.callbackSave&&this.callbackSave(this)}));let s=b("<div/>").appendTo(e).css({width:"800px",height:"650px"});this.sketcher.setSize(800,650),this.sketcher.defineMolecule(this.mol),this.sketcher.setup((()=>this.sketcher.render(s)))}actionCopy(){this.sketcher.performCopySelection(!1)}actionCut(){this.sketcher.performCopySelection(!0)}actionPaste(){this.sketcher.performPaste()}actionUndo(){this.sketcher.performUndo()}actionRedo(){this.sketcher.performRedo()}}class Ui{constructor(t,e,s,i,o){this.width=t,this.minVal=e,this.maxVal=s,this.textWidth=i,this.inverse=o,this.notches=[]}calculate(){if(this.minVal==this.maxVal)return void this.notches.push({label:this.minVal.toString(),value:this.minVal,pos:.5*this.width});const t=this.width,e=this.minVal,s=this.maxVal,i=1/(s-e);let o=s=>t*(s-e)*i,n=null,l=null;const r=.99999,a=1.00001;t:for(let i=1e-10;i<=1e11;i*=10)for(let h of[.2,.5,1]){let u=i*h,m=1/u,d=Math.floor(e*u*r)*m,c=Math.round(e*u)*m,p=Math.ceil(e*u*a)*m,f=Math.floor(s*u*r)*m,g=Math.round(s*u)*m,b=Math.ceil(s*u*a)*m,A=o(d),y=o(c),E=o(p),M=o(f),T=o(g),x=o(b);if((G(A,0)||A>=0)&&A<=.1*t)n=d;else if((G(y,0)||y>=0)&&y<=.1*t)n=c;else{if(!((G(E,0)||E>=0)&&E<=.1*t))continue;n=p}if(x>=.9*t&&(G(x,t)||x<=t))l=b;else if(T>=.9*t&&(G(T,t)||T<=t))l=g;else{if(!(M>=.9*t&&(G(M,t)||M<=t)))continue;l=f}break t}if(null==n||null==l)return;let h=this.inverse(n),u=this.inverse(l);this.notches.push({label:this.formatNumber(h),value:h,pos:o(n)}),this.notches.push({label:this.formatNumber(u),value:u,pos:o(l)})}formatNumber(t){let e=t.toPrecision(4);return e=e.replace(/^(-?\d+)\.0+$/,"$1"),e=e.replace(/^(-?\d+\.0*[1-9]+)0+$/,"$1"),e=e.replace(/^(-?\d+)\.0+(e[\+\-]\d+)$/,"$1$2"),e=e.replace(/^(-?\d+\.0*[1-9]+)0+(e[\+\-]\d+)$/,"$1$2"),e}}class Yi extends zs{constructor(){super(),this.padding=4,this.borderCol=13684944,this.borderRadius=8,this.backgroundCol1=16777215,this.backgroundCol2=15790320,this.policy=Ye.defaultColourOnWhite()}clearBackground(){this.backgroundCol1=null,this.backgroundCol2=null}setBackground(t){this.backgroundCol1=t,this.backgroundCol2=null}setBackgroundGradient(t,e){this.backgroundCol1=t,this.backgroundCol2=e}render(t){super.render(t);let e=this.contentDOM;null!=this.borderCol&&e.setCSS("border","1px solid "+B(this.borderCol)),this.borderRadius>0&&e.setCSS("border-radius",this.borderRadius+"px");let s=this.backgroundCol1,i=this.backgroundCol2;if(null!=s&&null!=i){let t=B(s)+","+B(i);e.setCSS("background-image","linear-gradient(to bottom right, "+t+")")}else null!=s&&e.setCSS("background-color",B(s));e.css({padding:this.padding+"px",margin:"0"})}}class Xi extends Yi{constructor(t,e){super(),this.datastr=t,this.ds=null,this.failmsg="",this.tight=!1,e||(e={}),"base64"==e.encoding&&(t=Tt(atob(t.trim())));let s=null;if(e.name,"datasheet"==e.format||"chemical/x-datasheet"==e.format)s=Ms.readXML(t);else if("sdfile"==e.format||"chemical/x-mdl-sdfile"==e.format)try{s=new Jt(t).parse()}catch(t){this.failmsg=t}else{try{s=Ms.readXML(t)}catch(t){}if(null==s)try{s=new Jt(t).parse()}catch(t){}}if(null!=s){if(e.padding&&(this.padding=e.padding),"transparent"==e.background)this.clearBackground();else if(e.background){let t=e.background,s=t.indexOf(",");s<0?this.setBackground(S(t)):this.setBackgroundGradient(S(t.substring(0,s)),S(t.substring(s+1)))}"transparent"==e.border?this.borderCol=Ge.NOCOLOUR:e.border&&(this.borderCol=S(e.border)),null!=e.radius&&(this.borderRadius=parseInt(e.radius)),"wob"==e.scheme?this.policy=Ye.defaultWhiteOnBlack():"cob"==e.scheme?this.policy=Ye.defaultColourOnBlack():"bow"==e.scheme?this.policy=Ye.defaultBlackOnWhite():"cow"==e.scheme&&(this.policy=Ye.defaultColourOnWhite()),e.scale&&(this.policy.data.pointScale=e.scale),1!=e.tight&&"true"!=e.tight||(this.tight=!0),this.ds=s}}render(t){this.tagType="span",super.render(t);let e=this.contentDOM,s=this.ds;if(this.policy,e.css({display:"inline-block","line-height":"0"}),this.tight||e.setCSS("margin-bottom","1.5em"),null!=s){let t=new me(s).enumerate(),i=this.determineColumns(t),o=b("<table/>").appendTo(e);o.css({"font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'}),o.css({"border-collapse":"collapse","line-height":"1",margin:"2px",border:"0"});let n=b("<tr/>").appendTo(o).css({"line-height":"1"});for(let t=0;t<i.length;t++){let e=b("<th/>").appendTo(n);e.css({"white-space":"nowrap","font-weight":"600","text-decoration":"underline","text-align":"center"}),e.css({padding:"0.2em 0.5em 0.2em 0.5em",color:"black",border:"0"}),e.setText(i[t].name)}for(let e=0;e<s.numRows;){let l=1;for(let s of t)l=Math.max(l,s.rowBlockCount(e));n=b("<tr/>").appendTo(o).css({"line-height":"1"});for(let t=0;t<i.length;t++){let o=b("<td/>").appendTo(n);o.css({border:"1px solid #D0D0D0",padding:"0.2em","vertical-align":"middle"});let l=i[t];null==l.aspect?s.isNull(e,l.idx)?o.setText(" "):"molecule"==s.colType(l.idx)?this.renderMolecule(o,e,l.idx):this.renderPrimitive(o,e,l.idx):"text"==l.type?this.renderTextAspect(o,e,l.aspect,l.idx):"graphic"==l.type&&this.renderGraphicAspect(o,e,l.aspect,l.idx)}e+=l}}else{e.css({color:"red"}),e.setText("Unable to parse datasheet: "+this.failmsg);let t=b("<pre/>").appendTo(e);t.css({"line-height":"1.1"}),t.setText(this.datastr),console.log("Unparseable datasheet source string:\n["+this.datastr+"]")}}determineColumns(t){let e=this.ds,i=[],o=s.booleanArray(!1,e.numCols),n=[];for(let t=0;t<e.numCols;t++)n.push(e.colName(t));for(let s of t){if(e.numRows>0)for(let t=0,e=s.numTextRenderings(0);t<e;t++){let e=s.produceTextRendering(0,t).name;i.push({name:e,aspect:s,type:"text",idx:t})}if(e.numRows>0)for(let t=0,e=s.numGraphicRenderings(0);t<e;t++){let e=s.produceGraphicRendering(0,t,this.policy).name;i.push({name:e,aspect:s,type:"graphic",idx:t})}let t=s.areColumnsReserved(n);for(let e=0;e<n.length;e++)o[e]=o[e]||t[e]}for(let t=0;t<e.numCols;t++)o[t]||"extend"==e.colType(t)||i.push({name:e.colName(t),aspect:null,type:null,idx:t});return i}renderPrimitive(t,e,s){let i="",o=this.ds.colType(s),n="center";"string"==o?(i=this.ds.getString(e,s),n="left"):"integer"==o?i=this.ds.getInteger(e,s).toString():"real"==o?i=this.ds.getReal(e,s).toString():"boolean"==o&&(i=this.ds.getBoolean(e,s)?"true":"false"),t.setText(i),t.css({"text-align":n})}renderMolecule(t,e,s){t.css({"text-align":"center"});let i=new Xe,o=new We(0,0,this.policy.data.pointScale),n=new He(this.ds.getMolecule(e,s),o,this.policy,i);n.arrange();let l=new Ge;new $e(n,l).draw(),l.normalise(),b(l.createSVG()).appendTo(t)}renderTextAspect(t,e,s,i){let o=s.produceTextRendering(e,i);if(o.text)if(o.type==ae.TEXT_PLAIN)t.setText(o.text);else if(o.type==ae.TEXT_LINK){let e=b('<a target="_blank"/>').appendTo(t);e.setAttr("href",o.text),e.setText(o.text)}else o.type==ae.TEXT_HTML&&t.setHTML(o.text);else t.setText(" ")}renderGraphicAspect(t,e,s,i){let o=s.produceGraphicRendering(e,i,this.policy).metavec;null!=o?(t.css({"text-align":"center"}),o.normalise(),b(o.createSVG()).appendTo(t)):t.setText(" ")}}class Hi extends Yi{constructor(t,e){super(),this.molstr=t,this.mol=null,this.name="",this.failmsg="",this.maxWidth=0,this.maxHeight=0,this.boxSize=null,this.tight=!1,e||(e={});let s=null,i=e.name;if("sketchel"==e.format||"chemical/x-sketchel"==e.format)s=ne.fromString(t);else if("molfile"==e.format||"chemical/x-mdl-molfile"==e.format)try{let e=new Zt(t);s=e.parse(),null!=s&&null==i&&(i=e.molName)}catch(t){this.failmsg=t}else if(s=ne.fromString(t),null==s)try{let e=new Zt(t);s=e.parse(),null!=s&&null==i&&(i=e.molName)}catch(t){}if(null!=s){if(e.invert&&(s=jt.mirrorImage(s)),e.rotate&&jt.rotateMolecule(s,e.rotate*J),e.padding&&(this.padding=e.padding),"transparent"==e.background)this.clearBackground();else if(e.background){let t=e.background,s=t.indexOf(",");s<0?this.setBackground(S(t)):this.setBackgroundGradient(S(t.substring(0,s)),S(t.substring(s+1)))}if("transparent"==e.border?this.borderCol=Ge.NOCOLOUR:e.border&&(this.borderCol=S(e.border)),null!=e.radius&&(this.borderRadius=parseInt(e.radius)),e.width&&(this.maxWidth=e.width),e.height&&(this.maxHeight=e.height),e.box){let t=e.box,s=t.indexOf(",");this.boxSize=new d(parseInt(t.substring(0,s)),parseInt(t.substring(s+1)))}"wob"==e.scheme?this.policy=Ye.defaultWhiteOnBlack():"cob"==e.scheme?this.policy=Ye.defaultColourOnBlack():"bow"==e.scheme?this.policy=Ye.defaultBlackOnWhite():"cow"==e.scheme&&(this.policy=Ye.defaultColourOnWhite()),e.scale&&(this.policy.data.pointScale=e.scale),1!=e.tight&&"true"!=e.tight||(this.tight=!0),this.mol=s,this.name=i}}render(t){this.tagType="span",super.render(t);let e=this.contentDOM,s=this.mol,i=this.policy;if(e.css({display:"inline-block","line-height":"0"}),this.tight||e.setCSS("margin-bottom","1.5em"),null!=s&&s.numAtoms>0){e.setCSS("text-align","center");let t=new Xe,o=new We(0,0,i.data.pointScale),n=new He(s,o,i,t);if(n.arrange(),this.boxSize)n.squeezeInto(0,0,this.boxSize.w,this.boxSize.h);else if(this.maxWidth>0||this.maxHeight>0){let t=n.determineBoundary(),e=t[2]-t[0],s=t[3]-t[1],i=0==this.maxWidth?e:Math.min(e,this.maxWidth),o=0==this.maxHeight?s:Math.min(s,this.maxHeight);i==e&&o==s||n.squeezeInto(0,0,i,o)}let l=new Ge;if(new $e(n,l).draw(),null==this.boxSize?l.normalise():l.setSize(this.boxSize.w,this.boxSize.h),b(l.createSVG()).appendTo(e),this.name){let t=b("<p/>").appendTo(e);t.css({padding:"0.2em 0 0 0",margin:"0",width:"100%",color:"#606060","line-height":"1"}),t.css({"font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'}),t.setText(this.name)}}else{e.css({color:"red"}),e.setText("Unable to parse molecule: "+this.failmsg);let t=b("<pre/>").appendTo(e);t.css({"line-height":"1.1"}),t.setText(this.molstr),console.log("Unparseable molecule source string:\n["+this.molstr+"]")}}}!function(t){t.HEADER="header",t.SCHEME="scheme",t.QUANTITY="quantity",t.METRICS="metrics"}(_i||(_i={}));class ji extends Yi{constructor(t,e){super(),this.datastr=t,this.row=0,this.entry=null,this.failmsg="",this.tight=!1,this.facet="scheme",this.limitTotalW=800,this.includeStoich=!0,this.includeAnnot=!1,e||(e={}),"base64"==e.encoding&&(t=Tt(atob(t.trim())));let s=null;if("datasheet"==e.format||"chemical/x-datasheet"==e.format){let e=Ms.readXML(t);if(null==e)return void(this.failmsg="Unable to parse raw XML datasheet.");ts.isExperiment(e)&&(s=new ts(e))}else{let e=Ms.readXML(t);if(null==e)return void(this.failmsg="Unable to parse raw XML datasheet.");ts.isExperiment(e)&&(s=new ts(e))}if(null!=s)if(0!=s.ds.numRows)if(e.row&&(this.row=e.row),this.row<0||this.row>=s.ds.numRows)this.failmsg="Requested row "+this.row+" out of bounds.";else{if(this.entry=s.getEntry(this.row),e.facet&&(this.facet=e.facet),e.padding&&(this.padding=e.padding),"transparent"==e.background)this.clearBackground();else if(e.background){let t=e.background,s=t.indexOf(",");s<0?this.setBackground(S(t)):this.setBackgroundGradient(S(t.substring(0,s)),S(t.substring(s+1)))}"transparent"==e.border?this.borderCol=Ge.NOCOLOUR:e.border&&(this.borderCol=S(e.border)),null!=e.radius&&(this.borderRadius=parseInt(e.radius)),"wob"==e.scheme?this.policy=Ye.defaultWhiteOnBlack():"cob"==e.scheme?this.policy=Ye.defaultColourOnBlack():"bow"==e.scheme?this.policy=Ye.defaultBlackOnWhite():"cow"==e.scheme&&(this.policy=Ye.defaultColourOnWhite()),e.scale&&(this.policy.data.pointScale=e.scale),1!=e.tight&&"true"!=e.tight||(this.tight=!0),e.maximumwidth>0&&(this.limitTotalW=e.maximumwidth),0!=e.stoichiometry&&"false"!=e.stoichiometry||(this.includeStoich=!0),1!=e.annotations&&"true"!=e.annotations||(this.includeAnnot=!0)}else this.failmsg="Experiment datasheet has no rows.";else this.failmsg="Unable to instantiate Experiment aspect."}render(t){this.tagType="span",super.render(t);let e=this.contentDOM;e.css({display:"inline-block","line-height":"0"}),this.tight||e.setCSS("margin-bottom","1.5em"),null!=this.entry?this.facet==_i.HEADER?this.renderHeader(e):this.facet==_i.SCHEME?this.renderScheme(e):this.facet==_i.QUANTITY?this.renderQuantity(e):this.facet==_i.METRICS&&this.renderMetrics(e):(e.css({color:"red"}),e.setText("Failure to acquire data: "+this.failmsg),b("<pre/>").appendTo(e).css({"line-height":"1.1"}).setText(this.datastr),console.log("Unparseable datasheet source string:\n["+this.datastr+"]"))}renderHeader(t){let e=b("<table/>").appendTo(t);e.css({"font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'}),e.css({"border-collapse":"collapse","line-height":"1",margin:"2px",border:"0"});let s=["Title","Created","Modified","DOI"];for(let t=0;t<4;t++){if(3==t&&!this.entry.doi)continue;let i=b("<tr/>").appendTo(e).css({"line-height":"1"}),o=b("<th/>").appendTo(i);o.css({"white-space":"nowrap","font-weight":"600",color:"black","text-align":"left","vertical-align":"middle"}),o.css({padding:"0.2em 0.5em 0.2em 0.5em",border:"1px solid #D0D0D0"}),o.setText(s[t]);let n=b("<td/>").appendTo(i);if(n.css({border:"1px solid #D0D0D0",padding:"0.2em","vertical-align":"middle"}),0==t)this.entry.title||n.setCSS("font-style","italic"),n.setText(this.entry.title?this.entry.title:"(none)");else if(1==t||2==t){let e=1==t?this.entry.createDate:this.entry.modifyDate;null==e&&n.setCSS("font-style","italic"),n.setText(null==e?"(none)":e.toLocaleString())}else if(3==t){let t=this.doiToLink(this.entry.doi);if(null!=t&&(t.startsWith("http://")||t.startsWith("https://"))){let e=b('<a target="_blank"/>').appendTo(n);e.setAttr("href",t),e.setText(this.entry.doi)}else n.setText(this.entry.doi)}}}renderScheme(t){let e=new We(0,0,this.policy.data.pointScale),s=new Ve(this.entry,e,this.policy);s.limitTotalW=this.limitTotalW,s.includeStoich=this.includeStoich,s.includeAnnot=this.includeAnnot,s.arrange();let i=new Ge;new Qe(s,i).draw(),i.normalise(),b(i.createSVG()).appendTo(t)}renderQuantity(t){let e=new ze(this.entry);e.calculate();let s=b("<table/>").appendTo(t);s.css({"font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'}),s.css({"border-collapse":"collapse","line-height":"1",margin:"2px",border:"0"});let i=new Xe,o=new We(0,0,this.policy.data.pointScale);for(let t=0;t<e.numQuantities;t++){let n=e.getQuantity(t),l=b("<tr/>").appendTo(s).css({"line-height":"1"}),r=b("<td/>").appendTo(l);if(r.css({border:"1px solid #D0D0D0",padding:"0.2em","text-align":"center","vertical-align":"middle"}),Ht.notBlank(n.comp.mol)){let t=new He(n.comp.mol,o,this.policy,i);t.arrange();let e=new Ge;new $e(t,e).draw(),e.normalise(),b(e.createSVG()).appendTo(r)}r=b("<td/>").appendTo(l),r.css({border:"1px solid #D0D0D0",padding:"0.2em","text-align":"left","vertical-align":"top"}),this.renderComponentText(r,n)}}renderComponentText(t,e){let s=[],i=[];if(e.comp.name&&(s.push("Name"),i.push("<i>"+bt(e.comp.name)+"</i>")),Ht.notBlank(e.comp.mol)){let t=Ht.molecularWeight(e.comp.mol);s.push("Weight"),i.push(t.toFixed(4));let o=Ht.molecularFormula(e.comp.mol,["<sub>","</sub>","<sup>","</sup>"]);s.push("Formula"),i.push(o)}if(e.valueEquiv>0){let t=e.valueEquiv.toString(),o=e.statEquiv;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Stoichiometry"),i.push(t)}if(e.valueMass>0){let t=ze.formatMass(e.valueMass),o=e.statMass;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Mass"),i.push(t)}if(e.valueVolume>0){let t=ze.formatVolume(e.valueVolume),o=e.statVolume;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Volume"),i.push(t)}if(e.valueMoles>0){let t=ze.formatMoles(e.valueMoles),o=e.statMoles;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Moles"),i.push(t)}if(e.valueDensity>0){let t=ze.formatDensity(e.valueDensity),o=e.statDensity;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Density"),i.push(t)}if(e.valueConc>0){let t=ze.formatConc(e.valueConc),o=e.statConc;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Concentration"),i.push(t)}if(e.valueYield>0&&!e.comp.waste){let t=ze.formatPercent(e.valueYield),o=e.statYield;2==o?t="<i>("+t+")</i>":3==o&&(t+=" (conflicting)"),s.push("Yield"),i.push(t)}for(let e=0;e<s.length;e++){let o=b("<p/>").appendTo(t);o.setCSS("margin","0.1em"),o.append(b("<b>"+s[e]+"</b>")),o.appendText(": "),o.appendHTML(i[e])}}renderMetrics(t){let e=new ze(this.entry);e.calculate();let s=b("<table/>").appendTo(t);s.css({"font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'}),s.css({"border-collapse":"collapse","line-height":"1",margin:"2px",border:"0"});let i=new Xe,o=new We(0,0,this.policy.data.pointScale);if(e.numGreenMetrics>0)for(let t=0;t<3;t++){let i=b("<tr/>").appendTo(s).css({"line-height":"1"}),o=b("<th/>").appendTo(i);o.css({border:"1px solid #D0D0D0",padding:"0.5em","font-weight":"bold"}),o.css({"text-align":"right","vertical-align":"middle","white-space":"nowrap"}),o.setText(0==t?"All Reactants":1==t?"All Products":"All Waste");let n=b("<td/>").appendTo(i);n.css({border:"1px solid #D0D0D0",padding:"0.5em","white-space":"nowrap"}),n.css({"text-align":"left","vertical-align":"middle"}),0==t?n.setText(this.combineQuant(e.getAllMassReact(),"g")+" = "+this.sumQuant(e.getAllMassReact(),"g",!0)):1==t?n.setText(this.combineQuant(e.getAllMassProd(),"g")+" = "+this.sumQuant(e.getAllMassProd(),"g",!0)):2==t&&(e.getAllMassWaste().length>0?n.setText(this.combineQuant(e.getAllMassWaste(),"g")+" = "+this.sumQuant(e.getAllMassWaste(),"g",!1)):n.setText("none"))}else{let t=b("<tr/>").appendTo(s);b("<td/>").appendTo(t).setText("No metrics to show.")}for(let t=0;t<e.numGreenMetrics;t++){let n=e.getGreenMetrics(t),l=e.getQuantity(n.idx),r=b("<tr/>").appendTo(s).css({"line-height":"1"}),a=b("<td/>").appendTo(r);if(a.css({border:"1px solid #D0D0D0",padding:"0.2em","text-align":"center","vertical-align":"middle"}),Ht.notBlank(l.comp.mol)){let t=new He(l.comp.mol,o,this.policy,i);t.arrange();let e=new Ge;new $e(t,e).draw(),e.normalise(),b(e.createSVG()).appendTo(a)}a=b("<td/>").appendTo(r),a.css({border:"1px solid #D0D0D0",padding:"0.5em","text-align":"left","vertical-align":"top"});let h=this.combineQuant(n.massReact,"g"),u=this.combineQuant(n.massProd,"g"),m=this.sumQuantExt(n.massReact,n.massProd,1,Number.NaN,null),d=this.drawTotals("PMI",h,u,m);d.normalise();let c=b("<p/>").appendTo(a);b(d.createSVG()).appendTo(c);let p=this.combineQuant(n.massWaste,"g"),f=this.combineQuant(n.massProd,"g"),g=this.sumQuantExt(n.massWaste,n.massProd,1,Number.NaN,null);d=this.drawTotals("E-factor",p,f,g),d.normalise(),c=b("<p/>").appendTo(a),b(d.createSVG()).appendTo(c);let A=this.combineQuant(n.molwProd,null),y=this.combineQuant(n.molwReact,null),E=this.sumQuantExt(n.molwProd,n.molwReact,100,100,"%");d=this.drawTotals("Atom-E",A,y,E),d.normalise(),c=b("<p/>").appendTo(a),b(d.createSVG()).appendTo(c)}}combineQuant(t,e){if(0==t.length)return"?";let s="";for(let i=0;i<t.length;i++)i>0&&(s+=" + "),t[i]==ze.UNSPECIFIED?s+="?":(s+=N(t[i],4),e&&(s+=" "+e));return s}sumQuant(t,e,s){if(0==t.length)return s?"?":"0";let i=0;for(let e=0;e<t.length;e++){if(t[e]==ze.UNSPECIFIED)return"?";i+=t[e]}let o=N(i,4);return e&&(o+=" "+e),o}sumQuantExt(t,e,s,i,o){if(0==t.length||0==e.length)return"?";let n=0,l=0;for(let e=0;e<t.length;e++){if(t[e]==ze.UNSPECIFIED)return"?";n+=t[e]}for(let t=0;t<e.length;t++){if(e[t]==ze.UNSPECIFIED)return"?";l+=e[t]}if(l<=0)return"?";let r=s*n/l;Number.isNaN(i)||(r=Math.min(r,i));let a=N(r,4);return o&&(a+=" "+o),a}drawTotals(t,e,s,i){let o=new Ge,n=new We(0,0,this.policy.data.pointScale),l=" = ",r=.8*this.policy.data.pointScale,a=n.measureText(t,r),h=n.measureText(e,r),u=n.measureText(s,r),m=n.measureText(i,r),d=n.measureText(l,r),c=0;o.drawText(c,0,t,r,0,Be.Left|Be.Middle),c+=a[0],o.drawText(c,0,l,r,0,Be.Left|Be.Middle),c+=d[0],o.drawText(c,0,i,r,0,Be.Left|Be.Middle),c+=m[0],o.drawText(c,0,l,r,0,Be.Left|Be.Middle),c+=d[0];let p=Math.max(h[0],u[0]);return o.drawLine(c,0,c+p,0,0,1),o.drawText(c+.5*p,-2,e,r,0,Be.Centre|Be.Bottom),o.drawText(c+.5*p,2,s,r,0,Be.Centre|Be.Top),o}doiToLink(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;let e=ji.PTN_DOI1.exec(t);return e?"http://dx.doi.org/"+e[1]:(e=ji.PTN_DOI2.exec(t),e?"http://dx.doi.org/"+e[1]:(e=ji.PTN_ISBN.exec(t),e?"ISBN: "+e[1]:null))}}ji.PTN_DOI1=/^doi:(\d+\.\d+\/.*)$/,ji.PTN_DOI2=/^(\d+\.\d+\/.*)$/,ji.PTN_ISBN=/^(\d+-\d+-\d+-\d+-\d+)$/;class Vi{constructor(t){this.popupBackground="white",this.callbackClose=null,this.callbackPopulate=null,this.parent=A(t),Es("popup","\n\t*.wmk-popup\n\t{\n\t\tfont-family: 'Open Sans', sans-serif;\n\t}\n")}onClose(t){this.callbackClose=t}open(){let t=b(document.documentElement),e=this.domObscureBackground=b("<div/>").appendTo(t);e.css({position:"fixed","z-index":21e3}),e.css({left:"0",right:"0",top:"0",bottom:"0"}),e.css({"background-color":"black",opacity:.2});let s=this.domObscureForeground=b("<div/>").appendTo(t);s.css({position:"fixed","z-index":21001}),s.css({left:"0",right:"0",top:"0",bottom:"0"}),s.onClick((()=>this.close()));let i=this.domPanelBoundary=b('<div class="wmk-popup"/>').appendTo(s);i.onClick((t=>t.stopPropagation())),i.css({"background-color":this.popupBackground,border:"1px solid black"}),i.css({position:"absolute",overflow:"auto"}),this.domBody=b("<div/>").appendTo(i).css({padding:"5px"}),this.populate(),this.positionAndShow()}close(){this.domPanelBoundary.remove(),this.domObscureBackground.remove(),this.domObscureForeground.remove(),this.callbackClose&&this.callbackClose(this),_s()}bump(){this.positionAndShow()}bodyDOM(){return this.domBody}populate(){this.callbackPopulate?this.callbackPopulate(this):this.bodyDOM().setText("Empty popup.")}positionAndShow(){_s();let t=window.innerWidth,e=window.innerHeight,s=this.parent.el.getBoundingClientRect(),i=s.left,o=s.top,n=s.right,l=s.bottom,r=this.domPanelBoundary,a=Math.max(i,t-n)-4;r.css({"max-width":a+"px"});let h=Ot(),u=()=>{let s=r.width(),a=r.height(),u=0,m=0;l+2+a<e?m=l+2:o-2-a>0?m=o-2-a:e-l>o?(m=l+2,a=e-m-2):(m=2,a=o-m-2),r.height()>a&&(s+=h.w+10),i+s<t?u=i:s<n&&(u=n-s),_(r,u,m,s,a)};u(),window.setTimeout((()=>u()))}}class Wi{hasContextMenu(){return!1}openContextMenu(t,e){}}class Gi extends Wi{hasContextMenu(){return!0}openContextMenu(t,e){let[s,i]=P(e,document.body),o=b("<div/>").appendTo(document.body).css({position:"absolute","user-select":"none"});_(o,s-5,i-5,10,10);let n=b(document.activeElement),l=new Vi(o);l.callbackPopulate=()=>{l.bodyDOM().css({"user-select":"none","font-size":"16px"});for(let e of t){let t=b("<div/>").appendTo(l.bodyDOM());if(null==e)t.appendHTML("<hr/>");else if(e.subMenu){t.setText(e.label+" "),t.css({cursor:"pointer"});let s=t=>{t.preventDefault(),l.close(),this.openContextMenu(e.subMenu,t)};t.onClick(s),t.onContextMenu(s)}else e.click?(t.setText(e.label),t.onMouseEnter((()=>{t.css({"background-color":"#D0D0D0"})})),t.onMouseLeave((()=>{t.css({"background-color":"transparent"})})),t.css({cursor:"pointer"}),t.onClick((()=>{l.close(),e.click()}))):(t.css({color:"#808080"}),t.setText(e.label))}},l.callbackClose=()=>{o.remove(),n.grabFocus()},l.open()}}class $i{constructor(t=null){this.seed=t,this.m=134217728,this.invMN=1/(this.m-1),this.a=1103515245,this.c=5425153011,this.state=null==t?Math.floor(Math.random()*(this.m-1)):t}next(){return this.state=(this.a*this.state+this.c)%this.m,this.state}int(t){return t<=0?0:this.next()%t}float(){return this.next()*this.invMN}index(t){return s.isBlank(t)?null:this.int(t.length)}peek(t){return s.isBlank(t)?null:t[this.int(t.length)]}pull(t){if(s.isBlank(t))return null;let e=this.int(t.length),i=t[e];return t.splice(e,1),i}}WebMolKit=e})();